(()=>{"use strict";var e,t,s,i={313219:(e,t,s)=>{var i=s(526224),o=s(924400);window.PhotoTags=i.default,window.PhotoTooltip=o.default;try{stManager.done(jsc("web/photos_module.js"))}catch(e){}},76691:(e,t,s)=>{s.d(t,{default:()=>h});s(530522),s(991181),s(579665),s(95767),s(59357),s(976142),s(66108),s(296253);var i=s(830242);function o(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var s=[],i=!0,o=!1,a=void 0;try{for(var r,n=e[Symbol.iterator]();!(i=(r=n.next()).done)&&(s.push(r.value),!t||s.length!==t);i=!0);}catch(e){o=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(o)throw a}}return s}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(s);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return a(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}var r="friends_dropdown__list_item",n="friends_dropdown__list_item system_message",d="add_term_tag";const h=class{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options=extend({onUserSelected:()=>!1,onEscapePress:()=>!1,onKeyUp:()=>!1},e),cur.pvServerFriendsIndex&&cur.pvServerFriendsIds||(cur.pvServerFriendsIndex=new vkIndexer([],(e=>{var t=o(e,2);t[0];return t[1]})),cur.pvServerFriendsIds=[]),this.topUsers=new vkIndexer([],(e=>{var t=o(e,2);t[0];return t[1]})),this.isInited=!1,this.lastSeachTerm="",this.hoverItem=null,this.keyboardNavigation=!1,this.freeTerm=null,this._handleInputKeyEvent=this._handleInputKeyEvent.bind(this),this._handleMouseMoveOnce=this._handleMouseMoveOnce.bind(this)}init(){this.isInited&&this.friendsdListNode||((0,i.getIndexedFriends)()||this.fetchFriendsList(),this.isInited=!0,this._initElement(),this._initScroll());return this.friendsdListNode}update(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this._resetScroll(),this.setTopUsers(e),this._hideDropdown()}setTopUsers(e){this.topUsers.list.forEach((e=>{this.topUsers.remove(e)})),e.forEach((e=>{this.topUsers.add(e)})),this.topUsers.list=e}_hideDropdown(){removeClass(this.friendsdListNode,"show-dropdown")}_getItemHtml(e,t,s,i){return`<div class="${r}" data-id="${e}" data-name="${t}">\n      <img src="${i}" alt="${t}" class="friends_dropdown__list_image">\n      <div class="friends_dropdown__list_info">\n        <div class="friends_dropdown__list_name">${t} ${e===vk.id.toString()?`(${getLang("photos_tags_user_you")})`:""}</div>\n        <div class="friends_dropdown__list_label">${s}</div>\n      </div>\n    </div>`}_initElement(){this.friendsdListNode=ce("div",{className:"friends_dropdown__list"}),this.listInput=ce("input",{className:"friends_dropdown__list_input",placeholder:`${replaceEntities(getLang("photos_tags_dropdown_placeholder"))}`}),this.listDropdown=ce("div",{className:"friends_dropdown__list_dropdown"}),this.listContent=ce("div",{className:"friends_dropdown__list_content"}),this.listDropdown.appendChild(this.listContent),this.friendsdListNode.appendChild(this.listInput),this.friendsdListNode.appendChild(this.listDropdown),this._setListHTML(`<div class="${n}">${getLang("box_loading")}</div>`),addEvent(this.friendsdListNode,"click",cancelEvent),addEvent(this.listDropdown,"click",(e=>{this._handleItemSelected(e.target)})),addEvent(this.listDropdown,"mouseover",(e=>{if(!this.keyboardNavigation){var t=hasClass(e.target,r)?e.target:gpeByClass(r,e.target);this._setHoverItem(t)}})),addEvent(this.listInput,"keyup keydown keypress",this._handleInputKeyEvent),addEvent(this.listInput,"click",(()=>{this.show()}))}_handleItemSelected(e){var t=hasClass(e,r)?e:gpeByClass(r,e),s=domData(t,"name"),i=domData(t,"id");i&&this.options.onUserSelected(i,s),hasClass(e,d)&&this.freeTerm&&this.options.onUserSelected(0,this.freeTerm)}_getItemEleById(e){return window.domQuery1(`[data-id="${e}"]`,this.listDropdown)}_setListHTML(e){(this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent).innerHTML=e}_setHoverItem(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=domData(e,"id");if(s&&s!==this.hoverItem){if(this.hoverItem){var i=this._getItemEleById(this.hoverItem);removeClass(i,"hover")}this.hoverItem=s,addClass(e,"hover"),t&&this.scroll&&this.scroll&&this.scroll.scrollIntoView(e)}}show(e){hasClass(this.friendsdListNode,"show-dropdown")||(this._renderFriendsList(this.lastSeachTerm,e),addClass(this.friendsdListNode,"show-dropdown"),this._resetScroll(),this.scroll&&this.scroll.update())}_renderFriendsList(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e=trim(e),(0,i.getIndexedFriends)()){var s=this._doSearch(e);this._renderFriendsDropdown(e,s,t)}else this._setListHTML(`<div class="${n}">${getLang("box_loading")}</div>`);clearTimeout(this.requestTimeout),e.length>0&&e!==this.lastSeachTerm&&(this.requestTimeout=setTimeout((()=>{this.fetchFriendsWithQuery(e)}),300))}_initScroll(){browser.safari||stManager.add(["ui_common.css","ui_common.js"],(()=>{this.scroll=new window.uiScroll(this.listContent,{global:!0})}))}_handleInputKeyEvent(e){if("keyup"===e.type){switch(e.keyCode){case KEY.ENTER:this._handleEnter();break;case KEY.ESC:return this.options.onEscapePress(),void this._hideDropdown();default:var t=e&&e.target.value;t!==this.lastSeachTerm&&(this._renderFriendsList(t),this.lastSeachTerm=t,this.hoverItem=null)}this.options.onKeyUp(),this.show()}else switch(e.keyCode){case KEY.UP:case KEY.DOWN:this._handleArrows(e.keyCode===KEY.DOWN)}}_handleArrows(){var e,t,s=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.keyboardNavigation||(this.keyboardNavigation=!0,addEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)),this.hoverItem)e=this._getItemEleById(this.hoverItem),t=s?domNS(e):domPS(e);else{var i=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;t=domFC(i)}t&&this._setHoverItem(t,!0)}_handleMouseMoveOnce(){this.keyboardNavigation=!1,removeEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)}_handleEnter(){if(this.hoverItem){var e=this._getItemEleById(this.hoverItem);this._handleItemSelected(e)}}_doSearch(){var e,t,s,a,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=(0,i.getPhotoData)("tagged"),d=(0,i.getIndexedFriends)();r.length>0?(t=this.topUsers.search(r),s=d.search(r),a=cur.pvServerFriendsIndex.search(r)):(t=this.topUsers.list,s=d.list,a=cur.pvServerFriendsIndex.list),e=t.concat(s,a);var h=[];return(e=e.filter((e=>{var t=o(e,1)[0],s=h.indexOf(t)<0&&(!n||!n[t]);return h.push(t),s}))).length>20&&(e=e.slice(0,20)),e}_renderFriendsDropdown(e,t){var s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i="";if(t.forEach((e=>{var t=o(e,4),s=t[0],a=t[1],r=t[2],n=t[3],d=`id${s}`;i+=this._getItemHtml(s,a,r,n,d)})),!i&&s){this.freeTerm=e,e=clean(e);var a=getLang("photos_tags_not_found_tag_text").replace("{tagName}",`<span class="add_term_tag">${e}</span>`);i=`<div class="${n}">${a}</div>`,this._setListHTML(i)}else i&&(this._setListHTML(i),this.freeTerm=null,this._resetScroll());this.hoverItem=null}focus(){this.listInput.focus()}reset(){this.listInput.value="",this.lastSeachTerm="",this.hoverItem=null,this._resetScroll()}_resetScroll(){this.scroll?this.scroll.scrollTop():this.listContent.scrollTop=0}fetchFriendsList(){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags"},{onDone:e=>{(0,i.setIndexedFriends)(e,(()=>{this._renderFriendsList(this.lastSeachTerm)}))}})}fetchFriendsWithQuery(e){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags",str:e,photo:(0,i.getPhotoData)("id")},{onDone:t=>{this._handleFetchFriends(e,t)}})}_handleFetchFriends(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.lastSeachTerm===e){var s,a=0,r=(0,i.getPhotoData)("tagged");(s=r?t.filter((e=>{var t=o(e,1)[0];return!r[t]})):t).forEach((e=>{var t=e[0];cur.pvServerFriendsIds.indexOf(t)<0&&(cur.pvServerFriendsIds.push(t),cur.pvServerFriendsIndex.add(e),a++)})),(a>0||0===s.length)&&this._renderFriendsList(e,!0)}}}},526224:(e,t,s)=>{s.d(t,{default:()=>v});s(530522),s(66108),s(579665),s(95767),s(751876),s(59357),s(991181),s(296253);var i=s(414914),o=s(791563),a=s(116886),r=s(924400),n=s(830242),d=s(775478),h=s(486353),l=s(713208);function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var s=[],i=!0,o=!1,a=void 0;try{for(var r,n=e[Symbol.iterator]();!(i=(r=n.next()).done)&&(s.push(r.value),!t||s.length!==t);i=!0);}catch(e){o=!0,a=e}finally{try{i||null==n.return||n.return()}finally{if(o)throw a}}return s}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(s);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return u(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}var c="area_hover",p="visible_all";const v=class{constructor(e,t){this.imageNode=e,this.containerNode=t,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this.updatePhotoViewTags=this.updatePhotoViewTags.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}_init(){var e=(0,h.partConfigEnabled)("photo_recognition_web");this.photoTooltip=new r.default(window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined,hideAfterDecline:e}),this.photoView=window.Photoview,this.areasContainer=ce("div",{className:"photo_tags_suggested_areas_list"}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),addEvent(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()}_handleImageMouseMove(e){if(!this.areasHidden){var t=getXY(e.target),s=Math.round(100*(e.pageX-t[0])/e.target.offsetWidth),i=Math.round(100*(e.pageY-t[1])/e.target.offsetHeight);for(var o in clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout((()=>{this.photoTooltip.isActive||this.activeAreaId||this.hideAllSuggestedAreas()}),700),this.showAllSuggestedAreas(),this.areas)if(this.areas.hasOwnProperty(o)){var a=this.areas[o],r=a.x,n=a.y,d=a.x2,h=a.y2;if(s>parseInt(r)&&s<parseInt(d)&&i>parseInt(n)&&i<parseInt(h)){if(o===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(o),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}}_handleAreaClick(e){cancelEvent(e),this.photoTooltip.showAndFocusFriendsList(e)}showTagArea(e){var t=this.areas[e];return!(!t||t.isDeleted)&&(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&(0,i.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,(0,i.addClass)(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)}hideTagArea(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&(0,i.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()}_removeActiveAreaAfterTimeout(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout((()=>{!this.photoTooltip.isActive&&!this.tagAreaFound&&!this.photoTooltip.interaction&&this.hideTagArea(),this.waitToRemove=!1}),e))}showTooltip(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,s=this._getTooltipOptions(e);if(t){var o=(0,i.getXYRect)(t,!0),a=o.top,r=o.right,n=o.bottom,d=o.left;this.photoTooltip.show({top:a,right:r,bottom:n,left:d},s)}}}showAllSuggestedAreas(){(0,i.addClass)(this.areasContainer,p),(0,i.removeClass)(this.areasContainer,c),this.activeAreaId&&(0,i.addClass)(this.areasContainer,c)}hideAllSuggestedAreas(){(0,i.removeClass)(this.areasContainer,p)}pauseTooltips(){this.hideTagArea(),this.tooltipsPaused=!0}resumeTooltips(){this.tooltipsPaused=!1}_createTagElement(e,t,s,i){var o=cur.pvPhWidth,a=cur.pvPhHeight/o,r=s-e,n=i-t,d=ce("div",{className:"photo_tags_suggested_area"},{left:`${e}%`,marginTop:a*t+"%",width:`${r}%`}),h=ce("div",{},{paddingBottom:100*a*(n/r)+"%"});return d.appendChild(h),d}renderTagAreas(){this.areas={},this.areasContainer.innerHTML="";var e=(0,n.getPhotoData)("tags"),t=(0,n.getPhotoData)("suggested_tags"),s=(0,h.partConfigEnabled)("photo_recognition_web");for(var i in!s&&cur.postTo&&cur.postTo<0&&(t=[]),e)if("0"!==i&&e.hasOwnProperty(i)){var o=g(e[i],7),a=o[0],r=o[1],d=o[2],l=o[3],u=o[4],c=o[5],p=o[6],v=this._createTagElement(a,r,d,l);this.areas[i]={ele:v,x:a,y:r,x2:d,y2:l,userName:u,userHref:c,canDeleteTag:Boolean(p),confirmedTag:!1},this.areasContainer.appendChild(v)}for(var _ in t)if(_&&t.hasOwnProperty(_)){var m=g(t[_],7),f=m[0],w=m[1],T=m[2],S=m[3],A=m[4],I=m[5],C=m[6],N=this._createTagElement(f,w,T,S),b=void 0;A&&(b=`/id${A}`),this.areas[_]={ele:N,x:f,y:w,x2:T,y2:S,userHref:b,suggestedUserId:A,suggestedUserName:I,usersList:C,confirmedTag:!1},this.areasContainer.appendChild(N)}}_userSelectedCallback(e,t){var s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=(0,n.getPhotoData)("tags"),o=(0,n.getPhotoData)("suggested_tags"),a=(0,h.partConfigEnabled)("photo_recognition_web"),r=this.activeAreaId,d=this.areas[r],l=d.x,g=d.y,u=d.x2,c=d.y2,p=`/id${e}`,v=cur.pvAskForAutoTag&&s,_=clean(t),m={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:_,userHref:p,canDeleteTag:!0},f=this.activeAreaId;a?this.confirmSuggestedTags([r],(()=>{this.activeAreaId=f,this.photoTooltip.updateState(m),this.showTagArea(f),this._removeActiveAreaAfterTimeout(1e3)})):(i[r]=[l,g,u,c,_,p,!0],delete o[r],this._confirmSuggestedTag(r,e,t,a,(()=>{this.activeAreaId=f,this.areas[f]=extend(d,m),this.photoTooltip.updateState(m),this.showTagArea(f),this._removeActiveAreaAfterTimeout(1e3),v&&(cur.pvAskForAutoTag=!1,this.showSettingsBox())})))}showSettingsBox(){showBox("/al_photos.php",{act:"show_autotag_settings"},{params:{containerClass:"autotag_settings_box",grey:!0,width:450}})}confirmAlert(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=cur.pvOneSuggestHintId,s=cur.pvOneSuggestHintHash;e?(t=cur.pvSomeSuggestsHintId,s=cur.pvSomeSuggestsHintHash,cur.pvNeedShowAlertForSomeSuggests=!1):cur.pvNeedShowAlertForOneSuggest=!1,window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:t,hash:s},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}deleteTag(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=extend(t,{isDeleted:!0}),(0,i.addClass)(t.ele,"deleted"))}_getTooltipOptions(e){var t=this.areas[e],s=t.suggestedUserId,i=t.suggestedUserName;return{suggestedUserId:s,userName:t.userName,userHref:t.userHref,suggestedUserName:i,usersList:t.usersList,canDeleteTag:t.canDeleteTag}}_handleSuggestionDeclined(){var e=this.activeAreaId,t=this.areas[e];if(t){var s=(0,n.getPhotoData)("suggested_tags"),i=(0,h.partConfigEnabled)("photo_recognition_web");this.areas[e]=extend(t,{suggestedUserId:!1,suggestedUserName:!1,userHref:null}),s&&s[e]&&(s[e][4]=0),i?this.declineSuggestedTags([e]):(this.showTagArea(e),this._declineSuggestedTag(e))}}declineSuggestedTags(e,t,s){var o=(0,n.getPhotoData)("id"),r=(0,n.getPhotoData)("hash"),h=cur.pvListId,l=cur.pvIndex,g=cur.pvData[h][l],u=(0,n.getPhotoData)("tags"),c=e.map((e=>`${o}_${e}`)).join(",");ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:c,hash:r,extended:1},{onDone:(s,r,n)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewSuggestedTags(s,r,g),this.dispatchEvent(d.TagEventTypes.DECLINE_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:o}),h===cur.pvListId&&l===cur.pvIndex&&(!g.taginfo&&g.actions.tag&&u[0]<cur.pvMaxTags?(0,i.show)(cur.pvTagLink):(0,i.hide)(cur.pvTagLink),s||r||this.photoView.toggleTopInfoPanel((0,a.getLang)("photos_tag_deleted"),n)),t&&t()},onFail:e=>(e||(e=(0,a.getLang)("global_unknown_error")),s&&s(),this.handleTagRequestFail(e))})}confirmSuggestedTags(e,t,s){var r=cur.pvListId,h=cur.pvIndex,l=cur.pvData[r][h],g=(0,n.getPhotoData)("id"),u=(0,n.getPhotoData)("hash"),c=(0,n.getPhotoData)("suggested_tags"),p=e.length>1,v=e[0],_=c[v][4],m=()=>{var o=e.map((e=>`${g}_${e}`)).join(",");ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:o,hash:u,extended:1},{onDone:(s,o,a,n,u)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewTags(s,o,a,l),this.updatePhotoViewSuggestedTags(n,u,l),this.dispatchEvent(d.TagEventTypes.CONFIRM_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:g}),r===cur.pvListId&&h===cur.pvIndex&&(!l.taginfo&&l.actions.tag&&s[0]<cur.pvMaxTags?(0,i.show)(cur.pvTagLink):(0,i.hide)(cur.pvTagLink)),t&&t()},onFail:e=>(e||(e=(0,a.getLang)("global_unknown_error")),s&&s(),this.handleTagRequestFail(e))})};if(cur.pvNeedShowAlertForOneSuggest&&!p&&_!==window.vk.id||cur.pvNeedShowAlertForSomeSuggests&&p){var f="",w="",T="";if(p){var S=e.reduce(((e,t)=>{var s=c[t],i=s&&s[4];return i&&i!==window.vk.id&&(e[i]=!0),e}),{}),A=Object.keys(S).length;w=(0,a.getLang)("photo_recognition_some_tag_alert",A),f=(0,a.getLang)("photo_recognition_some_friends_alert_text",A),T=(0,a.getLang)("photo_recognition_some_friends_submit_btn")}else{var I=c[v][5],C=c[v][7];w=(0,a.getLang)("photo_recognition_one_tag_alert"),f=(0,a.langSex)(C,(0,a.getLang)("photo_recognition_one_tag_alert_text","raw")).replace("{name}",I),T=(0,a.getLang)("photo_recognition_one_friend_submit_btn")}var N=(0,o.showFastBox)(w,f,T,(()=>{N.hide(),m(),this.confirmAlert(p)}),(0,a.getLang)("global_cancel"),(()=>{N.hide(),s&&s()}))}else m()}decrementLeftMenuCounterIfNeeded(e){var t=(0,n.getPhotoData)("suggested_tags");e.forEach((e=>{var s=t[e],i=s&&s[4];i&&i===window.vk.id&&(0,l.decrementLeftMenuPhotoCounter)()}))}_confirmSuggestedTag(e,t,s,i,o){var a=(0,n.getPhotoData)("id"),r=(0,n.getPhotoData)("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:s,photo:a,hash:r},{onDone:(e,t,s)=>{this.updatePhotoViewTags(e,t,s),o()},onFail:this.handleTagRequestFail})}_declineSuggestedTag(e){var t=(0,n.getPhotoData)("id"),s=(0,n.getPhotoData)("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:t,hash:s},{onFail:this.handleTagRequestFail})}dispatchEvent(e,t){this.areasContainer.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}))}handleTagRequestFail(e){var t=(0,a.getLang)("global_error");return setTimeout((0,o.showFastBox)(t,e).hide,3e3),!0}unMount(){removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),removeEvent(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""}hideAreas(){this.areasHidden=!0,(0,i.hide)(this.areasContainer),this.photoTooltip.hide()}showAreas(){this.areasHidden=!1,(0,i.show)(this.areasContainer),removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove)}reload(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()}_queueCheckUpdates(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)}updatePhotoViewTags(e,t,s){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(i=i||(0,n.getCurrentPhoto)())&&(i.tags=e,i.tagged=t,i.tagshtml=s,this.photoView.setTags(s))}updatePhotoViewSuggestedTags(e,t){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(s=s||(0,n.getCurrentPhoto)())&&(e&&Object.keys(e).length?s.suggested_tags=e:delete s.suggested_tags,t?(s.suggestedTagsInfo=t,this.photoView.showSuggestedInfoTopPanel(cur.pvCurPhoto)):(delete s.suggestedTagsInfo,this.photoView.toggleTopInfoPanel(!1)),this.reload())}_queueReceiveUpdates(e,t){t.events&&t.events.forEach((e=>{var t=e.split("<!>"),s=t[1],i=t[2],o=JSON.parse(i),a=JSON.parse(t[3]),r=JSON.parse(t[4]),d=t[5];if((0,n.getPhotoData)("id")===s)(0,n.setPhotoData)("suggested_tags",o),this.updatePhotoViewTags(a,r,d),this.renderTagAreas();else if(cur.pvData){var h=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach(((t,i)=>{if(t.id&&t.id===s){var n=cur.pvData[e][i];n.suggested_tags=o,n.tags=a,n.tagged=r,n.tagshtml=d}}))}};for(var l in cur.pvData)h(l)}}))}}},924400:(e,t,s)=>{s.d(t,{default:()=>r});s(59357);var i=s(76691),o=s(116886),a="right_top";const r=class{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.options=extend({closeOnClick:!0,resetDropdownOnShow:!0,onUserSelected:()=>!1,onMouseLeave:()=>!1,onEscapePressed:()=>!1,onDeleteClicked:()=>!1,onSuggestionDeclined:()=>!1},t),this.container=e,this.friendsDropdown=new i.default({onUserSelected:this._handleUserSelected.bind(this),onEscapePress:this._handleEscapePress.bind(this),onKeyUp:this._handleStartInteraction.bind(this)}),this.friendsDropdownNode=this.friendsDropdown.init(),this._handleConfirmedTooltipClick=this._handleConfirmedTooltipClick.bind(this),this._handleDocumentClick=this._handleDocumentClick.bind(this),this.renderTooltip()}renderTooltip(){this.tooltipNode=ce("div",{className:"photo_tooltip"},{display:"none"});var e=ce("div",{className:"photo_tooltip__content"});this.sugggestionNode=ce("div"),this.nameNode=ce("div",{className:"photo_tooltip__name"},{display:"none"}),this.listNode=ce("div",{className:"photo_tooltip__suggestion"}),this.listNode.appendChild(this.friendsDropdownNode),addEvent(this.nameNode,"click",this._handleConfirmedTooltipClick),e.appendChild(this.nameNode),e.appendChild(this.sugggestionNode),e.appendChild(this.listNode),this.tooltipNode.appendChild(e),this.container.appendChild(this.tooltipNode),addEvent(this.tooltipNode,"mouseenter",(()=>{this.isActive=!0})),addEvent(this.sugggestionNode,"click",(e=>{switch(cancelEvent(e),window.domData(e.target,"button")){case"yes":this.options.onUserSelected(this.suggestedUserId,this.suggestedUserName,!0);break;case"no":this.options.onSuggestionDeclined(),hide(this.sugggestionNode),this.userHref=null,this.options.hideAfterDecline?this.hide():(this.showFriendsList(),this.showAndFocusFriendsList())}})),addEvent(this.tooltipNode,"mouseleave",(()=>{this.interaction||(this.isActive=!1,this.options.onMouseLeave())})),this.options.closeOnClick&&addEvent(document,"click",this._handleDocumentClick)}_handleDocumentClick(e){this.options.onMouseLeave(),this.interaction=!1,this.isActive=!1,this.hide()}_handleUserSelected(e,t){this.isActive=!1,this.options.onUserSelected(e,t)}_handleEscapePress(){this.isActive=!1,this.interaction=!1,this.friendsDropdown.reset(),this.options.onEscapePressed()}_handleStartInteraction(){this.interaction=!0}_handleConfirmedTooltipClick(e){cancelEvent(e),"button"===e.target.tagName.toLowerCase()?this.options.onDeleteClicked():this.userHref&&this._go(this.userHref,e)}updatePosition(e){var t=e.top,s=e.right,i=e.bottom,o=e.left,r=s-o,n=getSize(this.tooltipNode),d=n[0]?n[0]:280,h="bottom",l=o+Math.floor(r/2)-d/2,g=i;if((l<10||this.hasDropdown&&i>window.clientHeight()-300)&&(h=a),h===a){l=s,g=t;var u=window.clientHeight()-t;u<300&&(g=t-300+u)}domData(this.tooltipNode,"dir",h),setStyle(this.tooltipNode,{top:g,left:l})}updateSuggestionQuestion(e,t){this.sugggestionNode.innerHTML=this._getSuggestionHTML(e,t),this.suggestedUserName=t,this.suggestedUserId=e}_getSuggestionHTML(e,t){var s=e===vk.id?getLang("photos_tags_user_you"):t;return`<div class="suggested_tag_user">\n      ${(0,o.langTag)("<div>","</div>",getLang("photos_tags_suggestion_question"),"tag_span").replace("{userName}",`<div class="suggested_tag_user__name">&nbsp;${s}</div>`)}\n      <div class="suggested_tag_user__actions">\n        <button data-button="yes" class="yes">${getLang("box_yes")}</button>\n        <span>&middot;</span>\n        <button data-button="no">${getLang("box_no")}</button>\n      </div>\n    </div>`}updateState(e){var t=e.suggestedUserName,s=e.suggestedUserId,i=e.usersList,o=e.userName,a=e.userHref,r=e.canDeleteTag;this.suggestedUserName=!1,this.suggestedUserId=!1,this.userHref=a,this.hasDropdown=!1,removeClass(this.tooltipNode,"tagged"),o?(this.nameNode.innerHTML=`${o} ${r?"<button>Delete</button>":""}`,toggleClass(this.nameNode,"show_delete",r),show(this.nameNode),hide(this.listNode),hide(this.sugggestionNode),addClass(this.tooltipNode,"tagged")):s?(this.updateSuggestionQuestion(s,t),hide(this.nameNode),hide(this.listNode),show(this.sugggestionNode)):(this.friendsDropdown.update(i),hide(this.nameNode),hide(this.sugggestionNode),this.showFriendsList(),this.hasDropdown=!0)}showFriendsList(){show(this.listNode),this.options.resetDropdownOnShow&&this.resetFriendsDropdown()}resetFriendsDropdown(){this.friendsDropdown.reset()}show(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.isActive=!1,this.interaction=!1,this.updateState(t),this.updatePosition(e),show(this.tooltipNode),s&&this.friendsDropdown.show(!0),this.friendsDropdown.focus()}hide(){hide(this.tooltipNode)}showAndFocusFriendsList(e){this.userHref?this._go(this.userHref,e):(this.friendsDropdown.focus(),this.friendsDropdown.show())}unMount(){removeEvent(document,"click",this._handleDocumentClick),re(this.tooltipNode)}_go(e,t){t&&t.ctrlKey?window.open(e):nav.go(e,t)}}},713208:(e,t,s)=>{s.d(t,{decrementLeftMenuPhotoCounter:()=>n});var i=s(442699),o=s(611386),a=s(484426),r="ph";function n(e){void 0===e&&(e=1);try{var t=function(){var e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");var t=e.querySelector(".left_count");return t?(0,i.intval)(t.textContent):0}();(0,a.handlePageCount)(r,Math.max(t-e,0))}catch(e){console.error(e),(0,o.logError)(e)}}},775478:(e,t,s)=>{var i;s.d(t,{TagEventTypes:()=>i}),function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(i||(i={}))}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={exports:{}};return i[e].call(s.exports,s,s.exports,a),s.exports}a.m=i,e=[],a.O=(t,s,i,o)=>{if(!s){var r=1/0;for(l=0;l<e.length;l++){for(var[s,i,o]=e[l],n=!0,d=0;d<s.length;d++)(!1&o||r>=o)&&Object.keys(a.O).every((e=>a.O[e](s[d])))?s.splice(d--,1):(n=!1,o<r&&(r=o));if(n){e.splice(l--,1);var h=i();void 0!==h&&(t=h)}}return t}o=o||0;for(var l=e.length;l>0&&e[l-1][2]>o;l--)e[l]=e[l-1];e[l]=[s,i,o]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},s=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,a.t=function(e,i){if(1&i&&(e=this(e)),8&i)return e;if("object"==typeof e&&e){if(4&i&&e.__esModule)return e;if(16&i&&"function"==typeof e.then)return e}var o=Object.create(null);a.r(o);var r={};t=t||[null,s({}),s([]),s(s)];for(var n=2&i&&e;"object"==typeof n&&!~t.indexOf(n);n=s(n))Object.getOwnPropertyNames(n).forEach((t=>r[t]=()=>e[t]));return r.default=()=>e,a.d(o,r),o},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.e=()=>Promise.resolve(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={2866:0};a.O.j=t=>0===e[t];var t=(t,s)=>{var i,o,[r,n,d]=s,h=0;for(i in n)a.o(n,i)&&(a.m[i]=n[i]);if(d)var l=d(a);for(t&&t(s);h<r.length;h++)o=r[h],a.o(e,o)&&e[o]&&e[o][0](),e[r[h]]=0;return a.O(l)},s=self.webpackChunkvk=self.webpackChunkvk||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var r=a.O(void 0,[8592],(()=>a(313219)));r=a.O(r)})();