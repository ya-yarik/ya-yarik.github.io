(self.webpackChunkvk=self.webpackChunkvk||[]).push([[7586],{410329:(e,t,o)=>{"use strict";o.d(t,{photos:()=>p});o(66108),o(296253),o(991181),o(579665),o(95767),o(530522),o(21466),o(751876),o(59357);var r=o(414914),i=o(705456),n=o(791563),a=o(988989),s=o(611386),l=o(960139),d=o(116886),c=o(196132);function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var o=[],r=!0,i=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(o.push(a.value),!t||o.length!==t);r=!0);}catch(e){i=!0,n=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw n}}return o}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);"Object"===o&&e.constructor&&(o=e.constructor.name);if("Map"===o||"Set"===o)return Array.from(o);if("Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return h(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}var p={LOAD_TYPE_PHOTOS:"photos",LOAD_TYPE_ALBUMS:"albums",LOAD_TYPE_TAGGED:"tagged",MAX_DESC_INPUT_HEIGHT:600,changeAlbumPhoto(e){showBox("al_photos.php",{act:"change_thumb_box",album:e})},onMouseOverEditRow(e){var t=(0,r.geByClass1)("photos_photo_edit_row_desc_placeholder",e),o=(0,r.geByClass1)("photos_photo_edit_row_desc_input",e);(0,r.setTitle)(t,!1,(0,r.val)(o))},editInitSorter(){var e=(0,r.ge)("photos_container_photos");cur.photosEditSorter=new GridSorter(e,"photos_photo_edit_row_thumb",{onReorder:p.reorderPhotos})},updateEditHeaderPos(){void 0===cur.photosEditHeaderEl&&(cur.photosEditHeaderEl=(0,r.geByClass1)("photos_edit_selection_header")),cur.photosEditHeaderEl&&(cur.photosEditHeaderElOffset=cur.photosEditHeaderElOffset||(0,r.getXY)(cur.photosEditHeaderEl)[1]-(0,r.getSize)((0,r.ge)("page_header_cont"))[1],scrollGetY()>=cur.photosEditHeaderElOffset?(0,r.hasClass)(cur.photosEditHeaderEl,"photos_header_fixed")||((0,r.addClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,r.setStyle)(cur.photosEditHeaderEl,{width:(0,r.getSize)((0,r.ge)("page_body"))[0]}),(0,r.setStyle)((0,r.domNS)(cur.photosEditHeaderEl),{"margin-top":(0,r.getSize)(cur.photosEditHeaderEl)[1]+"px"})):((0,r.removeClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,r.setStyle)(cur.photosEditHeaderEl,{width:""}),(0,r.setStyle)((0,r.domNS)(cur.photosEditHeaderEl),{"margin-top":0})))},_editGetSelectedCount(){var e=(0,r.geByClass)("photos_edit_selected").length;if(cur.photoEditSelectedAll){var t=(0,r.geByClass)("photos_photo_edit_row").length;e=e<t?cur.count-t+e:cur.count}return e},editSelectAll(e){cur.photoEditSelectedAll=!e,each((0,r.geByClass)("photos_photo_edit_row"),(function(){(0,r.toggleClass)(this,"photos_edit_selected",cur.photoEditSelectedAll)})),p._editUpdateSelectedCounter()},_editUpdateSelectedCounter(){var e,t=p._editGetSelectedCount();e=t?(0,d.getLang)("photos_edit_selected_count").replace("{total}",cur.count).replace("{count}",t):langNumeric(cur.count,cur.lang.photos_edit_selected_count_initial,!0),(0,r.val)((0,r.ge)("photos_edit_selected_label"),e);var o=(0,r.ge)("photos_edit_selected_actions");(0,r.toggleClass)(o,"photos_selected",!!t),(0,r.geByClass)("photos_edit_selected_action",o).forEach((function(e){(0,r.toggleClass)(e,"link_lock",!t)}));var i=(0,r.ge)("photos_select_all_toggle");cur.photosEditSelectedHalf=t>=cur.count/2,cur.photosEditSelectedHalf?(0,r.val)(i,(0,d.getLang)("photos_edit_deselect_all")):(0,r.val)(i,(0,d.getLang)("photos_edit_select_all"))},selectEditPhoto(e,t){var o=(0,r.gpeByClass)("photos_photo_edit_row",t),i=(0,r.toggleClass)(o,"photos_edit_selected");if(e.shiftKey&&cur.photoEditPrevSelectedRowEl&&cur.photoEditPrevSelectedRowEl!=o)for(var n=(0,r.gpeByClass)("photos_edit_photos_container",t),a=(0,r.domFC)(n),s=0;s<2&&a;)a!=cur.photoEditPrevSelectedRowEl&&a!=o||s++,s&&(0,r.toggleClass)(a,"photos_edit_selected",i),a=(0,r.domNS)(a);return cur.photoEditPrevSelectedRowEl=o,p._editUpdateSelectedCounter(),cancelEvent(e),!1},startEditPhotoDescription(e,t){p.stopEditPhotoDescription();var o=(0,r.gpeByClass)("photos_edit_photos_container",t),i=(0,r.hasClass)(t,"photos_photo_edit_row")?t:(0,r.gpeByClass)("photos_photo_edit_row",t),n=(0,r.geByClass1)("photos_photo_edit_row_desc_cont",i),a=(0,r.geByClass1)("photos_photo_edit_row_desc_placeholder",i),s=(0,r.geByClass1)("photos_photo_edit_row_desc_input",i);function l(e,t,o,i){var n=clean((0,r.val)(o)).split("\n").join("<br>")+"&nbsp;",a=(0,r.ce)("div",{innerHTML:n,className:"photos_photo_edit_row_desc_input"},{width:(0,r.getSize)(t)[0],display:"block",visibility:"hidden"});e.appendChild(a);var s=(0,r.getSize)(a)[1]+(browser.msie?10:0);(0,r.setStyle)(o,{height:Math.min(p.MAX_DESC_INPUT_HEIGHT,Math.round(s))}),(0,r.re)(a)}(0,r.val)(s,s.getAttribute("data-orig-desc")),l(n,a,s),(0,r.show)(s),addEvent(document,"click",p.stopEditPhotoDescription),removeEvent(s,"input"),addEvent(s,"input",l.pbind(n,a,s)),s.select(),(0,r.addClass)(o,"photos_desc_editing"),(0,r.addClass)(i,"photos_row_desc_editing"),e&&cancelEvent(e)},onEditPhotoDescriptionKeyPress(e){switch(e.keyCode){case 27:p.stopEditPhotoDescription(null,!0);break;case 9:p.stopEditPhotoDescription(null,!1);var t=(0,r.gpeByClass)("photos_photo_edit_row",e.currentTarget);(t=(0,r.domNS)(t))&&p.startEditPhotoDescription(null,t),cancelEvent(e)}},stopEditPhotoDescription(e,t){var o;e&&(0,r.hasClass)(e.target,"photos_photo_edit_row_desc_input")||(removeEvent(document,"click",p.stopEditPhotoDescription),each((0,r.geByClass)("photos_row_desc_editing"),(function(){o=this,(0,r.removeClass)(o,"photos_row_desc_editing");var e=(0,r.geByClass1)("photos_photo_edit_row_desc_placeholder",o),i=(0,r.geByClass1)("photos_photo_edit_row_desc_input",o),n=o.getAttribute("data-id"),a=o.getAttribute("data-edit-hash"),s="";t?s=i.getAttribute("data-orig-desc"):((s=trim((0,r.val)(i)))!=i.getAttribute("data-orig-desc")&&ajax.post("al_photos.php",{act:"save_desc",photo:n,hash:a,text:s,edit:1},{}),i.setAttribute("data-orig-desc",s),e.titleSet=!1);(0,r.val)(e,clean(s)||(0,d.getLang)("photos_add_description_placeholder")),(0,r.toggleClass)(e,"photos_edit_has_desc",!!s),(0,r.hide)(i)})),(0,r.removeClass)((0,r.gpeByClass)("photos_edit_photos_container",o),"photos_desc_editing"))},updatePeriods(){cur.periods=(0,r.geByClass)("photos_period_delimiter",(0,r.ge)("photos_all_block"))},destroyPeriod(){cur.fixedPeriod&&((0,r.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)},fixPeriod(){if((0,r.ge)("photos_albums_block")&&(p.headerHeight=p.headerHeight||(0,r.getSize)((0,r.ge)("page_header_cont"))[1],cur.periods&&cur.periods.length)){var e=vk.staticheader?Math.max(scrollGetY(),p.headerHeight):scrollGetY()+p.headerHeight,t=!1,o=!1,i=(0,r.getSize)(cur.periods[0])[1];for(var n in cur.periods)if(cur.periods.hasOwnProperty(n)){if((0,r.getXY)(cur.periods[n])[1]>=e)break;t=cur.periods[n];var a=intval(n)+1;o=!!cur.periods[a]&&(0,r.getXY)(cur.periods[a])[1]-e}if(t&&!cur.fileApiUploadStarted){if(t==cur.fixedPeriodEl)setTimeout((function(){(0,r.setStyle)(cur.fixedPeriod,{left:(0,r.getXY)(t)[0]+"px"})}));else{if(cur.fixedPeriod)cur.fixedPeriod.innerHTML=t.innerHTML;else{var s=cur.fixedPeriod=(0,r.ce)("div",{innerHTML:t.innerHTML,className:"photos_period_delimiter_fixed"},{left:(0,r.getXY)(t)[0]+"px"});(0,r.ge)("page_body").appendChild(cur.fixedPeriod),(cur._back?cur._back.hide:cur.destroy).push((function(){(0,r.re)(s)}))}cur.fixedPeriodEl=t}var l=!1!==o?o-i:0;l>=0&&(l=0),cur.fixedPeriodTop!==l&&((0,r.setStyle)(cur.fixedPeriod,{top:l+"px"}),cur.fixedPeriodTop=l)}else!t&&cur.fixedPeriod&&((0,r.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)}},scrollResize(){if(!browser.mobile&&!cur.pvShown){var e=document.documentElement,t=window.innerHeight||e.clientHeight||bodyNode.clientHeight,o=scrollGetY(),i=(0,r.ge)("ui_photos_load_more"),n=(0,r.ge)("ui_albums_load_more"),a=(0,r.ge)("ui_tagged_load_more"),s=.8*t;(0,r.isVisible)(i)&&i.offsetTop-(o+t)<s&&p.load(),(0,r.isVisible)(n)&&cur.showAllAlbums&&n.offsetTop-(o+t)<s&&p.load(p.LOAD_TYPE_ALBUMS),(0,r.isVisible)(a)&&cur.showAllTagged&&a.offsetTop-(o+t)<s&&p.load(p.LOAD_TYPE_TAGGED),cur.fixPeriods&&p.fixPeriod(),p.updateEditHeaderPos()}},initScroll(){cur.module="photos",p.scrollnode=browser.msie6?pageNode:window,addEvent(p.scrollnode,"scroll",p.scrollResize),addEvent(window,"resize",p.scrollResize),removeEvent(window,"load",p.initScroll),cur.destroy.push((function(){removeEvent(p.scrollnode,"scroll",p.scrollResize),removeEvent(window,"resize",p.scrollResize)}))},recache(e,t){if(cur.loading)return cur.loading=1,void setTimeout(p.recache.pbind(e,t),100);for(var o=cur.offset;ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"];o+=20){var r=ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"];r[0]+=t,ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+(o+t)+"&part=1"]=r,delete ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"]}cur.offset+=t},loaded(e,t,o,i){var n,a,s,l,d,c;switch(i||(cur.loading=0),i=i||p.LOAD_TYPE_PHOTOS){case p.LOAD_TYPE_TAGGED:cur.taggedOffset=e,s=cur.moreFromTagged,d=cur.moreTaggedOpts,l=cur.taggedOffset;break;case p.LOAD_TYPE_ALBUMS:cur.albumsOffset=e,s=cur.moreFromAlbums,d=cur.moreAlbumsOpts,l=cur.albumsOffset,c=cur.albumsCount;break;default:cur.offset=e,s=cur.moreFrom,d=cur.moreOpts,l=cur.offset,c=cur.count}n=(0,r.ge)("photos_container_"+i),a=(0,r.ge)("ui_"+i+"_load_more");for(var u=(0,r.ce)("div",{innerHTML:trim(t)});u.firstChild;){if((0,r.hasClass)(u.firstChild,"photos_period_delimiter")){var h=u.firstChild.getAttribute("data-year");if((0,r.geByClass1)("photos_period_delimiter_"+h)){(0,r.re)(u.firstChild);continue}}cur.photoEditSelectedAll&&(0,r.addClass)(u.firstChild,"photos_edit_selected"),n.appendChild(u.firstChild)}o&&extend(cur.privacy,o),i==p.LOAD_TYPE_PHOTOS&&p.updatePeriods(),e>=c||!t?(0,r.hide)(a):i!=p.LOAD_TYPE_PHOTOS&&(cur.loading=1,ajax.post(s,extend({offset:l,part:1},d||{}),{cache:1,onDone:function(){2==cur.loading?p.loaded.apply(window,arguments):cur.loading=!1},onFail:function(){return cur.loading=0,!0}}))},load(e){var t,o,n,a;switch(e=e||p.LOAD_TYPE_PHOTOS){case p.LOAD_TYPE_PHOTOS:t=(0,r.ge)("ui_photos_load_more"),o=cur.moreFrom,n=cur.moreOpts,a=cur.offset;break;case p.LOAD_TYPE_TAGGED:t=(0,r.ge)("ui_tagged_load_more"),o=cur.moreFromTagged,n=cur.moreTaggedOpts,a=cur.taggedOffset;break;case p.LOAD_TYPE_ALBUMS:t=(0,r.ge)("ui_albums_load_more"),o=cur.moreFromAlbums,n=cur.moreAlbumsOpts,a=cur.albumsOffset}o&&(0,r.isVisible)(t)&&!(0,i.isButtonLocked)(t)&&(cur.loading?cur.loading=2:(e==p.LOAD_TYPE_PHOTOS&&n&&(cur.loading=1),ajax.post(o,extend({offset:a,part:1},n||{}),{onDone:p.loaded,onFail:function(){return cur.loading=0,!0},showProgress:function(){(0,i.lockButton)(t)},hideProgress:function(){(0,i.unlockButton)(t)},cache:1})))},loadMoreButtonClick(e){switch(e){case p.LOAD_TYPE_ALBUMS:cur.showAllAlbums=!0;break;case p.LOAD_TYPE_TAGGED:cur.showAllTagged=!0}this.load(e)},reorderAlbums(e,t,o){var r=e.id.replace("album",""),i=(t&&t.id||"").replace("album",""),n=(o&&o.id||"").replace("album","");ajax.post("al_photos.php",{act:"reorder_albums",album:r,before:i,after:n,hash:cur.reorderHash})},reorderPhotos(e,t,o){var i="edit"==nav.objLoc.act?"photo_edit_row_":"photo_row_",n=e.id.replace(i,""),a=(t&&t.id||"").replace(i,""),s=(o&&o.id||"").replace(i,""),l=(0,r.domData)((0,r.ge)("photos_container_photos"),"rev");l=l?"1"===l?1:"":nav.objLoc.rev,ajax.post("al_photos.php",{act:"reorder_photos",photo:n,before:a,after:s,rev:l,hash:cur.reorderHash})},privacy(e){if("photos_move"==e){var t=Privacy.getValue(e);return(t=(t=t.split("_"))[2])!=cur.album.split("_")[1]&&p.movePhoto(t),!0}var o=e.match(/^album(\d+)/);if(o){var i=(0,r.ge)("album"+vk.id+"_"+o[1]);if(i){if(i.helper){var n=(0,r.getSize)(i);if(n[0]!=i.w||n[1]!=i.h){(0,r.setStyle)(i.helper,{width:n[0],height:n[1]-(0,r.ge)("photos_container").sorter.dh}),extend(i,{x:i.x-i.w/2+n[0]/2,w:n[0],y:i.y-i.h/2+n[1]/2,h:n[1]});for(var a=i.nextSibling;a&&a.nextSibling;a=a.nextSibling.nextSibling)(0,r.setStyle)(a.nextSibling,{left:a.offsetLeft,top:a.offsetTop})}}clearTimeout(cur["privacy_timer_"+e]),cur["privacy_timer_"+e]=setTimeout(ajax.post.pbind("al_friends.php",{act:"save_privacy",key:e,val:Privacy.getValue(e),hash:cur.privacyHash}),500)}}},deleteAlbum(e,t){(0,n.showFastBox)({title:(0,d.getLang)("photos_deleting_album"),dark:1,bodyStyle:"padding: 20px;"},(0,d.getLang)("photos_sure_del_album"),(0,d.getLang)("global_delete"),(function(o){ajax.post("al_photos.php",{act:"delete_album",album:e,hash:t},{showProgress:i.lockButton.pbind(o),hideProgress:i.unlockButton.pbind(o)})}),(0,d.getLang)("global_cancel"))},showSaved(e,t){var o=(0,r.ge)(e),i=function(){setTimeout(animate.pbind(o,{backgroundColor:t,borderLeftColor:"#D8DFEA",borderRightColor:"#D8DFEA",borderTopColor:"#D8DFEA",borderBottomColor:"#D8DFEA"},1e3),1e3)};(0,r.isVisible)(o)?animate(o,{backgroundColor:"#E7F1F9",borderLeftColor:"#4C96D4",borderRightColor:"#4C96D4",borderTopColor:"#4C96D4",borderBottomColor:"#4C96D4"},200,i):((0,r.show)(o),i())},saveAlbum(e){var t={act:"save_album",album:cur.album,hash:cur.albumhash,title:(0,r.ge)("album_title").value,desc:(0,r.ge)("album_description").value,enable_hintach:isChecked("hintach_enabled_for_album")};if(!t.title)return(0,i.notaBene)("album_title");var o=cur.album.replace(vk.id+"_","");cur.privacy["album"+o]?extend(t,{view:Privacy.getValue("album"+o),comm:Privacy.getValue("albumcomm"+o)}):(0,r.ge)("album_only_check")&&extend(t,{main:isChecked("album_main_check"),only:isChecked("album_only_check"),comm:isChecked("album_comments_check")}),ajax.post("al_photos.php",t,{onDone:function(){var e=(0,r.ge)("album_main_check");e&&isChecked(e)&&((0,r.addClass)(e,"on"),(0,r.addClass)(e,"disabled"),(0,r.hide)("album_delete_action"));var t=(0,r.ge)("photos_changes_saved");(0,r.setStyle)(t,{opacity:1}),setTimeout((function(){(0,r.setStyle)(t,{opacity:0})}),1500)},showProgress:i.lockButton.pbind(e),hideProgress:i.unlockButton.pbind(e)})},savePhotos(){for(var e={act:"save_photos",album:cur.album,hash:cur.albumhash},t=(0,r.ge)("photos_container"),o=0,i=t.firstChild;i;i=i.nextSibling)if(i.firstChild&&(0,r.isVisible)(i.firstChild)){var n=i.id.replace("photo_edit_row","");e["photo_id"+o]=n,e["photo_desc"+o]=(0,r.ge)("photo_caption"+n).value,++o}ajax.post("al_photos.php",e,{onDone:function(){for(var e=t.firstChild;e;e=e.nextSibling)if(e.firstChild&&(0,r.isVisible)(e.firstChild)){var o=e.id.replace("photo_edit_row","");(0,r.ge)("photo_save_result"+o).innerHTML=(0,d.getLang)("photos_privacy_description")}cur.descs=!1,scrollToTop(200),p.showSaved("photos_saved_msg","#F3F8FC"),(0,r.ge)("photos_container").sorter&&sorter.update((0,r.ge)("photos_container").sorter.elems[0])},progress:"photos_save_progress"})},deleteSelectedPhotos(e){var t=[];each((0,r.geByClass)("photos_edit_selected"),(function(){t.push(this.getAttribute("data-id"))}));var o=intval(p._editGetSelectedCount()>t.length),i=cur.album.split("_");showBox("/al_photos.php",{act:"delete_selected_box",Photo_ids:o?"":t.join(","),owner_id:i[0],album_id:i[1],all:o},{onDone(){var t=curBox();t.removeButtons(),t.addButton((0,d.getLang)("photos_del_selected_box_yes"),(t=>{(0,r.show)("photos_del_box_progress"),(0,r.hide)("photos_del_box_text"),(0,r.re)(t);var o=(0,r.ge)("photos_del_box_progress_text");p.doEditBatchProcess({act:"delete_photos",hash:e,owner_id:i[0],album_id:i[1]},cur.editDeletePhotosArray,(0,r.ge)("photos_del_box_progress_wrap"),"photos_del_selected_title_progress",(function(e,t,i,n,a){(0,r.val)(o,(0,d.getLang)("photos_del_selected_box_text_progress").replace("{count}",n).replace("{total}",a)),cur.count=Math.max(cur.count-e,0),each(i,(function(e,t){(0,r.re)("photo_edit_row_"+t),cur.count=Math.max(cur.count,0)})),p._editUpdateSelectedCounter()}),(function(){var e=curBox();(e&&e.hide(),0==cur.count)?nav.reload():(0,r.geByClass)("photos_photo_edit_row").length<40&&p.load()}))})),t.addButton((0,d.getLang)("box_cancel"),(function(){t.hide(),cur.editDeletePhotosArray=!1}),"no")}})},doEditBatchProcess(e,t,o,i,n,a){var s=t.split(","),l=s.length,c=cur.editPhotosMaxChunkSize||50,u=Math.ceil(l/c),h=(0,r.geByClass1)("photos_progress_bar",(0,r.ge)(o))||(0,r.geByClass1)("ui_progress_bar",(0,r.ge)(o)),p=0,g=document.title,_=curBox();n(0,!1,[],0,l),function t(o){if(!_.isVisible())return a(p),void(0,r.setDocumentTitle)(g);var f=s.slice(o*c,(o+1)*c);ajax.post("/al_photos.php",extend({photos:f.join(",")},e),{onDone:function(e,s,c){p+=e,o++,(0,r.setStyle)(h,{width:100*o/u+"%"});var _=(0,d.getLang)(i).replace("{count}",p).replace("{total}",l);(0,r.setDocumentTitle)(_),n(e,s,f,p,l,c),o<u?t(o):setTimeout((function(){(0,r.setDocumentTitle)(g),a(p,s)}),200)}})}(0)},_showProgressPanel(e){var t=(0,r.se)('<div class="photo_mask_progress _photo_mask_progress"><div class="photos_editing_background"></div><div class="round_spinner"></div></div>');return e.appendChild(t),t},_hideProgressPanel(e){(0,r.re)((0,r.geByClass1)("_photo_mask_progress",e))},deletePhoto(e,t,o,i){var n;if(""===e&&o&&(n=(0,r.gpeByClass)("photos_photo_edit_row",o),e=(0,r.attr)(n,"data-id"),t=(0,r.attr)(n,"data-edit-hash")),n=n||(0,r.ge)("photo_edit_row_"+e)){var a=p._showProgressPanel(n);return(0,r.addClass)(n,"photos_deleted"),ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:1},{onDone:function(e){(0,r.re)(a),n.appendChild((0,r.se)(e)),p.recache(cur.offset,-1),cur.count-=1,p._editUpdateSelectedCounter(),cur.count<2&&(0,r.hide)("album_thumb_action"),(0,r.ge)("photos_go_to_album_cont")&&!cur.count&&(0,r.hide)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(n),cur.introTooltipHide&&cur.introTooltipHide(!0)}}),cancelEvent(i)}},restorePhoto(e,t,o){var i=(0,r.ge)("photo_edit_row_"+t);if(i&&(0,r.hasClass)(i,"photos_deleted")){var n=p._showProgressPanel(i);(0,r.re)((0,r.geByClass1)("photos_restore",i)),ajax.post("al_photos.php",{act:"restore_photo",photo:t,hash:o,edit:1},{onDone:function(){(0,r.re)(n),(0,r.removeClass)(i,"photos_deleted"),p.recache(cur.offset,1),cur.count+=1,p._editUpdateSelectedCounter(),cur.count>1&&(0,r.show)("album_thumb_action"),(0,r.ge)("photos_go_to_album_cont")&&cur.count&&(0,r.show)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(i)},progress:"photo_restore_progress"+t})}},toggleMoveToAlbumMode(e,t){var o=(0,r.ge)("photos_move_box_search"),i=(0,r.ge)("pv_move_to_album_cont"),n=(0,r.ge)("photos_box_edit_data"),a=curBox(),s=(0,r.geByClass1)("box_title",a.titleWrap);if(e){(0,r.hide)(o),(0,r.hide)(i),(0,r.show)(n),a.setOptions({width:500});var l=(0,d.getLang)("photos_move_to_new_album_title");cur.noAlbums||(l+=`\n          <span class="divider">|</span>\n          <a onclick="return photos.toggleMoveToAlbumMode(false, event)" href="" class="toggle">\n            ${(0,d.getLang)("photos_move_to_another_album_toggle")}\n          </a>\n        `),(0,r.val)(s,l),a.removeButtons().addButton((0,d.getLang)("photos_create_album_and_move"),cur.saveNewAlbum).addButton((0,d.getLang)("global_cancel"),a.hide,"no"),cur.onNewAlbumDone=function(e){curBox().hide(),p.movePhotosBox(cur.editPhotosArray.split(","),!1,(function(){setTimeout((function(){var t=(0,r.ge)("album"+e);p.doMovePhotos(!1,t)}))}))}}else(0,r.show)(o),(0,r.show)(i),(0,r.hide)(n),a.setOptions({width:795}),(0,r.val)(s,(0,d.getLang)("photos_move_box_title")+'<span class="divider">|</span><a onclick="return photos.toggleMoveToAlbumMode(true, event)" href="" class="toggle">'+(0,d.getLang)("photos_move_to_new_album")+"</a>"),a.removeButtons().addButton((0,d.getLang)("global_cancel"),a.hide);return cancelEvent(t)},showMove(e,t,o){var i=cur.moveddc,n=(0,r.ge)("photos_move_link"+e);cur.privacyPhotoMove?Privacy.show(n,o,"photos_move"):(cur.zIndexUpdated&&(p.hideMove(),cur.noZIndexUpdate=!0),(0,r.ge)("photo_edit_row"+e)&&(cur.zIndexUpdated=e,(0,r.setStyle)((0,r.ge)("photo_edit_row"+e),{zIndex:150})),p.hideMove()),extend(cur,{movelnk:n,moveph:e,movehash:t}),cur.privacyPhotoMove||(n.parentNode.replaceChild(i,n),cur.movedd.focus(),cur.movedd.showDefaultList(),addEvent(document,"click",p.hideMove))},hideMove(){if(cur.noZIndexUpdate)delete cur.noZIndexUpdate;else if(!cur.privacyPhotoMove){if(cur.movelnk)try{cur.moveddc.parentNode.replaceChild(cur.movelnk,cur.moveddc),cur.movelnk=!1,cur.movedd.clear(),cur.zIndexUpdated&&(0,r.ge)("photo_edit_row"+cur.zIndexUpdated)&&((0,r.setStyle)((0,r.ge)("photo_edit_row"+cur.zIndexUpdated),{zIndex:100}),delete cur.zIndexUpdated)}catch(e){}removeEvent(document,"click",p.hideMove)}},movePhoto(e,t,o){e=intval(e);var i=r.show.pbind("photo_return_progress"+t),a=r.hide.pbind("photo_return_progress"+t);if(!t){if(!e||e==cur.album.split("_")[1])return p.hideMove();t=cur.moveph,o=cur.movehash,i=function(){(0,r.hide)("photo_delete_link"+t),(0,r.show)("photo_edit_progress"+t)},a=function(){(0,r.hide)("photo_edit_progress"+t),(0,r.show)("photo_delete_link"+t)}}ajax.post("al_photos.php",{act:"move_photo",album:e,photo:t,hash:o},{onDone:function(o){var i=(0,r.ge)("photo_edit_row"+t);if(i&&i.firstChild){if(e==cur.album.split("_")[1]){if((0,r.isVisible)(i.firstChild))return;i.removeChild(i.firstChild.nextSibling),(0,r.show)(i.firstChild),p.recache(cur.offset,1),++cur.count,cur.count>1&&(0,r.show)("album_thumb_action")}else{if(!(0,r.isVisible)(i.firstChild))return;p.hideMove(),(0,r.hide)(i.firstChild),i.appendChild((0,r.ce)("div",{innerHTML:o})),p.recache(cur.offset,-1),--cur.count,cur.count<2&&(0,r.hide)("album_thumb_action")}cur.photoAddUpdate&&cur.photoAddUpdate(i),cur.introTooltipHide&&cur.introTooltipHide(!0),(0,r.ge)("photos_go_to_album_cont")&&(0,r.toggle)("photos_go_to_album_cont",!!cur.count)}},onFail:function(e){if(p.hideMove(),e)return setTimeout((0,n.showFastBox)({title:(0,d.getLang)("global_error"),dark:1,bodyStyle:"padding: 20px;"},e).hide,2e3),!0},showProgress:i,hideProgress:a})},updateThumbs(e,t){var o=(0,r.ge)("photos_add_img"+cur.peEditPhoto);o&&(o.src=e)},editPhoto(e,t,o){cur.peEditPhoto=e,showBox("al_photos.php",{act:"edit_photo",photo:e,webgl:1,stat:["ui_controls.css","ui_controls.js"]},{dark:1})},backupDesc(e){cur.descs||(cur.descs={}),cur.descs[e]=trim((0,r.ge)("photo_caption"+e).value)},saveDesc(e,t){var o=(0,r.ge)("photo_caption"+e).value,i=cur.descs[e];delete cur.descs[e],trim(o)!=i&&ajax.post("al_photos.php",{act:"save_desc",photo:e,hash:t,text:o,edit:1},{onDone:function(t){(0,r.ge)("photo_save_result"+e).innerHTML=t},onFail:function(t){return(0,r.ge)("photo_save_result"+e).innerHTML='<div class="photo_save_error">'+t+"</div>",!0},showProgress:function(){(0,r.ge)("photo_save_result"+e).innerHTML=(0,d.getLang)("photos_privacy_description"),(0,r.show)("photo_save_progress"+e)},hideProgress:function(){(0,r.hide)("photo_save_progress"+e)}})},genFile:(e,t,o)=>(0,r.ce)("div",{innerHTML:`\n        <a class="photo_file_cancel" id="photo_cancel${e}" onclick="${t}">${o}</a>\n        <div class="photo_file_button">\n          <div class="file_button_gray">\n            <div class="file_button" id="photo_file_button${e}">${(0,d.getLang)("photos_choose_file")}</div>\n          </div>\n        </div>\n      `}),initFile(e){FileButton.init("photo_file_button"+e,{name:"photo",id:"photo_file"+e,accept:"image/jpeg,image/png,image/gif",onchange:p.fileSelected})},addFile(){var e=cur.files.length,t=p.genFile(e,"photos.fileCancel("+e+")",(0,d.getLang)("global_cancel"));extend(t,{className:"photo_upload_file",id:"photo_upload_row"+e}),(0,r.ge)("photo_upload_files").appendChild(t),p.initFile(e),cur.files.push({})},filesLoad(){for(var e=0,t=0;e<cur.files.length;++e){if((0,r.ge)("photo_file"+e).value)break}if(e!=cur.files.length){cur.allcont=utilsNode.appendChild((0,r.ce)("div",{innerHTML:`\n        <iframe name="photo_frame_all"></iframe>\n        <form target="photo_frame_all" id="photo_form_all" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));var o=(0,r.ge)("photo_form_all"),i=extend(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"photos.filesDone",onfail:"photos.filesFail"});for(t in i)i.hasOwnProperty(t)&&o.appendChild((0,r.ce)("input",{name:t,value:i[t]}));for(e=0,t=0;e<cur.files.length;++e){var n=(0,r.ge)("photo_file"+e);n.value&&(n.name="file"+t,o.appendChild(n),++t)}o.submit()}},fileSelected(){var e=intval(this.id.replace("photo_file",""));if(cur.files[e].deleting||!cur.files[e].cont&&!cur.files[e].id){cur["fileDone"+e]=p.fileDone.pbind(e),cur["fileFail"+e]=p.fileFail.pbind(e),cur.files[e].cont=utilsNode.appendChild((0,r.ce)("div",{innerHTML:`\n        <iframe name="photo_frame${e}"></iframe>\n        <form target="photo_frame${e}" id="photo_form${e}" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));var t=(0,r.ge)("photo_form"+e),o=extend(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"cur.fileDone"+e,onfail:"cur.fileFail"+e});for(var n in o)o.hasOwnProperty(n)&&t.appendChild((0,r.ce)("input",{name:n,value:o[n]}));t.appendChild(this),t.submit();var a=(0,r.ge)("photo_file_button"+e);(0,i.lockButton)(a),setTimeout((function(){a.innerHTML=a.innerHTML}),0),(0,r.show)("photo_cancel"+e),(0,r.ge)("photo_cancel"+e).innerHTML=(0,d.getLang)("global_cancel"),e==cur.files.length-1&&p.addFile()}},fileDone(e,t){(0,r.hide)("photo_cancel"+e);for(var o="",i=e+1;i<cur.files.length;++i)if(cur.files[i].id&&!cur.files[i].deleting){o=cur.files[i].id;break}setTimeout(ajax.post.pbind("al_photos.php",extend({act:"done_add",before:o,context:1},AjaxConvert.fromQueryString(t)),{onDone:function(t,o){if(!t)return p.fileFail(e,0);cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont),extend(cur.files[e],{id:t,deleting:!1,cont:!1}),(0,r.ge)("photo_upload_row"+e).innerHTML=o,autosizeSetup("photo_caption"+t,{minHeight:30}),(0,r.show)("photo_delete"+t)},onFail:function(t){if(t)return setTimeout((0,n.showFastBox)({title:(0,d.getLang)("global_error"),dark:1,bodyStyle:"padding: 20px;"},t).hide,3e3),p.fileCancel(e),!0}}),0)},fileCancel(e,t){if(cur.files[e].cont&&(cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont)),!t){var o=(0,r.ge)("photo_file_button"+e);(0,i.unlockButton)(o),o.innerHTML=(0,d.getLang)("photos_choose_file"),cur.files[e]={},p.initFile(e),(0,r.hide)("photo_cancel"+e)}},fileFail(e,t){p.fileCancel(e)},fileDelete(e,t){for(var o=0;o<cur.files.length&&cur.files[o].id!=e;)++o;if(o!=cur.files.length&&!cur.files[o].deleting){cur.files[o].deleting=!0,ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:2},{onFail:function(){cur.files[o].deleting=!1}});var i=(0,r.ge)("photo_edit_row"+e);i.parentNode.insertBefore(p.genFile(o,"photos.fileRestore('"+e+"', '"+t+"')",(0,d.getLang)("global_restore")),i),(0,r.hide)(i),p.initFile(o),(0,r.show)("photo_cancel"+o)}},fileRestore(e,t){for(var o=0,i="";o<cur.files.length&&cur.files[o].id!=e;)++o;if(o!=cur.files.length&&cur.files[o].deleting&&-1!==cur.files[o].deleting){if(cur.files[o].cont)return p.fileCancel(o);for(var n=o+1;n<cur.files.length;++n)if(cur.files[n].id&&!cur.files[n].deleting){i=cur.files[n].id;break}cur.files[o].deleting=-1,ajax.post("al_photos.php",{act:"restore_photo",photo:e,hash:t,before:i,edit:2},{onDone:function(){cur.files[o].deleting=!1}});var a=(0,r.ge)("photo_edit_row"+e);(0,r.show)(a),(0,r.re)(a.previousSibling)}},filesDone(e){setTimeout(ajax.post.pbind("al_photos.php",extend({act:"done_add",context:2},AjaxConvert.fromQueryString(e))),0)},filesFail(){for(var e=0;e<cur.files.length;++e)p.fileCancel(e);cur.allcont.innerHTML="",utilsNode.removeChild(cur.allcont),cur.allcont=!1},chooseFlash(){if(browser.flash<10)return animate((0,r.ge)("photo_flash_needed"),{backgroundColor:"#FFEFE8",borderBottomColor:"#E89B88",borderLeftColor:"#E89B88",borderRightColor:"#E89B88",borderTopColor:"#E89B88"},100,(()=>{animate((0,r.ge)("photo_flash_needed"),{backgroundColor:"#FFFFFF",borderBottomColor:"#CCCCCC",borderLeftColor:"#CCCCCC",borderRightColor:"#CCCCCC",borderTopColor:"#CCCCCC"},500)}));cur.photoCheckFails=0,(0,r.show)("photo_flash_upload"),(0,r.hide)("photo_default_upload"),(0,r.hide)("photo_upload_unavailable")},chooseDefault(){cur.photoCheckFails=0,(0,r.show)("photo_default_upload"),(0,r.hide)("photo_flash_upload"),cur.serverChecked?((0,r.show)("photo_upload_files"),(0,r.hide)("photo_default_check")):((0,r.hide)("photo_upload_files"),(0,r.show)("photo_default_check"),cur.checkUpload())},flashWidth:()=>-1==_ua.indexOf("Mac")||-1==_ua.indexOf("Opera")&&-1==_ua.indexOf("Firefox")?"600":"601",activeTab(e){for(var t=(0,r.domPN)((0,r.domPN)(e)),o=(0,r.domFC)(t);o;o=(0,r.domNS)(o))(0,r.removeClass)(o,"active_link");(0,r.addClass)((0,r.domPN)(e),"active_link")},checkHtml5Uploader(){var e=window.XMLHttpRequest||window.XDomainRequest,t=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;return e&&(window.FormData||window.FileReader&&(window.XMLHttpRequest&&XMLHttpRequest.sendAsBinary||window.ArrayBuffer&&window.Uint8Array&&t))},upload:(e,t)=>t&&(2==t.button||t.ctrlKey)?(p.checkHtml5Uploader()&&(e.href+="&html5=1"),!0):!(void 0!==cur.uplId&&window.Upload&&Upload.checked&&Upload.checked[cur.uplId]&&p.checkHtml5Uploader())||((0,r.ge)("photos_upload_input").click(),!1),uploadLink:(e,t)=>(p.checkHtml5Uploader()&&(e.href+="&html5=1"),nav.go(e,t)),onUploadSelect(e){if((0,r.ge)("photos_upload_area")){window.filesToUpload=e;var t=(0,r.ge)("photos_upload_area").innerHTML;(0,r.ge)("photos_upload_area").innerHTML='<img src="/images/upload.gif">',nav.go((0,r.ge)("photos_upload_area").href+"&html5=1",!1,{onFail:function(e){return(0,r.ge)("photos_upload_area").innerHTML=t,setTimeout((0,n.showFastBox)({title:(0,d.getLang)("global_error"),dark:1,bodyStyle:"padding: 20px;"},e).hide,3e3),!0}})}},thumbOver(e,t,o){cur.hideTO&&cur.hideTO[t]&&clearTimeout(cur.hideTO[t]);var i=(0,r.geByClass1)("description",e),n=(0,r.geByClass1)("photo_album_title",e),a=(0,r.getSize)(i)[1];animate(n,{marginTop:163-(a?a+7:0)},{duration:200,transition:Fx.Transitions.easeOutCirc});var s=(0,r.geByClass1)("photo_album_info_back",e),l=(0,r.geByClass1)("photo_album_info_cont",e);if(s&&l)if(!s.over||o){var d=o?.6:.5,c=o?1:.8;o&&(s.over=1),animate(s,{opacity:d},{duration:200,transition:Fx.Transitions.easeOutCirc}),animate(l,{opacity:c},{duration:200,transition:Fx.Transitions.easeOutCirc})}else s.over=0},thumbOut(e,t,o){var i=(0,r.geByClass1)("photo_album_info_back",e),n=(0,r.geByClass1)("photo_album_info_cont",e),a=()=>{if(o){var t=(0,r.geByClass1)("photo_album_title",e);animate(t,{marginTop:163},200)}if(i&&n){var a=o?0:.8;animate(i,{opacity:o?0:.5},200),animate(n,{opacity:a},200)}};o?(cur.hideTO=cur.hideTO||{},cur.hideTO[t]=setTimeout(a,150)):a()},openEditor:(e,t)=>(stManager.add([jsc("web/photoview.js"),"photoview.css"],(function(){var t=(0,r.gpeByClass)("photos_photo_edit_row",e);cur.onPESave=function(e){curBox().hide(),(0,r.setStyle)((0,r.geByClass1)("photos_photo_edit_row_thumb",t),"background-image","url('"+e+"')"),cur.onPESave=!1,bodyNode.style.overflow="auto"};var o=t.getAttribute("data-id");Photoview.openEditor(o,cur.savedThumbs?cur.savedThumbs[o]:t.getAttribute("data-thumb"))})),cancelEvent(t)),addToAlbum(){cur.isPhotoUpload=!0,p.movePhotosBox(cur.savedPhotos||[],!1)},movePhotosBox(e,t,o,i){var n=[],a=!1;isArray(e)?n=e:(""===e&&t&&(e=(0,r.gpeByClass)("photos_photo_edit_row",t).getAttribute("data-id")),e?n.push(e):each((0,r.geByClass)("photos_edit_selected"),(function(){n.push(this.getAttribute("data-id"))})),a=intval(p._editGetSelectedCount()>n.length));var s=cur.album?cur.album.split("_"):[vk.id];return showBox("/al_photos.php",{act:"a_move_to_album_box",photo_ids:a?"":n.join(","),owner_id:s[0],from_album_id:s[1],all:a},{onDone:o}),cancelEvent(i)},cancelMove(e,t,o,i,n,a,s){var l=(0,r.gpeByClass)("photos_photo_edit_row",t);(0,r.re)((0,r.geByClass1)("photos_cancel_move",l)),p._showProgressPanel(l),ajax.post("al_photos.php",{act:"move_photos",photos:o,to_album_id:i,from_album_id:n,hash:s,owner_id:a},{onDone:function(){p._hideProgressPanel(l),cur.count++,p._editUpdateSelectedCounter()}}),cancelEvent(e)},doMovePhotos(e,t,o){var i=(0,r.domClosest)("_photos_album",t),n=(0,r.domData)(i,"aid"),a=(0,r.domData)(i,"from-aid"),s=(0,r.domData)(i,"owner-id"),l=(0,r.domData)(i,"move-hash"),c=(0,r.domData)(i,"from"),u=(0,r.geByClass1)("photos_album_counter",t),h=(0,r.geByClass1)("photos_album_thumb",t),g=(0,r.ge)("pv_move_to_album_progress");h.insertBefore(g,h.children[0]),(0,r.show)(g),(0,r.addClass)(t,"photos_in_progress"),(0,r.addClass)((0,r.gpeByClass)("photos_container_albums",t),"photos_inactive"),p.doEditBatchProcess({act:"move_photos",to_album_id:n,from_album_id:a,owner_id:s,hash:l,from:c},cur.editPhotosArray,(0,r.ge)("pv_move_to_album_progress"),"photos_move_in_progress_title",(function(e,t,i,l,c,h){cur.count=Math.max(cur.count-e,0),(0,r.val)(u,+(0,r.val)(u)+e),each(i,(function(e,t){var i=(0,r.ge)("photo_edit_row_"+t);if(!cur.isPhotoUpload)if(i&&!o){var l="return photos.cancelMove(event, this, '"+t+"', "+a+", "+n+", "+s+", '"+h+"')",c=(0,r.se)(`<div class="photos_cancel_move">\n                <div class="photos_editing_background"></div>\n                <a href="" onclick="${l}">${(0,d.getLang)("global_cancel")}</a></div>`);i.appendChild(c)}else(0,r.re)(i);cur.count=Math.max(cur.count,0)})),p._editUpdateSelectedCounter()}),(function(e,t){var i=curBox();i&&i.hide();var n=langNumeric(e,cur.lang.photos_x_photos_moved_no_cancel);(n=n.replace("{album}",t),showDoneBox(n),cur.pvShown&&cur.pvCurPhoto&&(cur.pvCurPhoto.album=t,(0,r.geByClass1)("pv_album_name").innerHTML=t),o||cur.isPhotoUpload)&&(0==cur.count?nav.reload():(0,r.geByClass)("photos_photo_edit_row").length<40&&p.load())})),e&&cancelEvent(e)},publishPhotos(e){if(cur.savedPhotos){cur.savingPhotos=!0;var t={act:"post",type:"photos_upload",to_id:vk.id,attach1_type:"photos_list",attach1:(cur.savedPhotos||[]).join(","),hash:cur.post_hash};ajax.post("/al_wall.php",t,{showProgress:i.lockButton.pbind(e),onDone:function(){delete cur._back,nav.go("/al_profile.php"),showBackLink()}})}return!1},registerDragZone(e){addEvent(document,"dragenter dragover",(function(t){if(p.checkHtml5Uploader())return setTimeout((function(){clearTimeout(cur.dragTimer),delete cur.dragTimer}),0),e.on(t),cancelEvent(t)})),addEvent(document,"dragleave",(function(t){cur.dragTimer&&(clearTimeout(cur.dragTimer),delete cur.dragTimer),cur.dragTimer=setTimeout((function(){e.un(t)}),100),cancelEvent(t)})),addEvent(document,"drop",(function(t){return e.un(t,!0),e.drop(t.dataTransfer.files),cancelEvent(t)})),cur.destroy.push((function(){removeEvent(document,"dragenter dragover"),removeEvent(document,"dragleave"),removeEvent(document,"drop")}))},initTagBlock(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=document.querySelector(`.${a.PHOTO_TAG_BLOCK_CLASS}`);if(t)try{var o=new a.PhotoTagBlock(t,e);window.cur.destroy.push((()=>o.destroy()))}catch(e){console.error(e),(0,s.logError)(e)}},initAlbumGoUploader(e){var t=e.id,o=e.userId,i=e.groupId,n=e.albumId,a=e.uploadUrl,h=e.endpoint,p=(0,r.ge)("photos_upload_input"),g=(0,r.ge)("photos_upload_area_drop"),_=[],f=c.ImpUploader.init(t,{uploadUrl:a,accept:["image/jpeg","image/png","image/gif","image/heic","image/heif","image/webp"],multiple:!0,input:p,dropArea:g,dragOverClass:"photos_upload_area_enter",onLoadStart:e=>{_.length=0,(0,r.hide)("system_msg"),window.PhotosAdd.onUploadStart(e)},onProgress:e=>{Array.from((0,r.geByClass)("photos_period_delimiter_fixed")).forEach(r.hide),m()},onLoadEnd:(e,t)=>{var r=u(t,1)[0],a={group_id:i,album_id:n,user_id:o,photos_json:JSON.stringify(r)};window.PhotosAdd.onImpUploadComplete(e,a,h,(()=>{_.push(...e),m(),f.nextBatch()}))},onLoadEndAll:(e,t)=>{window.PhotosAdd.onUploadCompleteAll(e,t,!1)},onError:(e,t,o)=>{(0,s.logError)(`${t}: ${o}`,{environment:"go_uploader"}),(0,l.topError)((0,d.getLang)("photos_upload_error"),{type:100});window.PhotosAdd.onImpUploadComplete(e,{},h),window.PhotosAdd.onUploadCompleteAll(null,null)}});window.photos.initAlbumGoUploaderDragZone(t),cur.nav.push((()=>(f.cancelAllUploads(),!0)));var m=()=>{var e=f.uploadedFiles.length,t=f.uploadedFiles[0].loadedSize,o=f.uploadedFiles[0].totalSize,i=_.length;if(i===e)window.PhotosAdd.hideUploadProgress(),(0,r.show)((0,r.ge)("photos_go_to_album"));else{var n=.1*(t/o)+.9*(i/e);window.PhotosAdd.updateProgressBar(n,i,e)}};window.filesToUpload&&window.filesToUpload.length&&(f.manualUploadFiles([...window.filesToUpload]),delete window.filesToUpload)},initAlbumGoUploaderDragZone(e){var t=c.ImpUploader.getUploader(e);this.onAlbumGoUploaderDragEnter=e=>{t.handleDragEnter(e)},window.document.addEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},detachAlbumGoUploaderDragZone(){window.document.removeEventListener("dragenter",this.onAlbumGoUploaderDragEnter)}}},963641:(e,t,o)=>{"use strict";o.d(t,{ImageProxyUploader:()=>l});var r=o(570655),i=o(419710),n=o(834740),a=o(387645),s=o(414914),l=function(){function e(e){var t,o,r,n=this;this.uploadUrl="",this.uploadedFiles=[],this.uploadMode=i.UploadMode.queue,this.uploadRequests=[],this.uploaderTasksQueue=[],this.isDndActive=!1,this.dndTimer=-1,this.handleDrop=function(e){var t;if(e.preventDefault(),e.stopPropagation(),n.dragOverClass&&((0,s.hide)(n.dropArea),null===(t=n.dropArea)||void 0===t||t.classList.remove(n.dragOverClass)),n.isDndActive=!1,e.dataTransfer){var o=n.getAcceptedFilesOnly(e.dataTransfer.files);n.manualUploadFiles(o)}},this.handleInputChange=function(e){var t=e.target.files;if(t&&0!==t.length){var o=n.getAcceptedFilesOnly(t);n.manualUploadFiles(o)}},this.handleDragOver=function(e){e.preventDefault(),e.stopPropagation(),window.setTimeout((function(){window.clearTimeout(n.dndTimer),n.dndTimer=-1}),0)},this.handleDragLeave=function(e){e.preventDefault(),e.stopPropagation(),-1!==n.dndTimer&&window.clearTimeout(n.dndTimer),n.dndTimer=window.setTimeout((function(){var e;n.isDndActive=!1,n.dragOverClass&&((0,s.hide)(n.dropArea),null===(e=n.dropArea)||void 0===e||e.classList.remove(n.dragOverClass))}),100)},this.handleDragEnter=function(e){var t;e.preventDefault(),e.stopPropagation(),n.isDndActive||(window.setTimeout((function(){window.clearTimeout(n.dndTimer),n.dndTimer=-1}),0),n.isDndActive=!0,n.dragOverClass&&(null===(t=n.dropArea)||void 0===t||t.classList.add(n.dragOverClass),(0,s.show)(n.dropArea)))},this.accept=null!==(t=e.accept)&&void 0!==t?t:["image/*"],this.multiple=null!==(o=e.multiple)&&void 0!==o&&o,this.dragOverClass=e.dragOverClass,this.uploadUrl=e.uploadUrl,this.uploadMode=null!==(r=e.uploadMode)&&void 0!==r?r:i.UploadMode.queue,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.dropArea&&this.initDropArea(e.dropArea)}return e.prototype.cancelUpload=function(e){e.cancelled=!0},e.prototype.cancelAllUploads=function(){var e=this;this.uploadedFiles.forEach((function(t){e.cancelUpload(t)}))},e.prototype.nextBatch=function(){var e=this.uploaderTasksQueue.shift();e&&e()},e.prototype.sendFilesUploadEvent=function(e,t){var o=this.uploadedFiles,r=this.uploadRequests.reduce((function(e,t){return e+t.loadedBytes}),0),i=this.uploadRequests.reduce((function(e,t){return e+t.totalBytes}),0);o.forEach((function(n){n.cancelled||(Object.assign(n,{loadedSize:r,totalCount:o.length,totalSize:i}),e(n,t))}))},e.prototype.startFilesUpload=function(e,t){var o=this;this.uploadedFiles=t.map((function(e,o){return{file:e,fileName:e.name,ind:0,loadedSize:0,num:o,totalCount:t.length,totalSize:e.size,uploaded:!1,error:void 0,cancelled:!1}})),this.onLoadStart&&this.sendFilesUploadEvent(this.onLoadStart);for(var n=(0,r.__spreadArray)([],(0,r.__read)(this.uploadedFiles)),a=[],s=function(){for(var t=[],r=0,i=0;i<5&&0!==n.length;i++){var s=n.shift();if(!s)break;if(r+=s.file.size,t.push(s),r>5242880)break}t.length&&a.push((function(){return o.sendUploadRequest(e,t)}))};n.length;)s();var l=[];return this.uploadMode===i.UploadMode.parallel?a.forEach((function(e){l.push(e())})):(a.forEach((function(e){l.push(new Promise((function(t){o.uploaderTasksQueue.push((function(){return e().then((function(e){return t(e),e}))}))})))})),this.nextBatch()),Promise.all(l)},e.prototype.sendUploadRequest=function(e,t){var o=this,r=new FormData,i={loadedBytes:0,totalBytes:0};this.uploadRequests.push(i);for(var a=0;a<t.length;a++){var s=t[a];r.append("file"+(a+1),s.file)}return(0,n.sendUploadRequest)(e,r,i,(function(){o.onProgress&&o.sendFilesUploadEvent(o.onProgress)})).then((function(e){var r;t.forEach((function(e){e.uploaded=!0}));try{r=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return Object.values(r.files).forEach((function(e,i){e&&(o.saveUploaderStateToFileState(t[i],e),Object.assign(t[i],{server:r.server,userId:r.user_id}),i++)})),o.onLoadEnd&&t.length&&o.onLoadEnd(t,[r]),e})).catch((function(e){return t.forEach((function(t){t.errorMessage=e})),e}))},e.prototype.initFileInput=function(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")},e.prototype.initDropArea=function(e){var t,o,r;this.dropArea=e,null===(t=this.dropArea)||void 0===t||t.addEventListener("dragleave",this.handleDragLeave),null===(o=this.dropArea)||void 0===o||o.addEventListener("dragover",this.handleDragOver),null===(r=this.dropArea)||void 0===r||r.addEventListener("drop",this.handleDrop)},e.prototype.destroy=function(){var e,t,o;null===(e=this.dropArea)||void 0===e||e.removeEventListener("dragleave",this.handleDragLeave),null===(t=this.dropArea)||void 0===t||t.removeEventListener("dragover",this.handleDragOver),null===(o=this.dropArea)||void 0===o||o.removeEventListener("drop",this.handleDrop)},e.prototype.getAcceptedFilesOnly=function(e){var t=this;return(0,r.__spreadArray)([],(0,r.__read)(e)).filter((function(e){return(0,a.acceptFile)(e,t.accept)}))},e.prototype.cleanupFields=function(){this.input&&(this.input.value=""),this.uploadRequests=[]},e.prototype.handleError=function(e){var t,o,r=0,i="unknown error";if("string"==typeof e)try{var n=JSON.parse(e);r=null!==(t=n.error_code)&&void 0!==t?t:r,i=null!==(o=n.error_msg)&&void 0!==o?o:i}catch(t){i=e}else i=e.message;this.onError&&this.onError(this.uploadedFiles,r,i)},e.prototype.uploadFiles=function(e){return this.startFilesUpload(this.uploadUrl,e).then((function(e){return Promise.all(e.map((function(e){var t;try{t=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return t})))}))},e.prototype.saveUploaderStateToFileState=function(e,t){t&&(t.error_code?Object.assign(e,{errorCode:t.error_code,errorMessage:t.error_msg}):Object.assign(e,{width:+t.meta.width,height:+t.meta.height,kid:t.meta.kid,secret:t.secret,sha:t.sha}))},e.prototype.manualUploadFiles=function(e){var t=this;e.length?this.uploadFiles(e).then((function(e){var o=t.uploadedFiles.filter((function(e){return!e.cancelled}));t.onLoadEndAll&&o.length&&t.onLoadEndAll(t.uploadedFiles,e)})).finally((function(){t.cleanupFields()})).catch((function(e){t.handleError(e)})):this.cleanupFields()},e}()},387645:(e,t,o)=>{"use strict";o.d(t,{acceptFile:()=>r});var r=function(e,t){if(e&&t){var o=e.name||"",r=(e.type||"").toLowerCase(),i=r.replace(/\/.*$/,"");return t.some((function(e){var t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):r===t}))}return!0}},196132:(e,t,o)=>{"use strict";o.d(t,{ImpUploader:()=>n});var r=o(963641),i=new Map,n={getUploader:function(e){return i.get(e)},init:function(e,t){if(i.has(e)){var o=i.get(e);o&&o.destroy()}var n=new r.ImageProxyUploader(t);return i.set(e,n),n}}},419710:(e,t,o)=>{"use strict";var r;o.d(t,{UploadMode:()=>r}),function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(r||(r={}))},834740:(e,t,o)=>{"use strict";o.d(t,{sendUploadRequest:()=>i});var r=o(570655),i=function(e,t,o,i){return new Promise((function(n,a){var s=new XMLHttpRequest;s.open("POST",e,!0),s.upload.onloadstart=function(e){o.totalBytes+=e.total,i()},s.upload.onprogress=function(e){e.lengthComputable&&(o.loadedBytes=e.loaded,o.totalBytes=e.total),i()},s.onerror=function(){a("Unknown error")},s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE&&200===s.status){if(JSON.parse(s.responseText).error_code)return void a(s.responseText);n(s.responseText)}};var l=function(e){return Array.from(e.entries()).reduce((function(e,t){var o=(0,r.__read)(t,2)[1];return e+("string"==typeof o?o.length:o.size)}),0)}(t);o.totalBytes=l,s.send(t)}))}},994146:(e,t,o)=>{"use strict";o.d(t,{PhotoSuggestedTagCard:()=>a});var r=o(570655),i=o(801147),n=o(116886),a=function(e){function t(t){return e.call(this,t)||this}return(0,r.__extends)(t,e),t.prototype.confirm=function(){return this.tagArea.confirmSuggestedTags(this.getTags(),this,this.confirmBtn)},t.prototype.decline=function(){return this.tagArea.declineSuggestedTags(this.getTags(),this,this.declineBtn)},t.prototype.getResultText=function(e){var t=this.getOwnerId(),o=this.tagArea.getTags()[0].getOwnerNameGenitive(),r="";switch(e){case i.TagCardViewStatus.CONFIRMED:r=(r=t>0?(0,n.getLang)("photo_recognition_confirm_myself_on_photo"):(0,n.getLang)("photo_recognition_confirm_myself_on_photo_group")).replace("{name}",o);break;case i.TagCardViewStatus.DECLINED:r=(r=t>0?(0,n.getLang)("photo_recognition_decline_on_photo"):(0,n.getLang)("photo_recognition_decline_on_photo_group")).replace("{name}",o);break;default:r=(0,n.getLang)("photo_recognition_deleted_tag")}return r},t}(i.PhotoTagCard)},632994:(e,t,o)=>{"use strict";var r;o.d(t,{PhotoTag:()=>i}),function(e){e[e.Initial=0]="Initial",e[e.Confirmed=1]="Confirmed",e[e.Declined=2]="Declined"}(r||(r={}));var i=function(){function e(e,t){this.tagEl=e,this.tagArea=t;var o=e.getAttribute("data-item");if(!o)throw new Error("Tag: incorrect json data");var i=JSON.parse(o);this.id=Number(i.id),this.userId=i.userId,this.name=i.name,this.nameGenitive=i.nameGenitive,this.ownerNameGenitive=i.ownerNameGenitive,this.placerNameGenitive=i.placerNameGenitive,this.nameAccusative=i.nameAccusative,this.isSuggested=Boolean(i.isSuggested),this.sex=Number(i.sex),this.styles={top:i.top,left:i.left,width:i.width,height:i.height};var n=r.Initial;e.classList.contains("PhotoTag--confirm")?n=r.Confirmed:e.classList.contains("PhotoTag--decline")&&(n=r.Declined),this.state=n;var a="tag_cutout"+t.getPhotoRawId()+"_"+i.userId,s=document.getElementById(a);if(!s)throw new Error("Tag: incorrect data");this.cutoutEl=s}return e.prototype.decline=function(){this.tagEl.classList.remove("PhotoTag--confirm"),this.tagEl.classList.add("PhotoTag--decline"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=r.Declined},e.prototype.confirm=function(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.add("PhotoTag--confirm"),this.cutoutEl.classList.add("PhotoTagCutout--transparency"),this.state=r.Confirmed},e.prototype.reset=function(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.remove("PhotoTag--confirm"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=r.Initial},e.prototype.getFullRawId=function(){return this.tagArea.getPhotoRawId()+"_"+this.getId()},e.prototype.getId=function(){return this.id},e.prototype.getUserId=function(){return this.userId},e.prototype.getUserName=function(){return this.name},e.prototype.getUserNameGenitive=function(){return this.nameGenitive},e.prototype.getUserNameAccusative=function(){return this.nameAccusative},e.prototype.getOwnerNameGenitive=function(){return this.ownerNameGenitive},e.prototype.getPlacerNameGenitive=function(){return this.placerNameGenitive},e.prototype.isConfirmed=function(){return this.state===r.Confirmed},e.prototype.getSex=function(){return this.sex},e}()},204182:(e,t,o)=>{"use strict";o.d(t,{PhotoTagArea:()=>c});var r=o(632994),i=o(705456),n=o(486353),a=o(621260),s=o(116886),l=o(791563),d=o(713208),c=function(){function e(e,t,o){var l=this;this.confirmTag=function(e,t,o){o&&(0,i.lockButton)(o);var r=!(0,n.partConfigEnabled)("recognize_mock_turn_off");return new Promise((function(n,d){window.ajax.post("al_photos.php",{act:"confirm_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:l.tagHash},{onDone:function(){l.setConfirmedTags([e]),l.decrementLeftMenuCounterIfNeeded([e]),n()},onFail:function(){return r?(l.setConfirmedTags([e]),n(),!0):((0,a.showDoneBox)((0,s.getLang)("global_unknown_error")),d(),!0)},hideProgress:function(){o&&(0,i.unlockButton)(o)}})}))},this.declineTag=function(e,t,o){return new Promise((function(r,d){o&&(0,i.lockButton)(o);var c=!(0,n.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"delete_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:l.tagHash},{onDone:function(){l.setDeclinedTags([e]),l.decrementLeftMenuCounterIfNeeded([e]),r()},onFail:function(){return c?(l.setDeclinedTags([e]),r(),!0):((0,a.showDoneBox)((0,s.getLang)("global_unknown_error")),d(),!0)},hideProgress:function(){o&&(0,i.unlockButton)(o)}})}))},this.confirmSuggestedTags=function(e,t,o){return l.showConfirmAlertBoxIfNeeded(e).then((function(){o&&(0,i.lockButton)(o);var t=!(0,n.partConfigEnabled)("recognize_mock_turn_off");return new Promise((function(r,n){window.ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:l.getFullRawTagIdsStr(e),track_code:l.trackCode,hash:l.tagHash},{onDone:function(){l.setConfirmedTags(e),l.decrementLeftMenuCounterIfNeeded(e),r()},onFail:function(){return t?(l.setConfirmedTags(e),r(),!0):((0,a.showDoneBox)((0,s.getLang)("global_unknown_error")),n(),!0)},hideProgress:function(){o&&(0,i.unlockButton)(o)}})}))}))},this.declineSuggestedTags=function(e,t,o){return new Promise((function(t,r){o&&(0,i.lockButton)(o);var d=!(0,n.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:l.getFullRawTagIdsStr(e),track_code:l.trackCode,hash:l.tagHash},{onDone:function(){l.setDeclinedTags(e),l.decrementLeftMenuCounterIfNeeded(e),t()},onFail:function(){return d?(l.setDeclinedTags(e),t(),!0):((0,a.showDoneBox)((0,s.getLang)("global_unknown_error")),r(),!0)},hideProgress:function(){o&&(0,i.unlockButton)(o)}})}))};var d=e.getEl().querySelector(".PhotoTagArea");if(!d)throw new Error("error: there is not tag area el");if(!t)throw new Error("error: there is not tag hash");var c=Array.from(e.getEl().querySelectorAll(".PhotoTag"));this.trackCode=o,this.tagArea=d,this.tagHash=t,this.photoEntity=e,this.tags=c.map((function(e){return new r.PhotoTag(e,l)})),this.tagsMap=this.tags.reduce((function(e,t){return e[t.getId()]=t,e}),{})}return e.prototype.showConfirmAlertBoxIfNeeded=function(e){var t=this,o=e[0];return new Promise((function(e,r){if(window.cur.pvNeedShowAlertForOneSuggest&&o.getUserId()!==window.vk.id)var i=(0,s.getLang)("photo_recognition_one_tag_alert"),n=(0,s.langSex)(o.getSex(),(0,s.getLang)("photo_recognition_one_tag_alert_text","raw")).replace("{name}",o.getUserName()),a=(0,l.showFastBox)(i,n,(0,s.getLang)("photo_recognition_one_friend_submit_btn"),(function(){t.hideHint(),a.hide(),e()}),(0,s.getLang)("global_cancel"),(function(){a.hide(),r()}));else e()}))},e.prototype.hideHint=function(){window.cur.pvNeedShowAlertForOneSuggest=!1;var e=window.cur.pvOneSuggestHintId,t=window.cur.pvOneSuggestHintHash;e&&t&&window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:e,hash:t},{onDone:function(){},onFail:function(){return console.error("something wrong with help hint"),!0}})},e.prototype.decrementLeftMenuCounterIfNeeded=function(e){e.forEach((function(e){e.getUserId()===window.vk.id&&(0,d.decrementLeftMenuPhotoCounter)()}))},e.prototype.getFullRawTagIdsStr=function(e){return void 0===e&&(e=this.tags),e.reduce((function(e,t,o){return e+(0===o?"":",")+t.getFullRawId()}),"")},e.prototype.setConfirmedTagsByIds=function(e){var t=this,o=e.reduce((function(e,o){return t.tagsMap[o]&&e.push(t.tagsMap[o]),e}),[]);return!!o.length&&(this.setConfirmedTags(o),!0)},e.prototype.setConfirmedTags=function(e){var t=this;(e=e.filter((function(e){return t.tagsMap[e.getId()]}))).length&&(e.forEach((function(e){return e.confirm()})),this.tagArea.classList.add("PhotoTagArea--fade"))},e.prototype.setDeclinedTags=function(e){e.forEach((function(e){return e.decline()}))},e.prototype.setDeclinedTagsByIds=function(e){var t=this,o=e.reduce((function(e,o){return t.tagsMap[o]&&e.push(t.tagsMap[o]),e}),[]);return!!o.length&&(this.setDeclinedTags(o),!0)},e.prototype.reset=function(){this.tagArea.classList.remove("PhotoTagArea--fade"),this.tags.forEach((function(e){return e.reset()}))},e.prototype.getPhotoRawId=function(){return this.photoEntity.getPhotoRawId()},e.prototype.getTags=function(){return this.tags},e.prototype.getConfirmedTags=function(){return this.tags.filter((function(e){return e.isConfirmed()}))},e.prototype.setSizes=function(e,t){this.tagArea.style.width=e+"px",this.tagArea.style.height=t+"px"},e.prototype.show=function(){this.tagArea.classList.remove("PhotoTagArea--hide")},e.calculateTagAreaSizes=function(e,t,o){var r,i,n=e.offsetWidth,a=e.offsetHeight,s=t/o,l=!0;return n/a>s&&(l=!1),l?(r=Math.round(Math.min(t,n)),i=Math.round(r/s)):(i=Math.round(Math.min(o,a)),r=Math.round(i*s)),[r,i]},e}()},988989:(e,t,o)=>{"use strict";o.d(t,{PHOTO_TAG_BLOCK_CLASS:()=>_,PhotoTagBlock:()=>f});var r=o(570655),i=o(801147),n=o(775478),a=o(3297),s=o(994146),l=o(503369),d=o(705456),c=o(414914),u=o(791563),h=o(116886),p=o(713208),g=o(621260),_="PhotoTagBlock",f=function(){function e(e,t){var o=this;this.isLoading=!1,this.isDestroyed=!1,this.handleOutsideConfirmationSuggestedTags=function(e){var t=e.detail.photoRawId,r=e.detail.tagIds;o.cards.filter((function(e){return e.getPhotoRawId()===t})).forEach((function(e){return e.setConfirmedTagsByIds(r)}))},this.handleOutsideDeclinationSuggestedTags=function(e){var t=e.detail.photoRawId,r=e.detail.tagIds;o.cards.filter((function(e){return e.getPhotoRawId()===t})).forEach((function(e){return e.setDeclinedTagsByIds(r)}))},this.handleOutsideConfirmationUserTag=function(e){var t=e.detail.photoRawId,r=e.detail.tagId,i=o.cards.find((function(e){return e.getPhotoRawId()===t}));i&&i.setConfirmedTagsByIds([r])},this.handleOutsideDeclinationUserTag=function(e){var t=e.detail.photoRawId,r=e.detail.tagId,i=o.cards.find((function(e){return e.getPhotoRawId()===t}));i&&i.setDeclinedTagsByIds([r])},this.handleOutsideDeletingTags=function(e){var t=e.detail.photoRawId,r=e.detail.tagIds;o.cards.filter((function(e){return e.getPhotoRawId()===t})).forEach((function(e){return e.setDeletedTagsByIds(r)}))},this.checkScroll=(0,l.debounce)((function(){o.isLoading||window.innerHeight+window.pageYOffset+700>=o.cardsBlock.getBoundingClientRect().bottom&&o.loadMore()}),200),this.loadMore=function(){!o.isLoading&&o.nextOffset&&(o.isLoading=!0,window.ajax.post("al_photos.php",{act:"recognition_tags",part:1,offset:o.nextOffset,is_full_page:Number(o.isFullPage)},{onDone:function(e,t,i){var n;if(o.isLoading=!1,!o.isDestroyed){o.fullCardsNumber=t,o.nextOffset=i,o.nextOffset||document.removeEventListener("scroll",o.checkScroll);var a=null==e?void 0:e.map((function(e){var t=(0,c.se)(e);return o.cardsBlock.appendChild(t),t}));(null==a?void 0:a.length)&&(n=o.cards).push.apply(n,(0,r.__spreadArray)([],(0,r.__read)(o.createCards(a)))),i||(0,c.hide)(o.loadMoreBtn)}},showProgress:function(){return(0,d.lockButton)(o.loadMoreBtn)},hideProgress:function(){return(0,d.unlockButton)(o.loadMoreBtn)}}))},this.getAllTagElements=function(e){return Array.from(e.querySelectorAll("."+i.PHOTO_TAG_CARD_CLASS))},this.onConfirmAll=function(){if(o.confirmAllHash){var e=o.getActiveCardsNumber();window.ajax.post("al_photos.php",{act:"confirm_all_tags",hash:o.confirmAllHash},{onDone:function(){o.onSubmitAll(e,(0,h.getLang)("photo_tags_confirmed_text",e))},onFail:function(e){return(0,u.showFastBox)((0,h.getLang)("global_error"),e||(0,h.getLang)("global_unknown_error")),!0},showProgress:function(){return(0,d.lockButton)(o.confirmAllBtn)},hideProgress:function(){return(0,d.unlockButton)(o.confirmAllBtn)}})}},this.onDeclineAll=function(){if(o.declineAllHash){var e=o.getActiveCardsNumber();(0,u.showFastBox)((0,h.getLang)("photo_tag_decline_box_title",e),(0,h.getLang)("photo_tag_decline_box_description"),(0,h.getLang)("photo_recognition_decline_all"),(function(t){!function(t){window.ajax.post("al_photos.php",{act:"decline_all_tags",hash:o.declineAllHash},{onDone:function(){o.onSubmitAll(e,(0,h.getLang)("photo_tags_declined_text",e))},onFail:function(e){return(0,u.showFastBox)((0,h.getLang)("global_error"),e||(0,h.getLang)("global_unknown_error")),!0},showProgress:function(){return(0,d.lockButton)(t)},hideProgress:function(){return(0,d.unlockButton)(t)}})}(t)}),(0,h.getLang)("global_cancel"))}},this.block=e,this.isFullPage=t.isFullPage,this.fullCardsNumber=t.fullCardsNumber,this.nextOffset=t.nextOffset,this.confirmAllHash=t.confirmAllHash,this.declineAllHash=t.declineAllHash,this.submitAllLimit=t.submitAllLimit;var n=this.block.querySelector(".PhotoTagBlock__cards");if(!n)throw new Error("PhotoTagBlock: incorrect data");this.cardsBlock=n,this.loadMoreBtn=this.block.querySelector(".PhotoTagBlock__loadMoreBtn"),this.confirmAllBtn=document.querySelector(".PhotoTagBlock__confirmAll"),this.declineAllBtn=document.querySelector(".PhotoTagBlock__declineAll"),this.cards=this.createCards(this.getAllTagElements(this.cardsBlock)),this.initListeners()}return e.prototype.initListeners=function(){var e,t,o;null===(e=this.confirmAllBtn)||void 0===e||e.addEventListener("click",this.onConfirmAll),null===(t=this.declineAllBtn)||void 0===t||t.addEventListener("click",this.onDeclineAll),null===(o=this.loadMoreBtn)||void 0===o||o.addEventListener("click",this.loadMore),document.addEventListener(n.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.addEventListener(n.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.addEventListener(n.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.addEventListener(n.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.addEventListener(n.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.nextOffset&&this.isFullPage&&window.addEventListener("scroll",this.checkScroll)},e.prototype.deInitListeners=function(){var e,t,o;null===(e=this.confirmAllBtn)||void 0===e||e.removeEventListener("click",this.onConfirmAll),null===(t=this.declineAllBtn)||void 0===t||t.removeEventListener("click",this.onDeclineAll),null===(o=this.loadMoreBtn)||void 0===o||o.removeEventListener("click",this.loadMore),document.removeEventListener(n.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.removeEventListener(n.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.removeEventListener(n.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.removeEventListener(n.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.removeEventListener(n.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.isFullPage&&this.nextOffset&&document.removeEventListener("scroll",this.checkScroll)},e.prototype.onSubmitAll=function(e,t){var o=(0,g.curBox)();o&&o.hide(),(0,p.decrementLeftMenuPhotoCounter)(e);var r="";r=!this.submitAllLimit||this.fullCardsNumber<=this.submitAllLimit?"/albums"+window.vk.id:"/albums"+window.vk.id+"?act=recognition_tags",this.go(r,t)},e.prototype.go=function(e,t){void 0===t&&(t="");var o=document.querySelector("#box_layer_wrap"),r=document.querySelector("#box_loader");window.nav.go(e,!1,{onDone:function(){t&&(0,g.showDoneBox)(t)},showProgress:function(){(0,c.show)(o),(0,c.show)(r),(0,g.boxRefreshCoords)(r)},hideProgress:function(){(0,c.hide)(o),(0,c.hide)(r)}})},e.prototype.getActiveCardsNumber=function(){var e=this.cards.filter((function(e){return e.isActive()})).length,t=this.cards.length-e;return this.fullCardsNumber-t},e.prototype.destroy=function(){this.isDestroyed=!0,this.deInitListeners(),this.cards.forEach((function(e){return e.destroy()}))},e.prototype.createCards=function(e){return e.map((function(e){return i.PhotoTagCard.isPhotoSuggestedTagCard(e)?new s.PhotoSuggestedTagCard(e):new a.PhotoUserTagCard(e)}))},e}()},801147:(e,t,o)=>{"use strict";o.d(t,{PHOTO_TAG_CARD_CLASS:()=>h,TagCardViewStatus:()=>r,PhotoTagCard:()=>g});var r,i=o(570655),n=o(920453),a=o(204182),s=o(469433),l=o(414914),d=o(917685),c=o(611386),u=o(830242),h="PhotoTagCard",p="PhotoTagCard--noSize";!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.CONFIRMED=1]="CONFIRMED",e[e.DECLINED=2]="DECLINED",e[e.DELETED=3]="DELETED"}(r||(r={}));var g=function(){function e(e){var t=this;this.status=r.ACTIVE,this.isLoading=!1,this.onPhotoClick=function(e){e.ctrlKey||e.metaKey||(t.showPhoto(e),(0,d.cancelEvent)(e))},this.onConfirmClick=function(){t.confirm().then((function(){var e=t.getTags();t.tagArea.setConfirmedTags(e),t.updatePhotoviewCache(!0),t.setViewStatus(r.CONFIRMED)}),(function(e){e&&(0,c.logError)(e)})).finally((function(){t.isLoading=!1}))},this.onDeclineClick=function(){t.isLoading||(t.isLoading=!0,t.decline().then((function(){t.setOverlay(),t.updatePhotoviewCache(!0),t.setViewStatus(r.DECLINED)}),(function(e){e&&(0,c.logError)(e)})).finally((function(){t.isLoading=!1})))},this.onCancelClick=function(){t.setOverlay(!1),t.tagArea.reset(),t.setViewStatus(r.ACTIVE)},this.el=e;var o=e.dataset.photoViewOptions,s=e.dataset.photoContext,l=e.dataset.photoRawId,u=o&&(0,n.parseJSON)(o),h=e.dataset.tagHash;if(!(u&&l&&s&&h))throw new Error("PhotoTagCard: incorrect arguments");var p=(0,i.__read)(l.split("_"),2),g=p[0],_=p[1];this.ownerId=Number(g),this.photoId=Number(_),this.photoRawId=l,this.photoContext=s,this.photoViewOptions=u,this.photoUrl=e.dataset.photoUrl;var f=e.querySelector(".PhotoTagCard__button--confirm"),m=e.querySelector(".PhotoTagCard__button--decline"),v=e.querySelector(".PhotoTagCard__button--cancelConfirm"),C=e.querySelector(".PhotoTagCard__button--cancelDecline"),w=e.querySelector(".PhotoTagCard__desc"),b=e.querySelector(".PhotoTagCard__photo"),T=e.querySelector(".PhotoTagCard__result");if(!(f&&m&&w&&b&&T))throw new Error("PhotoTagCard: there are not elements");this.photoEl=b,this.confirmBtn=f,this.declineBtn=m,this.description=w,this.cancelConfirmBtn=v,this.cancelDeclineBtn=C,this.resultPanel=T,this.tagArea=new a.PhotoTagArea(this,h),this.init()}return e.prototype.destroy=function(){this.deInitListeners()},e.prototype.getPhotoRawId=function(){return this.photoRawId},e.prototype.getEl=function(){return this.photoEl},e.prototype.setConfirmedTagsByIds=function(e){this.tagArea.setConfirmedTagsByIds(e)&&this.setViewStatus(r.CONFIRMED)},e.prototype.setDeclinedTagsByIds=function(e){this.tagArea.setDeclinedTagsByIds(e)&&(this.setOverlay(),this.setViewStatus(r.DECLINED))},e.prototype.setDeletedTagsByIds=function(e){this.tagArea.setDeclinedTagsByIds(e)&&this.setViewStatus(r.DELETED)},e.isPhotoSuggestedTagCard=function(e){return Boolean(Number(e.dataset.isSuggest))},e.prototype.init=function(){this.initListeners(),this.photoUrl&&this.checkPhotoHasNoSizes()&&this.correctTagView(this.photoUrl)},e.prototype.initListeners=function(){var e,t;this.confirmBtn.addEventListener("click",this.onConfirmClick),this.declineBtn.addEventListener("click",this.onDeclineClick),null===(e=this.cancelConfirmBtn)||void 0===e||e.addEventListener("click",this.onCancelClick),null===(t=this.cancelDeclineBtn)||void 0===t||t.addEventListener("click",this.onCancelClick),this.photoEl.addEventListener("click",this.onPhotoClick)},e.prototype.deInitListeners=function(){var e,t;this.confirmBtn.removeEventListener("click",this.onConfirmClick),this.declineBtn.removeEventListener("click",this.onDeclineClick),null===(e=this.cancelConfirmBtn)||void 0===e||e.removeEventListener("click",this.onCancelClick),null===(t=this.cancelDeclineBtn)||void 0===t||t.removeEventListener("click",this.onCancelClick),this.photoEl.removeEventListener("click",this.onPhotoClick)},e.prototype.setViewStatus=function(e){var t=this.resultPanel.querySelector(".PhotoTagCard__resultWrapper");if(t){if(this.status=e,e===r.ACTIVE)return(0,l.hide)(this.resultPanel),void(0,l.show)(this.description);t.innerHTML=this.getResultText(e),(0,l.hide)(this.description),e===r.CONFIRMED?(this.resultPanel.classList.add("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")):e===r.DECLINED?(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.add("PhotoTagCard__result--decline")):(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")),(0,l.show)(this.resultPanel)}},e.prototype.setOverlay=function(e){void 0===e&&(e=!1),this.photoEl.classList.toggle("PhotoTagCard__photo--disable",e)},e.prototype.showPhoto=function(e){(0,s.showPhoto)(this.photoRawId,this.photoContext,this.photoViewOptions,e),this.updatePhotoviewCache()},e.prototype.getTags=function(){return this.tagArea.getTags()},e.prototype.getConfirmedTags=function(){return this.tagArea.getConfirmedTags()},e.prototype.updatePhotoviewCache=function(e){void 0===e&&(e=!1),this.photoViewOptions.noCache=e,e&&(0,u.dropPhotoCacheData)()},e.prototype.checkPhotoHasNoSizes=function(){return this.el.classList.contains(p)},e.prototype.correctTagView=function(e){var t=this,o=new Image;o.onload=function(){var r=o.width,n=o.height;if(r&&n){var s=(0,i.__read)(a.PhotoTagArea.calculateTagAreaSizes(t.photoEl,r,n),2),l=s[0],d=s[1],c=t.el.querySelector(".PhotoTagCard__stub");c&&c.remove();var u=document.createElement("div");u.classList.add("PhotoTagCard__image"),u.style.backgroundSize=l+"px "+d+"px",u.style.backgroundImage="url('"+e+"')",t.photoEl.appendChild(u);var h=l+1,g=d+1;t.tagArea.setSizes(h,g),t.tagArea.show(),t.el.classList.remove(p)}},o.src=e},e.prototype.getOwnerId=function(){return this.ownerId},e.prototype.isActive=function(){return this.status===r.ACTIVE},e}()},3297:(e,t,o)=>{"use strict";o.d(t,{PhotoUserTagCard:()=>a});var r=o(570655),i=o(801147),n=o(116886),a=function(e){function t(t){return e.call(this,t)||this}return(0,r.__extends)(t,e),t.prototype.confirm=function(){var e=this.getTags();return this.tagArea.confirmTag(e[0],this,this.confirmBtn)},t.prototype.decline=function(){var e=this.getTags();return this.tagArea.declineTag(e[0],this,this.declineBtn)},t.prototype.getResultText=function(e){var t=this.getTags()[0].getPlacerNameGenitive()||"",o="";switch(e){case i.TagCardViewStatus.CONFIRMED:o=(0,n.getLang)("photo_recognition_confirm_myself").replace("{name}",t);break;case i.TagCardViewStatus.DECLINED:o=(0,n.getLang)("photo_recognition_decline_myself").replace("{name}",t);break;default:o=(0,n.getLang)("photo_recognition_deleted_tag")}return o},t}(i.PhotoTagCard)},713208:(e,t,o)=>{"use strict";o.d(t,{decrementLeftMenuPhotoCounter:()=>s});var r=o(442699),i=o(611386),n=o(484426),a="ph";function s(e){void 0===e&&(e=1);try{var t=function(){var e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");var t=e.querySelector(".left_count");return t?(0,r.intval)(t.textContent):0}();(0,n.handlePageCount)(a,Math.max(t-e,0))}catch(e){console.error(e),(0,i.logError)(e)}}},775478:(e,t,o)=>{"use strict";var r;o.d(t,{TagEventTypes:()=>r}),function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(r||(r={}))}}]);try{stManager.done("dist/ed02da901f6e6d717716f8686f741618.f31e12df53bb58b8b0b2.js")}catch(e){}