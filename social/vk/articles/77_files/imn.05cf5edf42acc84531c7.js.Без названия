!function(e){function t(t){for(var n,r,o=t[0],l=t[1],c=t[2],u=0,g=[];u<o.length;u++)r=o[u],Object.prototype.hasOwnProperty.call(i,r)&&i[r]&&g.push(i[r][0]),i[r]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(e[n]=l[n]);for(d&&d(t);g.length;)g.shift()();return s.push.apply(s,c||[]),a()}function a(){for(var e,t=0;t<s.length;t++){for(var a=s[t],n=!0,o=1;o<a.length;o++){var l=a[o];0!==i[l]&&(n=!1)}n&&(s.splice(t--,1),e=r(r.s=a[0]))}return e}var n={},i={"web/imn":0},s=[];function r(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.e=function(){return Promise.resolve()},r.m=e,r.c=n,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/js/cmodules/";var o=window.webpackJsonp=window.webpackJsonp||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var d=l;s.push([208,"common","palette","9b5c1549562b5997058328b940973c18","vendors","7ed9e4d544bccc8a5ada0a712a9cf1ad","1fe1df46cdb12c3eb98af3fc95e7c624","7441004f6b6b66cce39929ceed1ae0cd"]),a()}({"/cSr":function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return s}));var n=a("q1tI"),i=(a("17x9"),a("ZxpX"));function s(e){return n.createElement("div",{className:Object(i.classNames)("ChatSettingsRoundedIcon","ChatSettingsRoundedIcon--"+e.type,"ChatSettingsRoundedIcon--"+e.backgroundColor)})}},"1MUc":function(e,t,a){"use strict";a.r(t),a.d(t,"ChatCreation",(function(){return K}));var n=a("q1tI"),i=a.n(n),s=a("6krn"),r=a("QDnf"),o=a("e87a"),l=a("euvX"),c=function(e){var t=e.children,a=e.title,n=e.onClose,r=e.onBack;return i.a.createElement(o.default,{onClose:n,disableBodyScroll:!0,className:"ChatCreationModal"},i.a.createElement(l.ModalHeader,{title:a,onClose:n,backText:r?Object(s.getLang)("global_back"):void 0,onBack:r,appearance:"blue"}),i.a.createElement("div",{className:"ChatCreationModal__content"},t))},d=a("iukX"),u=function(e){var t=e.setFlags,a=e.flags,n=e.onClose;return i.a.createElement(d.ChatSettingsOptions,{flags:a,back:n,isChatCreation:!0,onSave:function(e){return t(e),Promise.resolve()},afterSave:n,onCancel:n})},g=a("F0+T"),m=function(e){var t=e.usersList,a=e.onRemoveToken,n=e.onChange,r=e.onSelect,o=e.renderSuggest,l=e.tokens,c=e.query;return i.a.createElement(g.default,{className:"ChatCreationUserList",tokens:l,removeTokenPlaceholder:Object(s.getLang)("mail_create_chat_remove_user"),onRemoveToken:a,placeholder:Object(s.getLang)("mail_search_creation"),value:c,onChange:n,onSelect:r,useInfiniteScroll:!0,hasMore:!1,virtualized:!0,loadMore:function(){},notFoundText:Object(s.getLang)("mail_no_users_found"),autoFocus:!0,isSearching:!1,renderSuggest:o,data:t})},_=a("Hri0"),p=a("5R8M"),h=a("Cx1h"),b=a("P13b"),v=a("Aegd"),f=function(e){var t=e.data,a=e.onSelect,n=e.isSelected,s=Object(b.isContactPeer)(t.peerId)?i.a.createElement(v.ConversationNoPhoto,{id:t.peerId,text:Object(b.getUserInitials)(t.name),size:"34",specificType:7}):t.photo;return i.a.createElement(p.default,{"data-id":t.peerId,onClick:function(){return a(t.peerId)},selectable:!0,aside:i.a.createElement(h.ListMultiSelectControl,{isSelected:n})},i.a.createElement(_.default,{"data-id":t.peerId,size:"34",title:t.name,photo:s}))},O=a("XuPN"),C=a("nAFc"),y=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<a;t++)for(var s=arguments[t],r=0,o=s.length;r<o;r++,i++)n[i]=s[r];return n},j=function(e){var t=e.usersList,a=e.selectedMap,s=e.setSelectedMap,r=e.onServerSearch,o=Object(n.useState)(""),l=o[0],c=o[1],d=Object(n.useState)(t.map((function(e){return e.peerId}))),u=d[0],g=d[1],_=Object(n.useRef)(E(t)),p=Object(n.useCallback)((function(e){return e.name}),[]),h=Object(n.useCallback)((function(e){return e.peerId}),[]),b=Object(O.useIndexer)(Array.from(_.current.values()),p,h),v=Object(n.useMemo)((function(){return Array.from(_.current.keys())}),[_.current]),C=Object(n.useCallback)((function(e,t){return r(e,t)}),[r]);Object(n.useEffect)((function(){var e=b.search(l).map((function(e){return e.peerId}));g(e),C(l,e).then((function(t){if(0!==l.length){var a=[],n=[];t.forEach((function(e){_.current.has(e.peerId)||(n.push(e.peerId),a.push(function(e){return{id:e.peerId,peerId:e.peerId,name:e.name,photo:e.photo}}(e)))})),a.length&&(i=_,s=E(a),i.current=new Map(y(Array.from(i.current.entries()),Array.from(s.entries()))),g(y(e,n)))}var i,s})).catch((function(){}))}),[l]);var j=function(e){a.delete(e),s((function(){return new Map(a)}))},T=function(e){a.has(e)?j(e):(!function(e){var t=_.current.get(e);t&&(a.set(e,S(t)),s((function(){return new Map(a)})))}(e),c(""))},w=Object(n.useCallback)((function(e){j(+e)}),[a]),I=Object(n.useCallback)((function(e){c(e.target.value)}),[l]),A=Array.from(a.values());return i.a.createElement(m,{query:l,tokens:A,usersList:l?u:v,onSelect:T,onChange:I,onRemoveToken:w,renderSuggest:function(e){var t=_.current.get(e);return t?i.a.createElement(f,{key:e,data:t,onSelect:T,isSelected:a.has(e)}):i.a.createElement(i.a.Fragment,null)}})};function E(e){return e.reduce((function(e,t){return t.name=Object(C.decodeHTMLEntities)(t.name),e.set(t.id,t)}),new Map)}function S(e){return{id:e.id.toString(),text:e.name}}var T=a("RXF5"),w=a("s0Wt"),I=a("h7Kf"),A=a("WfnU"),M=function(e){var t=e.onChangeTitle,a=e.onResetTitle,n=e.onShowSettings,r=e.onButtonClickHandler,o=e.title,l=e.photo,c=e.loading,d=e.onUploadAvatar,u=e.onRemoveAvatar,g=e.isButtonDisabled,m=e.buttonText;return i.a.createElement("div",{className:"ChatCreationInfo"},i.a.createElement("div",{className:"ChatCreationInfo__avatarWrapper"},i.a.createElement(T.default,{photo:l,title:o,className:"ChatCreationInfo__avatar",onClick:d}),l&&i.a.createElement(w.default,{text:Object(s.getLang)("mail_settings_remove_photo"),position:"t",align:"left"},i.a.createElement("button",{onClick:u,className:"ChatCreationInfo__avatarRemove"}))),i.a.createElement(I.default,{className:"ChatCreationInfo__titleInput",isControlledOutside:!0,value:o,onChange:function(e){return t(e.target.value)},onCancel:a,placeholder:Object(s.getLang)("mail_im_chat_title_intro")}),i.a.createElement(w.default,{text:Object(s.getLang)("mail_chat_creation_settings_icon_tooltip"),position:"t"},i.a.createElement("button",{className:"ChatCreationInfo__settings",onClick:n,"aria-label":Object(s.getLang)("mail_chat_creation_settings_icon_tooltip")})),i.a.createElement(A.default,{disabled:g,loading:c,onClick:r},m))},k=function(e){var t=e.title,a=e.photo,r=e.selectedUserIds,o=e.onShowSettings,l=e.onTitleChange,c=e.onCreateChat,d=e.onUploadAvatar,u=e.onRemoveAvatar,g=e.onGoToConvo,m=Object(n.useState)(!1),_=m[0],p=m[1],h=Object(n.useState)(!L(t)),b=h[0],v=h[1],f=1===r.length&&!b&&!a,O=0!==r.length||b,C=Object(n.useCallback)((function(e){v(!L(e)),l(e)}),[]),y=!f&&!O,j=f?Object(s.getLang)("mail_im_go_to_dialog"):Object(s.getLang)("mail_im_create_chat");return i.a.createElement(M,{title:t,onResetTitle:function(){return C("")},onChangeTitle:C,photo:a,onShowSettings:o,onButtonClickHandler:function(){if(p(!0),f){var e=r[0];g(+e)}else c().catch((function(){p(!1)}))},loading:_,isButtonDisabled:y,onUploadAvatar:d,onRemoveAvatar:u,buttonText:j})};function L(e){return!e.trim().replace("\n","")}var P,N=a("5PZO"),D=a("BiHW"),x=a("bTOO"),B=a("zjLC"),R=a("R5GP"),F=a("DM26"),H=a("shih"),U=a("Iqrf"),G=a("XLJO"),q=a("6x51"),W=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<a;t++)for(var s=arguments[t],r=0,o=s.length;r<o;r++,i++)n[i]=s[r];return n};!function(e){e[e.LOADING=0]="LOADING",e[e.LIST=1]="LIST",e[e.SETTINGS=2]="SETTINGS",e[e.PHOTO=3]="PHOTO",e[e.ERROR=4]="ERROR"}(P||(P={}));var K=function(e){var t=e.store,a=e.uploadAvatar,o=e.onClose,l=e.onBack,d=e.onCreateChat,g=e.onGoToConvo,m=e.preselectedUsers,_=Object(n.useState)([]),p=_[0],h=_[1],b=Object(n.useState)(P.LOADING),v=b[0],f=b[1],O=Object(n.useState)(0),C=O[0],y=O[1],E=Object(n.useState)(""),T=E[0],w=E[1],I=Object(n.useState)(""),A=I[0],M=I[1],L=Object(n.useState)(void 0),K=L[0],V=L[1],Y=Object(n.useState)(m?new Map(m.map((function(e){return[e.id,S(e)]}))):new Map),z=Y[0],Q=Y[1];Object(n.useEffect)((function(){(function(e){return Object(R.unpackStore)(e).hintsTree.then((function(t){var a=t.list.map((function(e){var t=e[0];return{id:+t,peerId:+t,name:e[1],photo:e[2]}}));return function(e,t){return Object(G.checkContactListLoaded)(e).then((function(e){var a=e.get().contactsList.filter((function(e){return!e.user})).sort((function(e,t){return e.id<t.id?1:-1})).map((function(e){return{id:Object(q.getContactPeerId)(e.id),peerId:Object(q.getContactPeerId)(e.id),name:e.name,photo:""}})),n=a.splice(0,a.length<3?a.length:3);return W(t.slice(0,4),n,t.slice(4),a)}))}(e,a)}))})(t).then((function(e){if(m){var t=m.reduce((function(e,t){return e[t.peerId]=!0,e}),{}),a=m.concat(e.filter((function(e){return!t[e.peerId]})));h(a)}else h(e)})).then((function(){return f(P.LIST)})).catch((function(){f(P.ERROR)}))}),[]);var X=Object(F.debouncedPromise)(H.searchHints,300);switch(v){case P.SETTINGS:return i.a.createElement(c,{title:Object(s.getLang)("mail_chat_creation_settings"),onClose:o,onBack:function(){return f(P.LIST)}},i.a.createElement(u,{flags:C,setFlags:y,onClose:function(){return f(P.LIST)}}));case P.LIST:return i.a.createElement(c,{title:Object(s.getLang)("mail_im_create_chat"),onBack:l,onClose:o},i.a.createElement(j,{usersList:p,selectedMap:z,setSelectedMap:Q,onServerSearch:function(e,a){return X(e,a,U.HintsSearchType.FRIENDS_AND_CONTACTS,{},t.get())}}),i.a.createElement(k,{title:T,photo:A,selectedUserIds:Array.from(z.keys()),onTitleChange:w,onShowSettings:function(){return f(P.SETTINGS)},onCreateChat:function(){var e=Array.from(z.keys()),a=K||void 0;return t.set((function(t){return Object(B.createChatAction)(t,a,e,T,C)})).then((function(e){d(e.get().next_peer)})).catch((function(){}))},onUploadAvatar:function(){f(P.PHOTO),a().then((function(e){if(e.photo&&e.photoData){var t=e.photo,a=e.photoData;M(t),V(a)}else V(void 0);f(P.LIST)})).catch((function(){f(P.ERROR)}))},onRemoveAvatar:function(){M(""),V(void 0)},onGoToConvo:g}));case P.ERROR:return i.a.createElement(c,{title:Object(s.getLang)("global_error"),onClose:o},i.a.createElement(x.ModalBody,null,i.a.createElement("p",null,Object(s.getLang)("global_error"))),i.a.createElement(N.ModalFooter,{actionButtons:i.a.createElement(D.default,{onClick:o},Object(s.getLang)("global_close"))}));case P.LOADING:return i.a.createElement(r.default,null);case P.PHOTO:return i.a.createElement(i.a.Fragment,null)}}},"1nu5":function(e,t,a){"use strict";a.r(t),a.d(t,"VkIndexer",(function(){return n}));var n=function(){function e(e,t,a){this.delimiter=new RegExp("[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\#\\+\\?\\\\]+","g"),this.trimmer=new RegExp("^[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\+\\?\\\\]+|[\\s\\-,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\\\]+$","g"),this.toTranslit={1072:"a",1073:"b",1074:"v",1075:"g",1076:"d",1077:"e",1078:"zh",1079:"z",1080:"i",1081:"y",1082:"k",1083:"l",1084:"m",1085:"n",1086:"o",1087:"p",1088:"r",1089:"s",1090:"t",1091:"u",1092:"f",1093:"h",1094:"ts",1095:"ch",1096:"sh",1097:"sh",1099:"y",1101:"e",1102:"yu",1103:"ya",1105:"e",1098:"",1100:""},this.toLocalCase={f:"a",",":"b","<":"b",d:"v",u:"g",l:"d",t:"e",";":"zh",":":"zh",p:"z",b:"i",q:"y",r:"k",k:"l",v:"m",y:"n",j:"o",g:"p",h:"r",c:"s",n:"t",e:"u",a:"f","[":"h","{":"kh",w:"ts",x:"ch",i:"sh",o:"sh",s:"y","'":"e",'"':"e",".":"yu",">":"yu",z:"ya","`":"e","~":"e",m:"","]":"","}":""},this.toLocalTranslit={1072:"f",1074:"d",1075:"u",1076:"l",1077:"t",1079:"p",1080:"b",1081:"q",1082:"r",1083:"k",1084:"v",1085:"y",1086:"j",1087:"g",1088:"h",1089:"c",1090:"n",1091:"e",1092:"a",1094:"w",1095:"x",1096:"i",1097:"o",1099:"s",1103:"z",1098:"m"},this.list=e||[],this.iterCur=0,this.iterEnd=e?e.length:0,this.index={},this.callback=a||function(){},this.prepareFunc=t||function(e){return e},setTimeout(this.indexIteration.bind(this),10)}return e.prototype.indexIteration=function(){for(var e=Math.min(this.iterEnd,this.iterCur+200),t=this.iterCur;t<e;t++){var a=this.list[t];try{a._order=t}catch(e){}this.add(a)}this.iterCur=t,t>=this.iterEnd?this.callback(this):setTimeout(this.indexIteration.bind(this),10)},e.prototype.strToPrefixes=function(e){for(var t,a={},n=(t=e,t.replace(/&#(\d\d+);/g,(function(e,t){return(t=!0===(a=t)?1:parseInt(a)||0)>=32?String.fromCharCode(t):e;var a})).replace(/&quot;/gi,'"').replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&amp;/gi,"&")).toLowerCase().split(this.delimiter),i=n.length;i--;){var s=n[i],r="";if(s){for(var o=0;o<6;o++){var l=s.charCodeAt(o);if(l){var c=this.toTranslit[l],d=s.substr(o,1);r+=null!=c?c:d}}a[r]=1}}return a},e.prototype.strToSearchPrefixes=function(e){for(var t=[],a=e.toLowerCase().split(this.delimiter),n=a.length;n--;){var i={},s=a[n],r="",o="",l="",c=s.length>1;if(s){for(var d=0;d<6;d++){var u=s.charCodeAt(d);if(u){var g=this.toTranslit[u],m=s.substr(d,1);if(r+=null!=g?g:m,c){var _=this.toLocalCase[m],p=this.toLocalTranslit[u];o+=null!=_?_:m,l+=null!=p?p:m}}}i[r]=1,c&&(i[o]=2,i[l]=3),t.push(i)}}return t},e.prototype.toIndexTree=function(e,t){for(var a=this.index,n=0;n<6;n++){var i=e.substr(n,1)||-1;a=a[i]?a[i]:a[i]=5==n?[]:{}}a.push(t)},e.prototype.remove=function(e){var t=this.prepareFunc(e),a=this.strToPrefixes(t);for(var n in a)if(a.hasOwnProperty(n)){for(var i=this.index,s=0;s<6;s++){var r=n.substr(s,1)||-1;if(!i[r])break;i=i[r]}if(i.length)for(var s in i)if(this.equals(i[s],e)){i.splice(s,1);break}}},e.prototype.equals=function(e,t){for(var a in e)if(e.hasOwnProperty(a))switch(typeof e[a]){case"object":if(!this.equals(e[a],t[a]))return!1;break;case"function":if(void 0===e[a]||e[a].toString()!=t[a].toString())return!1;break;default:if(e[a]!=t[a])return!1}for(var a in t)if(void 0===t[a])return!1;return!0},e.prototype.intersect=function(e,t){var a=[];if(i(e[0])||i(t[0]))return e.filter((function(e){return-1!==t.indexOf(e)}));for(;e.length>0&&t.length>0;)if(e[0]._order<t[0]._order)e.shift();else if(e[0]._order>t[0]._order)t.shift();else{if(this.equals(e[0],t[0])){var n=e.shift();n&&a.push(n)}t.shift()}return a},e.prototype.add=function(e){var t=this.prepareFunc(e),a=this.strToPrefixes(t);for(var n in a)a.hasOwnProperty(n)&&this.toIndexTree(n,e)},e.prototype.search=function(e){var t=this.index,a=this.strToSearchPrefixes(e),n=[],i=!1;for(var s in a)if(a.hasOwnProperty(s)){if(i&&!n)break;var r=this.localSearch(a[s],0,t);r.sort((function(e,t){return e._order-t._order})),n=i?this.intersect(n,r):r,i=!0}for(var o=n[0],l=n.length+1,c=[],d=1;d<l;d++){var u=n[d];u!=o&&(c.push(o),o=u)}return c},e.prototype.localSearch=function(e,t,a){if(!a)return[];var n={};for(var i in e)e.hasOwnProperty(i)&&(n[r=i.substr(t,1)||-1]||(n[r]={}),n[r][i]=1);if(6==t++)return a;var s=[];for(var r in n)if("-1"===r)for(var o in a)a.hasOwnProperty(o)&&s.push.apply(s,this.localSearch(n[r],t,a[o]));else{var l=this.localSearch(n[r],t,a[r]);s.push.apply(s,l)}return s},e}();function i(e){return!isNaN(e)}},208:function(e,t,a){e.exports=a("V1UX")},"8h6g":function(e,t,a){"use strict";a.r(t),a.d(t,"VIDEO_UPLOAD_EXTS",(function(){return n})),a.d(t,"VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB",(function(){return i})),a.d(t,"VIDEO_UPLOAD_CHUNK_SIZE",(function(){return s}));a("KKXr");var n="avi mp4 3gp mpeg mov flv f4v wmv mkv webm vob rm rmvb m4v mpg ogv ts m2ts mts mxf".split(" "),i=5,s=4194304},"9KdC":function(e,t,a){"use strict";a.r(t),a.d(t,"EntityType",(function(){return n}));var n,i=function(){return(i=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};!function(e){e.Online="online"}(n||(n={}));var s=function(e){var t=this,a=e.getQueue,n=e.registerQueue;this.QUEUE_KEY_TTL=3e3,this.MAX_RETRIES=5,this.listeners=[],this.retriesLeft=this.MAX_RETRIES,this.restart=function(){t.intervalId&&clearInterval(t.intervalId),0!==t.retriesLeft&&(t.retriesLeft--,t.getQueue().then((function(e){t.retriesLeft=t.MAX_RETRIES;var a=i({},e);t.intervalId=window.setInterval((function(){t.registerQueue(a,(function(e,n){if(function(e){return void 0!==e.err}(n))t.restart();else{a.ts=n.ts;for(var i=0,s=n.events;i<s.length;i++)for(var r=s[i],o=0,l=t.listeners;o<l.length;o++)(0,l[o])(r)}}))}),t.QUEUE_KEY_TTL)})).catch((function(e){console.error(e),setTimeout(t.restart,t.QUEUE_KEY_TTL)})))},this.subscribe=function(e){return t.listeners.push(e),1===t.listeners.length&&t.restart(),function(){t.listeners=t.listeners.filter((function(t){return t!==e})),0===t.listeners.length&&(t.retriesLeft=t.MAX_RETRIES,t.intervalId&&clearInterval(t.intervalId))}},this.registerQueue=n,this.getQueue=a};t.default=s},J4gp:function(e,t,a){"use strict";a.r(t),a.d(t,"convoPickerMode",(function(){return E})),a.d(t,"ConvoPicker",(function(){return M}));var n=a("q1tI"),i=a.n(n),s=a("i8i4"),r=a.n(s),o=a("ZxpX"),l=a("CGHU"),c=a("8tCR"),d=a("3blr"),u=a("URsI"),g=a("h++7"),m=a("6krn"),_=a("5R8M"),p=a("Hri0"),h=a("P13b"),b=a("mvjr"),v=a("Aegd"),f=a("RXF5"),O=a("gdug"),C=function(){return(C=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},y=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(a[n[i]]=e[n[i]])}return a},j=function(e){var t=e.peerId,a=e.name,n=e.photo,s=e.online,r=e.memberCount,l=e.mode,c=void 0===l?E.DEFAULT:l,d=e.isSelected,u=e.isDisabled,g=e.isActive,m=e.isCasper,j=e.className,S=y(e,["peerId","name","photo","online","memberCount","mode","isSelected","isDisabled","isActive","isCasper","className"]),T=function(e,t,a,n){void 0===n&&(n=0);var s=Object(h.isContactPeer)(e);switch(!0){case Array.isArray(a):return i.a.createElement(b.default,{photos:a});case s:return i.a.createElement(v.ConversationNoPhoto,{id:e,text:Object(h.getUserInitials)(t),size:"34",specificType:7});default:return i.a.createElement(f.default,{isOnline:!!n,isMobile:!!O.mobPlatforms[n],title:t,photo:a,onlineSize:"s"})}}(t,a,n,s),w=m?'<span class="ConvoPickerRow__itemTitle ConvoPickerRow__itemTitle--casper">\n        <span class="ConvoPickerRow__itemTitleText">\n          '+a+"\n        </span>\n      </span>":a,I=c===E.RADIO?i.a.createElement("span",{className:Object(o.classNames)("ConvoPickerRow__radio",{"ConvoPickerRow__radio--selected":d})}):void 0,A=Object(o.classNames)("ConvoPickerRow",j,{"ConvoPickerRow--disabled":u});return i.a.createElement(_.default,C({active:g,selectable:!u,canBeHovered:!1,chevron:c===E.DEFAULT&&!u,aside:I,className:A},S),i.a.createElement(p.default,{size:"34",title:w,photo:T,description:r,className:"ConvoPickerRow__itemContent"}))};var E,S=a("rHUl"),T=a("d8ub"),w=function(){return(w=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},I=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(a[n[i]]=e[n[i]])}return a},A=m.default.getLang;!function(e){e.DEFAULT="default",e.RADIO="radio"}(E||(E={}));var M=function(e){var t,a=e.searchValue,s=void 0===a?"":a,m=e.isLoading,p=void 0!==m&&m,b=e.convos,v=e.mode,f=void 0===v?E.DEFAULT:v,O=e.selectedConvos,C=void 0===O?[]:O,y=e.checkDisabled,M=e.onSearchValueChange,k=e.onSearchInputKeydown,L=e.onConvoSelect,P=e.onListLoadMore,N=void 0===P?function(){}:P,D=e.onAddClick,x=e.searchInputGetter,B=e.className,R=e.style,F=I(e,["searchValue","isLoading","convos","mode","selectedConvos","checkDisabled","onSearchValueChange","onSearchInputKeydown","onConvoSelect","onListLoadMore","onAddClick","searchInputGetter","className","style"]),H=Object(o.classNames)("ConvoPicker",B),U=Object(n.createRef)(),G=Object(n.useState)(0),q=G[0],W=G[1],K=function(e){var t=Math.max(e-1,0);return y&&y(b[t])?K(t):t},V=function(e){var t=Math.min(e+1,b.length-1);return y&&y(b[t])?V(t):t},Y=function(e){e!==q&&(W(e),function(e){if(t){var a=b[e].peerId,n=t.querySelector('[data-id="'+a+'"]');if(n&&n instanceof HTMLElement){var i=n.offsetTop,s=t.scrollTop;if(i<s)t.scrollTop=i;else{var r=t.offsetHeight,o=i+n.offsetHeight;o>s+r&&(t.scrollTop=o-r)}}}}(e))};Object(n.useEffect)((function(){x&&U.current&&x(U.current.element)}),[]);var z=!!D&&!s,Q=(z?[i.a.createElement(_.default,{selectable:!1,key:"add","data-id":0},i.a.createElement(T.ListAddControl,{onClick:D},A("mail_new_convo_from_invite")))]:[]).concat(b.map((function(e,t){var a=e.peerId,n=e.photo,s=e.name,r=e.online,o=!!y&&y(e);return i.a.createElement(j,{key:a,"data-id":a,peerId:a,photo:n,name:s,online:r,memberCount:Object(h.getChatMemberCount)(e),mode:f,isCasper:Object(S.isCasperChatTab)(e),isSelected:C.includes(a),isActive:t===q,isDisabled:o,onClick:function(){o||L(a)},onMouseEnter:function(){return W(o?-1:t)}})})));return i.a.createElement("div",w({className:H,onMouseLeave:function(){return W(-1)},style:R},F),i.a.createElement(l.BlockSearchInput,{value:s,onChange:M,onKeyDown:function(e){switch(e.which||e.keyCode){case g.ARROW_UP:Y(K(q)),e.preventDefault();break;case g.ARROW_DOWN:Y(V(q)),e.preventDefault();break;case g.ENTER:L(b[q].peerId),e.preventDefault()}k(e)},placeholder:A("mail_top_search"),autoFocus:!0,key:"search",ref:U}),p&&i.a.createElement(c.default,{className:"ConvoPicker__stub",key:"loading"},i.a.createElement(d.default,null)),!p&&s&&0===b.length&&i.a.createElement(c.default,{className:"ConvoPicker__stub",key:"no-results"},A("mail_im_search_empty_chats")),!p&&(b.length>0||z)&&i.a.createElement(u.default,{virtualized:!0,className:"ConvoPicker__results",loadMore:N,hasMore:!1,ref:function(e){var a=r.a.findDOMNode(e);a&&a instanceof HTMLElement&&(t=a)},key:"results"},Q))}},LYnS:function(e,t,a){"use strict";a.r(t);a("pIFo");var n=a("86+7"),i=a("rHUl"),s=a("6krn").default.getLang;t.default=()=>[{id:"user name",label:s("mail_community_templates_hint_name"),process:e=>Object(n.oCacheGet)(e,Object(i.getPeer)(e)).first_name},{id:"user surname",label:s("mail_community_templates_hint_last_name"),process(e){var t=Object(n.oCacheGet)(e,Object(i.getPeer)(e));return t.name.replace(t.first_name,"").trim()}},{id:"admin name",label:s("mail_community_templates_hint_your_name"),process:e=>Object(n.oCacheGet)(e,vk.id).first_name},{id:"admin surname",label:s("mail_community_templates_hint_your_last_name"),process(e){var t=Object(n.oCacheGet)(e,vk.id);return t.name.replace(t.first_name,"").trim()}},{id:"community",label:s("mail_community_templates_hint_community"),process:e=>Object(n.oCacheGet)(e,e.get().id).name},{id:"greeting",label:s("mail_community_templates_hint_greeting"),process(e){var t=(new Date).getHours();return s(t>=3&&t<12?"mail_greeting_good_morning":t>=12&&t<17?"mail_greeting_good_afternoon":t>=17&&t<=23?"mail_greeting_good_evening":"mail_greeting_good_night")}}]},RQ7Z:function(e,t,a){"use strict";a.r(t),a.d(t,"screenfull",(function(){return n}));var n=function(){var e=function(){for(var e,t,a=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],n=0,i=a.length,s={};n<i;n++)if((e=a[n])&&e[1]in document){for(n=0,t=e.length;n<t;n++)s[a[0][n]]=e[n];return s}return!1}(),t={request:function(t){var a=e.requestFullscreen;(t=t||document.documentElement)[a]()},exit:function(){document[e.exitFullscreen]()},toggle:function(e){this.isFullscreen?this.exit():this.request(e)},raw:e};return!!e&&(Object.defineProperties(t,{isFullscreen:{get:function(){return Boolean(document[e.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[e.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[e.fullscreenEnabled])}}}),t)}()},V1Nw:function(e,t,a){"use strict";function n(e,t,a){var n=0,i=e,s=[],r=!1;function o(){!s.length||n>0||r||(t(s),s=[])}return{pause:function(){n++},resume:function(){n>0&&(n--,o())},onLp:function(e,t,n){r||(i>=e?(i=t,s.push.apply(s,n),o()):a&&(r=!0,a(i).then((function(e){var t=e[1],a=e[2];i=t,r=!1,s.push.apply(s,a),o()}))))}}}a.r(t),a.d(t,"createLongpollEventsQueue",(function(){return n}))},V1UX:function(e,t,a){"use strict";a.r(t);a("rE2o"),a("ioFf"),a("HEwt"),a("a1Th"),a("91GP"),a("VRzm"),a("Vd3H"),a("pIFo"),a("SRfc"),a("OEbY"),a("rGqo"),a("Btvt"),a("9AAn"),a("OG14");var n=a("vT4u"),i=a("P13b"),s=a("rHUl"),r=a("MhhX"),o=a("UIlX"),l=a("aong"),c=a("ofcU"),d=a("rDjD");function u(e,t,a){var s=intval(domData(a,"msgid"));if(!Object(l.getSelectionText)()&&!Object(i.checkSelectClick)(t)){var r=intval(domData(a,"peer"));return e.set(n.cancelSearch.bind(null,r)),e.get().longpoll.push([Object(d.changePeer)(r,s)]),!1}}function g(e,t){return{isAll:e=>Object(n.isSearchAllLoaded)(e.get().peer,e.get()),loadMore:e=>function(e){return Object(n.isSearchAllLoaded)(e.get().peer,e.get())?Promise.resolve(""):Object(n.searchMessagesInplace)(e.get().peer,e.get())}(e),unmount(){Object(c.destroyModule)(t)}}}function m(e){return e.findIndex(e=>"number"==typeof e.peerId&&e.href)>-1}function _(e,t){var a=u.bind(null,t);return g(0,Object(c.createModule)({handlers:(t,n)=>{n(e,"click","_im_mess",a)}}))}var p=a("h++7"),h=a("R5GP"),b=a("+/AQ");function v(e,t){return Object(l.toArray)(e).find(e=>domData(e,"list-id")===t)}function f(e,t){return Object(l.toArray)(e).findIndex(e=>domData(e,"list-id")===t)}function O(e,t,a,n){if(a){C(e,t,n);var i=domData(a,"list-id"),s=i&&v(t.children,i);s&&n.forEach(e=>addClass(s,e)),e.setState({hoveredListItemId:i})}}function C(e,t,a){var n=domQuery("."+a.join("."),t);n&&Object(l.toArray)(n).forEach(e=>{a.forEach(t=>removeClass(e,t))}),e.setState({hoveredListItemId:null})}function y(e,t){var a=t&&domQuery("."+t.join("."),e)[0];return a?domData(a,"list-id"):null}function j(e,t,a){return e.map(t).reduce((e,t)=>(e[t]=!0,e),a)}function E(e,t,a){return{ids:j(a.get().elements,e,{}),scrolls:t,activated:!0}}function S(e,t,a){return a.elements=a.elements.filter(a=>t(a)!==e),delete a.ids[e],Promise.resolve(a)}function T(e,t,a){var n=[];a.elements=a.elements.map(a=>{var i=t(a),s=e.filter(e=>t(e)===i)[0];return n.push(i),s||a});var i=e.filter(e=>!inArray(t(e),n));return a.elements=a.elements.concat(i),Promise.resolve(a)}function w(e){var t={};return e.forEach(e=>{"r"===e[0]&&t["a,"+e[1]]?delete t["a,"+e[1]]:t[`${e[0]},${e[1]}`]=e}),Object.keys(t).map(e=>t[e])}function I(e,t,a,n,i,s,r){for(var o=0;o<n;o++)e=domNS(e);var l=se(i(t));return domData(l,"list-id",a),e?s.insertBefore(l,e):s.appendChild(l),r&&r(l),e}function A(e,t,a,n,i){var s=n.get(),r=s.limit,o=s.offset,c=function(e,t){var a=t.get();return!a._sortedEls&&e&&t.setState({elements:a.elements.sort(e),_sortedEls:!0}),t.get().elements}(a().sortFn,n).slice(0,o+r),d=function(e,t){for(var a=[],n=Math.max(e.length,t.length),i=0;i<n;i++){var s=e[i],r=t[i];!s&&r?a.push(["a",r,i]):s&&!r?a.push(["r",s,i]):s!==r&&(a.push(["r",s,i]),a.push(["a",r,i]))}var o=w(a),l=w(a.reverse());return o.length>l.length?l:o}(Object(l.toArray)(e.children).map(e=>domData(e,"list-id")).filter(e=>!!e),c.map(e=>a().idFn(e).toString()));if(function(e,t,a,n,i){if(0!==t.length){var s=(t=t.sort((e,t)=>e[2]-t[2])).filter(e=>"a"===e[0]);if(t.filter(e=>"r"===e[0]).map(t=>e.children[t[2]]).forEach(e=>re(e)),0!==s.length)for(var r=s.shift(),o=r[2],l=(I(e.children[o],a[r[2]],r[1],0,n,e,i),0);l<s.length;l++)r=s[l],I(e.children[o],a[r[2]],r[1],r[2]-o,n,e,i),o=r[2]}}(e,d,c,a().renderFn,a().onRenderFn),function(e,t){e.get().loading?t.update(!1,!0):(e.get().loading=!0,t.update(!1,!0),e.get().loading=!1)}(n,t),i)return d.filter(e=>"a"==e[0]).map(e=>parseInt(e[1]))}function M(e,t,a,n){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=e.get(),l=t.getContainer().children,c=f(l,n||o.hoveredListItemId);c<0||(o.limit+o.offset<c?e.setState({offset:c-o.limit+1}).then(A.bind(null,t.getContainer(),t,a)):Promise.resolve()).then(()=>{var e=l[c],a=t.scrollTop(),n=t.getScrollHeight(),o=e.offsetHeight;s="center"===s?-.5*t.getScrollHeight():s,r="center"===r?n/2:r;var d=i?function(e){t.smoothScroll(e-t.scrollTop())}:t.scrollTop.bind(t),u=a+s>e.offsetTop,g=o+e.offsetTop>a+n-r;u?d(e.offsetTop-s):g&&d(e.offsetTop-n+o+r)})}function k(e,t){if(e.get().loading||e.get().stop||!e.get().activated)return Promise.resolve([]);e.get().loading=!0;for(var a=arguments.length,n=new Array(a>2?a-2:0),i=2;i<a;i++)n[i-2]=arguments[i];return t(...n).then(()=>{e.get().loading=!1})}function L(e,t,a){return a.scrolls||(a.scrolls={}),a.scrolls[e]&&!t||(a.scrolls[e]={scrolled:a.scrolled||0,scrollItem:a.scrollItem}),Promise.resolve(a)}function P(e,t,a,n){var s=e.get(),r=s.elements,o=n.getContainer(),l=e.setState({offset:s.offset+s.limit}).then(()=>{var a,i=s.offset,l=s.limit;return l+i>r.length?a=t().more(i,l).then(t=>!1===t?[]:(0===t.length&&e.setState({stop:!0}),t)).then(D.bind(null,e,o,n,t,s.pipeId)):(a=Promise.resolve(),A(o,n,t,e)),a});if(!a){var c=r.length>0?"im-preloader_fixed-bottom":"im-preloader_fixed-center";Object(i.wrapLoading)(o)(l,"bottom",c)}return l}function N(e,t){var a=e.get().pipeId;return!(void 0!==a&&void 0!==t&&a!==t)}function D(e,t,a,n,i,s){return!!N(e,i)&&e.setState(function(e,t,a){var n=e.filter(e=>!a.ids[t(e)]);return{_sortedEls:!1,els:n,ids:j(n,t,a.ids),elements:a.elements.concat(n)}}(s,n().idFn,e.get())).then(A.bind(null,t,a,n))}function x(e,t,a){var n=k.bind(null,t,P.bind(null,t,a)),i=(e,n)=>{(t.get().activated||e)&&(void 0!==n&&t.get().elements.length>0&&t.setState({scrolled:n}),a().onScroll&&a().onScroll())},s=Object(b.createScroll)(e,{noScroll:t.get().noScroll,nativeScroll:t.get().nativeScroll,scrollChange:i.bind(null,!1),more:!!a().more&&n.bind(null,!1)}),r=Object(c.createModule)({handlers:(n,i)=>{i(e,"click",t.get().elCls,a().onClick)}});return t.setState(E(a().idFn,{},t)),{pipe:(e,n)=>(t.setState({pipeId:n}),e.then(D.bind(null,t,s.getContainer(),s,a,n))),replacePreserveOrder:e=>t.set(T.bind(null,e,a().idFn)).then(A.bind(null,s.getContainer(),s,a)),pipeReplace(e,n){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t.setState({pipeId:n,stop:!1}),e.then(e=>{if(N(t,n))return t.setState({elements:e,_sortedEls:!1,ids:j(e,a().idFn,{})}).then(A.bind(null,s.getContainer(),s,a,t,i))})},wipe(){s.getContainer().innerHTML=""},deactivate(){t.setState({activated:!1})},activate(){t.setState({activated:!0})},saveScroll:(e,a)=>t.set(L.bind(null,e,a)),updateScroll(){s.update(!1,!0)},toTop(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?s.smoothScroll(-s.scrollTop()):s.scrollTop(0),e&&i(e,0)},scrollTop:e=>s.scrollTop(e),restoreScroll(e){var a=t.get().scrolls,n=a[e];return n&&(t.setState({scrolls:extend({},a,{[e]:null})}),s.scrollTop(n.scrolled)),!!n},unsetScroll(e){t.setState({scrolls:extend({},t.get().scrolls,{[e]:null})})},scrollPage(e,t){var a=s.scroll.scroller,n=s.scrollTop(),i=n+("up"===e?-1:1)*a.clientHeight;t?s.smoothScroll(i-n):s.scrollTop(i)},scrollToElement(e,n,i,r){M(t,s,a,e,n,i,r)},getScroller:()=>s.getScroller(),checkMore:e=>t.get().elements.length<t.get().limit?n(e,s):Promise.resolve([]),add:(e,n)=>D(t,s.getContainer(),s,a,n,e),hoverNextElement(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=s.getContainer(),o=r.children,c=f(o,t.get().hoveredListItemId||y(r,n)),d=Object(l.toArray)(o).slice(c+1).find(a().hoverableFn);O(t,r,d,e),M(t,s,a,null,!1,i.top,i.bottom)},hoverPrevElement(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=s.getContainer(),o=r.children,c=f(o,t.get().hoveredListItemId||y(r,n)),d=c>=0&&Object(l.toArray)(o).slice(0,c).reverse().find(a().hoverableFn);O(t,r,d,e),M(t,s,a,null,!1,i.top,i.bottom)},hoverFirstElement(e,n){var i=s.getContainer(),r=i.children,o=Object(l.toArray)(r).findIndex(a().hoverableFn),c=r[o];!t.get().hoveredListItemId&&c&&(O(t,i,c,e),M(t,s,a,o,!1,n.top,n.bottom))},hoverElement(e,n,i){var r=s.getContainer(),o=r.children,l=f(o,e),c=o[l];c&&(O(t,r,c,n),M(t,s,a,l,!1,i.top,i.bottom))},unhoverElements(e){C(t,s.getContainer(),e)},reset(){var e=t.get().scrolls;t.reset(),t.setState(E(a().idFn,e,t))},getHoveredElement:()=>v(s.getContainer().children,t.get().hoveredListItemId),getCurrentElements:()=>t.get().elements,isLoading:()=>t.get().loading,isEmpty:()=>0===t.get().elements.length,remove(e){t.set(S.bind(null,e,a().idFn)).then(A.bind(null,s.getContainer(),s,a))},unmount(){Object(c.destroyModule)(r),s.destroy()}}}var B=a("eaP7"),R=a("1y80"),F=a("86+7"),H=a("lJdi"),U=a("FWc3"),G=a("3qfP"),q=a("rudk"),W=a("W9Tc");function K(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return V(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return V(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function V(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Y=["_im_dialog_selected","nim-dialog_selected"],z=["_im_dialog_hovered","nim-dialog_hovered"];function Q(e,t,a){removeClass(t.parentNode,"im-page--dialogs_with-mess");var n=a.getCurrentElements().filter(e=>e.message);a.toTop(),a.reset(),Object(R.statlogsProbValueEvent)(.01,"im_search_stat",1,"search_messages_only"),n.length>0?(n=[{type:"sep_messages"}].concat(n),e.setState({searchOnlyMessages:!0})):n=[je()],a.pipeReplace(Promise.resolve(n))}function X(e){return hasClass(e,"_im_search")}function $(e,t,a,r){if(Object(s.isSearching)(e)&&e.get().searchAllLoaded||Object(s.isRecentSearchesActive)(e))return Promise.resolve([]);if(e.get().dialog_search_going||Object(i.isClassicInterface)(e)&&0!==e.get().peer)return Promise.resolve(!1);if(Object(s.isSearching)(e))return Object(n.searchMessages)(Object(s.getSearchText)(e),e.get()).then(e=>{var t=K(e,2),a=t[0];return ye(t[1],a)});var o=e.get().active_tab,l=e.get().dialog_tabs_all;return(o!==p.FOLDER_MESSAGE_REQUEST&&l[p.FOLDER_ALL]&&!Object(i.isReversedDialogs)(e)||l[o])&&o!==p.FOLDER_PEER_TAGS?0===Fe(e).length?Object(s.isMessageRequestFolder)(e)?Promise.resolve([{type:"message_request_notice"},{type:"empty_message_requests"}]):Promise.resolve([{type:"empty_dialogs"}]):Promise.resolve([]):e.set(n.loadDialogs).then(t=>{var a=Fe(e);return 0===a.length?Object(s.isMessageRequestFolder)(e)?Promise.resolve([{type:"message_request_notice"},{type:"empty_message_requests"}]):[{type:"empty_dialogs"}]:a})}function J(e,t,a,r,o,l){var c=gpeByClass("_im_peer_target",o.target)&&checkEvent(o),u=Object(i.isCommunityInterface)(a)&&gpeByClass("_im_dialog_peer_tags",o.target);if(!c&&!u){var g=a.get(),m=X(l),_=parseInt(domData(l,"peer"),10),h=parseInt(domData(l,"msgid"),10),b=Object(s.getTab)(a,_);if(function(e,t){return e.get().active_tab===p.FOLDER_MESSAGE_REQUEST&&Object(s.tabIsMessageRequestToChat)(t)}(a,b))return t().showInvitationBox(a,_),cancelEvent(o);var v="";if(Object(s.isSearching)(a)&&(v="conversations_search"),Object(s.isRecentSearchesActive)(a)&&(v="recent_searches"),hasClass(l,"_im_sugg_"+_)&&(v="popular_suggestions"),m&&(v="message_search"),checkEvent(o))return window.open(function(e,t,a){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=Object(i.getBaseLink)(e),r=()=>`${s}?sel=${Object(i.convertPeerToUrl)(t.peerId)}${n&&a?"&msgid="+a:""}`;if(n)return r();if(Object(i.isUserPeer)(t.peerId)||Object(i.isCommunityPeer)(t.peerId))return Object(i.isClassicInterface)(e)?r():t.href;return r()}(a,b,h,m));if(r.saveScroll("list"),m&&g.msgid!==h)g.longpoll.push([Object(d.changePeer)(_,h,!1,!1,v)]);else if(_!==g.peer){g.longpoll.push([Object(d.changePeer)(_,!1,!0,!0,v)]);var f=Object(s.isSearching)(a);f&&!hasClass(l,"_dont_add_recent")&&Object(n.saveRecentSearchPeer)(_,cur.imDb),f&&b&&!Object(i.isClassicInterface)(a)&&setTimeout(()=>{var e=b.message?b.message.messageId:b.peerId;r.scrollToElement(e.toString(),!0,0,"center")},100)}else _===g.peer&&e().goToHistoryEnd();cancelEvent(o)}}function Z(e,t,a,n){var r,o="string"==typeof a.photo&&""!==a.photo,l=Object(i.isContactPeer)(t),c=a.tab||a.name,d=l?Object(i.prepareContactName)(c):c;if(Object(i.isChatPeer)(t)&&!o)r=Object(i.renderPhotosFromTab)(e,a,!n);else{if(l){var u=Object(i.getUserInitials)(c);r=`<div class="nim-peer--contact-avatar nim-peer--contact-avatar_${Object(s.isSearching)(e)&&!a.message?34:n?50:46}">${u}</div>`}else r=`<img src="${a.photo}" alt="">`;n&&(r=getTemplate("im_dialogs_link_img",{href:a.href||a.link,photo:r}))}return{photo:r,userLink:`<span class="_im_dialog_link">${d}</span>`}}function ee(e){return!Object(i.isPendingForward)(e)}function te(e,t,a,n){return a?"":n?getTemplate("im_img_prebody",{photo:t}):e+":"}function ae(e,t,a,n,r,o,l,c,d,u){var g="",m=Object(s.isChannelPeer)(Object(s.getTab)(e,a));return t&B.FLAG_OUTBOUND?g=te(getLang("mail_by_you"),u,m,d):Object(i.isChatPeer)(a)&&0!==n&&(g=te(Object(F.oCacheGet)(e,n).first_name,Object(F.oCacheGet)(e,n).photo,m,d)),l=Object(i.renderShortText)(a,c,l,r,o),g?getTemplate("im_drow_prebody",{prebody:g,body:l}):l}function ne(e,t,a,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},o=[];return Object(i.isClassicInterface)(n)&&o.push("nim-dialog_classic"),Object(s.isRecentSearchesActive)(n)&&o.push("nim-dialog_recent"),o.push("nim-dialog_empty"),r.search&&o.push("_im_search"),getTemplate("im_drow",{peer:e.peerId,msg_id:"",photo:t,user_link:a,date:"",body:"",unread:"",more:o.join(" "),is_star:"",unread_message_string:"",is_online:onlinePlatformClass(e.online),is_unread:"",is_unread_out:"",is_selected:e.peerId==n.get().peer?"nim-dialog_selected _im_dialog_selected":""})}function ie(e,t,a){return!!(a&B.FLAG_OUTBOUND)&&(!Object(i.isSelfMessage)(t.peerId,e.get().gid)&&(!(Object(i.isChatPeer)(t.peerId)&&t.data&&t.data.closed)&&(!t.unread&&!(!t.lastmsg||t.lastmsg<=t.out_up_to))))}function oe(e){var t=he(e);return!!(e.unread>0&&t)||!!Object(s.isTabMarkedUnread)(e)}function le(e){return!(!e.mentions||!e.mentions.length)}function de(e){return function(e){return!(!e.expiring_messages||!e.expiring_messages.length)}(e)&&!le(e)}function ue(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=a||he(t),l=Z(e,t.peerId,t,Object(i.isClassicInterface)(e)),c=l.photo,d=l.userLink;if(!o)return ne(t,c,d,e,n);var u=o.flags,g=Object(i.isFvkcomgroup)(e,t.peerId),m=Object(s.tabIsMessageRequestToChat)(t),_=Object(s.isCasperChat)(e,t.peerId),p=Object(i.isContactPeer)(t.peerId),h=pe(t,e,a),b=Object(s.isCommunityChat)(e,t.peerId),v=t.major_sort_id,f=[];n.search&&f.push("_im_search","nim-dialog_search"),inArray(t.peerId,e.get().mutedPeers)&&f.push("nim-dialog_muted"),t.verified&&f.push("nim-dialog_verified"),_&&f.push("nim-dialog_casper"),Object(s.isRecentSearchesActive)(e)&&f.push("nim-dialog_recent"),Object(r.isMessageEmpty)(o)&&!_&&f.push("nim-dialog_empty"),Object(i.isClassicInterface)(e)&&f.push("nim-dialog_classic"),t.folders&B.FOLDER_IMPORTANT&&f.push("nim-dialog_starred"),!n.search&&Object(i.isUnrespond)(e,t.peerId,t)&&f.push("nim-dialog_unrespond"),(g||b)&&e.get().gid&&f.push("nim-dialog_deny-remove"),le(t)&&f.push("nim-dialog_unread-mentions"),de(t)&&f.push("nim-dialog_unread-expiring"),t.callInProgress&&f.push("nim-dialog_active-call"),t.callInProgress&&t.callInProgress.participants.count<1&&f.push("nim-dialog_active-call-empty"),Object(q.isPinnedSortId)(v)&&f.push("nim-dialog_pinned");var O=Object(s.tabIsMessageRequestToChat)(t)?t.mr&&t.mr.request_date:o.date,C=e.get().timeshift,y=O?getShortDateOrTime(O,C,!0,getLang("months_sm_of","raw")):"",j=!ie(e,t,u)||m||Object(s.isSearching)(e)?"":"nim-dialog_unread-out",E=t.unread>0?getLang("mail_im_new_messages",t.unread):"",S=p?Object(i.prepareContactName)(t.tab):t.tab;return getTemplate("im_drow",{peer:t.peerId,msg_id:o.messageId,photo:c,user_link:d,date:y,body:h,unread_message_string:E,tab_name:stripHTML(S),unread:Object(i.simplifyCounter)(t.unread),more:f.join(" "),is_online:onlinePlatformClass(t.online),is_unread:oe(t)?"nim-dialog_unread":"",is_unread_out:j,is_selected:n.noselect||m||t.peerId!=e.get().peer?"":"nim-dialog_selected _im_dialog_selected"})}function me(e,t,a,n,o){if(!t.deletedDialog)if(hasClass(e,"nim-conversation-search-row"))_e(e,t,a);else{var c=a.get(),d=he(t),u=d.flags,g=pe(t,a),m=Z(a,t.peerId,t,Object(i.isClassicInterface)(a)),_=m.photo,p=m.userLink,h=a.get().timeshift,b=d.date?getShortDateOrTime(d.date,h,!0,getLang("months_sm_of","raw")):"";Ie(e,t),val(geByClass1("_dialog_body",e),g),val(geByClass1("_im_dialog_date",e),b),val(geByClass1("_im_dialog_unread_ct",e),Object(i.simplifyCounter)(t.unread));var v=geByClass1("_im_dialog_link",e);v&&val(v.parentNode,p);var f=geByClass1("_im_dialog_photo",e);f.innerHTML!==_&&val(f,_),c.is_peer_profile_enabled&&(c.peer||De(e,a));var O=Object(s.isCasperChat)(a,t.peerId);toggleClass(e,"nim-dialog_verified",!!t.verified),toggleClass(e,"nim-dialog_casper",O),toggleClass(e,"nim-dialog_muted",inArray(t.peerId,a.get().mutedPeers)),toggleClass(e,"nim-dialog_unrespond",Object(i.isUnrespond)(a,t.peerId,t)),toggleClass(e,"nim-dialog_classic",Object(i.isClassicInterface)(a)),toggleClass(e,"nim-dialog_unread",oe(t)),toggleClass(e,"nim-dialog_unread-mentions",le(t)),toggleClass(e,"nim-dialog_unread-expiring",de(t)),toggleClass(e,"nim-dialog_active-call",!!t.callInProgress),toggleClass(e,"nim-dialog_active-call-empty",!!t.callInProgress&&t.callInProgress.participants.count<1),toggleClass(e,"nim-dialog_pinned",Object(q.isPinnedSortId)(t.major_sort_id)),toggleClass(e,"nim-dialog_deny-remove",a.get().gid>0&&(Object(i.isFvkcomgroup)(a,t.peerId)||Object(s.isCommunityChat)(a,t.peerId))),removeClass(e,"nim-dialog_failed"),removeClass(e,"nim-dialog_deleted"),addClass(e,"_im_dialog"),Object(l.toggleOnline)(geByClass1("_im_peer_online",e),t.online),toggleClass(e,"nim-dialog_recent",Object(s.isRecentSearchesActive)(a)),toggleClass(e,"nim-dialog_empty",Object(r.isMessageEmpty)(d)&&!O),toggleClass(e,"nim-dialog_unread-out",ie(a,t,u)&&!Object(s.isSearching)(a)),Ne(e),toggleClass(e,"nim-dialog_starred",t.folders&B.FOLDER_IMPORTANT),o&&setTimeout((function(){addClass(geByClass1("_im_dialog_"+t.peerId,n),"nim-dialog_injected")}),100)}}function _e(e,t,a){Ie(e,t),toggleClass(e,"nim-dialog_recent",Object(s.isRecentSearchesActive)(a)),val(geByClass1("_im_dialog_unread_ct",e),Object(i.simplifyCounter)(t.unread)),toggleClass(e,"nim-dialog_unread",oe(t)),toggleClass(e,"nim-dialog_unread-expiring",de(t)),toggleClass(e,"nim-dialog_unread-mentions",le(t));var n=Z(a,t.peerId,t,Object(i.isClassicInterface)(a)).photo,r=geByClass1("_im_dialog_photo",e);r.innerHTML!==n&&val(r,n),Object(l.toggleOnline)(geByClass1("_im_peer_online",e),t.online)}function pe(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=a||he(e),o=Object(s.tabIsMessageRequestToChat)(e),l=Object(s.isCasperChat)(t,e.peerId);if(o){var c=Object(i.isClassicInterface)(t),d=e.mr&&e.mr.inviter_id,u=Object(F.oCacheGet)(t,d),g=c?u.name:u.short_name,m=c?getTemplate("im_img_prebody",{photo:u.photo}):"",_=getLang("mail_mr_service_message").replace(/{user}/,g);return m+_}if(Object(i.isPeerBlocked)(e.peerId,t)){var p=t.get().block_states[e.peerId].name,h=getLang("mail_community_answering").replace("{username}",p);return getTemplate("im_drow_prebody",{prebody:h,body:""})}return Object(r.isServiceMsg)(n)&&!o?Object(i.renderServiceMsg)(t,n,e,!1):l&&Object(r.isMessageEmpty)(n)?getLang("mail_empty_casper_message"):Object(r.isExpiredCasperMessage)(n)?getLang("mail_expired_message"):ae(t,n.flags,e.peerId,n.userId,!0,n.attaches,n.text,n.subject,Object(i.isClassicInterface)(t),Object(F.oCacheGet)(t,t.get().id).photo)}function he(e){var t=e.lastmsg_meta;return Array.isArray(t)&&(t=Object(G.getMessageFromTuple)(t)),t||Object(G.getMessageFromTuple)([-1,0,e.peer,0,"",{},{},-1,-1,0])}function be(e,t,a){var r=Object(s.getTab)(e,t),o=Object(s.tabIsMessageRequestToChat)(r),l=Object(i.showLeaveDialog)(e,t,s=>{a().updateMenu(e);var r=Promise.resolve();Object(i.isChatPeer)(t)&&(r=o?e.set(n.rejectMessageRequest.bind(null,t)):e.set(n.leaveChat.bind(null,t))),s&&r.then(()=>Object(i.cleanHistory)(e,l,a,n.flushHistory,t)),l.hide()})}function ve(e,t,a,s,r,o){var l=gpeByClass("_im_dialog",o,a);if(cancelEvent(r),!l)return!1;var c=intval(domData(l,"peer")),d=t.get(),u=Object(i.isCommunityPeer)(c)||Object(i.isUserPeer)(c);if(d.recentSearch){var g=Object(n.removeFromRecentSearch)(c,cur.imDb);re(l),0===g.length&&Pe(t,s,e)}else Object(i.isClassicInterface)(t)&&u?Object(n.deleteDialog)(c,d).then(a=>{var n=K(a,2),i=n[0],s=n[1];i?(!function(e,t,a,n,i){var s=geByClass1("_dialog_body",t);addClass(t,"nim-dialog_deleted"),removeClass(t,"_im_dialog"),val(s,getTemplate("im_delete_actions",{text:langNumeric(a,getLang("mail_im_X_message_deleted","raw")),peer:e,spam_id:n}))}(c,l,i,s),e().updateMenu(t)):be(t,c,e)}):be(t,c,e);return!1}function fe(e,t){Object(i.toggleMessageRequestsTab)(e,t,n.changeDialogsTab)}function Oe(e,t){switch(t.type){case"sep_btn_search_msg":return Object(i.renderBtnSearchOnlyMessages)(e);case"sep_messages":return Object(i.renderMessagesSep)();case"sep_conversations":return Object(i.renderConversationsSep)();case"sep_popular":return Object(i.renderPopularSuggSep)();case"popular_sugg":return Object(i.renderPopularSuggestions)(e);case"clear_recent":return Object(i.renderClearRecent)();case"empty_dialogs":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_list_empty")});case"empty_message_requests":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_mr_empty")});case"empty":return getTemplate("im_dialogs_none",{msg:getLang("mail_im_search_empty")});case"message_request_notice":return getTemplate("im_dialogs_message_requests_notice",{msg:getLang("mail_message_request_tab_notice")});case"message_request_button_go":return getTemplate("im_dialogs_message_requests_button",{msg:getLang("mail_tab_mr")});case"message_request_button_return":return getTemplate("im_dialogs_message_requests_button",{msg:getLang("mail_go_to_all_tab")});default:return t.message?ue(e,t,t.message,{noselect:!0,search:!0}):t.local_index||Object(s.isSearching)(e)?function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=Z(e,t.peerId,t,Object(i.isClassicInterface)(e)),r=n.photo,o=n.userLink,l=ee(e),c=""===a?[]:[a];return Object(s.isRecentSearchesActive)(e)&&c.push("nim-dialog_recent"),Object(i.isClassicInterface)(e)&&c.push("nim-csr_classic"),inArray(t.peerId,e.get().mutedPeers)&&c.push("nim-dialog_muted"),Object(s.isCasperChatTab)(t)&&c.push("nim-dialog_casper"),le(t)&&c.push("nim-dialog_unread-mentions"),de(t)&&c.push("nim-dialog_unread_expiring"),getTemplate("im_conversation_search_row",{peer:t.peerId,msg_id:t.lastmsg||"",photo:r,user_link:o,unread:Object(i.simplifyCounter)(t.unread),tab_name:stripHTML(name),is_unread:oe(t)?"nim-dialog_unread":"",is_online:onlinePlatformClass(t.online),is_selected:t.peerId==e.get().peer&&l?"nim-dialog_selected _im_dialog_selected":"",more:c.join(" ")})}(e,t):ue(e,t)}}function Ce(e,t,a,s,r,o){var l=intval(domData(o,"peer")),c=domData(o,"action"),d=domData(o,"sid"),u=geByClass1("_im_dialog_"+l,t),g=intval(domData(o,"spam"));switch(c){case"restore":u&&e.set(n.restoreDialog.bind(null,l,d,g)).then(()=>{addClass(u,"_im_dialog"),removeClass(u,"nim-dialog_deleted"),me(u,e.get().tabs[l],e,t,!1),s().updateMenu(e)});break;case"spam":var m=`${getLang("mail_im_dialog_marked_spam")}\n        <button type="button" class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction"\n          data-action="restore"\n          data-spam="1"\n          data-sid="${d}" data-peer="${l}">\n            ${getLang("mail_restore")}\n        </button>`;if(u){var _=geByClass1("_dialog_body",u);val(_,m),Object(n.spamDialog)(l,d,e.get())}break;case"block":(Object(i.isCommunityInterface)(e)?Object(i.showBlacklistBox)(l,e):Object(i.showBlacklistBoxUser)(l,e)).once("success",(function(){e.set(n.flushHistory.bind(null,l)).then(()=>{a().restoreDialogs(e)})}))}cancelEvent(r)}function ye(e,t){return e.map(e=>Object(G.getMessageFromTuple)(e)).map(e=>extend({},t[e.peerId],{message:e}))}function je(e){return{type:"empty",lang:e}}function Ee(e,t){var a=e.get().msg_local_ids_sort,n=a&&a[t.lastmsg];return void 0!==n?2e9+n:t.minor_sort_id||0}function Se(e,t,a,i){var s=gpeByClass("_im_dialog",i,t),r=intval(domData(s,"peer"));return e.set(n.toggleDialogImportant.bind(null,r)),setTimeout((function(){we(e,t,a,i)}),100),cancelEvent(a),!1}function Te(e,t,a){var n=(t.lastmsg||!Object(W.partConfigEnabled)("messenger_empty_pinned_support"))&&t.major_sort_id||0,s=(a.lastmsg||!Object(W.partConfigEnabled)("messenger_empty_pinned_support"))&&a.major_sort_id||0,r=n!==s?s-n:Ee(e,a)-Ee(e,t);return r=Object(i.isReversedDialogs)(e)?-r:r}function we(e,t,a,n){Object(U.showTooltip)(n,{text:function(){var a=gpeByClass("_im_dialog",n,t),i=domData(a,"peer");return e.get().tabs[i].folders&B.FOLDER_IMPORTANT?getLang("mail_im_toggle_important_off"):getLang("mail_im_toggle_important")},black:1,zIndex:1,shift:[14,8],toup:He(e,n.getBoundingClientRect().top)})}function Ie(e,t){var a=t.unread>0?getLang("mail_im_new_messages",t.unread):"",n=geByClass1("_im_unread_blind_label",e);val(n,a)}function Ae(e,t,a,i,r){var o=gpeByClass("_im_dialog",r,t),l=intval(domData(o,"peer")),c=e.get().tabs[l].lastmsg;return e.set(n.markDialogAnswered.bind(null,l,c)).then(()=>{me(o,e.get().tabs[l],e,t),Object(s.isRecentSearchesActive)(e)||a().restoreDialogs(e)}),showDoneBox(getLang("mail_marked_as_answered"),{out:1e3}),cancelEvent(i),!1}function Me(e){var t=Object(s.isSearching)(e),a=e.get().searchOnlyMessages;return Object(i.isClassicInterface)(e)?{top:t&&!a?96:60,bottom:Object(i.isCommunityInterface)(e)?42:87}:{top:t&&!a?36:0,bottom:0}}function ke(e,t){e.hoverFirstElement(z,Me(t))}function Le(e){e.unhoverElements(z)}function Pe(e,t,a){if(Object(s.doPopularSuggExist)(e)){t.pipeReplace(Promise.resolve([{type:"sep_popular"},{type:"popular_sugg"}])),t.toTop()}else a().cancelSearch(e),cancelStackFilter("im_search")}function Ne(e){var t=geByClass1("_im_dialog_star",e),a=geByClass1("_im_dialog_date",e);if(t&&a){var n=a.offsetWidth;t.style.right=15+n+14+"px"}}function De(e,t){var a=t.get(),n=parseInt(domData(e,"peer")),r=Object(s.getTab)(a,n);if(a.is_peer_profile_enabled&&Object(i.isCommunityInterface)(a)&&r&&!Object(s.isChannelPeer)(r)&&!Object(s.isCommunityChat)(a,n)){var l=geByClass1("_im_dialog_peer_tags",e);if(r.ad_id||a.peer_profile_tags&&r.peer_tags&&r.peer_tags.ids){var c=r.peerTagsMaxWidth||0;if(!c){var d=geByClass1("_im_dialog_name_w",e).offsetWidth;c=340-(d+6+(r.verified?16:0)),t.set(e=>(e.tabs[n].peerTagsMaxWidth=c,Promise.resolve(e)))}Object(o.renderPeerTags)(l,c,t,n)}else l.innerHTML&&(l.innerHTML="")}}function xe(e,t){Object(i.isCommunityInterface)(e)&&("empty_dialogs"===domData(t,"list-id")?Object(o.updateEmptyDialogsMargin)():hasClass(t,"_im_dialog")&&(Ne(t),De(t,e)))}function Be(e){checkEvent(e)||cancelEvent(e)}function Re(e,t,a,r,o){return{selectPeer(t,a){for(var n=geByClass("_im_dialog",e),i=a.get().peer,s=0;s<n.length;s++){var r=n[s],o=intval(domData(r,"peer")),l=intval(domData(r,"msgid"));o===i&&(!X(r)||t===l&&X(r))?(addClass(r,"nim-dialog_selected"),addClass(r,"_im_dialog_selected")):hasClass(r,"_im_dialog_selected")&&(removeClass(r,"nim-dialog_selected"),removeClass(r,"_im_dialog_selected"))}},appendFastDialogs(t,n,r){removeClass(e.parentNode,"im-page--dialogs_with-mess"),a.saveScroll("list"),r?(a.reset(),Object(i.isPendingForward)(t)||Object(s.isRecentSearchesActive)(t)||!m(n)?Object(s.isRecentSearchesActive)(t)&&(m(n)&&(n=[{type:"clear_recent"}].concat(n)),Object(s.doPopularSuggExist)(t)&&(n=[{type:"sep_popular"},{type:"popular_sugg"}].concat(n))):n=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(n),t.setState({searchOnlyMessages:!1}),a.pipeReplace(Promise.resolve(n)).then(()=>ke(a,t))):a.pipe(Promise.resolve(n)),Object(i.isClassicInterface)(t)&&!Object(i.isReservedPeer)(t.get().peer)||a.toTop()},deactivate(){a.deactivate()},activate(){a.activate()},hoverFirstDialog(e){ke(a,e)},hoverNextDialog(e){a.hoverNextElement(z,Y,Me(e))},hoverPrevDialog(e){a.hoverPrevElement(z,Y,Me(e))},unhoverDialogs:Le.bind(a),selectHoveredDialog(t){var n=geByClass1("_im_dialog_hovered",e);n||(n=geByClass1("_im_dialog",e)),n&&J(r,this,t,a,{},n)},appendSearch(t,n,i){var s=ye(i,n);i.length>0?(addClass(e.parentNode,"im-page--dialogs_with-mess"),a.pipe(Promise.resolve([{type:"sep_messages"}].concat(s))).then(()=>ke(a,t))):(0===a.getCurrentElements().length&&a.pipeReplace(Promise.resolve([je()])),removeClass(e.parentNode,"im-page--dialogs_with-mess"))},update(e){a.pipeReplace(Promise.resolve(Fe(e)))},updateDialog(t,a){var n=geByClass1("_im_dialog_"+t,e);n&&!X(n)&&me(n,Object(s.getTab)(a,t),a,e)},focusOnSelected(t){var n=t.get().peer;if(n){var i=geByClass1("_im_dialog_"+n,e);i?a.scrollTop(i.offsetTop-i.offsetHeight):a.toTop()}},restoreScroll(e){a.restoreScroll("list")||a.toTop()},forceScrollReinit(){var e=a.getScroller();e&&(e.style.overflowY="hidden",setTimeout(()=>e.style.overflowY="",0))},restoreDialogs:(t,n,s)=>(removeClass(e.parentNode,"im-page--dialogs_with-mess"),t.setState({searchOnlyMessages:!1}),0!==Fe(t).length||a.isLoading()||(n=!0),n&&a.reset(),s&&a.wipe(),a.pipeReplace(Promise.resolve(Fe(t))).then(()=>{if(n&&(!Object(i.isClassicInterface)(t)||!t.get().peer)){var e=function(e,t,a){return Object(i.isClassicInterface)(a)||t().toggleSettingsLoader(a,!0),e.checkMore(!Object(i.isClassicInterface)(a)).then(()=>{Object(i.isClassicInterface)(a)||t().toggleSettingsLoader(a,!1)})}(a,r,t);return a.toTop(),e}}).then(()=>Le(a))),appendDialogs(t,n){removeClass(e.parentNode,"im-page--dialogs_with-mess"),n.forEach(a=>{var n=geByClass1("_im_dialog_"+a.peerId,e);n&&_e(n,a,t)}),Object(i.isPendingForward)(t)||Object(s.isRecentSearchesActive)(t)||!m(n)||(n=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(n)),t.setState({searchOnlyMessages:!1}),a.isEmpty()&&0===n.length&&Object(i.isPendingForward)(t)&&(n=[je(getLang("mail_im_search_empty_chats"))]),a.replacePreserveOrder(n)},updateCounter(t,a){var n=geByClass1("_im_dialog_"+a,e),r=Object(s.getTab)(t,a);if(n&&!X(n)&&(Ie(n,r),val(geByClass1("_im_dialog_unread_ct",n),Object(i.simplifyCounter)(r.unread)),toggleClass(n,"nim-dialog_unread",oe(r)),toggleClass(n,"nim-dialog_unread-out",ie(t,r,he(r).flags)),toggleClass(n,"nim-dialog_unread-mentions",le(r)),toggleClass(n,"nim-dialog_unread-expiring",de(r))),Object(s.isRecentSearchesActive)(t)){var o=geByClass1("_im_sugg_"+a,e);o&&(val(geByClass1("_sugg_unread_ct",o),Object(i.simplifyCounter)(r.unread)),toggleClass(o,"sugg-is_unread",r.unread>0))}},removeDialog(e,t){a.remove(t)},updateOnline(t,a){var n=geByClass1("_im_dialog_"+t,e);if(n){var i=a.get().tabs[t],s=geByClass1("_im_peer_online",n);Object(l.toggleOnline)(s,i.online)}},setDialogFailed(t,a,n){var i=geByClass1("_im_dialog_"+t,e);i&&(n.get().tabs[t].lastmsg===a&&(addClass(i,"nim-dialog_failed"),val(geByClass1("_im_dialog_unread_ct",i),"!")))},scrollUp(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];a.toTop(e,t),a.saveScroll("list",!0)},saveScroll(e){a.saveScroll("list",!0)},promoteDialog(n,i){var r=geByClass1("_im_dialog_"+i,e);r&&!X(r)||!Object(s.isSearching)(n)?(a.pipeReplace(Promise.resolve(Fe(n)),void 0,!0).then(t=>{!inArray(i,t)&&r&&me(r,Object(s.getTab)(n,i),n,e)}),t().updateTyping(i,n)):a.unsetScroll("list")},removeSelection(t){var n=t.get().peer.toString(),s=`._im_dialog_${n}.${Y.join(".")}`,r=domQuery(s,e)[0];Y.forEach(e=>removeClass(r,e)),Object(i.isClassicInterface)(t)||a.hoverElement(n,z,Me(t))},updateScroll(){a.updateScroll()},updateTyping(t,a){var n=geByClass1("_im_dialog_"+t,e);if(n&&!X(n)&&!a.get().tabs[t].deletedDialog){var r=geByClass1("_im_dialog_typing",n),o=!Object(i.isClassicInterface)(a),l=Object(i.formatTyper)(Object(s.getTab)(a,t).activity,t,!Object(i.isChatPeer)(t),a.get(),1,o);val(r,l),toggleClass(n,"nim-dialog_typing",l)}},showInvitationBox(e,t){var a=()=>this.removeDialog(e,t),o=()=>Object(i.isClassicInterface)(e)&&r().updateMenu(e);return(Boolean(Object(s.getTab)(e,t))?Promise.resolve():e.set(n.loadPeer.bind(null,t,0,0,0))).then(()=>{var r=Object(s.getTab)(e,t);if(!Object(s.tabIsMessageRequestToChat)(r)){var l=Object(d.changePeer)(t,!1,!1,!1,"");return e.get().longpoll.push([l])}return Object(i.showInvitationBox)(e,{receiver_peer_id:t},n.leaveInvitation,!1,{updateList:a,updateMenu:o})})},updateStarPosition(){!function(e){geByClass("_im_dialog",e).forEach(e=>{Ne(e)})}(e)},renderPeerTags(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;a?De(geByClass1("_im_dialog_"+a,e),t):function(e,t){var a=t.get();a.is_peer_profile_enabled&&Object(i.isCommunityInterface)(a)&&geByClass("_im_dialog",e).forEach(e=>{De(e,t)})}(e,t)},unmount(){a.unmount(),Object(c.destroyModule)(o)}}}function Fe(e){var t=e.get(),a=t.active_tab,n=t.dialog_tabs[a],s=t.tabs,r=n.map(e=>s[""+e]).sort(Te.bind(null,e)),o=t.dialog_tab_cts.mr;if(a===p.FOLDER_MESSAGE_REQUEST&&r.unshift({type:"message_request_notice"}),!Object(i.isClassicInterface)(e))switch(a){case p.FOLDER_ALL:o>0&&r.unshift({type:"message_request_button_go"});break;case p.FOLDER_MESSAGE_REQUEST:r.unshift({type:"message_request_button_return"})}return r}function He(e,t){var a=e.get().gid?220:150;return!(Object(o.isPeerTagsFolder)(e)&&t<=a+46)&&(t>a||Object(s.isSearching)(e))}function Ue(e,t,a,r){var d=Object(c.createMutations)(Re),u=d.callMutations,g=d.bindMutations,m=function(e,a){Object(U.showTooltip)(a,{text:()=>{if(Object(s.isRecentSearchesActive)(t))return getLang("mail_hide_from_recent");var e=Number(a.getAttribute("data-peer")),n=Object(s.getTab)(t,e),r=Object(s.tabIsMessageRequestToChat)(n);return Object(i.isChatPeer)(e)&&!r?Object(H.doesChatTabHaveFlag)(Object(s.getTab)(t,e),1024)?getLang("mail_unfollow_channel"):Object(s.isChatActive)(n)?getLang("mail_leave_chat"):getLang("mail_delete"):getLang("mail_delete")},black:1,[Object(i.isClassicInterface)(t)?"center":"needLeft"]:!0,shift:Object(i.isClassicInterface)(t)?[-4,10]:[0,10],toup:He(t,a.getBoundingClientRect().top),zIndex:1})},_=function(e,a){Object(U.showTooltip)(a,{text:getLang("mail_end_conversation"),black:1,center:!0,zIndex:1,shift:[1,4],toup:He(t,a.getBoundingClientRect().top)})},p=we.bind(null,t,e),b=Se.bind(null,t,e),v=Ae.bind(null,t,e,u),f={idFn:e=>function(e,t){return t.message?t.message.messageId:Object(s.isSearching)(e)&&t.peerId?t.peerId+"cr":t.peerId||t.type}(t,e),hoverableFn:e=>hasClass(e,"_im_dialog"),renderFn:Oe.bind(null,t),more:$.bind(null,t,u),onScroll:!!Object(i.isClassicInterface)(t)&&(()=>{(bodyNode.scrollTop||document.documentElement.scrollTop)<=0&&!layers.visible&&browser.safari?addClass(r,"im-page--header_static"):removeClass(r,"im-page--header_static")}),onRenderFn:xe.bind(null,t)},O=x(e,Object(h.default)({limit:40,offset:0,nativeScroll:!!Object(i.isClassicInterface)(t),height:64,elements:Fe(t)}),()=>f),C=J.bind(null,a,u,t,O),y=Q.bind(null,t,e,O),j=Ce.bind(null,t,e,u,a),E=ve.bind(null,a,t,e,O),S=fe.bind(null,t,a),T=Object(c.createModule)({handlers:(s,r)=>{r(e,"click","_im_dialog_close",E),r(e,"click","_im_dialog_markre",v),r(e,"click","_im_dialog_star",b),r(e,"click","_im_dialog",C),r(e,"click",i.MESSAGE_SEARCH_CLASS,y),r(e,"mouseover","_im_dialog_close",m),r(e,"mouseover","_im_dialog_markre",_),r(e,"click",i.CLEAR_RECENT_CLASS,()=>{Object(n.resetRecentSearch)(cur.imDb),Pe(t,O,a)}),r(e,"click",i.TOGGLE_MR_TAB,S),r(e,"mouseover","_im_dialog_star",p),r(e,"click","_im_dialog_daction",j),r(e,"click","_im_peer_target",Be),Object(i.isCommunityInterface)(t)&&t.get().is_peer_profile_enabled&&(r(e,"mouseover","_im_peer_tags_extra",e=>Object(o.onPeerTagsExtraHover)(e,t)),r(e,"click","_im_dialog_peer_tag",e=>Object(o.onDialogPeerTagClick)(e,t))),s(e,"mouseover",Object(l.throttle)(O.unhoverElements.bind(O,z),100))}});return g(e,u,O,a,T)}a("KKXr"),a("hhXQ");var Ge,qe,We,Ke,Ve,Ye,ze,Qe,Xe,$e,Je,Ze,et,tt,at,nt=a("O8ze"),it=a("hC3G"),st=a("/eGY"),rt=a("RQ7Z"),ot=a("XLJO"),lt=(a("/8Fb"),a("ZVxX")),ct=a("EasH"),dt=browser.msie&&intval(browser.version)<10?window.XDomainRequest:window.XMLHttpRequest;function ut(e){var t=e%60;return parseInt(e/60)+":"+(t<10?"0":"")+t}var gt=!1,mt=!1,_t=100;function pt(e){var t=e.get().peer;Object(i.isFullyLoadedTab)(e,t)&&!Object(i.isAnyMessageBeingEdited)(e)&&Date.now()-(Object(i.getTab)(e,t).lastTyping||0)>1e3*n.ACTIVITY_PERIOD&&e.set(n.sendRecordingAudio.bind(null,t))}function ht(e){if(!mt){mt=!0,Object(i.lockButton)(Ye);var t={peer:Xe.get().peer,from_place:cur.docsChooseFrom,imhash:cur.docsChooseImHash,blockPersonal:cur.docsChooseBlockPersonal,mail_add:cur.docsChooseMailAdd};(function(e){return new Promise((t,a)=>{var n=e.getFormData(),i=new dt;i.onload=i.onerror=function(e){var n=e.currentTarget.response;200==this.status&&n.length>0&&"{"==n[0]?(n=JSON.parse(n),t(n)):a()},i.open("POST",at.upload_url,!0),i.send(n)})})(e).then(e=>e.file?new Promise((a,n)=>{ajax.post("/docs.php",extend({act:"a_save_doc",from:"choose",from_place:t.from_place,imhash:t.imhash,blockPersonal:t.blockPersonal,mail_add:t.mail_add},e),{onDone:(e,n)=>{Ct(),Ze([["doc",e+"_"+n,"audiomsg"]],{},t.peer),wt(),a()},onFail:function(e){n(e)},progress:null})}):Promise.reject()).then(()=>{Object(i.unlockButton)(Ye),mt=!1}).catch(()=>{mt=!1,Object(i.unlockButton)(Ye),Object(ct.showFastBox)(getLang("global_error"),getLang("mail_audio_message_upload_error"))})}}function bt(){tt(),qe.innerHTML=ut(gt.duration),gt.duration>=600&&Tt()}function vt(e){e.set(n.cancelRecording).then(Et)}function ft(){tt(),stManager.add(["voice_message_player.js","speech.js"],(function(){gt||(gt=Speech.newRecorder(),addEvent(gt,"progress",bt)),AudioMessagePlayer.detachPlayer(),AudioMessagePlayer.pauseGlobalMedia(),gt.record().then(()=>{var e;e=Xe,at.isRecording=!0,cancelStackPush("audio_message_cancel",vt.bind(null,e)),hideProgress(geByClass1("im-audio-message-send-wrapper",Ge)),qe.innerHTML="0:00",addClass(Ge,"im-audio-message_recording"),removeClass(Ge,"im-audio-message_recorded"),function(){Ge&&Ge.classList&&Ge.classList.remove("im-audio-message-input--hidden");geByClass1("_im_chat_input_parent",Qe).classList.add("im-chat-input--hidden")}(),(Je=Speech.createVisualization("wave",gt.source,We)).start();var t=We.getBoundingClientRect();_t=(t.right-t.left)/3}).catch(e=>{AudioMessagePlayer.resumeGlobalMedia();var t=e.name;switch(e.name){case"DevicesNotFoundError":case"NotFoundError":case"NotAllowedError":t="mail_audio_message_device_error";break;case"PermissionDeniedError":case"PermissionDismissedError":t="mail_audio_message_permission_error";break;case"Unsupported":t="mail_audio_message_unsupported_error"}Object(ct.showFastBox)(getLang("global_error"),getLang(t)),console.error(e)})}))}function Ot(){gt&&gt.stop(),Je&&(Je.destroy(),Je=null)}function Ct(){at.isRecording=!1,cancelStackFilter("audio_message_cancel")}function yt(){jt(),ht(gt)}function jt(){var e;AudioMessagePlayer.loaded&&AudioMessagePlayer.resumeGlobalMedia(),removeEvent(gt,"finish",jt),removeEvent(gt,"finish",yt),e=URL.createObjectURL(gt.buffer),domData($e,"duration",gt.duration),domData($e,"ogg",e),domData($e,"mp3",e),geByClass1("audio-msg-track--duration",$e).innerHTML=ut(gt.duration),geByClass1("audio-msg-track--wave-wrapper",$e).innerHTML=AudioMessagePlayer.getWave(gt.wave,_t),removeClass(Ge,"im-audio-message_recording"),addClass(Ge,"im-audio-message_recorded")}function Et(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Ct(),AudioMessagePlayer.loaded&&(AudioMessagePlayer.resumeGlobalMedia(),AudioMessagePlayer.detachPlayer()),removeEvent(gt,"finish",jt),removeEvent(gt,"finish",yt),Ot(),wt(),e&&et()}function St(){gt.isRecording?(addEvent(gt,"finish",yt),removeEvent(gt,"finish",jt),Ot()):ht(gt)}function Tt(){addEvent(gt,"finish",jt),removeEvent(gt,"finish",yt),Ot()}function wt(){removeClass(Ge,"im-audio-message_recorded"),removeClass(Ge,"im-audio-message_recording"),Ge&&Ge.classList&&Ge.classList.add("im-audio-message-input--hidden"),geByClass1("_im_chat_input_parent",Qe).classList.remove("im-chat-input--hidden")}function It(){ge("audiomsg_record"),$e=ge("audiomsg_player"),Qe=geByClass1("_im_chat_input_w"),Ge=geByClass1("im-audio-message-input",Qe),qe=geByClass1("audio-msg-track--duration",Ge),We=geByClass1("audio-msg-track--wave",Ge),Ve=geByClass1("im-audio-message--cancel-btn",Ge),Ye=geByClass1("_im_audio_send",Ge),ze=geByClass1("audio-msg-track--btn",Ge),geByClass1("im-chat-input--text",Qe);var e=geByClass1("im-chat-input--textarea",Qe);addClass(e,"_voice_field_wrap"),addEvent(Ke,"click",ft),addEvent(Ve,"click",Et),addEvent(Ye,"click",St),addEvent(ze,"click",Tt)}function At(){!function(){gt&&removeEvent(gt,"progress",bt);removeEvent(Ke,"click",ft),removeEvent(Ve,"click",Et),removeEvent(Ye,"click",St),removeEvent(ze,"click",Tt)}(),$e=Ge=qe=We=Ke=Ve=Ye=ze=null}function Mt(e,t,a){return{cancelRecording:Et,start:function(){ft()},unmount(){Et(!1),At()}}}function kt(e,t,a,s,r){return Xe=t,at=t.get().audio_msg,tt=pt.bind(null,t),Ze=a,et=r,Object(lt.initFailBack)(),Object(i.getAvailableMicrophones)().then(e=>{var a=e.length>0;a?(It(),s()):setCookie("remixvoice","0",7),t.set(n.setVoiceMessageAvail.bind(null,a))}).catch(e=>{throw setCookie("remixvoice","0",7),e}),(0,Object(c.createMutations)(Mt).bindMutations)(e,t,a)}var Lt=a("q1tI"),Pt=a.n(Lt),Nt=a("i8i4"),Dt=a.n(Nt),xt=a("1Ot2"),Bt=a("Jbbb"),Rt=a("ZxpX"),Ft=a("BiHW"),Ht=a("N4ZS"),Ut=a("Egk5");a("17x9");function Gt(){return(Gt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function qt(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}class Wt extends Lt.Component{constructor(){super(...arguments),this.onLinkClick=e=>{var t=this.props.action.link;if(/^https:\/\/(.+\.)?vk\.com\/gifts580392144\?act=send&ref=[^&]+$/.test(t))return Object(ct.showBox)("al_gifts.php",{act:"get_gift_box",mid:580392144,fr:0,ref:t.split("&ref=")[1]},{stat:["gifts.css","wide_dd.js","wide_dd.css"],dark:1}),Object(Ut.cancelEvent)(e)},this.onButtonClick=()=>{var e=this.props,t=e.action,a=e.sendMessage,n=e.appHash,i=e.keyboardAuthorId;return Object(st.handleButtonClick)(t,a,n,i)}}render(){var e=this.props,t=e.action,a=(e.sendMessage,e.appHash,e.keyboardAuthorId,qt(e,["action","sendMessage","appHash","keyboardAuthorId"])),n=Object(st.getButtonAppearance)(this.props),i=Object(st.getButtonLabel)(this.props),s=t.type,r=Lt.createElement(Ft.default,Gt({wide:!0,overflow:!0},a,{type:t.type,appearance:n,className:"BotButton BotButton--"+s,onClick:this.onButtonClick}),Lt.createElement("span",{className:"BotButtonLabel Button--overflow",dangerouslySetInnerHTML:{__html:i}}));switch(t.type){case st.BUTTON_TYPE_OPEN_LINK:return this.wrapLinkButton(r);default:return r}}wrapLinkButton(e){var t=this.props.action,a=Object(Ht.wrapAwayIfExternal)(t.link,!0);return Lt.createElement("a",{href:a,className:"Keyboard__buttonWrapper",target:"_blank",rel:"nofollow noopener",onClick:this.onLinkClick},e)}}Wt.defaultProps={color:st.BUTTON_COLOR_DEFAULT};var Kt=Wt;class Vt extends Lt.Component{static getButtonWidth(e){return`calc(100% / ${e} - 10px)`}render(){var e=this.props.store,t=this.props.send,a=e.get(),n=Object(s.getCurrentKeyboard)(e),i=a.keyboard_app_hash;return n&&n.buttons?Lt.createElement("div",{className:Object(Rt.classNames)("Keyboard",{"Keyboard--hidden":n.hide})},Lt.createElement(xt.Scroll,{className:"Keyboard__scroll-wrapper"},Lt.createElement("div",{className:"Keyboard__container"},n.buttons.map((e,a)=>Lt.createElement("div",{key:"row-"+a,className:"Keyboard__row"},e.map((a,s)=>Lt.createElement("div",{className:"Keyboard__button",key:"cell-"+s,style:{width:Vt.getButtonWidth(e.length)}},Lt.createElement(Kt,{sendMessage:t,appHash:i,keyboardAuthorId:n.author_id,action:a.action,type:a.action.type,color:a.color})))))))):null}}var Yt=Object(Bt.connect)(Vt);function zt(){return document.getElementById("_im_keyboard_container")}function Qt(e,t,a){return{init(){return new Promise(e=>{this.isMounted=!0,function(e,t,a){var n=zt();if(n){var i=Lt.createElement(Bt.default,{value:e},Lt.createElement(Yt,{send:t}));Nt.render(i,n,a)}}(t,a,e)})},toggle:(e,a,i)=>t.set(n.toggleKeyboard.bind(null,e,a,i)),unmount(){var t=zt();t&&this.isMounted&&Nt.unmountComponentAtNode(t),this.isMounted=!1,Object(c.destroyModule)(e)}}}var Xt=a("LYnS"),$t=a("nAFc"),Jt=a("fD+e").default,Zt=a("m5nf").default,ea=a("m5nf"),ta=ea.MAIN,aa=ea.EDIT;function na(e,t){return Object(Xt.default)().reduce((function(t,a){return t.replace(new RegExp("({"+a.id+"})","gi"),a.process(e))}),t).replace(/&lt;br&gt;/gi,"<br>")}function ia(e,t,a,i,r){var o;return{closeSettingsPopup:function(){o&&o.hide()},showSettingsPopup:function(e){var a=this,n={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:500,onShow:function(){var n=document.getElementById("TemplatesSettings");n&&Nt.render(Lt.createElement(Bt.default,{value:t},Lt.createElement(Zt,{popup:o,section:e,getTemplates:function(){return Object(s.getTemplates)(t)},saveTemplate:a.saveTemplate.bind(a),deleteTemplate:a.deleteTemplate.bind(a),closePopup:a.closeSettingsPopup.bind(a)})),n),requestAnimationFrame((function(){return o.updateBoxCoords()}))}};(o=new ct.MessageBox(n).content('<div id="TemplatesSettings"></div>')).show()},applyTemplate:function(e){var a=Object(s.getTemplates)(t).find((function(t){return t.id===e}));Object(nt.statlogsCommunityTemplatesClickEvent)(),i(na(t,Object($t.prepareToWriting)(a.text)))},getPreparedTemplates:function(){return Object(s.getTemplates)(t).map((function(e){return Object.assign({},e,{name:e.name,text:na(t,e.text)})}))},saveTemplate:function(e){var a=Object($t.decodeHTMLEntities)(e.name),i=Object($t.decodeHTMLEntities)(e.text);return t.set(e.id?n.updateTemplate.bind(null,e.id,a,i):n.createTemplate.bind(null,a,i))},deleteTemplate:function(e){return t.set(n.deleteTemplate.bind(null,e))},isNeedRenderTemplates:function(){return!!Object(s.getPeer)(t)&&(!!Object(s.isCommunityInterface)(t)&&(!(Object(s.getPeer)(t)>2e9&&Object(H.doesChatTabHaveFlag)(Object(s.getCurrentTab)(t),1024))&&!Object(s.isCommunityChat)(t,Object(s.getPeer)(t))))},toggleImText:function(e){void 0===e&&(e=this.isNeedRenderTemplates()),r(e)},update:function(){this.toggleImText()},unmount:function(){this.toggleImText(!1)}}}var sa=a("DM26");function ra(e,t){return t.queues[e].currEv=!1,Promise.resolve(t)}function oa(e,t){var a=t.queues[e].currEv;return a?(t.queues[e].errored.push(a),ra(e,t)):Promise.resolve(t)}function la(e,t,a){return a.queues[e]?(a.queues[e].errored=t?[]:a.queues[e].errored.concat(a.queues[e].evs),a.queues[e].evs=[],ra(e,a)):Promise.resolve(a)}function ca(e,t,a,n){var i=n.get().queues[e];if(i&&!i.currEv&&i.evs.length>0&&!i.pause){var s=ca.bind(null,e,t,a,n),r=i.evs.shift();i.currEv=r,t(e,r).then(()=>{n.get().opts.waitCommit||n.set(ra.bind(null,e))}).then(s).catch(t=>n.set(oa.bind(null,e)).then(()=>{a(e,function(e,t){var a=ma(e,t.get()).errored;return a.length>0&&a[a.length-1]}(e,n),t)}).then(s))}}function da(e,t,a){var n=a.queues[e];return n.errored.filter(e=>e.mess.messageId===t).forEach(e=>{e.failed=!1,n.evs.push(e)}),n.errored=n.errored.filter(e=>e.mess.messageId!==t),Promise.resolve(a)}function ua(e){var t=Date.now();return Object.keys(e.queues).forEach(a=>ga(a,e,t,18e5)),Promise.resolve(e)}function ga(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=t.queues[e],s=[];return i.errored.forEach(e=>{e.ts>=a-n?(e.failed=!1,i.evs.push(e)):s.push(e)}),i.errored=s,Promise.resolve(t)}function ma(e,t){return t.queues[e]||(t.queues[e]={evs:[],pause:!1,errored:[],currEv:!1}),t.queues[e]}function _a(e,t,a){return ma(e,a).pause=t,Promise.resolve(a)}function pa(e,t,a){return t.ts=Date.now(),ma(e,a).evs.push(t),Promise.resolve(a)}function ha(e){Object.keys(e.get().queues).forEach(t=>{e.set(oa.bind(null,t)),e.set(la.bind(null,t,!1))})}function ba(e,t,a){var n=Object(h.default)({queues:{},debug:a&&a.debug,opts:extend({},a)},a);return a&&a.store?(n.setState(function(e){for(var t={},a=Object.keys(e.queues),n=a.length,i=0;i<n;i++){var s=a[i],r=e.queues[s];(r.currEv||r.evs.length||r.errored.length)&&(t[s]=r)}return{queues:t,opts:e.opts}}(n.get())),ha(n)):ha(n),{pushMessage:(a,i)=>n.set(pa.bind(null,a,i)).then(n=>{ca(a,e,t,n)}),resend(a){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n.set(da.bind(null,a,i)).then(()=>{var s=n.get().queues[a].evs.filter(e=>e.mess.messageId===i)[0];return ca(a,e,t,n),s})},resendAll:()=>n.set(ua).then(()=>{Object.keys(n.get().queues).forEach(a=>{ca(a,e,t,n)})}),resendPeer:a=>n.set(ga.bind(null,a)).then(()=>{ca(a,e,t,n)}),reset:a=>n.set(la.bind(null,a,!0)).then(n=>{ca(a,e,t,n)}),setErrored:(e,t)=>n.set(a=>(ma(e,a).errored=t,Promise.resolve(a))),pause(e){n.set(_a.bind(null,e,!0))},isPaused:e=>!!ma(e,n.get()).pause,complete(a,i){var s=n.get();s.queues[a].currEv&&s.queues[a].currEv.rid===i&&n.set(ra.bind(null,a)).then(()=>{ca(a,e,t,n)})},resume(a){n.set(_a.bind(null,a,!1)).then(Object(sa.pause)(.1)).then(()=>{ca(a,e,t,n)})},inspectQueue(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!n.get().queues[e])return[];var a=n.get().queues[e];return(t&&a.currEv?[a.currEv]:[]).concat(a.evs.slice()).concat(a.errored.slice().map(e=>extend({},e,{failed:!0}))).sort((e,t)=>e.ts-t.ts)}}}var va=a("hOuX"),fa=a("4+be"),Oa=a("QGEU"),Ca=a("BJj/"),ya=(a("Oyvg"),a("rCUf")),ja="jpg jpeg png gif heic heif".split(" "),Ea=["application/vnd.rn-realmedia-vbr","application/vnd.rn-realmedia"];function Sa(e){var t=ja.slice(0,ja.length);if("types"===e){for(var a=t.length,n=0;n<a;++n)t.push(t[n].toUpperCase());return"*."+t.join(";*.")}return"accept"===e?"."+ja.join(",."):"mask"===e?ja.join("|"):""}function Ta(e,t,a){var n=void 0!==t.ind?t.ind:t,i=t.fileName?n+"_"+t.fileName:t;if(re("upload"+i+"_progress_wrap"),e().unchoose(i),!geByClass1("popup_box_container")){var s=Object(fa.getLang)("mail_add_doc_error");"wrong_music_file"===a?s=Object(fa.getLang)("mail_upload_music_fail"):"wrong_arch_file"===a||"wrong_arch_mp3_file"===a?s=Object(fa.getLang)("mail_upload_arch_fail"):"photo"===Upload.options[n].file_name?s=Object(fa.getLang)("mail_add_photo_error"):"video_file"===Upload.options[n].file_name&&(s=Object(fa.getLang)("video_upload_error")),setTimeout(Object(ct.showFastBox)({title:Object(fa.getLang)("global_error")},s).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+n)||{}).action}),Upload.embed(n)}function wa(e){var t=void 0!==e.ind?e.ind:e,a=(e.fileName||e.filename||"").replace(/[&<>"']/g,""),n=a?t+"_"+a:e,i=ge("upload"+n+"_progress_wrap");return i&&hide(geByClass1("progress_x",i)),n}function Ia(e,t){if(!e().canAddMedia())return"none";if(!t.items||!t.items.length)return"media";var a="^("+Sa("mask")+")";return[].slice.call(t.items).every(e=>{var t=e.type.split("/");return new RegExp(a,"i").test(t[1])})?"photo":[].slice.call(t.items).every(e=>"video"===e.type.split("/")[0]||~Ea.indexOf(e.type))?"video":"doc"}function Aa(e){var t=geByClass1("_im_upload_dropbox"),a=geByClass1("im-page--chat-header").getBoundingClientRect(),n=geByClass1("im-chat-input").getBoundingClientRect();(a.width<10||n.bottom-a.bottom<10)&&(e="none"),t.style.top=a.bottom+"px",t.style.left=a.left+1+"px",t.style.width=a.width-2+"px",t.style.height=n.bottom-a.bottom+"px",t.setAttribute("data-mode",e),"none"!==e&&t.classList.add("im-dropbox--visible")}function Ma(){geByClass1("_im_upload_dropbox").classList.remove("im-dropbox--visible")}function ka(e,t,a){return{loaded:t,total:a,fileName:e.fileName?e.fileName.replace(/[&<>"']/g,""):void 0}}function La(e,t,a,n){"string"==typeof t&&t.indexOf("TERMINATED")>-1||(t=JSON.parse(t),Upload.onUploadError(e,t.error)),n().reHeight(a)}function Pa(e,t,a,n,i){var s=t.get().upload_opts,r=geByClass1("_im_upload_photo",i),o=geByClass1("_im_drop_photo",i);return Upload.init(r,s.url,s.params,{accept:Sa("accept"),file_name:"photo",file_size_limit:26214400,file_types:Sa("types"),file_match:s.opts.ext_re,lang:s.opts.lang,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"photo",max_attempts:3,server:s.opts.server,error:s.opts.default_error,error_hash:s.opts.error_hash,dropbox:o,dragEl:bodyNode,onNoFilteredCallback(e){Upload.onFileApiSend(n,e)},onUploadStart(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete(e,n){var i=window.parseJSON(n);i.photos?function(e,t,a,n){var i=wa(e);ajax.post("al_photos.php",extend({act:"choose_uploaded"},t),{onDone:function(e,t){n().choose("photo",e,extend(t,{upload_ind:i}))},onFail:Ta.bind(null,n,e)})}(e,i,0,a):La(e,n,t,a)},onUploadProgress(e,t,n){var i=void 0!==e.ind?e.ind:e;a().progress("photo",i,ka(e,t,n))},onUploadError(e,t){statlogsValueEvent("upload_photo_fails",1,s.opts.server,t),Ta(a,e,t)},onDragEnter(e){var t=geByClass1("im-audio-message_recording");e.dataTransfer&&!t&&Aa(Ia(a,e.dataTransfer))},onDragOut(){Ma()},onDrop(){Ma()}})}function Na(e,t,a,n){var i=t.get().upload_doc_opts,s=geByClass1("_im_upload_doc",n),r=geByClass1("_im_drop_doc",n);return Upload.init(s,i.url,i.params,{file_name:"file",file_size_limit:1024*(parseInt(i.file_size_limit_in_MB)||2048)*1024,file_types:"*.*;",lang:i.opts.lang,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"doc",max_attempts:3,server:i.opts.server,error:i.opts.default_error,error_hash:i.opts.error_hash,dropbox:r,dragEl:bodyNode,onUploadStart(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete(e,n){var s=window.parseJSON(n);s.file?function(e,t,a,n){var i=wa(e),s={act:"a_save_doc",blockPersonal:1,from:"choose",mail_add:1};a.opts.imhash&&(s=extend(s,{from_place:"from_gim",imhash:a.opts.imhash})),ajax.post("docs.php",extend(s,t),{onDone:function(e,t,a){n().choose("doc",e+"_"+t,extend(a,{upload_ind:i}))},onFail:Ta.bind(null,n,e)})}(e,s,i,a):La(e,n,t,a)},onUploadProgress(e,t,n){var i=void 0!==e.ind?e.ind:e;a().progress("doc",i,ka(e,t,n))},onUploadError(e,t){statlogsValueEvent("upload_doc_fails",1,i.opts.server,t),Ta(a,e,t)}})}function Da(e,t,a){removeEvent(bodyNode,"dragover dragenter");var i=geByClass1("_im_upload_dropbox"),s=Na(0,t,a,i),r=function(e,t,a,i,s){var r=t.get().upload_video_params;if(r){var o=geByClass1("_im_upload_video",s),l=geByClass1("_im_drop_video",s);return r.options.visible_dropbox=!1,Object(ya.getUploadModule)(o,l,r,null,{onUploadStart:function(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete:function(e,i){var s=window.parseJSON(i);s.video_id?Object(ya.onVideoUploaded)(e,s,t.get().textMediaSelector,(e,a)=>{var i=document.querySelector('[data-video="'+a+'"]'),s=e.editable.sizes.x[0]||e.thumb;if(i&&s){i.style.backgroundImage=`url(${s})`;var r=gpeByClass("_im_mess",i);"im"===cur.module&&r&&Object(n.updateVideoThumb)(t,r)}}):La(e,i,t,a)},onUploadProgress:function(e,t,n){var i=void 0!==e.ind?e.ind:e;a().progress("video",i,ka(e,t,n))},onUploadError:function(e,t){statlogsValueEvent("upload_video_fails",1,r.options.server,t),Ta(a,e,t)},onNoFilteredCallback:function(e){Upload.onFileApiSend(i,e)},onDragEnter:function(e){var t=geByClass1("im-audio-message_recording");e.dataTransfer&&!t&&Aa(Ia(a,e.dataTransfer))},onDragOut:function(){Ma()},onDrop:function(){Ma()}})}}(0,t,a,s,i),o=Pa(0,t,a,r,i);cur.lang.attachments_limit=t.get().upload_opts.opts.lang.max_files_warning;var l=Object(c.createModule)({handlers:e=>{var t=ge("im_full_upload");e(t,"change",(function n(i){if(window.Upload&&i.target.files){if(a().canAddMedia()){var s=Array.from(i.target.files),d=s.filter(e=>Upload.checkFileType(e.name,Sa("types"))),u=s.filter(e=>Upload.checkFileType(e.name,Object(ya.getUploadVideoExtMasks)("types")));Upload.onFileApiSend(o,d),Upload.onFileApiSend(r,u)}else Object(ct.showFastBox)(Object(fa.getLang)("global_error"),Object(fa.getLang)("global_error"));Object(c.destroyModule)(l);var g=t.cloneNode();g.value="",t.parentNode.replaceChild(g,t),e(t=g,"change",n)}}))}});return{paste(e){Upload.onFileApiSend(o,e)},unmount(){Object(c.destroyModule)(l),Upload.deinit(o),Upload.deinit(r),Upload.deinit(s)}}}var xa=a("wSs/"),Ba=a("rjmT"),Ra=a("V1lx");function Fa(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Ha(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Ha(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ha(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function Ua(e,t){if(!e)return!1;window.tooltips&&tooltips.hide(e,t)}function Ga(e){return e.map(e=>({id:e[1],type:e[0],kind:e[2]||null}))}function qa(e,t,a,n,r,o){var l=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];if(On(t,n))return Promise.resolve(!1);var c=$a(n),d=Object(s.getTab)(n,t);c.getBoundAttach(a.message)&&(a.message=""),a.share_url=c.getShareUrl(),a.cancelled_shares=c.getCancelledShares();var u=Object(va.random)(),g={peerId:t,messageId:"rid"+u,flags:B.FLAG_OUTBOUND,date:intval(Date.now()/1e3)-n.get().timeshift,subject:"",text:Object(i.replaceSpecialSymbols)(clean(a.message)).replace(/\n/gi,"<br>"),local:!0,kludges:{emoji:!0,from_admin:n.get().gid?vk.id:null},type:B.ADD_MESSAGE,attaches:Ga(a.attaches),minorSortId:d.minor_sort_id};return a.rid=u,a.mess=g,e(t,a),n.get().longpoll.push([g]),l&&o().clearText(t,n),r().newMessage(n),Promise.resolve(!0)}function Wa(e,t,a,n,i,s,r){var o=arguments.length>7&&void 0!==arguments[7]&&arguments[7];o||(o=e.get().peer);var l=$a(e),c=Ka(l,r),d=c?l.dData.attaches.map(e=>[e.type,e.id]):[],u={message:"",attaches:[].concat(d,s)};r&&extend(u,r),Va(e,t,!1).then(()=>qa(a,o,u,e,t,n,!1).then(a=>(c&&cn(e,i,t),Promise.resolve(a)))).catch(t=>{debugLog(t),Xa(e,i)})}function Ka(e,t){var a=e.dData,n=t&&t.sticker_referrer,i=n&&0===n.indexOf("suggestion"),s=t&&t.is_hintach_item;return(!a.txt.trim()||i||s)&&0===a.attaches.filter(e=>"reply"!==e.type).length}function Va(e,t,a){return e.get().tabs[e.get().peer].skipped>0?(t().loadingPeer(e),e.setState({no_moving_down:!0}),e.set(n.changePeer.bind(null,e.get().peer,!1,!1)).then(()=>e.set(n.loadPeer.bind(null,e.get().peer,!0,-1,!1))).then(()=>(t().changePeer(e,!1),e.setState({no_moving_down:!1}),a))):Promise.resolve(a)}function Ya(e,t,a){var i=!!intval(domData(a,"val"));i!==cur.ctrl_submit&&(cur.ctrl_submit=i,e.set(n.changeSubmitSettings.bind(null,i)))}function za(e,t,a,i){return!e.get().delayed_ts&&setTimeout(()=>{e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>{a(...i)})},t)}function Qa(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(fa.getLang)("mail_send_error"),t=Object(fa.getLang)("global_error");Object(ct.showFastBox)({title:t},e,Object(fa.getLang)("mail_ok"),()=>{nav.reload({force:!0})})}function Xa(e,t){document.activeElement&&document.activeElement.blur(),Qa();var a=geByClass1("_im_send",t);return e.set(n.toggleSendingAbility.bind(null,!0)).then(()=>{Object(i.lockButton)(a)})}function $a(e){return e.get().tfdraft||new Ba.ImDraft}function Ja(e,t,a,r,o,c){var d=Object(s.getPeer)(e),u=Object(s.getCurrentKeyboard)(e)||{},g=u.one_time,m=void 0!==g&&g,_=geByClass1("_im_send",r);return Promise.resolve().then(()=>{if(Object(s.isSendingAvailable)(e)){if(Object(n.isAnythingLoading)(e.get())||!Object(i.isFullyLoadedTab)(e,e.get().peer)){var r=za(e,2e3,Ja,Object(l.toArray)(arguments));return e.set(n.setDelayedMessage.bind(null,!0,r)).then(()=>{Object(i.lockButton)(_)})}return clearTimeout(e.get().delayed_ts),e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>Object(i.unlockButton)(_)).then(Va.bind(null,e,t)).then(()=>{var n=c.keyboardAuthorId,s=c.action||{},r=s.attaches||[],l=Object($t.decodeHTMLEntities)(s.payload||""),u=Object($t.decodeHTMLEntities)(s.label||"");Object(i.isChatPeer)(d)&&(u=`@${Object(F.oCacheGet)(e,n).link.slice(1)} ${u}`);return Object(R.statlogsValueEvent)("message_send_from_keyboard",0,e.get().id,d,n),qa(a,d,{message:u,attaches:r,payload:l},e,t,o,!1)}).then(()=>m?e.set(n.deleteKeyboard.bind(null,d)):Promise.resolve()).then(()=>o().fixKeyboard())}}).catch(t=>{debugLog(t),Xa(e,r)})}function Za(e,t,a,r,o,c){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];return Promise.resolve().then(()=>{var g=geByClass1("_im_send",r);if(!Object(s.isSendingAvailable)(e))return!1;if(Object(n.isAnythingLoading)(e.get())||!Object(i.isFullyLoadedTab)(e,e.get().peer)){var m=za(e,2e3,Za,Object(l.toArray)(arguments));return e.set(n.setDelayedMessage.bind(null,!0,m)).then(()=>{Object(i.lockButton)(g)})}clearTimeout(e.get().delayed_ts),o().saveText(e);var _=!1,p=$a(e),h=p.dData.attaches.map(e=>{if("poll"==e.type){var t=c.pollData();return t||(_=!0),[e.type,e.id,t]}return[e.type,e.id]}).concat(u);if(_)return!1;var b=e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>{Object(i.unlockButton)(g)}),v=Object(s.getPeer)(e);return b.then(()=>{var n=p.dData.txt,s=t().getEditingMessage();if(s||n||h.length){if(s)return n||h.length&&!p.hasOnlyReplies(s)?Object(i.isMessageTooLong)(n)?void Object(ct.showFastBox)(Object(fa.getLang)("global_error"),Object(fa.getLang)("mail_err_edit_too_long")):(t().cancelEditing(),void(Object(xa.wasMessageReallyModified)(e,s,p)&&(Object(xa.replaceMsgAfterEdit)(e,s,n,h,p.getShareUrl(),p.getCancelledShares()),t().sendEditMessage(e,s),e.get().longpoll.push([Object(d.editMessageLocallyEvent)(s)])))):void en(e,t,r,s.messageId);var l=Object(i.splitMessageToParts)(n,h).map(n=>qa(a,v,{message:n.msgText||"",attaches:n.attaches||[]},e,t,o));return Promise.all(l)}}).then(Va.bind(null,e,t))}).catch(t=>{debugLog(t),Xa(e,r)})}function en(e,t,a,i){var s=e.get(),r=s.peer,o=Object(ct.showFastBox)({title:Object(fa.getLang)("mail_dialog_msg_delete_title"),dark:1},Object(fa.getLang)("mail_dialog_msg_delete_for_all"),Object(fa.getLang)("mail_delete"),(function(e){Object(n.removeMessageSend)([i],r,null,"deleteforall",s),o.hide(),t().cancelEditing()}),Object(fa.getLang)("global_cancel"),(function(){o.hide(),rn(geByClass1("_im_text",a))}))}function tn(e,t,a){return e.set(n.deliverMessage.bind(null,t,a,{}))}function an(e,t,a,n){e.get().longpoll.push([Object(d.failedMessage)(t,a.mess,n)])}function nn(e,t,a,r,o,l,c,d,u){var g,m=Object(Ca.debounce)(Cn.bind(null,e,a),500);var _=Emoji.init(geByClass1("_im_text",t),{ttDiff:93,rPointer:!0,ref:"im",onSend:()=>Tn(e,t).then(e=>e&&r([])),controlsCont:t,forceTxt:!e.get().editable,checkEditable:function(a,r){var o=e.get().peer,l=Emoji.val(r);Object(i.isReservedPeer)(o)||On(o,e)||$a(e).dData.txt==l||!l||function(e){var t=e.get().peer;Object(i.isFullyLoadedTab)(e,t)&&!Object(s.isAnyMessageBeingEdited)(e)&&Date.now()-(Object(s.getTab)(e,t).lastTyping||0)>1e3*n.ACTIVITY_PERIOD&&e.set(n.sendTyping.bind(null,t))}(e),wn(e,t,l),An(e,t,l),m(r);var c=t.offsetHeight;if(g&&g!==c){var u=d().updateScroll();d().scrollFix(e,e.get().peer,u)}g=c},onStickerSend:(e,t,a)=>o([["sticker",e,a]],{sticker_referrer:t}),onHintachSend:(e,t)=>l([[e,t]],{is_hintach_item:!0}),uploadActions:c,suggestionsConfig:e.get().suggestionsConfig,clearText:function(){u().clearText(e.get().peer,e)}});return Emoji.emojiLoadMore(_),e.setState({emojiOptId:_}),_}function sn(e,t,a){var n=Emoji.val(geByClass1("_im_text",t));Object(s.isAnyMessageBeingEdited)(e)&&""!==n||Tn(e,t).then(t=>{var i=intval(domData(a.target,"tttype"));(2===i&&!0!==t||1===i&&!0===t||3!==i&&""===n)&&window.tooltips&&tooltips.destroy(a.target,{fasthide:!0});var r=$a(e).dData.attaches.length>0;if(Object(s.isAnyMessageBeingEdited)(e)&&""===n&&!r)return domData(a.target,"tttype",3),Object(U.showTooltip)(a.target,{text:Object(fa.getLang)("mail_delete_for_all"),black:!0,force:3!==i,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});if(!0!==t)return domData(a.target,"tttype",1),Object(U.showTooltip)(a.target,{text:Object(fa.getLang)("mail_added_audiomsg"),black:!0,force:1!==i,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});domData(a.target,"tttype",2);var o=e.get().ctrl_submit?1:0;return Object(U.showTooltip)(a.target,{text:getTemplate("ctrl_submit_hint",{enter_on:o?"":"on",ctrl_on:o?"on":""}),dir:"down",shift:[-28,-5],needLeft:!0,className:"im-chat-input--tt",hasover:!0,force:2!==i,showdt:700,zIndex:200,hidedt:700,appendParentCls:"_im_chat_input_parent",onCreate(){radioBtns.im_submit={els:Object(l.toArray)(geByClass("_im_submit_btn")),val:o}}})})}function rn(e){Emoji.focus(e,!0),setTimeout(Emoji.correctCaret.pbind(e),10)}function on(e,t,a,n){var o=e.getFwdRaw(),l=t.querySelector("._im_media_fwd"),c=t.parentNode.querySelector("._im_replied_content");if(!(Object(s.getCurrentKeyboard)(n)||{}).hide&&o&&a.toggleKeyboard(!0),l.innerHTML="",c.innerHTML="",o){var d=function(e,t){if(e.get().isEditing){var a=Object(i.getNowEditingMessage)(e);return a&&Object(r.hasReply)(a)}return"reply"===t.type}(n,o),u=d?c:l,g=o.object;u.innerHTML=d?ln(g):function(e,t,a,n){if(a.object&&a.object.authorName){var s=Object(i.renderShortText)(0,"",n.text,!0,Object(q.convertKludgesToAttaches)(n.kludges,0));return getTemplate("im_attach_mess",{messages:s,text:n.authorName,date:getSmDate(n.date,e.get().timeshift),modifier:"im-fwd_msg"})}return getTemplate("im_attach_mess",{messages:Object(fa.getLang)("mail_title_X_msgs",t.getFwdCount()),text:Object(fa.getLang)("mail_im_fwd_msgs_title"),date:"",modifier:""})}(n,e,o,g)}}function ln(e){var t=Object(i.renderShortText)(0,"",e.text,!0,Object(q.convertKludgesToAttaches)(e.kludges,0));return getTemplate("im_replied_message",{authorName:e.authorName,text:t})}function cn(e,t,a){return e.set(n.forwardMessages.bind(null,null,$a(e),!1)).then(()=>{var n=t.querySelector("._im_media_fwd"),i=t.parentNode.querySelector("._im_replied_content"),s=document.querySelector("._im_chat_audio_input_parent ._im_replied_content");i&&i.children.length&&(i.innerHTML="",gn(e,a)),s&&s.children.length&&(s.innerHTML="",gn(e,a)),n&&n.children.length&&(n.innerHTML="",gn(e,a)),wn(e,t)})}function dn(e,t,a){var i=Object(s.getPeer)(e);e.set(n.acceptMessageRequest.bind(null,i)).then(()=>{Sn(e,i,t),a()}).catch(()=>Qa())}function un(e,t,a){var r=Object(s.getPeer)(e);e.set(n.rejectMessageRequest.bind(null,r)).then(()=>{Object(i.isClassicInterface)(e)&&t(e),a(e,r),r===e.get().peer&&e.get().longpoll.push([Object(d.resetPeer)()])}).catch(()=>Qa())}function gn(e,t){var a=t().updateScroll();t().scrollFix(e,e.get().peer,a)}function mn(e,t,a,i){var s=e.get().peer,r=inArray(s,e.get().mutedPeers);e.set(n.toggleMutePeer.bind(null,s,!r,-1)).then(a().updateState.bind(null,s)),cancelEvent(i)}function _n(e,t,a,i){var s=e.get().peer;e.set(n.returnToChat.bind(null,s)).then(e=>e.set(n.getPinnedMessage.bind(null,s))).then(a().updateChatTopic.bind(null,s)),cancelEvent(i)}function pn(e,t,a,n,r,o,l,c){if("close"!==l&&"open"!==l&&"hide"!==l)throw new Error(`Action "${l}" not found`);var d=e.get(),u=Object(s.getCurrentKeyboard)(e);(Object(i.isCommunityInterface)(e)||!u||d.isEditing)&&(l="hide");var g="close"===l||"hide"===l,m=Promise.resolve();g||a.isMounted||(m=a.init());var _=!u&&"open"!==l;return m.then(()=>(toggleClass(t,"im-chat-input_open-keyboard",!g),toggleClass(t,"im-chat-input_close-keyboard",g&&"hide"!==l),toggleClass(n,"im_chat-input--keyboard-button_hidden","hide"===l),a.toggle(d.peer,g,o))).then(()=>{if(!_||c){var t=r().updateScroll();return r().scrollFix(e,d.peer,t)}})}function hn(e,t){if(Object(s.isAnyMessageBeingEdited)(e))return!1;var a=e.get();if(Object(i.isCommunityInterface)(e))return!1;if(!Object(s.getCurrentTab)(e).moneyTransferAvail)return!1;if(Object(i.isCommunityPeer)(t))return a.moneyTransferCommAvail;if(Object(i.isUserPeer)(t)){var n=inArray(t,a.moneyTransferExcept);return t!=vk.id&&!n&&!Object(i.isContactPeer)(t)}return!1}function bn(e,t){return!Object(s.isAnyMessageBeingEdited)(e)&&(!!e.get().moneyRequestAvail&&(!!Object(s.getCurrentTab)(e).moneyRequestAvail&&(!(!Object(i.isCommunityPeer)(t)&&!Object(i.isChatPeer)(t))||!!Object(i.isUserPeer)(t)&&(t!=vk.id&&!Object(i.isContactPeer)(t)))))}function vn(e,t,a,n,r,o,l,d,u,g,m,_,p,h,b,v){return{restoreKeyboard(){this.toggleKeyboard(!!(ls.get("is_keyboards_hide")||{})[Object(s.getPeer)(e)])},toggleKeyboard(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!Object(s.getCurrentKeyboard)(e).hide,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return pn(e,n,_,m,o,a,t?"close":"open")},initKeyboard(){if(!e.get().peer||!Object(s.getCurrentKeyboard)(e))return Promise.resolve();var t=!!(ls.get("is_keyboards_hide")||{})[Object(s.getPeer)(e)];return pn(e,n,_,m,o,!0,t?"close":"open")},fixKeyboard(){var t,a=Object(s.getCurrentKeyboard)(e);return t=a?a.hide?"close":"open":"hide",pn(e,n,_,m,o,!0,t,!0)},hideKeyboard:()=>pn(e,n,_,m,o,!1,"hide"),restoreDraft(e,r,l){t.chosenMedias.length>0&&(e.setState({removingMedias:!0}),t.unchooseMedia(),t.chosenMedias=[],e.setState({removingMedias:!1}));var c=e.get().peer,d={gift:Object(i.isGiftOptionAvailableForPeer)(e,c)&&!Object(s.isAnyMessageBeingEdited)(e),money:Object(i.isMoneyOptionAvailableForPeer)(e,c)&&!Object(s.isAnyMessageBeingEdited)(e),poll:Object(i.isChatPeer)(c)},u=geByClass1("ms_items_more",n);Object.entries(d).forEach(e=>{var t=Fa(e,2),a=t[0],n=t[1],i=geByClass1("ms_item_"+a,u);toggleClass(i,"ms_item--hidden",!n)});var g={im:!0,fromId:-Object(s.getGroupId)(e)||vk.id,peer:c,moneyTransfer:{request:bn(e,c),send:hn(e,c)}},m=e.get().emojiOptId;if(void 0===m?e.setState({suggestionsConfig:g}):Emoji.setSuggestionsConfig(m,g),Object(i.isReservedPeer)(c))return Promise.resolve();var _=$a(e);return Emoji.val(a)!==_.dData.txt?(!function(e,t){Emoji.val(e,clean(t)),rn(e)}(a,_.dData.txt),An(e,n,_.dData.txt)):rn(a),_.prepareObjects(e.get().gid,r&&r.messageId).then(()=>{if(!Sn(e,c,a)&&c==e.get().peer){for(var i=_.dData.attaches,s=0;s<i.length;s++)t.chooseMedia(i[s].type,i[s].id,i[s].object||{});if(on(_,n,this,e),l){var r=o().updateScroll();o().scrollFix(e,c,r)}wn(e,n,_.dData.txt)}})},sendMessage(){r([])},sendMessageFromKeyboard(){for(var t=arguments.length,a=new Array(t),i=0;i<t;i++)a[i]=arguments[i];return Ja.call(null,e,o,h,n,...a)},choose(e,a,n){t.chooseMedia(e,a,n)},updateChosenMedia(e,a,n){t.updateChosenMedia(e,a,n)},canAddMedia:()=>!t.hasRestrictingAttach()&&!On(e.get().peer,e),isEmpty:e=>!trim(Emoji.val(a))&&!$a(e).hasAttaches(),unchoose(e){t.unchooseMedia(e)},attachCount:()=>t.attachCount(),progress(e,a,n){t.showMediaProgress(e,a,n)},updateState(e){this.restoreKeyboard(),Sn(e,e.get().peer,a)},focusOn(e){Emoji.editableFocus(a,!1,!0)},setDraft(e,t){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=Object(s.getTab)(e,e.get().peer);Object(H.doesChatTabHaveFlag)(n,1024)&&!e.get().gid||(p&&p.update(),e.setState({tfdraft:t}),t&&this.restoreDraft(e,o().getEditingMessage(),a))},clearText(e,i){$a(i).clear(),t.cancelCheckUrl(),t.unchooseMedia(),t.chosenMedias=[],Emoji.val(a,""),cn(i,n,o);var s=o().updateScroll();o().scrollFix(i,i.get().peer,s)},attachMessages(e,t){if(e.get().peer===t){on($a(e),n,this,e);var a=o().updateScroll();o().scrollFix(e,t,a),wn(e,n)}},detachMessages(t){var a=$a(e).getFwdRaw();if(a&&!!a.id.split(";").find(e=>Math.abs(e)===t.messageId))return cn(e,n,o).then(()=>{var t=o().updateScroll();o().scrollFix(e,e.get().peer,t)});return Promise.resolve()},cancelRecording(){g.cancelRecording()},reHeight(e){var t=o().updateScroll();o().scrollFix(e,e.get().peer,t)},isBlocked:()=>On(e.get().peer,e),toggleStickers(e,t){Emoji.toggleStickers(e.get().emojiOptId,!t)},saveText(e){$a(e).setText(Emoji.val(geByClass1("_im_text",n)))},resendAll(){b()},resendPeer(){v(e.get().peer)},unmount(){Object(c.destroyModule)(u),t.destroy(),d.unmount(),_.unmount(),p&&p.unmount(),Emoji.destroy(e.get().emojiOptId),g.unmount()}}}function fn(e,t){return!!Object(i.isChatPeer)(e)&&t.get().tabs[e].data.kicked}function On(e,t){return fn(e,t)||Object(s.getTab)(t,e)&&Object(s.getTab)(t,e).block_error>0||Object(i.isLocksAvailable)(t)&&Object(i.isPeerBlocked)(e,t)}function Cn(e,t,a){var n=e.get().peer,s=Emoji.val(a);Object(i.isReservedPeer)(n)||$a(e).dData.txt==s||On(n,e)||(t.checkMessageURLs(s,!0,2e3),$a(e).setText(s))}function yn(e){var t=$a(e).getFwdRaw();t&&window.showForwardBox({act:"a_show_forward_box",will_fwd:t.id,gid:e.get().gid})}function jn(e,t){e.disabled=!0,e.contentEditable="false",addClass(e,"im-chat-input--text_disabled"),addClass(t,"im-chat-input_error"),addClass(geByClass1("_im_page_history"),"is_tf_blocked")}function En(e,t){e.disabled=!1,e.contentEditable="true",removeClass(e,"im-chat-input--text_disabled"),removeClass(t,"im-chat-input_error"),removeClass(geByClass1("_im_page_history"),"is_tf_blocked")}function Sn(e,t,a){var n=gpeByClass("_im_chat_input_parent",a),r=geByClass1("_im_chat_input_error",n),o=Object(s.getTab)(e,t);if(On(t,e)){jn(a,n);var l=function(e,t,a){switch(a.block_error){case 7:case 5:return Object(fa.getLang)("mail_peer_deleted");case 14:return Object(fa.getLang)("mail_community_deleted");case 11:return Object(fa.getLang)("mail_group_banned_messages");case 28:return Object(fa.getLang)("mail_cant_send_messages_by_time");case 29:return Object(fa.getLang)("mail_cant_send_messages_by_web_bot");case 4:case 6:case 9:case 19:case 20:case 13:return Object(i.isCommunityPeer)(t)?Object(fa.getLang)("mail_send_privacy_community_error"):Object(fa.getLang)("mail_send_privacy_error");case 23:var n=Object(F.oCacheGet)(e,t);return langSex(n.sex,Object(fa.getLang)("mail_blacklist_user","raw")).replace("{user}",n.kick_name);case 12:return Object(fa.getLang)("mail_cant_send_messages_to_community");case 16:return Object(fa.getLang)("mail_chat_youre_kicked");case 26:return Object(fa.getLang)("mail_chats_is_disabled");case 0:if(fn(t,e))return Object(fa.getLang)("mail_chat_youre_kicked");var s=e.get().block_states[t].name;return Object(fa.getLang)("mail_community_answering").replace("{username}",s);default:return Object(fa.getLang)("mail_send_privacy_error")}}(e,t,o);if(Object(s.isChannelPeer)(o)&&addClass(geByClass1("_im_page_history"),"is_channel"),Object(i.isFvkcomgroup)(e,t)&&!e.get().gid){addClass(n,"is-f-vkcomgroup");var c=inArray(t,e.get().mutedPeers);l=Object(s.isChatActive)(o)?getTemplate("sImPeerMuteUnmute",{text:c?Object(fa.getLang)("mail_im_unmute"):Object(fa.getLang)("mail_im_mute"),type:c?"unmute":"mute"}):getTemplate("sImPeerReturnToChat",{text:Object(fa.getLang)("mail_return_to_vkcomgroup")})}else removeClass(n,"is-f-vkcomgroup");return val(r,l),!0}return o&&Object(i.tabIsMessageRequest)(o)&&!Object(i.tabIsRejectedMessageRequest)(o)?(jn(a,n),addClass(n,"is-message_request"),val(r,getTemplate("sImPeerAcceptOrRejectMessageRequest",{cls_accept:"_mr_button_accept",cls_reject:"_mr_button_reject"})),!0):(n.classList.contains("is-message_request")&&(En(a,n),removeClass(n,"is-message_request"),val(r,"")),a.disabled&&(removeClass(n,"is-f-vkcomgroup"),removeClass(geByClass1("_im_page_history"),"is_channel"),En(a,n),removeClass(n,"is-message_request"),val(r,"")),!1)}function Tn(e,t,a){return Object(i.isVoiceMessageAvailable)(e).then(n=>{if(!n&&!Object(s.isAnyMessageBeingEdited)(e))return!0;var r=null!=a?a:Emoji.val(geByClass1("_im_text",t));if(trim(r))return!Object(s.isAnyMessageBeingEdited)(e)||!Object(i.isMessageTooLong)(r);var o=$a(e),l=Object(i.getNowEditingMessage)(e);return o.hasAttaches()&&!o.hasOnlyReplies(l)})}function wn(e,t,a){var n=geByClass1("_im_send",t.parentNode);Ua(n,{fasthide:!0}),Tn(e,t,a).then(t=>{if(Object(s.isAnyMessageBeingEdited)(e))toggleClass(n,"is_input_empty",!t),attr(n,"aria-label",Object(fa.getLang)("mail_im_edit"));else{toggleClass(n,"im-send-btn_audio",!t),toggleClass(n,"im-send-btn_send",t),t&&removeClass(n,"im-send-btn_saudio");var a=t?Object(fa.getLang)("mail_send2"):Object(fa.getLang)("mail_added_audiomsg");attr(n,"aria-label",a)}})}function In(e){var t=geByClass1("MassMentionWarning",e);t.classList.contains("MassMentionWarning--hidden")||t.classList.add("MassMentionWarning--hidden")}function An(e,t,a){var n=Object(s.getCurrentTab)(e);if(n){if(!Object(i.isChatPeer)(n.peerId)||Object(s.isChannelPeer)(n))return In(t);var r=(a.match(it.MASS_MENTION_REGEXP)||[]).map(e=>e.slice(1));if(0===r.length)return In(t),void e.set(e=>(n.dontReopenWarningForCurrentMassMention=!1,Promise.resolve(e)));var o=geByClass1("MassMentionWarning",t),l=geByClass1("MassMentionWarning__title",o),c=geByClass1("MassMentionWarning__text",o),d=(e,t)=>{n.dontReopenWarningForCurrentMassMention||(l.innerHTML!==e&&(l.innerHTML=e),c.innerHTML!==t&&(c.innerHTML=t),o.classList.remove("MassMentionWarning--hidden"))},u=it.MASS_MENTION_ALIASES.all.some(e=>r.includes(e)),g=it.MASS_MENTION_ALIASES.online.some(e=>r.includes(e));switch(!0){case u&&n.membersCount>=11:return d(Object(fa.getLang)("mail_im_mass_mention_warning_title"),Object(fa.getLang)("mail_im_mass_mention_warning_many_people_mentioned_text",n.membersCount-1));case g&&n.membersCount>=30:return d(Object(fa.getLang)("mail_im_mass_mention_warning_title"),Object(fa.getLang)("mail_im_mass_mention_warning_maybe_many_people_mentioned_text"));default:return In(t)}}}function Mn(e,t,a,r,o){cur.share_timehash=t.get().share_timehash;var l=Object(c.createMutations)(vn),u=l.callMutations,g=l.bindMutations,m=Da(0,t,u),_=tn.bind(null,t);ls.remove("im_send_queue_2"+vk.id),ls.remove("im_send_queue_1"+vk.id);var p=ba(_,an.bind(null,t),{store:!0,key:"im_send_queue_"+vk.id,waitCommit:!0}),h=p.pushMessage,b=p.inspectQueue,v=p.resend,f=p.resendAll,O=p.resendPeer,C=p.setErrored,y=p.complete,j=Wa.bind(null,t,o,h,u,e),E=Wa.bind(null,t,o,h,u,e),S=yn.bind(null,t);hide(geByClass1("ms_items_more_helper",e));var T=t.get().mediaTypes||[["photo",Object(fa.getLang)("mail_added_photo")],["video",Object(fa.getLang)("profile_wall_video")],["audio",Object(fa.getLang)("profile_wall_audio")],["doc",Object(fa.getLang)("profile_wall_doc")],["map",Object(fa.getLang)("profile_wall_map")],["gift",Object(fa.getLang)("profile_wall_gift")]];(t.get().moneyTransferAvail||t.get().moneyRequestAvail)&&T.push(["money",Object(fa.getLang)("profile_wall_money")]);var w=new MediaSelector(geByClass1("_im_media_selector",e),"_im_media_preview",T,{from:"message",maxShown:0,vectorIcon:!0,ignoreMobile:!0,onAddMediaChange:function(a,i,s,r){return a&&u().toggleKeyboard(!0),function(e,t,a,i,s,r,o,l,c){if(!t.get().removingMedias){if("album"===s||"page"===s||"mail"===s||"reply"===s)return!1;if("share"===s&&!o.title)return!1;var d,u;r&&"string"==typeof s?(l&&$a(t).addBindUrl(l,s,r),$a(t).addAttach(s,r,o)):($a(t).syncWithSelector(c),"number"==typeof r&&c.chosenMedias[r]&&(d=c.chosenMedias[r],u=$a(t),("string"==typeof d[0]&&"string"==typeof d[1]&&d[1]||"string"==typeof d[0]&&"group"===d[0])&&u.dData.cancelled.push(`${d[0]},${d[1]}`)));var g=e().updateScroll();if(e().scrollFix(t,t.get().peer,g),t.get().delayed_message&&!Object(n.isAnythingLoading)(t.get()))return a([]),!1;wn(t,i)}}(o,t,I,e,a,i,s,r,w)},onMediaChange:function(){return function(e,t,a,n,i){if(!t.get().removingMedias){var s=i.getMedias().find(e=>"poll"===e[0]);s&&$a(t).addAttach(s[0],s[1],i.pollData(!0,!0)),wn(t,n)}}(0,t,0,e,w)},editable:1,onChangedSize:function(){var a,n,i=o().updateScroll();o().scrollFix(t,t.get().peer,i),a=e,n=ge("_im_media_preview").offsetHeight,toggleClass(a,"im-chat-input--overflowed",n>400)},sortable:1,teWidth:150,mail:1,teHeight:100,forceToUp:!0,toId:t.get().gid?-t.get().gid:void 0,blockPersonal:t.get().gid?1:0,docParams:t.get().gid?{imhash:t.get().upload_doc_opts.opts.imhash,from:"from_gim"}:{}}),I=Za.bind(null,t,o,h,e,u,w),A=sn.bind(null,t,e),M=geByClass1("_im_send",e),k=Wa.bind(null,t,o,h,u,e),L=kt(e,t,k,()=>{addClass(M,"im-send-btn_audio"),removeClass(M,"im-send-btn_static")},()=>{u().restoreKeyboard()});!function(e,t){var a=geByClass1("_im_text",e),n=Object(sa.promisify)(stManager.add);(window.Wall?Promise.resolve():n(["page.js"])).then((function(){Wall.initComposer(a,{lang:{introText:Object(fa.getLang)("profile_mention_start_typing"),noResult:Object(fa.getLang)("profile_mention_not_found")},toup:!0,getValue:()=>t.get().peer>2e9?(window.Emoji&&Emoji.editableVal||val)(a):"",onShow:()=>{addClass(e,"im_mention_shown");var t=data(a,"composer");if(t&&t.wdd&&t.wdd.shown){var n=0,i=!1,s=function(){t.ignoredTerm=t.curTerm,t.curTerm=!1,val(t.wddInput,""),Composer.toggleSelectList(t)};each(t.wdd.shown,(function(){this[0]&&(n++,"@"+t.curTerm==this[2]&&(i=!0))})),!n||i&&1==n?s():cancelStackPush("im_mention",s)}},onHide:()=>{removeClass(e,"im_mention_shown"),cancelStackFilter("im_mention")},searchKeys:[1,7,9],wddOpts:{}})}))}(e,t),t.get().textMediaSelector=w,t.set(n.initTextStore.bind(null,b,v,C,y));var P=geByClass1("_im_text",e);setTimeout(()=>{Object(s.getPeer)(t)&&u().setDraft(t,Object(s.getTabDraft)(Object(s.getCurrentTab)(t))),nn(t,e,w,I,j,E,m,o,u)},0);var N=cn.bind(null,t,e,o),D=dn.bind(null,t,P,()=>{var e=o().updateScroll();o().scrollFix(t,Object(s.getPeer)(t),e)}),x=un.bind(null,t,a,r),B=mn.bind(null,t,e,o),R=_n.bind(null,t,e,o),F=Ya.bind(null,t);Sn(t,t.get().peer,P);var H=e.querySelector("._im_keyboard_button"),G=function(e,t,a,n,i){return(0,Object(c.createMutations)(Qt).bindMutations)(Object(c.createModule)({handlers:(e,t)=>{}}),t,n)}(0,t,0,Ja.bind(null,t,o,h,e,u)),q=Object(i.isCommunityInterface)(t)?function(e,t,a,n){var i=(0,Object(c.createMutations)(ia).bindMutations)(Object(c.createModule)({handlers:function(){}}),e,t,a,n);if("function"!=typeof i){i.toggleImText();var s=Lt.createElement(Bt.default,{value:e},Lt.createElement(Jt,{getTemplates:i.getPreparedTemplates,applyTemplate:i.applyTemplate.bind(i),isNeededRendering:i.isNeedRenderTemplates,showSettingsPopup:i.showSettingsPopup.bind(i,ta),showCreatingTemplatePopup:i.showSettingsPopup.bind(i,aa)}));Nt.render(s,t)}return i}(t,e.querySelector("._message_templates_container"),e=>Object(Ra.setHTML)(P,e),t=>toggleClass(e,"im-chat-input--textarea_show-templates",t)):null,W=Object(c.createModule)({handlers:(a,i)=>{a(M,"click",()=>{In(e),Promise.resolve().then(()=>Tn(t,e)).then(e=>{if(e||Object(s.isAnyMessageBeingEdited)(t))I([]);else{var a=$a(t);Ka(a)&&function(e){var t=document.querySelector("._im_chat_audio_input_parent ._im_replied_content"),a=e.getFwdRaw();if(a){var n=a.object;t&&(t.innerHTML=ln(n))}else t.innerHTML=""}(a),Ua(M,{fasthide:!0}),L.start(),setTimeout(()=>removeClass(M,"im-send-btn_saudio"),300)}})}),a(M,"mouseover",A),a(P,"focus",()=>{t.get().longpoll.push([Object(d.transitionEvent)("message")]),cur.focused=t.get().peer}),a(P,"blur",()=>{var e=0===t.get().peer?"search":"default";t.get().longpoll.push([Object(d.transitionEvent)(e)]),cur.focused=!1}),a(H,"click",()=>u().toggleKeyboard(void 0)),a(H,"mouseover",()=>{Object(U.showTooltip)(H,{text(){var e=Object(s.getCurrentKeyboard)(t);return!e||e.hide?Object(fa.getLang)("mail_show_keyboard"):Object(fa.getLang)("mail_hide_keyboard")},black:!0,shift:[4,5]})}),a(geByClass1("MassMentionWarning__close"),"click",()=>{!function(e,t){In(t),e.set(e=>(Object(s.getCurrentTab)(e).dontReopenWarningForCurrentMassMention=!0,Promise.resolve(e)))}(t,e),rn(P)}),i(e.parentNode,"click","_im_peer_mute_unmute",B),i(e.parentNode,"click","_im_peer_return_to_chat",R),i(e.parentNode,"click","_im_remove_replied",N),i(e.parentNode,"click","_mr_button_accept",D),i(e.parentNode,"click","_mr_button_reject",x),i(e,"click","_im_fwd_close",N),i(e,"click","_im_will_fwd",S),i(e,"keydown","_im_text",e=>function(e,t,a,i){if(38===i.which&&a().isEmpty(e)&&!t().getEditingMessage()&&!Emoji.shown&&!Object(Oa.hasAccessibilityMode)()&&!Object(n.isAnythingLoading)(e.get())){var r=Object(xa.findLastMessageToEdit)(e,Object(s.getCurrentTab)(e));r&&t().startEditing(Object(s.getMessage)(e,e.get().peer,r))}}(t,o,u,e)),i(bodyNode,"click","_im_submit_btn",F)}}),K=g(t,w,P,e,I,o,b,m,W,L,H,G,q,h,f,O);return K.initKeyboard(),K}function kn(e,t,a,n,i,s){return{focus(e){uiSearch.focus(t),function(e,t,a,n){cancelStackPush("im_hist_search",xn.bind(null,e,t,a,n))}(e,t,a,n)},changePeer(e,a){uiSearch.getFieldEl(t).value=a.get().tabs[e].searchText||""},search(){s({})},unmount(){Object(c.destroyModule)(i),cancelStackFilter("im_hist_search"),n.then(e=>e.destroy())}}}function Ln(e,t,a,i){e.set(n.setCurrentSearchDate.bind(null,e.get().peer,`${i.d}.${i.m}.${i.y}`)).then(Nn.bind(null,e,t,a))}function Pn(e,t){e.then(e=>{triggerEvent(geByClass1("datepicker_control",t),"mousedown",!1,!0)})}function Nn(e,t,a){var i=e.get().peer;uiSearch.showProgress(a),Object(n.searchMessagesInplace)(i,e.get()).then(n=>{uiSearch.hideProgress(a),t().insertSearch(n,e)}).catch(()=>{uiSearch.focus(a),uiSearch.hideProgress(a)})}function Dn(e,t,a,i,s,r){if("keyup"!==r.type||13==r.which){var o=clean(uiSearch.getFieldEl(t).value);e.set(n.setCurrentSearch.bind(null,o,e.get().peer)).then(s.bind(null,e,i,t))}}function xn(e,t,a,i){cancelStackFilter("im_hist_search"),i.then(e=>{e.hide()}),e.set(n.cancelSearch.bind(null,e.get().peer)).then(()=>{uiSearch.getFieldEl(t).value="",a().cancelSearch(e)})}function Bn(e,t,a,i){a.then(e=>{e.hide()}),e.set(n.clearDate.bind(null,e.get().peer)).then(Nn.bind(null,e,t,i))}function Rn(e,t,a){var n=geByClass1("_im_search_date_input",e),i=geByClass1("_im_search_history_input",e),s=function(e,t,a,n){var i='<td class="cal_clear" colspan="7"><button type="button" class="im_cal_clear_lnk _im_clear_date">'+getLang("wall_clear_date_filter")+"</button></td>";return new Promise(e=>{stManager.add(["ui_controls.js",window.jsc("web/datepicker.js"),"datepicker.css"],(function(){var t=new Datepicker(a,{width:140,resfmt:"plain",addRows:'<tr id="im_day_clear">'+i+"</tr>",addRowsM:'<tr id="im_month_clear">'+i+"</tr>",onUpdate:n,pastActive:!0,noFuture:!0});e(t)}))})}(0,0,n,Ln.bind(null,t,a,i)),r=Pn.bind(null,s,e),o=Dn.bind(null,t,i,n,a,Object(Ca.debounce)(Nn,300)),l=xn.bind(null,t,i,a,s),d=Bn.bind(null,t,a,s,i),u=Object(c.createModule)({handlers:(t,a)=>{t(geByClass1("_im_search_date",e),"click",r),t(uiSearch.getFieldEl(i),"keyup",o),t(geByClass1("_im_start_inplace_search",e),"click",o),t(geByClass1("_im_cancel_inplace_search",e),"click",l),a(e,"click","_im_clear_date",d)}});return kn(0,i,a,s,u,o)}var Fn=a("t7TG");function Hn(e,t,a,n,s){var r=Object(i.getHistoryTopIndent)(e);Object(U.showTooltip)(t,{shift:[a,10],black:1,className:"_im_history_tooltip "+n,appendParentCls:"_im_mess_stack",toup:t.getBoundingClientRect().top>r+37,text:s})}function Un(e,t,a){var i=gpeByClass("_im_mess",a),o=intval(domData(i,"msgid")),l=e.get().peer,c=Object(s.getMessage)(e,l,o),d=!Object(r.isImportant)(c);return e.get().longpoll.push([{peerId:l,messageId:o,type:d?B.SET_FLAGS:B.RESET_FLAGS,flags:B.FLAG_IMPORTANT}]),e.set(n.favMessage.bind(null,[o],d,l)),Gn(e,-10,t,a,!0),!1}function Gn(e,t,a,n,i){var o=domData(gpeByClass("_im_mess",n),"msgid"),l=Object(s.getMessage)(e,e.get().peer,o),c=getLang("mail_im_unmark_important"),d=getLang("mail_im_toggle_important"),u=Object(r.isImportant)(l)?c:d,g=u.length>16;i&&window.tooltips&&tooltips.destroy(n),Hn(e,n,g?84:34,g?"im-star-tt_long":"im-star-tt",l?u:"")}function qn(e,t,a,s){var r=e.get().peer,o=+domData(domClosest("im-mess",s.target),"msgid");if(Object(i.canForwardMessages)(e,[o]))return Object(nt.statlogsForwardFromChannel)(),Object(n.processFwd)([o],r,e).then(t=>e.set(n.prepareForward.bind(null,t))).then(()=>{Object(Fn.mount)(a,e)}),!1}function Wn(e,t,a){var i=e.get().peer,s=+domData(domClosest("im-mess",a.target),"msgid");return Object(n.processFwd)([s],i,e).then(t=>e.set(n.forwardMessages.bind(null,t,e.get().tfdraft,!0))).then(()=>t().respond(e,i)),!1}function Kn(e,t,a,n){Hn(e,n,18,"im-reply-tt",getLang("mail_im_mark_forward"))}function Vn(e,t,a,n){Hn(e,n,18,"im-reply-tt",getLang("mail_im_reply"))}function Yn(e,t,a,n){var i=intval(domData(gpeByClass("_im_mess",n),"msgid")),r=Object(s.getMessage)(e,e.get().peer,i);return r&&t().startEditing(r),!1}function zn(e,t,a){Hn(e,a,18,"im-edit-tt",getLang("mail_im_edit"))}function Qn(e,t,a){var n=Gn.bind(null,t,0),s=Un.bind(null,t),r=Kn.bind(null,t,0),o=qn.bind(null,t,e.querySelector("_im_dialog_actions"),a),l=Vn.bind(null,t,0),d=Wn.bind(null,t,a),u=zn.bind(null,t),g=Yn.bind(null,t,a),m=Object(c.createModule)({handlers:(t,a)=>{a(e,"click","_im_mess_fav",s),a(e,"mouseover","_im_mess_fav",n),a(e,"click","_im_mess_forward",o),a(e,"mouseover","_im_mess_forward",r),a(e,"click","_im_mess_reply",d),a(e,"mouseover","_im_mess_reply",l),a(e,"click","_im_mess_edit",g),a(e,"mouseover","_im_mess_edit",u)}});return function(e,t){return{markImportant(t,a,n){Object(i.updateStar)(t,a,e)},unmount(){Object(c.destroyModule)(t)}}}(e,m)}function Xn(e,t,a,r,o){if(!Object(n.isSearchingInplace)(e.get().peer,e.get())&&!(hasClass(o,i.FAILED_CLASS)||hasClass(o,i.SENDING_CLASS)||hasClass(o,"_im_mess_srv")||Object(i.checkSelectClick)(r,o)||Object(s.isAnyMessageBeingEdited)(e)||"A"===r.target.tagName||domClosest("_im_replied_message",r.target)||r.target.classList.contains("_im_retry_media")||r.target.closest("."+i.MESSAGE_KEYBOARD_BUTTON_CLASS))){var l,c,d=intval(domData(o,"msgid")),u=e.get().peer;if(!Object(i.isAlreadyDeleted)(e,u,d))l=r.shiftKey?Object(s.getMessageRangeFromSelection)(e,u,d):[d],e.set(n.addSelection.bind(null,l)).then(()=>{var n=Object(s.getSelectedMessages)(e),i=!1;l.forEach(e=>{var t=geByClass1("_im_mess_"+e,a);if(t){var s=inArray(e,n);i|=s,toggleClass(t,"im-mess_selected",s);var r=s?getLang("mail_deselect_message"):getLang("mail_select_message"),o=geByClass1("_im_mess_blind_label_select",t);attr(o,"aria-label",r)}}),i&&(window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()),t().changedMessageSelection(e)}).then(()=>{1!==e.get().selectedMessages.length||c?c&&c.hide():c=function(e){var t=e.get();if(t.pinnedMessagesPromo&&Object(i.isChatPeer)(t.peer)){var a=geByClass1("_mess-action-promo"),s=new ElementTooltip(a,{autoShow:!1,appendTo:a,content:getTemplate("im_pinned_messages_promo",{content:getLang("mail_pinned_messages_promo_tooltip")}),forceSide:"bottom",cls:"feature_intro_tt",width:260,onHide:function(){e.setState({pinnedMessagesPromo:!1}),Object(n.hidePromoTooltip)()}});return s.show(),s}}(e)})}}function $n(e,t,a){var n=Xn.bind(null,t,a,e),i=Object(c.createModule)({handlers:(t,a)=>{a(e,"click","_im_mess",n)}});return function(e,t){return{cleanSelection(t){t&&Array.isArray(t)&&t.length&&t.map(t=>geByClass1("_im_mess_"+t,e)).filter(e=>e).forEach(e=>removeClass(e,"im-mess_selected"))},unmount(){Object(c.destroyModule)(t)}}}(e,i)}function Jn(e,t,a){var n=a.get(),i=n.observer,o=n.targets;o.length&&o.forEach(i.unobserve.bind(i));var l=function(e,t){var a=e.get().peer,n=Object(s.getTab)(e,a);return Object(s.isFullyLoadedTab)(e,a)?Object.keys(n.msgs).reduce((e,a)=>{var i=n.msgs[a],o=t||document;if(Object(r.isUnread)(n,Object(s.parserMessage)(i))){var l=o.querySelector("._im_mess_"+a);l&&e.push(l)}return e},[]):[]}(e,t);a.setState({targets:l}),l.length&&l.forEach(i.observe.bind(i))}var Zn=a("Syd7"),ei=a("Wu9C");var ti={onNewMessagesChunk:function(e){var t=geByClass("post");LongView.clearElemsCache&&LongView.clearElemsCache(),t.forEach(e=>LongView.register(e,"im"))},onHistoryScroll:function(e){LongView.onScroll(e,window.innerHeight)}};function ai(){return(ai=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function ni(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return ii(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return ii(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ii(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function si(e,t,a,n){var i=e instanceof Array?e:geByClass("_im_bar_date",e),s=t.contHeight();ti.onNewMessagesChunk();var r=i.reduce((e,t)=>(e[domData(t,"date")]=[t.offsetTop+10,s,t],e),{}),o=!a&&n.barMap?n.barMap:{};return n.barMap=extend(o,r),n.barMapKeys=Object.keys(n.barMap).sort(),Promise.resolve(n)}function ri(e,t){return t.barMapKeys.forEach(a=>{t.barMap[a][0]-=e}),Promise.resolve(t)}function oi(e,t,a,n,s){var r=e.get().barMap[t],o=Object(i.isClassicInterface)(s)?68:20;return a-(r[0]+a-r[1])+n-o}function li(e,t,a,n){return n.barTransition=n.barMap[t][2],a>0?(addClass(n.barMap[t][2],"im-page--date-bar-transition-inverse"),addClass(e,"im-page--date-bar-transition-inverse")):a<0&&(removeClass(n.barMap[t][2],"im-page--date-bar-transition-inverse"),removeClass(e,"im-page--date-bar-transition-inverse")),addClass(n.barMap[t][2],"im-page--date-bar-transition"),addClass(e,"im-page--date-bar-transition"),Promise.resolve(n)}function ci(e,t){return t.barTransition&&(removeClass(t.barTransition,"im-page--date-bar-transition"),t.barTransition=null),removeClass(e,"im-page--date-bar-transition"),Promise.resolve(t)}function di(e,t,a,n,i){var s,r,o=e.get(),l=a-t;o.barMapKeys.forEach(t=>{var o=oi(e,t,a,n,i);if(o>=l){var c=s?oi(e,s,a,n,i):a;s=c>o?t:s}else if(o<l){var d=r?oi(e,r,a,n,i):0;r=o>d?t:r}});var c={};return[[r,"prev"],[s,"cur"]].forEach(t=>{var s=ni(t,2),r=s[0],o=s[1];r&&(c[o+"Bar"]=function(e,t){var a=e.get().barMap[t][2];return{text:a.textContent,date:domData(a,"date")}}(e,r),c[o+"Left"]=oi(e,r,a,n,i)-l)}),c}function ui(e,t,a,s,r){var o=e.get(),l=Object(n.isEverythingLoaded)(o),c=t.get(),d=r.scrollTop(),u=c.lastTop?c.lastTop-d:0;c.lastTop=d;var g=Object(ei.isPinnedMessageVisibleInTab)(o,o.peer)?Object(i.getPinnedMessageHeight)(e):0,m=Object(n.isSearchingInplace)(o.peer,o)&&o.tabs[o.peer]&&o.tabs[o.peer].top_banner?50:0,_=(Object(i.isClassicInterface)(e)?68+g+m:0)-16,p=di(t,d,r.contHeight(),_,e),h=p.prevBar,b=p.curBar,v=p.prevLeft,f="translateY(0px)",O=!1,C=!1,y=!1;b||l||(b=function(e){var t=geByClass1("_im_mess",e),a=domData(t,"ts");return t&&a?{text:getShortDate(intval(a),!1,!0,getLang("months_of","raw")),date:a}:null}(s)),b?O=b:C=!0,h&&b&&v>-32&&v<0&&(y=!0,C=!1,O=b,f=`translateY(${-32-v}px)`),O&&function(e,t){domData(e,"ts")!==t.date&&(e.innerHTML=t.text,domData(e,"ts",t.date),e.style.visibility="visible")}(a,O),y?t.set(li.bind(null,a,h.date,u)):t.set(ci.bind(null,a)),f&&(a.style.transform=f),toggleClass(a,"im-page--top-date-bar_no-b",C)}function gi(e,t){var a=geByClass1("_im_top_date_bar",t),n={lastTop:!1,barMap:{},barMapKeys:[],isDisabled:!1},i=Object(h.default)(n),s=null,r=null,o=null,l=Object(Ca.debounce)(e=>{var a=i.get();Object.keys(a).length&&!a.isDisabled&&i.set(si.bind(null,t,e,!1))},500);return{reset(n){i.get().isDisabled||i.set(si.bind(null,t,n,!0)).then(ui(e,i,a,t,n))},disable(){i.setState(ai({},n,{isDisabled:!0}))},enable(){i.setState({isDisabled:!1})},heightIncreased(e,t){i.get().isDisabled||(l(t),i.set(ri.bind(null,e)))},parseMore(n,s){i.get().isDisabled||i.set(si.bind(null,n,s,!1)).then(()=>{ui(e,i,a,t,s)})},toggle(e){i.get().isDisabled&&e||a.classList.toggle("im-page--top-date-bar--hidden",!e)},show(){i.get().isDisabled||(r=Date.now(),o||(addClass(t,"im-page--top-date-bar_visible"),o=setInterval((function(){Date.now()-r>2e3&&(removeClass(t,"im-page--top-date-bar_visible"),clearInterval(o),o=null)}),100)))},update(n){i.get().isDisabled||(s&&(clearTimeout(s),s=null),s=setTimeout((function(){ui(e,i,a,t,n)}),300),ui(e,i,a,t,n))},unmount(){s&&(clearTimeout(s),s=null),o&&(clearInterval(o),o=null),i.unmount()}}}var mi=a("bIHZ"),_i=a("uytb"),pi=a("S2bU"),hi=a("t7n3"),bi=a("zxIV");function vi(){return(vi=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function fi(e){return!e.children.length}function Oi(e,t){var a=geByClass1("_im_dialog_actions",e);Object(bi.toggleClass)(a,"im-page--chat-header_top-banner",t)}function Ci(e,t){var a=geByClass1("_im_top_banner_hide",e);a&&window.tooltips&&tooltips.hide(a),Oi(e,!1),t.innerHTML=""}function yi(e,t,a){var n=t.participants,s=n.count>0?langNumeric(n.count,getLang("mail_im_n_chat_members","raw")):"";return Object(hi.getTemplate)("sImCallBannerContent",{user_list:Object(i.renderCallUserList)(e,n.list),title:getLang("calls_group_call_banner_title"),desc:s,cls:a?"CallBanner--classic":""})}function ji(e){var t=e.peerId;if(Object(i.isChatPeer)(e.peerId)&&!Object(s.isChatActive)(e))return!1;var a=e.callInProgress,n=cur.imDb.selectByKey("hiddenCallBanners");return n?!(!a||n[t]&&n[t]===a.join_link):!!a}function Ei(e,t,a){var r=geByClass1("_im_top_banner",e),o=Object(c.createModule)({handlers:(o,l)=>{var c=geByClass1("_im_dialog_actions",e);l(e,"click","_im_top_banner_hide",()=>{var o=t.get().peer,l=Object(s.getTab)(t,o);ji(l)?function(e){var t=e.peerId,a=e.callInProgress,n=cur.imDb.selectByKey("hiddenCallBanners")||{};cur.imDb.updateByKey("hiddenCallBanners",vi({},n,{[t]:a.join_link}))}(l):t.set(e=>Object(n.hideTopBannerAction)(o,e)),Ci(e,r);var c=!!Object(i.renderPinnedMessage)(t);Object(i.compensateHistoryHeightChange)(t,c,!0,a)}),l(e,"click","_im_top_banner_button",s=>{var o=function(e,t,a,s){var r=e.target,o=t.get().peer;if(r.classList.contains("_im_call_banner_join_btn")){var l=r.dataset.link;return Object(i.joinCallFromIm)(t,o,l,!1,i.CALL_ENTRY_POINT_JOIN_BANNER),!1}var c=r.dataset.payload;return c?(t.set(e=>Object(n.callbackTopBannerAction)(o,c,e)),Ci(a,s),!0):(r.classList.contains("_im_top_banner_button_gifts")&&(showBox("al_gifts.php",{act:"get_gift_box",mid:o,ref:"im_birthday_banner"},{stat:["gifts.css","wide_dd.js","wide_dd.css"],dark:1}),Object(R.statlogsValueEvent)("gifts_im_birthday_banner","click",o),e.originalEvent.preventDefault()),!1)}(s,t,e,r),l=!o,c=!!Object(i.renderPinnedMessage)(t)||!o;Object(i.compensateHistoryHeightChange)(t,c,l,a)}),l(c,"mouseover","_im_top_banner_hide",(e,t)=>{Object(U.showTooltip)(t,{text:getLang("mail_top_banner_hide"),black:1,shift:[8,4],appendEl:bodyNode})})}});return{renderPeer(t){var n=Object(s.getTab)(t,t.get().peer),o=n.top_banner,l=n.callInProgress,c=!fi(r),d=ji(n);!d&&!o||Object(s.isSearchShown)(t)?c&&Ci(e,r):(Oi(e,!0),r.innerHTML=d?function(e,t){return Object(hi.getTemplate)("im_top_banner",{text:yi(e,t,Object(s.isClassicInterface)(e)),icon:"",buttons:[Object(hi.getTemplate)("sImCallBannerButton",{call_link:t.join_link}),Object(hi.getTemplate)("im_top_banner_hide_btn",{})].join(""),classes:"im-top-banner_call"})}(t,l):function(e){var t=e.icon?Object(hi.getTemplate)("im_top_banner_icon",{icon:e.icon}):"",a=e.text;"employees_banner"===e.name&&(a=Object(pi.replaceHyperLinks)(a,e=>Object(pi.linksReplacer)(!1,e)),a=Object(pi.replaceMentions)(a));var n=(e.buttons||[]).map(e=>{var t="";switch(e.layout){case"tertiary":t="im-top-banner--button-tertiary";break;case"secondary":t="secondary";break;default:t="blue_button"}switch(e.type){case"link":return Object(hi.getTemplate)("im_top_banner_button_link",{link:e.link,text:e.text,css_class:t});case"gifts_link":return t+=" _im_top_banner_button_gifts",Object(hi.getTemplate)("im_top_banner_button_link",{link:e.link,text:e.text,css_class:t});default:return Object(hi.getTemplate)("im_top_banner_button",{callback_data:e.callback_data,text:e.text,css_class:t})}});return n=n.concat([Object(hi.getTemplate)("im_top_banner_hide_btn",{})]),Object(hi.getTemplate)("im_top_banner",{text:a,icon:t,buttons:n.join("")})}(o),o&&"birthday"===o.name&&Object(R.statlogsValueEvent)("gifts_im_birthday_banner","view",t.get().peer));var u=!fi(r);Object(i.compensateHistoryHeightChange)(t,u,c,a)},unmount(){Object(c.destroyModule)(o)}}}var Si=a("cGUQ");function Ti(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return wi(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return wi(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function wi(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Ii="im-audio-message_recorded",Ai=!1,Mi={};function ki(e){return e.get().isMassMentionsMessageAllowed}function Li(e){var t=Object(s.getTab)(e,e.get().peer);return!!Object(s.getPinnedMessage)(e)||!(!t||!t.top_banner)}function Pi(e,t){var a=Object(l.unpackStore)(e),n=Object(s.getTab)(a,t);return Object(i.isChatPeer)(t)&&Object(ei.isPinnedMessageVisibleInTab)(a,t)||!!n.top_banner&&!Object(s.isSearchShown)(t,a)}function Ni(e){return Object(i.getPinnedMessageHeight)(e)}function Di(e,t,a){var n=a||window.clientHeight();return Math.min(n-15,Math.max(0,e,742+t.offsetTop))}function xi(e,t){var a=intval(domData(t.target,"msgid")),n=gpeByClass("_im_mess_"+a,t.target),i=geByClass1("_im_log_body",n),s=geByClass1("_im_mess_susp_cont",n);i.innerHTML=s.innerHTML}function Bi(e,t){return geByClass1("_im_mess_"+t,e)}function Ri(e,t,a){var n,s,r,o,l,c,d,u,g,m=geByClass1(e,t);o={onStartDrag:(e,t)=>{addClass(bodyNode,"cursor_ns_resize"),n=t,s=t},onDrop:()=>{removeClass(bodyNode,"cursor_ns_resize")},onDrag:(e,r)=>{var o=Di(s-n+r,t);Object(i.setClassicChatHeight)(o),a().fixHeight()}},d=function(e){l=void 0!==e.clientX?e.clientX:e.touches[0].clientX,c=void 0!==e.clientY?e.clientY:e.touches[0].clientY,o.onDrag&&o.onDrag.call(r,l,c)},u=function e(t){o.onDrop&&o.onDrop.call(r,l,c),removeEvent(document,"mouseup touchend mouseleave",e),removeEvent(document,"mousemove touchmove",d)},g=function(e){(1===e.which||e.touches&&e.touches[0])&&(addEvent(document,"mouseup touchend mouseleave",u),addEvent(document,"mousemove touchmove",d),l=void 0!==e.clientX?e.clientX:e.touches[0].clientX,c=void 0!==e.clientY?e.clientY:e.touches[0].clientY,o.onStartDrag&&o.onStartDrag.call(r,l,c),o.onDrag&&o.onDrag.call(r,l,c),cancelEvent(e))},(r=m).beginDragHandler=g,addEvent(r,"mousedown touchstart",g)}function Fi(e,t){var a;a=geByClass1(e,t),removeEvent(a,"mousedown touchstart",a.beginDragHandler)}function Hi(e){e().hideError()}function Ui(e,t,a,i,s){if(checkEvent(i))return!0;var r=Object(Si.fromQueryString)(s.getAttribute("href")),o=intval(r.msgid);o&&e.set(n.changePeer.bind(null,e.get().peer,o,!1)).then(()=>es(a,t,o,e)),cancelEvent(i)}function Gi(e,t,a){var i=Object(s.getTab)(t,a),r=Object(n.strHistory)(i.history);toggleClass(e,"im-page--history_empty-hist",!r)}function qi(e,t,a,n){if(hasClass(a.target,"_im_mess_marker")){var s=a.target,r=Object(l.toArray)(geByClass(i.FAILED_CLASS,t));window.tooltips&&r.map(e=>geByClass1("_im_mess_marker",e)).filter(e=>e!==s).forEach(e=>tooltips.hide(e,{fasthide:!0}));var o=domData(n,"msgid");Object(U.showTooltip)(s,{content:getTemplate("im_failed_menu",{count:r.length,modifiers:Object(Rt.classNames)("im-settings_failed",{"im-settings_no_delete":o>0,"im-settings_single":1===r.length}),id:o}),className:"im-page--failed-tt",appendParentCls:"_chat_body_wrap",dir:"down",noZIndex:!0,shift:[12,8],hasover:!0,force:!0})}}function Wi(e){return geByClass1("_im_peer_history",e)}function Ki(e,t){var a=t.contHeight(),n=e.scrollTop+(a-e.contHeight);t.scrollTop(n)}function Vi(e,t,a,r,o,l,c,d,u){var g=!(arguments.length>9&&void 0!==arguments[9])||arguments[9],m=arguments.length>10&&void 0!==arguments[10]&&arguments[10],_=(t.get().tabs||{})[a];o().hideError(),l.renderPeer(t),d.renderPeer(t),u.render(t);var p=Object(s.isCasperChat)(t,a);if(toggleClass(e,"im-page--history_casper",p),!t.get().tabHistoryNotChanged){l.reRenderTitle(t),Gi(e,t,a);var h=Object(n.strHistory)(_.history);if(h){var b=geByClass1("_im_peer_history",e);val(b,h)}else o().showEmptyScreen();getAudioPlayer().isPlaying()&&getAudioPlayer().updateCurrentPlaying(),bs(t,r,e)}if(Object(n.isSearchingInplace)(a,t.get())?o().showSearch(t):o().cancelSearch(t,!1),c.changePeer(a,t),t.get().msgid)es(r,e,t.get().msgid,t);else if(_.scrollBottom&&g){Ki(_,r);var v=Object(i.isMessagesVisible)(t,e,r),f=Ti(v,1),O=f[0];_.skipped||setTimeout(()=>{_.unread&&!O&&(ns(t,e,!0),is(t,e,!0)),Qi(t,r,e),Xi(t,r,e)},100)}else Zi(r,e,o,t,m)||r.scrollBottom(-30);window.LazyLoad&&window.LazyLoad.scan(!!r.scroll&&r.scroll.scroller)}function Yi(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=a||t.scrollTop(),s=t.scrollBottom(),r=t.contHeight(),o=e.get().peer;e.set(n.saveHistoryScroll.bind(null,o,i,s,r))}function zi(){return rt.screenfull.isFullscreen}function Qi(e,t,a){var n=Object(s.isGoToMentionVisible)(e),i=Object(s.isGoToEndVisible)(e),r=t.getScrollHeight()/4,o=t.scrollTop()>0;t.scrollBottom()>r&&(!i||n)&&o&&ns(e,a,!0,40)}function Xi(e,t,a){if(ki(e)){var n=t.getScrollHeight()/4,i=t.scrollTop()>0,r=Object(s.isGoToMentionVisible)(e);t.scrollBottom()>n&&!r&&i&&is(e,a,!0,40)}}function $i(e,t,a,r,o,l,c,d){var u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];if((e.get().history_init||(e.get().history_init=!0,!(d.scrollTop()>0)))&&!zi()){o.update(d),o.show();var g=e.get().peer;if(0!==g&&Object(i.isFullyLoadedTab)(e.get(),g)&&(ti.onHistoryScroll(d.scrollTop()),!layers.visible)){var m=Object(s.getTab)(e,g);m&&!m.skipped&&d.scrollBottom()>40?(Qi(e,d,l),Xi(e,d,l)):m.skipped||m.unread||(Cs(e,l),ys(e,l));var _=Object(i.wrapLoading)(a);if(!Object(n.isSearchingInplace)(g,e.get())&&u&&r(d),!Ai&&(c<0||0===d.scrollBottom())&&d.scrollBottom()<1e3){if(Object(n.isSearchingInplace)(g,e.get()))return;if(m.skipped>0&&!e.get().no_moving_down){var p=gpeByClass("_im_page_history",l),h=e.get();Ai=!0;var b=e.set(n.loadLessHistory).then(t().loadHistory.bind(null,h.peer,{reversed:!0})).then(()=>{t().updateObserver(),Ai=!1,ns(e,p),is(e,p),m.skipped||e.set(n.changePeer.bind(null,e.get().peer,!1,!1))});return _s(p,!0),void b.then(_s.bind(null,p,!1))}}if(!Ai&&d.scrollTop()<1e3){if(Object(n.isSearchingInplace)(g,e.get())){Ai=!0;var v=t().getSearchResulstModule();return v.isAll(e)?void(Ai=!1):void _(v.loadMore(e).then(a=>{Ai=!1,a&&(t().loadHistory(e.get().peer,{},e,a),r(d))}),"up")}var f=e.get();m.allShown||(Ai=!0,_(e.set(n.loadMoreHistory.bind(null,0,0)).then(t().loadHistory.bind(null,f.peer,{})).then(()=>{Ai=!1,r(d)}),"up"))}c<0&&As(e,g,d.scrollBottom(),l,t),Object(n.videoAutoPlayHandler)()}}}function Ji(e,t){return window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle?Promise.resolve():e.set(n.readTillSpecificMessage.bind(null,t,e.get().peer))}function Zi(e,t,a,s,r){var o=geByClass1("_im_unread_bar_row",t);if(o){var l=s.get(),c=l.peer,d=o.getBoundingClientRect(),u=geByClass1("_im_chat_body_abs",t).getBoundingClientRect().top+20;Object(i.isClassicInterface)(s)&&(u+=47+(Pi(l,c)?Ni(s):0));var g=e.scrollTop()-u+d.top;return e.scrollTop(g),Yi(s,e,g),setTimeout(()=>{c===s.get().peer&&$i(s,a,Wi(t),(function(){}),r,t,0,e)},80),Object(W.partConfigEnabled)("mail_history_unread_counter_observer")?a().updateObserver():function(e){var t=e.get().peer;if(!(window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle)&&t)e.set(n.readLastMessages.bind(null,t))}(s),!0}return!1}function es(e,t,a,n){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"top",r=Bi(t,a);if(r){var o=Object(i.isClassicInterface)(n),l=n.get().peer,c=o?window.clientHeight():geByClass1("_im_chat_body_abs",t).offsetHeight,d=r.offsetTop+domPN(r).offsetTop+domPN(domPN(r)).offsetTop+domPN(domPN(domPN(r))).offsetTop;o&&Pi(n,l)&&(d-=Ni(n)),"top"===s?e.scrollTop(d-e.getScrollHeight()/2+c/2):e.scrollTop(d-e.getScrollHeight()+c/4),addClass(r,"im-mess_light"),setTimeout(()=>{removeClass(r,"im-mess_light")},2e3)}}function ts(e,t,a){a.updateLastSeen(e)}function as(e,t,a,i,s,r){var o=domData(r,"action"),l=domData(r,"msgid"),c=geByClass1("_im_mess_marker",Bi(a,l)),d=Number(l)>0?"edit":"send",u=e.get().peer,g=Wi(a);switch(o){case"resend":Object(nt.statlogsSendingRetry)("retry",d),t(s,r);break;case"resend_all":Object(nt.statlogsSendingRetry)("retry",d),i().resendPeer();break;case"delete":Object(nt.statlogsSendingRetry)("delete",d),e.set(n.removeFailed.bind(null,g,u,l));break;case"delete_all":Object(nt.statlogsSendingRetry)("delete",d),e.set(n.removeFailed.bind(null,g,u,void 0))}tooltips.hide(c,{fasthide:!0})}function ns(e,t,a){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=e.get(),o=r.peer;if(!Object(i.isReservedPeer)(o)){var l=e.get().tabs[o],c=(t||document).querySelector("._im_to_end"),d=!1;(a||l.skipped>0||l.unread>0)&&!Object(n.isSearchingInplace)(o,e.get())?(d=!0,ss(t,e),addClass(c,"im-navigation_shown")):Os(c,!0),e.set(n.updateGoToEndVisibility.bind(null,[d,+s]))}}function is(e,t,a){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(!ki(e))return!1;var r=e.get(),o=r.peer;if(!Object(i.isReservedPeer)(o)){var l=e.get().tabs[o],c=(t||document).querySelector("._im_to_mention"),d=os(e).length,u=!1;l.unread>0&&d>0&&!Object(n.isSearchingInplace)(o,e.get())?(u=!0,rs(t,e,d),addClass(c,"im-navigation_shown")):Os(c,!0),e.set(n.updateGoToMentionVisibility.bind(null,[u,+s]))}}function ss(e,t){var a=t.get().peer,n=Object(s.getTab)(t,a);(e||document).querySelector("._im_to_end").querySelector("._im_to_end_label").innerHTML=Number(n.unread)>0?Object(hi.formatCount)(n.unread):""}function rs(e,t,a){(e||document).querySelector("._im_to_mention").querySelector("._im_to_mention_label").innerHTML=a>0?Object(hi.formatCount)(a):""}function os(e){var t=e.get(),a=t.id,n=t.peer,i=Object(s.getTab)(e,n);if(!n||!i)return[];var o=i.msgs||{};return Object.values(o).filter(e=>!(!e||Array.isArray(e)||Object(r.isOut)(e)||!Object(r.isUnread)(i,e))&&Object(r.hasUserMentions)(e,a))}function cs(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e.scrollTop()&&0===e.scrollBottom())return!1;var a=e.scrollBottom();return a<(t?30+t:30)}function ds(e,t,a,n,i){var r=domData(i,"msgid"),o=e.get().peer,l=Object(s.getMessage)(e,o,r);l.type===B.EDIT_MESSAGE?(a().sendEditMessage(e,l),a().resendMessage(o,r)):e.get().imQueueResend(o,r).then(t=>{e.get().longpoll.push([Object(d.resendEvent)(o,t.mess)])})}function us(e,t,a,r,o,l){var c=intval(domData(l,"peer")),d=intval(domData(gpeByClass("_im_mess",l),"msgid")),u=Object(s.getTab)(e,c);return e.set(n.restoreMessage.bind(null,d,c)).then(i.restoreMessage.bind(null,d,c,Wi(t))).then(()=>bs(e,a,t)),Object(n.restoreMessageSend)(d,c,u.hash,e.get().gid).then(()=>{d>u.lastmsg&&Object(n.loadActualLastMessage)(e,c).then(()=>r().updateState(c,e))}),!1}function gs(e,t){e().showCreation(t)}function ms(e,t){if(e){var a=e.querySelector("._im_to_end");toggleClass(a,"im-navigation_loading",t)}}function _s(e,t){if(e){var a=e.querySelector("._im_to_end");toggleClass(a,"im-navigation_loading",t)}}function ps(e,t,a,o){var l=t.get().peer,c=Object(s.getTab)(t,l);if(Object(i.isFullyLoadedTab)(t,l)){var d=Object.keys(c.msgs).find(e=>{var t=c.msgs[e];return!Array.isArray(t)&&Object(r.isUnread)(c,t)});if(!c.skipped)return d?es(o,a,d,t):o.scrollBottom(-30),ns(t,a),is(t,a),As(t,l,0,a,e),void Object(n.readTillSpecificMessage)(c.lastmsg,l,t.get());ms(a,!0),t.set(n.changePeer.bind(null,l,!1,!1)).then(()=>t.set(n.loadPeer.bind(null,l,!0,-1,!1))).then(()=>{ms(a,!1),e().changePeer(t,!1,!1)})}}function hs(e,t,a,i){var r=Object(s.getTab)(t,t.get().peer),o=os(t),l=!!o.length&&o[0].messageId;if(!r.skipped)return l&&es(i,a,l,t,"center"),ns(t,a,!0),is(t,a),Ji(t,l),void As(t,t.get().peer,0,a,e);ms(a,!0),t.set(n.changePeer.bind(null,t.get().peer,!1,!1)).then(()=>t.set(n.loadPeer.bind(null,t.get().peer,!0,-1,!1))).then(()=>{ms(a,!1),e().changePeer(t,!1,!1),Ji(t,l)})}function bs(e,t,a){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(Object(i.isClassicInterface)(e)){var s=t.contHeight(),r=geByClass1("_im_chat_input_w",a),o=geByClass1("_im_chat_resize",a);if(!1!==(n=!1!==n?n:Object(i.getClassicChatHeight)())&&n>0){var l=window.clientHeight(),c=geByClass1("_im_chat_audio_input_parent",a),d=Di(n,a,l),u=hasClass(c,"im-audio-message_recording")||hasClass(c,Ii),g=u?c:geByClass1("_im_chat_input_parent",a),m=d-g.offsetHeight;o.style.height=l-d-15+"px",setStyle(r,{top:m+"px",bottom:"auto"})}else o.style.height="0px",setStyle(r,{top:"auto",bottom:"0px"});var _=geByClass1("_im_peer_history_w",a);return setStyle(_,{borderBottomWidth:r.offsetHeight-15-1}),t.contHeight()-s}var p=t.getScrollHeight();t.update(!1,!0);var h=t.getScrollHeight();return p-h}function vs(e,t,a,n){var i=t.offsetHeight;n(),e.heightIncreased(t.offsetHeight-i,a)}function fs(e,t){var a=t.getBoundingClientRect().top;Object(U.showTooltip)(t,{className:"im-page--admin-tt",text:getLang("mail_only_admin_see"),appendParentCls:"_chat_body_wrap",shift:[20,5],dir:"auto",showdt:400,noZIndex:!0,toup:a>200})}function Os(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];hasClass(e,"im-navigation_shown")&&(t&&addClass(e,"im-navigation_fast"),removeClass(e,"im-navigation_shown"),t&&(e.offsetHeight,removeClass(e,"im-navigation_fast")))}function Cs(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.querySelector("._im_to_end");e.set(n.updateGoToEndVisibility.bind(null,[!1,0])),Os(i,a)}function ys(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.querySelector("._im_to_mention");e.set(n.updateGoToMentionVisibility.bind(null,[!1,0])),Os(i,a)}function js(e,t,a){rt.screenfull.isFullscreen||0===t.get().peer||Object(i.isClassicInterface)(t)||e().restoreScroll(t,t.get().peer)}function Es(e,t){var a=e.get(),o=a.peer,l=domClosest("_im_mess_srv",t.target),c=intval(domData(l,"msgid")),d=Object(s.getMessage)(e,o,c),u=d&&Object(r.isServiceMsg)(d)&&d.kludges.source_act;if(u===i.CHAT_PIN_MESSAGE||u===i.CHAT_UNPIN_MESSAGE){var g=l.querySelector(".im_srv_mess_link");if(g&&"A"!==g.tagName){var m=d.kludges.source_chat_local_id;if(!m||Mi[m])return;Mi[m]=Object(n.getMessageLocalId)(o,m,a).then(e=>{var t=Ti(e,1)[0];if(t){var a=`/im?sel=${Object(i.convertPeerToUrl)(o)}&msgid=${t}`,n=g.innerHTML;domReplaceEl(g,Object(i.serviceLink)(a,n,!0,"im_srv_mess_link")),delete Mi[m]}})}}}function Ss(e,t,a){var n=e.get(),r=n.peer,o=a.target.href&&a.target.href.match(/msgid=([\d]+)/),l=o&&o[1];"A"!==a.target.tagName||!l||Object(i.isAlreadyDeleted)(e,r,l)||checkEvent(a)||(Object(s.getMessage)(e,r,l)?(e.setState({msgid:l}),Object(mi.updateLocation)({msgid:l}),t().focusOnMessage()):n.longpoll.push([Object(d.changePeer)(r,l)]));cancelEvent(a)}function Ts(e){var t=Object(s.getCurrentTab)(e);Object(i.isChatPeer)(t.peerId)&&(t.pinHideId=cur.imDb.select(_i.PIN_HIDDEN_ID_OP,t.peerId))}function ws(e,t,a,n,i){e.setState({isEditing:!1}),removeClass(n,"im-mess_is_editing"),removeClass(geByClass1("_im_page_history"),"is_msg_editing"),cancelStackFilter("cancel_edit"),a.setDraft(e,Object(s.getPeer)(e)?Object(s.getTabDraft)(Object(s.getCurrentTab)(e)):null),a.toggleStickers(e,!0),a.restoreKeyboard(),Is(t)}function Is(e){Object(l.toArray)(geByClass("_im_history_tooltip",e)).forEach(hide)}function As(e,t,a,i,r){var o=Object(s.getTab)(e,t);if(!(Date.now()-(o.lastReset||0)<1e3)&&(o&&o.msgs&&o.history&&!Ai&&o.offset>300&&0==o.skipped&&a<50&&a>=0&&0===(e.get().selectedMessages||[]).length)){var l=Object.keys(o.msgs).filter(e=>e>0).sort((e,t)=>e-t).slice(0,-50),c=l.slice(-1)[0];e.mutate(n.resetTabAll.bind(null,t)),e.set(n.removeMessages.bind(null,l,t)).then(()=>r().removeStartingFromMessage(c,t,e))}}function Ms(e,t,a,n){var s=n.target,r=domClosest("_im_replied_message",s),o=Number(r.getAttribute("data-msgid")),l=domClosest("im-mess",s),c=Number(l.getAttribute("data-msgid")),d=e.get().peer;o&&!Object(i.isAlreadyDeleted)(e,d,o)?(e.setState({msgid:o}),Object(mi.updateLocation)({msgid:o}),Object(i.focusOnMessage)(e,t().focusOnMessage,d,o)):c&&Object(i.showRepliedBox)(e,c,n)}function ks(e){checkEvent(e)||cancelEvent(e)}function Ls(e,t){var a=domClosest("_im_mess",t);if(a){var i=Number(a.getAttribute("data-msgid")),o=e.get().peer,l=Object(s.getMessage)(e,o,i);i&&l&&!Object(r.isOut)(l)&&Object(n.markAudioMessageAsListened)(o,i,e.get())}}function Ps(e,t,a){var n=a.target.closest("."+i.MESSAGE_KEYBOARD_BUTTON_CLASS),s=a.target.closest("."+i.MESSAGE_STACK_CLASS);if(n){var r=t.get().keyboard_app_hash,o=e.sendMessageFromKeyboard.bind(null,()=>e),l=Object(st.getActionObjectFromElement)(n),c=s?s.dataset.peer:void 0;return Object(st.handleButtonClick)(l,o,r,c)}}function Ns(e,t){var a=t.target.closest("._im-call-snippet"),n=a.closest("._im_mess_callsnippet"),s=a.dataset.type,r=a.dataset.participants,o=r&&r.split(",").reduce((t,a)=>(+a!==e.get().id&&Object(i.isUserPeer)(+a)&&t.push(+a),t),[]),l=+n.dataset.peer;Object(i.isCallToPeerAvailable)(e,l)&&Object(i.startCallFromIm)(e,l,"video"===s,o,i.CALL_ENTRY_POINT_SNIPPET)}function Ds(e,t,a){xs(e,t,a.target.closest("._im_mess_pinned"))}function xs(e,t,a){var n=+a.dataset.msgid,r=Object(s.getMessage)(e,e.get().peer,n),o=Object(xa.canMessageBeEdited)(e,r);o!==a.classList.contains("im-mess_editable")&&(a.classList.toggle("im-mess_editable",o),Object(i.updateMessageInCache)(e,t,a))}function Bs(e,t,a,o,u,g,m,p,h,b,v,f,O,C,y,j,E,S){var T,w=Object(l.throttle)((function(){a.smoothScroll(...arguments)}),300);return{fixKeyboard(){u.fixKeyboard()},removeUnpinnedMessageEditable(e,a){var n=t.querySelector("._im_mess_pinned:not(._im_mess_"+a);n&&(n.classList.remove("_im_mess_pinned"),xs(e,t,n))},changePeer(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],l=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],c=e.get().peer;if(revertLastInlineVideo(t),0===c)return y.disable(),u.setDraft(e,null),function(e){addClass(e,"im-page--history_empty"),Wi(e).innerHTML=""}(t);if(Object(i.isFullyLoadedTab)(e.get(),e.get().peer)){removeClass(t,"im-page--history_search"),e.set(n.dropSelection),o.changeActions(e),o.showActions(e);var d=e.get().prevPeer;removeClass(t,"im-page--history_loading"),toggleClass(t,"im-page--history_vkcomgroup",Object(i.isFvkcomgroup)(e,c)),r?u.setDraft(e,Object(s.getTabDraft)(Object(s.getCurrentTab)(e))):u.updateState(e),ns(e,t),is(e,t),g().updateTyping(c,e),ts(e,0,o),Object(i.isReservedPeer)(d)&&!Object(i.isReservedPeer)(c)?function(e,t,a,n,i,s,r,o,l,c,d){removeClass(e,"im-page--history_empty"),Vi(e,t,a,n,i,s,r,o,l,c,d)}(t,e,c,a,g,o,p,j,S,l,y):Object(i.isReservedPeer)(d)||Object(i.isReservedPeer)(c)||Vi(t,e,c,a,g,o,p,j,S,l,y),Object(s.isCasperChat)(e,c)||(y.enable(),y.toggle(!0),y.reset(a)),Object(i.isReservedPeer)(c)||setTimeout(()=>{$i(e,g,Wi(t),O,y,t,0,a)}),Object(i.ensureDomHasActions)(t)}},preparePeer(e){var a=Object(s.getPeer)(e);Ts(e),u.setDraft(e,Object(s.getTabDraft)(Object(s.getTab)(e,a)),!1),g().updateTyping(a,e),g().hideError(),o.renderPeer(e),j.renderPeer(e),o.hideActions(e),p.changePeer(a,e),ts(e,0,o),y.toggle(!1),Cs(e,t,!0),ys(e,t,!0)},saveScroll:e=>Yi(e,a),loadingPeer(e){Object(n.isAnythingLoading)(e.get())||(removeClass(t,"im-page--history_empty"),addClass(t,"im-page--history_loading"))},stopLoading(e){removeClass(t,"im-page--history_loading")},deselectDialog(e){m().removeSelection(e)},replaceMessageAttrs(e,a){Object(i.replaceMessageAttrs)(a.get(),Wi(t),e)},cleanSelection(e){b.cleanSelection(e)},updateDialogFilters(e){m().updateDialogFilters(e)},getSearchResulstModule:()=>T,showSearchResults(e){e?(removeClass(t,"im-page--history_search-empty"),Wi(t).innerHTML=e):(addClass(t,"im-page--history_search-empty"),Wi(t).innerHTML=Object(i.renderEmptySearch)())},insertSearch(e,n){T||(o.deselectAll(n),T=_(t,n)),addClass(t,"im-page--history_search"),g().showSearchResults(e),bs(n,a,t),a.scrollBottom(0),ns(n,t),is(n,t),y.reset(a)},updateChatTopic(e,t){m().updateDialog(e,t),e===t.get().peer&&(o.renderPeer(t),o.renderActions(t),j.renderPeer(t))},updateActions(e){o.changeActions(e)},updateChatPhoto(e,n,s){if(Object(i.isPeerActive)(e.peerId,s.get())){o.renderPeer(s),j.renderPeer(s);var r=cs(a);Object(i.addChatPhotoToUpdate)(e,n,s.get(),Wi(t)),r&&a.scrollBottom(-30)}},markImportant(e,a,n){Bi(t,e)&&(o.changedMessageSelection(n),h.markImportant(e,a,n))},isNewMessagesVisible:e=>function(e,t){return Object(s.getUnreadScrollBottom)(e)>=intval(t.scrollBottom())}(e,a),loadHistory(e,n,s){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=s.get();if(Object(i.isPeerActive)(e,o)){var l=r||o.tabs[e].historyToAppend;if(!l)return;var c=geByClass1("_im_peer_history",t),d=domFC(c),u=a.scrollBottom(),g=n.reversed?e=>c.appendChild(e):e=>c.insertBefore(e,d),m=0;n.reversed&&(m=c.offsetHeight);var _=sech(l),p=document.createDocumentFragment();_.forEach(e=>p.appendChild(e)),g(p),n.reversed&&y.heightIncreased(c.offsetHeight-m,a),n.reversed||a.scrollBottomFixSave(u),a.update(!1,!0);var h=_.filter(e=>hasClass(e,"_im_bar_date"));y.parseMore(h,a),Object(i.ensureDomHasActions)(t)}},sendMessage(e){0!==e.get().peer&&u.sendMessage()},editMessage(e,n){if(Object(i.isFullyLoadedTab)(e,n.peerId)&&Object(i.isPeerActive)(n.peerId,e.get())){if(!Bi(t,n.messageId))return;Yi(e,a),Object(i.editAndReplaceMessage)(e.get(),n,t),Ki(Object(s.getTab)(e,n.peerId),a),o.reRenderPinned(e),y.reset(a)}},addMessage(e,o){if(!Object(n.isSearchingInplace)(o.peerId,e.get())&&Object(i.isFullyLoadedTab)(e,o.peerId)&&Object(i.isPeerActive)(o.peerId,e.get())){if(Bi(t,o.messageId))return;var l=Wi(t);vs(y,l,a,()=>{var n=cs(a),c=geByClass1("_im_unread_bar_row",t),d=Ti(Object(i.isMessagesVisible)(e,t,a),2),u=d[0],m=d[1];Object(i.appendToHistory)(e.get(),o,l,!0,!0,!u&&!c),removeClass(t,"im-page--history_empty-hist");var _=Object(s.getTab)(e,e.get().peer),p=Object(r.isServiceMsg)(o)&&o.userId===vk.id,h=o.kludges&&o.kludges.source_act,b=p&&h!==i.CHAT_PIN_MESSAGE&&h!==i.CHAT_UNPIN_MESSAGE;_.skipped||u||!Object(r.isUnread)(_,o)||Object(r.isOut)(o)||(ns(e,t,!0,m),is(e,t,!0,m)),(o.local||n||b)&&a.scrollBottom(0),g().updateTyping(o.peerId,e),ss(t,e),Is(t)});var c=domPS(domLC(l));if(hasClass(c,"_im_bar_date")){var d=ce("div");d.innerHTML=c.outerHTML,y.parseMore(d,a)}g().hideError(),y.update(a),Object(n.updateMentions)(e.get()),As(e,o.peerId,a.scrollBottom(),0,g),this.updateObserver()}},setMessageErrored(e,a,n,s){n&&"string"==typeof n&&g().showError(n),Object(i.setMessageError)(e,a,t)},markMessagesAsRead(e,a){e.get().peer===a.peerId&&Object(i.markMessagesAsRead)(e.get(),a.peerId,t)},compensateHistoryHeightChange(e){a.scrollTop(a.scrollTop()+e*Ni(f))},updateTyping(e,a){if(!Object(n.isSearchingInplace)(e,a.get())){var r=a.get();if(r.peer===e&&Object(i.isFullyLoadedTab)(r,e)){var o=Object(i.formatTyper)(Object(s.getTab)(a,e).activity,e,!1,r),l=geByClass1(i.TYPING_CLASS,t);if(l||o){if(!l){var c=geByClass1("_im_typer_c",t);val(c,getTemplate("im_typing",{cls:Object(i.isClassicInterface)(a)?"im-activity_classic":""})),l=geByClass1(i.TYPING_CLASS,t)}val(geByClass1("_im_typing_name",l),o);var d=Object(i.loadSummaryActivityType)(Object(s.getTab)(a,e).activity||{})===n.ACTIVITY_TYPE_RECORDING_AUDIO;l.setAttribute("data-activity-type",d?"recording":"typing"),o?(addClass(l,"im-page--typing_vis"),g().hideError()):removeClass(l,"im-page--typing_vis")}}}},scrollFix(e,t,n){y.heightIncreased(n,a),y.update(a),Object(i.isPeerActive)(t,e.get())&&cs(a,n)&&a.scrollBottom(-30)},goToEnd(){ps(()=>this,f,t,a)},updateGoToEnd(e,n){var i=Object(s.getTab)(e,e.get().peer);i&&(i.skipped||i.unread)?ns(e,t):Cs(e,t,n),v(0,a,!1);var r=e.get().peer;setTimeout(()=>{e.get().peer===r&&Yi(e,a)})},updateGoToMention(e,n){var i=Object(s.getTab)(e,e.get().peer),r=os(e),o=r.length>0&&r[0].messageId;i&&o?is(e,t):ys(e,t,n),v(0,a,!1);var l=e.get().peer;setTimeout(()=>{e.get().peer===l&&Yi(e,a)})},newMessage(e){m().newMessage(e),Cs(e,t,!0),ys(e,t,!0)},scroll(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==e.get().peer){var s=n?a.getScrollHeight():40;!0===i&&(s=a.contHeight()),s="up"===t?-s:s,n||i?w(s,()=>{v(s,a)}):(a.scrollTop(a.scrollTop()+s),v(s,a))}},showCreation(e,t){m().showCreation(e,t)},updateScroll:()=>bs(f,a,t),toggleBarDate(e){y.toggle(e)},changedMessageSelection(e){o.changedMessageSelection(e)},updateOnline(e,t){Object(i.isTabLoaded)(t.get(),e)&&e===t.get().peer&&o.renderPeer(t)},isEmpty:e=>u.isEmpty(e),replaceAttachmentPlaceholders(e,n){if(Object(i.isPeerActive)(n.peerId,e.get()))vs(y,Wi(t),a,()=>{var r=cs(a);Object(i.replaceAttaches)(t,n,e.get());var l=Object(s.getTab)(e,n.peerId);if(l.mediacontent[n.messageId].length>=3&&l.mediacontent[n.messageId][2].pinned){var c=Object(s.parserMessage)(l.pinned);c&&c.messageId==n.messageId&&(l.pinned=l.mediacontent[n.messageId][2].pinned,o.reRenderPinned(e))}r&&a.scrollBottom(0)}),y.update(a);else if(Object(r.isMoneyRequest)(n)){var l=Object(s.getTab)(e,n.peerId);if(l.mediacontent[n.messageId].length>=3&&l.mediacontent[n.messageId][2].pinned){var c=Object(s.parserMessage)(l.pinned);c&&c.messageId==n.messageId&&(l.pinned=l.mediacontent[n.messageId][2].pinned)}}},removeMessages(e,n,s){s.get().peer===n&&(Object(i.removeMessages)(e,Wi(t)),Object(i.removeExpiredMessagesStub)(e,Wi(t)),bs(s,a,t),o.changedMessageSelection(s),this.updateObserver())},removeStartingFromMessage(e,n,s){if(s.get().peer===n){var r=Wi(t),l=geByClass1("_im_mess_"+e,r);Object(i.removeStartingFromMessage)(l,r),bs(s,a,t),o.changedMessageSelection(s)}},hideGoToEnd(e){Cs(f,t,e)},hideGoToMention(e){ys(f,t,e)},removeMessagesRestore(e,a,n,s){s.get().peer===a&&Object(i.removeMessagesWithRestore)(e,a,n,Wi(t))},removeExpiredFailedMessages(e){f.get().peer===e&&f.set(n.removeExpiredFailed.bind(null,Wi(t),e))},handleMessageExpiration(e){Object(i.isFullyLoadedTab)(f.get(),e.peerId)&&(Object(i.replaceExpiredMessageWithPlaceholder)(f,t,e),Object(i.replaceExpiredRepliedMessageWithPlaceholder)(t,e),u.detachMessages(e))},updateState(e,t){m().updateState(e,t)},updateBanner(e){j.renderPeer(e)},updateHeader(e){o.renderPeer(e)},updateChat(e,t){e.get().peer===t&&(o.changeActions(e),o.renderPeer(e),o.renderActions(e),j.renderPeer(e),u.updateState(e),Object(n.updateMentions)(e.get()))},focustTxt(e){u.focusOn(e)},startSearch(e){g().showSearch(e),p.changePeer(e.get().peer,e),p.search()},showSearch(e){addClass(t,"im-page--hisory_search-open"),e.setState({searchShown:!0}),Li(e)&&this.updateChatTopic(e.get().peer,e),this.cancelEditing(),setTimeout(()=>p.focus(e),10)},cancelSearch(e){var s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e.get().searchShown&&(removeClass(t,"im-page--hisory_search-open"),removeClass(t,"im-page--history_search"),removeClass(t,"im-page--history_search-empty"),e.setState({searchShown:!1}),Li(e)&&this.updateChatTopic(e.get().peer,e),o.changedMessageSelection(e)),s&&!Object(i.isReservedPeer)(e.get().peer)&&T){var r=e.get().tabs[e.get().peer],l=Object(n.strHistory)(r.history);l?Wi(t).innerHTML=l:g().showEmptyScreen(),bs(e,a,t),a.scrollBottom(0),e.get().msgid&&(es(a,t,e.get().msgid,e),ns(e,t),is(e,t)),O(a),y.reset(a)}T&&(T.unmount(),T=!1,Object(i.ensureDomHasActions)(t))},showEmptyScreen(){var e=geByClass1("_im_peer_history",t);addClass(t,"im-page--history_empty-hist");var a=Object(s.isCasperChat)(f,f.get().peer)?getTemplate("sImEmptyCasper"):getLang("mail_im_here_history");val(e,a)},updateHistory(e){0!==f.get().peer&&e(t)},focusOnMessage(){es(a,t,f.get().msgid,f)},sendEditMessage(e,t){e.set(n.deliverEditedMessage.bind(null,Object(s.getTab)(e,t.peerId),t)).catch(a=>e.get().longpoll.push([Object(d.failedMessage)(t.peerId,t,a)]))},unmount(){Object(c.destroyModule)(e),a.destroy(),clearInterval(C),u.unmount(),o.unmount(),h.unmount(),b.unmount(),p.unmount(),y.unmount(),cancelStackFilter("forward"),Fi("_im_chat_resize_track",t),S.destroy()},removePeer(e,t){m().removePeer(e,t)},restoreScroll(e,t){var n=e.get().tabs[t];n.scrollBottom?Ki(n,a):a.scrollBottom(-30)},resendMessage(e,a){e===f.get().peer&&Object(i.startResendMessage)(e,a,t)},resendPeer(){u.resendPeer()},resendAll(){u.resendAll()},respond(e,t){u.attachMessages(e,t),u.focusOn(e);var n=Object(s.getTab)(e,t);n&&!n.skipped&&(a.scrollBottom(-30),O(a))},cancelRecording(){u.cancelRecording()},flushDraft(e){u.saveText(e)},hideError(){geByClass1("_im_error",t).classList.remove("im-page--error--visible")},showError(e){var n=geByClass1("_im_error",t);n.innerHTML=e,n.classList.add("im-page--error--visible"),a.scrollBottom(-30)},startEditing(e){if(Object(n.isAnythingLoading)(f.get()))Object(i.showWaitUntilUploadedBox)();else{e=Object(s.parserMessage)(e);var a=Object(i.getNowEditingMessage)(f);if(!(u.isBlocked()||a&&a.messageId==e.messageId)){a&&this.cancelEditing(),Is(t),f.get().searchShown&&this.cancelSearch(f);var r=Bi(t,e.messageId);r&&(this.cancelRecording(),function(e,t,a,n,i){e.setState({isEditing:!0}),a.saveText(e),addClass(n,"im-mess_is_editing"),addClass(geByClass1("_im_page_history"),"is_msg_editing"),cancelStackPush("cancel_edit",()=>ws(e,t,a,n,i));var s=new Ba.ImDraft;s.dData.txt=Object(xa.convertEmojiHtmlToRegularText)(i.text),s.dData.attaches=Object(q.convertKludgesToAttaches)(i.kludges,i.messageId),a.toggleStickers(e,!1),a.setDraft(e,s),setTimeout(()=>a.focusOn(e),0)}(f,t,u,r,e),u.hideKeyboard(),o.deselectAll(f))}}},cancelEditing(){var e=Object(i.getNowEditingMessage)(f);e&&ws(f,t,u,Bi(t,e.messageId))},messageKeyboardButtonClick:e=>Ps(u,f,e),getEditingMessage:()=>Object(i.getNowEditingMessage)(f),focusEditingMessage(){var e=Object(i.getNowEditingMessage)(f);e&&es(a,t,e.messageId,f),u.focusOn(f)},setNetworkWaitingStatus(e){o.setNetworkWaitingStatus(e)},setNetworkReconnectingStatus(){o.setNetworkReconnectingStatus()},clearNetworkStatus(){o.clearNetworkStatus()},updateCasperMessageStatus(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.isFullyLoadedTab)(f.get(),e.peerId)&&f.set(n.updateCasperMessageExpiringStatus.bind(null,e,a)).then(()=>{f.get().peer===e.peerId&&Object(i.setCasperMessageExpiringStatusDOM)(t,a,e.messageId)})},updateObserver(){E.update()},renderPeerProfile(e){S.render(e)},destroyPeerProfile(){S.destroy()}}}function Rs(e,t,a,o,u){var g=geByClass1("_im_peer_history_w",e);Object(Oa.hasAccessibilityMode)()&&addClass(g,"history_a11y");var m,_,p,v=Object(c.createMutations)(Bs),f=v.callMutations,O=v.bindMutations,C=(m=Yi.bind(null,t),_=Object(Ca.debounce)(m,100),p=Object(l.throttle)(m,100),e=>{_(e),p(e)}),y=gi(t,e),j=$i.bind(null,t,f,g,C,y,e),E=Object(b.createScroll)(geByClass1("_im_chat_body_abs",e),{onScroll:j,nativeScroll:Object(i.isClassicInterface)(t),shadows:!1}),S=Object(i.isClassicInterface)(t)?void 0:E.scroll.container,T=function(e,t,a){var n=Object(h.default)({observer:new IntersectionObserver(a,{root:t}),targets:[]});Jn(e,t,n);var i=Object(c.createModule)({handlers:(e,t)=>{}});return{update(){Jn(e,t,n)},unmount(){var e=n.get(),t=e.observer;e.targets.forEach(t.unobserve.bind(t)),Object(c.destroyModule)(i)}}}(t,S,e=>function(e,t,a){var i=Object(s.getCurrentTab)(e),o=a.reduce((t,a)=>{if(a.isIntersecting){var n=+a.target.getAttribute("data-msgid"),o=Object(s.getMessage)(e,i.peerId,n);n&&o&&!Object(r.isOut)(o)&&t.push(n)}return t},[]);if(o.length){var l=Math.max(...o);Ji(e,l).then(()=>{l===i.lastmsg&&e.set(e=>Object(n.setActions)(e)).then(()=>t().updateActions(e))})}}(t,f,e));setTimeout((function(){var a=t.get().peer;if(a){if(Ts(t),(Object(s.getCurrentTab)(t).pinned||Object(s.getCurrentTab)(t).top_banner)&&(f().updateChatTopic(a,t),t.set(n.setActions),w.changeActions(t)),Object(s.getCurrentTab)(t).callInProgress&&f().updateBanner(t),t.get().msgid)es(E,e,t.get().msgid,t);else if(!Zi(E,e,f,t,y)){E.scrollBottom(-30);var r=Object(s.getCurrentTab)(t);Object(i.isTabMarkedUnread)(r)&&t.set(e=>Object(n.markDialogRead)(r.peerId,e))}t.get().history_init=!1,Object(s.isCasperChat)(t,a)?y.disable():y.reset(E),ns(t,e),is(t,e),$i(t,f,g,C,y,e,0,E),Object(i.ensureDomHasActions)(e),nav.objLoc.st&&(t.mutate(n.setInplaceSearch.bind(null,nav.objLoc.st,a)),f().startSearch(t))}else y.disable()}),15);var w=Object(ot.mount)(geByClass1("_im_dialog_actions",e),t,f),I=Mn(geByClass1("_im_text_input",e),t,Object(i.isClassicInterface)(t)?o.updateMenu:void 0,(e,t)=>{a.removeDialog(e,t),a.restoreDialogs(e,!0)},f),A=Rn(geByClass1("_im_dialog_actions",e),t,f),M=Qn(e,t,f),k=$n(e,t,()=>({changedMessageSelection:w.changedMessageSelection})),L=Object(Zn.mount)(g);Object(ei.mount)(e,t,f);var P=Ei(e,t,()=>({hidePinned(){Object(ei.pinnedMessageHide)(t,t.get().peer,f,!1)},compensateHistoryHeightChange(e){f().compensateHistoryHeightChange(e)},showPinned(){Object(ei.pinnedMessageUnHide)(t,t.get().peer,f,!1)}}));Object(i.isReservedPeer)(t.get().peer)||t.set(n.restoreHistoryQueue.bind(null,t.get().peer)).then(()=>{Object(i.restoreQueue)(t.get().peer,t.get(),Wi(e)),Gi(e,t,t.get().peer)}),AudioMessagePlayer.events.on("listened",Ls.bind(null,t)),Ri("_im_chat_resize_track",e,u);var N=ds.bind(null,t,e,f),D=us.bind(null,t,e,E,f),x=gs.bind(null,u,t),B=ps.bind(null,f,t,e,E),R=hs.bind(null,f,t,e,E),F=qi.bind(null,t,e),H=i.showEditTimeTooltip.bind(null,t),G=i.showMessageInfoTooltip.bind(null,t),q=as.bind(null,t,N,e,f),W=Ui.bind(null,t,e,E),K=js.bind(null,f,t,E),V=Es.bind(null,t),Y=Ss.bind(null,t,f),z=Ms.bind(null,t,f,e),Q=Ps.bind(null,I,t),X=Hi.bind(null,f),$=i.showCasperExpiringTooltip.bind(null,t,e),J=()=>showWiki({w:"expired_messages"}),Z=Ns.bind(null,t),ee=e=>function(e,t){var a=t.target.closest("._im_call_snippet_join_btn"),n=a.closest("._im_mess_callsnippet"),s=a.dataset.link,r=+n.dataset.peer;Object(i.isCallToPeerAvailable)(e,r)&&Object(i.joinCallFromIm)(e,r,s,!1,i.CALL_ENTRY_POINT_JOIN_SNIPPET)}(t,e),te=Ds.bind(null,t,e),ae=Object(c.createModule)({handlers:(a,r)=>{r(e,"click",i.RESTORE_CLASS,D),r(e,"mouseover click",i.FAILED_CLASS,F),r(e,"mouseover","_im_edit_time",H),r(e,"mouseover","_im_page_info",G),r(e,"click","_im_mess_susp",xi.bind(null,e)),r(e,"click","_im_failed_action",q),r(e,"click","_im_mess_link",W),r(e,"mouseover","_im_admin_name",fs),r(e,"mouseover","_im_mess_srv",V),r(e,"mouseover","im-mess-stack--bomb",$),r(e,"mouseover","mem_pseudolink",e=>function(e,t){var a=e.target.dataset.mention,n=null;switch(!0){case it.MASS_MENTION_ALIASES.all.includes(a):n=getLang("mail_im_mention_all");break;case it.MASS_MENTION_ALIASES.online.includes(a):n=getLang("mail_im_mention_online")}n&&(window.tooltips&&window.tooltips.destroy(e.target),Object(U.showTooltip)(e.target,{shift:[0,5],center:!0,black:1,className:"im-mass-mention-tt",reverseOffset:!0,toup:e.target.getBoundingClientRect().top>Object(i.getHistoryTopIndent)(t)+37,text:n,noZIndex:!0}))}(e,t)),r(e,"mouseover","_im_mess_pinned",te),r(e,"click","im_srv_mess_link",Y),r(e,"click","_im_error",X),r(e,"click","_im_replied_message",z),r(e,"click","_im_replied_author_link",ks),r(e,"click","_chat_invitation",(e,a)=>{if(checkEvent(e))return!0;if(!gpeByClass("wall_postlink_preview_btn",e.target)&&!hasClass(e.target,"wall_postlink_preview_btn"))return!0;var s=geByClass1("flat_button",a),r={invite_chat_id:domData(s,"inv-id"),invite_hash:domData(s,"hash")};Object(i.showInvitationBox)(t,r,n.leaveInvitation),cancelEvent(e)}),r(e,"click","_im_join_call_by_link",i.handleCallLinkClick),r(e,"click","_im_join_cancel",()=>t.get().longpoll.push([Object(d.resetPeer)()])),r(e,"click","_im_retry_media",e=>function(e,t,a){var r=e.get(),o=domClosest("_im_mess",a.target),l=domData(o,"msgid"),c=Object(s.getMessage)(r,r.peer,l),d=e=>t().replaceAttachmentPlaceholders(e,c);c&&(Object(nt.statlogsSendingRetry)("retry_attach"),e.set(n.addAttachmentsToStoreData.bind(null,c,[Object(i.renderMessageMedia)(e,c)])).then(d),e.set(n.loadMedia.bind(null,c)).then(d))}(t,f,e)),r(e,"click",i.MESSAGE_KEYBOARD_BUTTON_CLASS,Q),r(e,"click","_im-call-snippet",Z),r(e,"click","_im_call_snippet_join_btn",ee),a(geByClass1("_im_peer_history_w",e),"mousemove",y.show),a(geByClass1("_im_start_new",e),"click",x),a(e.querySelector("._im_to_end"),"click",B),a(e.querySelector("._im_to_mention"),"click",R),a(geByClass1("_im_cancel_edit",e),"click",()=>(f().cancelEditing(),!1)),a(geByClass1("_im_edit_focus_cur",e),"click",()=>(f().focusEditingMessage(),!1)),rt.screenfull.raw&&a(document,rt.screenfull.raw.fullscreenchange,K),a(window,"im_goToMessage",e=>{var a=intval(e.msgid);if(a)return window.statlogsValueEvent("im_links_to_attachments",1,"to_message"),t.set(n.changePeer.bind(null,e.sel,a,!1)).then(()=>Object(i.focusOnMessage)(t,f().focusOnMessage,t.get().peer,a))}),r(e,"click","im-expired-message--in",J)}});curNotifier.recvClbks.pin_hide=[function(e){e.hide?Object(ei.pinnedMessageHide)(t,e.peer,f,!1):Object(ei.pinnedMessageUnHide)(t,e.peer,f,!1)}],window.showForwardBox=e=>function(e,t){Object(i.boxHandleMessagesLabelsTooltips)(showBox("al_im.php",t,{dark:1}),e)}(t,e);var ne=setInterval(ts.bind(null,t,e,w),1e4);return O(ae,e,E,w,I,f,u,A,M,k,j,t,C,ne,y,P,T,L)}function Fs(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Hs(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Hs(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Hs(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Us=[],Gs=0,qs=!1;function Ws(e){Us=Us.reduce((t,a)=>{var n=Fs(a,2),i=n[0],s=n[1];return s(e)?t:t.concat([[i,s]])},[])}function Ks(e,t){!1===qs&&(qs=!0,document.body.addEventListener("click",Ws,!0)),Us=Us.concat([[e,t]])}function Vs(e){Us=Us.filter(t=>Fs(t,1)[0]!==e),0===Gs&&(document.body.removeEventListener("click",Ws,!0),qs=!1)}function Ys(e,t){Us=Us.map(a=>{var n=Fs(a,2),i=n[0],s=n[1];return i===e?[e,t]:[i,s]})}function zs(e,t){return 0===t.length?t=>(e(t),!0):a=>{var n=t.reduce((e,t)=>e&&!domClosest(t,a.target),!0);return n&&e(a),n}}var Qs=a("XzvV"),Xs=a("e87a"),$s=a("GSQL"),Js=a("CGHU"),Zs=a("8tCR"),er=a("p9ed"),tr=a("RdBX"),ar=a("Aegd"),nr=a("85vT"),ir=a("6krn"),sr=a("5R8M").default,rr=function(e){var t=e.onClose,a=e.contacts,n=e.selectPeer,s=Pt.a.useState(""),r=s[0],o=s[1],l=Pt.a.useState(a),c=l[0],d=l[1],u=Object(Lt.useMemo)((function(){return new tr.vkIndexer(a,(function(e){return[e.name,e.user&&e.user.full_name].filter(Boolean).join(" ")}))}),[a]);Pt.a.useEffect((function(){if(0!==r.length){var e=u.search(r);d(e)}else d(a)}),[r]);return Pt.a.createElement("div",{className:"ContactsListContent"},Pt.a.createElement(Js.BlockSearchInput,{onChange:function(e){return t=e.target.value,void o(t);var t},placeholder:Object(ir.getLang)("mail_top_search"),autoFocus:!0,key:"search",value:r}),0===c.length?Pt.a.createElement(Zs.default,{className:"ContactsListContent__stub",key:"no-results"},Object(ir.getLang)("mail_im_search_empty_contacts")):Pt.a.createElement(xt.Scroll,{className:"ContactsListContent__scroll"},Pt.a.createElement(er.default,{className:"ContactsListContent__list"},c.map((function(e){var a=e.user?e.user.user_id:19e8+e.id,s=Object(i.prepareContactName)(e.name);return Pt.a.createElement(sr,{key:e.id,onClick:function(){return function(e){n(e),t()}(a)},className:"ContactsListContent__contact"},Pt.a.createElement("div",{className:"ContactsListContent__contactAvatar"},e.user?Pt.a.createElement("img",{className:"ContactsListContent__contactAvatarImage",src:e.user.photo,alt:e.name}):Pt.a.createElement(ar.ConversationNoPhoto,{text:Object(i.getUserInitials)(e.name),size:"34",id:a,specificType:7,key:e.id})),Pt.a.createElement("div",{className:"ContactsListContent__contactName"},Pt.a.createElement(nr.default,null,s)))})))))},or=a("QDnf"),lr=function(e){var t=e.onClose,a=e.selectPeer,n=e.getContactsList,i=Pt.a.useState({kind:"loading"}),s=i[0],r=i[1];switch(Pt.a.useEffect((function(){n().then((function(e){r({kind:"loaded",contactsList:e})})).catch((function(e){Object(l.showErrorBox)(Object(ir.getLang)("global_error")),r({kind:"failed",error:e}),t()}))}),[]),s.kind){case"failed":return Pt.a.createElement(Pt.a.Fragment,null);case"loading":return Pt.a.createElement(or.default,null);case"loaded":return Pt.a.createElement(Xs.default,{onClose:t,disableBodyScroll:!0,className:"ContactsList"},Pt.a.createElement($s.default.Header,{title:Object(ir.getLang)("mail_contacts_list"),onClose:t,appearance:"blue"}),Pt.a.createElement("div",{className:"ContactsList__body"},Pt.a.createElement(rr,{contacts:s.contactsList,onClose:t,selectPeer:a})))}};function cr(e,t){var a=dr();Nt.render(Lt.createElement(lr,{onClose:t.closeContactList,getContactsList:()=>function(e){return Object(ot.checkContactListLoaded)(e).then(e=>{var t=e.get().contactsList;return Promise.resolve(t)})}(e),selectPeer:t=>function(e,t){e.get().longpoll.push([Object(d.changePeer)(t,!1,!0,!0,"contacts_list")])}(e,t)}),a)}function dr(){var e=document.getElementById("_im_contacts_list");if(e)return e;var t=document.createElement("section");return t.setAttribute("id","_im_contacts_list"),document.body.appendChild(t),t}function ur(e,t){return{unmount:()=>function(e,t){var a=dr();a&&Nt.unmountComponentAtNode(a),Object(c.destroyModule)(e)}(e),closeContactList(){var e=dr();Nt.unmountComponentAtNode(e)}}}function gr(e){var t=(0,Object(c.createMutations)(ur).bindMutations)(Object(c.createModule)({handlers:(e,t)=>{}}),e);return cr(e,t),t}function mr(){return(mr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function _r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return pr(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return pr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function pr(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var hr=Object(Ca.debounce)(R.statlogsProbValueEvent,1e3);function br(e,t,a,i,r,o,l){var c=trim(o);if(Object(s.isSearchingValue)(e,c)){var d=()=>l.clearSearch(e,t);c?(e.setState({recentSearch:!1}),r.stop()):r.replaceOrAdd(d),cancelStackPush("im_search",d),c&&e.set(e=>Object(n.setCurrentSearch)(c,!1,e)).then(t),i.classList.add("im-page--dialogs-search_fill","_im_d_search"),Object(s.isCommunityInterface)(e)||l.showCancelControl()}else c||(r.stop(),e.set(e=>Object(n.setCurrentSearch)("",!1,e)).then(t),i.classList.remove("im-page--dialogs-search_fill","_im_d_search"),Object(s.isCommunityInterface)(e)||l.hideCancelControl())}function vr(e,t,a){return function(){var n=Object(s.getSearchText)(t);n===e&&a(...arguments)}}function fr(e,t,a){var i=Object(s.getSearchText)(a);return hr(.01,"im_search_stat",1,"search_start"),Object(n.updateSearchQuery)(i),a.setState({recentSearch:!1}),e().toggleSettingsButton(a,!!i),i?(a.get().dialog_search_going=!0,function(e,t,a){var i=vr(e,a,e=>t().appendFastDialogs(a,e));return Object(n.searchTopConv)(e,a.get()).then(e=>(i(e),e))}(i,e,a).then(n=>{var s=n.map(e=>e.peerId);return t(i,e,s,a)}).then(()=>{a.get().dialog_search_going=!1}).catch(()=>{})):(e().restoreDialogs(a,!1,!0),Object(Qs.removeSearchPositionTracker)("messages"),Promise.resolve(!1))}function Or(e,t,a,s){var r=s.get(),o=vr(e,s,e=>t().appendDialogs(s,e)),l=vr(e,s,t().appendSearch);return Object(i.isPendingForward)(s)?Object(n.searchHints)(e,a,"all",{},r).then(o):Promise.all([Object(n.searchHints)(e,a,"all",{},r).then(o),Object(n.searchMessages)(e,r)]).then(e=>{var t=_r(e,2),a=_r(t[1],2),n=a[0],i=a[1];l(s,n,i,!0)})}function Cr(e,t,a){var i=a.target;e.set(e=>Object(n.toggleCommunityMute)(t,e)).then(()=>{i.classList.toggle("im-page--gim-mute_muted",e.get().mute),t&&yr(e,{target:i})})}function yr(e,t){var a=t.target;return Object(U.showTooltip)(a,{text:()=>e.get().mute?Object(fa.getLang)("mail_im_sound_off"):Object(fa.getLang)("mail_im_sound_on"),black:1,shift:[13,9],appendCls:"js-im-page"})}function jr(e,t,a,n,i,r,l,d,u){return{focusInput(){uiSearch.focus(n.parentNode)},hideCancelControl(){a.classList.remove("im-page--dialogs-header-controls_hidden"),t.classList.add("im-dialog-select_hidden"),t.classList.remove("im-dialog-select_rotated")},showCancelControl(){a.classList.add("im-page--dialogs-header-controls_hidden"),t.classList.add("im-dialog-select_rotated"),t.classList.remove("im-dialog-select_hidden")},setSearch(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2]?u:()=>{};n.value=t,br(e,a,0,n,r,t,d())},clearSearch(e,t){cancelStackFilter("im_search"),Object(s.isCommunityInterface)(e)||d().hideCancelControl(),uiSearch.reset(n),e.setState({recentSearch:!1}),br(e,t||(()=>{}),0,n,r,n.value,d())},initPeerTagsFilter(e){Object(o.initPeerTagsFilter)(e)},unmount(){r.stop(),Object(c.destroyModule)(l),uiSearch.destroy(i),cancelStackFilter("im_search")}}}function Er(e,t,a){var r=Object(c.createMutations)(jr),l=r.callMutations,u=r.bindMutations,g=geByClass1("_im_dialogs_header_controls",e),m=geByClass1("_im_create_convo",e),_=geByClass1("_im_create_call",e),p=geByClass1("_im_search_cancel",e),h=ge("im_dialogs_search",e),b=geByClass1("_im_gim_mute",e),v=geByClass1("_im_av_time",e),f=geByClass1("_im_peer_tags_filter_control",e),O=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Gs++,{stop(){Gs--,Vs(e)},replaceOrAdd(a){var n=Us.filter(t=>{var a=Fs(t,1)[0];return e===a}),i=zs(a,t);n.length>0?Ys(e,i):Ks(e,i)}}}("im_search",["_im_search_more","_im_create_convo","_im_create_call","_im_page_dcontent","_im_d_search","_im_dialog"]),C=Object(sa.debouncedPromise)(Or,300),y=e=>fr(a,C,e),j=e=>br(t,y,0,h,O,e,l()),E=()=>l().clearSearch(t,y),S=geByClass1("_im_dialogs_search_input",e);uiSearch.init(S,{onChange:j}),h.value&&setTimeout(()=>j(h.value),0);var T=e=>{Object(U.showTooltip)(e.target,{text:Object(fa.getLang)("mail_admin_av_time"),dir:geByClass1("_im_top_notice")||geByClass1("im-page--dialogs--group-status")?"down":"up",shift:[0,8]})},w=()=>{var e;e=0===t.get().peer||Object(i.isPendingForward)(t)?"search":"default",Object(s.isSearching)(t)||a().toggleSettingsButton(t,!1),t.get().longpoll.push([Object(d.transitionEvent)(e)])},I=()=>{Object(s.isSearching)(t)&&a().toggleSettingsButton(t,!0),function(e,t,a,r,o,l){if(!Object(s.isSearching)(e)){var c=cur.imDb.select(_i.RECENT_SEARCH_OP);if(0!==c.length||Object(s.doPopularSuggExist)(e)){e.setState({recentSearch:!0}),br(e,()=>{Object(s.isSearching)(e)||(r.stop(),o().toggleSettingsButton(e,!1),o().restoreDialogs(e,!1,!0))},0,a,r,"",l);var d=c.filter(t=>!Object(i.isTabLoadedWithMessage)(e.get(),t)),u=c.filter(t=>Object(i.isTabLoadedWithMessage)(e.get(),t)).reduce((t,a)=>(t[a]=Object(s.getTab)(e,a),t),{});e.get().topConvTree.then(t=>{var a=t.list.filter(e=>d.includes(e[0])).reduce((e,t)=>(e[t[0]]=Object(n.localIndexToDialog)(t),e),{}),i=mr({},a,{},u);return o().appendFastDialogs(e,c.map(e=>i[e])),a}).then(t=>Object(n.searchHints)(!1,Object.keys(t),!1,{},e.get())).then(t=>{o().appendDialogs(e,t)})}}}(t,0,h,O,a,l())},A=(e,a)=>{switch(a.dataset.action){case"contacts":gr(t);break;case"favorites":nav.go("/im?box=fav")}},M=Object(c.createModule)({handlers:(n,r)=>{n(p,"click",E),n(p,"mouseover",()=>function(e,t){return Object(U.showTooltip)(t,{appendEl:bodyNode,text:Object(fa.getLang)("mail_cancel"),black:1,shift:[3,-1],appendCls:"js-im-page"})}(0,p)),n(m,"click",()=>a().showCreation(t)),n(_,"click",()=>Object(i.startCallFromIm)(t,null,!1,null,i.CALL_ENTRY_POINT_LIST)),r(e,"click","_im_search_more_action",A),v&&n(v,"mouseover",T),Object(s.isCommunityInterface)(t)&&b&&(n(b,"click",e=>Cr(t,!0,e)),n(b,"mouseover",e=>yr(t,e))),n(h,"click",I),n(h,"blur",w),n(h,"focus",()=>{t.get().longpoll.push([Object(d.transitionEvent)("search")])}),Object(s.isCommunityInterface)(t)&&f&&(r(e,"change","_im_peer_tags_filter_checkbox",e=>Object(o.onPeerTagsFilterCheckboxChange)(e,t)),r(e,"click","_im_peer_tags_filter_pane_item",e=>Object(o.onPeerTagsFilterPaneItemClick)(e,t)))}});return Object(s.isCommunityInterface)(t)&&(f?Object(o.initPeerTagsFilter)(t):b&&Cr(t,!1,{target:b})),u(e,p,g,h,S,O,M,l,y)}function Sr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Tr(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Tr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Tr(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function wr(e,t,a,s){if(!e.loading&&!e.all&&a.scrollTop+window.innerHeight-a.scrollHeight>-300){var r=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,Object(i.wrapLoading)(r)(Object(n.loadSpam)(e.offset,s.get().gid).then(t=>{var a=Sr(t,4),o=(a[0],a[1]),l=(a[2],a[3]);e.all=l.all,e.offset=l.offset,e.all?addClass(r,"im-important_all"):e.loading=!1,s.set(n.mergeTabs.bind(null,Object(i.tabFromIds)(l.msgs,l.hash)));var c=ce("div");c.innerHTML=o,r.appendChild(c),Object(i.ensureDomHasActions)(r)}),"bottom")}}function Ir(e,t){var a=t.get().selectedMessages,n=geByClass1("_im_spam_box",e.bodyNode),s=geByClass1("ui_tab_sel",e.bodyNode);if(a.length>0){var r=getLang("mail_selected",a.length);r=r.replace("{count}",a.length),val(s,r+`<button aria-label="${getLang("mail_deselect_all")}" type="button" class="im-deselect ${i.DESELECT_ALL_CLASS}"></button>`)}else val(s,getLang("mail_spam"));0===a.length?removeClass(n,"im-important-box_with-sel"):(addClass(n,"im-important-box_with-sel"),val(geByClass1("_im_spam_not_spam"),getLang("mail_im_mark_notspam",a.length)),val(geByClass1("_im_spam_spam"),getLang("mail_im_mark_delspam",a.length)))}function Ar(e,t,a){var i=e.get().selectedMessages;e.set(n.cleanSelected).then(a.cleanSelection.bind(null,i)).then(a=>Ir(t,e))}function Mr(e,t,a,s){var r=gpeByClass("_im_mess",s,t);if(r){var o=intval(domData(r,"msgid"));r&&(Object(n.removeMessageSend)([o],0,e.get().tabs[0].hash,"undel",e.get()),Object(i.restoreMessage)(o,0,t))}}function kr(e,t,a){var s=e.get().selectedMessages;Object(n.removeMessageSend)(s,0,e.get().tabs[0].hash,"delete",e.get()),Object(i.removeMessagesWithRestore)(s,0,"delete",t),Ar(e,t,a)}function Lr(e,t,a){var s=e.get().selectedMessages;Object(n.removeMessageSend)(s,0,e.get().tabs[0].hash,"nospam",e.get()),s.map(e=>geByClass1("_im_mess_"+e)).filter(e=>e).forEach(e=>{var t=intval(domData(e,"peer")),a=intval(domData(e,"msgid"));val(e,Object(i.renderGoTo)(t,a)),addClass(e,"im-mess_light")}),Ar(e,t,a)}function Pr(e,t,a,n,i){var s=gpeByClass("_im_mess",i,t.bodyNode),r=intval(domData(s,"peer")),o=intval(domData(s,"msgid"));return t.hide(),a().unmount(),e.get().longpoll.push([Object(d.changePeer)(r,o)]),Object(Ut.stopEvent)(n),cancelEvent(n),!1}function Nr(e,t,a,i){var s=Object(ct.showFastBox)({title:getLang("mail_deleteall1"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_delete_all_spam"),getLang("mail_delete"),()=>{Object(n.flushSpam)(e,i).then(e=>{var t=Sr(e,2),a=(t[0],t[1]);showDoneBox(a)}),s.hide(),t.hide(),a().unmount()},getLang("mail_close"),()=>s.hide())}function Dr(e,t){return{unmount(){t.unmount(),Object(c.destroyModule)(e)}}}function xr(e,t,a){var n=ge("box_layer_wrap"),s=Object(c.createMutations)(Dr),r=s.callMutations,o=s.bindMutations,l=Object(h.default)({peer:0,oCache:{},tabs:Object(i.tabFromIds)(a.msgs,a.hash),gid:t.get().gid}),d=wr.bind(null,{all:a.all,loading:!1,offset:a.offset},e,n,l),u=Mr.bind(null,l,e.bodyNode),g=Pr.bind(null,t,e,r),m=Nr.bind(null,a.hash,e,r,t.get().gid),_=$n(e.bodyNode,l,t=>({changedMessageSelection:Ir.bind(null,e)})),p=kr.bind(null,l,e.bodyNode,_),b=Lr.bind(null,l,e.bodyNode,_),v=Ar.bind(null,l,e,_);return Object(i.ensureDomHasActions)(e.bodyNode),o(Object(c.createModule)({handlers:(t,a)=>{t(n,"scroll",d),t(geByClass1("_im_spam_spam",e.bodyNode),"click",p),t(geByClass1("_im_spam_not_spam",e.bodyNode),"click",b),t(geByClass1("_im_spam_flush",e.bodyNode),"click",m),a(e.bodyNode,"click","_im_mess_restore",u),a(e.bodyNode,"click","_im_go_to",g),a(e.bodyNode,"click",i.DESELECT_ALL_CLASS,v)}}),_)}function Br(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"im_settings",t={sound:ls.get("sound_notify_off")?getLang("mail_im_sound_off"):getLang("mail_im_sound_on")};return window.pushNotifier&&window.pushNotifier.loadEndpoint()||Object(W.partConfigEnabled)("push_notifier")&&ls.get("im_ui_notify_off")?t.browser=getLang("mail_notification_settings"):t.browser=Fr()?getLang("mail_im_notifications_on"):getLang("mail_im_notifications_off"),getTemplate(e,t)}function Rr(e,t){Object(U.showTooltip)(t.target,{content:Br("im_settings_pop"),dir:"down",shift:[220,9],hasover:!0,showdt:10})}function Fr(){return DesktopNotifications.supported()&&!DesktopNotifications.checkPermission()&&!ls.get("im_ui_notify_off")}function Hr(e,t,a,n,s){var r=domData(s,"action"),o=gpeByClass("_im_settings_menu",s),l=hasClass(o,"_im_settings_popup")?"im_settings_pop":"im_settings";switch(r){case"spam":Object(i.showSpamLayer)(e,xr,n);break;case"sound":ls.get("sound_notify_off")?ls.set("sound_notify_off",0):ls.set("sound_notify_off",1),o.outerHTML=Br(l);break;case"browser":Fr()?(ls.set("im_ui_notify_off",1),o.outerHTML=Br(l),Object(nt.statlogsBrowserNotificationsOff)()):DesktopNotifications.checkPermission()?DesktopNotifications.requestPermission(()=>{o.parentNode&&(o.outerHTML=Br(l))}):Object(W.partConfigEnabled)("push_notifier")?nav.go("/settings?act=notify"):(ls.set("im_ui_notify_off",0),o.outerHTML=Br(l),Object(nt.statlogsBrowserNotificationsOn)())}}function Ur(e,t,a){var r=Rr.bind(null,t),o=Hr.bind(null,t,a,e),l=function(e,s){if(Object(i.showUnreadOnly)(t,a,n.changeDialogsTab)){var r=t.get().active_tab===p.FOLDER_UNREAD;val(s,getTemplate("im_filter",{filter:r?getLang("mail_to_all_dialogs"):getLang("mail_to_unread")}))}},d=Object(c.createModule)({handlers:(t,a)=>{a(e,"mouseover","_im_dialogs_cog_settings",r),a(e,"click","_im_settings_action",o),a(e,"click","_im_to_unread",l)}});return function(e,t){return{updateFilter(t){var a,n=t.get().active_tab===p.FOLDER_UNREAD,i=[];Object(s.isSearching)(t)&&i.push("im-page--dialogs-filter_hidden"),t.get().unread_cnt>0?a=n?getLang("mail_to_all_dialogs"):getLang("mail_to_unread"):(a=getLang("mail_all_dialogs"),i.push("im-page--dialogs-filter_disabled")),val(geByClass1("_im_to_unread",e),getTemplate("im_filter",{filter:a,cls:i.join(" ")}))},toggleButton(t,a){var n=geByClass1("im-page--dialogs-filter",e);toggleClass(n,"im-page--dialogs-filter_hidden",a)},toggleLoader(t,a){var n=geByClass1("_im_dialogs_cog_settings",e);toggleClass(n,"im-page--dialogs-settings_loading",a)},updateSettings(t){geByClass1("_im_settings_menu",e).outerHTML=Br()},unmount(){Object(c.destroyModule)(t)}}}(e,d)}var Gr=a("iukX"),qr=a("amDN");function Wr(e,t){return t.selection||(t.selection=[]),t.selection.push(e),Promise.resolve(t)}function Kr(e){return e.selection=[],Promise.resolve(e)}function Vr(e,t){return t.selection=t.selection.filter(t=>t.id!==e),Promise.resolve(t)}function Yr(e,t,a,n,i,s,r){var o=intval(domData(r,"peer"));tooltips.hide(r),t.set(Vr.bind(null,o)).then(s=>{Qr(e,n,t,i),a().selectionDeleted(t,o)})}function zr(e,t,a,i){e.set(n.setCurrentSearch.bind(null,a,!1)).then(t().onChange)}function Qr(e,t,a,n){var i=a.get().selection,s=uiSearch.getFieldEl(e);uiSearch.focus(e),i.length>0?attr(s,"placeholder",""):attr(s,"placeholder",unclean(Object(fa.getLang)("mail_search_creation"))),t.innerHTML=i.map(e=>`<div class="token">\n      <div class="token_title">${e.name}</div>\n      <div data-peer="${e.id}" class="token_del _ui_multiselect_cancel"></div>\n    </div>`).join(""),toggleClass(e,"ui_multiselect_has_selection",i.length>0),domFC(e).scrollTop+=50,n()}function Xr(e,t){return Object(U.showTooltip)(t,{text:Object(fa.getLang)("mail_create_chat_remove_user"),black:1,shift:[15,8],appendParentCls:"_wrap"})}function $r(e,t,a){uiSearch.init(e,{onChange:zr.bind(null,t,a)});var n=uiSearch.getFieldEl(e),i=ce("div",{className:"_ui_multiselection ui_multiselect_cnt"});n&&n.parentNode.insertBefore(i,n);var s,r,o=(s=n,r=0,function(){var e=s.offsetWidth;setStyle(s,{width:1});var t=s.offsetLeft;r!==t?(r=t,e=s.parentNode.offsetWidth,setStyle(s,{width:Math.max(30,e-t-20)})):setStyle(s,{width:e})});t.set(Kr);var l=Yr.bind(null,e,t,a,i,o),d=t=>{document.activeElement!==n&&uiSearch.focus(e)},u=Object(c.createModule)({handlers:(t,a)=>{a(e,"click","_ui_multiselect_cancel",l),a(e,"mouseover","_ui_multiselect_cancel",Xr),t(e,"click",d)}});return{addSelection:(a,n)=>t.set(Wr.bind(null,{id:a,name:n})).then(Qr.bind(null,e,i,t,o)),removeSelection:a=>t.set(Vr.bind(null,a)).then(Qr.bind(null,e,i,t,o)),resetSelection(){!function(e,t,a,n){e.set(Kr).then(Qr.bind(null,t,a,e,n))}(t,e,i,o)},focus(){uiSearch.focus(e)},save(){t.stash(),Qr(e,i,t,o)},restore(){t.pop(),Qr(e,i,t,o)},unmount(){uiSearch.destroy(e),Object(c.destroyModule)(u)}}}var Jr=a("v+DW"),Zr=a("zjLC"),eo="_im_dialogs_creation_name",to="_im_create_select",ao=["im-creation--item_hovered"],no=0;function io(e){!function(e){var t=e.querySelector("._im_creation_settings_modal_wrap"),a=so.bind(null,t);Nt.render(Lt.createElement(Xs.default,{onClose:a,className:"im-creation--modal-settings"},Lt.createElement(qr.default,{title:Object(fa.getLang)("mail_chat_creation_settings"),onCloseClick:a}),Lt.createElement(Gr.ChatSettingsOptions,{flags:no,back:a,isChatCreation:!0,onSave:ro,afterSave:oo.bind(null,t),onCancel:a})),t)}(e)}function so(e){e&&Nt.unmountComponentAtNode(e)}function ro(e){return no=e,Promise.resolve()}function oo(e){so(e)}function lo(e){return Object(U.showTooltip)(e,{text:Object(fa.getLang)("mail_chat_creation_settings_icon_tooltip"),black:1,center:!0,zIndex:1e3,shift:[0,10]})}function co(e,t,a,i,s,r){Object(n.toggleConversation)(!1),removeClass(t,"im-create_shown"),removeClass(t,"im-create_photo-attached"),setTimeout(go.bind(null,t,!1),100),bo(r).map(e=>geByClass1("_im_dialog"+e)).forEach(e=>{removeClass(e,"olist_item_wrap_on")}),a().createCanceled(e),s.resetSelection(),"add_member"===e.get().creationType&&e.set(n.setCreationType.bind(null,"chat",[])),e.set(n.presetAvatar.bind(null,!1));var o=geByClass1("_im_avatar_img",t);mo(e,r,t),uiSearch.reset(geByClass1(eo,t)),uiSearch.reset(geByClass1(to,t)),o&&o.parentNode.removeChild(o),mo(e,r,t),cancelStackFilter("im_search");var l=0===e.get().peer?"search":"default";e.get().longpoll.push([Object(d.transitionEvent)(l)]),attr(t,"aria-hidden","true")}function uo(e,t,a){return t&&(a.current_create_peer_ids={},a.current_create_peers=[]),a.current_create_peer_ids||(a.current_create_peer_ids={}),a.current_create_peers||(a.current_create_peers=[]),e.forEach(e=>{e.then(e=>{e=e.filter(e=>!a.current_create_peer_ids[e.peerId]),a.current_create_peer_ids=e.reduce((e,t)=>(e[t.peerId]=!0,e),a.current_create_peer_ids),a.current_create_peers=a.current_create_peers.concat(e)})}),Promise.resolve(a)}function go(e,t){toggleClass(e,"im-create_material",t)}function mo(e,t,a){var n=geByClass1("_im_confirm_creation",a),i=t.get().selection.length,s="add_member"===e.get().creationType,r=i>0,o=uiSearch.getFieldEl(geByClass1(eo,a)).value.length>0,l=!r&&(s||!o),c=s?1===i?Object(fa.getLang)("mail_append_chat"):Object(fa.getLang)("mail_im_create_chat_with"):o||i>1?Object(fa.getLang)("mail_im_create_chat"):Object(fa.getLang)("mail_im_go_to_dialog");val(n,c),toggleClass(n,"button_disabled",l)}function _o(e,t,a,n,i,s,r){if(r){var o,l=intval(domData(r,"list-id")),c=bo(s),d=trim(r.textContent),u=geByClass1(to,t),g=getSize(u)[1];inArray(l,c)?(o=n.removeSelection(l,d),removeClass(r,"olist_item_wrap_on")):(o=n.addSelection(l,d),addClass(r,"olist_item_wrap_on")),o.then(()=>{var e=g-getSize(u)[1],t=i.scrollTop();i.scrollTop(t-e)}),mo(e,s,t);var m=geByClass1(to,t);uiSearch.reset(m)}}function po(e,t){var a=bo(e),n=["_im_dialog","_im_dialog"+t.peerId,"im-creation--item"],i=[];return t.online&&i.push("online"),mobPlatforms[t.online]&&i.push("mobile"),inArray(t.peerId,a)&&n.push("olist_item_wrap_on"),getTemplate("im_owner_item",{owner_id:t.peerId,cls:" "+n.join(" "),photo:t.photo,name:t.name,link:t.href,img_cls:i.join(" ")})}function ho(e){return Object(s.getSearchText)(e)||!1}function bo(e){return e.get().selection.map(e=>e.id)}function vo(e,t,a){return e.then(e=>e.filter(e=>e.is_friend&&!inArray(e.peerId,a.get().creationFilter)))}function fo(e,t,a,i,s){var r,o,l=geByClass1(to,e),c=Object(n.searchLocalHints)(i,t.get()),d=a.hoverFirstElement.bind(a,ao,So(t));t.get().creation_shown_all=!1,a.reset(),a.pipe(vo(c,0,t),i),a.toTop(),i?(o=Object(n.searchTopConv)(i,t.get()),r=Object(n.searchHintsIndex)(i,[],"friends",t.get()),a.pipe(vo(r,0,t),i).then(d),a.pipe(vo(o,0,t),i).then(d)):(r=Promise.resolve([]),o=Promise.resolve([])),t.set(uo.bind(null,[c,o,r],!0)),uiSearch.showProgress(l),Promise.all([c,r,o]).then(()=>uiSearch.hideProgress(l))}function Oo(e,t,a,i){var s=2e9+Math.round(rand(1e6,2e6));cur.recieveCropResult=a=>{cur.recieveCropResult=!1,curBox()&&curBox().hide(),e.set(n.presetAvatar.bind(null,a)),Object(n.getOwnerPhoto)(a,s).then(e=>{geByClass1("_im_create_avatar",t).appendChild(ce("img",{className:"im-chat-placeholder--img _im_avatar_img",src:e}))}),addClass(t,"im-create_photo-attached")},Page.ownerPhoto(s)}function Co(e,t){geByClass1("_im_create_avatar",t).innerHTML="",e.set(n.presetAvatar.bind(null,!1)),removeClass(t,"im-create_photo-attached")}function yo(e,t,a,n,i,s){bo(t).map(e=>geByClass1("_im_dialog"+e)).forEach(e=>removeClass(e,"olist_item_wrap_on")),t.reset(),fo(a,e,n,!1,bo(t)),i.resetSelection(),co(e,a,s,0,i,t)}function jo(e,t,a,i,r,o,l){var c=bo(t),u=e.get(),g=geByClass1("_im_confirm_creation",a),m=uiSearch.getFieldEl(geByClass1(eo,a)).value,_="add_member"===e.get().creationType,p=!_&&(m.length||c.length>1),h=geByClass1("_im_creation_show_history_input",a).checked;if(_)return e.set(n.addNewMember.bind(null,u.peer,c,h)).catch(e=>Object(ct.showFastBox)(Object(fa.getLang)("global_error"),e)),co(e,a,o,0,r,t);if(Object(Jr.lockButton)(g),!p)return b(c[0]);function b(n){no=0,yo(e,t,a,i,r,o),function(e,t,a,n,i,s){co(e,t,a,0,i,s),e.get().longpoll.push([Object(d.changePeer)(n,!1,!1,!1,"create_conversation")])}(e,a,o,n,r,t),Object(Jr.unlockButton)(g),Object(s.isSearching)(e)?o().cancelSearch(e):o().restoreDialogs(e)}e.set(e=>Object(Zr.createChatAction)(e,u.next_chat_avatar,c,m,no)).then(()=>b(u.next_peer)).catch(e=>{Object(Jr.unlockButton)(g),topMsg(Object(fa.getLang)("global_unknown_error"),2,"#FFB4A3")})}function Eo(e,t){return Object(U.showTooltip)(e,{text:Object(fa.getLang)("mail_cancel"),black:1,zIndex:1e3,shift:[3,-2],appendCls:"js-im-page"})}function So(e,t){var a=t&&t.get().selection.length;return{top:-1,bottom:Object(i.isClassicInterface)(e)?a>0?69:0:-1}}function To(e,t,a){mo(e,t,a)}function wo(e,t,a,n,i,s,r,o){return{show(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.setState({shown:!0}),go(e,!0),cancelStackPush("im_create",r),addClass(e,"im-create_shown");var o=n.get().selection.reduce((e,t)=>(e[t.id]=!0,e),{});s&&s.forEach(t=>{if(!o[t[0]]){var a=e.querySelector("._im_dialog"+t[0]);i.addSelection(t[0],t[1]),a&&!a.classList.contains("olist_item_wrap_on")&&a.classList.add("olist_item_wrap_on")}}),function(e,t,a,n){toggleClass(e,"im-create_chat","chat"===n.get().creationType),toggleClass(e,"im-create_invite","add_member"===n.get().creationType);var i="chat"===n.get().creationType?Object(fa.getLang)("mail_im_group_dialog"):Object(fa.getLang)("mail_im_friends_tab"),s=geByClass1("_im_create_title",e);val(s,i),val(geByClass1("_im_confirm_creation",e),"add_member"===n.get().creationType?Object(fa.getLang)("mail_im_create_chat_with"):Object(fa.getLang)("mail_im_create_chat")),fo(e,n,t,!1,a.get().selection.map(e=>e.id))}(e,a,n,t),setTimeout(()=>{t.get().longpoll.push([Object(d.transitionEvent)("create")]),attr(e,"aria-hidden","false"),i.focus()},1)},focusSearch(e){i.focus()},confirmCreate(e){o()},hide(a){a.get().shown=!1,co(a,e,t,0,i,n)},scroll(e){a.scrollPage(e,!0)},updateScroll(){a.updateScroll()},selectElement(t){_o(t,e,0,i,a,n,a.getHoveredElement())},hoverPrevElement(e){a.hoverPrevElement(ao,null,So(e,n))},hoverNextElement(e){a.hoverNextElement(ao,null,So(e,n))},unmount(){Object(c.destroyModule)(s),a.unmount(),i.unmount(),cancelStackFilter("im_create"),cur.recieveCropResult=void 0}}}function Io(e,t,a){var i=Object(h.default)({selection:[]}),s=x(geByClass1("_im_create_list",e),Object(h.default)({offset:0,limit:100,elements:[],elCls:"_im_dialog"}),()=>({idFn:e=>intval(e.peerId),hoverableFn:e=>hasClass(e,"_im_dialog"),renderFn:po.bind(null,i),more(e,a){var s;return t.get().shown?(t.get().creation_shown_all||!1!==ho(i)?s=Promise.resolve([]):(t.get().creation_shown_all=!0,s=Object(n.searchTopConv)(ho(i),t.get())),t.set(uo.bind(null,[s],!1)),vo(s,ho(i),t)):Promise.resolve(!1)},onClick(a,n){checkEvent(a)||(_o(t,e,0,d,s,i,n),cancelEvent(a))}}));t.get().creationQuery=!1,t.get().creationType="chat";var r=geByClass1(to,e),o=Object(sa.debouncedPromise)(a=>function(e,t,a,n){var i=n.get(),s=ho(i);i.selection.map(e=>e.id),a.unhoverElements(ao),e.get().creationQuery=s,fo(t,e,a,s)}(t,e,s,a),300),d=$r(r,i,()=>({selectionDeleted(a,n){mo(t,a,e),removeClass(geByClass1("_im_dialog"+n),"olist_item_wrap_on")},onChange:o})),u=co.bind(null,t,e,a,"cross",d,i),g=Oo.bind(null,t,e),m=Co.bind(null,t,e),_=yo.bind(null,t,i,e,s,d,a),p=jo.bind(null,t,i,e,s,d,a),b=To.bind(null,t,i,e),v=io.bind(null,e),f=geByClass1("_im_create_cancel",e),O=geByClass1(eo,e),C=geByClass1("_im_creation_settings",e),y=O.querySelector(".ui_search_reset"),j=Object(c.createModule)({handlers:(t,a)=>{t(f,"click",u),t(f,"mouseover",Eo.bind(null,f)),t(geByClass1("_im_create_avatar",e),"click",g),t(geByClass1("_im_create_remove_avatar",e),"click",m),t(geByClass1("_im_cancel_creation",e),"click",_),t(O,"change",b),t(O,"input",b),t(O,"paste",b),t(y,"click",b),t(geByClass1("_im_confirm_creation",e),"click",p),t(C,"click",v),t(C,"mouseenter",lo.bind(null,C)),t(e,"mouseover",Object(l.throttle)(s.unhoverElements.bind(s,ao),100))}});return wo(e,a,s,i,d,j,u,p)}var Ao=a("1MUc"),Mo=a("hGJG");function ko(){var e="_im_create_chat_container",t=document.getElementById(e);if(t)return t;var a=document.createElement("section");return a.id=e,document.body.appendChild(a),a}function Lo(e,t,a){return{show:a,unmount:function(){var e=ko();e&&Dt.a.unmountComponentAtNode(e),Object(c.destroyModule)(t)},closeCreateConvoPopup:function(){var e=ko();Dt.a.unmountComponentAtNode(e),Object(n.toggleConversation)(!1)}}}function Po(e){var t=Object(c.createModule)({handlers:function(){}}),a=(0,Object(c.createMutations)(Lo).bindMutations)(t,e),n=function(t){var n;null===(n=e.get().longpoll)||void 0===n||n.push([Object(d.changePeer)(t,!1,!1,!1,"create_conversation")]),a.closeCreateConvoPopup()},i=function(t){var n;null===(n=e.get().longpoll)||void 0===n||n.push([Object(d.changePeer)(t,!1,!0,!0)]),a.closeCreateConvoPopup()},s=a.closeCreateConvoPopup;return Lo(0,t,(function(){return function(e,t,a,n){var i=ko();Dt.a.render(Pt.a.createElement(Ao.ChatCreation,{store:e,uploadAvatar:Mo.uploadConvoPhoto,onClose:t,onCreateChat:a,onGoToConvo:n}),i)}(e,s,n,i)}))}var No=a("9KdC");function Do(e,t){return t.state=e,Promise.resolve(t)}function xo(e,t,a,n,s){switch(t){case p.ARROW_UP:Object(i.isEditableFocused)()||(n.scroll(s,"up"),cancelEvent(a));break;case p.ARROW_DOWN:Object(i.isEditableFocused)()||(n.scroll(s,"down"),cancelEvent(a));break;case p.PAGE_UP:a.ctrlKey||Object(i.isClassicInterface)(s)||(n.scroll(s,"up",!0),cancelEvent(a));break;case p.PAGE_DOWN:a.ctrlKey||Object(i.isClassicInterface)(s)||(n.scroll(s,"down",!0),cancelEvent(a));break;case p.HOME:Object(i.isEditableFocused)()||(n.scroll(s,"up",!1,!0),cancelEvent(a));break;case p.END_KEY:Object(i.isEditableFocused)()||(n.scroll(s,"down",!1,!0),cancelEvent(a));break;case p.PRINTABLE:n.focustTxt(e)}}function Bo(e,t,a,n,s,r){var o=Object(h.default)({state:t||"default"});return{signal(t,l){if(!(cur.storyLayer||cur.articleEditorLayer||window.isArticleLayerOpen()))switch(o.get().state){case"default":return xo(o,t,l,n,e);case"fwd":case"search":return function(e,t,a,n,s,r){switch(t){case p.ARROW_DOWN:n.hoverNextDialog(r),cancelEvent(a);break;case p.ARROW_UP:n.hoverPrevDialog(r),cancelEvent(a);break;case p.ENTER:Object(i.isEditableFocused)()&&!gpeByClass("_im_dialogs_search_input",document.activeElement)||n.selectHoveredDialog(r);break;case p.PRINTABLE:s.focusInput()}}(0,t,l,a,s,e);case"create":return function(e,t,a,n,s){switch(t){case p.PAGE_UP:!a.ctrlKey&&Object(i.isClassicInterface)(s)&&(n.scroll("up"),cancelEvent(a));break;case p.PAGE_DOWN:!a.ctrlKey&&Object(i.isClassicInterface)(s)&&(n.scroll("down"),cancelEvent(a));break;case p.ARROW_DOWN:n.hoverNextElement(s);break;case p.ARROW_UP:n.hoverPrevElement(s);break;case p.ENTER:gpeByClass("_im_dialogs_creation_name",document.activeElement)?n.confirmCreate(s):gpeByClass("im-create--search",document.activeElement)&&n.selectElement(s);break;case p.PRINTABLE:n.focusSearch(s)}}(0,t,l,r,e);case"message":return function(e,t,a,n,i){switch(t){case p.HOME:case p.END_KEY:n.isEmpty(i)&&xo(e,t,a,n,i);break;case p.PAGE_UP:case p.PAGE_DOWN:xo(e,t,a,n,i)}}(o,t,l,n,e);default:throw new Error("Unknown state: "+o.get().state)}},transition:e=>o.set(Do.bind(null,e))}}var Ro=a("ER42"),Fo=a("nJdr"),Ho=a("V1Nw"),Uo=a("ERyv");function Go(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return qo(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return qo(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function qo(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Wo={},Ko=Date.now();function Vo(e,t){var a=Math.floor(t.status/100);t.status&&e.stat&&(t.status>=500&&t.status<600&&statlogsValueEvent("im_longpoll",1,a+"0x",t.getResponseHeader("x-frontend")),Wo[a]=Wo[a]?Wo[a]+1:1,Date.now()-Ko>=3e4&&(Object.keys(Wo).forEach(e=>{statlogsValueEvent("im_longpoll",Wo[e],e+"0x",t.getResponseHeader("x-frontend"))}),Wo={},Ko=Date.now()))}function Yo(e,t){return Promise.resolve(extend({},t,{timeout:e<64?2*e:e}))}function zo(e,t){return Promise.resolve(extend({},t,{imTs:e}))}function Qo(e){e.set(e=>Promise.resolve(extend({},e,{stopped:!0}))).then(()=>{e.get().cancelToken()})}function Xo(e,t){return t.cancelToken=e,Promise.resolve(t)}function $o(e,t){return t.pauses||(t.pauses=[]),t.pauses.push(e),Promise.resolve(t)}function Jo(e){return e.pauses||(e.pauses=[]),Object(l.lplog)("Aborting all pauses","error"),e.pauses.forEach(e=>e()),e.pauses=[],Promise.resolve(e)}function Zo(e,t,a,i){var s=i.failed?Object(sa.abortablePause)(4,e):{},r=s.abort,o=s.pause;switch(i.failed){case 1:return Object(l.lplog)("Old timestamp, init resync","error"),e.set($o.bind(null,r)),a([B.resyncEvent()]),e.set(n.loadLongPollTs).then(o).then(el.bind(null,e,t,a));case 2:return Object(l.lplog)("Key is incorrect","error"),e.set($o.bind(null,r)),e.set(n.loadLongPollKey).then(o).then(el.bind(null,e,t,a));case 3:throw Object(Uo.imWeirdLog)("im_longpoll_force_reload",i,!1),nav.reload({force:!0}),new Error("ts is very wrong");default:return e.set(zo.bind(null,i.ts)).then(()=>i)}}function el(e,t,a){if(e.get().stopped)return Promise.resolve({updates:[]});if(t())return Promise.reject(new Error("pause"));var n=e.get(),i=`${n.imUrl}/${n.imPart}`,s=Object(Ro.plaingetCancelable)(i,{act:"a_check",key:n.imKey,version:14,ts:n.imTs,wait:25,mode:n.mode}),r=s.request,o=s.cancel;return e.set(Xo.bind(null,o)).then(()=>r).then(t=>{var a=Go(t,2),i=a[0],s=a[1];return s&&Vo(n,s),e.set(Yo.bind(null,1)),JSON.parse(i)}).catch(e=>{var t=Go(e,2),a=(t[0],t[1]);return a&&Vo(n,a),Promise.reject(new Error(""))}).then(Zo.bind(null,e,t,a))}function tl(e){var t=e.id,a=e.gid,n=e.key,i=e.ts,s=e.url,r=e.lhost,o=e.lpstat,c=new EventEmitter,d=window.vk.lpConfig&&window.vk.lpConfig.enabled&&window.longpollTesting_onImEvents,u=ba((function(e,t){return d&&window.longpollTesting_onImEvents(t),c.trigger("data",t),Promise.resolve({})})),g=u.pause,m=u.resume,_=u.pushMessage,p=u.isPaused,b=u.reset,v=Object(h.default)({id:t,gid:a,mode:202,timeout:1,imKey:n,imTs:i,imPart:s,imUrl:r,pause:!1,stat:o});return function e(t,a,n){t.get().stopped||(Object(l.lplog)("New request"),el(t,n,a).then(e=>e.map(B.constructEvent)).then(e=>(Object(l.lplog)("Request success","success"),e)).then(a).catch(e=>{if(!t.get().stopped)return Object(l.lplog)("Error, waiting: "+(e.message||"no message (probably browser reset)"),"error"),t.set(Yo.bind(null,n()?2:t.get().timeout)).then(()=>{var e=Object(sa.abortablePause)(t.get().timeout,t),a=e.abort,n=e.pause;return t.set($o.bind(null,a)).then(n)});Object(l.lplog)("Stopped longpoll")}).then(e.bind(null,t,a,n)))}(v,_.bind(null,"main"),p.bind(null,"main")),{onData:e=>c.on("data",e),offData:e=>c.off("data",e),abortWaiting:()=>v.set(Jo),stop:Qo.bind(null,v),pause:g.bind(null,"main"),resume:m.bind(null,"main"),reset:b.bind(null,"main"),push:e=>c.trigger("data",e),isEnabled:()=>!v.get().pause&&!v.get().stopped}}var al=new Map,nl=!1;function il(e){return e.queue||e.key}function sl(){al.forEach((e,t)=>{var a=e.onData,n=e.onUpdateKey,i=e.ts;(function(e){return!!window.curNotifier&&!curNotifier.addQueues[il(e)]})(t)&&Notifier.addKey(extend(t,{ts:i}),ll.bind(null,a,n,t))})}function rl(){nl||(nl=setInterval(sl,3e3))}function ol(e){!function(e){if(!window.curNotifier)return!1;delete curNotifier.addQueues[il(e)]}(e),al.delete(e),0===al.size&&(clearInterval(nl),nl=!1)}function ll(e,t,a,n,i){if(i.failed)return ol(a),void function(e,t,a,n){var i;switch(e){case 1:case 2:case 3:case 5:i=n(t,e);break;case 4:i=Object(sa.pause)(1).then(()=>t);break;default:throw new Error("Unkonwn error from queue: "+e)}Object(sa.pause)(3).then(()=>i).then(e=>{al.set(e,{onUpdateKey:n,onData:a,ts:e.ts}),sl(),rl()})}(i.err,a,e,t);al.set(a,{onData:e,onUpdateKey:t,ts:intval(i.ts)}),i.events.map(e=>e.split("<!>")).forEach(e)}var cl=a("PEW9"),dl=Object.values(cl.ConvoListFolder);function ul(e){var t=e.get().tabbedPeers.map(t=>e.get().tabs[t.peer]||e.get().mapped_index&&e.get().mapped_index[t.peer]).filter(e=>e).filter(e=>!e.deletedDialog).map(e=>({type:"peer",peer:e.peerId}));return t.length>0&&(t=[{type:"sep"}].concat(t)),t}function gl(e,t){if("sep"===t.type)return getTemplate("im_right_menu_sep",{});var a=`${Object(i.getBaseLink)(e)}?sel=${t.peer}&tab=${e.get().active_tab}`,n=Object(i.getBareTab)(t.peer,e),s=Object(i.isContactPeer)(t.peer)?Object(i.prepareContactName)(n.tab):n.tab,r="";switch(!0){case n.unread>0:r=n.unread;break;case Object(i.isTabMarkedUnread)(n):r=1}return s=getTemplate("im_right_menu_ct",{name:s,count:r}),getTemplate("im_right_menu_tpl",{href:a,label:s,peer:t.peer,attrs:`title="${stripHTML(n.tab)}"`,cls:n.unread>0?"im-right-menu--unread":""})}function ml(e,t,a,i){var s=gpeByClass("_im_peer_tab",i),r=intval(domData(s,"list-id")),o=e.get().tabbedPeers.filter(e=>e.peer!==r);return e.set(n.updateTabbedPeers.bind(null,o,!0)).then(()=>{if(_l(t,e),r===e.get().peer)e.get().longpoll.push([Object(d.resetPeer)()]);else if(0!==e.get().peer){var a=gpeByClass("_im_right_menu",i);uiRightMenu.hideSliding(a)}}),cancelEvent(a),!1}function _l(e,t){return e.pipeReplace(Promise.resolve(ul(t)))}function pl(e,t,a,n){return{updateMenu(t){!function(e,t){geByClass("_im_peer_tab",e).forEach(e=>{var a=Object(Si.fromQueryString)(attr(e,"href").split("?")[1]);a.tab!==t.get().active_tab&&attr(e,"href",`${Object(i.getBaseLink)(t)}?sel=${a.sel}&tab=${t.get().active_tab}`)})}(e,t);var n=gpeByClass("_im_right_menu",e);_l(a,t).then(()=>{var e;(e=t.get().peer?ge("ui_rmenu_peer_"+t.get().peer):ge("ui_rmenu_"+t.get().active_tab))&&uiRightMenu.switchMenu(e,!0),uiRightMenu.hideProgress(n)})},updateName(e,t){var a=ge("ui_rmenu_peer_"+e);if(a){var n=geByClass1("_im_r_tx",a),i=t.get().tabs[e].tab;val(n,i)}},updateCounter(e,t){var a=ge("ui_rmenu_peer_"+t);if(a){var n=geByClass1("_im_r_ct",a),s=Object(i.getTab)(e,t),r="";switch(!0){case s.unread>0:r=s.unread;break;case Object(i.isTabMarkedUnread)(s):r=1}val(n,r),toggleClass(a,"im-right-menu--unread",s.unread>0||Object(i.isTabMarkedUnread)(s))}},unmount(){Object(c.destroyModule)(n),a.unmount()}}}function hl(e,t,a){1===a.which&&(e.get().peer&&e.get().longpoll.push([Object(d.resetPeer)()]),e.get().longpoll.push([Object(d.changeTab)(t)]),cancelEvent(a))}function bl(e){Object(U.showTooltip)(e.currentTarget,{text:Object(fa.getLang)("mail_admin_av_time"),dir:"bottom",needLeft:!0,typeClass:"tt_default_right RightMenuBlockInfo__averageTimeTooltip",width:210,shift:[-14,8],slide:15})}function vl(e,t,a){e.set(e=>Object(n.toggleCommunityMute)(t,e)).then(()=>a.classList.toggle("RightMenuBlockInfo__mute--muted",e.get().mute))}function fl(e,t,a){var n=x(e,Object(h.default)({limit:50,offset:0,noScroll:!0,elements:ul(t)}),()=>({idFn:e=>e.peer||"000",renderFn:gl.bind(null,t)})),s=ml.bind(null,t,n),r=geByClass1("RightMenuBlockInfo"),o=geByClass1("RightMenuBlockInfo__averageTimeHint",r),u=geByClass1("RightMenuBlockInfo__mute",r),g=Object(c.createModule)({handlers:(a,n)=>{n(e,"click","_im_r_cl",s),n(e,"click","_im_peer_tab",(e,a)=>{if(!checkEvent(e)){var n=intval(domData(a,"list-id"));Object(l.unpackStore)(t).longpoll.push([Object(d.changePeer)(n,!1,!0,!0)]),cancelEvent(e)}}),dl.forEach(n=>{a(geByClass1("_ui_item_"+n,e.parentNode),"mousedown",hl.bind(null,t,n))}),a(geByClass1("_im_contact_list_menu_item",e.parentNode),"click",()=>gr(t)),o&&a(o,"mouseover",bl),Object(i.isCommunityInterface)(t)&&u&&a(u,"click",e=>vl(t,!0,e.currentTarget))}});return Object(i.isCommunityInterface)(t)&&u&&vl(t,!1,{target:u}),pl(e,0,n,g)}function Ol(e){var t=e.get().tabs,a=e.get().peer,s=Object.keys(t).filter(t=>Object(i.isFullyLoadedTab)(e,t)&&intval(t)!==a).map(e=>t[e]);s.filter(e=>Date.now()-e.last_visited>54e6).forEach(t=>e.set(n.cleanTab.bind(null,t.peerId))),s.filter(t=>Object(i.isFullyLoadedTab)(e,t.peerId)&&"string"!=typeof t.history&&Date.now()-t.last_touched>72e5).forEach(t=>e.set(n.stringifyTab.bind(null,t.peerId)))}function Cl(e){var t=setInterval(Ol.bind(null,e),5e3);return{unmount(){clearInterval(t)}}}function yl(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return jl(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return jl(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function jl(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function El(e,t,a,s){if(!e.loading&&!e.all&&a.scrollTop+window.innerHeight-a.scrollHeight>-300){var r=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,Object(i.wrapLoading)(r)(Object(n.loadImportant)(e.offset).then(t=>{var a=yl(t,4),o=(a[0],a[1]),l=(a[2],a[3]);e.all=l.all,e.offset=l.offset,e.all?addClass(r,"im-important_all"):e.loading=!1,s.set(n.mergeTabs.bind(null,Object(i.tabFromIds)(l.msgs,l.hash)));var c=ce("div");c.innerHTML=o,r.appendChild(c),Object(i.ensureDomHasActions)(r)}),"bottom")}}function Sl(e,t,a){for(var i=arguments.length,s=new Array(i>3?i-3:0),r=3;r<i;r++)s[r-3]=arguments[r];s.filter(e=>inArray(e.type,[B.SET_FLAGS,B.RESET_FLAGS,B.CHANGE_PEER])).forEach(i=>{if(i.type!==B.CHANGE_PEER){if(i.flags===B.FLAG_IMPORTANT){var s=i.type===B.SET_FLAGS;e.set(n.updateFavMessage.bind(null,[i.messageId],0,s)).then(a=>{t.markImportant(i.messageId,s,e)})}}else a.hide()})}function Tl(e,t,a,n){var s=ge("box_layer_wrap"),r=t.get().longpoll,o=Object(h.default)({peer:0,longpoll:r,oCache:{},tabs:Object(i.tabFromIds)(n.msgs,n.hash)}),l=Qn(e.bodyNode,o,()=>({})),d=_(e.bodyNode,t);Object(i.ensureDomHasActions)(e.bodyNode);var u=Sl.bind(null,t,l,e);r.onData(u);var g=El.bind(null,{all:!1,loading:n.all,offset:n.offset},e,s,o),m=Object(c.createModule)({handlers:(e,t)=>{e(s,"scroll",g)}});return{unmount(){Object(c.destroyModule)(m),d.unmount(),l.unmount(),r.offData(u)}}}function wl(e){return e.which||e.keyCode}function Il(e,t,a){!a||inArray(wl(a),p.UNPRINTABLE_KEYS)||Object(n.isSearchingInplace)(e.get().peer,e.get())||Object(i.isEditableFocused)()||a.ctrlKey||browser.mac&&a.metaKey||a.key&&1!==a.key.length||t.signal("printable",a)}function Al(e,t,a){wl(a)===p.ENTER&&e.signal(wl(a),a)}function Ml(e,t,a,n){var s=wl(n);if(!layers.visible){if(s>=49&&s<=57&&(n.ctrlKey||n.metaKey&&browser.mac)&&Object(i.isClassicInterface)(t))return function(e,t){var a=e.get().tabbedPeers[t];a&&e.get().longpoll.push([Object(d.changePeer)(a.peer,!1,!0,!0)])}(t,s-49),cancelEvent(n);inArray(s,p.UP_DOWN_CONTROLS)&&e.signal(s,n)}}function kl(e,t){var a=browser.mozilla?"keydown":"keypress",n=Object(h.default)({signalTimer:!1}),i=Il.bind(null,e,t),s=Ml.bind(null,t,e,n),r=Al.bind(null,t,n),o=Object(c.createModule)({handlers:(e,t)=>{e(document,"keydown",s),e(document,"keyup",r),e(document,a,i)}});return{unmount(){Object(c.destroyModule)(o)}}}function Ll(e,t){return-1===(e?e.indexOf(t):0)&&(e.push(t),!0)}function Pl(e,t){var a=e?e.indexOf(t):-1;return-1!==a&&(e.splice(a,1),!0)}function Nl(e,t,a,r,o,l){var c=Object(s.getTab)(e,t);switch(a){case B.MAIL_CHAT_UPDATE_TYPE_ADMIN_GRANTED:case B.MAIL_CHAT_UPDATE_TYPE_ADMIN_KICKED:return a===B.MAIL_CHAT_UPDATE_TYPE_ADMIN_GRANTED?Ll(c.adminIds,r):Pl(c.adminIds,r),e.set(e=>Object(n.setCallAvailability)(t,e)).then(()=>{Dl(e,t,o),xl(e,t,o,l)}),!0;case B.MAIL_CHAT_UPDATE_TYPE_FLAGS_CHANGED:return c.data.flags=r,e.set(e=>Object(n.setCallAvailability)(t,e)).then(()=>{Dl(e,t,o),xl(e,t,o,l)}),!0;case B.MAIL_CHAT_UPDATE_TYPE_PINNED:delete c.pinHideId,cur.imDb.update(_i.PIN_HIDDEN_ID_OP,[c.peerId,void 0]);var d=c&&c.pinned&&Object(i.parserMessage)(c.pinned).messageId;return o.removeUnpinnedMessageEditable(e,d),!1;case B.MAIL_CHAT_UPDATE_TYPE_USER_JOINED:var u=r===vk.id;return function(e,t,a){if(Object(i.isTabLoaded)(a.get(),e)){var r=Object(s.getTab)(a,e);Ll(r.memberIds,t)&&r.membersCount++,-1===r.data.active.indexOf(t)&&r.data.active.push(t),t===vk.id&&(r.data.kicked=0,r.data.closed=0)}return a.set(a=>Object(n.loadChatMember)({[e]:[t]},a))}(t,r,e).then(()=>{if(u&&e.get().peer===t)return e.set(e=>Object(n.getPinnedMessage)(t,e))}).then(()=>xl(e,t,o,l)).then(()=>{if(u&&e.get().peer===t)return Promise.all([e.set(e=>Object(n.getPeerActiveCallData)(t,e)),e.set(e=>Object(n.loadKeyboard)(t,e))])}).then(()=>(e.get().peer===t&&c.callInProgress&&(o.updateBanner(e),o.updateHeader(e)),o.fixKeyboard())),!0;case B.MAIL_CHAT_UPDATE_TYPE_USER_LEFT:case B.MAIL_CHAT_UPDATE_TYPE_USER_KICKED:return function(e,t,a,r,o){if(Object(i.isTabLoaded)(r.get(),e)){var l=Object(s.getTab)(r,e);Pl(l.memberIds,t)&&l.membersCount--,l.data.active=l.data.active.filter(e=>e!==t),t===vk.id&&(a?l.data.kicked=1:l.data.closed=1,r.set(t=>Object(n.removePeerActiveCallData)(e,t)))}return t===vk.id&&r.get().peer===e?(o.cancelEditing(),r.set(t=>Object(n.unpinMessageOptimistic)(e,t))):Promise.resolve()}(t,r,a===B.MAIL_CHAT_UPDATE_TYPE_USER_KICKED,e,o).then(()=>xl(e,t,o,l)),e.get().id!==r&&(Object(s.getKeyboard)(e,t)||{}).author_id!==r||e.set(e=>Object(n.deleteKeyboard)(t,e)).then(()=>o.fixKeyboard()),!0;case B.MAIL_CHAT_UPDATE_TYPE_BANNER_CHANGED:return e.set(e=>Object(n.loadBanner)(t,e)).then(()=>o.updateBanner(e)),!0;case B.MAIL_CHAT_UPDATE_TYPE_KEYBOARD_CHANGED:case B.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED:return!0;case B.MAIL_CHAT_UPDATE_TYPE_CALL_IN_PROGRESS_CHANGED:var g=r?e=>Object(n.getPeerActiveCallData)(t,e):e=>Object(n.removePeerActiveCallData)(t,e);return e.set(g).then(()=>{e.get().peer===t&&(o.updateBanner(e),o.updateHeader(e)),l.updateDialog(t,e)}),!0;default:return!1}}function Dl(e,t,a){e.get().peer===t&&(Object(n.setActions)(e.get()),a.updateActions(e))}function xl(e,t,a,i){e.get().peer===t&&(Object(n.setActions)(e.get()),a.updateChat(e,t),i.updateDialog(t,e))}var Bl=a("gF8j"),Rl=a("ambf"),Fl=a("pdqG");function Hl(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||Ul(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ul(e,t){if(e){if("string"==typeof e)return Gl(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(a):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?Gl(e,t):void 0}}function Gl(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function ql(e,t,a,r,o){var l,c={},d=new Map,u=function(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=Ul(e))){var t=0,a=function(){};return{s:a,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,s=!0,r=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){r=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(r)throw i}}}}(o);try{for(u.s();!(l=u.n()).done;){var g=l.value;c[g.peerId]||(c[g.peerId]=[]),c[g.peerId].push(g.messageId),d.set(g.messageId,g)}}catch(e){u.e(e)}finally{u.f()}Object.keys(c).forEach(o=>{var l=c[o],u=Object(s.getTab)(e,o),g=u&&!u.offset,m=u&&u.inplaceSearch&&!!u.searchOffset;e.set(n.removeMessages.bind(null,l,o)).then(()=>e.set(n.removeMessagesMarkDeleted.bind(null,l,o))).then(()=>{if(e.get().peer===+o&&Object(i.isFullyLoadedTab)(e.get(),o)){var a=Object(s.getTab)(e,o);t.removeMessages(l,+o,e);var r=a.inplaceSearch;if(!a.offset&&!g&&(Object(n.setActions)(e.get()),t.updateActions(e),r||t.showEmptyScreen()),r&&m&&!a.searchOffset&&(t.showSearchResults(),browser.safari)){var c=geByClass1("_im_peer_history_w");c.style.display="none",setTimeout(()=>c.style.display="",0)}}}).then(()=>{var i=Object(s.getTab)(e,o);if(i){var c=l.some(e=>e>=i.lastmsg),u=l.filter(e=>e>i.in_up_to&&!(d.get(e).flags&B.FLAG_OUTBOUND));c?Object(n.loadActualLastMessage)(e,+o).then(()=>{a.promoteDialog(e,o),r&&r.updateCounter(e,o),t.updateGoToEnd(e,!0),t.updateGoToMention(e,!0)}):u&&Object(Fl.removeDeletedUnreadMsgsFromTab)(o,u,e.get()).then(()=>a.updateDialog(o,e))}})})}function Wl(e,t){"spam"===t?Object(i.showSpamLayer)(e,xr,{}):"fav"===t&&Object(i.showFavvedBox)(e,{},Tl,{})}function Kl(e,t,a,s,r){e.forEach(e=>{switch(e.kludges.source_act){case i.CHAT_PHOTO_REMOVE:case i.CHAT_PHOTO_UPDATE:!function(e,t,a,i){t.set(n.updateChatPhoto.bind(null,e)).then(()=>{var n=e.kludges.source_act;a.updateDialog(e.peerId,t),i.updateChatPhoto(e,n,t)})}(e,t,a,s)}})}function Vl(e,t){var a=e.get().longpoll.push.bind(null,[Object(d.resetPeer)()]),n=()=>{var i=e.get().selectedMessages;i&&i.length?(e.setState({selectedMessages:[]}).then(()=>{t.changedMessageSelection(e),t.cleanSelection(i)}),setTimeout(()=>cancelStackPush("im_peer",n),0)):a()};cancelStackPush("im_peer",n)}function Yl(e){var t=e.attaches.filter(e=>"sticker"!==e.type&&"call"!==e.type);return Object(r.isServiceMsg)(e)||0===t.length}function zl(e,t,a){addClass(a,"im-page_history-show"),t.loadingPeer(e)}function Ql(e,t){var a=Object(i.getRightMenuMaxItems)(e,t.offsetHeight);if(e.get().tabbedPeers.length>a){var s=e.get().tabbedPeers.filter(t=>{var a=t.peer;return intval(a)!==e.get().peer}).map(t=>{var a=t.peer;return e.get().tabs[a]}).sort((e,t)=>t.last_touched-e.last_touched),r=[];0!==e.get().peer&&r.push(e.get().tabs[e.get().peer]);var o=r.concat(s).slice(a).map(e=>e.peerId),l=e.get().tabbedPeers.filter(e=>!inArray(e.peer,o));return e.set(n.updateTabbedPeers.bind(null,l,!0))}return Promise.resolve(e)}function Xl(){for(var e=curBox();e;)e.hide(),e=curBox()}function $l(e,t,a,r,o,l,c,d,u){e.get().audio_msg.isRecording&&e.set(n.cancelRecording).then(()=>{r.cancelRecording()}),AudioMessagePlayer.detachPlayer(),Object(s.isAnyMessageBeingEdited)(e)&&r.cancelEditing(),Object(s.isSearching)(e)&&t.cancelSearch&&(o.clearSearch(e),a.restoreDialogs(e),u().toggleSettingsButton(e,!1)),Jl(e,d,u),zl(e,r,l);var g=e.get().peer;Object(n.updateMentions)(e.get()),Object(n.videoAutoPlayHandler)(),Object(i.isFullyLoadedTab)(e,t.peerId)&&(t.msgid&&!Object(s.getMessage)(e,t.peerId,t.msgid)||!t.msgid&&!Object(s.getMessage)(e,t.peerId,Object(s.getTab)(e,t.peerId).lastmsg)||Object(s.getTab)(e,t.peerId).skipped)&&e.mutate(e=>Object(s.makeTabNotFullyLoaded)(e,t.peerId));var m=e.set(n.changePeer.bind(null,t.peerId,t.msgid,t.entryPoint)).then(e=>{var a=e.get(),i=n.loadPeer.bind(null,t.peerId,!1,t.msgid,!1,a);return a.tabs[t.peerId]?Promise.resolve(a):e.set(i)}).then(()=>{a.selectPeer(t.msgid,e),function(e,t){Object(i.isPendingForward)(e)&&(cancelStackFilter("forward"),e.set(n.forwardMessages.bind(null,e.get().pendingForward,Object(s.getTabDraft)(Object(s.getTab)(e,t)),!1)))}(e,e.get().peer),window.tooltips&&tooltips.hideAll(),Xl(),r.preparePeer(e),Vl(e,r),Object(i.isClassicInterface)(e)&&(a.deactivate(),Ql(e,l).then(()=>c.updateMenu(e)),Object(i.updateMessageRequestsCounterInDOM)(e))});return(m=t.msgid?m.then(()=>e.set(n.selectPeerOnMessage.bind(null,t.peerId===g,g))):m.then(()=>e.set(n.selectPeer.bind(null,!0)))).then(()=>e.set(n.prepareCasperMessagesFromMessages.bind(null,t.peerId))).then(()=>{if(e.get().peer===t.peerId){if(t.forward){var a=e.get().tabs[e.get().peer];if(!a.scrollBottom&&a.unread)(Object(W.partConfigEnabled)("mail_history_unread_counter_observer")?Promise.resolve():e.set(n.readLastMessages.bind(null,e.get().peer))).then(()=>e.set(n.setActions)).then(()=>r.updateActions(e));else!a.unread&&Object(s.isTabMarkedUnread)(a)&&e.set(e=>Object(n.markDialogRead)(t.peerId,e))}Object(i.isClassicInterface)(e)&&c.updateMenu(e),r.changePeer(e,!1),r.updateTyping(t.peerId,e),r.removeExpiredFailedMessages(t.peerId),Object(W.partConfigEnabled)("mail_history_unread_counter_observer")&&r.updateObserver(),Object(n.updateMentions)(e.get())}}).catch(e=>Object(Uo.imWeirdCatch)("applyNewPeer",e))}function Jl(e,t,a){t&&e.get().shown&&(t.hide(e),a().createCanceled(e))}function Zl(e,t,a){Object(s.isSearching)(e)&&(t.clearSearch(e),a.restoreDialogs(e))}function ec(e,t,a,s,r,o,l){e.setState({isCreating:!0}),Object(W.partConfigEnabled)("messages_chat_creation_new_interface")?Po(e).show():(Object(i.isClassicInterface)(e)&&(r.saveScroll(e),o.saveScroll(e)),s.showCancelControl(),addClass(l,"im-page_creating"),a&&a.show(e,t),Object(i.isClassicInterface)(e)&&(setStyle(l,{height:oc(l,e).page}),setTimeout((function(){addClass(l,"im-page_cropped")}),200))),Object(n.toggleConversation)(!0)}function tc(e,t,a,n){Object(i.isTabLoaded)(e.get(),n)&&(t.updateTyping(n,e),a.updateTyping(n,e))}function ac(e,t,a,s,r){s.activityType||(s.activityType=r);var o=e=>tc(e,t,a,s.peerId);Object(i.isSelfMessage)(s.peerId,e.get().gid)||(e.set(n.setActivity.bind(null,s,r)).then(o),e.set(n.waitActivity.bind(null,s,r)).then(o))}function nc(e,t){t?e.classList.add("im-page_reconnecting"):e.classList.remove("im-page_reconnecting")}function ic(e,t,a){var i=null;if(a.kludges.keyboard&&!a.kludges.keyboard.inline){var o=Object.assign(a.kludges.keyboard,{author_id:a.userId});i=e.set(n.setKeyboard.bind(null,a.peerId,o))}else{var l=Object(s.getKeyboard)(e,a.peerId);l&&l.one_time&&l.author_id!==Object(r.getAuthorId)(e,a)&&(i=e.set(n.deleteKeyboard.bind(null,a.peerId)))}a.peerId===Object(s.getPeer)(e)&&i&&i.then(t.fixKeyboard)}function sc(e,t,a,l,u,g,m,_,h,b,v,f,O,C,y,j,E,S,T,w,I,A){var M=!1;return{changePeer(e,a){t.selectPeer(e,a)},cancelSearch(e){Zl(e,l,t)},loadingPeer(e){zl(e,a,u)},restoreDialogs(e,a,n){t.restoreDialogs(e,a,n)},toggleSettingsButton(e,t){v.toggleButton(e,t)},focusSearch(e){l.focusInput()},appendSearch(e,a,n,i){t.appendSearch(e,a,n,i)},appendDialogs(e,a){t.appendDialogs(e,a)},showCreation(e,n){ec(e,n,b,l,t,a,u)},showCreationNew(){Po(f).show()},updateState(e,n){t.updateDialog(e,n),n.get().peer===e&&a.updateChat(n,e)},updateConvoInList(e,a){t.promoteDialog(a,e)},appendFastDialogs(e,a){t.appendFastDialogs(e,a,!0)},createCanceled(e){l.hideCancelControl(),Object(i.isClassicInterface)(e)?(setStyle(u,{height:"auto"}),removeClass(u,"im-page_cropped"),setTimeout(()=>l.focusInput(),0),0===e.get().peer?t.restoreScroll(e):a.restoreScroll(e,e.get().peer)):setTimeout(()=>{0===e.get().peer?l.focusInput():a.focustTxt(e)},0),removeClass(u,"im-page_creating"),e.setState({isCreating:!1})},updateMenu(e){j&&j.updateMenu(e)},goToHistoryEnd(){a.goToEnd()},updateDialog(e,a){t.updateDialog(e,a)},focusTxt(e){a.focustTxt(e)},resync(e){Object(s.isSearching)(e)&&l.clearSearch(e),t.restoreDialogs(e,!0,!0).then(()=>{Object(i.isClassicInterface)(e)||t.focusOnSelected(e)}),b&&b.hide(e),Object(i.isCommunityInterface)(e)&&e.get().tabbedPeers.forEach(t=>{var a=t.peer;j.updateCounter(e,a)}),Object(i.isClassicInterface)(e)&&(e.get().tabbedPeers.forEach(t=>{var a=t.peer;j.updateCounter(e,a),j.updateName(a,e)}),Object(i.updateMessageRequestsCounterInDOM)(e)),a.cleanSelection(e.get().selectedMessages||[]),a.cancelSearch(e,!0),Object(i.isReservedPeer)(e.get().peer)||a.changePeer(e,!1);var n=e.get().gid?"l_mgid"+e.get().gid:"msg";handlePageCount(n,e.get().unread_cnt)},toggleSettingsLoader(e,t){v.toggleLoader(e,t)},onUserActions(e,t){if(!Object(n.isSearchingInplace)(e.get().peer,e.get())){var r,o=e.get(),l=o.peer;if(Object(i.isFullyLoadedTab)(o,l))if(!g.is_idle)if(Object(s.countUnread)(e.get().peer,e.get())>0)if(!o.tabs[l].skipped&&a.isNewMessagesVisible(e))a.hideGoToEnd(!0),a.hideGoToMention(!0),Object(W.partConfigEnabled)("mail_history_unread_counter_observer")?(a.updateObserver(),r=Promise.resolve()):r=e.set(n.readLastMessages.bind(null,l)),r.then(()=>e.set(n.setActions)).then(()=>a.updateActions(e))}},removeSelection(e){t.removeSelection(e),l.focusInput()},route(e,s,r,o){if(void 0!==e[0])return!0;e.box&&(e={box:e.box});var c=!1;return!!(e.mr||e.invite_chat_id&&r.invite_hash)||(o&&o.params&&"left_nav"===o.params._ref&&void 0===e.sel&&t.scrollUp(!0,!0),Object.keys(e).sort().forEach(e=>{switch(e){case"sel":r.q||(c=!0);var g=r.sel?Object(i.unUrlPeer)(r.sel):0,m=o.back;0===g?f.get().longpoll.push([Object(d.resetPeer)(!1,m)]):g!==f.get().peer&&f.get().longpoll.push([Object(d.changePeer)(g,r.msgid||!1)]);break;case"invite_chat_id":case"invite_hash":!function(e){e.set(n.leaveInvitation).then(()=>{e.get().longpoll.push([Object(d.resetPeer)(!1,!1)])})}(f);break;case"tab":Jl(f,b,h),c=!0;var _=r.tab||p.FOLDER_ALL;f.get().longpoll.push([Object(d.changeTab)(_)]);break;case"act":r.act&&"create"===r.act?ec(f,[],b,l,t,a,u):function(e,t,a,n){a&&a.hide(e,t)}(f,[],b);break;case"st":r.st&&r.sel?(curBox()&&curBox().hide(),f.mutate(n.setInplaceSearch.bind(null,unescape(r.st),r.sel)),a.startSearch(f)):(f.mutate(n.cancelSearch.bind(null,s.sel)),a.cancelSearch(f,!0));break;case"q":r.q?(curBox()&&curBox().hide(),l.setSearch(f,r.q,!0)):l.clearSearch(f);break;case"box":Wl(f,r.box)}}),r.msgid&&(f.get().msgid=r.msgid,a.focusOnMessage()),Object(i.isClassicInterface)(f)&&void 0===e.sel&&j.updateMenu(f),c&&Zl(f,l,t),!1)},updateDialogFilters(e){Object(s.isSearching)(e)||t.restoreDialogs(e),v.updateFilter(e)},removePeer(e,a){t.removeDialog(e,a),t.saveScroll(e),e.get().peer===a&&e.get().longpoll.push([Object(d.resetPeer)()]),Object(i.isClassicInterface)(e)&&j.updateMenu(e)},newMessage(e){Object(i.isClassicInterface)(e)||t.scrollUp(!0)},onQueueEvent(e,s){switch(s.entity_type){case No.EntityType.Online:e.set(e=>Object(n.updateOnline)(s.data.user_id,!!s.data.online&&s.data.platform,s.data.last_seen,e)).then(e=>{Object(i.isTabLoaded)(e.get(),s.data.user_id)&&(t.updateOnline(s.data.user_id,e),a.updateOnline(s.data.user_id,e))})}},onEvents(e,c){var f=function(e){for(var t=!1,a=e.length-1;a>=0;a--)e[a].type!==B.UNREAD_COUNT||t?e[a].type===B.UNREAD_COUNT&&e.splice(a,1):t=!0;return e}(c.filter(e=>e.type!==B.ADD_MESSAGE||!(e.flags&B.FLAG_STEALTH))),C=c.filter(r.isServiceMsg),y=c.filter(e=>e.type===B.ADD_MESSAGE);Kl(C,e,t,a);var E=Object(n.checkNewPeople)(C,y,e),S=Promise.resolve();E.shouldLoad&&(S=e.set(n.loadNewPeople.bind(null,E,m))),S.then(()=>{f.forEach(c=>{switch(c.type){case B.ADD_MESSAGE:var m=c.peerId,f=Object(s.getTab)(e,m),C=!f||!f.msgs||0===f.msgs.length,y=Object(i.getMessageStoreStatus)(c,e.get()),E=Object(s.isCommunityBlocked)(e,c.peerId),S=f&&!f.lastmsg;switch(ic(e,a,c),Object(r.isCasperMessage)(c)&&Rl.casperMessagesStore.add(c),y){case i.MSG_NEW:e.set(n.addMessage.bind(null,c)),Ql(e,u),function(e,t){var a=e.get().tabs[t.peerId],i=e.get().active_tab;return i===p.FOLDER_ALL||(i===p.FOLDER_PEER_TAGS?Object(o.applyPeerTagsFilterToTab)(e.get(),a):Object(n.filterFromTab)(i)(a))}(e,c)&&(Object(s.tabIsMessageRequest)(f)||(c.flags&B.FLAG_OUTBOUND||e.set(n.updateFavAndTitle.bind(null,c.peerId,!0)),function(e,t){var a=t.flags&B.FLAG_OUTBOUND,n=inArray(t.peerId,e.get().mutedPeers),s=t.flags&B.FLAG_DELETED,r=e.get().gid;if(!a&&!n&&!s){var o,l,c=function(e,t){return t<2e9&&e&&!e.match(/^\s*(Re(\(\d*\))?\:)?\s*\.\.\.\s*$/)}(t.subject,t.peerId)||"",d=(c?c+" ":"")+t.text||"",u=t.userId,g=t.peerId,m=e.get().tabs[g];if(t.kludges&&t.kludges.source_act&&(d=stripHTML(Object(i.renderServiceMsg)(e,t,m,!1))),(!e.get().notify_msg&&!Object(i.isChatPeer)(g)||r&&!e.get().mute)&&window.Notifier&&Notifier.playSound({author_id:g}),!Object(i.isChatPeer)(g))return;d=trim(replaceEntities(stripHTML(d.replace(/<br>/g,"\n").replace(/<\*>.*$/,"")))),d=Object(pi.replaceMentions)(d,(e,t,a,n,i)=>i),Object(i.isChatPeer)(g)?(o=Object(F.oCacheGet)(e,u).name,m.tab&&(o+=" » "+m.tab),l=Object(F.oCacheGet)(e,u).photo):(o=m.tab,l=m.photo);var _=t.attaches[0];if(_&&"mail"===_.type)d+="\n["+getLang("mail_added_msgs")+"]";else if(_){var p="doc"===_.type&&"graffiti"===_.kind?"graffiti":_.type;d+="\n["+getLang("mail_added_"+p)+"]"}o=trim(replaceEntities(stripHTML((o||"").replace("&nbsp;"," ")))),window.Notifier&&Notifier.proxyIm({id:t.messageId,text:d,author_id:g,title:o,author_photo:l})}}(e,c)),t.updateTyping(c.peerId,e),Object(s.isSearching)(e)?t.updateDialog(c.peerId,e):t.promoteDialog(e,c.peerId));var T=Object(s.isCommunityBlocked)(e,c.peerId),I=f&&!f.offset;(E&&!T||S&&!I)&&a.updateActions(e),Object(i.isClassicInterface)(e)?(j.updateCounter(e,c.peerId),j.updateMenu(e)):v.updateFilter(e),e.set(n.updateActivity.bind(null,c)).then(tc.bind(null,e,a,t,c.peerId)),a.addMessage(e,c),Yl(c)||!Object(i.isFullyLoadedTab)(e,c.peerId)||c.local||e.set(n.loadMedia.bind(null,c)).then(e=>{a.replaceAttachmentPlaceholders(e,c),Object(n.videoAutoPlayHandler)()}),Object(nt.statlogsSendingTimeStart)(e,c,"send","opt_to_lp");break;case i.MSG_LOCAL_DUPLICATE:Yl(c)||e.set(n.loadMedia.bind(null,c)).then(e=>{a.replaceAttachmentPlaceholders(e,c)}),e.set(n.replaceMessage.bind(null,c)),a.replaceMessageAttrs(c,e),t.updateDialog(c.peerId,e),c.randomId&&Object(nt.statlogsSendingTimeEnd)(e,c,"send","opt_to_lp");break;case i.MSG_DUPLICATE:Object(s.isSearching)(e)||t.promoteDialog(e,c.peerId)}Object(s.tabIsMessageRequest)(f)&&Object(i.checkMessageRequestsTab)(e,t.update);var A=y===i.MSG_LOCAL_DUPLICATE&&1===f.offset||y===i.MSG_NEW&&S&&!c.local;Object(W.partConfigEnabled)("messenger_empty_pinned_support")&&A&&e.set(t=>Object(n.loadPeer)(m,0,0,0,t).then(t=>(Object(Fl.updateListedConvos)(t,Object(s.getTab)(t,m),!1,n.addDialog.bind(null,m),n.shouldIncludeDialog.bind(null,t)),m===e.get().peer?Object(n.setActions)(t):t))).then(e=>t.promoteDialog(e,m)),f&&C&&f.peerId===Object(s.getPeer)(e)&&w();break;case B.EDIT_MESSAGE:case B.REPLACE_MESSAGE:e.set(n.editMessage.bind(null,c)).then(e=>{if(ic(e,a,c),c.kludges.is_expired)return Object(i.removeExpiredMessageIfNeed)(c,a.handleMessageExpiration),void t.updateDialog(c.peerId,e);t.updateDialog(c.peerId,e),a.updateTyping(c.peerId,e),a.editMessage(e,c),Yl(c)||!Object(i.isFullyLoadedTab)(e,c.peerId)||c.local||e.set(n.loadMedia.bind(null,c)).then(e=>a.replaceAttachmentPlaceholders(e,c))});break;case B.INVALIDATE_MESSAGE:Object(n.reloadMessage)(c.messageId,e.get()).then(t=>{var a=Object(G.getMessageFromTuple)(t);return e.set(e=>Object(n.editMessage)(a,e)).then(()=>a)}).then(s=>{a.editMessage(e,s),t.updateDialog(s.peerId,e),!Yl(s)&&Object(i.isFullyLoadedTab)(e,s.peerId)&&e.set(e=>Object(n.loadMedia)(s,e)).then(e=>a.replaceAttachmentPlaceholders(e,s))});break;case B.READ_INBOUND:e.set(n.markInboundMessagesAsRead.bind(null,c)).then(e=>{t.updateCounter(e,c.peerId),a.updateGoToEnd(e,!0),a.updateGoToMention(e,!0),a.updateObserver(),Object(i.isClassicInterface)(e)&&j.updateCounter(e,c.peerId),Object(s.isSearching)(e)||t.restoreDialogs(e),v.updateFilter(e)});break;case B.READ_OUTBOUND:e.set(n.markOutboundMessagesAsRead.bind(null,c)).then(e=>{t.updateCounter(e,c.peerId),a.markMessagesAsRead(e,c)});break;case B.UNREAD_COUNT:e.set(n.updateUnreadCount.bind(null,c.count)).then(()=>{var t=e.get().gid?"l_mgid"+e.get().gid:"msg";handlePageCount(t,c.count),v.updateFilter(e),Object(i.isClassicInterface)(e)&&e.get().tabbedPeers.forEach(t=>{var a=t.peer;j.updateCounter(e,a)})});break;case B.SET_FLAGS:case B.REPLACE_FLAGS:case B.RESET_FLAGS:if(!(c.flags&B.FLAG_DELETED||c.flags&B.FLAG_SPAM)||c.type!==B.SET_FLAGS||Object(i.isAlreadyDeleted)(e,c.peerId,c.messageId)||e.get().blockedFlagUpdates[c.peerId]||_(c),c.flags===B.FLAG_IMPORTANT){var k=c.type===B.SET_FLAGS;e.set(n.updateImportant.bind(null,k?1:-1,c.messageId)),e.set(n.updateFavMessage.bind(null,[c.messageId],c.peerId,k)).then(()=>{a.markImportant(c.messageId,k,e)})}break;case B.RECORDING_AUDIO:ac(e,a,t,c,n.ACTIVITY_TYPE_RECORDING_AUDIO);break;case B.TYPING:ac(e,a,t,c,n.ACTIVITY_TYPE_TYPING);break;case B.NOTIFY_SETTINGS_CHANGED:!function(e,t,a,i){e.set(n.setMutedPeer.bind(null,a,i)).then(t().updateState.bind(null,a))}(e,h,c.peerId,!c.sound);break;case B.CONVO_MAJOR_ID_CHANGED:e.set(e=>{var t=c.peerId,a=c.majorId,i=Object(s.getTab)(e,t);return(a&&i?Promise.resolve(e):Object(n.loadPeer)(t,0,0,0,e)).then(e=>{var i=Object(s.getTab)(e,t);return i.major_sort_id=a,Object(Fl.updateListedConvos)(e,i,!1,n.addDialog.bind(null,t),n.shouldIncludeDialog.bind(null,e)),Object(n.setActions)(e),Promise.resolve(e)})}).then(e=>{var n=c.peerId;Object(s.getTab)(e,n)&&!Object(s.isSearching)(e)&&t.promoteDialog(e,n),n===e.get().peer&&a.updateActions(e)});break;case B.CONVO_MINOR_ID_CHANGED:e.set(e=>{var t=c.peerId,a=c.minorId,n=Object(s.getTab)(e,t);return n?(n.minor_sort_id=a,Promise.resolve(e)):Promise.resolve(e)}).then(e=>{var a=c.peerId;Object(s.getTab)(e,a)&&!Object(s.isSearching)(e)&&t.promoteDialog(e,a)});break;case B.RESYNC:e.get().longpoll.pause(),e.set(n.resync).then(h().resync).then(()=>e.get().longpoll.resume());break;case B.TRANSITION:O.transition(c.state);break;case B.RESET_PEER:if(c.removeActivePeer){var L=e.get().tabbedPeers.filter(t=>{var a=t.peer,n=t.type;return a!==e.get().peer&&"perm"===n});e.setState({tabbedPeers:L})}!function(e,t,a,r){e.set(n.cancelRecording).then(()=>{a.cancelRecording()}),AudioMessagePlayer.detachPlayer(),t.removeSelection(e),removeClass(r,"im-page_history-show"),t.updateStarPosition(),a.flushDraft(e),a.stopLoading(),a.destroyPeerProfile(),Object(s.isAnyMessageBeingEdited)(e)&&a.cancelEditing();var o=e.get().peer;e.set(n.changePeer.bind(null,0,!1,!1)).then(()=>{window.tooltips&&window.tooltips.hideAll(),Xl(),Object(i.isClassicInterface)(e)&&t.activate(),a.changePeer(e),Object(i.isClassicInterface)(e)&&t.restoreScroll(e),setTimeout(()=>{e.get().longpoll.push([Object(d.transitionEvent)("search")])},13),Object(i.isLocksAvailable)(e)&&Object(i.isPeerBlockedByMe)(o,e)&&e.set(n.releaseBlock.bind(null,o))})}(e,t,a,u),t.renderPeerTags(e,e.get().prevPeer),c.cancelSearch&&Zl(e,l,t),Object(i.isClassicInterface)(e)&&j.updateMenu(e),l.focusInput(),Object(i.isCommunityInterface)(e)&&l.initPeerTagsFilter(e);break;case B.CHANGE_TAB:Object(s.isSearching)(e)&&l.clearSearch(e);var P=e.get().active_tab;Object(i.changeTab)(c.tab,e,h,n.changeDialogsTab).then(e=>{v.updateFilter(e),c.tab===p.FOLDER_PEER_TAGS&&P!==c.tab&&l.initPeerTagsFilter(e)});break;case B.RESET_DIRECTORIES:case B.SET_DIRECTORIES:case B.REPLACE_DIRECTORIES:var N=c.type,D=c.peerId,x=c.mask;if(x===B.FOLDER_HAS_BANNER)break;var R=x===B.FOLDER_AD_TAG;e.set(n.updateFolderState.bind(null,D,x,N,c.local,R)).then(e=>{Object(s.isSearching)(e)||N===B.RESET_DIRECTORIES&&x===p.FOLDER_MASKS[p.FOLDER_IMPORTANT]||N===B.RESET_DIRECTORIES&&x===p.FOLDER_MASKS[p.FOLDER_MESSAGE_REQUEST]||N===B.SET_DIRECTORIES&&x===p.FOLDER_MASKS[p.FOLDER_MESSAGE_REQUEST_REJECTED]||N===B.REPLACE_DIRECTORIES||t.restoreDialogs(e),t.updateDialog(D,e),Object(i.isClassicInterface)(e)&&j.updateCounter(e,D),e.get().peer===D&&a.changedMessageSelection(e)});break;case B.DELETE_DIALOG:e.set(n.deletedDialog.bind(null,c.peerId,Promise.resolve([]))).then(()=>{h().removePeer(e,c.peerId),h().updateDialogFilters(e)});break;case B.CHANGE_PEER:$l(e,c,t,a,l,u,j,b,h);break;case B.MUTEX:var H={[c.peerId]:c},U=Object(i.isPeerBlocked)(c.peerId,e);e.set(n.updateBlockStates.bind(null,H)).then(()=>{t.updateDialog(c.peerId,e);var n=Object(i.isPeerBlocked)(c.peerId,e);Object(i.isFullyLoadedTab)(e.get(),c.peerId)&&U!==n&&a.updateChat(e,c.peerId)});break;case B.FAILED_MESSAGE:e.set(n.setMessageErrored.bind(null,c.peer,c.message)).then(()=>{a.setMessageErrored(c.peer,c.message,c.error,e),t.setDialogFailed(c.peer,c.message.messageId,e)});break;case B.RESEND:var q=c.message.messageId;e.set(n.resendMessage.bind(null,c.peerId,q,c.message)).then(()=>{a.resendMessage(c.peerId,q),t.promoteDialog(e,c.peerId)});break;case B.PEER_TAGS_CHANGED_EVENT:Object(o.onPeerTagsChangeEvent)(e,t,c);break;case B.PEER_PROFILE_TAGS_CHANGED_EVENT:Object(o.onPeerProfileTagsChangedEvent)(e,t,l);break;case B.CONVERSATION_UPDATED:if(Object(s.isMessageRequestChangedEvent)(c)){var K=Promise.resolve(),V=Object(s.getCurrentTab)(e);switch(c.updateType){case B.MAIL_CHAT_UPDATE_TYPE_CONTACT_CONVERTED:V&&V.peerId===c.updateArg&&e.get().longpoll.push([Object(d.changePeer)(c.peerId)]),K=e.set(n.deletedDialog.bind(null,c.updateArg,Promise.resolve([]))).then(()=>{h().removePeer(e,c.updateArg),h().updateDialogFilters(e)});break;case B.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED:K.then(()=>e.set(n.updateMessageRequestsCounter.bind(null,c))).then(()=>{Object(i.updateMessageRequestsCounterInDOM)(e),Object(i.checkMessageRequestsTab)(e,t.update),c.updateArg===B.MESSAGE_REQUEST_STATUS_ACCEPTED&&Object(i.isClassicInterface)(e)&&j.updateMenu(e)})}}else{if(Object(i.isTabLoaded)(e.get(),c.peerId))Nl(e,c.peerId,c.updateType,c.updateArg,a,t)||h().reloadChatInfo(c.peerId)}break;case B.WAITING_FOR_RECONNECT:setTimeout(()=>{nc(u,!0),a.setNetworkWaitingStatus(c.timeout-1)},1e3);break;case B.RECONNECTING:nc(u,!0),a.setNetworkReconnectingStatus();break;case B.RECONNECTED:nc(u,!1),setTimeout(a.clearNetworkStatus,0),browser.chrome&&!Object(i.isClassicInterface)(e)&&e.get().peer&&(g.is_idle?M||(g.once("unidle",()=>{M=!1,t.forceScrollReinit()}),M=!0):t.forceScrollReinit())}})})},updateHistory:e=>a.updateHistory(e),reloadChatInfo(e){Object(i.isTabLoaded)(f.get(),e)&&f.set(n.loadChatInfo.bind(null,e)).then(()=>function(e,t,a,s,r){s.updateChatTopic(t,e),Object(i.isClassicInterface)(e)&&r.updateName(t,e),e.get().peer==t&&(Object(n.setActions)(e.get()),s.updateActions(e))}(f,e,0,a,j))},cancelRecording:()=>f.set(n.cancelRecording).then(()=>a.cancelRecording()),fixHeight(){w()},unmount(){Object(c.destroyModule)(e),clearInterval(f.get().update_title_to),g.stop(),I(),A(),Rl.casperMessagesStore.destroy(),t.unmount();var s=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_logo"+s+".ico"),a.unmount(),l.unmount(),cancelStackFilter("im_peer"),v.unmount(),b&&b.unmount(),j&&j.unmount(),E&&E(),C&&C(),Object(i.isLocksAvailable)(f)&&f.get().peer&&f.set(n.releaseBlock.bind(null,f.get().peer)),S.unmount(),j&&j.unmount(),T.unmount(),clearInterval(y),cur.imDb.unmount(),cur.imDb=!1}}}function rc(e,t,a,s){var r=t.get();Object(i.isReservedPeer)(r.peer)||e().onUserActions(t,s),r.update_old_title&&t.set(n.updateFavAndTitle.bind(null,!1,!1))}function oc(e,t){var a=ge("page_header"),n=geByClass1("_im_page_history",e),s=window.clientHeight()-a.offsetHeight-30-2,r=Object(i.isClassicInterface)(t)?250:400,o={page:Math.max(s,r)};if(Object(i.isClassicInterface)(t)){var l=Object(i.getClassicChatHeight)();l=l>0?Math.min(l-a.offsetHeight-30-2,s):s;var c=hasClass(n,"im-page--history_empty-hist")?l:s;o.history=Math.max(l,r),o.chat=Math.max(c,r)}return o}function lc(e,t,a,s,r){var o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],c=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!Object(l.isFullScreen)()){var d=oc(e,t);if(setStyle(e,{minHeight:d.page}),Object(i.isClassicInterface)(t)&&(void 0===t.get().chatResizeInitialized&&t.set(n.initializeChatResize),setStyle(e,{height:t.get().isCreating?d.page:"auto"}),setStyle(geByClass1("_im_page_dialogs",e),{minHeight:d.page,position:"static",top:0}),setStyle(geByClass1("_im_page_history",e),{minHeight:d.history,position:"relative",top:0}),setStyle(geByClass1("_im_chat_body_abs",e),{minHeight:d.chat,height:d.chat,position:"relative",top:0})),browser.safari&&c&&"function"==typeof c&&c(),s&&s.updateScroll(),r&&r.updateScroll&&r.updateScroll(),a){var u=a.updateScroll();a.scrollFix(t,t.get().peer,u)}o&&setTimeout(()=>lc(e,t,a,s,r,!1),100)}}function cc(e,t){e.get().resendAllOnOnline&&t()}function dc(){!function(e){var t="safari-repaint";e.forEach((function(e){hasClass(e,t)&&removeClass(e,t),addClass(e,t)})),setTimeout((function(){e.forEach((function(e){removeClass(e,t)}))}),100)}([geByClass1("_im_dialog_actions"),geByClass1("_im_chat_input_w"),ge("side_bar"),geByClass1("_im_right_menu"),geByClass1("_im_dialogs_settings"),geByClass1("_im_dialogs_search")])}function uc(e){var t,a,s,r=e.get();return Object(i.isLocksAvailable)(e)?(t=r.mutex_key,a=function(e){r.longpoll.push([B.mutexEvent(e)])},s=function(e,t){return Object(n.getMutexQueue)(r.gid).then(e=>Hl(e,1)[0])},Notifier.addKey(t,ll.bind(null,a,s,t)),al.set(t,{onData:a,onUpdateKey:s,ts:t.ts}),rl(),{stop:ol.bind(null,t)}).stop:null}function gc(e,t){var a,r=t.get(),o=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_im"+o+".ico"),lc(e,t,!1,!1,!1,!0),Object(nt.statlogsBrowserNotificationsUser)();var d=Object(c.createMutations)(sc),u=d.callMutations,g=d.bindMutations,m=r.useFcLongpoll&&vk.lpConfig.enabled&&Notifier.getLpInstance&&Notifier.getLpInstance(),_=m?Notifier.getLpInstance():t.get().gid?function(e){Object(Uo.imWeirdLog)("im_start_longpoll_group",{},!1);var t=Object(Ho.createLongpollEventsQueue)(e.ts,e=>{n.trigger("data",e)}),a=Object(Fo.createLongpoll)(e,t.onLp),n=new window.EventEmitter;return{onData:e=>n.on("data",e),offData:e=>n.off("data",e),push:e=>n.trigger("data",e),pause:t.pause.bind(t),resume:t.resume.bind(t),abortWaiting:a.abortWaiting.bind(a),onLp:t.onLp.bind(t),stop:a.stopConnection.bind(a),isEnabled:()=>!(!a||a.isStopped())}}(r.lpConfig):tl(r);_.onData(v);var p=Notifier.getEventQueueInstance&&Notifier.getEventQueueInstance(),h=p?p.subscribe(e=>u().onQueueEvent(t,e)):()=>{};function v(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];u().onEvents(t,a)}m&&Object(Uo.imWeirdLog)("im_use_fc_longpoll",{},!1);var f=geByClass1("_im_dialogs_search",e),O=geByClass1("_im_dialogs_settings",e),C=Ue(geByClass1("_im_page_dcontent",e),t,u,f);C.updateStarPosition(),C.renderPeerTags(t);var y,j,E=Er(f,t,u),S=Ur(O,t,u),T=Cl(t);(cur.imDb=Object(_i.mount)(t.get().gid?-t.get().gid:vk.id),t.set(n.preloadSearchIndex.bind(null,cur.imDb)),Object(i.isClassicInterface)(t)&&S.updateSettings(t),Object(i.isClassicInterface)(t))&&(y=fl(geByClass1("_im_ui_peers_list",e.parentNode),t),j=function(e,t,a,n){if(browser.mobile)return!1;var i=[t,a,geByClass1("_im_chat_input_w",n),geByClass1("_im_dialog_actions",n)],s=null,r=hasClass(e,"im-page--header_static"),o=ge("im-group-online-disabled-notice");function l(){var t=Object(b.getNativeOption)("scrollLeft"),a=hasClass(e,"im-page--header_static"),n=[];s!==t?n=i.slice().concat([e]):a!==r&&(n=[e]),s=t,r=a,n.length>0&&n.forEach(n=>{var i=e===n&&a?0:-t;setStyle(n,{[cssTransformProp]:0===i?"unset":"translateX("+i+"px)"})})}return o&&i.push(o),i=i.concat(geByClass("_im_aside_notice"),geByClass("_im_aside_promo_block")),addEvent(window,"scroll",l),l(),()=>{removeEvent(window,"scroll",l)}}(f,O,geByClass1("_im_right_menu",e.parentNode),e));Object(i.isClassicInterface)(t)&&r.peer&&C.deactivate(),r.gid||(a=Object(W.partConfigEnabled)("messages_chat_creation_new_interface")?Po(t):Io(geByClass1("_im_dialogs_creation",e),t,u));var w=Rs(geByClass1("_im_page_history",e),t,C,y,u),I=r.isCreating,A=I?"create":0===r.peer?"search":"default";I&&a.show(t,[]);var M=Bo(t,A,C,w,E,a),k=kl(t,M);w.renderPeerProfile(t),w.updateScroll();var L=rc.bind(null,u,t,M);r.peer&&t.set(n.prepareCasperMessagesFromMessages.bind(null,r.peer)),Object(i.isReservedPeer)(r.peer)||setTimeout(()=>Vl(t,w),10);var P=new Bl.default({id:"im",element:document,focusElement:window,triggerEvents:"mouseover mousedown keypress"}),N=Object(Ca.debounce)(dc,300),D=lc.bind(null,e,t,w,C,a,!1,N),x=cc.bind(null,t,w.resendAll);t.setState({longpoll:_}),t.set(n.setExecStack.bind(null,[])),P.on("unidle",(function(){_.abortWaiting(),L()})),P.start(),nav.objLoc.box&&(Wl(t,nav.objLoc.box),Object(mi.updateLocation)({box:null})),nav.objLoc.mr&&Object(i.isChatPeer)(Number(nav.objLoc.mr))&&C.showInvitationBox(t,nav.objLoc.mr);var B,R=uc(t);if(Object(i.isLocksAvailable)(t)&&(B=setInterval(i.blockLatencyCompensation.bind(null,t,r.longpoll),2e3)),t.get().invitation&&Object(i.showInvitationBox)(t,t.get().invitation,n.leaveInvitation),Object(i.isClassicInterface)(t)&&Object(s.existsIncomingMessageRequest)(t)){var F=document.getElementById("ui_rmenu_mr");F&&F.classList.remove("unshown")}var H=Object(l.throttleAccumulate)(ql.bind(null,t,w,C,y),200),U=i.hideTopNotice.bind(null,t),G=i.hideAsideNotice.bind(null,t);return Rl.casperMessagesStore.subscribe(e=>function(e,t,a,n,i){var r=i.type,o=i.message;switch(r){case Rl.EXPIRING:return t.updateCasperMessageStatus(o);case Rl.EXPIRING_SOON:return t.updateCasperMessageStatus(o,!0);case Rl.EXPIRED:Object(s.isCasperChat)(e,o.peerId)?n(o):(t.handleMessageExpiration(o),a.updateDialog(o.peerId,e))}}(t,w,C,H,e)),Rl.casperMessagesStore.setTimeshift(r.timeshift),g(Object(c.createModule)({handlers:(t,a)=>{t(document,"mousemove mousedown keypress",L),t(window,"resize",D),t(window,"online",x),a(e,"click",i.HIDE_TOP_NOTICE_CLASS,U),a(gpeByClass("_im-page-wrap",e),"click",i.HIDE_ASIDE_NOTICE_CLASS,G),a(gpeByClass("_im-page-wrap",e),"click",i.HIDE_ASIDE_PROMO_BLOCK_CLASS,i.hideAsidePromoBlock),a(gpeByClass("_im-page-wrap",e),"click",i.INSTALL_VKADMIN_LINK,i.installVKAdminApp),browser.safari&&t(document,"visibilitychange",dc)}}),C,w,E,e,P,_,H,u,a,S,t,M,R,B,y,j,T,k,D,(function(){m?_.offData(v):_.stop()}),h)}var mc,_c;function pc(e){var t=ge("page_header"),a=window.clientHeight()-t.offsetHeight-30-2;setStyle(e,{height:Math.max(a,400)})}function hc(e){var t=Object(i.formatTimespan)(Math.floor(Math.max(e,0)/1e3),!0);return t?getLang("mail_sick_timer").replace(/{timer}/gi,t):""}function bc(){nav.reload({force:!0})}function vc(e){return{unmount(){clearInterval(_c),clearTimeout(mc),Object(c.destroyModule)(e)}}}function fc(e,t,a){pc(e);var n,i,s=(0,Object(c.createMutations)(vc).bindMutations)(Object(c.createModule)({handlers:(t,a)=>{t(e.querySelector("._im_sick_reload"),"click",bc),t(window,"resize",pc.bind(null,e))}})),r=(n=localStorage.getItem("im_sick_timer"),i=n?Math.min(2*parseInt(n),6e5):5e3,localStorage.setItem("im_sick_timer",i),i),o=e.querySelector("._im_sick_timer"),l=+new Date;return o.innerHTML=hc(r),_c=setInterval(()=>{o.innerHTML=hc(l+r-new Date)},500),mc=setTimeout(bc,r),s}var Oc=a("f4YT"),Cc=a.n(Oc),yc=function(){return(yc=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};window.IM={init:function(e){var t,a;if(window.imwl=e.imwl,Object(Uo.startLoggingAllUnhandled)(),Object(hi.addTemplates)(Cc.a),window.cur.lang.dont_attach=Object(fa.getLang)("mail_dont_add_media"),e.failed)return fc(Object(bi.geByClass1)("im-sick",Object(bi.ge)("page_body")));localStorage.removeItem("im_sick_timer"),window.cur.ctrl_submit=e.ctrl_submit,window.cur.module="im",window.cur.mutedPeers=e.mutedPeers,window.cur.gid=e.gid,window.cur.peer=e.peer,window.cur.options={blacklist_hash:e.thash};var s=-10800-60*(new Date).getTimezoneOffset(),r=e.timeshift,o=yc(yc({},e),{owners:void 0,tabbedPeers:(e.tabbedPeersArray||[]).map((function(e){return{peer:e,type:"perm"}})),blockedFlagUpdates:{},msgid:Object(hi.intval)(window.nav.objLoc.msgid),timeshift:r-s,oCache:{},ref_id:window.nav.objLoc.ref,ref_source:window.nav.objLoc.ref_source,topConvTree:new Promise((function(){})),hintsTree:new Promise((function(){})),imTopConvList:new Promise((function(){}))}),l=Object(h.default)(o);null===(t=e.owners)||void 0===t||t.forEach((function(e){return Object(F.oCacheAdd)(l,e)})),Object(i.normalizeTabsGotFromServer)(l,l.get().tabs),window.cur.imClassicInterface=Object(i.isClassicInterface)(l);var c=gc(Object(bi.geByClass1)("js-im-page",Object(bi.ge)("page_body")),l);Object(n.updateMentions)(l.get()),e.group_calls_feature_tt_hash&&Object(i.showGroupCallsOnboardingBox)(l.get(),e.group_calls_feature_tt_hash),e.group_calls_new_year_feature_tt_hash&&Object(i.showGroupCallsNewYearTooltip)(l.get(),e.group_calls_new_year_feature_tt_hash),window.IMBRIDGE={chatPhotoSaved:function(e){window.curBox()&&window.curBox().hide();var t=(e||{})[1];return t?(window.cur.pvShown&&window.layers.fullhide(!0,!0),"im"!=window.cur.module||l.get().peer!=t?window.nav.go("/im?sel=c"+(t-2e9)):void 0):window.nav.reload()},syncHistory:function(){l.set((function(e){return Object(n.syncHistory)(e)})).then((function(){}),(function(){}))},activateTab:function(e){l.get().gid||l.get().longpoll.push([Object(d.changePeer)(Object(hi.intval)(e),!1,!1,!0)])}},Object(W.partConfigEnabled)("debug_messenger")&&(window.IMBRIDGE.store=l);var u=!1;window.cur.nav.push((function(){var e;return!!u||((null===(e=l.get().audio_msg)||void 0===e?void 0:e.isRecording)&&c.cancelRecording(),window.AudioMessagePlayer.detachPlayer(),c.route.apply(null,arguments))})),null===(a=window.cur.destroy)||void 0===a||a.push((function(){if(u)return!0;c.unmount(),window.IMBRIDGE=void 0,l.unmount(),window.store=void 0,u=!0,e=!1,l=!1,c=!1,Object(Uo.stopLoggingAllUnhandled)()}))}};try{window.stManager.done("imn.js")}catch(e){}},V1lx:function(e,t,a){"use strict";a.r(t),a.d(t,"setHTML",(function(){return r}));a("91GP"),a("ioFf"),a("rGqo"),a("Btvt");var n=a("q1tI");a("17x9");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}function r(e,t){var a=!!window.getSelection&&window.getSelection(),n=!1;if(a&&a.rangeCount){var i=a.getRangeAt(0);n=i.commonAncestorContainer?i.commonAncestorContainer:i.parentElement?i.parentElement():i.item(0)}for(var s=n;s&&s!=e;)s=s.parentNode;window.Emoji&&(s||window.Emoji.editableFocus(e,!1,!0),window.Emoji.insertHTML(t))}class o extends n.Component{constructor(){super(...arguments),this.onChange=()=>{this.props.onChange&&window.Emoji&&this.props.onChange(window.Emoji.val(this.container))},this.containerRef=n.createRef(),this.state={value:this.props.initialValue}}componentDidMount(){if(this.container=this.containerRef.current,this.container&&!this.isMount){this.isMount=!0;var e=this.props.initialValue;window.Emoji&&(window.Emoji.val(this.container,window.Emoji.emojiToHTML(e)),window.Emoji.init(this.container,{noStickers:!0,onSend:()=>{},ctrlSend:()=>!0,onChange:this.onChange,noLineBreaks:!this.props.isMultiLine}))}}componentWillUnmount(){this.container&&this.isMount&&(this.isMount=!1)}render(){var e=this.props,t=e.tabIndex,a=e.isMultiLine,r=(e.initialValue,s(e,["tabIndex","isMultiLine","initialValue"]));return n.createElement("div",i({role:"textbox",ref:this.containerRef,tabIndex:t,contentEditable:!0,"aria-multiline":a},r))}}o.defaultProps={isMultiLine:!1,tabIndex:0,initialValue:""},t.default=o},XLJO:function(e,t,a){"use strict";a.r(t),a.d(t,"checkContactListLoaded",(function(){return U})),a.d(t,"mount",(function(){return ie}));a("rGqo"),a("pIFo"),a("VRzm"),a("Btvt");var n=a("EasH"),i=a("FWc3"),s=a("4+be"),r=a("ofcU");var o=a("vT4u"),l=a("P13b"),c=a("eaP7"),d=a("rDjD"),u=a("rHUl"),g=a("ZxpX"),m=a("MhhX"),_=a("86+7"),p=a("Wu9C"),h=a("ZoqV"),b=a("t7TG"),v=a("i8i4"),f=a("q1tI"),O=a.n(f),C=a("e87a"),y=a("GSQL"),j=function(e){var t=e.icon,a=e.children,n=Object(g.classNames)("ContactIconRow__icon","ContactIconRow__icon--"+t);return O.a.createElement("div",{className:"ContactIconRow"},O.a.createElement("div",{className:n}),O.a.createElement("div",{className:"ContactIconRow__text"},a))},E=a("Aegd"),S=a("85vT"),T=a("6krn"),w=function(e){var t=e.contact,a=t.id+19e8;return O.a.createElement("div",{className:"ContactPopupContent"},O.a.createElement("header",{className:"ContactPopupContent__header"},O.a.createElement("div",{className:"ContactPopupContent__photo"},O.a.createElement(E.ConversationNoPhoto,{text:Object(l.getUserInitials)(t.name),size:"80",id:a,specificType:7,key:t.id})),O.a.createElement("h3",{className:"ContactPopupContent__title"},O.a.createElement(S.default,null,Object(l.prepareContactName)(t.name))),O.a.createElement("div",{className:"ContactPopupContent__meta"},Object(T.getLang)("mail_from_contacts_list"))),O.a.createElement("div",{className:"ContactPopupContent__info"},t.main_phone&&O.a.createElement(j,{icon:"phone"},Object(l.formatPhoneNumber)(t.main_phone)),t.emails[0]&&O.a.createElement(j,{icon:"mail"},O.a.createElement("a",{href:"mailto:"+t.emails[0]},t.emails[0]))),t.sync_date&&O.a.createElement("div",{className:"ContactPopupContent__info"},O.a.createElement(j,{icon:"sync"},t.sync_date)))},I=a("QDnf"),A=a("aong"),M=function(e){var t=e.getContactInfo,a=e.onClose,n=O.a.useState({kind:"loading"}),i=n[0],s=n[1];switch(O.a.useEffect((function(){var e=function(e){Object(A.showErrorBox)(e),s({kind:"failed"}),a()};t().then((function(t){t?s({kind:"loaded",contact:t}):e(Object(T.getLang)("mail_contact_was_removed"))})).catch((function(){e(Object(T.getLang)("global_error"))}))}),[]),i.kind){case"failed":return O.a.createElement(O.a.Fragment,null);case"loading":return O.a.createElement(I.default,null);case"loaded":return O.a.createElement(C.default,{onClose:a,className:"ContactPopup"},O.a.createElement(y.default.Header,{title:Object(T.getLang)("mail_contact"),onClose:a,appearance:"blue"}),O.a.createElement(w,{contact:i.contact}))}};function k(e,t,a){var n=L();if(n){var i=t-19e8;v.render(f.createElement(M,{store:e,onClose:a.closeContactPopup,getContactInfo:()=>function(e,t){return U(e).then(e=>{var a=function(e,t){var a=e.get().contactsList;return a?a.find(e=>e.id===t):null}(e,t);return Promise.resolve(a)})}(e,i)}),n)}}function L(){return document.querySelector("._im_contact_popup_container")}function P(e,t){return{unmount:()=>function(e,t){var a=L();a&&v.unmountComponentAtNode(a),Object(r.destroyModule)(e)}(e),closeContactPopup(){var e=L();v.unmountComponentAtNode(e)}}}var N=a("q2pz");var D=a("vhcd"),x=a("shih"),B=a("W9Tc"),R="im-page--header-action_loading";function F(e,t,a){return!e.map(e=>{var n=Object(u.getMessage)(t,a,e);return Object(m.isImportant)(n)}).reduce((e,t)=>e&&t,!0)}function H(e,t){var a=t.get(),n=a.peer,i=a.tabs[n].pinned;return 1===e.length&&i&&e[0]===Object(u.parserMessage)(i).messageId}function U(e){return e.get().contactsList?Promise.resolve(e):e.set(o.getContactsList)}function G(e,t,a){var n=Object(s.getLang)("mail_selected_shorted",t.length);V({actions:!0},"im-page--chat-header"),val(geByClass1("im-page--selected-messages"),getTemplate("im_selected_messages",{label:n.replace("{count}",t.length),tip:Object(s.getLang)("mail_deselect_all")}));var i=Object(u.getTab)(a,a.get().peer),r=e.querySelector("._im_mess_actions"),o=F(t,a,a.get().peer),c=H(t,a),d=t.length>1,m=!d&&Object(l.isChatPeer)(i.peerId)&&Object(l.canPinMessage)(a,t[0]),_=Object(l.canForwardMessages)(a,t),p=e.querySelector('._im_page_action[data-action="respond"]'),h=e.querySelector('._im_page_action[data-action="forward"]'),b=Boolean(Object(u.tabIsOutgoingMessageRequest)(i)),v=Boolean(Object(u.tabIsMessageRequest)(i));r.className=Object(g.classNames)("im-page--mess-actions _im_mess_actions",{"im-page--mess-actions_important":!o,"im-page--mess-actions_pinned":c,"im-page--mess-actions_channel":Object(u.isChannelPeer)(i)&&!a.get().gid,"im-page--mess-actions_multiple-selection":d,"im-page--mess-actions_no-pin-btn":!m,"im-page--mess-actions_out-mr":b,"im-page--mess-actions_in-mr":v,"im-page--mess-actions_no-important-btn":!Object(l.canMarkImportant)(a,t)}),t.length>1?p.innerHTML=Object(s.getLang)("mail_forward_here"):p.innerHTML=Object(s.getLang)("mail_im_mark_reply"),_?(h.removeAttribute("disabled"),h.classList.remove("button_disabled")):(h.setAttribute("disabled","disabled"),h.classList.add("button_disabled")),d&&!_?(p.setAttribute("disabled","disabled"),p.classList.add("button_disabled")):(p.removeAttribute("disabled"),p.classList.remove("button_disabled"));var f=o?Object(s.getLang)("mail_im_toggle_important"):Object(s.getLang)("mail_im_toggle_important_off"),O=c?Object(s.getLang)("mail_unpin"):Object(s.getLang)("mail_pin");attr(geByClass1("im-page-action_star",e),"aria-label",f),attr(geByClass1("im-page-action_pin",e),"aria-label",O)}function q(e,t,a){var n=t.get(),i=n.peer,s=n.tabs[i],r=geByClass1("_im_chat_verified",e),c=geByClass1(l.PINNED_CONTAINER_CLASS,e),d=Object(l.isChatPeer)(i),g=d&&Object(u.isChannelPeer)(s),m=n.selectedMessages&&!!n.selectedMessages.length;r.tt=!1;var h=Object(l.renderPhotosFromTab)(t,s,!0),b=getTemplate("im_simple_link",{href:g?"/club"+-s.ownerId:s.href,content:getTemplate("im_peer_photo",{online_class:"",owner_photo:h,modifier_class:"nim-peer_smaller"})});val(geByClass1("im-page--aside-photo",e),b);var v=d&&Object(u.isChatActive)(s),f={muted:inArray(i,n.mutedPeers),verified:!!s.verified,chat:d,vkcomgroup:g,actions:m,derelict:d&&!v&&!g,pinned:!1};if(d){var O=Object(u.getPinnedMessage)(t),C=function(e){var t=Object(u.getPinnedMessage)(e);if(!t||Object(_.oCacheGet)(e,t.userId))return!1;return t.userId}(t);O&&Object(p.isPinnedMessageVisibleInTab)(t,i)&&(C?t.set(o.loadChatMember.bind(null,{[i]:[C]})).then(q.bind(null,e,t,a)):f.pinned=!0)}W(t,s,e);var y=!s.top_banner&&c.innerHTML,j=!s.top_banner&&K(t,e,c),E=geByClass1("_im_page_peer_name",e);removeClass(E,l.DESELECT_ALL_CLASS),function(e,t,a){var n=a.length>0;geByClass("_im_header_icon",e).forEach(e=>{if("star"===e.dataset.type&&Object(l.isFoldersAvailable)(t)&&(toggleClass(e,"im-page--header-icon_shown",!n),toggleClass(e,"im-page--header-icon_star-active",Object(l.isImportant)(t))),"answer"===e.dataset.type&&Object(l.isFoldersAvailable)(t)&&toggleClass(e,"im-page--header-icon_shown",!n&&Object(l.isUnrespond)(t)),"search"===e.dataset.type&&!Object(l.isCommunityInterface)(t)){var a=t.get().peer,i=!n&&Object(l.isFullyLoadedTab)(t,a)&&Object(u.getTab)(t,a).offset&&!Object(l.isCommunityInterface)(t)&&(!Object(l.isCallToPeerAvailable)(t,a)||!Object(l.isClassicInterface)(t));toggleClass(e,"im-page--header-icon_shown",i)}})}(e,t,[]);var S=e.querySelector("._im_dialog_call_action_wrapper"),T=e.querySelector("._im_header_icon[data-type=call]");if(S&&S.classList.toggle("im-page--header-call-is-hidden",!Object(l.isCallToPeerAvailable)(t,i)||!!s.callInProgress),T&&(T.classList.toggle("im-page--header-icon_shown",Object(l.isCallToPeerAvailable)(t,i)&&!!s.callInProgress),T.classList.toggle("im-page--header-icon_call-active",!!s.callInProgress&&s.callInProgress.participants.count>0)),Object(l.isClassicInterface)(t)){var w=geByClass1("_im_page_back",e);attr(w,"href",`${Object(l.getBaseLink)(t)}?tab=${n.active_tab}`)}V(f,"im-page--chat-header"),Object(l.compensateHistoryHeightChange)(t,j,y,a)}function W(e,t,a){var n=Object(l.isChatPeer)(t.peerId),i=n&&Object(u.isChannelPeer)(t),r=n&&Object(u.isChatActive)(t),o=n&&Object(u.isCasperChatTab)(t),c=Object(l.isContactPeer)(t.peerId),d=t.name,g="";n?g=i?getTemplate("im_vkcomgroup_members",{name:Object(s.getLang)("mail_im_n_vkcomgroup_members",Object(l.getAliveMembersCount)(t))}):r?getTemplate("im_chat_members",{name:Object(s.getLang)("mail_im_n_chat_members",Object(l.getAliveMembersCount)(t))}):"":Object(l.isUserPeer)(t.peerId)&&(g=Object(l.getLastSeenTextInHeader)(e,t.peerId));var m=[];""===g&&m.push("im-page--title--1line"),o&&m.push("im-page--title--casper"),m=m.join(" ");var _=getTemplate("im_simple_name",{name:c?Object(l.prepareContactName)(t.name):t.tab,href:i?"/club"+-t.ownerId:t.href,name_attr:d,ads_union:t.ad_union_ids_attr,online:g,more_cls:m});val(geByClass1("im-page--title-wrapper",a),_)}function K(e,t,a){var n=Object(u.getPinnedMessage)(e),i=a||geByClass1(l.PINNED_CONTAINER_CLASS,t);if(removeClass(i,"im-page--pinned_with-bar"),n&&Object(m.isMoneyRequest)(n)){if(void 0===n.kludges.attach1_tr_amount)return;n.kludges.attach1_total_amount&&addClass(i,"im-page--pinned_with-bar")}var s=Object(l.renderPinnedMessage)(e);return val(i,s),!!s}function V(e,t){var a=geByClass1(t);Object.keys(e).forEach(n=>{toggleClass(a,`${t}_${n}`,!!e[n])})}function Y(e,t,a,n,i){e.set(o.removeMessagesWithRestore.bind(null,a,i,n)).then(t().removeMessagesRestore.bind(null,a,i,n)),Object(o.removeMessageSend)(a,i,null,n,e.get()).then(()=>{var n=Object(u.getTab)(e,i);a.includes(n.lastmsg)&&Object(o.loadActualLastMessage)(e,i).then(()=>{Object(B.partConfigEnabled)("messenger_empty_pinned_support")&&t().updateConvoInList(i,e),t().updateState(i,e)})})}function z(e,t,a,n,i){var s=e.get().selectedMessages,r=domData(i,"action"),d=e.get().peer,g=Object(u.getTab)(e,d),m=!0;if(!["star","delete"].includes(r)&&Object(u.tabIsOutgoingMessageRequest)(g))return X(e,t,a);switch(r){case"delete":var _=!(vk.id==d&&!e.get().gid)&&s.every(t=>Object(l.canMessageBeDeletedForAll)(e,Object(u.getMessage)(e,d,t)));if(_||s.length>1){m=!1;var p=Object(l.showMsgDeleteDialog)(d,s.length,_,n=>{X(e,t,a),p.hide(),cur.imDb.updateByKey("del_forall_checked",n),n?Object(o.removeMessageSend)(s,d,null,"deleteforall",e.get()):Y(e,t,s,r,d)})}else Y(e,t,s,r,d);break;case"spam":Y(e,t,s,r,d);break;case"forward":if(!Object(l.canForwardMessages)(e,s))return;Object(o.processFwd)(s,d,e).then(t=>e.set(o.prepareForward.bind(null,t))).then(()=>a().showForward(e)).catch(e=>console.error(e));break;case"star":var h=F(s,e,d);e.set(o.favMessage.bind(null,s,h,d)),e.get().longpoll.push(s.map(e=>({type:h?c.SET_FLAGS:c.RESET_FLAGS,messageId:e,peerId:d,flags:c.FLAG_IMPORTANT})));break;case"respond":var b=e.get(),v=1===s.length;Object(o.processFwd)(s,b.peer,e).then(t=>e.set(o.forwardMessages.bind(null,t,b.tfdraft,v))).then(()=>{t().respond(e,d)});break;case"pin":var f=Object(u.getLocalId)(e,s[0]);if(!Object(l.canPinMessage)(e,f))return;var O=H(s,e),C=O?o.unpinMessageOptimistic.bind(null,d):o.pinMessageOptimistic.bind(null,f,d),y=O?o.unpinMessage.bind(null,d):o.pinMessage.bind(null,f,d),j=ae.bind(null,t,d);e.set(o.checkChatMember.bind(null,e,f,d)).then(e=>e.set(C)).then(j).then(e=>e.set(y)).then(j)}m&&X(e,t,a)}function Q(e,t,a,i,r,c){var g=domData(c,"action"),m=i.querySelector("._im_dialog_action_wrapper ._ui_menu").parentNode,h=e.get().peer;switch(g){case o.CHAT_ACTION_CLEAR:var b=Object(u.getTab)(e,h),v=Object(l.showFlushChat)(b,h,()=>{Object(l.cleanHistory)(e,v,t,o.flushHistory,e.get().peer)});break;case o.CHAT_ACTION_MEDIA:showWiki({w:"history"+Object(l.convertPeerToUrl)(h)+"_photo"},null,{});break;case o.CHAT_ACTION_CALL_AUDIO:case o.CHAT_ACTION_CALL_VIDEO:Object(l.isCallToPeerAvailable)(e,h)&&Object(l.startCallFromIm)(e,h,g===o.CHAT_ACTION_CALL_VIDEO,[],l.CALL_ENTRY_POINT_HEADER);break;case o.CHAT_ACTION_CALL_APP:if(Object(l.isCallToPeerAvailable)(e,h)){(function(e){return new Promise((t,a)=>{if(window.browser&&browser.mobile)a("is_mobile");else if(document.body.focus(),"hidden"===document.visibilityState||document.hidden)a("hidden_page");else{var n,i=()=>{n&&clearTimeout(n),window.removeEventListener("blur",i),t()};if(window.addEventListener("blur",i),n=setTimeout(()=>{window.removeEventListener("blur",i),a("timed_out")},2e3),window.browser&&(browser.safari||browser.mozilla)){var s=document.createElement("iframe");s.style.display="none",document.body.appendChild(s);var r=s.contentWindow;r?(r.location.href=e,setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},100)):window.location.href=e}else window.location.href=e}})})("vkcall://payload").then(()=>{window.console&&console.log("Native app check success")}).catch(e=>{window.console&&console.log("Native app check failed",e)})}break;case o.CHAT_ACTION_SEARCH:t().showSearch(e);break;case o.CHAT_ACTION_BLOCK_NOTIFY:case o.CHAT_ACTION_BLOCK_COMMUNITY:e.set(o.toggleCommunityMessages.bind(null,!1,h)).then(()=>{e.get().longpoll.push([Object(d.resetPeer)()]),showDoneBox(Object(s.getLang)("mail_community_was_blocked"))});break;case o.CHAT_ACTION_ALLOW_COMMUNITY:e.set(o.toggleCommunityMessages.bind(null,!0,h)).then(()=>{a().changeActions(e)});break;case o.CHAT_ACTION_BLOCK:Object(l.showBlacklistBox)(h,e).once("success",t=>{t.delta&&(showDoneBox(t.msg),e.get().longpoll.push([Object(d.resetPeer)()]))});break;case o.CHAT_ACTION_LEAVE:var f=Object(l.showLeaveDialog)(e,h,a=>{var n=e.set(o.leaveChat.bind(null,h)).then(()=>e.set(o.unpinMessageOptimistic.bind(null,h)));a&&n.then(()=>Object(l.cleanHistory)(e,f,t,o.flushHistory,h)),f.hide(),e.get().longpoll.push([Object(d.resetPeer)()])});break;case o.CHAT_ACTION_UNREAD:var O=e.get();Object(o.markDialogUnread)(O.peer,O);break;case o.CHAT_ACTION_RETURN:e.set(o.returnToChat.bind(null,h)).then(e=>e.set(o.getPinnedMessage.bind(null,h))).then(t().updateChatTopic.bind(null,h)).catch(e=>{Object(n.showFastBox)(Object(s.getLang)("global_error"),e)});break;case o.CHAT_ACTION_MUTE:case o.CHAT_ACTION_UNMUTE:e.set(o.toggleMutePeer.bind(null,h,g===o.CHAT_ACTION_MUTE,-1)).then(t().updateState.bind(null,h));break;case o.CHAT_ACTION_PIN_CONVO:Object(x.pinConvoHandler)(e.get(),h).catch(e=>{Object(A.showErrorBox)(e)});break;case o.CHAT_ACTION_UNPIN_CONVO:Object(x.unpinConvoHandler)(e.get(),h).catch(e=>{Object(A.showErrorBox)(e)});break;case o.CHAT_ACTION_CHAT_INVITE:Object(l.inviteUser)(e,h,t,o.setCreationType);break;case o.CHAT_ACTION_USER_INVITE:var C=Object(u.getTab)(e,h);if(Object(l.isUserPeer)(h)&&C.canBeAddedToChat){Object(D.collectConvoInviteStats)(D.ConvoInviteEntryPoint.DIALOG_ACTIONS,h);var y=Object(l.isContactPeer)(h)?function(e){return{id:e.peerId,link:e.href,name:e.name,first_name:"",short_name:"",inv_name:"",kick_name:"",sex:e.sex,photo:e.photo||""}}(C):Object(_.oCacheGet)(e,h);Object(N.mount)(e,y,t=>{var a;return Promise.resolve(null===(a=e.get().longpoll)||void 0===a?void 0:a.push([Object(d.changePeer)(t,!1)]))},t=>{var a;return null===(a=e.get().longpoll)||void 0===a?void 0:a.push([Object(d.changePeer)(t,!1,!0,!0)])})}break;case o.CHAT_ACTION_CREATE_CHAT:var j=Object(u.getTab)(e,h),E=[[h,j.tab]];e.set(o.setCreationType.bind(null,"chat",[])).then(()=>t().showCreation(e,E));break;case o.CHAT_ACTION_PIN_HIDE:Object(p.pinnedMessageHide)(e,Object(u.getPeer)(e),t);break;case o.CHAT_ACTION_PIN_UNHIDE:Object(p.pinnedMessageUnHide)(e,Object(u.getPeer)(e),t);break;case o.CHAT_ACTION_UNPIN:Object(p.pinnedMessageUnpin)(e,Object(u.getPeer)(e),t);break;case o.CHAT_ACTION_SETTINGS:a().showSettings(e)}uiActionsMenu.toggle(m,!1),t().cancelEditing()}function X(e,t,a){var n=e.get().selectedMessages;e.set(o.cleanSelected).then(a().changedMessageSelection).then(t().cleanSelection.bind(null,n))}function $(e,t,a,n){var r,o,c=Object(l.isClassicInterface)(e);switch(domData(n,"type")){case"star":o=[4,6],r=()=>Object(l.isImportant)(e)?Object(s.getLang)("mail_im_toggle_important_off"):Object(s.getLang)("mail_im_toggle_important");break;case"answer":o=[4,6],r=Object(s.getLang)("mail_end_conversation");break;case"search":o=c?[5,6]:[4,-9],r=Object(s.getLang)("mail_search_in_peer")}Object(i.showTooltip)(n,{text:r||"",black:1,shift:o,forcetoup:!0,appendParentCls:c?"_im_dialog_actions":"_im_mess_actions"})}function J(e,t,a){var n=Object(l.isClassicInterface)(e),s=domData(a.target,"action");"respond"!==s&&"forward"!==s&&Object(i.showTooltip)(a.target,{text:Z.bind(null,e,s)||"",black:1,shift:[2,n?-4:11],forcetodown:!0,appendParentCls:"_im_dialog_actions"})}function Z(e,t){var a=e.get(),n=a.selectedMessages,i=a.peer;switch(t){case"pin":return H(n,e)?Object(s.getLang)("mail_unpin"):Object(s.getLang)("mail_pin");case"star":return F(n,e,i)?Object(s.getLang)("mail_im_toggle_important"):Object(s.getLang)("mail_im_toggle_important_off");case"delete":return Object(s.getLang)("mail_delete");case"spam":return Object(s.getLang)("mail_im_mark_spam")}}function ee(e,t,a,n,i){var r=domData(i,"type"),c=e.get().peer;switch(r){case"star":e.set(o.toggleDialogImportant.bind(null,c)).then(()=>{setTimeout(()=>$(e,0,0,i),40)});break;case"search":a().showSearch(e),window.tooltips&&tooltips.hide(i,{fasthide:!0});break;case"answer":var g=Object(u.getTab)(e,c);g&&(e.set(o.markDialogAnswered.bind(null,e.get().peer,g.lastmsg)),showDoneBox(Object(s.getLang)("mail_marked_as_answered"),{out:1e3}),e.get().longpoll.push([Object(d.resetPeer)()]));break;case"call":if(Object(l.isCallToPeerAvailable)(e,c)){var m=Object(u.getTab)(e,c).callInProgress;m&&Object(l.joinCallFromIm)(e,c,m.join_link,!1,l.CALL_ENTRY_POINT_JOIN_HEADER)}}}function te(e,t){var a=Number(t),n=Object(l.formatTimespan)(a,!0),i=Object(s.getLang)("mail_network_waiting").replace(/{timer}/gi,n);e.querySelector("._im_page_status").innerHTML=i}function ae(e,t,a){return e().updateChatTopic(t,a),a}function ne(e,t,a,n){var i={};return{changeActions(t){var a=e.querySelector("._im_dialog_action_wrapper ._ui_menu"),n=geByClass1("_im_dialog_action_wrapper",e),i=t.get().curActions,s=Object.keys(i).map((e,t)=>{var a="";return 7!==o.ACTION_PRIORITIES[e]&&10!==o.ACTION_PRIORITIES[e]||0===t||(a='<div class="ui_actions_menu_sep"></div>'),a+getTemplate("sImUiActionMenuItem",{action:e,name:i[e].name,icon:i[e].icon,classes:"_im_action"})}).join("");0===Object.keys(i).length?addClass(n,R):(val(a,s),removeClass(n,R))},setNetworkWaitingStatus(t){i.interval&&clearInterval(i.interval),te(e,t),i.timeout=t,i.interval=setInterval(()=>{i.timeout>1?(i.timeout--,te(e,i.timeout)):(clearInterval(i.interval),i={})},1e3)},setNetworkReconnectingStatus(){var t,a;i.interval&&clearInterval(i.interval),i={},t=e.querySelector("._im_page_status"),a=Object(s.getLang)("mail_network_reconnecting"),t&&(t.innerHTML=a)},clearNetworkStatus(){i.interval&&clearInterval(i.interval),i={},e.querySelector("._im_page_status").innerHTML=""},showSettings(t){var a=t.get(),i=Object(u.getTab)(t,a.peer);Object(u.isChatActive)(i)&&Object(h.mount)(e,t,n)},showForward(t){Object(b.mount)(e,t,n)},renderPeer(a){q(e,a,t)},reRenderPinned(t){var a=Object(u.getCurrentTab)(t);a&&a.pinned&&K(t,e)},reRenderTitle(t){var a=Object(u.getCurrentTab)(t);a&&W(t,a,e)},renderActions(t){var a=t.get().selectedMessages||[];a.length>0&&G(e,a,t)},hideActions(t){if(!Object(l.isFullyLoadedTab)(t,t.get().peer)){geByClass("_im_header_icon",e).forEach(e=>{addClass(e,R)});var a=geByClass1("_im_dialog_action_wrapper",e);addClass(a,R);var n=geByClass1("_im_dialog_call_action_wrapper",e);addClass(n,R)}},showActions(t){if(Object(l.isFullyLoadedTab)(t,t.get().peer)){geByClass("_im_header_icon",e).forEach(e=>{removeClass(e,R)});var a=geByClass1("_im_dialog_action_wrapper",e);removeClass(a,R);var n=geByClass1("_im_dialog_call_action_wrapper",e);removeClass(n,R)}},changedMessageSelection(a){if(0!==a.get().peer){var n=a.get().selectedMessages||[];n.length>0?G(e,n,a):q(e,a,t)}},updateLastSeen(t){!function(e,t){var a=e.get().peer,n=geByClass1("_im_page_peer_online",t);n&&Object(l.isUserPeer)(a)&&Object(u.getTab)(e,a)&&Object(l.applyInnerHtml)(n,Object(l.getLastSeenTextInHeader)(e,a))}(t,e)},deselectAll(e){X(e,t,n)},updateState(e){t().updateState.bind(null,e)},unmount(){Object(r.destroyModule)(a),cancelStackFilter("fowrward")}}}function ie(e,t,a){var n=Object(r.createMutations)(ne),i=n.callMutations,s=n.bindMutations,c=z.bind(null,t,a,i),u=Q.bind(null,t,a,i,e),g=X.bind(null,t,a,i),m=(e,a)=>Object(l.showVerifiedTooltip)(a,t.get().peer),_=$.bind(null,t,e),p=J.bind(null,t,e),h=ee.bind(null,t,e,a),b=()=>i().showSettings(t),v=a=>{var n=t.get().peer;Object(l.isContactPeer)(n)&&(!function(e,t,a,n){var i=(0,Object(r.createMutations)(P).bindMutations)(Object(r.createModule)({handlers:(e,t)=>{}}),e);k(e,t,i)}(t,n),cancelEvent(a)),!gpeByClass("im-page--chat-header_chat",a.target,e)||gpeByClass("im-page--chat-header_vkcomgroup",a.target,e)||checkEvent(a)||(b(),cancelEvent(a))},f=()=>function(e,t){var a=()=>{t&&(t.classList.remove("im-page--chat-header_reconnected"),t.removeEventListener("mouseleave",a))};t&&(t.classList.add("im-page--chat-header_reconnected"),t.addEventListener("mouseleave",a)),e.get().longpoll.abortWaiting()}(t,e),O=Object(r.createModule)({handlers:(a,n)=>{n(e,"click","_im_page_action",c),n(e,"click","_im_action",u),n(e,"click",l.DESELECT_ALL_CLASS,g),n(e,"mouseover","_im_chat_verified",m),n(e,"mouseover","_im_header_icon",_),n(e,"mouseover","_im_page_action",p),n(e,"click","_im_header_icon",h),n(e,"click","_im_header_link",v),n(e,"click","_im_page_peer_name",v),n(e,"click","_im_chat_members",b),n(e,"click","_im_page_reconnect",f),n(e,"click","_im_page_back",e=>{checkEvent(e)||(t.get().longpoll.push([Object(d.resetPeer)()]),cancelEvent(e))})}});return Object(l.isReservedPeer)(t.get().peer)||setTimeout(()=>{t.set(o.setActions).then(i().changeActions)}),s(e,a,O,i)}},XuPN:function(e,t,a){"use strict";a.r(t),a.d(t,"useIndexer",(function(){return s}));var n=a("1nu5"),i=a("q1tI"),s=function(e,t,a){var s=Object(i.useRef)(null);s.current=s.current?s.current:new n.VkIndexer(e,t);var r=s.current,o=Object(i.useCallback)((function(e){return e.reduce((function(e,t){return e[a(t)]=!0,e}),{})}),[]),l=Object(i.useState)(e),c=l[0],d=l[1],u=Object(i.useState)(o(e)),g=u[0],m=u[1];return Object(i.useEffect)((function(){var t=o(e),n=e.filter((function(e){return!g[a(e)]})),i=c.filter((function(e){return!t[a(e)]}));(n.length||i.length)&&(n.forEach((function(e){r.add(e)})),i.forEach((function(e){r.remove(e)})),d(e),m(t))}),[e]),r}},ZVxX:function(e,t,a){"use strict";a.r(t),a.d(t,"initFailBack",(function(){return n}));a("VRzm"),a("Btvt");function n(){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||window.MediaDevices&&window.MediaDevices.getUserMedia;e&&!navigator.mediaDevices&&(navigator.mediaDevices=navigator.mediaDevices||{}),navigator.mediaDevices&&(navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(t){return new Promise((function(a,n){e?e.call(navigator,t,a,n):n(new Error("NotSupported"))}))}),navigator.mediaDevices.enumerateDevices||(navigator.mediaDevices.enumerateDevices=function(){return new Promise((function(e,t){if(MediaStreamTrack&&MediaStreamTrack.getSources){var a={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources((function(t){e(t.map((function(e){return{label:e.label,kind:a[e.kind],deviceId:e.id,groupId:""}})))}))}t(new Error("NotSupported"))}))})),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(window.AudioContext.prototype.createScriptProcessor=window.AudioContext.prototype.createScriptProcessor||window.AudioContext.prototype.createJavaScriptNode)}},ZoqV:function(e,t,a){"use strict";a.r(t),a.d(t,"mount",(function(){return ve}));var n=a("ofcU"),i=a("q1tI"),s=a("i8i4"),r=(a("HEwt"),a("a1Th"),a("rGqo"),a("rE2o"),a("ioFf"),a("OEbY"),a("VRzm"),a("Btvt"),a("P13b")),o=a("vT4u"),l=a("rDjD"),c=a("6krn"),d=a("aong"),u=a("amDN"),g=a("BiHW"),m=(a("pIFo"),a("ZxpX")),_=a("s0Wt"),p=a("SSU4"),h=a("b8Q7"),b=a("lJdi"),v=a("ERyv"),f=c.default.getLang;class O extends i.PureComponent{constructor(e){super(e),this.onSaveTitle=e=>{var t=this.props.store,a=t.get(),n=e.value.trim().replace("\n","");n&&n!==unclean(this.props.title)&&(this.setState({titleChanged:!1}),t.set(o.updateChatTopic.bind(null,a.peer,n)))},this.onChangeTitle=e=>{if(this.state.title!==e.target.value){var t=e.target.value.replace("\n","");this.setState({title:t,titleChanged:unclean(this.props.title)!==t})}},this.onValidateTitle=e=>!!e.trim().replace("\n",""),this.onCancelTitle=()=>{this.setState({title:unclean(this.props.title),titleChanged:!1})},this.onSaveDescription=e=>{},this.onPhotoUpload=()=>{var e=this.props.store,t=e.get().peer;Object(b.canChangeTitle)(e)&&(cur.recieveCropResult=void 0,Page.ownerPhoto(t,{gid:e.get().gid}))},this.onPhotoRemove=()=>{var e=this.props.store,t=e.get().peer;Object(b.canChangeTitle)(e)&&e.set(o.removeChatPhoto.bind(null,t)).then(()=>e.set(o.getChatDetails.bind(null,t))).catch(e=>Object(v.imWeirdCatch)("onPhotoRemove",e))},this.state={title:unclean(e.title),titleChanged:!1}}getCasperInfo(){var e=f("mail_casper_chat_info");return i.createElement(i.Fragment,null,f("mail_casper_chat_label"),i.createElement(_.default,{text:e,position:"t",appearance:"light",maxWidth:280,marginTop:-6},i.createElement(h.default,{"aria-label":e,className:"ChatSettingsInfo__casperHint"})))}render(){var e=this.props,t=e.store,a=e.photo,n=e.title,s=e.description,r=e.grid,o=e.meta,l=e.isDefaultPhotoOwner,c=void 0!==l&&l,d=e.isCasper,u=void 0!==d&&d,g=unclean(n),h=Object(b.canChangeTitle)(t),v=Object(m.classNames)("ChatSettingsInfo",{"ChatSettingsInfo--editable":h}),O=Object(m.classNames)("ChatSettingsInfo__title",{"ChatSettingsInfo__title-service":64&this.props.flags});return i.createElement("div",{className:v},i.createElement("header",{className:"ChatSettingsInfo__header"},i.createElement("div",{className:"ChatSettingsInfo__photo"},i.createElement("div",{className:"ChatSettingsInfo__attach nim-peer nim-peer_larger","data-tip":f("mail_settings_photo"),onClick:this.onPhotoUpload},a?i.createElement("img",{src:a,width:"80",height:"80",alt:g,className:"ChatSettingsInfo__photoSelf"}):i.createElement("div",{className:"nim-peer--photo-w"},i.createElement("div",{className:"ChatSettingsInfo__photoGrid nim-peer--photo",dangerouslySetInnerHTML:{__html:r}}))),a&&h&&!c&&i.createElement(_.default,{text:f("mail_settings_remove_photo"),position:"t",align:"left"},i.createElement("button",{onClick:this.onPhotoRemove,className:"ChatSettingsInfo__photoRemove"}))),i.createElement("h3",{className:O},h?i.createElement(p.default,{value:this.state.title,changed:this.state.titleChanged,useEnter:!0,onSave:this.onSaveTitle,onChange:this.onChangeTitle,onCancel:this.onCancelTitle,validate:this.onValidateTitle}):g),i.createElement("div",{className:"ChatSettingsInfo__meta"},i.createElement("span",{className:"ChatSettingsInfo__metaItem"},o),u&&i.createElement("span",{className:"ChatSettingsInfo__metaItem"},this.getCasperInfo()))),s&&i.createElement("div",{className:"ChatSettingsInfo__description"},h?i.createElement(p.default,{value:s,onSave:this.onSaveDescription}):s))}}a("KKXr");var C=a("h7Kf"),y=a("zgoX"),j=a("n3cE"),E=a("ngxX"),S=c.default.getLang;class T extends i.Component{constructor(e){super(e),this.onCopy=()=>{this.input&&(elfocus(this.input,0,this.input.value.length),document.execCommand("copy"),this.setState({copied:!0}))},this.onBlinkTextHide=()=>{this.setState({copied:!1})},this.getInputRef=e=>{e&&e.element&&(this.input=e.element)},this.state={copied:!1}}componentDidMount(){this.input&&elfocus(this.input,0,this.input.value.length)}render(){var e=this.props,t=e.onReset,a=e.invitationLinks,n=e.store,s=S("mail_invite_link_reset_explainer").split("{reset_link}"),o=!Object(r.isFvkcomgroup)(n,n.get().peer),l=a.linkWithHistory,c=a.linkWithoutHistory,d=this.props.isInvitationLinkWithHistory?l:c;return i.createElement("div",{className:"ChatSettingsInvitationLink"},this.props.reseted&&i.createElement("div",{className:"ChatSettingsInvitationLink__reseted"},S("mail_invite_link_reseted_explainer")),i.createElement("p",null,S("mail_invite_link_explainer")),i.createElement("div",{className:"ChatSettingsInvitationLink__switch"},i.createElement(E.default,{children:S("mail_im_chat_add_members_show_history"),checked:this.props.isInvitationLinkWithHistory,onChange:this.props.onLinkHistoryOptionToggle})),i.createElement("div",{className:"ChatSettingsInvitationLink__main"},i.createElement(C.default,{ref:this.getInputRef,readOnly:"readonly",className:"ChatSettingsInvitationLink__input",value:d}),i.createElement(g.default,{onClick:this.onCopy},S("mail_get_invite_link_copy")),i.createElement(y.default,{className:"ChatSettingsInvitationLink__copied",shown:this.state.copied,callback:this.onBlinkTextHide},S("mail_invite_link_copied"))),o&&i.createElement("p",null,s[0],i.createElement(j.default,{className:"ChatSettingsInvitationLink__reset",onClick:t},S("mail_invite_reset_link")),s[1]))}}var w=a("WfnU"),I=a("0MTP"),A=c.default.getLang;class M extends i.Component{constructor(e){super(e),this.onConfirm=()=>{this.state.loading||(this.setState({loading:!0}),this.props.onConfirm().then(()=>{this.setState({loading:!1}),this.props.onCancel()}).catch(()=>this.setState({loading:!1})))},this.state={}}render(){return i.createElement("div",{className:"ChatSettingsResetInvitationLink"},i.createElement("div",{className:"ChatSettingsResetInvitationLink__text",dangerouslySetInnerHTML:{__html:A("mail_chat_reset_link_warning")}}),i.createElement(I.default,{alignment:"right"},i.createElement(g.default,{appearance:"tertiary",onClick:this.props.onCancel},A("global_cancel")),i.createElement(w.default,{onClick:this.onConfirm,loading:this.state.loading},A("mail_chat_reset_link_confirm"))))}}a("91GP");var k=a("p9ed"),L=a("5R8M"),P=a("Hri0"),N=a("hN/p"),D=a("+tmx"),x=a("/cSr"),B=a("rHUl"),R=c.default.getLang,F=()=>[{label:R("mail_settings_time_one_hour"),value:D.HOUR},{label:R("mail_settings_time_eight_hours"),value:8*D.HOUR},{label:R("mail_settings_time_day"),value:D.DAY},{label:R("mail_settings_time_week"),value:D.WEEK},{label:R("mail_settings_time_forever"),value:-1}];class H extends i.Component{constructor(e){super(e),this.onCopyInviteLink=e=>{this.input&&(this.input.focus(),this.input.select(),document.execCommand("copy"),this.setState({copied:!0})),e.preventDefault(),e.stopPropagation()},this.onBlinkTextHide=()=>{this.setState({copied:!1})},this.getHiddenInput=e=>{this.input=e},this.onDisabledSettingsChange=e=>{var t=e.selected.value,a=t>0?Math.floor((Date.now()+t)/1e3):t,n=0!==a;this.setState({push_disabled_until:a,push_disabled:n,disabledPlaceholder:this.getDisabledPlaceholder(a)},()=>{this.props.onUpdateNotificationSettings(n,Math.floor(t/1e3)).then(()=>{this.props.afterDisableUntilUpdated()})})},this.onMentionSettingsChange=e=>{var t=e.selected.value;this.setState({mentions_push_disabled:t},()=>{this.props.onUpdateMentionNotificationSettings(t).then(()=>{this.props.afterNotificationSettingsUpdated()})})},this.onShowInviteLink=()=>{Object(b.canChangeInviteLink)(this.props.store)&&this.props.showInvitationLink()};var t=this.getPushSettingsFromProps(e),a=t.push_disabled_until,n=a>0?+new Date(a):a;this.state=Object.assign({pushDisabled:a,disabledPlaceholder:this.getDisabledPlaceholder(n),copied:!1},t)}getPushSettingsFromProps(e){var t=e.store.get();return t.tabs[t.peer].notifications}getPushDisabledFromProps(e){var t=e.store.get();return t.tabs[t.peer].notifications.push_disabled}getDisabledPlaceholder(e){if(!e||0===e)return R("mail_settings_configure");if(-1===e)return R("mail_settings_time_forever");var t=getShortDateWithTime(e,0,!1);return`${R("mail_settings_until")} ${t}`}getDisabledOptions(){return this.state.push_disabled_until?[].concat(F(),[{label:R("mail_settings_time_cancel"),value:0}]):F()}render(){var e=this.props,t=e.store,a=e.flagsUpdated,n=e.notificationSettingsUpdated,s=e.disableUntilUpdated,o=e.onHideStatus,l=e.invitationLinks,c=e.isInvitationLinkWithHistory,d=t.get(),u=d.tabs[d.peer],g=Object(r.isFvkcomgroup)(d,d.peer),_=Object(B.isCommunityChat)(d,d.peer),p=u.inviteLinks&&Object(b.canSeeInviteLink)(t)||Object(b.canChangeInviteLink)(t),h=l||u.inviteLinks,v=h&&(c?h.linkWithHistory:h.linkWithoutHistory),f=Object(b.canSeeSettingsItem)(t,d.peer,d.id),O=Object(m.classNames)("ChatSettingsMenu",{"ChatSettingsMenu--copied":this.state.copied}),C=d.isMassMentionsMessageAllowed,E=R(c?"mail_get_invite_link_copy_with_history":"mail_get_invite_link_copy_without_history");return i.createElement("div",{className:"ChatSettings__pane"},_&&i.createElement(k.default,{className:O},i.createElement(L.default,{onClick:e=>nav.go(u.owner.link,e),chevron:!0,className:"ChatSettingsMenu__owner"},i.createElement(P.default,{size:"28",title:u.owner.title,photo:u.owner.photo,href:u.owner.link,description:u.owner.description}))),i.createElement(k.default,{className:O},i.createElement(L.default,{onClick:this.props.showAttachments,chevron:!0},i.createElement(x.default,{type:"attach",backgroundColor:"blue"}),R("mail_im_show_media_history"))),i.createElement(k.default,{className:O},C&&i.createElement(i.Fragment,null,i.createElement(L.default,{selectable:!1,chevron:!1,aside:i.createElement(i.Fragment,null,i.createElement(y.default,{shown:n,callback:o},R("global_changes_saved_short")),i.createElement(N.default,{className:"ChatSettingsMenu__select",onChange:this.onMentionSettingsChange,options:[{label:R("mail_settings_mentions_all"),value:0},{label:R("mail_settings_mentions_except"),value:1},{label:R("mail_settings_mentions_disable"),value:2}],value:this.state.mentions_push_disabled}))},i.createElement(x.default,{type:"mention",backgroundColor:"blue"}),R("mail_settings_mentions")),i.createElement(L.default,{selectable:!1,aside:i.createElement(i.Fragment,null,i.createElement(y.default,{shown:s,callback:o},R("global_changes_saved_short")),i.createElement(N.default,{className:"ChatSettingsMenu__select",onChange:this.onDisabledSettingsChange,options:this.getDisabledOptions(),placeholder:this.state.disabledPlaceholder}))},i.createElement(x.default,{type:"notice",backgroundColor:"red"}),R("mail_settings_notices"))),(p||f)&&i.createElement(i.Fragment,null,p&&i.createElement(L.default,{onClick:this.onShowInviteLink,chevron:Object(b.canChangeInviteLink)(t)},i.createElement(x.default,{type:"link",backgroundColor:"green"}),R(g?"mail_vkcomgroup_invite_link":"mail_chat_invite_link"),v&&i.createElement("span",{className:"ChatSettingsMenu__invite"},i.createElement("span",{className:"ChatSettingsMenu__hidden"},i.createElement("input",{type:"text",readOnly:!0,value:v,ref:this.getHiddenInput})),i.createElement(y.default,{className:"ChatSettingsMenu__copied",shown:this.state.copied,callback:this.onBlinkTextHide},R("mail_invite_link_copied")),i.createElement(j.default,{className:"ChatSettingsMenu__copy",onClick:this.onCopyInviteLink},E))),f&&i.createElement(L.default,{onClick:this.props.showSettings,chevron:!0,aside:i.createElement(y.default,{shown:a,callback:o},R("global_changes_saved"))},i.createElement(x.default,{type:"gear",backgroundColor:"gray"}),R("mail_settings_options")))))}}a("OG14"),a("Vd3H");var U=a("rudk"),G=a("RlRI"),q=a("yuXj"),W=a("zjLC"),K=a("kxld");var V=c.default.getLang;class Y extends i.Component{constructor(){super(...arguments),this.toggleAdmin=()=>{var e=this.props,t=e.store,a=e.mid,n=e.adminMap,i=t.get().peer,s=!n[a];t.set(o.toggleAdminOptimisticly.bind(null,i,a,s)),t.set(o.toggleAdmin.bind(null,i,a,s))},this.kick=()=>{var e=this.props.store,t=e.get().peer,a=this.props.mid;e.set(e=>function(e,t,a){var n=Object(K.getTab)(e,t);return!n||Object(U.isChatPeer)(t)?Promise.reject("No chat info"):(n.memberIds=n.memberIds.filter((function(e){return e!==a})),n.adminIds=n.adminIds.filter((function(e){return e!==a})),n.membersCount=n.memberIds.length,Promise.resolve(e))}(e,t,a)),e.set(e=>Object(W.kickUserAction)(e,t,a)).catch(e=>{Object(v.imWeirdCatch)("ChatSettingsMemberEdit.kick",e)})},this.cancelMessageRequest=()=>{var e=this.props.store,t=e.get().peer,a=this.props.mid;e.set(e=>Object(W.cancelMessageRequestAction)(e,t,a)).catch(e=>{Object(v.imWeirdCatch)("ChatSettingsMemberEdit.cancel",e)})},this.changeAccess=e=>{var t=this.props.store,a=t.get().peer,n=this.props.mid;t.set(o.changeCommunityAccess.bind(null,a,n,!e)).catch(e=>{Object(v.imWeirdCatch)("ChatSettingsMemberEdit.changeAccess",e)})}}getMemberRole(e,t){var a=this.props.storeData,n=a.peer;return t===a.tabs[n].ownerId?V("mail_settings_owner"):e[t]?V("mail_settings_admin"):null}getActions(e){var t=this.props,a=t.store,n=t.mid,i=Object(d.unpackStore)(a),s=i.id,r=i.peer,o=s===n,l=[],c=Object(B.isCommunityChat)(a,r);if(o)return c&&Object(B.isCommunityInterface)(a)?[]:[{text:V("mail_leave_chat"),onClick:this.props.onLeave}];if(Object(b.canAddAdmin)(a,n)&&l.push({text:e[n]?V("mail_chat_remove_admin"):V("mail_settings_appoint_admin"),onClick:this.toggleAdmin}),Object(b.canKickUser)(a,n)&&l.push({text:V("mail_settings_kick"),onClick:this.kick}),Object(B.isCommunityPeer)(n)&&!e[n]){var u=Object(b.canSeeAllMessages)(a,a.get().peer,n),g=u?"mail_settings_community_mentions_only":"mail_settings_community_full_access";l.push({text:V(g),onClick:this.changeAccess.bind(this,u)})}return l}render(){var e=this.props,t=e.adminMap,a=e.storeData,n=e.mid,s=e.isMR,r=a.id,o=!!t[r],l=this.getMemberRole(t,n),c=r===n,d=o&&this.getActions(t);return s?i.createElement(_.default,{text:V("mail_cancel_invitation"),position:"t",align:"right"},i.createElement("span",{onClick:this.cancelMessageRequest,className:"ChatSettingsMembersEdit__kick"})):i.createElement(i.Fragment,null,l&&i.createElement("span",{className:"ChatSettingsMembersEdit__role"},l),d&&d.length>0&&i.createElement(q.default,{position:"b",align:"right",trigger:"hover",marginTop:-8,marginLeft:1,data:this.getActions(t)},i.createElement("span",{className:"ChatSettingsMembersEdit__actions"})),!o&&!c&&Object(b.canKickUser)(a,n)&&i.createElement(_.default,{text:V("mail_settings_kick"),position:"t",align:"right"},i.createElement("span",{onClick:this.kick,className:"ChatSettingsMembersEdit__kick"})),!o&&c&&i.createElement(_.default,{text:V("mail_leave_chat"),position:"t",align:"right"},i.createElement("span",{onClick:this.props.onLeave,className:"ChatSettingsMembersEdit__kick"})))}}var z=a("Aegd"),Q={appendParentCls:"ChatSettingsWrapper"},X=c.default.getLang,$={all:"allShowMore",admins:"adminsShowMore",invitedByMRShowMore:"invitedByMRShowMore"};class J extends i.Component{constructor(e){super(e),this.onToggleSearch=()=>{this.state.showSearch?this.setState({showSearch:!1,searchQuery:""}):(this.setState({showSearch:!0}),requestAnimationFrame(()=>{this.searchInput.focus()}))},this.onSearchChange=e=>{e.target.value!==this.state.searchQuery&&this.setState({searchQuery:e.target.value})},this.onShowMore=()=>{var e=$[this.state.current];this.state[e]&&this.setState({[e]:!1})},this.onTabClick=(e,t)=>{e.preventDefault(),this.state.current!==t&&this.setState({current:t})},this.handleDocumentClick=e=>{!this.state.showSearch||this.state.searchQuery||e.target.closest(".ChatSettingsMembersWidget__search")||e.target.closest(".ChatSettingsMembersWidget__searchIcon")||this.setState({showSearch:!1})},this.onKeydown=e=>{this.state.showSearch&&27===e.keyCode&&(this.searchInput.blur(),this.setState({showSearch:!1,searchQuery:""}),e.preventDefault(),e.stopPropagation())},this.getInviter=e=>{if(this.invitersCache[e])return this.invitersCache[e];var t=this.props.store.get(),a=t.peer,n=t.tabs[a],i=n.inviters;if(!i[e])return"";var s=Object(r.getChatMembersByIds)(t,[i[e][0]])[0],o=getSmDate(i[e][2],t.timeshift,!0);if(Object(b.isUserOwnerInChat)(n,e))return this.invitersCache[e]=X("mail_settings_owner"),X("mail_settings_owner");if(!s)return this.invitersCache[e]=o,o;var l=langSex(i[e][1],X("mail_chat_member_invited_by_X","raw")).replace(/{inviter}/,replaceEntities(s.name))+" "+o;return this.invitersCache[e]=l,l},this.isAddMemberWidgetShown=()=>{var e=this.props.store,t=Object(d.unpackStore)(e),a=t.id,n=t.peer,i=this.state,s=i.current,r=i.showSearch,o=i.searchQuery;return"all"===s&&!(r&&""!==o)&&Object(b.canInviteUser)(e,n,a)},this.getCommunityDescriptionText=e=>X(e?"mail_settings_community":"mail_settings_bot"),this.getMemberDescriptionText=(e,t,a)=>{var n=t.tabs[t.peer];if(Object(r.isCommunityPeer)(e.id))return this.getCommunityDescriptionText(e.id===n.ownerId);if(a)return Object(r.getMessageRequestDateText)(e.date,t.timeshift);var i=n.membersLastSeen;return i&&i[e.id]?Object(r.getLastSeenText)(t,e.id,i[e.id],Q):void 0},this.searchInputRef=e=>{this.searchInput=e};var t=e.store.get(),a=this.getMembers(t),n=this.getAdmins(t),i=this.getInvitedByMessageRequests(t);this.state={showSearch:!1,searchQuery:"",current:"all",all:a,allShowMore:a.length>50,admins:n,adminsShowMore:n.length>50,invitedByMR:i,invitedByMRShowMore:i.length>50},this.membersMap=a.reduce((e,t)=>(e[t]=!0,e),{}),this.searchIndexPromise=this.getSearchIndex(a).then(e=>{this.searchIndex=e}),this.invitersCache={}}componentWillReceiveProps(e){var t=e.store.get(),a=this.getMembers(t),n=this.getAdmins(t),i=this.getInvitedByMessageRequests(t),s={removes:[],additions:[]},r=a.reduce((e,t)=>(e[t]=!0,e),{});a.forEach(e=>{this.membersMap[e]||s.additions.push(e)}),Object.keys(this.membersMap).forEach(e=>{r[e]||s.removes.push(e)}),(s.removes.length||s.additions.length)&&(this.updateSearchIndex(t,s),this.membersMap=r);var o={all:a,allShowMore:this.state.allShowMore&&a.length>50,admins:n,adminsShowMore:this.state.adminsShowMore&&n.length>50,invitedByMR:i,invitedByMRShowMore:this.state.invitedByMRShowMore&&i.length>50};o.current=o[this.state.current].length>0?this.state.current:"all",this.setState(o)}getMembers(e){var t=e.peer,a=e.tabs[t],n=-1!==(a.memberIds||[]).indexOf(a.ownerId),i=(a.adminIds||[]).reduce((e,t)=>(e[t]=!0,e),{});return(n?[a.ownerId]:[]).concat((a.adminIds||[]).filter(e=>e!==a.ownerId),(a.memberIds||[]).filter(e=>e!==a.ownerId&&!i[e]))}getAdmins(e){var t=e.peer,a=e.tabs[t];return(-1!==(a.memberIds||[]).indexOf(a.ownerId)?[a.ownerId]:[]).concat((a.adminIds||[]).filter(e=>e!==a.ownerId))}getInvitedByMessageRequests(e){var t=e.peer;return e.tabs[t].invitedByMessageRequest.sort((function(e,t){return e.date-t.date}))}getCurrentList(){var e=this.props.store,t=this.state,a=t.current,n=t.showSearch,i=t.searchQuery,s=t.invitedByMR;if(n&&i&&this.searchIndex){var o=s.filter(e=>!!e.name.toLowerCase().trim().split(/\s+/).find(e=>0===e.indexOf(i.toLowerCase())));return this.searchIndex.search(i).concat(o)}var l=this.state[a],c="invitedByMR"===a?l:Object(r.getChatMembersByIds)(e.get(),l);return this.state[a+"ShowMore"]?c.slice(0,50):c}getSearchIndex(e){var t=window.vkIndexer,a=Object(r.getChatMembersByIds)(this.props.store.get(),e);return this.membersMap=a.reduce((e,t)=>(e[t.id]=!0,e),{}),new Promise((e,n)=>{var i=new t(a,e=>e.name,()=>{e(i)})})}updateSearchIndex(e,t){var a=Object(r.getChatMembersByIds)(e,t.removes),n=Object(r.getChatMembersByIds)(e,t.additions);(this.searchIndex?Promise.resolve(this.searchIndex):this.searchIndexPromise).then(e=>{a.forEach(t=>{e.remove(t)}),n.forEach(t=>{e.add(t)})})}componentDidMount(){this.searchInput.addEventListener("keydown",this.onKeydown)}componentWillUnmount(){this.searchInput.removeEventListener("keydown",this.onKeydown)}render(){var e=this.props,t=e.store,a=e.membersCount,n=e.membersAdded,s=e.onHideStatus,o=this.state,l=o.current,c=o.showSearch,d=o.searchQuery,u=o.admins,g=o.invitedByMR,_=t.get(),p=_.peer,h=_.tabs[p],b=this.getCurrentList(),v=this.isAddMemberWidgetShown()?["add"].concat(b):b,f=this.state[$[l]],O={"ChatSettingsMembersWidget--search":!!c},C=h.adminIds.reduce((e,t)=>(e[t]=!0,e),{});return i.createElement("div",{className:Object(m.classNames)("ChatSettingsMembersWidget",O)},i.createElement("header",{className:"ChatSettingsMembersWidget__header"},i.createElement("input",{placeholder:X("mail_members_search"),className:"ChatSettingsMembersWidget__search",onChange:this.onSearchChange,onInput:this.onSearchChange,onPaste:this.onSearchChange,value:this.state.searchQuery,ref:this.searchInputRef}),i.createElement("button",{className:"ChatSettingsMembersWidget__searchIcon",onClick:this.onToggleSearch}),i.createElement(G.default,{className:"ChatSettingsMembersWidget__tabs",onTabClick:this.onTabClick},i.createElement("span",{key:"all"},X("mail_settings_everyone")+" ",i.createElement("span",{className:"Tabs__desc"},Object(r.getAliveMembersCount)(h))),u.length>0&&i.createElement("span",{key:"admins"},X("mail_settings_admins")+" ",i.createElement("span",{className:"Tabs__desc"},u.length)),g.length>0&&i.createElement("span",{key:"invitedByMR"},X("mail_invited_members")+" ",i.createElement("span",{className:"Tabs__desc"},g.length)))),i.createElement("div",{className:"ChatSettingsMembersWidget__list"},i.createElement(k.default,{border:!1},v.length>0&&v.map(e=>{if("add"===e)return i.createElement(L.default,{selectable:!1,border:!1,key:"add",onClick:this.props.showMembersSettings,aside:i.createElement(y.default,{className:"ChatSettingsMembersWidget__blink",shown:n,callback:s},langNumeric(a||0,X("mail_settings_members_added","raw")))},i.createElement("span",{className:"ChatSettingsMembersWidget__add"},i.createElement("span",null,X("mail_settings_add_members"))));var o=this.getInviter(e.id),c="invitedByMR"===l,d=e.covid_status?e.name+`<span class="ChatSettingsMembersWidget__covidStatus">${e.covid_status}</span>`:e.name,u=this.getMemberDescriptionText(e,_,c);return i.createElement(L.default,{selectable:!1,border:!1,aside:i.createElement(Y,{adminMap:C,store:t,storeData:_,mid:e.id,onLeave:this.props.onLeave,isMR:c}),key:e.id},i.createElement(P.default,{photo:Object(U.isContactPeer)(e.id)?i.createElement(z.ConversationNoPhoto,{id:p,text:Object(r.getUserInitials)(e.name),size:"xxxs",specificType:7}):e.photo,title:d,description:i.createElement("span",{title:o,dangerouslySetInnerHTML:{__html:u}}),href:e.link}))}),!v.length&&c&&d&&i.createElement("div",{className:"ChatSettingsMembersWidget__empty"},X("mail_settings_not_found")),!(c&&d)&&f&&i.createElement("div",{className:"ChatSettingsMembersWidget__more",onClick:this.onShowMore},X("mail_settings_show_all_members")))))}}var Z=a("F0+T"),ee=a("wQFj"),te=a("EasH"),ae=a("DM26"),ne=c.default.getLang,ie=()=>{};class se extends i.Component{constructor(e){super(e),this.onChange=e=>{var t=this.props.store.get(),a=e.target.value;Object(o.searchLocalHints)(a,t).then(e=>(this.setSearchResults({},!1,a,e),a?(this.isSearching=!0,this.serverSearch(a,e.map(e=>e.peerId))):Promise.resolve([]))).then(this.appendSearchResults).catch(()=>{})},this.serverSearch=Object(ae.debouncedPromise)((e,t)=>{var a=this.props.store;return Object(o.searchHints)(e,t,"friends",a.get())},300),this.onRemoveToken=e=>new Promise(t=>{var a=this.state.selected.filter(t=>t!==e);this.selected=a.reduce((e,t)=>(e[t]=!0,e),{}),this.setState({selected:a},t)}),this.onSelect=e=>new Promise(t=>{var a=this.selected[e]?this.state.selected.filter(t=>t!==e):[].concat(this.state.selected,e).filter((e,t,a)=>a.indexOf(e)===t);this.selected=a.reduce((e,t)=>(e[t]=!0,e),{}),this.resetSearch({selected:a,value:""},t)}),this.onShowHistoryToggle=()=>{this.setState({isShowHistoryChecked:!this.state.isShowHistoryChecked})},this.onAddPeople=()=>{var e=this.props.store,t=e.get().peer,a=this.state.selected.map(e=>parseInt(e)),n=this.state.isShowHistoryChecked;this.setState({loading:!0}),e.set(o.addNewMember.bind(null,t,a,n)).then(()=>e.set(o.getChatDetails.bind(null,t)).then(()=>{this.selected={},this.resetSearch({selected:[],loading:!1},()=>{this.props.afterSave(a.length)})})).catch(e=>{this.selected={},this.resetSearch({selected:[],loading:!1}),Object(te.showFastBox)(ne("global_error"),e)})},this.setSearchResults=(e,t,a,n)=>{var i=this.props.store.get(),s=Object(B.getTab)(i,i.peer),r=[];n.forEach(e=>{this.data[e.peerId]||(this.data[e.peerId]=e),-1===s.memberIds.indexOf(e.peerId)&&r.push(e.peerId)}),this.setState(Object.assign({},e,{found:r,value:a}),t||ie)},this.appendSearchResults=e=>{var t=this.props.store.get(),a=Object(B.getTab)(t,t.peer),n=this.state.found;e.forEach(e=>{this.data[e.peerId]||(this.data[e.peerId]=e),-1===a.memberIds.indexOf(e.peerId)&&-1===n.indexOf(e.peerId)&&n.push(e.peerId)}),this.isSearching=!1,this.setState({found:n})},this.state={selected:[],value:"",loading:!1,found:[],isShowHistoryChecked:!0},this.data={},this.selected={}}resetSearch(e,t){return Object(o.searchLocalHints)("",this.props.store.get()).then(this.setSearchResults.bind(this,e,t,""))}componentDidMount(){this.resetSearch()}render(){var e=Object.keys(this.state.selected).length;return i.createElement("div",{className:"ChatSettingsMembers"},i.createElement(Z.default,{className:"ChatSettingsMembers__multiSelect",tokens:this.state.selected.map(e=>({text:unclean(this.data[e].name),id:e})),removeTokenPlaceholder:ne("mail_create_chat_remove_user"),onRemoveToken:this.onRemoveToken,placeholder:ne("mail_search_creation"),value:this.state.value,onChange:this.onChange,onSelect:this.onSelect,useInfiniteScroll:!1,hasMore:!1,virtualized:!1,loadMore:()=>{},notFoundText:ne("mail_not_found"),autoFocus:!0,isSearching:this.isSearching},this.state.found.map(e=>i.createElement("div",{className:Object(m.classNames)("ChatSettingsMembers__entity",{"ChatSettingsMembers__entity--selected":this.selected[e]}),key:e,"data-id":e},i.createElement(P.default,{size:"34",title:this.data[e].name,photo:this.data[e].photo})))),i.createElement(I.default,{alignment:"right",className:"ChatSettingsMembers__submitArea"},i.createElement(ee.default,{checked:this.state.isShowHistoryChecked,onChange:this.onShowHistoryToggle,className:"ChatSettingsMembers__showHistory"},ne("mail_im_chat_add_members_show_history")),i.createElement(w.default,{disabled:0===e,onClick:this.onAddPeople,loading:this.state.loading,className:"ChatSettingsMembers__confirm"},ne(e<2?"mail_append_chat":"mail_im_create_chat_with"))))}}var re=a("iukX");function oe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return le(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return le(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function le(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var ce,de=c.default.getLang;class ue extends i.Component{constructor(e){super(e),this.showInvitationLink=()=>{var e=this.props.store,t=Object(d.unpackStore)(e),a=t.peer;return this.setState({invitationLoading:!0}),Object(o.getInviteLink)(a-2e9,t).then(e=>{var t=oe(e,1)[0];this.setState({section:2,invitationLoading:!1,invitationLinks:t})})},this.onUpdateNotificationSettings=(e,t)=>{var a=this.props,n=a.store,i=a.parentMutations,s=n.get().peer;return n.set(o.toggleMutePeer.bind(null,s,e,t)).then(i().updateState.bind(null,s))},this.onUpdateMentionNotificationSettings=e=>{var t=this.props,a=t.store,n=t.parentMutations,i=a.get().peer;return a.set(o.toggleMuteMentionsPeer.bind(null,i,e)).then(n().updateState.bind(null,i))},this.onUpdateFlags=e=>{var t=this.props.store.get(),a=t.peer,n=t.hasOwnProperty("onUpdateFlags")?t.onUpdateFlags.bind(null,a,e):e=>Promise.resolve(e);return Object(o.updateFlags)(a,e,t).then(n)},this.afterFlagsUpdated=()=>{this.go(0,()=>this.setBlinkStatus({flagsUpdated:!0}))},this.afterMembersAdded=e=>{this.go(0,()=>this.setBlinkStatus({membersAdded:!0,membersCount:e}))},this.afterNotificationSettingsUpdated=()=>{this.setBlinkStatus({notificationSettingsUpdated:!0})},this.afterDisableUntilUpdated=()=>{this.setBlinkStatus({disableUntilUpdated:!0})},this.setBlinkStatus=e=>{this.timers.push(setTimeout(()=>this.setState(e),300))},this.onHideStatus=()=>{this.setState({membersAdded:!1,flagsUpdated:!1,notificationSettingsUpdated:!1,disableUntilUpdated:!1})},this.onLeave=()=>{var e=this.props,t=e.store,a=e.closePopup,n=t.get().peer,i=Object(r.isFvkcomgroup)(t,n),s=Object(te.showFastBox)({title:de(i?"mail_leave_channel":"mail_chat_leave_title"),dark:1},de(i?"mail_vkcomgroup_leave_confirm":"mail_chat_leave_confirm"),de(i?"mail_leave_channel":"mail_leave_chat"),(function(){t.set(o.unpinMessageOptimistic.bind(null,n)),t.set(o.leaveChat.bind(null,n)),s.hide(),a(),t.get().longpoll.push([Object(l.resetPeer)()])}),de("global_cancel"),(function(){s.hide()}))},this.onChatClose=()=>{var e=this.props,t=e.store,a=e.closePopup,n=t.get().peer,i=Object(B.getTab)(t,n).data.flags,s=i&b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE?i&~b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE:i|b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE,o=Object(te.showFastBox)({title:de("global_warning"),dark:1},de("mail_chat_close_confirm"),de("mail_close_chat"),()=>{this.onUpdateFlags(s).then(()=>{o.hide(),a(),Object(r.isCommunityInterface)(t)||t.get().longpoll.push([Object(l.resetPeer)()])})},de("global_cancel"),(function(){o.hide()}))},this.onChatRestore=()=>{var e=this.props,t=e.store,a=e.closePopup,n=t.get().peer,i=Object(B.getTab)(t,n).data.flags,s=i&b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE?i&~b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE:i|b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE;this.onUpdateFlags(s).then(a)},this.onResetLink=()=>{var e=this.props.store,t=Object(d.unpackStore)(e),a=t.peer;return Object(o.resetInviteLink)(a,t).then(e=>{var t=oe(e,1)[0];this.setState({invitationLinksReseted:!0,invitationLinks:t})})},this.onShowAttachments=()=>{var e=Object(B.getPeer)(this.props.store);this.props.closePopup(),window.showWiki({w:"history"+Object(r.convertPeerToUrl)(e)+"_photo"},null,{})},this.onLinkHistoryOptionToggle=()=>{var e=Object(B.getPeer)(this.props.store);this.setState(e=>({isInvitationLinkWithHistory:!e.isInvitationLinkWithHistory}),()=>{this.props.updateHistoryLinkState(e,this.state.isInvitationLinkWithHistory)})},this.state={section:0,invitationLinks:null,invitationLinksReseted:!1,isInvitationLinkWithHistory:this.props.isLinkWithHistorySelected,membersAdded:!1,flagsUpdated:!1,notificationSettingsUpdated:!1,disableUntilUpdated:!1},this.timers=[]}go(e,t){this.setState({section:e},()=>{this.props.updatePopup(),t&&t()})}getPopupTitle(){switch(this.state.section){case 1:return de("mail_settings_add_members");case 2:case 3:return de("mail_chat_invite_link");case 6:return de("mail_settings_options");default:return de("mail_settings_title")}}componentWillReceiveProps(e){var t=e.store.get(),a=t.peer,n=t.tabs[a];n.photoLarge||n.photoGrid||this.resync||(this.resync=!0,e.store.set(o.getChatDetails.bind(null,a)).then(()=>{this.resync=!0}))}componentDidMount(){this.props.updatePopup()}componentWillUnmount(){this.timers.forEach(clearTimeout)}render(){var e=this.props,t=e.store,a=e.closePopup,n=t.get(),s=n.peer,o=n.tabs[s],l=Object(r.isFvkcomgroup)(t,s),c=Object(B.isCasperChat)(t,s),d=Object(B.isCommunityChat)(t,s),m=!l&&!d||!t.get().gid,_=Object(b.canCloseChat)(t,s,n.id),p=Object(B.isClosedChat)(t,s),h=n.isChatTypeEditAllowed,v=de(l?"mail_im_n_vkcomgroup_members":"mail_im_n_chat_members",Object(r.getAliveMembersCount)(o));return i.createElement("section",{className:"ChatSettings"},i.createElement(u.default,{title:this.getPopupTitle(),back:0!==this.state.section?de("global_back"):void 0,onCloseClick:a,onBackClick:()=>this.go(0)}),0===this.state.section&&i.createElement("div",{className:"ChatSettings__content"},i.createElement(O,{store:t,photo:o.photoLarge,grid:o.photoGrid,title:o.name,flags:o.data.flags,isDefaultPhotoOwner:o.isDefaultPhotoOwner,isCasper:c,meta:v,description:""}),i.createElement(H,{store:t,showMembersSettings:()=>this.go(1),showAttachments:this.onShowAttachments,showInvitationLink:this.showInvitationLink,isInvitationLinkWithHistory:this.state.isInvitationLinkWithHistory,invitationLinks:this.state.invitationLinks,showSettings:()=>this.go(6),notificationSettingsUpdated:this.state.notificationSettingsUpdated,disableUntilUpdated:this.state.disableUntilUpdated,flagsUpdated:this.state.flagsUpdated,onHideStatus:this.onHideStatus,onUpdateNotificationSettings:this.onUpdateNotificationSettings,onUpdateMentionNotificationSettings:this.onUpdateMentionNotificationSettings,afterNotificationSettingsUpdated:this.afterNotificationSettingsUpdated,afterDisableUntilUpdated:this.afterDisableUntilUpdated}),l?null:i.createElement("div",{className:"ChatSettings__pane"},i.createElement(J,{store:t,onLeave:this.onLeave,showMembersSettings:()=>this.go(1),membersAdded:this.state.membersAdded,onHideStatus:this.onHideStatus,membersCount:this.state.membersCount})),m&&i.createElement("div",{className:"ChatSettings__pane"},i.createElement(g.default,{appearance:["link","mobile"],className:"ChatSettings__criticalAction ChatSettings__leave",onClick:this.onLeave},de(l?"mail_leave_channel":"mail_settings_leave"))),_&&!p&&i.createElement("div",{className:"ChatSettings__pane"},i.createElement(g.default,{appearance:["link","mobile"],className:"ChatSettings__criticalAction ChatSettings__close",onClick:this.onChatClose},de("mail_settings_close"))),_&&p&&i.createElement("div",{className:"ChatSettings__pane"},i.createElement(g.default,{appearance:["link","mobile"],className:"ChatSettings__criticalAction ChatSettings__restore",onClick:this.onChatRestore},de("mail_settings_restore")))),1===this.state.section&&i.createElement(se,{store:t,afterSave:this.afterMembersAdded}),6===this.state.section&&i.createElement(re.ChatSettingsOptions,{isChatTypeEditAllowed:h,flags:o.data.flags,isCasperChatTab:c,isCommunityChat:d,allowedUpdateFlags:o.allowedUpdateFlags,back:()=>this.go(0),onSave:this.onUpdateFlags,afterSave:this.afterFlagsUpdated}),2===this.state.section&&i.createElement(T,{store:t,onReset:()=>this.go(3),onLinkHistoryOptionToggle:this.onLinkHistoryOptionToggle,reseted:this.state.invitationLinksReseted,isInvitationLinkWithHistory:this.state.isInvitationLinkWithHistory,invitationLinks:this.state.invitationLinks}),3===this.state.section&&i.createElement(M,{onConfirm:this.onResetLink,onCancel:()=>this.go(2)}))}}function ge(e,t){var a=ls.get("im_chats_no_invite_link_history")||[],n=e-2e9,i=t?a.filter(e=>e!==n):a.concat(n);ls.set("im_chats_no_invite_link_history",i)}function me(e,t){var a=he(),n=function(e){var t=Object(B.getPeer)(e)-2e9;return!(ls.get("im_chats_no_invite_link_history")||[]).includes(t)}(e);a&&s.render(i.createElement(ue,{store:e,closePopup:_e.bind(null,e),updatePopup:pe,isLinkWithHistorySelected:n,updateHistoryLinkState:ge,parentMutations:t}),a)}function _e(e){ce&&ce.hide();var t=e.get();t.hasOwnProperty("onClose")&&t.onClose()}function pe(){ce&&ce.updateBoxCoords()}function he(){return document.querySelector("#ChatSettings")}function be(e){var t=document.querySelector("#box_layer_wrap"),a=document.querySelector("#box_loader"),i=isVisible(t);return{unmount(){var t=he();t&&s.unmountComponentAtNode(t),Object(n.destroyModule)(e)},showLoader(){boxRefreshCoords(a),show(a),i||show(t)},hideLoader(){hide(a),i||hide(t)}}}function ve(e,t,a){var i=Object(n.createMutations)(be).bindMutations,s=t.get(),r=Object(n.createModule)({handlers:(e,t)=>{}}),l=s.peer,c=i(r);var u=function(e,t){t.get().peer===l?function(e,t){var a=Object(B.getTab)(e,e.get().peer);a&&a.data&&Object(B.isChatActive)(a)?me(e,t):_e(e)}(t,a):e.unmount()}.bind(null,c),g={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:560,onShow(){me(t,a),t.subscribe(u),requestAnimationFrame(()=>ce.updateBoxCoords())},onHideAttempt:()=>(t.unsubscribe(u),c.unmount(),!0)};return c.showLoader(),t.set(o.getChatDetails.bind(null,l)).then(e=>{c.hideLoader();var t=Object(d.unpackStore)(e).peer;t&&t===l?ce=new MessageBox(g).content('<div id="ChatSettings" class="ChatSettingsWrapper"></div>').show():c.unmount()}),c}},bP5l:function(e,t,a){"use strict";a.r(t),a.d(t,"lpLogFc",(function(){return s})),a.d(t,"longpollTestingOnFcEvents",(function(){return g})),a.d(t,"longpollTestingOnImEvents",(function(){return m}));var n=a("ERyv"),i=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<a;t++)for(var s=arguments[t],r=0,o=s.length;r<o;r++,i++)n[i]=s[r];return n};function s(e,t){for(var a=[],n=2;n<arguments.length;n++)a[n-2]=arguments[n];if(window.vk.lpConfig.debug){var s="background: "+e+"; color: white",r=new Date,o=function(e){return e<10?"0"+e.toString():e.toString()};console.log.apply(console,i(["%c "+r.getHours()+":"+o(r.getMinutes())+":"+o(r.getSeconds())+":"+r.getMilliseconds()+" "+t+" ",s],a))}}function r(){return window.lpBufferFc||(window.lpBufferFc=[]),window.lpBufferFc}function o(){return window.lpBufferIm||(window.lpBufferIm=[]),window.lpBufferIm}function l(e,t){var a;window.lpWeird||(window.lpWeird=[]),window.lpWeird.push({msg:e,ev:t,is_master:!!(null===(a=window.curNotifier)||void 0===a?void 0:a.is_server)}),setTimeout(c,1e4)}function c(){window.lpWeird&&window.lpWeird.length&&(Object(n.imWeirdLog)("fc_im_differ",{diff:window.lpWeird},!1),window.lpWeird=[])}function d(){return"im"===window.cur.module&&window.store&&window.store.get().longpoll&&!window.store.get().stopped}function u(){var e;d()&&(o().forEach((function(e){!r().find((function(t){return e.ev===t.ev}))&&e.time<Date.now()-1e3&&!e.warned&&(e.warned=!0,s("red","im not fc",e.ev),Object(n.isWeirdLogging)()&&l("im not fc",e.ev))})),r().forEach((function(e){var t=o().find((function(t){return t.ev===e.ev}));t&&t.warned&&!e.warned&&(e.warned=!0,s("red","now fc like im",e.ev),Object(n.isWeirdLogging)()&&l("now fc like im",e.ev))}))),e=Date.now()-3e4,window.lpBufferFc=r().filter((function(t){return t.time>e})),window.lpBufferIm=o().filter((function(t){return t.time>e}))}function g(e){var t;d()&&((t=r()).push.apply(t,e.map((function(e){return{time:Date.now(),ev:JSON.stringify(e),warned:!1}}))),setTimeout(u,0)),s.apply(void 0,i(["green","fc"],e))}function m(e){var t;d()&&((t=o()).push.apply(t,e.map((function(e){return{time:Date.now(),ev:JSON.stringify(e),warned:!1}}))),setTimeout(u,1100)),s.apply(void 0,i(["blue","im"],e))}window.longpollTestingOnImEvents=m},f4YT:function(e,t){e.exports={im_img_prebody:'<div class="im-prebody"> <img alt="" src="%photo%" /> </div>',im_admin_link:' (<a href="%href%" class="_im_admin_name" target="_blank">%name%</a>)',im_right_menu_tpl:'<a id="ui_rmenu_peer_%peer%" href="%href%" class="_im_peer_tab ui_rmenu_item %cls%"%attrs%>\n  <span>%label%</span>\n</a>',im_right_menu_sep:'<div class="ui_rmenu_sep"></div>',im_right_menu_ct:'<span class="ui_rmenu_count im-right-menu--count _im_r_ct">%count%</span> <button type="button" class="im-right-menu--close _im_r_cl"></button><span class="im-right-menu--text _im_r_tx">%name%</span>',im_dialogs_link_img:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank"><div class="im_grid">%photo%</div></a>',im_dialogs_link:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank">%photo%</a>',im_peer_photo:'<div class="nim-peer %online_class% %modifier_class%"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> %owner_photo% </div> </div> </div>',im_contact_avatar:' <div class="nim-peer--contact-avatar nim-peer--contact-avatar_%size%">%name%</div>',im_owner_item:'<a href="%link%" class="olist_item_wrap%cls%" id="olist_item_wrap%owner_id%" >\n  <div class="olist_item clear_fix">\n    <div class="olist_item_photo_wrap %img_cls%">\n      <img class="olist_item_photo" src="%photo%"/>\n    </div>\n    <div class="olist_item_name">%name%</div>\n    <div class="olist_checkbox"></div>\n  </div>\n</a>',im_simple_name:function(){return'<div class="im-page--title %more_cls%"> <span class="im-page--title-main" title="%name_attr%" %ads_union%> <span class="im-page--title-main-in"> <a href="%href%" target="_blank" class="im-page--title-main-inner _im_page_peer_name">%name%</a> <span class="im-page--title-main-verified _im_chat_verified"></span> </span> </span> <span class="im-page--title-meta _im_page_peer_online">%online%</span> <span class="im-page--title-status _im_page_status"></span> <button class="im-page--title-reconnect _im_page_reconnect">'+getLang("mail_network_reconnect")+"</button> </div>"},im_simple_link:'<a href="%href%" class="_im_header_link" target="_blank">%content%</a>',im_selected_messages:'<span class="im-page--selected-messages-count">%label%</span> <button aria-label="%tip%" type="button" class="im-page--selected-messages-remove"></button>',im_topic:"<div class='im-topic %cls%'>%topic%</div>",im_stack_date:' <a href="%link%" class="_im_mess_link" >%date%</a>',im_dialogs_none:'<li data-list-id="002300" class="im-page--dialogs-empty"> %msg%</li>',im_dialogs_message_requests_button:'<li class="im-page--dialogs-message-requests-button _im_toggle_mr_tab" data-list-id="%list_id%"> %msg%</li>',im_dialogs_message_requests_notice:'<li class="im-page--dialogs-message-requests-notice-w" data-list-id="message_request_notice"> <div class="im-page--dialogs-message-requests-notice"> %msg% </div> </li>',im_filter:'<a class="im-page--dialogs-filter %cls%">%filter%</a>',im_drow_prebody:'<span class="nim-dialog--who">%prebody%</span> <span class="nim-dialog--inner-text">%body%</span>',im_attach_mess:' <div class="im-fwd %modifier%"> <span class="im-fwd--title"> <span class="im-fwd--title-name">%text%</span> <span class="im-fwd--date">%date%</span></span> <span class="im-fwd--close _im_fwd_close"></span> <div rel="button" tab-index="0" type="button" class="im-fwd--messages _im_will_fwd">%messages%</div> </div>',im_preloader:'<div class="im-preloader %cls%"> %preloader%</div>',im_service_row:'<ul class="ui_clean_list"> <li class="im-mess im-mess_srv _im_mess _im_mess_srv _im_mess_%message_id%" data-msgid="%message_id%" data-from="%from_id%" data-ts="%date%"> <div class="im-mess--text">%text%</div> </li> </ul>',im_chat_members:'<button type="button" class="_im_chat_members im-page--members">%name%</button>',im_vkcomgroup_members:'<span class="im-page--members im-page--members--nohover">%name%</span>',im_mess_stack:'<div class="im-mess-stack _im_mess_stack %cls%" data-peer="%peerId%" data-admin="%admin%"> <div class="im-mess-stack--photo"> <div class="nim-peer nim-peer_small fl_l"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> <a target="_blank" class="im_grid" href="%href%"><img alt="%name%" src="%photo%" /></a> </div> </div> </div> </div> <div class="im-mess-stack--content"> <div class="im-mess-stack--info"> <div class="im-mess-stack--pname"> %stack_name% <span class="im-mess-stack--tools">%messageMeta%</span> </div> </div> <ul class="ui_clean_list im-mess-stack--mess _im_stack_messages"> %messages% </ul> </div> </div>',im_mess_stack_name:'<a href="%link%" class="im-mess-stack--lnk%class%" title="" target="_blank">%name%</a>',im_message_media:'<div class="_im_msg_%type%%messageId%" class="wall_module">%attaches%</div>%text%',im_dialog_media:'<span class="nim-dialog--preview nim-dialog--preview-attach">%name%</span>',im_typing:'<div class="im-page--typing _im_typing"> <div class="im-activity %cls%"><div class="pr im-activity--icon"><div class="pr_bt"></div><div class="pr_bt"></div><div class="pr_bt"></div></div><span class="_im_typing_name">&nbsp;</span></div> </div>',ctrl_submit_hint:function(){return'<div class="reply_submit_hint_wrap" >\n  <div class="reply_submit_hint_title">'+getLang("wall_reply_submit_settings")+'</div>\n  <div class="reply_submit_hint_opts" id="">\n    <div class="radiobtn %enter_on% _im_submit_btn" data-val="0" onclick="radiobtn(this, 0, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_1")+'</div></div>\n    <div class="radiobtn %ctrl_on% _im_submit_btn" data-val="1" onclick="radiobtn(this, 1, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_2")+"</div></div>\n  </div>\n</div>"},im_day_bar:'<h5 class="im-page--history-new-bar im-page--history-new-bar_days _im_bar_date %day_class%" data-date="%date%"><span>%day%</span></h5>',im_mess_bar:function(){return'<h4 class="im-page--history-new-bar _im_unread_bar_row"><span>'+getLang("mail_new_unread_msgs")+"</span></h4>"},im_replied_message:'<div class="im-replied"> <div class="im-replied--photo-wrapper"></div> <div class="im-replied--content"> <div class="im-replied--author"> <span class="im-replied--author-link">%authorName%</span> </div> <div class="im-replied--text">%text%</div> </div> </div>',im_drow:function(){return'<li data-list-id="%peer%" class="nim-dialog _im_dialog _im_dialog_%peer% %is_unread% %is_unread_out% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <div class="nim-dialog--date _im_dialog_date">%date%</div> <button type="button" class="nim-dialog--close _im_dialog_close" data-peer="%peer%"></button> <button type="button" class="nim-dialog--markre _im_dialog_markre"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w _im_dialog_name_w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--verfifed _im_dialog_verified"></span> <span class="nim-dialog--casper _im_dialog_casper" aria-label="'+getLang("mail_casper_chat_label")+'" role="img" ></span> <span class="nim-dialog--mute"></span> <button type="button" class="nim-dialog--star _im_dialog_star"></button> <div class="nim-dialog--peer-tags _im_dialog_peer_tags PeerTags"></div> </div> <div class="nim-dialog--text-preview"> <span class="nim-dialog--preview _dialog_body" tabindex="0">%body%</span> <span class="nim-dialog--typing _im_dialog_typing"></span><span class="nim-dialog--typer-el"></span> </div> <div class="nim-dialog--pinned-conversation" role="img"></div> <div class="nim-dialog--unread_container"> <div class="nim-dialog--unread-badge_mention nim-dialog--unread-badge" aria-label="'+getLang("mail_mention_badge_label")+'" role="img"></div> <div class="nim-dialog--unread-badge_bomb nim-dialog--unread-badge" aria-label="'+getLang("mail_expiring_message_badge_label")+'" role="img"></div> <label class="blind_label _im_unread_blind_label">%unread_message_string%</label> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </div> </li>'},im_conversation_search_row:function(){return'<li data-list-id="%peer%" class="nim-dialog nim-conversation-search-row _im_dialog _im_dialog_%peer% %is_unread% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer nim-peer_search %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <button type="button" class="nim-dialog--close _im_dialog_close" data-peer="%peer%"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--casper _im_dialog_casper" aria-label="'+getLang("mail_casper_chat_label")+'"></span> </div> <div class="nim-dialog--unread_container"> <div class="nim-dialog--unread-badge_mention nim-dialog--unread-badge" aria-label="'+getLang("mail_mention_badge_label")+'" role="img"></div> <div class="nim-dialog--unread-badge_bomb nim-dialog--unread-badge" aria-label="'+getLang("mail_expiring_message_badge_label")+'" role="img"></div> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </div> </li>'},im_delete_actions:function(){return'<span class="nim-dialog--who">%text%</span> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="restore" type="button">'+getLang("mail_restore")+'</button> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="spam" type="button">'+getLang("mail_im_mark_spam")+'</button> <button class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="block" type="button">'+getLang("mail_user_black_list")+"</button>"},im_chat_change_topic:function(){return'<div class="im_change_topic_wrap clear_fix"> <div class="im_change_topic_label fl_l ta_r">'+getLang("mail_chat_topic_change_label")+'</div> <div class="im_change_topic_labeled fl_l"> <input class="text _im_chat_topic_change_input" value="%value%"/> </div> </div>'},im_msg_row:function(){return'<li class="im-mess %cls% _im_mess_noa _im_mess_%msg_id%" aria-hidden="%aria_hidden%" data-ts="%ts%" data-msgid="%msg_id%" data-peer="%from_id%"> <div class="im-mess--text wall_module _im_log_body">%text%</div> <span tabindex="0" role="link" aria-label="'+getLang("mail_select_message")+'" class="blind_label im-mess--blind-select _im_mess_blind_label_select"></span> <span class="blind_label im-mess--blind-read _im_mess_blind_unread_marker" %unread_params%></span> <span class="im-mess--marker _im_mess_marker" %marker_params%></span> </li>'},sImHistoryRowActions:function(){return'<div class="im-mess--actions"> <span role="link" aria-label="'+getLang("mail_im_mark_forward")+'" class="im-mess--forward _im_mess_forward"></span> <span role="link" aria-label="'+getLang("mail_im_reply")+'" class="im-mess--reply _im_mess_reply"></span> <span role="link" aria-label="'+getLang("mail_im_edit")+'" class="im-mess--edit _im_mess_edit"></span> <span role="link" aria-label="'+getLang("mail_important_message")+'" class="im-mess--fav _im_mess_fav"></span> </div> <div class="im-mess--check fl_l"></div>'},im_wrap_mobile:'<b class="mob_onl %class%" %attrs% onmouseover="mobileOnlineTip(this, {%params%})"></b>',im_pinned_message:'<div class="im-page-pinned _im_pinned_message"> <button class="im-page-pinned--hide _im_pin_hide"></button> <div class="im-page-pinned--meta"> <a href="%link%" target="_blank" class="im-page-pinned--name">%name%</a> <span class="im-page-pinned--date">%date%</span> </div> <div class="im-page-pinned--content">%content%</div> </div>',im_pinned_message_media:'<span class="im-page-pinned--media">%text%</span>',im_pinned_message_media_bar:'<div class="im-page-pinned--media-bar">\n  <div class="im-page-pinned--media-bar_progress" style="width: %percent%%;"></div>\n</div>',im_pinned_messages_promo:'<div class="im-page--mess-actions-promo-content">%content%</div>',im_retry_link:function(){return'<button class="im-page--retry _im_retry_media">'+getLang("mail_retry")+"</button>"},sImLblWasEdited:function(){return" <span class='im-mess--lbl-was-edited _im_edit_time' data-time='%update_time%'>"+getLang("mail_was_edited_short")+"</span>"},sImLblWasSourceInfo:function(){return" <span class='im-mess--lbl-was-edited _im_page_info' data-info='%source%'>"+getLang("mail_was_source_short")+"</span>"},im_top_banner:'<div class="im-top-banner %classes%">\n  %icon%\n  <div class="im-top-banner--text">%text%</div>\n  <div class="im-top-banner--buttons">%buttons%</div>\n</div>',im_top_banner_icon:'<div class="im-top-banner--icon">\n  <img src="%icon%" alt=""/>\n</div>',im_top_banner_button_link:'<a href="%link%" target="_blank" class="_im_top_banner_button im-top-banner--button %css_class% flat_button button_small">%text%</a>',im_top_banner_button:'<button class="_im_top_banner_button im-top-banner--button %css_class% flat_button button_small" data-payload="%callback_data%">%text%</button>',im_top_banner_hide_btn:'<button class="im-top-banner--button im-top-banner--button_hide _im_top_banner_hide"></button>',im_calls_link:'<button class="im_srv_lnk_light _fc_call_link">%text%</button>',sImPeerMuteUnmute:'<button class="_im_peer_mute_unmute im-chat-input-block-control im-chat-input-block-control--with-icon im-chat-input-block-control--%type%">%text%</button>',sImPeerAcceptOrRejectMessageRequest:function(){return"<p>"+getLang("mail_message_request_user_notice")+'</p> <p> <button type="button" class="flat_button %cls_accept%">'+getLang("mail_message_request_accept")+'</button> <button type="button" class="flat_button secondary %cls_reject%">'+getLang("mail_message_request_reject")+"</button> </p>"},sImPeerReturnToChat:'<button class="_im_peer_return_to_chat im-chat-input-block-control">%text%</button>',sImCallSnippet:'<article class="CallSnippet %classes%" %attributes%> <div class="CallSnippet__users">%user_list%</div> <div class="CallSnippet__content"> <h3 class="CallSnippet__title">%title%</h3> <div class="CallSnippet__desc">%description%</div> </div> %button%</article>',sImMessageKeyboard:'<div class="MessageKeyboard">%content%</div>',sImMessageKeyboardRow:'<div class="MessageKeyboard__row">%content%</div>',sImMessageKeyboardButton:' <span class="MessageKeyboard__cell"> <%tagName% class="MessageKeyboard__button MessageKeyboard__button--%modifier% Button Button--size-s Button--%appearance% _im_mess_btn" %attributes% > <span class="MessageKeyboard__label">%label%</span> </%tagName%> </span>',sImBomb:'<span class="im-mess-stack--bomb %classnames%"></span>',sImEmptyCasper:function(){return' <div class="im-page--casper-empty"> '+getLang("mail_im_empty_casper_chat")+" </div>"},sImExpiredMessagePlaceholder:' <div class="im-expired-message _im_expired_message %id_classes%" data-count="%count%"> <a href="/im?w=expired_messages" target="_blank" class="im-expired-message--in"> <span class="im-expired-message--inner">%text%</span> </a> </div>',sImGiftLabel:' <span class="im-mess-stack--gift">%content%</span>',sImMoneyTransferLabel:' <span class="im-mess-stack--money-transfer">%content%</span>',sImUiActionMenuItem:'<a tabindex="0" role="link" class="ui_actions_menu_item im-action im-action_%icon% %classes%" data-action="%action%"> %name%</a>',sImPeerTagsItem:' <div class="PeerTagsItem _im_dialog_peer_tag" data-id="%tag_id%" style="background-color: %color%;">%name%</div>',sImPeerTagsAdTag:function(){return' <div class="PeerTagsItem PeerTagsItem--adTag %extra_class%"> <a href="%url%" target="_blank" class="PeerTagsItem__adTagLink"> <span class="PeerTagsItem__adTagText">%ad_tag_text%</span> </a> <button onclick="return showFastBox(\''+getLang("mail_ad_tag_no_access_box_title")+"', '"+getLang("mail_ad_tag_no_access_box_text")+'\');" class="PeerTagsItem__adTagAlert"> <span class="PeerTagsItem__adTagText">%ad_tag_text%</span> </button> </div>'},sImPeerTagsExtra:' <div class="PeerTagsItem PeerTagsItem--extra _im_peer_tags_extra">%text%</div>',sImPeerTagsExtraTooltipItem:' <div class="PeerTagsExtraTooltipItem"> <span class="PeerTagsExtraTooltipItem__color" style="background-color: %color%"></span> <span class="PeerTagsExtraTooltipItem__name">%name%</span> </div>',sImPeerTagsFilterItem:'<div class="PeerTagsFilterItem"> <input class="PeerTagsFilterItem__checkbox _im_peer_tags_filter_checkbox" type="checkbox" id="peer_tag_%tag_id%" %checked%> <label class="PeerTagsFilterItem__label" for="peer_tag_%tag_id%"> <span class="PeerTagsFilterItem__color" style="background-color: %color%"></span> <span class="PeerTagsFilterItem__name">%name%</span> <span class="PeerTagsFilterItem__count">%count%</span> </label> </div>',sImPeerTagsFilterPaneItem:'<div class="PeerTagsFilterPaneItem _im_peer_tags_filter_pane_item" data-id="%tag_id%"> <span class="PeerTagsFilterPaneItem__color" style="background-color: %color%"></span> <span class="PeerTagsFilterPaneItem__name">%name%</span> <span class="PeerTagsFilterPaneItem__remove"></span> </div>',sImCallUser:'<img src="%url%" alt="%name%" class="CallUsers__user">',sImCallUsers:'<div class="CallUsers"> <svg xmlns="http://www.w3.org/2000/svg" class="CallUsers__hidden"> <defs> <clipPath id="user-frame"> <path d="M12 0a12 12 0 11-7.97 20.97C5.89 18.47 7 15.37 7 12c0-3.36-1.1-6.47-2.97-8.97A11.95 11.95 0 0112 0z"/> </clipPath> </defs> </svg> <figure class="CallUsers__list"> %users% </figure> </div>',sImCallBannerContent:'<article class="CallBanner %cls%"> <div class="CallBanner__users">%user_list%</div> <div class="CallBanner__content"> <h3 class="CallBanner__title">%title%</h3> <div class="CallBanner__desc">%desc%</div> </div> </article>',sImCallBannerButton:function(){return'<button class="_im_top_banner_button _im_call_banner_join_btn im-top-banner--button flat_button button_small secondary" data-link="%call_link%">'+getLang("mail_join_chat")+"</button>"}}},"fD+e":function(e,t,a){"use strict";a.r(t),a.d(t,"TemplatesDropDown",(function(){return d}));var n=a("q1tI"),i=(a("17x9"),a("1Ot2")),s=a("6krn"),r=a("Jbbb"),o=a("n3cE"),l=a("ZxpX"),c=s.default.getLang;class d extends n.Component{constructor(){super(...arguments),this.elementOnClick=(e,t)=>{t.preventDefault(),t.stopPropagation(),this.props.applyTemplate(e),this.toggleDropdown(!1)},this.toggleDropdown=e=>{this.setState({isShowDropDown:e})},this.state={isShowDropDown:!1}}render(){var e=this.props,t=e.getTemplates,a=e.showSettingsPopup,s=e.showCreatingTemplatePopup,r=e.isNeededRendering,d=this.state.isShowDropDown;if(!r())return null;var u=t();return n.createElement("div",{className:"TemplatesDropDown",onMouseOver:this.toggleDropdown.bind(this,!0),onMouseOut:this.toggleDropdown.bind(this,!1)},n.createElement("div",{className:Object(l.classNames)("TemplatesDropDown__wrapper",{"TemplatesDropDown__wrapper--show":d}),"aria-hidden":d},n.createElement("div",{className:"TemplatesDropDown__container"},n.createElement(i.Scroll,{className:"TemplatesDropDown__scroll-wrapper"},n.createElement("div",null," ",n.createElement("header",{className:"TemplatesDropDown__header"},n.createElement("h2",{className:"TemplatesDropDown__title"},c("mail_community_templates")),n.createElement("a",{role:"button",className:"TemplatesDropDown__setting-button",onClick:a},c("mail_settings_configure"))),u.length?n.createElement("ul",{className:"TemplatesDropDown__list"},u.map(e=>n.createElement("li",{key:e.id,className:"TemplatesDropDown__item",onMouseDown:this.elementOnClick.bind(null,e.id)},n.createElement("h3",{className:"TemplatesDropDown__item-name",dangerouslySetInnerHTML:{__html:e.name}}),n.createElement("div",{className:"TemplatesDropDown__item-content",dangerouslySetInnerHTML:{__html:e.text}})))):n.createElement("div",{className:"TemplatesDropDown__not-found-container"},n.createElement("span",null,c("mail_community_templates_not_found")),n.createElement(o.default,{onClick:s},c("mail_add_community_template"))))))),n.createElement("button",{className:"TemplatesDropDown__icon"}))}}t.default=Object(r.connect)(d)},gF8j:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return o})),a.d(t,"getVisibilityState",(function(){return d})),a.d(t,"getVisiblityEvent",(function(){return u}));var n=a("uQjJ"),i=a("PU8N"),s=new(function(){function e(){this.onVisibilityChange=this._onVisibilityChange.bind(this)}return e.prototype._onVisibilityChange=function(){this.wakeLockSentinel&&"visible"===document.visibilityState&&this.lock().then((function(){})).catch(console.error)},e.prototype.requestWakeLock=function(){var e=this;return navigator.wakeLock?this.wakeLockSentinel?Promise.resolve():navigator.wakeLock.request("screen").then((function(t){e.wakeLockSentinel=t})):Promise.reject()},e.prototype.isLocked=function(){return!!this.wakeLockSentinel&&!this.wakeLockSentinel.released},e.prototype.lock=function(){var e=this;return this.requestWakeLock().then((function(){e.wakeLockSentinel&&document.addEventListener("visibilitychange",e.onVisibilityChange)})).catch((function(){}))},e.prototype.unlock=function(){var e=this;return this.wakeLockSentinel?(document.removeEventListener("visibilitychange",this.onVisibilityChange),this.wakeLockSentinel.release().finally((function(){e.wakeLockSentinel=null}))):Promise.resolve()},e}()),r=browser.iphone||browser.ipad||browser.ipod;function o(e){this.started=!1,this.is_idle=!0,this.activeTimeStart=null,this.cbActiveB=this.cbActive.bind(this),this.cbInactiveB=this.cbInactive.bind(this),this.onVisiblityChange=this.onVisiblityChange.bind(this),this.opts=extend({triggerEvents:"mousemove keydown",onIdleCb:function(){},onUnIdleCb:function(){},focusElement:e.element,element:null,idleTimeout:3e4},e)}function l(e,t,a){Object(i.isMvk)()?window.addEvent(e,t,a,{passive:!0}):window.addEvent(e,t,a)}function c(e,t,a){Object(i.isMvk)()?window.removeEvent(e,t,a,{passive:!0}):window.removeEvent(e,t,a)}function d(){return document.visibilityState||document.webkitVisibilityState}function u(){var e="visibilitychange";return document.visibilityState||(document.webkitVisibilityState?e+="webkit":e=""),e}extend(o.prototype,n.default.prototype),extend(o.prototype,{stop:function(){this.started=!1,c(this.opts.element,this.opts.triggerEvents,this.cbActiveB),Object(i.isMvk)()&&this._isTopLevel()&&u()&&c(document,u(),this.onVisiblityChange),Object(i.isMvk)()&&r||(c(this.opts.focusElement,"focus",this.cbActiveB),c(this.opts.focusElement,"blur",this.cbInactiveB)),clearTimeout(this.setIdleTo),clearTimeout(this.checkIdleCbTo),clearTimeout(this.sendCbTO),this.is_idle=!0,this.opts.parentManager&&this.opts.parentManager.off("idle",this.cbInactiveB)},idle:function(e){this.is_idle=!0,e||this.opts.onIdleCb(),this.emit("idle")},unidle:function(e){this.is_idle=!1,e||this.opts.onUnIdleCb(),this.emit("unidle")},start:function(){this.started=!0,!Object(i.isMvk)()&&browser.mobile||(this.is_idle=!this._isFocused(),this.opts.parentManager&&this.opts.parentManager.on("idle",this.cbInactiveB),Object(i.isMvk)()&&this._isTopLevel()&&u()&&l(document,u(),this.onVisiblityChange),Object(i.isMvk)()&&r||(l(this.opts.focusElement,"focus",this.cbActiveB),l(this.opts.focusElement,"blur",this.cbInactiveB)),clearTimeout(this.checkIdleCbTo),this.checkIdleCb(),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},checkIdleCb:function(){this.started&&(l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.setIdleTo),this.setIdleTo=setTimeout(this.cbInactiveB,this.opts.idleTimeout))},cbActive:function(){this.started&&(this.activeTimeStart=(new Date).getTime(),clearTimeout(this.setIdleTo),this.is_idle&&(this.is_idle=!1,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("unidle"),this.opts.onUnIdleCb&&this.opts.onUnIdleCb()}.bind(this),100)),c(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.checkIdleCbTo),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},cbInactive:function(){this.started&&(s.isLocked()||(this.activeTimeStart=null,this.is_idle||(this.is_idle=!0,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("idle"),this.opts.onIdleCb&&this.opts.onIdleCb()}.bind(this),100)),clearTimeout(this.checkIdleCbTo),c(this.opts.element,this.opts.triggerEvents,this.cbActiveB),l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout)))},getActiveTime(){return!this.is_idle&&this.activeTimeStart?(new Date).getTime()-this.activeTimeStart:0},onVisiblityChange(){"visible"===d()?this.cbActiveB():this.cbInactiveB()},_isTopLevel(){var e=this.opts.focusElement;return e===window||e===document},_isFocused(){var e=this.opts.focusElement;if(this._isTopLevel()){var t=d();return"string"==typeof t&&"visible"===t}return document.activeElement===e}})},hGJG:function(e,t,a){"use strict";a.r(t),a.d(t,"uploadConvoPhoto",(function(){return r}));var n=a("jE6c"),i=a("kcIO"),s=a("Iqrf");function r(){var e=2e9+Math.round(Object(n.rand)(1e6,2e6));return new Promise((function(t){window.cur.recieveCropResult=function(a){window.cur.recieveCropResult=!1,Object(s.ownerPhoto)(JSON.parse(a).data[0],e).then((function(e){var n=Array.isArray(e)?e[0]:e;t({photo:n,photoData:a}),Object(i.curBox)()&&Object(i.curBox)().hide(!0)}),(function(){}))},window.Page.ownerPhoto(e),Object(i.curBox)().setOptions({onHideAttempt:function(e){return e||t({}),!0}})}))}},hOuX:function(e,t,a){"use strict";a.r(t),a.d(t,"MAX_SAFE_INTEGER",(function(){return n})),a.d(t,"MAX_INTERGER",(function(){return i})),a.d(t,"random",(function(){return s}));a("tuSo");var n=9007199254740991,i=2147483647;function s(){try{if(window.crypto){var e=new Int32Array(1);return crypto.getRandomValues(e),Math.abs(e.reduce((e,t)=>e+t))}}catch(e){}return intval(rand(0,i).toFixed(0))}},iukX:function(e,t,a){"use strict";a.r(t),a.d(t,"ChatSettingsOptions",(function(){return v}));a("OEbY");var n=a("q1tI"),i=a("6krn"),s=a("p9ed"),r=a("5R8M"),o=a("hN/p"),l=a("BiHW"),c=a("WfnU"),d=a("0MTP"),u=a("/cSr"),g=(a("17x9"),a("ZxpX")),m=149946368,_=0;class p extends n.Component{constructor(e){super(e),this.selectPreset=(e,t)=>{var a=3===this.state.selectedPresetId&&null!==this.state.customFlags;this.setState(e=>({selectedPresetId:t,customFlags:a?this.props.flags:e.customFlags})),this.props.onSelectPreset(e)};var t=this.props.flags===m?2:this.props.flags===_?1:3;this.state={customFlags:3===t?this.props.flags:null,selectedPresetId:t}}componentWillReceiveProps(e){![_,m].includes(e.flags)&&this.setState({customFlags:e.flags,selectedPresetId:3})}render(){var e=this.state.customFlags?this.state.customFlags:this.props.flags,t=this.state.selectedPresetId,a=[{id:1,title:Object(i.getLang)("mail_chat_creation_preset_regular"),icon:"regular",flags:_},{id:2,title:Object(i.getLang)("mail_chat_creation_preset_closed"),icon:"closed",flags:m},{id:3,title:Object(i.getLang)("mail_chat_creation_preset_custom"),icon:"custom",flags:e}];return n.createElement("div",{className:"ChatSettingsPresetPanel"},a.map((e,a)=>n.createElement("div",{className:Object(g.classNames)("ChatSettingsPresetPanel__preset",{"ChatSettingsPresetPanel__preset--selected":e.id===t}),onClick:this.selectPreset.bind(null,e.flags,e.id),key:a},n.createElement("div",{className:Object(g.classNames)("ChatSettingsPresetPanel__presetIcon","ChatSettingsPresetPanel__presetIcon--"+e.icon)}),n.createElement("div",{className:"ChatSettingsPresetPanel__presetTitle"},e.title))))}}var h=a("lJdi"),b=i.default.getLang;class v extends n.Component{constructor(e){super(e),this.onChange=e=>{var t=e.name,a=e.selected.value;this.setState(e=>({flags:a?e.flags&~t^a:e.flags&~t}))},this.onCancel=()=>{this.setState({flags:this.props.flags}),this.props.back()},this.onSave=()=>{this.state.loading||(this.setState({loading:!0}),this.props.onSave(this.state.flags).then(()=>{this.setState({loading:!1},this.props.afterSave)}).catch(e=>{this.setState({loading:!1,flags:this.props.flags})}))},this.setFlags=e=>{this.setState({flags:e})},this.isAllowed=e=>{var t=this.props.allowedUpdateFlags;return!t||t.includes(e)},this.state={flags:e.flags,loading:!1}}render(){var e=this.state.flags,t=this.props,a=t.isChatTypeEditAllowed,i=t.isCasperChatTab,g=t.isCommunityChat,m=function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return[!g&&{value:e,label:b("mail_settings_only_owner")},{value:t,label:b(g?"mail_settings_only_admins":"mail_settings_owner_and_admins")},{value:a,label:b("mail_settings_all_members")}].filter(Boolean)};return n.createElement("div",{className:"ChatSettingsOptions"},this.props.isChatCreation&&n.createElement(p,{flags:e,onSelectPreset:this.setFlags}),n.createElement(s.default,null,(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE)})},n.createElement(u.default,{type:"plus",backgroundColor:"green"}),b("mail_settings_can_invite")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE)})},n.createElement(u.default,{type:"pencil",backgroundColor:"blue"}),b("mail_settings_can_edit_info")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN))&&!i&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_PIN+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_PIN,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_PIN|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN)})},n.createElement(u.default,{type:"pin",backgroundColor:"blue"}),b("mail_settings_can_pin")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION)})},n.createElement(u.default,{type:"mention",backgroundColor:"blue"}),b("mail_settings_can_use_mass_mention")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK,options:m(0,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK,h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK)})},n.createElement(u.default,{type:"link",backgroundColor:"blue"}),b("mail_settings_can_see_invitation_link")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL)})},n.createElement(u.default,{type:"call",backgroundColor:"green"}),b("mail_settings_can_start_group_call")),this.isAllowed(h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS)&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS,options:[{value:0,label:b("mail_settings_only_owner")},{value:h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS,label:b("mail_settings_owner_and_admins")}],value:e&h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS})},n.createElement(u.default,{type:"user",backgroundColor:"green"}),b("mail_settings_admins_can_add_admins")),this.isAllowed(h.MAIL_CHAT_FLAG_SERVICE_CHAT)&&a&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__select",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_SERVICE_CHAT,options:[{value:0,label:b("mail_settings_service_simple")},{value:h.MAIL_CHAT_FLAG_SERVICE_CHAT,label:b("mail_settings_service_service")}],value:e&h.MAIL_CHAT_FLAG_SERVICE_CHAT})},n.createElement(u.default,{type:"gear",backgroundColor:"gray"}),b("mail_settings_service"))),n.createElement(d.default,{alignment:"right",className:"ChatSettingsOptions__submitArena"},n.createElement(l.default,{appearance:"tertiary",onClick:this.onCancel},b("global_cancel")),n.createElement(c.default,{onClick:this.onSave,loading:this.state.loading},b("global_save"))))}}},m5nf:function(e,t,a){"use strict";a.r(t),a.d(t,"MAIN",(function(){return p})),a.d(t,"EDIT",(function(){return h}));a("pIFo"),a("91GP"),a("VRzm"),a("Btvt");var n=a("q1tI"),i=(a("17x9"),a("6krn")),s=a("amDN"),r=a("Jbbb"),o=a("BiHW"),l=a("1Ot2"),c=a("n3cE"),d=a("V1lx"),u=a("LYnS"),g=a("vT4u"),m=a("nAFc"),_=a("EasH"),p="main",h="edit";class b extends n.Component{constructor(){super(...arguments),this.setEditableMessage=e=>{var t=e.id,a=e.name,n=e.text;return new Promise(e=>this.setState({editableMessage:{id:t,name:a,text:n}},e))},this.onChangeEditableMessage=(e,t)=>this.setEditableMessage(Object.assign({},this.state.editableMessage,{[e]:Object(m.escape)(t)})),this.deleteTemplate=e=>Promise.resolve().then(()=>this.state.section!==p?this.go(p):Promise.resolve()).then(()=>this.props.store.set(g.deleteTemplate.bind(null,e))).catch(()=>{Object(_.showFastBox)(Object(i.getLang)("mail_error"),Object(i.getLang)("mail_community_templates_delete_error"))}),this.saveTemplate=e=>{e.preventDefault();var t=this.state.editableMessage,a=t.name,n=t.text;a.length>200||a.length<2||a.length>2e3||n.length<5?Object(_.showFastBox)(Object(i.getLang)("mail_error"),Object(i.getLang)("mail_form_is_filled_in_incorrectly")):this.props.saveTemplate(t).catch(()=>{Object(_.showFastBox)(Object(i.getLang)("mail_error"),Object(i.getLang)("mail_community_templates_save_error"))}).then(()=>this.go(p))},this.addHint=(e,t)=>{t.preventDefault();var a=this.state.editableMessage,n=a.id,i=void 0===n?null:n,s=a.name,r=a.text;return Object(d.setHTML)(this.textarea,`{${e.id}}`),this.setEditableMessage({id:i,name:s,text:`${r}{${e.id}} `})},this.getTextAreaRef=e=>{this.textarea=(e||{}).container},this.state={section:this.props.section,editableMessage:{id:null,name:"",text:""}}}go(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.id,n=void 0===a?null:a,i=t.name,s=void 0===i?"":i,r=t.text,o=void 0===r?"":r;return new Promise(t=>{this.state.section!==e?this.setState({section:e,editableMessage:{id:n,name:s,text:o}},()=>{this.props.popup.updateBoxCoords(),t()}):t()})}render(){var e=this.props,t=e.getTemplates,a=e.closePopup,r=this.state,g=r.section,m=r.editableMessage,_=t();return n.createElement("section",{className:"TemplatesSettings"},n.createElement(s.default,{title:n.createElement("span",{className:"TemplatesSettings__title"},g===p&&Object(i.getLang)("mail_community_templates"),g===h&&Object(i.getLang)("mail_add_community_template")),onCloseClick:a}),n.createElement("main",{className:"TemplatesSettings__content"},g===p&&(_.length?n.createElement(l.Scroll,{className:"TemplatesSettings__scroll-wrapper"},n.createElement("div",{className:"TemplatesSettings__list"},_.map(e=>n.createElement("section",{key:e.id,className:"TemplatesSettings__item"},n.createElement("h3",{className:"TemplatesSettings__item-name",dangerouslySetInnerHTML:{__html:e.name}}),n.createElement("div",{className:"TemplatesSettings__item-content",dangerouslySetInnerHTML:{__html:e.text}}),n.createElement("div",{className:"TemplatesSettings__buttons-row"},n.createElement(c.default,{onClick:()=>this.go(h,e),className:"TemplatesSettings__item-button"},Object(i.getLang)("mail_settings_edit")),n.createElement("span",{className:"TemplatesSettings__buttons-splitter","aria-hidden":"true"}," ","·"," "),n.createElement(c.default,{onClick:this.deleteTemplate.bind(null,e.id),className:"TemplatesSettings__item-button"},Object(i.getLang)("mail_delete"))))))):n.createElement("div",{className:"TemplatesSettings__not-found-container"},n.createElement("span",null,Object(i.getLang)("mail_community_templates_not_found")),n.createElement(c.default,{onClick:()=>this.go(h)},Object(i.getLang)("mail_add_community_template")))),g===h&&n.createElement("form",{className:"TemplatesSettings__form",id:"create_template_form",onSubmit:this.saveTemplate},n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label",htmlFor:"name"},Object(i.getLang)("mail_name"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},n.createElement(d.default,{id:"name",type:"text",initialValue:m.name,className:"TemplatesSettings__input",onChange:this.onChangeEditableMessage.bind(null,"name")}),n.createElement("span",{className:"TemplatesSettings__notice"},Object(i.getLang)("mail_community_templates_input_size").replace("{min}",2).replace("{max}","200")))),n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label",htmlFor:"text"},Object(i.getLang)("mail_text"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},n.createElement(d.default,{id:"text",name:"text",isMultiLine:!0,ref:this.getTextAreaRef,initialValue:m.text,className:"TemplatesSettings__textarea",onChange:this.onChangeEditableMessage.bind(null,"text")}),n.createElement("span",{className:"TemplatesSettings__notice"},Object(i.getLang)("mail_community_templates_input_size").replace("{min}",5).replace("{max}","2 000")))),n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label"},Object(i.getLang)("mail_hints"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},Object(u.default)().map(e=>n.createElement(o.default,{type:"button",onMouseDown:this.addHint.bind(null,e),appearance:"secondary",className:"TemplatesSettings__hint",key:e.id},e.label)))))),n.createElement("footer",{className:"TemplatesSettings__footer"},g===p&&n.createElement(n.Fragment,null,n.createElement(c.default,{onClick:()=>this.go(h)},Object(i.getLang)("mail_add_community_template")),n.createElement(o.default,{onClick:a},Object(i.getLang)("mail_close"))),g===h&&n.createElement(n.Fragment,null,n.createElement("div",null,m.id&&n.createElement(c.default,{onClick:this.deleteTemplate.bind(null,m.id)},Object(i.getLang)("mail_delete_community_template"))),n.createElement("div",null,n.createElement(o.default,{appearance:"tertiary",onClick:()=>this.go(p)},Object(i.getLang)("mail_cancel")),n.createElement(o.default,{onClick:this.saveTemplate,form:"create_template_form",type:"submit"},Object(i.getLang)("mail_save"))))))}}b.defaultProps={section:p},t.default=Object(r.connect)(b)},nJdr:function(e,t,a){"use strict";a.r(t),a.d(t,"createLongpoll",(function(){return h}));var n=a("DM26"),i=a("ER42"),s=a("eaP7"),r=function(){return(r=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function o(e,t){e.waitAbortFns.push(t)}function l(e){if(e.isStoppedFn())return Promise.resolve({ts:0,updates:[]});var t=Object(i.plaingetCancelable)(e.url,{act:"a_check",key:e.key,version:e.version,ts:e.ts,wait:25,mode:e.mode}),a=t.request,s=t.cancel;return e.stopFn=s,window.lpDebug={startedAt:Date.now(),finishedAt:null,error:!1,request:a,cancel:s},a.then((function(t){var a=t[0],n=t[1];return window.lpDebug&&(window.lpDebug=r(r({},window.lpDebug),{finishedAt:Date.now(),request:null,cancel:null})),e.onData(e,n),e.waitTimeout=2,JSON.parse(a)})).catch((function(t){var a=t[1];return window.lpDebug&&(window.lpDebug=r(r({},window.lpDebug),{finishedAt:Date.now(),error:!0,request:null,cancel:null})),e.onData(e,a),Promise.reject(new Error(""))})).then((function(t){return function(e,t){var a=t.failed?Object(n.abortablePause)(4,null):{abort:function(){},pause:function(){return Promise.resolve()}},i=a.abort,s=a.pause;switch(t.failed){case 1:return o(e,i),e.onHistoryLost(e,t).then((function(){return e.onResult({ts:t.ts,updates:[[-1]]})})).then(s).then((function(){return l(e)}));case 2:return o(e,i),e.onKeyExpired(e,t).then((function(t){var a=t[0],n=t[1],i=t[2],s=t[3];return e.onResult({ts:+s,updates:[[-2,a,n+"/"+i],[-1]]})})).then(s).then((function(){return l(e)}));case 3:return e.onLpBroken(e,t);default:return Promise.resolve(t)}}(e,t)}))}function c(e){e.isStoppedFn()||l(e).then(e.onResult.bind(e)).then((function(){return e.isReconnecting&&d(e,-5)})).catch((function(t){return function(e,t){if(e.isStoppedFn())return;e.onRequestError(t),e.waitTimeout=Math.min(60,2*e.waitTimeout),d(e,-3);var a=Object(n.abortablePause)(e.waitTimeout,null),i=a.abort,s=a.pause;return o(e,i),s().then((function(){return d(e,-4)}))}(e,t)})).then((function(){return c(e)}))}function d(e,t){e.isReconnecting=-4===t,e.onResult({ts:e.ts,updates:[[t,e.waitTimeout]]})}function u(e){return e||function(){}}function g(e){return e?function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];return Promise.resolve(e.apply(void 0,t))}:function(){return Promise.reject()}}var m=a("bP5l"),_=a("vT4u"),p=a("XzvV");function h(e,t){return function(e,t){var a=!!e.stopped,n={id:e.id,key:e.key,ts:e.ts,url:e.url,lpstat:e.lpstat||0,version:e.version||14,mode:202,waitTimeout:2,waitAbortFns:[],isReconnecting:!1,isStoppedFn:function(){return a},onResult:function(e){e.ts&&r(n.ts,e.ts,e.updates.map(s.constructEvent))},onData:u(t.onData),onRequestError:u(t.onRequestError),onHistoryLost:g(t.onHistoryLost),onKeyExpired:g(t.onKeyExpired),onLpBroken:g(t.onHistoryLost)},i=t.onEvents;function r(e,t,a){n.ts=t;for(var r=0;r<a.length;++r)a[r].type===s.REFRESH_LP_KEY&&(n.key=a[r].key||"",n.url=a[r].url||"");i(e,t,a)}var o={options:n,isStopped:function(){return a},stopConnection:function(){a=!0,n.stopFn&&n.stopFn(),n.stopFn=void 0,document.removeEventListener("resume",l),this.abortWaiting()},reinitConnection:function(){this.stopConnection(),document.addEventListener("resume",l),d(n,-4),a=!1,c(n)},abortWaiting:function(){n.waitAbortFns.forEach((function(e){return e()})),n.waitAbortFns=[],n.waitTimeout=2},onLp:r};function l(){o.abortWaiting()}return document.addEventListener("resume",l),c(n),o}(e,{onEvents:t,onData:f,onRequestError:O,onHistoryLost:C,onKeyExpired:y,onLpBroken:j})}var b={},v=Date.now();function f(e,t){if(t&&t.status&&e.lpstat){var a=t.status.toString();t.status>=500&&t.status<600&&Object(p.statlogsValueEvent)("fc_longpoll",1,a,t.getResponseHeader("x-frontend")||""),b[a]=a in b?b[a]+1:1,Date.now()-v>=3e4&&(Object.keys(b).forEach((function(e){Object(p.statlogsValueEvent)("fc_longpoll",b[e],e,t.getResponseHeader("x-frontend")||"")})),b={},v=Date.now())}}function O(e){Object(m.lpLogFc)("red","LP error",e.message||"no message (probably browser reset)")}function C(e,t){Object(m.lpLogFc)("red","LP failed: old timestamp; resync, next ts",t.ts)}function y(e){return Object(m.lpLogFc)("red","LP failed: key is incorrect; refresh key"),Object(i.post)(_.CONTROLLER,{act:"a_get_key",uid:e.id,gid:e.id<0?-e.id:0},1e3)}function j(){throw window.nav.reload({force:!0}),new Error("ts is very wrong")}},q2pz:function(e,t,a){"use strict";a.r(t),a.d(t,"mount",(function(){return F}));var n,i=a("ofcU"),s=a("q1tI"),r=a.n(s),o=a("i8i4"),l=a.n(o),c=a("e87a"),d=a("6krn"),u=a("euvX"),g=function(e){var t=e.title,a=e.onCloseModal,n=e.footer,i=e.isWithBackButton,s=void 0!==i&&i,o=e.onBackClick,l=e.children;return r.a.createElement(c.default,{className:"UserConvoInviteModal",disableBodyScroll:!0,onClose:a},r.a.createElement(u.ModalHeader,{title:t,onClose:a,appearance:"blue",backText:s?Object(d.getLang)("global_back"):void 0,onBack:o,className:"UserConvoInviteModal__header"}),r.a.createElement("div",{className:"UserConvoInviteModal__content"},l),n)},m=a("5PZO"),_=a("wQFj"),p=a("J4gp"),h=a("zjLC");!function(e){e.ALL="all",e.UNREAD="unread",e.IMPORTANT="important",e.UNANSWERED="unanswered",e.MESSAGE_REQUEST="message_request",e.BUSINESS_NOTIFY="business_notify",e.CHATS="chats"}(n||(n={}));var b=a("kxld"),v=a("EasH"),f=a("QDnf"),O=a("shih"),C=a("4+be"),y=a("4edV"),j=a("pdqG"),E=a("rudk"),S=a("DM26"),T=a("XuPN"),w=a("6x51"),I=a("Iqrf"),A=Object(S.debouncedPromise)(O.searchHints,300),M=function(){return!0};var k,L=a("ErRf"),P=a("1MUc"),N=a("hGJG"),D=d.default.getLang;!function(e){e[e.PICKER=0]="PICKER",e[e.CREATION=1]="CREATION"}(k||(k={}));var x=function(e){var t=e.user,a=e.store,i=e.onClose,o=e.onInviteSent,l=e.onGoToConvo,c=Object(s.useState)(k.PICKER),d=c[0],u=c[1],S=Object(s.useState)(!function(e){var t,a=e.get(),n=a.chatList||(null===(t=a.dialog_tabs)||void 0===t?void 0:t.all);return Boolean(n&&n.length>0)}(a)),x=S[0],B=S[1],R=Object(s.useState)(!0),F=R[0],H=R[1],U=Object(s.useState)(!1),G=U[0],q=U[1],W=Object(s.useState)(function(e){var t,a=e.get(),n=a.chatList||((null===(t=a.dialog_tabs)||void 0===t?void 0:t.all)||[]).filter(E.isChatPeer);if(n&&n.length>0)return n.map((function(t){return Object(b.getTab)(e,t)}));return[]}(a)),K=W[0],V=W[1],Y=Object(s.useState)(""),z=Y[0],Q=Y[1],X=Object(s.useCallback)((function(e){Q(e.target.value)}),[z]),$=Object(s.useCallback)((function(){}),[]),J=Object(s.useRef)(null),Z=function(e,t,a,n){var i=Object(s.useState)(t),r=i[0],o=i[1],l=Object(s.useState)(!1),c=l[0],d=l[1],u=Object(s.useRef)(a),g=Object(s.useCallback)((function(e){return e.name}),[]),m=Object(s.useCallback)((function(e){return e.peerId}),[]),_=Object(T.useIndexer)(t,g,m),p=Object(s.useCallback)((function(e){return n.filterFn?e.filter(n.filterFn):e}),[n.filterFn]);return Object(s.useEffect)((function(){if(u.current=a,a){var i=_.search(a),s=i.map((function(e){return e.peerId}));o(p(i)),d(!0),A(a,s,n.queryType||I.HintsSearchType.ALL,n,e.get()).then((function(e){u.current===a&&(o(Object(w.mergeConvoLists)(i,e,n.filterFn||M)),d(!1))})).catch((function(){}))}else o(p(t)),d(!1)}),[a,t]),[r,c]}(a,K,z,{queryType:I.HintsSearchType.ALL,filterFn:function(e){return Object(E.isChatPeer)(e.peerId)}}),ee=Z[0],te=Z[1];Object(s.useEffect)((function(){return Object(O.loadConversations)(a.get(),n.CHATS,200).then((function(e){var t=e.items;return V(Object(w.mergeConvoLists)(K,t)),t})).then((function(e){var t=e.reduce((function(e,t){return e[t.peerId]=t,e}),{});return a.set((function(a){return Object(j.mergeTabs)(t,a).then((function(t){return Object(y.setChatList)(t,e.map((function(e){return e.peerId})))}))}))})).finally((function(){return B(!1)})),Object(L.cancelStackPush)("convo_invite",(function(){})),function(){setTimeout((function(){return Object(L.cancelStackFilter)("convo_invite")}),0)}}),[]);var ae=t.inv_name?Object(C.langStr)(Object(C.langSex)(t.sex,D("mail_im_invite_user",!0)),"user",t.inv_name):D("mail_convo_invite_title");return r.a.createElement(r.a.Fragment,null,d===k.PICKER&&r.a.createElement(g,{title:ae,onCloseModal:i,footer:r.a.createElement(m.ModalFooter,null,r.a.createElement(_.default,{checked:F,onChange:function(e,t){return H(t)}},D("mail_im_chat_add_members_show_history")))},r.a.createElement(p.ConvoPicker,{convos:ee.map((function(e){return Object(b.getTab)(a,e.peerId)||e})),searchValue:z,onSearchValueChange:X,onSearchInputKeydown:$,onConvoSelect:function(e){q(!0),Promise.resolve().then((function(){return a.set((function(a){return Object(h.addNewMember)(e,[t.id],F,a)}))})).then((function(){return o(e)})).then((function(){i(),q(!1)})).catch((function(e){q(!1),Object(v.showFastBox)(D("global_error"),e)}))},checkDisabled:function(e){return!e.canInvite},searchInputGetter:function(e){return J.current=e},isLoading:x||te&&0===ee.length,style:{height:410},onAddClick:function(){return u(k.CREATION)}})),d===k.CREATION&&r.a.createElement(P.ChatCreation,{store:a,uploadAvatar:N.uploadConvoPhoto,onClose:i,onBack:function(){return u(k.PICKER)},onCreateChat:function(e){o(e).then((function(){}),(function(){})),i()},onGoToConvo:function(e){l(e),i()},preselectedUsers:[{id:t.id,peerId:t.id,name:t.name,photo:t.photo}]}),G&&r.a.createElement(f.default,null))};function B(){var e="_im_user_convo_invite",t=document.getElementById(e);if(t)return t;var a=document.createElement("section");return a.setAttribute("id",e),document.body.appendChild(a),a}function R(e){return{unmount:function(){var t=B();t&&l.a.unmountComponentAtNode(t),Object(i.destroyModule)(e)}}}function F(e,t,a,n){var s=(0,Object(i.createMutations)(R).bindMutations)(Object(i.createModule)({handlers:function(){}}));return function(e,t,a,n,i){var s=B();l.a.render(r.a.createElement(x,{user:a,store:e,onClose:t.unmount,onInviteSent:n,onGoToConvo:i}),s)}(e,s,t,a,n),s}},rCUf:function(e,t,a){"use strict";a.r(t),a.d(t,"getUploadVideoExtMasks",(function(){return s})),a.d(t,"getUploadModule",(function(){return o})),a.d(t,"onVideoUploaded",(function(){return l}));a("91GP"),a("pIFo");var n=a("EasH"),i=a("8h6g");function s(e){var t=i.VIDEO_UPLOAD_EXTS.slice(0,i.VIDEO_UPLOAD_EXTS.length);if("types"===e){for(var a=t.length,n=0;n<a;++n)t.push(t[n].toUpperCase());return"*."+t.join(";*.")}return"accept"===e?"."+i.VIDEO_UPLOAD_EXTS.join(",."):""}function r(e){if(!cur.leaving){var t=getLang("video_upload_changed"),a=!1;if(each(window.cur.videoUploaders,(e,t)=>{Upload.isSomethingUploading(t)&&(a=!0)}),1===e){if(!a)return!0;var i=Object(n.showFastBox)({title:getLang("global_warning"),dark:!0},t,getLang("global_continue"),(function(){cur.leaving=!0,i.hide(),cur.onContinueCb&&cur.onContinueCb()}),getLang("global_cancel"),(function(){i.hide(),nav.objLoc.section="upload",nav.setLoc(nav.objLoc)}));return!1}return a?winToUtf(t.replace(/<\/?b>/g,"").replace(/<br\s*\/?>/g,"\n")):void 0}}function o(e,t,a,o,c){if(a){o=o||cur,(c=c||{}).onUploadStart||(c.onUploadStart=e=>{boxQueue.hideLast(),cur.nav.push((function(e,t,a){if(!1===r(1))return cur.onContinueCb=nav.go.pbind(a),!1})),cur.prevBefUnload=window.onbeforeunload,window.onbeforeunload=r,c.onUploadProgress(e,0,0),Wall.showEditPost&&Wall.showEditPost(),c.onUploadStartDone&&c.onUploadStartDone()}),c.onUploadComplete||(c.onUploadComplete=(e,t)=>{var a=window.parseJSON(t);a.video_id?l(e,a,o):"string"==typeof t&&t.indexOf("TERMINATED")>-1||Upload.onUploadError(e);c.onUploadCompleteDone&&c.onUploadCompleteDone(),setTimeout(()=>{c.onUploadAllCompleteDone&&!window.Upload.isSomethingUploading(e.ind)&&c.onUploadAllCompleteDone()})}),c.onUploadProgress||(c.onUploadProgress=(e,t,a)=>{var n=void 0!==e.ind?e.ind:e;show("_im_media_preview"),o.showMediaProgress&&o.showMediaProgress("video",n,function(e,t,a){return{loaded:t,total:a,fileName:e.fileName?e.fileName.replace(/[&<>"']/g,""):void 0}}(e,t,a))}),c.onUploadError||(c.onUploadError=(e,t)=>{statlogsValueEvent("upload_video_fails",1,a.options.server,t),function(e){var t=void 0!==e.ind?e.ind:e,a=e.fileName?t+"_"+e.fileName:e;if(re("upload"+a+"_progress_wrap"),!geByClass1("popup_box_container")){var i=getLang("video_upload_error");setTimeout(Object(n.showFastBox)({title:getLang("global_error")},i).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+t)||{}).action}),Upload.embed(t)}(e)}),cur.maxFiles=(cur.chooseParams||{}).maxFiles||10;var d=cur.maxFiles-(cur.savedVideos||[]).length,u=browser.safari?"":"video/*,"+s("accept");a.lang&&(cur.lang=extend(cur.lang||{},a.lang));var g={accept:u,file_input:null,file_name:"video_file",file_size_limit:1024*(a.options.file_size_limit_in_GB||i.VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB)*1024*1024,file_types_description:"Video files",file_types:s("types"),chooseBox:1,chunked:1,chunkSize:i.VIDEO_UPLOAD_CHUNK_SIZE,clear:1,dragEl:t===boxLayerWrap?boxLayerWrap:bodyNode,dropbox:t,from:a.vars.from,lang:a.lang,max_attempts:3,max_files:d,multiple:1,multi_progress:1,requestOptionsForFile:!0,type:"video",visibleDropbox:!a.options.hasOwnProperty("visible_dropbox")||a.options.visible_dropbox},m=Upload.init(e,"",{},Object.assign(g,c));return window.cur.videoUploaders||(window.cur.videoUploaders=[]),window.cur.videoUploaders.push(m),m}}function l(e,t,a,i){a=a||cur;var s=void 0!==e.ind?e.ind:e,r=(e.fileName||e.filename||"").replace(/[&<>"']/g,""),o=r?s+"_"+r:e,l=t.owner_id+"_"+t.video_id,c=ge("upload"+o+"_progress_wrap");c&&hide(geByClass1("progress_x",c)),ajax.post("al_video.php?act=a_videos_attach_info",{videos:l},{onDone:e=>{a.chooseMedia("video",l,extend(e[l],{upload_ind:o,upload_new:!0}));var s=t.owner_id,r=t.video_id,c=t.video_hash,d=0,u=()=>{ajax.post("al_video.php?act=encode_progress",{oid:s,vid:r,hash:c,need_thumb:1},{onDone:t=>{var c,d=!0;if(t){if(t.error)return c=getLang("video_upload_encode_error"),void setTimeout(Object(n.showFastBox)({title:getLang("global_error")},c).hide,2e3);t.thumb&&(d=!1,ajax.post("al_video.php",{act:"a_video_photo_sizes",oid:s,vid:r},{onDone:t=>{a.hasChosenMedia("video",l)?a.updateChosenMedia("video",l,extend(t,{upload_ind:o,upload_new:!0})):i&&i(e,l)}}))}d&&a.hasChosenMedia("video",l)&&setTimeout(u,1e3)},onFail:()=>{++d<3&&setTimeout(u,2e3*d)}})};u()}})}t.default={getUploadModule:(e,t,a,n,i)=>o(e,t,a,n,i),initModalVideoUploader(){var e=cur.videoUploadParams,t=ge("choose_video_upload");return!!t&&(this.initDragEvents(),o(t,boxLayerWrap,e))},initDragEvents(){var e,t=e=>{cur.dragTimeout&&(clearTimeout(cur.dragTimeout),delete cur.dragTimeout);var t=ge("video_choose_upload_area_wrap");if(!hasClass(t,"video_choose_upload_area_enter")){addClass(t,"video_choose_upload_area_enter");var a=ge("video_choose_wrap"),n=getXY(a)[1],i=getSize(t)[1];return hide("video_choose_wrap"),setStyle(t,"height",scrollGetY()+window.clientHeight()-n+i),cancelEvent(e)}},a=e=>cancelEvent(e),n=e=>{if(a(),e.dataTransfer.files.length&&Upload.checkFilesSizes(window.videoInlineUploader,e.dataTransfer.files))return window.Upload&&Upload.checked&&Upload.checked[window.videoInlineUploader]&&Upload.onFileApiSend(window.videoInlineUploader,e.dataTransfer.files),cancelEvent(e)},i=()=>{addEvent(boxLayerWrap,"dragenter dragover",t),addEvent(boxLayerWrap,"dragleave",a),addEvent(boxLayerWrap,"drop",n)};i();var s=null===(e=curBox().getOptions())||void 0===e?void 0:e.onHide;setTimeout(curBox().setOptions.pbind({onHide:()=>{if(removeEvent(boxLayerWrap,"dragenter dragover",t),removeEvent(boxLayerWrap,"dragleave",a),removeEvent(boxLayerWrap,"drop",n),"function"==typeof s)return s()},onShow:()=>{i()}}),0)}}},t7TG:function(e,t,a){"use strict";a.r(t),a.d(t,"mount",(function(){return P}));a("VRzm"),a("Btvt");var n=a("ofcU"),i=a("q1tI"),s=a("i8i4"),r=a("Jbbb"),o=(a("91GP"),a("HEwt"),a("a1Th"),a("rGqo"),a("rE2o"),a("ioFf"),a("17x9"),a("amDN")),l=a("3blr"),c=a("J4gp"),d=a("vT4u"),u=a("DM26"),g=a("P13b"),m=a("rHUl"),_=a("lJdi"),p=a("rDjD"),h=a("6krn"),b=a("O8ze"),v=a("ZxpX"),f=a("rjmT"),O=a("EasH");function C(){return(C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function y(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return j(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return j(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var E=Object(u.debouncedPromise)(d.searchHints,300),S=h.default.getLang;class T extends i.Component{constructor(e){var t;super(e),t=this,this.toggleMode=()=>{var e=this.props.store;if(Object(m.isCommunityInterface)(e)){var t=0===this.state.mode?1:0,a=0===t?d.searchImTopConv:d.searchTopConv;this.setState({value:"",mode:t,loading:!0,selected:null,found:[]},()=>a("",e.get()).then(e=>this.setSearchResults(this.filterResults(e))).then(()=>this.searchInput.focus()).catch(e=>console.error(e)))}},this.onChange=e=>{this.setState({value:e.target.value,loading:!0,error:null});var t=e.target.value;this.searchQuery!==t&&(this.searchQuery=t,this.onSearch(t))},this.filterResults=e=>{var t=Object(m.isCommunityInterface)(this.props.store)&&1===this.state.mode;return e.filter(e=>{var a=e.peerId;return!(t&&a<0)&&(!(t&&a>2e9&&!Object(_.doesChatTabHaveFlag)(e,1024))&&!(!t&&a>2e9&&Object(_.doesChatTabHaveFlag)(e,1024)))})},this.onSearch=e=>{var t=this.props.store,a=t.get(),n=Object(m.isCommunityInterface)(t)&&0===this.state.mode,i=n?d.searchImTopConv:d.searchTopConv;return 1===this.state.mode&&""===e?this.emptySearch().then(e=>{this.setSearchResults(this.filterResults(e))}):i(e,a).then(t=>{var i=t.map(e=>e.peerId);return t=this.filterResults(t),this.setSearchResults(t,!1,!t.length),e?E(e,i,"all",{hidegid:n},a):Promise.resolve([])}).then(t=>{e===this.state.value&&this.setSearchResults(this.filterResults(t),!0)}).catch(()=>{})},this.emptySearch=()=>{var e=this.props.store,t=e.get(),a=t.dialog_tabs.all,n={},i={};return Object(d.searchTopConv)("",t).then(s=>(s.forEach(e=>{i[e.peerId]=e}),[t.peer].concat(a.filter(e=>e!=t.peer)).map(t=>{var a=Object(m.getTab)(e,t);return n[t]=!0,{name:i[t]&&i[t].tab||a.tab,photo:i[t]&&i[t].photo||a.photo,data:a.data,peerId:t}}).concat(s.filter(e=>!n[e.peerId]))))},this.sendRecipient=e=>{var t=this.props.store,a=t.get();1===this.state.mode?(a.longpoll.push([Object(p.changePeer)(e,!1,!0,!0,"forward_messages_popup")]),Object(b.statlogsForwardEvent)(t),Object(m.isCommunityInterface)(t)&&Object(b.statlogsForwardFromCommunityEvent)(t,!1)):this.setState({selected:e,error:null},()=>{Emoji.focus(this.input)})},this.loadMore=()=>{},this.getSearchInputEl=e=>this.searchInput=e,this.setSearchResults=function(e,a){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t.unmounted)if(a){var i=e.filter(e=>!t.found[e.peerId]);i.forEach(e=>{t.found[e.peerId]=!0}),t.setState({found:[].concat(t.state.found,i),loading:n})}else t.found=e.reduce((e,t)=>(e[t.peerId]=!0,e),{}),t.setState({found:e,loading:n,activeElement:0})},this.getFormRef=e=>{this.form=e},this.getInputRef=e=>{this.input=e},this.getEmojiButtonRef=e=>{this.emojiButton=e},this.onEmojiButtonMouseOver=e=>{e.persist(),Emoji.show(this.emojiButton,e)},this.onEmojiButtonMouseOut=e=>{e.persist(),Emoji.hide(this.emojiButton,e)},this.send=()=>{var e=this.props.store,t=this.state.selected,a=Emoji.val(this.input).trim(),n=new f.ImDraft({},0),i=e.get().pendingForward;if(t&&!Object(g.isMessageTooLong)(val)){this.setState({sending:!0});var s=Object(m.isCommunityInterface)(e)&&0===this.state.mode;s||n.addAttach("mail",i.msgIds.join(";"),i.object||null);var r={message:a,attaches:n.dData.attaches.map(e=>[e.type,e.id])||[]},o={hidegid:!0,external:{original_gid:e.get().id,fwd_group_msg_ids:s?i.msgIds.join(";"):void 0}};new Promise(a=>{Object(d.loadHashes)([t],{hidegid:!0},e.get()).then(e=>{var n=y(e,1)[0];return a(n[t])})}).then(a=>e.set(d.sendMessage.bind(null,t,r,C({hash:a},o)))).then(()=>{Object(b.statlogsForwardFromCommunityEvent)(e,!0),e.setState({pendingForward:null}),this.props.closePopup(),showDoneBox(S("mail_send3"))}).catch(e=>{this.unmounted||this.setState({sending:!1},()=>{Object(O.showFastBox)(S("mail_error"),e)})})}},this.onSearchKeyDown=e=>{27===e.keyCode&&this.state.value&&(this.searchInput.blur(),this.searchQuery="",this.setState({value:"",loading:!0,error:null},this.onSearch.bind(this,"")),e.stopPropagation())},this.onMessageInputKeyDown=e=>{27===e.keyCode&&(this.state.sending||(Emoji.val(this.input,""),this.setState({selected:null}),this.searchInput.focus()),e.stopPropagation())},this.state={value:"",found:[],mode:1,loading:!0,sending:!1,selected:null,activeElement:0},this.emptySearch().then(e=>{this.setSearchResults(this.filterResults(e))}).catch(e=>console.error(e))}componentDidMount(){this.props.updatePopup(),Emoji.init(this.input,{noStickers:!0,onSend:this.send}),this.input.addEventListener("keydown",this.onMessageInputKeyDown)}componentWillUnmount(){this.input.removeEventListener("keydown",this.onMessageInputKeyDown),this.unmounted=!0}render(){var e=this.props,t=e.store,a=e.closePopup,n=this.state,s=n.mode,r=n.loading,d=n.selected,u=n.found,g=n.sending,_=Object(v.classNames)("MessageForward",{"MessageForward--form":0===s&&!!d});return i.createElement("section",{className:_},i.createElement(o.default,{title:i.createElement(i.Fragment,null,i.createElement("span",{className:"MessageForward__title"},S("mail_forward_messages")),Object(m.isCommunityInterface)(t)&&i.createElement("span",{className:"MessageForward__switch",onClick:this.toggleMode},S(0===s?"mail_forward_to_community_messages":"mail_forward_to_im"))),onCloseClick:a}),i.createElement("div",{className:"MessageForward__content"},i.createElement(c.ConvoPicker,{searchValue:this.state.value,isLoading:r,convos:u.map(e=>e||Object(m.getTab)(t,e.peerId)),mode:1===s?c.convoPickerMode.DEFAULT:c.convoPickerMode.RADIO,selectedConvos:[d],onSearchValueChange:this.onChange,onSearchInputKeydown:this.onSearchKeyDown,onConvoSelect:this.sendRecipient,onListLoadMore:this.loadMore,searchInputGetter:this.getSearchInputEl,className:"MessageForward__convoPicker"}),i.createElement("footer",{className:"MessageForward__footer",ref:this.getFormRef,key:"footer"},i.createElement("div",{className:"MessageForward__form _emoji_field_wrap"},i.createElement("div",{className:"MessageForward__input",tabIndex:"0",contentEditable:!0,role:"textbox","aria-multiline":!0,ref:this.getInputRef,placeholder:S("mail_im_enter_msg")}),i.createElement("div",{className:"MessageForward__emoji emoji_smile_wrap _emoji_wrap"},i.createElement("div",{ref:this.getEmojiButtonRef,className:"emoji_smile _emoji_btn",title:S("global_emoji_hint"),onMouseOver:this.onEmojiButtonMouseOver,onMouseOut:this.onEmojiButtonMouseOut,onClick:this.onEmojiButtonClick},i.createElement("div",{className:"emoji_smile_icon_vector emoji_smile_icon"})))),g?i.createElement("div",{className:"MessageForward__send-spinner"},i.createElement(l.default,null)):i.createElement("button",{className:"MessageForward__send",onClick:this.send}))))}}var w,I=Object(r.connect)(T);function A(){w&&w.hide()}function M(){w&&w.updateBoxCoords()}function k(){return document.querySelector("#MessageForward")}function L(e){var t=document.querySelector("#box_layer_wrap"),a=document.querySelector("#box_loader"),i=isVisible(t);return{unmount(){var t=k();t&&s.unmountComponentAtNode(t),Object(n.destroyModule)(e)},showLoader(){boxRefreshCoords(a),show(a),i||show(t)},hideLoader(){hide(a),i||hide(t)}}}function P(e,t,a){var o=(0,Object(n.createMutations)(L).bindMutations)(Object(n.createModule)({handlers:(e,t)=>{}})),l={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:500,onShow(){!function(e){var t=k();t&&s.render(i.createElement(r.default,{value:e},i.createElement(I,{closePopup:A,updatePopup:M})),t)}(t),requestAnimationFrame(()=>w.updateBoxCoords())},onHideAttempt:()=>(t.set(d.prepareForward.bind(null,null)),o.unmount(),!0)};return o.showLoader(),Promise.resolve().then(e=>{o.hideLoader(),w=new MessageBox(l).content('<div id="MessageForward"></div>').show()}),o}},vhcd:function(e,t,a){"use strict";a.r(t),a.d(t,"ConvoInviteEntryPoint",(function(){return n})),a.d(t,"collectConvoInviteStats",(function(){return s}));var n,i=a("DM2o");!function(e){e.DIALOG_ACTIONS="dialog_actions",e.PROFILE_SCREEN="profile_screen",e.CONTACT_SCREEN="contact_screen"}(n||(n={}));var s=function(e,t){Object(i.statlogsValueEvent)("convo_invite",e,t)}}});