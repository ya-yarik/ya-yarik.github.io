!function(t){function e(e){for(var a,o,n=e[0],c=e[1],l=e[2],d=0,p=[];d<n.length;d++)o=n[d],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&p.push(i[o][0]),i[o]=0;for(a in c)Object.prototype.hasOwnProperty.call(c,a)&&(t[a]=c[a]);for(h&&h(e);p.length;)p.shift()();return s.push.apply(s,l||[]),r()}function r(){for(var t,e=0;e<s.length;e++){for(var r=s[e],a=!0,n=1;n<r.length;n++){var c=r[n];0!==i[c]&&(a=!1)}a&&(s.splice(e--,1),t=o(o.s=r[0]))}return t}var a={},i={"web/article":0},s=[];function o(e){if(a[e])return a[e].exports;var r=a[e]={i:e,l:!1,exports:{}};return t[e].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=t,o.c=a,o.d=function(t,e,r){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)o.d(r,a,function(e){return t[e]}.bind(null,a));return r},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/js/cmodules/";var n=window.webpackJsonp=window.webpackJsonp||[],c=n.push.bind(n);n.push=e,n=n.slice();for(var l=0;l<n.length;l++)e(n[l]);var h=c;s.push([108,"bundles/audioplayer","bundles/common","bundles/4060411aa2c063eade7896c7daf24353"]),r()}({"/e88":function(t,e){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},108:function(t,e,r){t.exports=r("4pkH")},"4PuL":function(t,e,r){"use strict";r.r(e);var a=r("lXE5"),i=r("aong"),s=r("zxIV"),o=r("t7n3"),n=r("Egk5");function c(t,e,r){if(Object(o.isObject)(e)?r=e:this._dragElClass=e,this.options=Object(o.extend)({dragThreshold:c.DRAG_THRESHOLD_DIST},r),this._contEl=Object(s.ge)(t),this._contEl){this._excludedCount=0;for(var a=0;a<this._contEl.children.length;a++)this._contEl.children[a].getAttribute("nodrag")&&this._excludedCount++;Object(n.addEvent)(this._contEl,"mousedown",this._ev_mousedown_handler=this._onMouseDown.bind(this)),Object(s.setStyle)(this._contEl,"position","relative"),this._inited=!0,this._updateScrollbar=this._initUpdaterScrollbar()}}c.AUTO_SCROLL_DY=10,c.DRAG_THRESHOLD_DIST=0,c.AUTO_SCROLL_DISTANCE_THRESHOLD=300,c.AUTO_SCROLL_GAP=300,c.prototype.destroy=function(){this._inited&&(this._inited=!1,this._deinitEvents(!0))},c.prototype._getParentDragItemEl=function(t){for(var e,r=t;r&&(e=Object(s.domPN)(r))!==this._contEl;)r=e;return r===this._curPlaceholderEl&&(r=null),r},c.prototype._onKey=function(t){t.keyCode===n.KEY.ESC&&this.isCurrentlyDragging()&&this._onMouseUp()},c.prototype._onMouseDown=function(t){if(!(this._disabled||0!=t.button||this._curDragEl||Object(s.attr)(t.target,"nodrag")||this._dragElClass&&!Object(s.domClosest)(this._dragElClass,t.target))){for(var e=t.target;e&&e!==window.document;){if(Object(o.intval)(Object(s.domData)(e,"nodrag")))return;e=Object(s.domPN)(e)}var r=this._getParentDragItemEl(t.target);if(r&&!Object(s.attr)(r,"nodrag")&&(Object(s.re)(Object(s.geByClass1)("ui_gridsorter_placeholder"),this._contEl),this._contInfo=this._contInfo||{prevSize:Object(s.getSize)(this._contEl)},this._ensureGridIsActual(),!(this._grid.length<=1))){var a=window.getComputedStyle(r),i=Object(s.getXY)(r);this._initial={candidateEl:r,x:t.clientX,y:t.clientY,itemMargin:{x:parseInt(a.marginLeft),y:parseInt(a.marginTop)},shift:{x:t.pageX-i[0],y:t.pageY-i[1]}},Object(n.addEvent)(document,"mousemove",this._ev_mousemove_handler=this._onMouseMove.bind(this)),Object(n.addEvent)(document,"mouseup",this._ev_mouseup_handler=this._onMouseUp.bind(this)),Object(n.addEvent)(document,"keydown",this._ev_keydown_handler=this._onKey.bind(this)),cur.cancelClick=!1,Object(n.cancelEvent)(t)}}},c.prototype._dist=function(t){return Math.abs(t.clientX-this._initial.x)+Math.abs(t.clientY-this._initial.y)},c.prototype._onMouseUp=function(t){var e=this._curDragEl,r=!t;if(this._curDragEl){this._curDragEl=null,Object(s.removeClass)(e,"ui_gridsorter_moveable_notrans"),this._curOverCell||(this._curOverCell={el:this._curPlaceholderEl,pos:Object(s.getXY)(this._curPlaceholderEl),size:Object(s.getSize)(this._curPlaceholderEl)});var a=this._curOverCell.pos,i=this._curOverCell.el,o=this._grid[this._curDragCellIndex],c=o&&o.size;Object(s.gpeByClass)("_ape_item_list",e)&&(a[0]+=20,a[1]+=20),c&&this._isShiftToLeft&&(a[1]-=c[1]-this._curOverCell.size[1]),setTimeout(()=>{if(r){for(var t=0,i=this._grid.length;t<i;t++){var s=this._grid[t];s.dirty&&this._setPos(s.el,{left:0,top:0})}this._setPos(e,this._initialCurDragPos)}else this._setPos(e,{left:a[0],top:a[1]})}),setTimeout(()=>{if(Object(s.re)(this._curPlaceholderEl),Object(s.removeClass)(this._contEl,"ui_gridsorter_cont"),this.options.dragCls&&Object(s.removeClass)(e,this.options.dragCls),this._inited){var t;if(r){for(var a=this._grid.length,o=0;o<a;o++){var n=this._grid[o];n.dirty&&this._setPos(n.el,{left:null,top:null})}this._setPos(e,{left:null,top:null,width:null,height:null})}else{var c;t=this._isShiftToLeft?Object(s.domNS)(i):i,this._contEl.insertBefore(e,t);var l=-1,h=this._initial.hasInlineSize;this._setPos(e,{left:null,top:null}),h||Object(s.setStyle)(e,{width:null,height:null});for(var d=this._grid.length,p=0;p<d;p++){var _=this._grid[p];(_.dirty||_.el===e)&&(this._setPos(_.el,{left:null,top:null}),h||Object(s.setStyle)(_.el,{width:null,height:null}),_.pos=this._calcElementPos(_.el),_.dirty=!1),_.el===e?c=p:_.el===i&&(l=p)}if(l>=0){var u=this._grid.splice(c,1);this._grid.splice(l,0,u[0])}}Object(s.removeClass)(e,"ui_gridsorter_moveable"),this._curOverCell=this._curPlaceholderEl=null,r&&this.update(),i!==e&&!r&&this.options.onReorder&&this.options.onReorder(e,t,Object(s.domPS)(e))}},210),t&&this._dist(t)>5&&(Object(n.cancelEvent)(t),cur.cancelClick=!0)}this._updateScrollbar(),this._deinitEvents(),e&&this._overEl&&this.options.onDragLeave&&this.options.onDragLeave(this._overEl,e),r||e&&this._overEl&&this.options.onDragDrop&&(r=this.options.onDragDrop(this._overEl,e)),this._overEl=null},c.prototype._deinitEvents=function(t){t&&(this._onMouseUp(),Object(n.removeEvent)(this._contEl,"mousedown",this._ev_mousedown_handler)),clearTimeout(this._autoScrollTO),this._autoScrollTO=!1,this._ev_mousemove_handler&&Object(n.removeEvent)(document,"mousemove",this._ev_mousemove_handler),this._ev_mouseup_handler&&Object(n.removeEvent)(document,"mouseup",this._ev_mouseup_handler),this._ev_keydown_handler&&Object(n.removeEvent)(document,"keydown",this._ev_keydown_handler)},c.prototype._setPos=function(t,e){this.options.noPosTransform||!this._hasTranslateFeauture&&!(this._hasTranslateFeauture=window.getComputedStyle(t).getPropertyValue("transform"))?Object(s.setStyle)(t,Object(o.extend)({transform:null},e)):null===e.left||null===e.top?Object(s.setStyle)(t,{transform:null,top:null,left:null}):Object(s.setStyle)(t,{transform:"translate("+e.left+"px, "+e.top+"px)",top:null,pos:null})},c.prototype._recalc=function(){var t=this._curDragEl,e=this._curOverCell.el;if(this._initGrid(),e!==t){for(var r=0,a=!1,i=!1,s=this._grid.length,o=0;o<s;o++){var n=this._grid[o];if(n.el===t){a=!0;break}if(n.el===e){a=!1;break}}this._isShiftToLeft=a;for(var c=a?0:this._grid.length-1,l=a?this._grid.length:-1,h=a?1:-1,d=[0,0];c!==l;c+=h){var p=this._grid[c];if(2!==r)if(p.el!==t){if(p.el===e&&r++,1===r||2===r){var _=0,u=0;a?(_=i.pos[0]+d[0],u=i.pos[1]+d[1],d[0]+=p.size[0]-i.size[0],d[1]+=p.size[1]-i.size[1]):(d[0]+=i.size[0]-p.size[0],d[1]+=i.size[1]-p.size[1],_=i.pos[0]+d[0],u=i.pos[1]+d[1]),this._setPos(p.el,{left:_-p.pos[0],top:u-p.pos[1]}),p.dirty=!0}else p.dirty&&(this._setPos(p.el,{left:null,top:null}),p.dirty=!1);i=p}else r++,i=p;else p.dirty&&(this._setPos(p.el,{left:null,top:null}),p.dirty=!1),i=p}}else for(var g=this._grid.length,b=0;b<g;b++){var f=this._grid[b];f.el!==t&&f.dirty&&(f.dirty=!1,this._setPos(f.el,{left:null,top:null}))}},c.prototype.disable=function(){this._disabled=!0},c.prototype.enable=function(){this._disabled=!1,this._initGrid(!0)},c.prototype.update=function(){this._disabled||this._initGrid(!0)},c.prototype._ensureGridIsActual=function(){this._initGrid()},c.prototype._needGridUpdate=function(){if(!this._grid)return 1;this._contInfo.prevSize=this._contInfo.prevSize||Object(s.getSize)(this._contEl);var t=0,e=this._contEl.children.length-this._excludedCount-Object(o.intval)(!!this._curPlaceholderEl);if(e!==this._grid.length)t=e>this._grid.length?2:1,this._contInfo.prevSize=Object(s.getSize)(this._contEl);else{var r=Object(s.getSize)(this._contEl),a=this._contInfo.prevSize;(Math.abs(a[0]-r[0])>5||Math.abs(a[1]-r[1])>5)&&(t=1),this._contInfo.prevSize=r}return t},c.prototype._initGrid=function(t){var e=t?1:this._needGridUpdate();if(e){1===e&&(this._grid=[],this._contInfo&&(delete this._contInfo.pos,delete this._contInfo.size));var r=this._grid?this._grid[this._grid.length-1]:null;this._grid=this._grid||[];var a,i=!!r,o=this._contEl.children;if(o.length)for(var n=this._getItemMargins(),c=this._curDragEl?this._grid.length:0,l=o.length;c<l;c++){var h=o[c];r&&h===r.el?i=!1:i||h===this._curPlaceholderEl||h.getAttribute("nodrag")||((a=Object(s.getSize)(h))[0]+=n[0],a[1]+=n[1],this._grid.push({el:h,size:a,pos:this._calcElementPos(h)}))}}},c.prototype._getRelativeMousePos=function(t){var e=this._getContPos(),r=this._getContShift();return{left:t.clientX-e[0]-r[0],top:t.clientY-e[1]-r[1]}},c.prototype._updateDraggablePosition=function(t){if(this._curDragEl){var e=this._getRelativeMousePos(t),r=this._getItemShift(),a=this._getContShift(),i=this._getContSize(),o=e.top-this._initial.shift.y-r[1]+a[1];this.options.limitBottomMove&&(o=Math.min(o,i[1]+30)),Object(s.hasClass)(this._contEl,"_ape_item_list")&&(o+=this._contEl.scrollTop),this._setPos(this._curDragEl,{left:e.left-this._initial.shift.x-r[0]+a[0],top:o}),window.AudioPage&&window.AudioPage.onUpdateDraggablePosition&&window.AudioPage.onUpdateDraggablePosition()}},c.prototype._getContShift=function(){if(this._contInfo=this._contInfo||{},!this._contInfo.shift){var t=window.getComputedStyle(this._contEl);this._contInfo.shift=[parseFloat(t.paddingLeft),parseFloat(t.paddingTop)]}return this._contInfo.shift},c.prototype._getContSize=function(){return this._contInfo=this._contInfo||{},this._contInfo.size=Object(s.getSize)(this._contEl),this._contInfo.size},c.prototype._getContPos=function(){return this._contInfo=this._contInfo||{},this._contInfo.pos=Object(s.getXY)(this._contEl),this._contInfo.pos[1]-=Object(a.scrollGetY)(),this._contInfo.pos},c.prototype._getItemShift=function(){if(this._contInfo=this._contInfo||{},!this._contInfo.itemShift){var t=window.getComputedStyle(Object(s.domFC)(this._contEl));this._contInfo.itemShift=[parseFloat(t.marginLeft),parseFloat(t.marginTop)]}return this._contInfo.itemShift},c.prototype._getItemMargins=function(){if(this._contInfo=this._contInfo||{},!this._contInfo.itemMargins){var t=window.getComputedStyle(Object(s.domFC)(this._contEl));this._contInfo.itemMargins=[parseFloat(t.marginLeft)+parseFloat(t.marginRight),parseFloat(t.marginTop)+parseFloat(t.marginBottom)]}return this._contInfo.itemMargins},c.prototype._calcElementPos=function(t){var e=this._getContShift(),r=this._getItemShift();return[t.offsetLeft-e[0]-r[0],t.offsetTop-e[1]-r[1]]},c.prototype.isCurrentlyDragging=function(){return!!this._curDragEl},c.prototype._initUpdaterScrollbar=function(){return Object(i.throttle)(t=>{var e=this.options.wrapNode||t,r=Object(s.data)(e,"sb");r&&r.update(!1,!0)},500)},c.prototype._onMouseMove=function(t){var e=()=>this.options.wrapNode?this.options.wrapNode.scrollTop:Object(a.scrollGetY)(),r=t=>{this.options.wrapNode?this.options.wrapNode.scrollTop=t:Object(a.scrollToY)(t,0,!1,!0)};if(this._curDragEl){this._ensureGridIsActual(),!t&&(t={clientX:this._lastMousePos.x,clientY:this._lastMousePos.y}),this._lastMousePos={x:t.clientX,y:t.clientY},this._updateDraggablePosition(t);var i=this._getContSize(),o=this._getRelativeMousePos(t),c=!1;if(Object(s.hasClass)(this._contEl,"_ape_item_list")&&(o.top+=this._contEl.scrollTop),o.left>0&&o.left<i[0]&&o.top>0&&o.top<i[1])for(var l=0,h=this._grid.length-1,d=50;d;){var p=l+Math.floor((h-l)/2),_=this._grid[p];if(o.left>_.pos[0]&&o.top>_.pos[1]&&o.left<_.pos[0]+_.size[0]&&o.top<_.pos[1]+_.size[1]){c=_;break}if(l===h)break;o.top<_.pos[1]||o.left<_.pos[0]&&o.top<_.pos[1]+_.size[1]?h=h===p?h-1:p:l=l===p?l+1:p,d--}else{for(var u,g,b,f=this._grid.length,v=999999,O=0;O<f;O++){var j=this._grid[O],y=(g=o.left-(j.pos[0]+j.size[0]/2))*g+(b=o.top-(j.pos[1]+j.size[1]/2))*b;v>y&&(v=y,u=j)}c=u}!c||this._curOverCell&&this._curOverCell.el===c.el||(this._curOverCell=c,this._recalc());var m,P,E,C,T=0;if(this.options.wrapNode)m=C=this.options.wrapNode,P=Object(s.getSize)(m),(E=Object(s.getXY)(m))[1]-=Object(a.scrollGetY)(),T=t.clientY;else{var w=window,I=document.documentElement,x=document.getElementsByTagName("body")[0],S=w.innerWidth||I.clientWidth||x.clientWidth,k=w.innerHeight||I.clientHeight||x.clientHeight;C=w.bodyNode,P=[S,k],E=[0,0],T=t.clientY}var L=Math.max(20,P[1]/10),A=E[1]+L-T,M=L-(E[1]+P[1]-T);if(M>0||A>0){var D=Math.min(1,A/L),N=Math.min(1,M/L);this._autoScrollTO||(this._autoScrollTO=setTimeout(()=>{this._autoScrollTO=!1;var t=e();r(t+16*(D>0?-D:N)),t!==C.scrollTop&&(this._updateScrollbar(C),this._onMouseMove())},20))}if(this.options.onDragOverElClass){var R=t.target;Object(s.hasClass)(R,this.options.onDragOverElClass)||(R=Object(s.gpeByClass)(this.options.onDragOverElClass,R))?this._overEl!==R&&(this._overEl&&this.options.onDragLeave&&this.options.onDragLeave(this._overEl,this._curDragEl),this.options.onDragEnter&&this.options.onDragEnter(R,this._curDragEl),this._overEl=R):(this._overEl&&this.options.onDragLeave&&this.options.onDragLeave(this._overEl,this._curDragEl),this._overEl=null)}}else if(this._dist(t)>this.options.dragThreshold){this._curDragEl=this._initial.candidateEl;for(var B=this._grid.length,z=0;z<B;z++)if(this._grid[z].el===this._curDragEl){this._curDragCellIndex=z;break}this.options.dragCls&&Object(s.addClass)(this._curDragEl,this.options.dragCls);var H=Object(s.getSize)(this._curDragEl),U=Object(s.getXY)(this._curDragEl),F=window.getComputedStyle(this._curDragEl),$=this._getContPos();this._initial.hasInlineSize=!(!this._curDragEl.style.width&&!this._curDragEl.style.height),Object(s.setStyle)(this._curDragEl,{width:H[0],height:H[1]}),this._initialCurDragPos={left:U[0]-$[0],top:U[1]-$[1]-bodyNode.scrollTop},this._curPlaceholderEl=Object(s.ce)("div",{className:"ui_gridsorter_placeholder"}),Object(s.setStyle)(this._curPlaceholderEl,{width:H[0]+parseFloat(F.marginLeft)+parseFloat(F.marginRight),height:H[1]+parseFloat(F.marginTop)+parseFloat(F.marginBottom)}),this._contEl.insertBefore(this._curPlaceholderEl,this._curDragEl),Object(s.addClass)(this._curDragEl,"ui_gridsorter_moveable"),Object(s.addClass)(this._curDragEl,"ui_gridsorter_moveable_notrans"),Object(s.addClass)(this._contEl,"ui_gridsorter_cont"),this._onMouseMove(t),this._updateDraggablePosition(t)}Object(n.cancelEvent)(t)},e.default=c},"4pkH":function(t,e,r){"use strict";r.r(e);var a=r("Ed98");window.ArticleEditor=a.default;try{window.stManager.done(window.jsc("web/article.js"))}catch(t){}},Cxd3:function(t,e,r){"use strict";r.r(e),r.d(e,"NBSP",(function(){return o})),r.d(e,"CURSOR_MARKER_START",(function(){return n})),r.d(e,"CURSOR_MARKER_END",(function(){return c})),r.d(e,"ArticleEditorParagraphClass",(function(){return l})),r.d(e,"replaceParagraphEntities",(function(){return h})),r.d(e,"isQuoteEl",(function(){return d})),r.d(e,"paragraphElProperties",(function(){return p})),r.d(e,"isParagraphEl",(function(){return _})),r.d(e,"selectEl",(function(){return u})),r.d(e,"focusEl",(function(){return g})),r.d(e,"isBR",(function(){return b})),r.d(e,"prepareLineText",(function(){return f})),r.d(e,"getElementIndex",(function(){return v})),r.d(e,"isObjectParagraphEl",(function(){return O})),r.d(e,"isObjectParagraph",(function(){return j})),r.d(e,"isObjectResize",(function(){return y})),r.d(e,"hasSeparator",(function(){return m})),r.d(e,"genSepatorId",(function(){return E})),r.d(e,"isEmbedType",(function(){return C})),r.d(e,"isHeaderParagraph",(function(){return T})),r.d(e,"isListParagraph",(function(){return w})),r.d(e,"buildParagraph",(function(){return I})),r.d(e,"convertBRsToArray",(function(){return x})),r.d(e,"getRange",(function(){return S})),r.d(e,"prepareSpacesWithSpaces",(function(){return k})),r.d(e,"cleanTextSpaces",(function(){return L})),r.d(e,"mergeRanges",(function(){return A})),r.d(e,"isWhiteSpaceChar",(function(){return M})),r.d(e,"isCyrillicChar",(function(){return N})),r.d(e,"isLatinChar",(function(){return R})),r.d(e,"isAlienParagraphEl",(function(){return B})),r.d(e,"getFocusedElement",(function(){return z})),r.d(e,"getPhotoSize",(function(){return H})),r.d(e,"childNodeIndex",(function(){return U})),r.d(e,"generateLatinizedName",(function(){return $})),r.d(e,"dataURItoBlob",(function(){return Y})),r.d(e,"imageToBlob",(function(){return W})),r.d(e,"queuePhotoProcess",(function(){return V})),r.d(e,"justCursorInString",(function(){return Q})),r.d(e,"isParagraphEmpty",(function(){return q})),r.d(e,"arrayUnique",(function(){return J})),r.d(e,"decorationsSlice",(function(){return Z})),r.d(e,"cleanLineBRs",(function(){return tt})),r.d(e,"cleanBRs",(function(){return et})),r.d(e,"createParagraphEl",(function(){return rt})),r.d(e,"traverseTree",(function(){return at})),r.d(e,"throttle",(function(){return it})),r.d(e,"isPublishNameCorrect",(function(){return st})),r.d(e,"correctRealIndexes",(function(){return nt})),r.d(e,"isVKUrl",(function(){return ct})),r.d(e,"decodeURL",(function(){return lt})),r.d(e,"BlockElements",(function(){return ht})),r.d(e,"hasBlockElements",(function(){return dt})),r.d(e,"buildProductSnippetElement",(function(){return pt}));var a=r("EE0W"),i=r("zxIV"),s=r("t7n3"),o="&nbsp;",n="​",c="‌",l="_article_paragraph";function h(t){return Object(i.se)("<textarea>"+(t||"")+"</textarea>").value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function d(t){return t&&t.nodeType==Node.ELEMENT_NODE&&Object(s.inArray)(t.tagName.toLowerCase(),["cite","blockquote"])}function p(t){return[Object(i.domData)(t,"type"),Object(i.domData)(t,"uuid"),Object(i.domData)(t,"mode")]}function _(t){return t&&Object(i.hasClass)(t,"_article_paragraph")}function u(t){if(t)try{var e=document.createRange();e.selectNodeContents(t);var r=window.getSelection();null==r||r.removeAllRanges(),null==r||r.addRange(e)}catch(t){}}function g(t,e){if(t)try{var r=document.createRange();e?(r.selectNodeContents(t),r.collapse(!1)):(r.setStart(t,0),r.setEnd(t,0));var a=window.getSelection();null==a||a.removeAllRanges(),null==a||a.addRange(r)}catch(t){}}function b(t){return t&&t.nodeType==Node.ELEMENT_NODE&&"BR"==t.tagName}function f(t,e,r,a,i){if(void 0===i&&(i=!1),t=t.substring(e,r),a&&a.length){var s=[],o=0;a.forEach((function(r){if(!((r-=e)<=0||r>t.length)){var a=t.substring(o,r)+"<br/>";a=i?a:k(a),s.push(a),o=r}}));var n=t.substring(o);s.push(i?n:k(n));s[s.length-1];return s.join("")}return i?t:k(t)}function v(t){if(!t)return!1;for(var e=0;null!=(t=t.previousSibling);)e++;return e}function O(t){return t&&t.nodeType==Node.ELEMENT_NODE&&!!Object(i.domData)(t,"uuid")}function j(t){return t&&t.type&&t.type>=100}function y(t){return t&&t.mode}function m(t){return t&&t.sep}var P=0;function E(){return++P}function C(t){return Object(s.inArray)(t,[a.ParagraphType.ObjectFacebook,a.ParagraphType.ObjectInstagram,a.ParagraphType.ObjectTwitter,a.ParagraphType.ObjectTelegram,a.ParagraphType.ObjectVK,a.ParagraphType.ObjectAliExpressProduct])}function T(t){var e;return e=Object(s.isObject)(t)?t.type:t,Object(s.inArray)(e,[a.ParagraphType.Header1,a.ParagraphType.Header2,a.ParagraphType.Header3])}function w(t){return t&&(t.type==a.ParagraphType.NumericList||t.type==a.ParagraphType.BulletList)}function I(t){var e={};return j(t=t||{})&&(e._uuid=t._uuid),e.lines=t.lines||[{text:"",decorations:{},brs:[]}],e.type=t.type?parseInt(t.type):a.ParagraphType.Text,t.mediaId&&(e.mediaId=t.mediaId),t.sep&&(e.sep=t.sep),t.fromExtPage&&(e.fromExtPage=t.fromExtPage),e}function x(t){if(Array.isArray(t))return t;var e=[];return Object(s.each)(t,(function(t,r){e.push(Object(s.intval)(r))})),e.sort(),e}function S(){var t=window.getSelection();return(null==t?void 0:t.rangeCount)?[t.getRangeAt(0),t.isCollapsed,t]:[!1]}function k(t){return-1!=t.search(/^\s/)&&(t=" "+t.trimLeft()),-1!=t.search(/\s$/)&&(t=t.trimRight()+o),t}function L(t){return t.replace(/\s\s+/g," ").replace(/\s/g," ")}function A(t){var e=t.slice();e.sort((function(t,e){return t[0]-e[0]}));for(var r=0;r<e.length-1;){var a=e[r],i=e[r+1],s=a[2]===i[2];a[1]>=i[0]&&s?(a[1]=Math.max(a[1],i[1]),e.splice(r+1,1)):r++}return e}function M(t){return/\s/.test(t)}var D=/[\u0400-\u04FF]/;function N(t){return D.test(t)}function R(t){return/[a-zA-Z]/.test(t)}function B(t){return!Object(i.hasClass)(t,l)}function z(){var t=window.getSelection();return null==t?void 0:t.focusNode}function H(t){var e=[];Object(s.each)(t,(function(t,r){e.push(r)}));var r=e.sort((function(t,e){return e[1]-t[1]}))[0];return[r[1],r[2]]}function U(t){var e=t.parentNode;if(null==e?void 0:e.childNodes.length)for(var r=0;r<e.childNodes.length;r++)if(t==e.childNodes[r])return r;return-1}var F={1072:"a",1073:"b",1074:"v",1075:"g",1076:"d",1077:"e",1105:"e",1078:"zh",1079:"z",1080:"i",1081:"i",1082:"k",1083:"l",1084:"m",1085:"n",1086:"o",1087:"p",1088:"r",1089:"s",1090:"t",1091:"u",1092:"f",1093:"h",1094:"c",1095:"ch",1096:"sh",1097:"sch",1099:"y",1101:"e",1102:"u",1103:"ya"};function $(t,e){t=t.toLowerCase();for(var r="",a=!1,i="-qwertyuiopasdfghjklzxcvbnm0123456789".split(""),o=0;o<t.length;o++)if(/\s/.test(t[o]))a||(r+="-",a=!0);else if(Object(s.inArray)(t[o],i))r+=t[o],a=!1;else{var n=F[t.charCodeAt(o)];n&&(r+=n,a=!1)}return r=(r=r.substr(0,e)).replace(/-*$/,"").replace(/^-*/,"").replace(/-+/g,"-")}function Y(t){var e,r,a;e=t.split(",")[0].includes("base64")?atob(t.split(",")[1]):unescape(t.split(",")[1]),r=t.split(",")[0].split(":")[1].split(";")[0],a=new Uint8Array(e.length);for(var i=0;i<e.length;i++)a[i]=e.charCodeAt(i);return new Blob([a],{type:r})}function W(t,e,r){var a="";if("function"==typeof e&&(r=e,e={}),e=e||{},!t)return r(new Error("Pass in a IMG DOM node or a url as first param"));if("object"==typeof t&&"img"===t.tagName.toLowerCase()&&(a=t.src),"string"==typeof t&&(a=t),!a.startsWith("data:")||e.convert){var i,s={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",svg:"image/svg+xml"};e.type=s[e.type]||((i=a)?s[i.split("?").shift().split(".").pop()]:null),e.src=a,e.callback=r,e.name=a,e.type?function(t,e){var r=document.createElement("canvas"),a=document.createElement("img");a.onload=function(){var t=r.getContext("2d");t&&(r.width=a.width,r.height=a.height,t.drawImage(a,0,0),e(null,r.toDataURL("image/png")))},a.addEventListener("error",(function(){e(new Error("FailedToLoadImage"))})),r.getContext&&r.getContext("2d")?(a.crossOrigin="anonymous",a.src=t):setTimeout(e,0,new Error("CanvasIsNotSupported"))}(a,G.bind(null,e)):r(new Error("Image type is not supported"))}else r(null,Y(a))}function G(t,e,r){if(e)t.callback(e);else{var a=Y(r);a.name=a.filename=t.name,t.callback(null,a)}}var X=[],K=0;function V(t,e){X.push({src:t,cb:e}),function t(){if(0!=X.length&&2!=K){K++;var e=X.shift(),r=new Image;r.addEventListener("error",(function(){null==e||e.cb(!0,!1,(function(){K--,t()}))})),r.addEventListener("load",(function(){W(r,{},(function(r,a){null==e||e.cb(r,a,(function(){K--,t()}))}))})),r.src=e.src}}()}function Q(t){return 1==(t=Object(s.trim)(t)).length&&t.startsWith(n)}function q(t,e){if(!t)return!0;if(j(t))return!1;var r=t.lines;return 0==r.length||!(e?Object(s.trim)(r[0].text):r[0].text)}function J(t){return t.filter((function(t,e,r){return r.indexOf(t)===e}))}function Z(t,e,r){var a={},i=function(i){if(t.hasOwnProperty(i)){var s=[];t[i].forEach((function(t){e<t[1]&&t[0]<=r&&s.push([Math.max(t[0],e)-e,Math.min(r,t[1])-e,t[2]])})),a[i]=s}};for(var s in t)i(s);return a}function tt(t){t.brs&&(t.brs=J(t.brs),t.brs[t.brs.length-1]==t.text.length&&t.brs.pop())}function et(t,e){var r=t.length;return(1==r&&t[r-1]==e||r>1&&t[r-1]==e&&t[r-2]!=e)&&t.pop(),t}function rt(t,e){void 0===t&&(t="");var r=e?'data-sep="'+E()+'"':"";return Object(i.se)('<p class="'+l+'" '+r+">"+t+"</p>")}function at(t,e,r,a){void 0===r&&(r=!0),void 0===a&&(a=!0);var i=e(t,a);if(void 0!==i)return i;for(var s,o=Array.prototype.slice.call(r?t.children:t.childNodes);s=o.shift();){var n=at(s,e,r,!1);if(void 0!==n)return n}}function it(t,e,r){var a,i,s,o=null,n=0;r||(r={});var c=function(){n=!1===r.leading?0:Date.now(),o=null,s=t.apply(a,i),o||(a=i=null)};return function(){var l=Date.now();n||!1!==r.leading||(n=l);var h=e-(l-n);return a=this,i=arguments,h<=0||h>e?(o&&(clearTimeout(o),o=null),n=l,s=t.apply(a,i),o||(a=i=null)):o||!1===r.trailing||(o=setTimeout(c,h)),s}}function st(t){return!!/^[a-z0-9\-]+$/.test(t)&&(!t.includes("--")&&(!t.startsWith("-")&&!t.endsWith("-")&&!(t.length>60)))}function ot(t,e,r){t.decorations&&Object(s.each)(t.decorations,(function(t,a){a.forEach((function(t){t[0]>e&&(t[0]+=r),t[1]>e&&(t[1]+=r)}))})),t.brs&&t.brs.forEach((function(r,a){r>e&&t.brs&&(t.brs[a]-=1)}))}function nt(t,e){t.forEach((function(t){t.lines.forEach((function(t){for(var r=0,a=t.text.length;r<a;r++){var i=t.text.charCodeAt(r);i>=55296&&i<=56319&&(ot(t,r,e),r+=1)}}))}))}function ct(t){return/^(https?:\/\/)?([a-z0-9_\-.]+\.)?vk.com(\/.*)?/.test(t)}function lt(t){var e=t;try{e=decodeURIComponent(t)}catch(r){e=t}return e}var ht="div p footer form h1 h2 h3 h4 h5 h6 header hgroup hr main nav output pre section table tfoot address article aside blockquote canvas dd dl dt fieldset figcaption figure".toUpperCase().split(" ");function dt(t){for(var e=0,r=t.children.length;e<r;e++)if(ht.includes(t.children[e].tagName))return!0;return!1}function pt(t,e){var r;if(t.snippet)r=t.snippet;else{var a=t.product;a.description||(a.description=a.title),r=Object(i.rs)(window.cur.articleEditor.getOptions().marketItemSnippetTemplate,a)}return Object(i.se)('<div class="'+e+'" contenteditable="false">'+r+"</div>")}},EE0W:function(t,e,r){"use strict";r.r(e),r.d(e,"ParagraphType",(function(){return i})),r.d(e,"ResizableObjectTypes",(function(){return s})),r.d(e,"ObjectResizeType",(function(){return o})),r.d(e,"ArticleStatsEvents",(function(){return n})),r.d(e,"getAppropriateImage",(function(){return c})),r.d(e,"preloadImage",(function(){return h})),r.d(e,"mailruStatsPixel",(function(){return d})),r.d(e,"getUrlParam",(function(){return p})),r.d(e,"changeHeightInstagramEmbed",(function(){return _})),r.d(e,"ALLOWED_FILE_TYPES_FOR_PASTE",(function(){return u}));var a=r("jE6c"),i={Text:1,Header1:2,Header2:3,Header3:4,Code:5,NumericList:6,BulletList:7,Quote:8,Quote2:9,ObjectAudioPlaylist:100,ObjectPhoto:101,ObjectVideo:102,ObjectGIF:103,ObjectPodcast:104,ObjectAudio:105,ObjectTwitter:106,ObjectFacebook:107,ObjectInstagram:108,ObjectVK:109,ObjectTelegram:110,ObjectPoll:111,ObjectMarketItem:112,ObjectAliExpressProduct:113},s=[i.ObjectPhoto,i.ObjectGIF,i.ObjectVideo,i.ObjectTwitter,i.ObjectFacebook,i.ObjectInstagram,i.ObjectVK,i.ObjectTelegram],o={Normal:0,Float:1,Medium:2,Large:3},n={clickOnVideo:"click_on_video",clickOnAudio:"click_on_audio",clickOnPhoto:"click_on_photo",clickOnExternalLink:"external_link_click",clickOnCarouselNext:"click_on_carousel_next",clickOnCarouselPrev:"click_on_carousel_prev",clickOnMentions:"click_on_mentions",nightModeOn:"night_mod_on",nightModeOff:"night_mod_off",close:"close"};function c(t,e,r){var i=[];if(Object(a.each)(t,(function(t,e){r&&!["w","z","y","x","m","s"].includes(t)||i.push(e)})),!i.length)return[!1];i.sort((function(t,e){return t[1]-e[1]})),e*=window.devicePixelRatio>=2?2:1;var s=i[i.length-1];return Object(a.each)(i,(function(t,r){if(r[1]>=e)return s=r,!1})),s}var l={};function h(t,e){if(!0===l[t])return e&&e(),!0;if(Array.isArray(l[t]))return l[t].push(e),!1;l[t]=[e];var r=new Image;return r.onload=function(){var e=l[t];l[t]=!0,Object(a.each)(e,(function(t,e){e&&e()}))},r.src=t,!1}function d(t,e){if(Object(a.isObject)(e)&&!Object(a.isEmpty)(e)){var r="https://vk-callback.go.mail.ru/longread_pxl?action="+t;Object(a.each)(e,(function(t,e){r+="&"+t+"="+e})),(new Image).src=r}}function p(t,e){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e||location.search);return null===r?"":decodeURIComponent(r[1].replace(/\+/g," "))}function _(t){if(/^https?:\/\/([\w-]+\.)*(instagram\.com|instagr\.am)$/.test(t.origin)){var e=function(t){for(var e,r=document.getElementsByTagName("iframe"),a=r.length-1;a>=0;a--){var i=r[a];if(i.contentWindow===t.source){e=i;break}}return e}(t);if(e){try{t=JSON.parse(t.data)}catch(t){}"object"==typeof t&&"string"==typeof t.type&&"object"==typeof t.details&&setTimeout((function(){if("MEASURE"===t.type){var r=t.details.height;e.setAttribute("height",r)}}),100)}}}var u="*.jpg;*.JPG;*.jpeg;*.JPEG;*.png;*.PNG;*.gif;*.GIF"},Ed98:function(t,e,r){"use strict";r.r(e),r.d(e,"default",(function(){return Nt}));r("a1Th"),r("rE2o"),r("ioFf"),r("VRzm"),r("HEwt"),r("Oyvg"),r("fA63"),r("OG14"),r("rGqo"),r("Btvt"),r("SRfc"),r("KKXr"),r("pIFo");var a,i=r("Cxd3"),s=r("4+be"),o=r("zxIV"),n=window.browser&&(window.browser.mozilla||window.browser.safari),c=function(){function t(t,e,r){this._mediaId=t,this._editor=e,this._highlighted=!1,this.isCaptioned=r,a=this.getEditor().getOptions().multiMediasSeparator}return Object.defineProperty(t.prototype,"isCaptioned",{get:function(){return this._isCaptioned},set:function(t){this._isCaptioned=t},enumerable:!0,configurable:!0}),t.prototype.getEditor=function(){return this._editor},t.prototype.getMediaIdsCount=function(){return this._mediaId.split(a).length},t.prototype.getMediaId=function(t){return void 0!==t?this._mediaId.split(a)[t]:this._mediaId},t.prototype.getMediaIds=function(){return this._mediaId.split(a)},t.prototype.setMediaId=function(t){this._mediaId=t},t.prototype.highlight=function(t,e){if(void 0===t&&(t=!1),void 0===e&&(e=!1),t!=this._highlighted){this._highlighted=t;var r=this.el();if(t){var a=Object(o.getSize)(r),s=Object(o.se)('<div class="article_ed__object_highlight _article_ed__object_highlight"></div>');Object(o.setStyle)(s,{width:a[0]+0,height:a[1]+0}),Object(o.addClass)(r,"article_ed__object_highlighted")}else Object(o.re)(Object(o.geByClass1)("_article_ed__object_highlight",r)),Object(o.removeClass)(r,"article_ed__object_highlighted");if(this.isCaptioned)if(t)this._toggleCaption(!0),this._toggleCaptionPlaceholder(this.isEmptyCaption()),e||Object(i.focusEl)(this._getCaptionEl(),!0);else{var n=this.isEmptyCaption();this._toggleCaptionPlaceholder(n),this._toggleCaption(!n)}}},t.prototype.render=function(){return!1},t.prototype.appendObjectInnerEl=function(){var t=this.render();Object(o.addClass)(t,"article_object_el"),t.setAttribute("contenteditable","false");var e=Object(o.geByClass1)("article_object_el",this._objectEl);if(e)Object(o.domReplaceEl)(e,t);else{var r=Object(o.geByClass1)("article_ed__img_inner",this._objectEl);r.insertBefore(t,r.firstChild)}},t.prototype.el=function(){var t=this;if(!this._objectEl){var e=this.render();Object(o.addClass)(e,"article_object_el"),e.setAttribute("contenteditable","false");var r=this.getEditor().isLocked()?"false":"true",a=window.browser.mozilla?'contenteditable="'+r+'"':'contenteditable="false"';this._objectEl=Object(o.se)("<figure "+a+"></figure>");var c=this.renderExtraControlsEl(),l=this.renderEditControlEl();if(c){var h=Object(o.se)('<div class="article_ed__img_wrapper"></div>'),d=Object(o.se)('<div class="article_ed__img_inner"></div>');c.setAttribute("contenteditable","false"),Object(o.addClass)(c,"article_ed__extra_controls"),d.appendChild(c),h.appendChild(d),this._objectEl.appendChild(h),this.appendObjectInnerEl()}else this._objectEl.appendChild(e);l&&this._objectEl.appendChild(l),this.isCaptioned&&(this._captionEl=Object(o.se)('<figcaption class="article_ed__figcaption" contenteditable="false">\n          <div class="article_ed__figcaption_edit" contenteditable="'+r+'"></div>\n          <div class="article_ed__caption_placeholder" contenteditable="false">'+Object(s.getLang)("pages_article_figure_placeholder")+"</div>\n        </figcaption>"),this._objectEl.appendChild(this._captionEl)),n&&e.addEventListener("click",(function(){t.highlight(!0),Object(i.focusEl)(e)}))}return this._setLoadingEl(),this._objectEl},t.prototype.renderExtraControlsEl=function(){return!1},t.prototype.renderEditControlEl=function(){return!1},t.prototype.renderLoadErr=function(){return Object(o.se)('\n      <div class="article_editor_embed_error">\n        <p class="article_editor_embed_error_text">'+Object(s.getLang)("pages_article_load_error_msg")+"</p>\n      </div>\n    ")},t.prototype.setLoadingState=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1),this._isLoading!=t&&(this._isLoading=t,this._setLoadingEl(e),Object(o.toggleClass)(this._objectEl,"article_ed__object_loading",t),t||this.getEditor().onObjectStateLoaded(this))},t.prototype.isLoading=function(){return this._isLoading},t.prototype._setLoadingEl=function(t){if(void 0===t&&(t=!1),this._objectEl){if(Object(o.re)(Object(o.geByClass1)("article_ed___object_loading_placeholder",this._objectEl)),this._isLoading){var e=Object(o.se)('<div class="article_ed___object_loading_placeholder"></div>');Object(o.toggleClass)(e,"article_ed__object_loading_white",t),Object(o.domInsertBefore)(e,this._objectEl.firstChild)}Object(o.toggleClass)(this._objectEl,"article_ed___object_loading",!!this._isLoading)}},t.prototype.getCaptionEl=function(){return!!this.isCaptioned&&this._getCaptionEl()},t.prototype.isCaptionFocused=function(){return!!this.isCaptioned&&this._isFocusInCaption()},t.prototype.setCaptionElHtml=function(t){if(this.isCaptioned){t=t.trim();var e=this._getCaptionEl();e&&(e.innerHTML!=t&&(e.innerHTML=t),this._toggleCaptionPlaceholder(!t),this._toggleCaption(!!t))}},t.prototype.isEmptyCaption=function(){var t;return!(null===(t=this._getCaptionEl().textContent)||void 0===t?void 0:t.trim())},t.prototype._getCaptionEl=function(){return Object(o.geByClass1)("article_ed__figcaption_edit",this._captionEl)},t.prototype._toggleCaption=function(t){Object(o.toggleClass)(this._captionEl,"article_ed__figcaption_visible",t)},t.prototype._toggleCaptionPlaceholder=function(t){void 0!==this._captionPlaceholderShown&&this._captionPlaceholderShown===t||(this._captionPlaceholderShown=Object(o.toggle)(Object(o.geByClass1)("article_ed__caption_placeholder",this._captionEl),t))},t.prototype._isFocusInCaption=function(){var t=this,e=Object(i.getRange)(),r=e[0],a=e[1];if(!r)return!1;var s=function(e){var r=t._captionEl;return!!Object(o.traverseParent)(e,(function(t){return t==r}),10)};if(a)return s(r.startContainer);var n=s(r.startContainer),c=s(r.endContainer);return n&&c},t.prototype.loadErrorHandler=function(t){this.setLoadingState(!1),Object(o.addClass)(this._objectEl,"article_paragraph_err"),t.appendChild(this.renderLoadErr())},t}(),l={};function h(t){var e=t.split("_");return e[0]+"_"+e[1]}var d,p=function(t,e,r){l[t]=l[t]||{},Object(i.isEmbedType)(t)?l[t][e]=r:l[t][h(e)]=r},_=function(t,e,r){if(l[t]=l[t]||{},Object(i.isEmbedType)(t))return l[t][e];if(void 0!==r){var a=e.split(",");e=a[r]}return l[t][h(e)]},u=function(t,e,r){l[t]=l[t]||{},l[t][e]=r},g=function(t,e){return l[t]=l[t]||{},l[t][e]},b=r("EE0W"),f=(d=function(t,e){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}d(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),v=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return f(e,t),e.prototype.render=function(){var t=this;this._el=Object(o.se)('\n      <div class="article_object_audio"></div>\n    ');var e=_(b.ParagraphType.ObjectAudioPlaylist,this.getMediaId());if(e.snippet)this._el.innerHTML=e.snippet;else{var r=this.getMediaId().split("_"),a=r[0],i=r[1];this.setLoadingState(!0),window.ajax.post("al_articles.php",{act:"get_audioplaylist_snippet",pl_owner_id:a,pl_id:i,pl_access_hash:e.accessHash},{onDone:function(e){t.setLoadingState(!1),t._el.appendChild(Object(o.se)(e))}})}return this._el.appendChild(Object(o.se)('<div class="article_ed__audioplaylist_play_note" contenteditable="false">'+Object(s.getLang)("pages_articles_editor_audio_play_note")+"</div>")),this._el},e}(c),O=r("t7n3"),j=r("EasH"),y=r("59zB"),m=r("4PuL");function P(t,e){return t?'<div class="article_ed__caredit_item article_ed__caredit_item_photo" data-media-id="'+e+'">\n      <div class="article_ed__caredit_photo" style="background-image: url('+t+')"></div>\n      <div class="article_ed__caredit_remove"><div class="article_ed__caredit_remove_icon"></div></div>\n    </div>':'<button class="article_ed__caredit_item article_ed__caredit_item_add" nodrag="1">\n      <div class="article_ed__caredit_add"></div>\n      <div class="article_ed__caredit_item_text">'+Object(s.getLang)("pages_article_ed_carousel_add")+"</div>\n    </button>"}var E,C,T=function(){function t(t,e,r,a){var i=this,n='<div class="article_ed__caredit">\n                  <div class="article_ed__caredit_inner">\n    ';n+='\n      <div class="article_ed__caredit_header">\n        <div class="article_ed__caredit_container">\n          '+Object(s.getLang)("pages_article_ed_carousel_title")+'\n          <div class="article_ed__caredit_header_controls">\n            <div class="article_ed__caredit_header_counter"></div>\n            <button class="flat_button article_ed__caredit_save">'+Object(s.getLang)("global_save")+'</button>\n            <button class="flat_button article_ed__caredit_cancel">'+Object(s.getLang)("global_cancel")+"</button>\n          </div>\n         </div>\n      </div>\n    ",n+='\n      <div class="article_ed__caredit_items_wrap article_ed__caredit_container">\n        <div class="article_ed__caredit_items">\n    ',e.getMediaId().split(",").forEach((function(t){var e=_(b.ParagraphType.ObjectPhoto,t),r=Object(b.getAppropriateImage)(e.sizes,251)[0];n+=P(r,t)})),n+=P(),n+="  </div>",n+="</div>",n+='</div>\n             <div class="article_ed__caredit_loading" style="display: none"></div>\n           </div>';var c=Object(o.se)(n);this._els={editor:c,itemsWrap:Object(o.geByClass1)("article_ed__caredit_items_wrap",c),items:Object(o.geByClass1)("article_ed__caredit_items",c),addButton:Object(o.geByClass1)("article_ed__caredit_item_add",c),saveButton:Object(o.geByClass1)("article_ed__caredit_save",c),cancelButton:Object(o.geByClass1)("article_ed__caredit_cancel",c),loading:Object(o.geByClass1)("article_ed__caredit_loading",c),counter:Object(o.geByClass1)("article_ed__caredit_header_counter",c)},this._els.addButton.addEventListener("click",(function(){Object(j.showBox)("al_photos.php",{to_id:e.getEditor().getArticleOwnerId(),act:"choose_photo",max_files:i._limit-i._medias.length,article:1},{cache:1,stat:[window.jsc("web/photos.js"),"photos.css",window.jsc("web/upload.js")]}),window.cur.chooseMedia=i._onPhotoAdd.bind(i),window.cur.showMediaProgress=function(){Object(o.show)(i._els.loading),e.getEditor().setMediaUploadMode(!0)},window.cur.choosePhotoUploadedAll=function(){Object(o.hide)(i._els.loading),e.getEditor().setMediaUploadMode(!1)}})),this._onSave=r,this._els.saveButton.addEventListener("click",this.save.bind(this)),this._els.cancelButton.addEventListener("click",this.cancel.bind(this)),this._els.items.addEventListener("click",(function(t){if(Object(o.hasClass)(t.target,"article_ed__caredit_remove")){var e=Object(o.gpeByClass)("article_ed__caredit_item",t.target);Object(o.re)(e),i._collectMediaIds(),i._initSorter(),i._toggleAddButton(),i._updateCounter()}})),t.appendChild(this._els.editor),Object(o.setStyle)(this._els.itemsWrap,{height:Object(o.getSize)(this._els.itemsWrap)[1]}),this._initSorter(),this._scroll=new y.default(this._els.itemsWrap,{global:!0,stopScrollPropagation:!0,stopScrollPropagationAlways:!0,theme:"dark"}),this._limit=a,this._originalMedias=this._collectMediaIds(),this._toggleAddButton(),this._updateCounter()}return t.prototype.cancel=function(){Object(o.re)(this._els.editor),this._onSave(this._originalMedias.join(","))},t.prototype.save=function(){Object(o.re)(this._els.editor),this._onSave(this._medias.join(","))},t.prototype._updateCounter=function(){this._els.counter.innerHTML=Object(s.getLang)("pages_aricle_ed_carousel_counter",this._medias.length)},t.prototype._toggleAddButton=function(){Object(o.toggle)(this._els.addButton,this._medias.length<this._limit),this._scroll.update()},t.prototype._collectMediaIds=function(){var t=this;return this._medias=[],Object(O.each)(this._els.items.children,(function(e,r){var a=Object(o.domData)(r,"media-id");a&&t._medias.push(a)})),this._medias=this._medias.slice(0,this._limit),this._medias},t.prototype.addPhoto=function(t,e,r){void 0===r&&(r=0),this._onPhotoAdd("photo",t,e,r)},t.prototype._onPhotoAdd=function(t,e,r,a){var s;if(!Object(O.inArray)(e,this._medias)&&this._medias.length<this._limit){p(b.ParagraphType.ObjectPhoto,e,{size:Object(i.getPhotoSize)(r.editable.sizes),sizes:r.editable.sizes});var n=Object(b.getAppropriateImage)(r.editable.sizes,251)[0];Object(o.domInsertBefore)(Object(o.se)(P(n,e)),this._els.addButton)}return void 0===a&&(null===(s=window.curBox())||void 0===s||s.hide(),this._initSorter(),this._scroll.update()),this._collectMediaIds(),this._toggleAddButton(),this._updateCounter(),!1},t.prototype._initSorter=function(){var t=this;this._sorter?this._sorter.update():this._sorter=new m.default(this._els.items,"",{onReorder:function(){t._collectMediaIds()}})},t}(),w=r("Egk5"),I=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),x=function(t){function e(e,r,a){var i=t.call(this,e,r,!0)||this;return i._currentImageIndex=0,i.paragraph=a,i}return I(e,t),e.prototype.cancelCarouselEditor=function(){var t;null===(t=this._carouselEditor)||void 0===t||t.cancel()},e.prototype.renderExtraControlsEl=function(){var t=this,e=Object(o.se)('\n        <div>\n          <div class="article_ed__carousel_nav_btn">\n            <div class="article_ed__carousel_nav_btn_left"></div>\n            <div class="article_ed__carousel_nav_btn_right"></div>\n          </div>\n          <div class="article_ed__carousel_btns">\n            <button class="article_ed__carousel_btn article_ed__carousel_btn_edit">'+Object(s.getLang)("pages_article_ed_create_carousel")+'</button>\n            <div class="article_ed__carousel_btn article_ed__carousel_counter"></div>\n          </div>\n        </div>\n    ');this._carouselControlsEl=e;var r=Object(o.geByClass1)("article_ed__carousel_btn_edit",e),a=Object(o.geByClass1)("article_ed__carousel_nav_btn_left",e),i=Object(o.geByClass1)("article_ed__carousel_nav_btn_right",e);return this._editButtonEl=r,this._controls=e,this.updateEditButtonCaption(),r.addEventListener("click",(function(e){return t.createCarousel(),Object(w.cancelEvent)(e)})),a.addEventListener("click",this.prevPhotoInCarousel.bind(this)),i.addEventListener("click",this.nextPhotoInCarousel.bind(this)),this._setImageIndex(0),e},e.prototype.renderCarouselHover=function(){this._carouselControlsEl&&!this._hoverEl&&(this._hoverEl=Object(o.ce)("div",{className:"article_ed__carouselHover",innerHTML:this.isCarousel()||this.isCarouselEditorOpened()?Object(s.getLang)("pages_article_ed_add_photo_carousel_hint"):Object(s.getLang)("pages_article_ed_create_carousel_hint")}),Object(o.domInsertAfter)(this._hoverEl,this._carouselControlsEl))},e.prototype.removeCarouselHover=function(){Object(o.re)(this._hoverEl),this._hoverEl=null},e.prototype.updateEditButtonCaption=function(){var t=this.getMediaIdsCount()>1;this._editButtonEl.innerHTML=t?Object(s.getLang)("pages_article_ed_edit_carousel"):Object(s.getLang)("pages_article_ed_create_carousel")},e.prototype.createCarousel=function(){var t=this,e=this.getEditor();e.closeAllCarouselEditors(),e._resizeTooltip&&e._resizeTooltip.hide(),Object(o.addClass)(this._objectEl,"article_ed__carousel_edit_open"),this._carouselEditor=new T(this._controls,this,(function(e){e?(delete t._fixedImageSize,t.setMediaId(e),t.appendObjectInnerEl(),t.getEditor().saveUndoStateAndDraft(),t.updateEditButtonCaption(),t._setImageIndex(0),Object(o.removeClass)(t._objectEl,"article_ed__carousel_edit_open"),delete t._carouselEditor):t.getEditor().removeObject(t)}),this.getEditor().getLimits().maxCarouselItems)},e.prototype.addPhotoInCarousel=function(t,e,r){void 0===r&&(r=0),this._carouselEditor&&this._carouselEditor.addPhoto(t,e,r)},e.prototype.nextPhotoInCarousel=function(){this.isCarousel()&&this._changePhotoInCarousel(!1)},e.prototype.prevPhotoInCarousel=function(){this.isCarousel()&&this._changePhotoInCarousel(!0)},e.prototype._changePhotoInCarousel=function(t){var e=this.getEditor();this._setImageIndex(this.getImageIndex()+(t?-1:1));var r=e.getObjectParagraphIndex(this.paragraph);if(r>=0?(e.setParagraphDirty(r),e.redraw(!1)):e.redraw(!0),this.isCaptionFocused()){var a=this.getCaptionEl();a&&Object(i.focusEl)(a,!0)}},e.prototype.getImageIndex=function(){return Math.min(this.getMediaIdsCount()-1,this._currentImageIndex)},e.prototype._setImageIndex=function(t){this._currentImageIndex=Math.min(Math.max(0,t),this.getMediaIdsCount());var e=Object(o.geByClass1)("article_ed__carousel_nav_btn",this._carouselControlsEl);Object(o.toggleClass)(e,"no_left",0==this._currentImageIndex),Object(o.toggleClass)(e,"no_right",this._currentImageIndex==this.getMediaIdsCount()-1),Object(o.toggleClass)(this._objectEl,"article__carousel",this.isCarousel());var r=Object(o.geByClass1)("article_ed__carousel_counter",this._carouselControlsEl);this.isCarousel()?(Object(o.setStyle)(r,"display","inline-block"),r.innerHTML=Object(s.getLang)("pages_article_ed_carousel_counter").replace("{counter}",this._currentImageIndex+1).replace("{total}",this.getMediaIdsCount())):Object(o.hide)(r),this._drawImage(),this.highlight()},e.prototype.render=function(){this._el=Object(o.se)('\n      <div class="article_ed__img_content">\n        <img contenteditable="false" class="article_ed__img"/>\n      </div>\n    ');var t=_(b.ParagraphType.ObjectPhoto,this.getMediaId(),0);return t&&t.sizes?(this.setLoadingState(!1),this._drawImage()):this.setLoadingState(!0),this._el},e.prototype._initUpload=function(){var t=this;if(void 0===this._upload){var e=this.getEditor().getPhotoUploadOptions();this._upload=window.Upload.init(this.getEditor().getPhotoUploadEl(),e.url,e.params,{file_name:"photo",file_size_limit:15728640,file_types_description:"Image files (*.jpg, *.jpeg, *.png, *.gif)",file_types:b.ALLOWED_FILE_TYPES_FOR_PASTE,file_input:null,accept:"image/jpeg,image/png,image/gif",wiki_editor:0,noCheck:!0,onUploadComplete:function(e,r){r=JSON.parse(r),Object(O.isEmpty)(r)?t._onUploadCallback&&t._onUploadCallback():window.ajax.post("al_photos.php",Object(O.extend)({act:"choose_uploaded"},r),{onDone:function(e,r){t._mediaId=e,p(b.ParagraphType.ObjectPhoto,e,{size:Object(i.getPhotoSize)(r.editable.sizes),sizes:r.editable.sizes}),t._drawImage(),t._onUploadCallback&&t._onUploadCallback(),t.getEditor().saveUndoStateAndDraft()}})},noFlash:1,max_files:20,chooseBox:1,clear:1,type:"photo",max_attempts:3,server:e.opts.server,error:e.opts.default_error,error_hash:e.opts.error_hash})}},e.prototype._getImageEl=function(){return Object(o.geByTag1)("img",this._el)},e.prototype.setBLOB=function(t,e){var r=this;this._onUploadCallback=e;var a=new FileReader;a.onload=function(){r._initUpload(),window.Upload.onFileApiSend(r._upload,[t])},a.readAsDataURL(t)},e.prototype._drawImage=function(){var t=this;if(this._el){var e=_(b.ParagraphType.ObjectPhoto,this.getMediaId(),this.getImageIndex()),r=720;switch(Number(this.paragraph.mode)){case 1:r=350;break;case 2:r=920;break;case 3:r=window.innerWidth}if(e){var a=Object(b.getAppropriateImage)(e.sizes,r)[0],i=this._getImageEl(),s=!1;i.onload=function(){clearTimeout(E),s=!0,Object(o.setStyle)(i,"visibility","visible"),Object(o.show)(i),t.setLoadingState(!1),t.isCarousel()&&t._fixSize()},i.src=a,clearTimeout(E),s||(E=setTimeout((function(){s||(Object(o.setStyle)(i,"visibility","hidden"),t.setLoadingState(!0,t.isCarousel()))}),10))}}},e.prototype.isCarousel=function(){return this.getMediaIdsCount()>1},e.prototype.isCarouselEditorOpened=function(){return!!this._carouselEditor},e.prototype._fixSize=function(){this._fixedImageSize=Object(o.getSize)(this._el),this._fixedImageSize[0]=Math.ceil(this._fixedImageSize[0]),this._fixedImageSize[1]=Math.ceil(this._fixedImageSize[1]),Object(o.setStyle)(this._el,{height:this._fixedImageSize[1]+"px"}),Object(o.setStyle)(this._getImageEl(),{"max-width":this._fixedImageSize[0],"max-height":this._fixedImageSize[1]})},e.prototype.isSmallPhotoSize=function(){var t=_(b.ParagraphType.ObjectPhoto,this.getMediaId(),0);return!(!t&&!t.size)&&t.size[0]>=720},e}(c),S=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),k=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return S(e,t),e.prototype.render=function(){this._el=Object(o.se)('<div class="article_object_video"></div>');var t=_(b.ParagraphType.ObjectVideo,this.getMediaId());if(!t)return this._el;if(t.preview)this._el.appendChild(Object(o.se)('<div class="article_ed__video_play_note" contenteditable="false">'+Object(s.getLang)("pages_articles_editor_video_play_note")+"</div>")),this._el.appendChild(Object(o.se)(t.preview));else if(t.editable||t.thumb){var e=void 0;if(t.thumb)e=t.thumb;else e=Object(b.getAppropriateImage)(t.editable.sizes,this.getEditor().getWidth(!0))[0];this._el.appendChild(Object(o.se)('<div class="article_object_video_play"></div>')),this._el.appendChild(Object(o.se)(Object(o.rs)(this.getEditor().getOptions().videoLabelTemplate,{duration:t.duration||0,platform:t.platform||""}))),this._el.appendChild(Object(o.se)('<div class="article_ed__video_play_note" contenteditable="false">'+Object(s.getLang)("pages_articles_editor_video_play_note")+"</div>")),this._el.appendChild(Object(o.se)('<img class="article_ed__video_img" src='+e+' contenteditable="false" />'))}return this._el},e}(c),L=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),A=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return L(e,t),e.prototype.render=function(){var t=this;this._el=Object(o.se)('<div class="article_ed__gif_content"></div>');var e=_(b.ParagraphType.ObjectGIF,this.getMediaId());if(e)if(e.video){if(this._videoEl=Object(o.ce)("video",{autoplay:!0,loop:"loop",muted:!0,src:e.video+"&mp4=1"}),e.size){var r=e.size[0]<e.size[1],a=!this._isSmallGifSize();(r||a)&&Object(o.setStyle)(this._videoEl,{width:e.size[0]})}this._el.appendChild(this._videoEl),this._el.appendChild(Object(o.se)('<span class="article_ed__select_dummy">&nbsp;</span>'))}else if(e.href){var i=e.href+"&wnd=1&module="+window.cur.module;this._imgEl=Object(o.ce)("img",{}),this._imgEl.addEventListener("error",(function(){Object(j.showFastBox)(Object(s.getLang)("pages_article_error_box_title"),Object(s.getLang)("pages_article_error_box_text")),t._editor.removeObject(t)})),this._imgEl.src=i,this._el.appendChild(this._imgEl)}return this._el},e.prototype.onViewport=function(t){this._imgEl?Object(o.setStyle)(this._imgEl,"visibility",t?"visible":"hidden"):t?this._videoEl&&this._videoEl.play().catch((function(){})):this._videoEl&&this._videoEl.pause()},e.prototype.onRender=function(){var t=this;setTimeout((function(){if(t._videoEl&&(t._videoEl.play().catch((function(){})),window.browser.msie)){var e=t._videoEl.src;t._videoEl.src="",t._videoEl.src=e}}))},e.prototype._isSmallGifSize=function(){var t=_(b.ParagraphType.ObjectGIF,this.getMediaId());return!(!t||!t.size)&&t.size[0]>this.getEditor().getOptions().minGifWidthExpand},e}(c),M=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),D=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return M(e,t),e.prototype.render=function(){var t=this;this._el=Object(o.se)('\n      <div class="article_object_audio"></div>\n    ');var e=_(b.ParagraphType.ObjectPodcast,this.getMediaId());if(e.snippet)this._el.innerHTML=e.snippet;else{var r=this.getMediaId().split("_"),a=r[0],i=r[1];this.setLoadingState(!0),window.ajax.post("al_articles.php",{act:"get_podcast_snippet",owner_id:a,podcast_id:i},{onDone:function(e){t.setLoadingState(!1),t._el.appendChild(Object(o.se)(e))}})}return this._el.appendChild(Object(o.se)('<div class="article_ed__audioplaylist_play_note" contenteditable="false">'+Object(s.getLang)("pages_articles_editor_audio_play_note")+"</div>")),this._el},e}(c),N=r("pp2G"),R=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),B=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return R(e,t),e.prototype.render=function(){var t=_(b.ParagraphType.ObjectAudio,this.getMediaId()).audio,e=N.AudioUtils.drawAudio(t);return this._el=Object(o.se)('<div class="article_object_audio">'+e+"</div>"),this._el},e}(c),z=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),H=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return z(e,t),e.prototype.render=function(){var t=_(b.ParagraphType.ObjectMarketItem,this.getMediaId());return this._el=Object(i.buildProductSnippetElement)(t,"article_add__object_market_product"),this._el},e}(c),U=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),F=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return U(e,t),e.prototype.render=function(){var t=g(b.ParagraphType.ObjectAliExpressProduct,this.getMediaId());return this._el=Object(i.buildProductSnippetElement)(t,"article_add__object_market_aliexpress_product"),this._el},e}(c),$=[{pattern:/\s-\s$/,substitution:" — "},{pattern:/^-\s$/,substitution:"— "},{pattern:/--\s$/,substitution:"— "},{pattern:/\s"$/,substitution:" “",noUndo:!0,cyrillic:!1},{pattern:/(\S)"$/,substitution:"$1”",noUndo:!0,cyrillic:!1},{pattern:/^"$/,substitution:"“",noUndo:!0,cyrillic:!1},{pattern:/\s"$/,substitution:" «",noUndo:!0,cyrillic:!0},{pattern:/(\S)"$/,substitution:"$1»",noUndo:!0,cyrillic:!0},{pattern:/^"$/,substitution:"«",noUndo:!0,cyrillic:!0},{pattern:"+/-",substitution:"±"},{pattern:"+-",substitution:"±"},{pattern:"^2",substitution:"²"},{pattern:"^3",substitution:"³"},{pattern:"<<",substitution:"«"},{pattern:">>",substitution:"»"},{pattern:"(c)",substitution:"©"},{pattern:"(C)",substitution:"©"},{pattern:"(r)",substitution:"®"},{pattern:"(R)",substitution:"®"},{pattern:"1/2",substitution:"½"},{pattern:"1/4",substitution:"¼"},{pattern:"3/4",substitution:"¾"},{pattern:"...",substitution:"…"},{pattern:"->",substitution:"→"},{pattern:"<-",substitution:"←"},{pattern:"!=",substitution:"≠"},{pattern:"<=",substitution:"≤"},{pattern:">=",substitution:"≥"}],Y=r("lkNA"),W=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),G=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return W(e,t),e.prototype.render=function(){var t=this;return this._el=Object(o.se)('<div class="article_object_embed"></div>'),this.setLoadingState(!0),Object(Y.loadScript)("https://platform.twitter.com/widgets.js",{onLoad:function(){var e;t.setLoadingState(!1),null===(e=window.twttr)||void 0===e||e.widgets.createTweet(t.getMediaId(),t._el,{align:"center",lang:window.vk&&0==window.vk.lang?"ru":"en",dnt:!0}).then((function(){}))},onError:function(){t.loadErrorHandler(t._el)}}),this._el},e}(c),X=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),K=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return X(e,t),e.prototype.render=function(){var t=this,e=this.getMediaId().split(";"),r=e[0],a=e[1];this._el=Object(o.se)('<div class="article_object_embed fb-post" data-href="https://www.facebook.com/'+r+"/posts/"+a+'/" data-width="552px"></div>'),this.setLoadingState(!0);var i=window.vk&&0==window.vk.lang?"ru_RU":"en_US";return Object(Y.loadScript)("https://connect.facebook.net/"+i+"/all.js#xfbml=1&amp;version=v2.8",{onLoad:function(){setTimeout((function(){var e;null===(e=window.FB)||void 0===e||e.XFBML.parse(t._objectEl,t.setLoadingState(!1))}),0)},onError:function(){t.loadErrorHandler(t._el)}}),this._el},e}(c),V=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),Q=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return V(e,t),e.prototype.render=function(){var t=this;return this._el=Object(o.se)('\n      <div class="article_object_embed article_object_embed_instagram">\n        <blockquote\n            class="article_embed_spacer instagram-media"\n            data-instgrm-permalink="https://instagram.com/p/'+this.getMediaId()+'"\n            data-instgrm-version="12"\n        ></blockquote>\n      <div>\n    '),this.setLoadingState(!0),Object(Y.loadScript)("https://www.instagram.com/embed.js",{onLoad:function(){setTimeout((function(){var e;null===(e=window.instgrm)||void 0===e||e.Embeds.process(),Object(w.addEvent)(window,"message",b.changeHeightInstagramEmbed),t.setLoadingState(!1)}),0)},onError:function(){t.loadErrorHandler(t._el)}}),this._el},e}(c),q=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),J=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return q(e,t),e.prototype.render=function(){var t=this;return this._el=Object(o.se)('<div class="article_object_embed"></div>'),setTimeout((function(){var e=t.getMediaId().split(";"),r=e[0],a=e[1],i=Object(o.domData)(t._objectEl,"uuid"),s="vk_post_"+t.getMediaId()+"_"+i;t._el.setAttribute("id",s),t.setLoadingState(!0),Object(Y.loadScript)("/js/api/openapi.js",{onLoad:function(){window.ajax.post("dev.php",{act:"a_get_post_hash",post:r+"_"+a},{onDone:function(e){var i;e&&(t.setLoadingState(!1),null===(i=window.VK)||void 0===i||i.Widgets.Post(""+s,r,a,e))},onFail:function(){return t.loadErrorHandler(t._el),!0}})}})}),0),this._el},e}(c),Z=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),tt=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return Z(e,t),e.prototype.render=function(){var t=this,e=this.getMediaId().split(";"),r=e[0],a=e[1];return this._el=Object(o.se)('<div class="article_object_embed"><blockquote class="telegram-post" data-telegram-post="'+r+"/"+a+'" data-width="100%" data-userpic="true"></div>'),this.setLoadingState(!0),Object(Y.loadScript)("https://telegram.org/js/telegram-widget.js?5",{onLoad:function(){t.setLoadingState(!1)},onError:function(){t.loadErrorHandler(t._el)}}),this._el},e}(c),et=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),rt=function(t){function e(e,r){return t.call(this,e,r,!0)||this}return et(e,t),e.prototype.render=function(){var t=this;this._el=Object(o.se)('\n      <div class="article_object_poll"></div>\n    ');var e=_(b.ParagraphType.ObjectPoll,this.getMediaId());if(e&&e.snippet)return this._el.appendChild(Object(o.se)(e.snippet)),this._el;var r=this.getMediaId().split("_")[1];return this.setLoadingState(!0),window.ajax.post("al_articles.php",{act:"get_poll_snippet",voting_id:r},{onDone:function(e){t.setLoadingState(!1),t._el.appendChild(Object(o.se)(e))}}),this._el},e.prototype.renderEditControlEl=function(){var t=_(b.ParagraphType.ObjectPoll,this.getMediaId());if(!t||!t.editable)return!1;var e=Object(o.se)('\n      <div class="article_ed__obj_edit_control">\n        <div class="article_ed__poll_object_btn">\n          <button class="article_ed__poll_object_edit">'+Object(s.getLang)("global_edit")+"</button>\n        </div>\n      </div>\n    ");return Object(o.geByClass1)("article_ed__poll_object_edit",e).addEventListener("click",this._editor.editObjectPoll.bind(this._editor,this)),e},e}(c),at={_saveChunk:function(t,e,r,a,i){window.ajax.post("al_articles.php",{act:"save_text_chunk",article_owner_id:t,hash:a,chunk_index:r,Article_text:JSON.stringify(e)},{onDone:function(t){i(t)},onFail:function(){return i(!0),!0}})},_saveFinally:function(t,e,r,a,i,o,n,c,l,h){window.ajax.post("al_articles.php",Object.assign({act:"save",article_owner_id:t,article_id:e,cover_photo_id:i,name:a,is_published:Number(r),chunks_count:c,Article_text:l?JSON.stringify(l):"",hash:n},o||{}),{onDone:h,onFail:function(t){return t.startsWith("locked ")&&h(t),t&&(Object(j.showFastBox)(Object(s.getLang)("global_error"),t),h(!0)),!0}})},save:function(t,e,r,a,i,o,n,c,l,h){var d=this,p=[],_=[],u=0;if(r.forEach((function(t){var e=JSON.stringify(t).length;(u+=e)>=c&&(p.push(_),u=e,_=[]),_.push(t)})),_.length&&p.push(_),p.length>1){var g=new window.CallHub((function(){d._saveFinally(t,e,a,i,o,l,n,p.length,!1,h)}),p.length);p.forEach((function(e,r){d._saveChunk(t,e,r,n,(function(t){t?Object(j.showFastBox)(Object(s.getLang)("global_error"),Object(s.getLang)("pages_articles_save_fail")):g.done()}))}))}else this._saveFinally(t,e,a,i,o,l,n,0,r,h)}};function it(t){var e=[];t.length>C.maxParagraphs&&e.push(Object(s.getLang)("pages_article_ed_limit_paragraphs").replace("{count}",t.length).replace("{limit}",C.maxParagraphs));var r=0,a=0;return t.forEach((function(t){var o=0;t.lines.forEach((function(t){t&&(r+=t.text.length,o+=t.text.length)})),Object(i.isObjectParagraph)(t)&&a++,o>C.maxSymbolsPerParagraph&&e.push(Object(s.getLang)("pages_article_ed_limit_symbols_per_par").replace("{count}",o).replace("{limit}",C.maxSymbolsPerParagraph))})),r>C.maxSymbols&&e.push(Object(s.getLang)("pages_article_ed_limit_symbols").replace("{count}",r).replace("{limit}",C.maxSymbols)),a>C.maxObjects&&e.push(Object(s.getLang)("pages_article_ed_limit_objects").replace("{count}",a).replace("{limit}",C.maxObjects)),e.length&&e.push(Object(s.getLang)("pages_article_ed_limit")),e.join("<br>")}var st=r("jE6c");function ot(t){return JSON.parse(JSON.stringify(t))}function nt(t,e,r){var a=[];return t.forEach((function(t,s){r&&!Object(i.isObjectParagraph)(t)&&Object(i.isParagraphEmpty)(t)&&0!=s&&t.type!=b.ParagraphType.Code||a.push(function(t,e){var r={type:b.ParagraphType.Text,lines:[]};for(var a in t)if(t.hasOwnProperty(a)){if(a.startsWith("_")&&("_uuid"!==a||!e))continue;var s=t[a];r[a]=Object(st.isObject)(s)||Array.isArray(s)?ot(s):s}return Object(i.isObjectParagraph)(t)&&t._object&&(r.mediaId=t._object.getMediaId()),t.sep&&(r.sep=1),r.type==b.ParagraphType.Text&&delete r.type,r.lines.forEach((function(t){if(t){if(void 0!==t.decorations){var e=!0;Object(st.each)(t.decorations,(function(r,a){0==a.length?delete t.decorations[r]:e=!1})),e&&delete t.decorations}t.brs&&0==t.brs.length&&delete t.brs}})),r}(t,e))})),ot(a)}function ct(t){return t.forEach((function(t){t.type=t.type||b.ParagraphType.Text,t.lines.forEach((function(t){t.brs=t.brs||[],t.decorations=t.decorations||{}}))})),t}var lt=r("lXE5"),ht=r("W9Tc"),dt=r("/PiP"),pt=r("98sY"),_t=r("k487"),ut=r("Xrg9");function gt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var r=[],a=!0,i=!1,s=void 0;try{for(var o,n=t[Symbol.iterator]();!(a=(o=n.next()).done)&&(r.push(o.value),!e||r.length!==e);a=!0);}catch(t){i=!0,s=t}finally{try{a||null==n.return||n.return()}finally{if(i)throw s}}return r}(t,e)||function(t,e){if(!t)return;if("string"==typeof t)return bt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return bt(t,e)}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function bt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,a=new Array(e);r<e;r++)a[r]=t[r];return a}var ft=65,vt=66,Ot=67,jt=73,yt=83,mt=89,Pt=90,Et=8,Ct=13,Tt=38,wt=40,It=46,xt=9,St=[{type:"strong",tag:"strong"},{type:"em",tag:"em"},{type:"strike",tag:"strike"},{type:"link",tag:"a"},{type:"code",tag:"code"}],kt=St.slice().reverse(),Lt={};Object(st.each)(St,(t,e)=>{Lt[e.tag]=e});var At={};Object(st.each)(St,(t,e)=>{At[e.type]=e});var Mt=1;function Dt(){return Mt+++"-"+Date.now()%1e6+"-"+Object(st.irand)(0,99999)}class Nt{constructor(t,e,r){var a,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this._id=Dt(),cur.lang=cur.lang||{},Object(O.extend)(cur.lang,s.lang),this._options=s,this._els={editor:Object(o.ge)(t),canvas:Object(o.se)('<div class="article_editor_canvas article_edit article" contenteditable="true"></div>')},this._els.editor.appendChild(this._els.canvas),this._els.editor.appendChild(this._photoUploadEl=Object(o.se)('<div class="article_photo_upload"></div>')),Object(o.addClass)(this._els.editor,"article_editor"),this._dirty=[],this._undos=[],this._redos=[],this._objects={},this._floatedObjects=[],a=s.limits,C=a;var n=r||[];if(s.postData){var c=s.postData.text||"";c=(c=c.replace(/❤/g,"❤️")).split("\n");var l=[];l.push(Object(i.buildParagraph)({type:b.ParagraphType.Header1,lines:[{text:""}]})),c.forEach(t=>{Object(O.trim)(t)&&l.push(Object(i.buildParagraph)({lines:[{text:Object(O.clean)(t)}]}))}),n=l.concat(n)}n&&0!=n.length||(n=[Object(i.buildParagraph)({type:this._options.noTitle?b.ParagraphType.Text:b.ParagraphType.Header1})]),(n=n.filter(t=>!1!==t)).forEach(t=>{t.lines.forEach(t=>{t.text=Object(i.replaceParagraphEntities)(t.text),t.brs&&Object(st.isObject)(t.brs)&&(t.brs=Object(i.convertBRsToArray)(t.brs))})}),s.needIndexCorrection&&Object(i.correctRealIndexes)(n,1),this.initParagraphs(n),this._updateTextPlaceholders(),this._initObjectDrag(),s.postData?Object(i.focusEl)(this._getParagraphElByIndex(0)):this._restoreLastCursor(),this.saveDraft(!1,!0),s.coverPhoto&&this.setCoverPhoto(s.coverPhoto,!1),(this._options.isPublished||this._options.wasPublished)&&this.setPublishName(e.name),this.updateWarnInfos(),this._publishNameCandidate=s.name||this._getName(),this._saveUndoState(),this.wasPublishedInCurrentSession=!1,this._openTime=Date.now(),stManager.add(jsc("web/audio.js"))}updateWarnInfos(){this.showWarningInfo(),this.showEditLockInfo(),this.showRevEditInfo()}_setEventListener(t,e,r){this._events=this._events||[],this._events.push({el:t,event:e,handler:r}),t.addEventListener(e,r)}setCoverPhoto(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._coverPhoto=t,this._options.isPublished||this.saveDraft(e)}getCoverPhoto(){return!1!==this._coverPhoto&&(this._coverPhoto?this._coverPhoto:void 0)}getFirstCoverPhotoFromParagraphs(){var t=!1;return this._ps.forEach(e=>{if(!t&&e.type==b.ParagraphType.ObjectPhoto){var r=e._object.getMediaId(0);t={id:r,data:_(b.ParagraphType.ObjectPhoto,r)}}}),t}getPublishName(){return this._publishName||this._publishNameCandidate||this._getName()}getTimeSpent(){return Math.round((Date.now()-this._openTime)/1e3)}setPublishName(t){this._publishName=t,this._options.isPublished||this.saveDraft(!0)}_updateTextPlaceholders(){if(!this._options.noTitle){this._els.placeholders||(this._els.placeholders=Object(o.se)('<div class="article_ed__text_placeholders"></div>'),this._els.placeholderTitle=Object(o.se)(`<h1>${this.getOptions().placeholderTitle}</h1>`),this._els.placeholderFirstParagraph=Object(o.se)(`<p>${this.getOptions().placeholderParagraph}</p>`),this._els.placeholders.appendChild(this._els.placeholderTitle),this._els.placeholders.appendChild(this._els.placeholderFirstParagraph),this._els.editor.appendChild(this._els.placeholders)),Object(i.isParagraphEmpty)(this._ps[0])?Object(o.removeClass)(this._els.placeholderTitle,"article_ed__text_placeholder_hidden"):Object(o.addClass)(this._els.placeholderTitle,"article_ed__text_placeholder_hidden");var t=this._ps[1],e=!!t&&t.sep,r=gt(this._getCurrentParagraphIndex(),1)[0];Object(i.isParagraphEmpty)(t)&&(!t||t.type!=b.ParagraphType.Code)&&r<2&&this._ps.length<=2&&!e?Object(o.removeClass)(this._els.placeholderFirstParagraph,"article_ed__text_placeholder_hidden"):Object(o.addClass)(this._els.placeholderFirstParagraph,"article_ed__text_placeholder_hidden")}}destroy(){this._els.editor.innerHTML="",Object(o.removeClass)(this._els.editor,"article_editor"),this._formatTooltip&&this._formatTooltip.destroy(),this._resizeTooltip&&this._resizeTooltip.destroy(),this._objectPickerTooltip&&this._objectPickerTooltip.destroy(),this._events=this._events||[],this._events.forEach(t=>{t.el.removeEventListener(t.event,t.handler)}),delete cur.docsCurFilter}getLimits(){return this._options.limits}getOptions(){return this._options}getWidth(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return Object(o.getSize)(this._els.canvas)[0]+(t?2*this._options.figureSideMargin:0)}getPhotoUploadOptions(){return this._options.photoUploadOptions}getPhotoUploadEl(){return this._photoUploadEl}removeObject(t){Object(st.each)(this._ps,(e,r)=>{if(r._object==t){var a=this._getParagraphElByIndex(e+1);return Object(i.focusEl)(a),Object(o.re)(this._getParagraphElByIndex(e)),this._setAllParagraphsDirty(),this._triggerInputEvent(),!1}})}_processPastedUrl(t,e){var r=this._getParagraph(t);r&&r.type==b.ParagraphType.Text&&setTimeout(()=>{this._processMatchingEmbeds(t,e)||(Object(o.re)(this._els.shareParseForm),Object(o.re)(this._els.shareIFrame),this._els.shareIFrame=this._els.editor.appendChild(Object(o.se)('<iframe class="editor__share_parse_iframe" name="editor__share_parse_iframe"></iframe>')),this._els.shareParseForm=this._els.editor.appendChild(Object(o.ce)("form",{action:"share.php?act=url_attachment",method:"post",target:"editor__share_parse_iframe"})),this._els.shareParseForm.appendChild(Object(o.ce)("input",{type:"hidden",name:"hash",value:this._options.shareHash})),this._els.shareParseForm.appendChild(Object(o.ce)("input",{type:"hidden",name:"url",value:e})),this._els.shareParseForm.appendChild(Object(o.ce)("input",{type:"hidden",name:"index",value:1})),this._els.shareParseForm.appendChild(Object(o.ce)("input",{type:"hidden",name:"force_media",value:1})),window.onUploadFail=()=>{},window.onUploadDone=e=>{if(e){var r=e[2];if(r){var a,s,o={};switch(e[0]){case"audio_playlist":a=b.ParagraphType.ObjectAudioPlaylist,o={accessHash:r.accessHash},e[1]=r.ownerId+"_"+r.id+(r.accessHash?"_"+r.accessHash:"");break;case"podcast":a=b.ParagraphType.ObjectPodcast,o={};break;case"poll":Object(ht.partConfigEnabled)("article_poll")&&(a=b.ParagraphType.ObjectPoll,o={editable:!1,snippet:r.snippet});break;case"doc":"gif"!=r.ext&&3!=r.type||(a=b.ParagraphType.ObjectGIF,(o={size:r.video_preview_size,video:r.video_preview,href:r.href||r.editable.href}).video||o.href||(a=!1));break;case"photo":a=b.ParagraphType.ObjectPhoto,o={size:Object(i.getPhotoSize)(r.editable.sizes),sizes:r.editable.sizes};break;case"video":a=b.ParagraphType.ObjectVideo,o={editable:r.editable,duration:r.editable.duration,platform:r.editable.platform}}if(a){var n=Object(i.hasSeparator)(this._ps[t]),c={mediaId:e[1],type:a,sep:n,fromExtPage:Object(st.intval)(r.from_ext_page)};p(a,c.mediaId,o),this._linkTooltip&&this._linkTooltip.hide(),c=Object(i.buildParagraph)(c),(s=this._getParagraph(t+1))&&s._object&&s._object._mediaId===c.mediaId||(this._getOrCreateParagraphObject(c),this._insertParagraphAt(t+1,c),this._els.canvas.normalize(),this._redraw(!0,!0),this._saveUndoState(),setTimeout(()=>{this.onObjectStateLoaded()},10))}}}},this._els.shareParseForm.submit())},0)}_processMatchingEmbeds(t,e){var r,a,s;if(r=e.match(/^https?:\/\/(?:www.)?twitter\.com\/(?:#!\/)?(?:\w+)\/status(?:es)?\/(\d+)$/))a=b.ParagraphType.ObjectTwitter,s=r[1];else if(r=e.match(/^https?:\/\/(?:www.)?instagram\.com\/p\/([a-zA-Z0-9_-]+)(?:\/embed)?(?:\/)?/))a=b.ParagraphType.ObjectInstagram,s=r[1];else if(r=e.match(/^https?:\/\/(?:www.)?facebook\.com\/(\w.+)\/posts\/(\d+)\/?$/))a=b.ParagraphType.ObjectFacebook,s=`${r[1]};${r[2]}`;else if(r=e.match(/^(?:https?:\/\/)?(?:[a-z0-9\_\.-]*\.)?(?:www.)?vk\.com\/(?:[a-z0-9\_\.-?]*w=)?wall(-?\d+)_(\d+)/))a=b.ParagraphType.ObjectVK,s=`${r[1]};${r[2]}`;else if(r=e.match(/^https?:\/\/(?:www.)?t\.me\/(\w.+)\/(\d+)/)){if(Object(o.ge)(`telegram-post-${r[1]}-${r[2]}`))return!1;a=b.ParagraphType.ObjectTelegram,s=`${r[1]};${r[2]}`}if(!a||!s)return!1;var n=Object(i.buildParagraph)({_uuid:Dt(),type:a,mediaId:s}),c=this._getParagraph(t+1);return c&&c._object&&c._object._mediaId===n.mediaId||(this._getOrCreateParagraphObject(n),this._insertParagraphAt(t+1,n),this._els.canvas.normalize(),this._redraw(!0,!0),this._saveUndoState()),!0}_handleObjectPaste(t){var e=(t.clipboardData||t.originalEvent.clipboardData).getData("text/plain");if(e){var r=gt(e.split(":"),2),a=r[0],i=r[1];if("uuid"==a&&i){var s=Object(o.domQuery1)(`[data-uuid="${i}"]`);if(s){var n=s.cloneNode(!0);n.setAttribute("data-force-update","1");var c=gt(this._getCurrentParagraphIndex(),1)[0];Object(o.domInsertAfter)(n,this._getParagraphElByIndex(c)),t.preventDefault(),this._setAllParagraphsDirty(),this._triggerInputEvent()}}}}_handleLinkPaste(t){var e=this,r=(t.clipboardData||t.originalEvent.clipboardData).items;for(var a in r)if(r.hasOwnProperty(a)){var s=r[a];"string"===s.kind&&function(){var t=gt(e._getCurrentParagraphIndex(),1)[0];s.getAsString(r=>{var a=r.replace(/(<([^>]+)>)/gi,""),s=Object(O.extractUrls)(a,!0);if(1===s.length){var n=s[0].url,c=e._getParagraphElByIndex(t);e._processPastedUrl(t,n),Object(i.traverseTree)(c,r=>{if(r.nodeType==Node.TEXT_NODE&&r.textContent.indexOf(n)>=0&&!Object(o.traverseParent)(r,t=>t.tagName&&"a"==t.tagName.toLowerCase(),3)){e._saveCursorMarker();var a=document.createRange();a.setStart(r,r.textContent.indexOf(n)),a.setEnd(r,r.textContent.indexOf(n)+n.length);var i=window.getSelection();i.removeAllRanges(),i.addRange(a),e._setParagraphDirty(t),document.execCommand("createLink",!1,n),e._restoreCursorFromMarker()}},!1)}})}()}}_handlePhotoPaste(t){var e=this;this._photoPasteUploadingProcess=!1;var r=(t.clipboardData||t.originalEvent.clipboardData).items;for(var a in r)if(r.hasOwnProperty(a)){var s=r[a];"file"===s.kind&&function(){e._photoPasteUploadingProcess=!0;var t=s.getAsFile(),r=new FileReader;r.onload=()=>{e._photoPasteUploadingProcess=!1;var a=gt(e._getCurrentParagraphIndex(),1)[0];a=a||0;var s,o=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPhoto});e._getOrCreateParagraphObject(o).setBLOB(t),Object(i.isParagraphEmpty)(e._ps[a])?(s=a,Object(i.hasSeparator)(e._ps[s])&&(o.sep=1),e._ps[s]=o):(s=a+1,e._insertParagraphAt(s,o)),e._redraw(!0,!0);var n=new Image;n.onload=()=>{e._focusParagraph(s+1),e._showObjectPicker()},n.src=r.result},r.readAsDataURL(t)}()}}_getCurrentSelectionState(){var t=gt(this._getCurrentParagraphIndex(),2),e=t[0],r=t[1];if(!1===e||!1===r)return!1;for(var a,s,n={decorations:{},header1:!1,header2:!0,header3:!0,header:!1,object:!1,quote:!0,list:!1,justHeaders:!0},c={},l=0,h=e;h<=r&&h<this._ps.length;h++){var d=Object(i.isObjectParagraph)(this._ps[h])?this._ps[h]._object.getCaptionEl():this._getParagraphElByIndex(h);if(void 0===a){var p=gt(Object(O.getCaretCharacterOffsetWithin)(d),2);a=p[0],s=p[1]}this._ps[h].lines.forEach(t=>{var e=t.decorations;St.forEach(r=>{var i=e[r.type];i&&!Object(st.isEmpty)(i)&&i.forEach(e=>{var i=[e[0]+l,e[1]+l];if("link"==r.type)a<i[1]&&s>i[0]&&(c[r.type]=1,n.decorations[r.type]=!0);else if(1==c[r.type]){s>i[1]||(s>=i[0]&&s<=i[1]?e[0]>0?c[r.type]=-1:(c[r.type]=2,n.decorations[r.type]=!0):c[r.type]=-1)}else if(!c[r.type]){var o=a>=i[0]&&a<=i[1];o&&(s>=i[0]&&s<=i[1])?(c[r.type]=2,n.decorations[r.type]=!0):o&&(t.text.length>i[1]?c[r.type]=-1:c[r.type]=1)}})}),l+=t.text.length})}for(var _=e;_<=r&&_<this._ps.length;_++)Object(i.isObjectParagraph)(this._ps[_])&&(n.captionFocused=n.captionFocused||this._ps[_]._object.isCaptionFocused(),n.object=!0),this._ps[_].type==b.ParagraphType.Header1&&(n.header1=!0),this._ps[_].type!=b.ParagraphType.Header2&&(n.header2=!1),this._ps[_].type!=b.ParagraphType.Header3&&(n.header3=!1),Object(O.inArray)(this._ps[_].type,[b.ParagraphType.Header1,b.ParagraphType.Header2,b.ParagraphType.Header3])?n.header=!0:n.justHeaders=!1,Object(O.inArray)(this._ps[_].type,[b.ParagraphType.Quote,b.ParagraphType.Quote2])||(n.quote=!1),Object(O.inArray)(this._ps[_].type,[b.ParagraphType.BulletList,b.ParagraphType.NumericList])&&(n.list=!0);var u=gt(Object(i.getRange)(),1)[0];return!(u&&u.startContainer&&Object(o.hasClass)(u.startContainer,"article_ed__noconteditable"))&&(n.multiline=e!=r,n)}_hideFormatTooltip(){this._formatTooltip&&this._formatTooltip.isShown()&&this._formatTooltip.hide()}_showFormatTooltip(){if(!this.isLocked()){clearTimeout(this._doShowFormatTooltipTO);try{var t=window.getSelection();if(t.focusNode&&(Object(o.hasClass)(t.focusNode,"article_set_link")||"input"==t.focusNode.nodeName.toLowerCase()))return;var e=!t.isCollapsed;this._doShowFormatTooltipTO=setTimeout(this._doShowFormatTooltip.bind(this,e),1)}catch(t){}}}_doShowFormatTooltip(t){if(!this._formatTooltip){var e,r=Object(o.se)(`\n        <div>\n          <div class="article_format_btns clear_fix"></div>\n          <div class="article_set_link"><input type="text" placeholder="${Object(s.getLang)("pages_articles_enter_link")}"/><div class="article_set_link_delete"></div></div>\n        </div>`);this._formatTooltip=new _t.default(this._els.editor,{cls:"article_format_tt",content:r,customShow:!0,offset:[0,-3],onShow:()=>{var t=this._getCurrentSelectionState(),e=[];if(!t||t.header1||t.object&&!t.captionFocused||(t.justHeaders||e.push(["strong","cur.articleEditor.setStrong()",!!t.decorations.strong]),t.quote||t.justHeaders||e.push(["em","cur.articleEditor.setEm()",!!t.decorations.em]),e.push(["strike","cur.articleEditor.setStrike()",!!t.decorations.strike]),t.decorations.link?e.push(["link","cur.articleEditor.clearLink()",t.decorations.link]):e.push(["link","cur.articleEditor.setLinkMode(true)",t.decorations.link]),t.object||t.header1||t.list||(e.push(["header1","cur.articleEditor.setHeader1("+Object(st.intval)(t.header2)+")",t.header2]),e.push(["header2","cur.articleEditor.setHeader2("+Object(st.intval)(t.header3)+")",t.header3]),e.push(["quote","cur.articleEditor.setQuote()",t.quote]))),0!=e.length){var a=Object(o.geByClass1)("article_format_btns",r);a.innerHTML="",e.forEach((t,e)=>{e>0&&Object(O.inArray)(t[0],["header1"])&&a.appendChild(Object(o.se)('<div class="article_format_divider"></div>'));var r=t[2]?"article_format_btn_active":"";a.appendChild(Object(o.se)(`<button class="article_format_btn ${r}" id="article_format_btn_${t[0]}" onclick="${t[1]}"></button>`))}),this.setLinkMode(!1)}else this._formatTooltip.hide()},getTargetBoundingBox:()=>{if(this._formatTooltip.linkMode)return e;var t=gt(Object(i.getRange)(),3),r=t[0],a=t[2];if(!a||!a.rangeCount)return e;var s=r.getBoundingClientRect();if(!s.left){var n=r.startContainer.nodeType==Node.ELEMENT_NODE?r.startContainer:Object(o.domPN)(r.startContainer),c=Object(o.getXY)(n),l=Object(o.getSize)(n);return e={top:c[1]+Object(lt.scrollGetY)(),left:c[0]+l[0]/2,width:s.width,height:s.height}}return e={top:s.top+Object(lt.scrollGetY)(),left:s.left,width:s.width,height:s.height}}}),this._formatTooltip.linkMode=!1;var a=Object(o.geByTag1)("input",r);a.addEventListener("keypress",t=>{if(t.keyCode==Ct)return this._setLinkToSelectedText(a.value.trim()),this._formatTooltip.hide(),Object(w.cancelEvent)(t)}),Object(o.geByClass1)("article_set_link_delete",r).addEventListener("click",t=>(this._setLinkToSelectedText(),Object(w.cancelEvent)(t)))}t?(this._linkTooltip&&this._linkTooltip.isShown()&&this._linkTooltip.hide(),this._formatTooltip.show(),this._formatTooltip.getOptions().onShow(),this._formatTooltip.updatePosition()):(this._formatTooltip.hide(),this._formatTooltip.linkMode&&this.setLinkMode(!1,!0))}_setLinkToSelectedText(t){if(t){if(!(t=(t=t.substr(0,1500)).replace(/%E2%80%AE/i,"").replace("&#8238;","").replace(/&#x202E;/i,"")).match("^https?://"))t=(Object(i.isVKUrl)(t)?"https":"http")+"://"+t;t=encodeURIComponent(t)}this.setLinkMode(!1,!1),this._restoreCursor(this._linkSelectedCursor),this._setAllParagraphsDirty(),t&&document.execCommand("createLink",!1,t),!browser.msie&&t||this._triggerInputEvent(),t?this._restoreCursor(this._linkSelectedCursor):this._restoreCursor(this._linkCursor)}clearLink(){this.setLinkMode(!1);var t=gt(Object(i.getRange)(),3),e=t[0],r=t[2],a=Object(o.domClosestByTag)("a",e.startContainer),s=Object(o.domClosestByTag)("a",e.endContainer)||a;a&&(this._saveCursorMarker(),r.setBaseAndExtent(a,0,s,Math.max(1,s.children.length))),this._setCurrentParagraphDirty(),document.execCommand("unlink",!1)}setLinkMode(t,e){var r;t&&(r=this._getCursor(),browser.msie||document.execCommand("superscript",!1,!0));var a=this._formatTooltip.getContent();if(this._formatTooltip.linkMode!=!!t)if(t){var i=Object(o.geByTag1)("input",a);i.value="",Object(o.addClass)(a,"article_editor_format_tt_set_link"),this._linkCursor=r,this._linkSelectedCursor=this._getCursor(),i.focus(),this._formatTooltip.linkMode=!0,this._formatTooltip.updatePosition()}else Object(o.setStyle)(a,{width:null}),Object(o.removeClass)(a,"article_editor_format_tt_set_link"),this._formatTooltip.linkMode=!1,e&&(this._saveCursorMarker(),this._setAllParagraphsDirty(),this._triggerInputEvent())}setHeader1(t){this._setHeader(b.ParagraphType.Header2,!t)}setHeader2(t){this._setHeader(b.ParagraphType.Header3,!t)}setQuote(){var t=this._getCursor(),e=gt(this._getCurrentParagraphIndex(),2),r=e[0],a=e[1];if(!1!==r){a||(a=r);for(var s=b.ParagraphType.Text,o=r;o<=a;o++)if(l(this._ps[o])){s=this._ps[o].type==b.ParagraphType.Quote?b.ParagraphType.Quote2:this._ps[o].type==b.ParagraphType.Quote2?b.ParagraphType.Text:b.ParagraphType.Quote;break}for(var n=r;n<=a;n++){var c=this._ps[n];l(c)&&(this._ps[n]=Object(i.buildParagraph)({type:s,lines:[c.lines[0]],sep:Object(i.hasSeparator)(this._ps[n])}),this._setParagraphDirty(n))}this._redraw(!0),this._updateTextPlaceholders(),this._restoreCursor(t),this._saveUndoState(),this.saveDraft()}function l(t){return!Object(i.isObjectParagraph)(t)&&!Object(i.isListParagraph)(t)}}_setHeader(t,e){var r=this._getCursor(),a=gt(this._getCurrentParagraphIndex(),2),s=a[0],o=a[1];if(!1!==s){o||(o=s);for(var n=s;n<=o;n++){c(this._ps[n])&&(this._ps[n].type=e?t:b.ParagraphType.Text,this._setParagraphDirty(n))}this._redraw(!0),this._updateTextPlaceholders(),this._restoreCursor(r),this._saveUndoState(),this.saveDraft()}function c(t){return!Object(i.isObjectParagraph)(t)&&!Object(i.isListParagraph)(t)}}setStrong(){this._setAllParagraphsDirty(),document.execCommand("bold"),browser.msie&&this._triggerInputEvent()}setEm(){this._setAllParagraphsDirty(),document.execCommand("italic"),browser.msie&&this._triggerInputEvent()}setStrike(){this._setCurrentParagraphDirty(),document.execCommand("strikeThrough"),browser.msie&&this._triggerInputEvent()}saveUndoStateAndDraft(){this._saveUndoState(),this.saveDraft()}_saveUndoStateDelayed(){clearTimeout(this._saveUndoDelayedTO),this._saveUndoDelayedTO=setTimeout(()=>{this._saveUndoState()},1e3)}_saveUndoState(){clearTimeout(this._saveUndoDelayedTO),this._saveUndoDelayedTO=!1;var t=nt(this._ps,!0);if(this._undoCurrentState){if(JSON.stringify(t)==JSON.stringify(this._undoCurrentState))return;this._undos.push({ps:this._undoCurrentState,cursor:this._lastCursor}),this._undos.length>100&&this._undos.shift()}this._undoCurrentState=t,this._undoCurrentStateCursor=this._getCursor(),this._redos=[],this._options.onUndoRedo&&this._options.onUndoRedo()}undo(){if(this._saveUndoDelayedTO&&this._saveUndoState(),this._undos.length){this._redos.push({ps:this._undoCurrentState,cursor:this._undoCurrentStateCursor});var t=this._undos.pop();this._ps=ct(t.ps),this._undoCurrentState=nt(this._ps,!0),this._undoCurrentStateCursor=t.cursor,this._redraw(!0),t.cursor&&this._restoreCursor(t.cursor),this._updateTextPlaceholders(),0==this._undos.length&&(this._undoable=!1)}this._options.onUndoRedo&&this._options.onUndoRedo()}redo(){if(0!=this._redos.length){this._undos.push({ps:this._undoCurrentState,cursor:this._undoCurrentStateCursor});var t=this._redos.pop();this._ps=ct(t.ps),this._undoCurrentState=nt(this._ps,!0),this._undoCurrentStateCursor=t.cursor,this._redraw(!0),t.cursor&&this._restoreCursor(t.cursor),this._updateTextPlaceholders(),this._options.onUndoRedo&&this._options.onUndoRedo()}}canUndo(){return this._undoable||this._undos.length>0}canRedo(){return this._redos.length>0}initParagraphs(t){t.forEach(t=>{t._preparedData&&((Object(i.isEmbedType)(t.type)?[t.mediaId]:t.mediaId.split(",")).forEach((e,r)=>{p(t.type,e,t._preparedData[r])}),delete t._preparedData)}),this._ps=ct(t),this._cleanParagraphsBRs(),this._ensureDummyParagraphs(),this._init()}_getParagraphFromHTML(t,e){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];function a(e,r){if(e.nodeType==Node.TEXT_NODE){var s=e.data.replace(/</g,"&lt;").replace(/>/g,"&gt;");r.text+="pre"==t?s:Object(i.cleanTextSpaces)(s)}else Object(i.isBR)(e)&&r.text.length>0&&r.brs.push(r.text.length);Object(st.each)(e.childNodes,(t,e)=>{var s=[r.text.length];a(e,r),s.push(r.text.length);var o,n=(e.tagName||"").toLowerCase();switch(e.style&&("bold"==e.style.fontWeight||parseInt(e.style.fontWeight)>400)&&(n="strong"),n){case"b":case"strong":o=At.strong;break;case"em":case"i":o=At.em;break;case"s":case"strike":case"del":o=At.strike;break;case"a":o=At.link;var c=e.getAttribute("href")||"",l=Object(i.decodeURL)(c);Object(i.isVKUrl)(c)&&(l=c.match(/app-?\d+_-?\d+/)?l.replace("%23","#"):l.replace("#","%23")),s.push(l);break;case"code":o=At.code;break;case"font":var h=e.getAttribute("face");("monospace"===h||"times"===h)&&(o=At.code)}o&&(r.decorations[o.type]=r.decorations[o.type]||[],s[0]<s[1]&&r.decorations[o.type].push(s),r.decorations[o.type]=Object(i.mergeRanges)(r.decorations[o.type]))})}var s=document.createElement("div");s.innerHTML=e;var n,c=[],l={};if("ol"==t||"ul"==t){switch(t){case"ol":n=b.ParagraphType.NumericList;break;case"ul":n=b.ParagraphType.BulletList}for(var h=0,d=s.children.length;h<d;h++){var p={text:"",decorations:{},brs:[]};a(s.children[h],p),p.brs=Object(i.cleanBRs)(p.brs),c.push(p)}}else{switch(t){case"h1":n=b.ParagraphType.Header1;break;case"h2":case"header":n=b.ParagraphType.Header2;break;case"h3":case"h4":n=b.ParagraphType.Header3;break;case"blockquote":n=b.ParagraphType.Quote;break;case"cite":n=b.ParagraphType.Quote2;break;case"pre":n=b.ParagraphType.Code;break;default:n=b.ParagraphType.Text}var _=s.firstElementChild;if(Object(i.isObjectParagraphEl)(_)){var u=Object(o.domData)(_,"type"),g=Object(o.domData)(_,"media-id");u&&g&&(s=Object(o.geByTag1)("figure",_),n=u,l.mediaId=g)}var f={text:"",decorations:{},brs:[]};a(s,f),f.brs=Object(i.cleanBRs)(f.brs,f.text.length),c.push(f),n==b.ParagraphType.Code&&delete f.decorations.code,r||n!=b.ParagraphType.Text||"```"!=f.text||0!=f.brs.length||(f.text="",n=b.ParagraphType.Code),Object(i.isHeaderParagraph)(n)||(0===f.text.indexOf("1. ")?(n=b.ParagraphType.NumericList,this._removeParagraphLineTextPart(f,0,"1. ".length)):0===f.text.indexOf("* ")&&(n=b.ParagraphType.BulletList,this._removeParagraphLineTextPart(f,0,"* ".length))),f.brs=f.brs.filter(t=>t>0)}return l.lines=c,l.type=n,Object(i.buildParagraph)(l)}_removeParagraphLineTextPart(t,e,r){t.text=t.text.substring(0,e)+t.text.substring(r);for(var a=r-e,i=0,s=t.brs.length;i<s;i++){var o=t.brs[i];o>e&&o<r?t.brs[i]=void 0:t.brs[i]>e&&t.brs[i]>=r&&(t.brs[i]-=a)}t.brs=t.brs.filter(t=>void 0!==t),Object(st.each)(t.decorations,(i,s)=>{s.forEach(t=>{t[0]<=e&&t[1]<=e||(t[0]<=e&&t[1]<=r?t[1]=e:t[0]>=e&&t[1]<=r?t[0]=t[1]=void 0:t[0]>=e&&t[1]>r?(t[0]=e,t[1]-=a):(t[0]-=a,t[1]-=a))}),t.decorations[i]=t.decorations[i].filter(t=>void 0!==t[0])})}_renderObjectParagraph(t,e){var r=this._getOrCreateParagraphObject(t),a=r.el();r.onRender&&r.onRender();var s=0;return Object(st.isString)(e)&&(e=[e]),t.type==b.ParagraphType.ObjectPhoto?(s=r.getImageIndex(),r.setCaptionElHtml(e[s]||"")):r.setCaptionElHtml(e[0]||""),Object(o.domData)(a,"paragraph-lines",JSON.stringify(t.lines)),Object(o.domData)(a,"uuid",t._uuid),Object(o.domData)(a,"type",t.type),Object(o.domData)(a,"media-id",t._object.getMediaId()),Object(o.domData)(a,"mode",parseInt(t.mode)||0),Object(o.addClass)(a,i.ArticleEditorParagraphClass),a}_renderParagraphLines(t,e){if(!t.lines)return["",""];var r="",a="",s="",o=parseInt(t.type);switch(o){case b.ParagraphType.NumericList:r="ol",a="li";break;case b.ParagraphType.BulletList:r="ul",a="li";break;case b.ParagraphType.Header1:a="h1";break;case b.ParagraphType.Header2:a="h2";break;case b.ParagraphType.Header3:a="h3";break;case b.ParagraphType.Quote:a="blockquote";break;case b.ParagraphType.Quote2:a="cite";break;case b.ParagraphType.Code:a="pre";break;default:r="p"}var n=[];return t.lines.forEach(r=>{if(r){var c=r.text,l=r.decorations,h=[];Object(st.each)(St,(t,e)=>{if(!Object(i.isHeaderParagraph)(o)&&o!=b.ParagraphType.Code||"code"!=e.type){var r=l[e.type];if(r)for(var a=function(t,a){var i=r[a];(h[i[0]]=h[i[0]]||{open:{},close:{}}).open[e.type]=u(i);var s=h[i[1]]=h[i[1]]||{open:{},close:{}},o=function(t,e){for(var r=[];t>0;){var a=h[--t];if(a)for(var i in a.open)if(a.open.hasOwnProperty(i)){if(i==e)return[];r.push(i)}}return r}(i[1],e.type);o.forEach(t=>{s.close[t.type]=!0}),s.close[e.type]=!0,o.forEach(t=>{s.open[t.type]=u(i)})},s=0,n=r.length;s<n;s++)a(0,s)}});var d=0,p=[];h.forEach((e,a)=>{if(e){var s=!1,o=e.close.link&&1==Object.keys(e.close).length;a>0&&(s=Object(i.prepareLineText)(c,d,a,r.brs,t.type==b.ParagraphType.Code),o||p.push(s));var n=0;o&&(s&&s.endsWith("<br/>")&&(n++,s=s.replace(/<br\/>$/,"")),s&&s.endsWith("<br/>")&&(n++,s=s.replace(/<br\/>$/,"")),!1!==s&&p.push(s)),Object(st.each)(kt,(t,r)=>{void 0!==e.close[r.type]&&p.push(`</${r.tag}>`)}),p.push("<br/>".repeat(n)),Object(st.each)(St,(t,r)=>{var a=e.open[r.type];void 0!==e.open[r.type]&&(!0===a?p.push(`<${r.tag}>`):p.push(`<${r.tag} href="${Object(O.clean)(a)}">`))}),d=a}}),p.push(Object(i.prepareLineText)(c,d,void 0,r.brs,t.type==b.ParagraphType.Code));var _="";a&&(_+=`<${a}${s=s?" "+s:""}>`),Object(O.inArray)(o,[b.ParagraphType.Quote,b.ParagraphType.Quote2])&&(_+="<p>"),_+=p.join("")||(e?"":"<br/>"),Object(O.inArray)(o,[b.ParagraphType.Quote,b.ParagraphType.Quote2])&&(_+="</p>"),a&&(_+=`</${a}>`),n.push(_)}function u(t){return t[2]||!0}}),[r,n]}_renderParagraph(t){var e,r=Object(i.isObjectParagraph)(t),a=gt(this._renderParagraphLines(t,r),2),s=a[0],n=a[1];if(r)e=this._renderObjectParagraph(t,n);else{var c=n.join("");e=s?Object(o.se)(`<${s}>${c}</${s}>`):Object(o.se)(c)}return Object(i.hasSeparator)(t)?Object(o.domData)(e,"sep",Object(i.genSepatorId)()):Object(o.domData)(e,"sep",null),Object(o.addClass)(e,i.ArticleEditorParagraphClass),Object(o.addClass)(e,"article_paragraph"),e}_getParagraphElByIndex(t){return!1===t?null:this._els.canvas.childNodes[t]||null}getObjectParagraphIndex(t){for(var e=0;e<this._ps.length;e++)if(this._ps[e]._uuid===t._uuid)return e;return-1}_getParagraph(t){return t<this._ps.length?this._ps[t]:null}_decorateParagraphEls(){for(var t=0,e=this._ps.length;t<e;t++){var r=t>0&&this._ps[t-1],a=this._ps[t],i=t+1<e&&this._ps[t+1],s=!1,n=!1,c=!1;r&&a.type==r.type||(s=!0),i&&a.type==i.type||(n=!0),(b.ResizableObjectTypes.includes(+i.type)||i.sep)&&(c=!0);var l=this._getParagraphElByIndex(t);Object(o.toggleClass)(l,"article_decoration_first",s),Object(o.toggleClass)(l,"article_decoration_last",n),Object(o.toggleClass)(l,"article_decoration_before",c)}}redraw(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._redraw(t,!0)}_redraw(t,e){var r=this._getCursor();t?(this._els.canvas.innerHTML="",this._ps.forEach(t=>{this._els.canvas.appendChild(this._renderParagraph(t))})):this._dirty.forEach(t=>{if(!(t>=this._ps.length)){var e=this._getParagraphElByIndex(t);if(e){var r=this._renderParagraph(this._ps[t]);e?r.outerHTML!=e.outerHTML&&Object(o.domReplaceEl)(e,r):this._els.canvas.appendChild(r)}}}),e&&this._restoreCursor(r),this._decorateParagraphEls(),this._dirty=[]}_getContainingParagraphEl(t){for(;t&&t.parentNode!=this._els.canvas;)t=t.parentNode;var e=Object(i.getElementIndex)(t);return[t,e,this._getParagraph(e)]}_getCurrentParagraphIndex(){var t=window.getSelection();if(t.rangeCount){var e=t.getRangeAt(0);if(e.startContainer==this._els.canvas)return[e.startOffset,e.endOffset];var r=gt(this._getContainingParagraphEl(e.startContainer),2)[1],a=e.endContainer;if(0===e.endOffset&&(this._isParagraphEl(a)||this._isParagraphEl(Object(o.domPN)(a))&&0==Object(i.childNodeIndex)(a))){var s=gt(this._getContainingParagraphEl(a),1)[0];a=Object(o.domPS)(s)||s}var n=gt(this._getContainingParagraphEl(a),2)[1];return[r,Math.max(r,n)]}return[0,!1]}_saveCursorMarker(){if(!this._markerCursorSet){var t=gt(Object(i.getRange)(),2),e=t[0],r=t[1];if(!e)return[0,0];var a=e.startContainer,s=e.startOffset,o=e.endContainer,n=e.endOffset;if(a!=this._els.canvas){var c=this._getContainingParagraphEl(a)[1];l(a,s,i.CURSOR_MARKER_START),r||(this._getContainingParagraphEl(o)[1]==c&&o.textContent.includes(i.CURSOR_MARKER_START)&&(n+=1),l(o,n,i.CURSOR_MARKER_END)),this._markerCursorSet=!0}}function l(t,e,r){if(t.nodeType==Node.TEXT_NODE){var a=t.textContent;t.textContent=a.substring(0,e)+r+a.substring(e)}else{var i=document.createTextNode(r);t.insertBefore(i,t.childNodes[e])}}}_restoreCursorFromMarker(){if(this._markerCursorSet){var t,e,r,a=(t,e,r)=>function e(a){if(a.nodeType==Node.TEXT_NODE){var s=a.textContent.indexOf(t);if(s>=0){a.textContent=a.textContent.split(t).join("");var o=a.parentElement;return-1!=o.innerHTML.search(/\s$/)&&(o.innerHTML=o.innerHTML.trimRight()+i.NBSP,r&&r[0]==a&&(r[0]=o.lastChild),a=o.lastChild),o.innerHTML||((a=o).innerHTML="<br/>",s=0),[a,s]}}else for(var n=0,c=a.childNodes.length;n<c;n++){var l;if(l=e(a.childNodes[n]))return l}}(e);for(r=0;r<this._els.canvas.children.length&&!(t=a(i.CURSOR_MARKER_START,this._els.canvas.children[r]));r++);for(;r<this._els.canvas.children.length&&!(e=a(i.CURSOR_MARKER_END,this._els.canvas.children[r],t));r++);if(t){var s=document.createRange();t[0].nodeType==Node.TEXT_NODE&&(t[1]=Math.min(t[1],t[0].textContent.length)),s.setStart(t[0],t[1]),e&&(e[0].nodeType==Node.TEXT_NODE&&(e[1]=Math.min(e[1],e[0].textContent.length)),s.setEnd(e[0],e[1])),window.getSelection().setBaseAndExtent(s.startContainer,s.startOffset,s.endContainer,s.endOffset)}var o=t=>{this._ps.forEach(e=>{e.lines.forEach(e=>{var r=e.text.indexOf(t);if(r>=0){e.text=e.text.replace(t,"");for(var a=0,i=0;i<e.brs.length;i++)e.brs[i]>r&&(a=1),e.brs[i]-=a;Object(st.each)(St,(t,a)=>{var i=e.decorations[a.type];if(i)for(var s=0,o=i.length;s<o;s++){var n=i[s];n[0]>r&&(n[0]-=1),n[1]>r&&(n[1]-=1)}})}})})};o(i.CURSOR_MARKER_START),o(i.CURSOR_MARKER_END),this._markerCursorSet=!1}}_setAllParagraphsDirty(){this._dirty=[];for(var t=this._els.canvas.children.length,e=0;e<t;e++)this._dirty.push(e);this._ps=[]}_setCurrentParagraphDirty(){var t=gt(this._getCurrentParagraphIndex(),2),e=t[0],r=t[1];this._setParagraphDirty(e,r)}setParagraphDirty(t,e){this._setParagraphDirty(t,e)}_setParagraphDirty(t,e){if(void 0===t||t<0)throw new Error("Invalid paragraph index");e=e||t;for(var r=t;r<=e;r++)Object(O.inArray)(r,this._dirty)||this._dirty.push(r)}_expandDoubleBRs(){function t(t,e,r){var a=t.lines[0];void 0===r&&(r=a.text.length);var s=[];return a.brs.forEach(t=>{t<r&&t>e&&s.push(t-e)}),Object(i.buildParagraph)({type:t.type,lines:[{text:a.text.substr(e,r-e),decorations:Object(i.decorationsSlice)(a.decorations,e,r),brs:s}]})}for(var e=!1,r=0,a=this._ps.length;r<a;r++){var s=this._ps[r];if(s.lines.length>1)s.lines.forEach(i.cleanLineBRs);else{var o=s.lines[0];if(!o||!o.brs.length)continue;for(var n=o.brs,c=[],l=0,h=0,d=n.length;h<d;h++)if(l!=n[h]&&h>0&&n[h-1]==n[h]){var p=t(s,l,n[h]);Object(i.isParagraphEmpty)(p)||c.push(p),l=n[h]}c.push(t(s,l)),c.length>1&&(Array.prototype.splice.apply(this._ps,[r,1].concat(c)),r=r+c.length-1,e=!0)}}return e}_processAlienPhotos(){var t=this;if(!this._photoPasteUploadingProcess)for(var e,r=Array.prototype.slice.call(this._els.canvas.children);e=r.shift();)if(!Object(i.isObjectParagraphEl)(e)||!this._isTrackedObjectEl(e))for(var a=Array.prototype.slice.call(Object(o.geByTag)("img",e)),s=void 0,n=function(){if(!s.src||!Object(o.domPN)(e)||!Object(o.isVisible)(s))return"continue";var r=Object(o.traverseParent)(s,e=>e==t._els.canvas||"FIGURE"==e.tagName,10),a=!(!r||r==t._els.canvas)&&Object(o.geByTag1)("figcaption",r),n=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPhoto}),c=t._renderObjectParagraph(n,a?a.innerHTML:"");Object(i.justCursorInString)(e.textContent)?(Object(o.domReplaceEl)(e,c),Object(o.re)(s),Object(o.domInsertAfter)(Object(o.se)(`<p>${i.CURSOR_MARKER_START}</p>`),c)):(Object(o.domInsertAfter)(c,Object(o.domPN)(s)),Object(o.re)(a),Object(o.re)(s)),Object(o.traverseParent)(c,e=>{if(e==t._els.canvas)return!0;Object(o.removeClass)(e,i.ArticleEditorParagraphClass)}),Object(i.queuePhotoProcess)(s.src,(e,r,a)=>{e?(Object(o.re)(c),t._forgetObject(n._uuid),t._setAllParagraphsDirty(),t._triggerInputEvent(),a()):t._getOrCreateParagraphObject(n).setBLOB(r,a)})};s=a.shift();)n()}_flattenAlienParagraphs(){var t=this;if(this._fromPasteEvent){for(var e,r=Array.prototype.slice.call(this._els.canvas.children),a=this._fromPasteEvent,s=this._pasteCurrentIndex,n=gt(this._getCurrentParagraphIndex(),1)[0],c=-1,l=function(){if(c++,a&&!Object(O.trim)(e.textContent)&&c>s&&c<=n)return Object(o.re)(e),"continue";var r=e;Object(i.isQuoteEl)(e)&&!Object(i.isAlienParagraphEl)(e)&&(r=e.firstChild);var l=!1;(function t(a){if(a&&a.nodeType!=Node.TEXT_NODE&&!Object(i.isBR)(a))if(Object(i.hasBlockElements)(a))if(this._isTrackedObjectEl(a))a!=r&&(Object(o.domInsertBefore)(a,e),l=!0);else for(var s,n=Array.prototype.slice.call(a.childNodes);s=n.shift();)t.call(this,s);else a!=r&&(Object(O.trim)(a.innerHTML)&&Object(o.domInsertBefore)(a,e),l=!0)}).call(t,r,!0),l&&Object(o.re)(e)};e=r.shift();)l();this._setAllParagraphsDirty()}}_correctCaptionSelection(){var t=gt(Object(i.getRange)(),3),e=t[0],r=t[1],a=t[2];if(e&&!r){var s=Object(o.traverseParent)(e.startContainer,t=>"FIGCAPTION"==t.tagName,5);if(s&&e.endContainer!=e.startContainer&&e.endContainer.nodeType==Node.ELEMENT_NODE&&Object(i.isParagraphEl)(e.endContainer)&&0==e.endOffset&&0==e.startOffset){var n=Object(o.geByClass1)("article_ed__figcaption_edit",s),c=e.cloneRange();c.selectNodeContents(n),a.removeAllRanges(),a.addRange(c)}}}cancelSaveDraft(){clearTimeout(this._draftSaveTO)}saveDraft(t,e,r){if(!this.isLocked()){clearTimeout(this._draftSaveTO);var a=JSON.stringify({paragraphs:nt(this._ps)});e?this._lastSavedDraft=a:this._lastSavedDraft!=a||t?(this._options.onDraftNotSaved&&this._options.onDraftNotSaved(),this._draftSaveTO=setTimeout(()=>{if(this._lastSavedDraft=a,0!=this._ps.length){var t=it(this._ps);t?this._options.onDraftNotSaved&&this._options.onDraftNotSaved(t):this.save(!1,(t,e,r)=>{this._initDraftSave=!0,this._options.onDraftSaved&&this._options.onDraftSaved(t,e,r)})}},r?0:1e3*this._options.draftSaveDelay)):!e&&this._initDraftSave&&this._options.onDraftSaved&&this._options.onDraftSaved(!1,this.getArticleId())}}_getName(){if(this._publishName)return this._publishName;var t=nt(this._ps),e=t.length?t[0].lines[0].text:"";return Object(i.generateLatinizedName)(e,this._options.maxNameLength)}getTitle(){var t=this._ps[0];return t?t.lines[0].text:""}isLimitsExceeded(){return!!it(this._ps)}save(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=nt(this._ps,!1,!0);t&&Object(i.correctRealIndexes)(a,-1);var s=this._getName(),o=this.getCoverPhoto();void 0===o&&t&&(o=this.getFirstCoverPhotoFromParagraphs()),this.getOptions().postData&&(r.from_post_convert=1),this.getOptions().isEducationArticle&&(r.education_course_id=this.getOptions().educationCourseId,r.education_step_id=this.getOptions().educationStepId),r.session_duration=this.getTimeSpent(),at.save(this.getArticleOwnerId(),this.getArticleId(),a,t,s,o?o.id:"",this._getSaveDraftHash(),this._options.limits.maxSymbolsPerChunk,r,(r,a,i,o,n,c)=>{if(Object(st.isString)(r)&&r.startsWith("locked "))return this.getOptions().editLockMessage=r.slice("locked ".length),this.showEditLockInfo(),void(e&&e(!0));r||(a&&(this._options.articleId=a),"al_articles.php"!=nav.objLoc[0]||nav.objLoc.article_id||nav.setLoc(Object(O.extend)({},nav.objLoc,{article_id:this.getArticleOwnerId()+"_"+this.getArticleId()})),this._publishNameCandidate=s,t&&(this._options.isPublished=!0,this.wasPublishedInCurrentSession=!0),this._options.monetizationAllowed=c,this._replaceVideos(n)),e&&e(r,a,i,o)})}_replaceVideos(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=!1;try{t.forEach(t=>{var r=gt(t,4),a=r[0],i=r[1],s=r[2],o=r[3];this._ps.forEach((t,r)=>{if(t.type==b.ParagraphType.ObjectVideo){var n=gt(t.mediaId.split("_"),3),c=n[0],l=n[1];n[2]||c!=a||l!=i||(t.mediaId=`${s}_${o}`,this._setParagraphDirty(r),e=!0)}})})}catch(t){}e&&this._redrawModel()}focus(){this._restoreLastCursor()}focusLastParagraph(){Object(i.focusEl)(this._getParagraphElByIndex(this._ps.length-1))}getArticleId(){return this._options.articleId}getArticleOwnerId(){return this._options.articleOwnerId}_getSaveDraftHash(){return this._options.saveDraftHash}_expandBlockquoteParagraphs(t){for(var e,r=Array.prototype.slice.call(this._els.canvas.children);e=r.shift();)if(Object(i.isQuoteEl)(e)){var a=e.tagName,s=Array.prototype.slice.call(e.children),n=s[0];if(1==s.length&&n&&n.tagName&&Object(O.inArray)(n.tagName,["H1","H2","H3"])){Object(o.domReplaceEl)(e,n);continue}if(s.shift(),s.length)for(var c=void 0;c=s.shift();){if(this._saveCursorMarker(),t)Object(o.domInsertAfter)(c,e);else{var l=Object(o.se)(`<${a}></${a}>`);l.appendChild(c),Object(o.domInsertAfter)(l,e)}this._restoreCursorFromMarker()}}}_ensureDummyParagraphs(){if(this._els.canvas){var t=this._els.canvas.lastChild;if(t)if(Object(O.trim)(t.innerHTML)&&"<br>"!=t.innerHTML&&"&nbsp;"!=t.innerHTML||"H1"==t.tagName){var e=Object(i.buildParagraph)({});this._els.canvas.appendChild(this._renderParagraph(e)),this._ps.push(e),this._updateTextPlaceholders()}}}_ensureAtLeastOneParagraph(){0==this._ps.length&&(this._ps=[Object(i.buildParagraph)({type:b.ParagraphType.Text})])}_ensureTitleParagraph(){if(!this._options.noTitle){var t=this._ps[0];Object(i.isObjectParagraph)(t)&&(this._ps[0]=Object(i.buildParagraph)({type:b.ParagraphType.Header1})),t.type=b.ParagraphType.Header1,t.lines[0].decorations={},t.lines[0].brs=[],delete t.sep}this._ps.forEach((t,e)=>{(this._options.noTitle||0!=e)&&(1==e&&t.type==b.ParagraphType.Header1&&(t.type=b.ParagraphType.Text),t.type==b.ParagraphType.Header1&&(t.type=b.ParagraphType.Header2))})}_insertParagraphAt(t,e){this._ps.splice(t,0,e)}_deleteParagraphFrom(t){this._ps.splice(t,1)}_focusParagraph(t,e){Object(i.focusEl)(this._getParagraphElByIndex(t),e)}_init(){this._correctEmptyParagraphAfterFloatObjects(),this._redraw(!0),this._initEvents(),this._initLinksHrefTooltip(),this._initResizeTooltip()}_redrawModel(){this._saveCursorMarker(),this._redraw(!0),this._restoreCursor()}addObjectMarketProduct(){var t=gt(this._getCurrentParagraphIndex(),1)[0];Object(dt.showAttachProductBox)(null,e=>{Object(i.isParagraphEmpty)(this._ps[t])||this._insertParagraphAt(t,Object(i.buildParagraph)());var r={type:b.ParagraphType.ObjectMarketItem,mediaId:e.id};"link"===e.type&&(r.type=b.ParagraphType.ObjectAliExpressProduct,r.mediaId=e.url);var a=Object(i.buildParagraph)(r);"link"===e.type?u(r.type,r.mediaId,{product:e}):p(r.type,r.mediaId,{product:e}),this._getOrCreateParagraphObject(a),this._ps[t]=a,curBox().hide(),this._redrawModel();var s=this._getParagraphElByIndex(t);Object(i.focusEl)(s),this.saveUndoStateAndDraft(),t++})}addObjectAudio(){var t=gt(this._getCurrentParagraphIndex(),1)[0];this.getArticleOwnerId()<0&&(cur.audioAttachOriginalOwnerId=this.getArticleOwnerId(),cur.audioAttachSwitchOwnerId=vk.id),AudioPage.showAttachBox(this.getArticleOwnerId(),{canPlaylistAttach:!0,onAudioChoose:(e,r,a,s)=>{Object(i.isParagraphEmpty)(this._ps[t])||this._insertParagraphAt(t,Object(i.buildParagraph)());var o=Object(i.buildParagraph)({type:b.ParagraphType.ObjectAudio,mediaId:a.fullId});p(b.ParagraphType.ObjectAudio,a.fullId,{audio:s}),this._getOrCreateParagraphObject(o),this._ps[t]=o,e.shiftKey||curBox().hide(),this._redrawModel();var n=this._getParagraphElByIndex(t);Object(i.focusEl)(n),this.saveUndoStateAndDraft(),t++},onPlaylistChoose:(e,r)=>{var a=r.getOwnerId()+"_"+r.getPlaylistId()+(r.getAccessHash()?"_"+r.getAccessHash():""),s=Object(i.buildParagraph)({type:b.ParagraphType.ObjectAudioPlaylist,mediaId:a});p(b.ParagraphType.ObjectAudioPlaylist,a,{accessHash:r.getAccessHash()}),this._getOrCreateParagraphObject(s),this._ps[t]=s,curBox().hide(),this._redrawModel();var o=this._getParagraphElByIndex(t);Object(i.focusEl)(o),this.saveUndoStateAndDraft()}})}closeAllCarouselEditors(){this._ps.forEach(t=>{t.type==b.ParagraphType.ObjectPhoto&&t._object.cancelCarouselEditor&&t._object.cancelCarouselEditor()})}setMediaUploadMode(t){this._isUploading=!!t,Object(o.toggleClass)(this._els.editor,"article_ed__uploading",this._isUploading)}isMediaUploadMode(){return this._isUploading}addObjectVideo(){var t=gt(this._getCurrentParagraphIndex(),1)[0],e=this._getParagraph(t),r=Object(i.hasSeparator)(e);delete e.sep,Object(j.showBox)("al_video.php",{act:"a_choose_video_box",from:"article",to_id:this.getArticleOwnerId(),blockPersonal:1}),cur.chooseMedia=(e,a,s,o,n)=>{var c=Object(i.buildParagraph)({type:b.ParagraphType.ObjectVideo,mediaId:a,sep:r});r=!1,p(b.ParagraphType.ObjectVideo,a,s),this._getOrCreateParagraphObject(c),0==o?this._ps[t]=c:this._ps.splice(t+o,0,c),this._redrawModel(),this._saveUndoState();var l=this._getParagraphElByIndex(t);Object(i.focusEl)(l),!n&&curBox()&&curBox().hide(),this.saveDraft()}}addObjectDoc(){var t=gt(this._getCurrentParagraphIndex(),1)[0],e=this._getParagraph(t),r=Object(i.hasSeparator)(e);delete e.sep,cur.docsCurFilter="gif";var a=Object(j.showBox)("docs.php",{act:"a_choose_doc_box",from:"article",ext_filter:"gif",to_id:this.getArticleOwnerId()},{stat:["docs.css"]});cur.chooseMedia=(e,s,o)=>{a.hide();var n=Object(i.buildParagraph)({type:b.ParagraphType.ObjectGIF,mediaId:s,sep:r});r=!1,p(b.ParagraphType.ObjectGIF,s,{video:o.video_preview,size:o.video_preview_size,href:o.href}),this._getOrCreateParagraphObject(n),this._insertParagraphAt(t,n),this._redrawModel(),this._saveUndoState(),this.saveDraft(),this._focusParagraph(t),this._updateTextPlaceholders()},cur.showMediaProgress=()=>{}}addObjectPhoto(){var t,e,r=gt(this._getCurrentParagraphIndex(),1)[0],a=this._getParagraph(r)||Object(i.buildParagraph)(),s=Object(j.showBox)("al_photos.php",{to_id:this.getArticleOwnerId(),act:"choose_photo",max_files:200,article:1},{cache:1,stat:[jsc("web/photos.js"),"photos.css",jsc("web/upload.js")],dark:1});cur.onMediaUploadStarted=()=>{var e=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPhoto}),a=this._renderObjectParagraph(e,""),s=this._getParagraphElByIndex(r);Object(o.domInsertBefore)(a,s),Object(i.focusEl)(s),t=a,this.setMediaUploadMode(!0)},cur.onMediaUploadFail=()=>{delete cur.onMediaUploadStarted,t&&Object(o.re)(t),this.setMediaUploadMode(!1)};var n=-1;cur.chooseMedia=(c,l,h,d)=>{void 0===d?n++:n=Object(st.intval)(d),delete cur.onMediaUploadStarted,this.setMediaUploadMode(!1),t&&Object(o.re)(t);var _=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPhoto,mediaId:l,sep:a.sep});return p(b.ParagraphType.ObjectPhoto,l,{size:Object(i.getPhotoSize)(h.editable.sizes),sizes:h.editable.sizes}),this._getOrCreateParagraphObject(_),n?this._ps.splice(r+n,0,_):this._ps[r]=_,void 0===d&&s.hide(),clearTimeout(e),e=setTimeout(()=>{this._redrawModel(),this._focusParagraph(r+n),this._updateTextPlaceholders(),this.saveUndoStateAndDraft()},10),!1},cur.showMediaProgress=()=>{}}addSeparator(){var t=gt(this._getCurrentParagraphIndex(),1)[0],e=Object(i.hasSeparator)(this._getParagraph(t)),r=Object(i.hasSeparator)(this._getParagraph(t+1));!e&&!r&&t<this._ps.length-1&&this._ps.splice(t,1),this._getParagraph(t).sep=1;var a=this._getCursor();this._redraw(!0),this._restoreCursor(a),this._updateTextPlaceholders()}addObjectPoll(){var t=gt(this._getCurrentParagraphIndex(),1)[0],e=this._getParagraph(t),r=Object(i.hasSeparator)(e);Object(j.showBox)("al_voting.php",{act:"box",owner_id:this.getArticleOwnerId(),ref:"article"},{containerClass:"article_poll_creation"}),cur.chooseMedia=(e,a)=>{if(e&&a){var s=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPoll,mediaId:e,sep:r});p(b.ParagraphType.ObjectPoll,e,{editable:!0,snippet:a}),r=!1,this._getOrCreateParagraphObject(s),this._insertParagraphAt(t,s),this._redrawModel(),this._saveUndoState(),this.saveDraft(),this._updateTextPlaceholders()}}}editObjectPoll(t){var e=gt(t.getMediaId().split("_"),2),r=e[0],a=e[1],s=gt(this._getContainingParagraphEl(t.el()),3),o=s[1],n=s[2],c=Object(i.hasSeparator)(n);Object(j.showBox)("al_voting.php",{act:"box",voting_id:a,owner_id:r,ref:"article"},{containerClass:"article_poll_creation"}),cur.chooseMedia=(e,r)=>{var a=t.getCaptionEl().innerHTML;this._deleteParagraphFrom(o),this._forgetObject(n._uuid);var s=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPoll,mediaId:e,sep:c});p(b.ParagraphType.ObjectPoll,e,{editable:!0,snippet:r}),c=!1;var l=this._getOrCreateParagraphObject(s);this._insertParagraphAt(o,s),this._redrawModel(),this._saveUndoState(),this.saveDraft(),this._updateTextPlaceholders(),l.setCaptionElHtml(a)}}onObjectStateLoaded(){this.saveDraft(),this._showObjectPicker()}_hideObjectPicker(){this._objectPickerTooltip&&this._objectPickerTooltip.hide()}_showObjectPicker(){if(!this.isLocked()&&cur.articleEditor){if(!this._objectPickerEl){this._objectPickerEl=Object(o.se)('<div class="article_editor_object_picker"><div class="article_editor_object_picker_icon"></div></div>'),this._els.editor.appendChild(this._objectPickerEl);var t="";Object(ht.partConfigEnabled)("article_poll")&&(t='<button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_poll" onclick="cur.articleEditor.addObjectPoll()"></button>');var e="";cur.articleEditor.getOptions().marketAttachProductEnabled&&(e='<button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_product" onclick="cur.articleEditor.addObjectMarketProduct()"></button>');var r=Object(o.se)(`<div class="article_editor_object_picker_btns_wrap clear_fix">\n        <button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_photo" onclick="cur.articleEditor.addObjectPhoto()">\n        </button><button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_video" onclick="cur.articleEditor.addObjectVideo()">\n        </button><button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_audio" onclick="cur.articleEditor.addObjectAudio()"></button>\n        ${t}\n        ${e}\n        <button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_doc" onclick="cur.articleEditor.addObjectDoc()">\n        </button><button class="article_editor_object_picker_btn" id="article_editor_object_picker_btn_sep" onclick="cur.articleEditor.addSeparator()">\n        </button>\n      </div>`);this._objectPickerTooltip=new _t.default(this._objectPickerEl,{content:r,forceSide:"right",cls:"article_editor_object_picker_tt",autoShow:!1,elClassWhenShown:"article_editor_object_picker_tt_shown",offset:[2,0]}),this._objectPickerEl.addEventListener("mousedown",t=>Object(w.cancelEvent)(t))}var a=gt(this._getCurrentParagraphIndex(),2),s=a[0],n=a[1];if(!this.isMediaUploadMode()&&!1!==s&&s==n&&Object(i.isParagraphEmpty)(this._ps[s],!0)&&this._ps[s]&&Object(O.inArray)(this._ps[s].type,[b.ParagraphType.Text,b.ParagraphType.Header2,b.ParagraphType.Header3])){Object(o.show)(this._objectPickerEl);var c=this._getParagraphElByIndex(s),l=Object(o.getXY)(this._els.editor),h=Object(o.getXY)(c)[1]-l[1],d=!1;this._uploadFloatList(),this._floatedObjects.forEach(t=>{t.startY<=h+15&&t.endY+30>=h&&(d=!0)}),Object(o.setStyle)(this._objectPickerEl,{left:d?355:-40,top:h})}else Object(o.hide)(this._objectPickerEl)}}_initLinksHrefTooltip(){this._els.canvas.addEventListener("mouseover",t=>{if("a"==t.target.tagName.toLowerCase()){if(this._linkTooltip&&this._linkTooltip.destroy(),this._formatTooltip&&this._formatTooltip.isShown())return;var e=t.target,r=e.getAttribute("href").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),a=Object(i.decodeURL)(r);Object(i.isVKUrl)(r)||(r="/away.php?to="+encodeURIComponent(r)+"&utf=1"),this._linkTooltip=new _t.default(e,{cls:"article_editor_link_show_tt",appendTo:this._els.editor,content:Object(o.se)(`<a target="_blank" rel="noopener" href="${r}" class="article_editor_link">${a}</a>`)})}})}_isTrackedObjectEl(t){var e=Object(o.domData)(t,"uuid");return!!e&&!!this._getObject(e)}_cloneObjectParagraphs(){for(var t,e=Array.prototype.slice.call(this._els.canvas.children),r={};t=e.shift();)if(Object(i.isObjectParagraphEl)(t)){var a=t.getAttribute("data-uuid"),s=parseInt(t.getAttribute("data-type"));if(r[a]){var n=this._getObject(a);a=Dt(),this._getOrCreateParagraphObject({type:s,_uuid:a,mediaId:n.getMediaId()}),Object(o.domData)(t,"uuid",a)}r[a]=!0}}_correctCursorToBeWithinCanvas(){var t=gt(Object(i.getRange)(),2),e=t[0];t[1]&&e.startContainer==this._els.canvas&&this._focusParagraph(0)}_triggerInputEvent(){this._els.canvas.dispatchEvent(new Event("input"))}getCursor(){return this._getCursor()}_getCursor(){var t=this._els.canvas,e=gt(Object(i.getRange)(),2),r=e[0],a=e[1];if(!r)return!1;var s={start:{path:[],textOffset:void 0,nodeOffset:void 0},end:{path:[],textOffset:void 0,nodeOffset:void 0}};function n(e,r,a){r.nodeType==Node.TEXT_NODE?e.textOffset=a:e.nodeOffset=a,Object(o.traverseParent)(r,r=>{if(r==t)return!0;Object(i.isQuoteEl)(r)&&r.firstChild&&r.firstChild.nodeType==Node.ELEMENT_NODE&&"p"==r.firstChild.tagName.toLowerCase()&&e.path.pop(),e.path.push(Object(i.childNodeIndex)(r))},10),e.path=e.path.slice().reverse()}return n(s.start,r.startContainer,r.startOffset),a?delete s.end:n(s.end,r.endContainer,r.endOffset),s.isEmpty=()=>!s.end&&0==s.start.nodeOffset&&0==s.start.path.length&&0==s.start.path[0],s}restoreCursor(t){this._restoreCursor(t)}_restoreCursor(t){if(!t)return this._restoreCursorFromMarker();var e=this._els.canvas;function r(t){var r=e,a=0;return t.path.forEach((e,a)=>{if(Object(i.isQuoteEl)(r)){var s=r.firstChild;s&&1==a&&s.nodeType==Node.ELEMENT_NODE&&"p"==s.tagName.toLowerCase()&&(r=s)}e=Math.min(r.childNodes.length-1,e);var o=r.childNodes[e];if(!o)return t.nodeOffset=0,!1;r=o}),a=r.nodeType==Node.TEXT_NODE&&void 0!==t.textOffset?Math.min(r.textContent.length,t.textOffset):0,void 0!==t.nodeOffset&&r&&r.children&&(a=Math.min(t.nodeOffset,r.childNodes.length)),[r,a]}var a=document.createRange();try{var s=gt(r(t.start),2),n=s[0],c=s[1];if(Object(i.isBR)(n)&&0==c){var l=Object(o.domPN)(n);Object(i.isParagraphEl)(l)&&1==l.childNodes.length&&(n=l)}if(a.setStart(n,c),t.end){var h=gt(r(t.end),2),d=h[0],p=h[1];a.setEnd(d,p)}window.getSelection().setBaseAndExtent(a.startContainer,a.startOffset,a.endContainer,a.endOffset)}catch(t){Object(pt.debugLog)(t)}}_saveLastCursor(){var t=this._getCursor(),e="article_cursor_"+this.getArticleOwnerId()+"_"+(this.getArticleId()||0);t&&!t.isEmpty()?ut.default.set(e,JSON.stringify(t)):ut.default.remove(e),this._lastCursor=t}_restoreLastCursor(){var t=ut.default.get("article_cursor_"+this.getArticleOwnerId()+"_"+(this.getArticleId()||0));t?(t=JSON.parse(t),this._restoreCursor(t)):Object(i.focusEl)(this._els.canvas.firstChild)}_toggleCodeBlocks(){for(var t,e=gt(this._getCurrentParagraphIndex(),2),r=e[0],a=e[1],i=r;i<=a;i++)void 0===t&&(t=this._ps[i].type!=b.ParagraphType.Code),this._ps[i].type=t?b.ParagraphType.Code:b.ParagraphType.Text;var s=this._getCursor();this._redraw(!0),this._restoreCursor(s),this._updateTextPlaceholders()}_removeExtraSeparators(){for(var t,e=this._els.canvas.children,r=0;r<e.length;r++){var a=e[r],i=Object(o.domData)(a,"sep");i&&(void 0!==t&&i==t&&Object(o.domData)(a,"sep",null),t=i)}}_replaceAlienInlineTags(){var t=!1,e={b:"strong",i:"em"};return function r(a){var i=a.tagName.toLowerCase();if(e[i]){t||(this._saveCursorMarker(),t=!0);var s=Object(o.ce)(e[i],{innerHTML:a.innerHTML});Object(o.domReplaceEl)(a,s)}else for(var n,c=Array.prototype.slice.call(a.childNodes);n=c.shift();)n.nodeType==Node.ELEMENT_NODE&&r.call(this,n)}.call(this,this._els.canvas),t&&this._restoreCursorFromMarker(),t}_cleanParagraphsBRs(){this._ps.forEach(t=>{t.lines.forEach(i.cleanLineBRs)})}_initEvents(){if(!this.isLocked()){this._setEventListener(window,"scroll",()=>{var t=Object(lt.scrollGetY)(),e=window.innerHeight;this._ps.forEach((r,a)=>{if(Object(i.isObjectParagraph)(r)){var s=this._getParagraphElByIndex(a),n=Object(o.getSize)(s),c=Object(o.getXY)(s),l=c[1]<t+e&&c[1]+n[1]>t;r._object.onViewport&&r._object.onViewport(l)}})});var t,e=0;this._setEventListener(document,"selectionchange",()=>{var r=gt(Object(i.getRange)(),2),a=r[0],n=r[1];if(a&&!Object(o.traverseParent)(a.commonAncestorContainer,t=>t==this._els.canvas))return void this._showObjectPicker();var c=gt(this._getCurrentParagraphIndex(),1)[0];if(!1!==c){if(!n&&Object(o.hasClass)(a.startContainer,"article")){var l=this._ps[e];if(Object(i.isObjectParagraph)(l))return void Object(i.focusEl)(l._object.getCaptionEl())}var h=a.startContainer;if(browser.msie&&n&&Object(o.gpeByClass)("article_ed__extra_controls",h)&&"BUTTON"!=h.tagName){var d=this._ps[c];if(Object(i.isObjectParagraph)(d))return void d._object.getCaptionEl().focus()}e=c,this._highlightObjectsInCurrentSelection(),this._showObjectPicker(),this._correctCaptionSelection(),this._ensureDummyParagraphs(),0==s&&this._showFormatTooltip(),this._saveLastCursor();var p=this._getParagraph(c);Object(i.isObjectParagraph)(p)&&b.ResizableObjectTypes.includes(parseInt(p.type))?this._resizeTooltip&&(clearTimeout(t),t=setTimeout(()=>{this._showResizeTooltip()},100)):this._resizeTooltip&&this._resizeTooltip.isShown()&&this._resizeTooltip.hide()}else this._showObjectPicker()});var r=!1,a=!1,s=!1;this._els.canvas.addEventListener("mousedown",()=>{var t;s=!0,this._setEventListener(window,"mouseup",t=e=>{s=!1,"article_format_btn_link"==e.target.id||(this._showFormatTooltip(),t&&window.removeEventListener("mouseup",t))})}),this._els.canvas.addEventListener("selectstart",()=>{this._hideFormatTooltip()}),this._els.canvas.addEventListener("copy",t=>{var e=gt(Object(i.getRange)(),2),r=e[0];if(e[1]){var a=gt(this._getContainingParagraphEl(r.commonAncestorContainer),1)[0];Object(i.isObjectParagraphEl)(a)&&(t.clipboardData.setData("text/plain","uuid:"+a.getAttribute("data-uuid")),t.preventDefault())}}),this._els.canvas.addEventListener("paste",t=>{var e=gt(this._getCurrentParagraphIndex(),1)[0];e&&(this._handleObjectPaste(t),this._handleLinkPaste(t),this._handlePhotoPaste(t),this._fromPasteEvent=!0,this._pasteCurrentIndex=e)}),this._els.canvas.addEventListener("click",t=>{if(t.target.nodeType==Node.ELEMENT_NODE&&"A"==t.target.tagName)return Object(w.cancelEvent)(t)});var n=!1;this._els.canvas.addEventListener("input",()=>{this._hideObjectPicker(),this._expandBlockquoteParagraphs(h),this._removeExtraSeparators();var t,e=this._replaceAlienInlineTags();browser.safari||this._els.canvas.normalize(),this._fromPasteEvent||e||this._markerCursorSet?this._saveCursorMarker():t=this._getCursor(),this._processAlienPhotos(),this._flattenAlienParagraphs(),this._cloneObjectParagraphs(),this._ps.length>0&&this._els.canvas.children.length!==this._ps.length&&this._setAllParagraphsDirty(),this._dirty.forEach(this._updateLineData.bind(this)),n&&(this._cleanParagraphsBRs(),n=!1),this._ensureAtLeastOneParagraph(),this._ensureTitleParagraph();var i=!1;if(this._fromPasteEvent)try{i=this._expandDoubleBRs()}catch(t){console.error(t)}this._redraw(i),this._restoreCursor(t),this._correctCursorToBeWithinCanvas(),this._dirty=[],a?this._saveUndoStateDelayed():this._saveUndoState(),r=a=!1,this._fromPasteEvent=!1,this._updateTextPlaceholders(),this.saveDraft(),this._undoable=!0,this._options.onUndoRedo&&this._options.onUndoRedo()});var c,l=!1,h=!1,d=1;this._els.canvas.addEventListener("keydown",t=>{var e=t.keyCode,s=t.metaKey||t.ctrlKey,p=t.shiftKey,_=gt(Object(i.getRange)(),2),u=_[0],g=_[1];if(u){var f=gt(this._getCurrentParagraphIndex(),2),v=f[0],j=f[1],y=this._getParagraph(v),m=!1;if(Object(i.isObjectParagraph)(y))if(y._object.isCaptionFocused())m=0==u.startOffset&&g;else m=gt(this._getContainingParagraphEl(u.startContainer),1)[0]==y._object.el();if(m&&g&&browser.mozilla){if(e==Tt)return this._focusParagraph(v-1,!0),Object(w.cancelEvent)(t);if(e==wt)return this._focusParagraph(v+1,!0),Object(w.cancelEvent)(t)}if((e==It||e==Et)&&this._resizeTooltip&&this._resizeTooltip.isShown()&&this._resizeTooltip.hide(),e==xt&&g&&0==v)return Object(i.focusEl)(this._getParagraphElByIndex(1)),Object(w.cancelEvent)(t);if(s&&e==ft&&Object(i.isObjectParagraph)(y)&&y._object.isCaptionFocused()){var P=y._object.getCaptionEl();return Object(i.selectEl)(P),Object(w.cancelEvent)(t)}if(s)switch(e){case vt:return this._setCurrentParagraphDirty(),document.execCommand("Bold",!1,null),Object(w.cancelEvent)(t);case jt:return this._setCurrentParagraphDirty(),document.execCommand("Italic",!1,null),Object(w.cancelEvent)(t);case yt:return this.saveDraft(!1,!1,!0),Object(w.cancelEvent)(t);case Pt:return p?this.redo():this.undo(),Object(w.cancelEvent)(t);case mt:return this.redo(),Object(w.cancelEvent)(t)}var E=e==Ot&&t.altKey,C=y?y.type:b.ParagraphType.Text,T=Object(o.gpeByTag)("pre",u.startContainer),I=!!(T||Object(o.gpeByTag)("pre",u.endContainer)||u.startContainer.nodeType==Node.ELEMENT_NODE&&"PRE"==u.startContainer.tagName);if(E){if(C===b.ParagraphType.Header1)return Object(w.cancelEvent)(t);if(g)return this._toggleCodeBlocks(),Object(w.cancelEvent)(t);if(!I&&Object(O.inArray)(C,[b.ParagraphType.Text,b.ParagraphType.NumericList,b.ParagraphType.BulletList])){this._setCurrentParagraphDirty();var x=Object(o.gpeByTag)("code",u.startContainer)||Object(o.gpeByTag)("code",u.endContainer);if(x){this._saveCursorMarker();var S=Object(o.se)("<span></span>");S.innerHTML=x.innerHTML,Object(o.domReplaceEl)(x,S),this._triggerInputEvent()}else document.execCommand("fontName",!1,"monospace"),browser.msie&&this._triggerInputEvent();return Object(w.cancelEvent)(t)}}if(e==xt&&I&&C==b.ParagraphType.Code)return document.execCommand("insertText",!1,"  "),Object(w.cancelEvent)(t);var k=!1;if(e==Et){if(l)return l[0].textContent=l[1],this._restoreCursor(l[2]),l=!1,Object(w.cancelEvent)(t);if(m){var L=this._getParagraphElByIndex(v),A=Object(i.createParagraphEl)("",Object(i.hasSeparator)(y));return this._correctEmptyParagraphAfterFloatObjects(),Object(o.domReplaceEl)(L,A),Object(i.focusEl)(A),this._setAllParagraphsDirty(),this._triggerInputEvent(),Object(w.cancelEvent)(t)}if(u&&0==u.startOffset&&u.collapsed){var M=Object(o.gpeByTag)("li",u.startContainer),D=Object(i.getElementIndex)(M);if(M){var N=this._ps[v],R=Object(O.clone)(N),B=Object(O.clone)(N);R.lines=R.lines.slice(0,D);var z=Object(i.buildParagraph)({lines:[Object(O.clone)(N.lines[D])]});B.lines=B.lines.slice(D+1),this._ps.splice(v,1,R,z,B),this._redraw(!0);var H=this._getParagraphElByIndex(v+1);return Object(i.focusEl)(H),this._saveUndoState(),Object(w.cancelEvent)(t)}}if(u&&g&&0==u.startOffset&&"LI"!==u.startContainer.nodeName){var U=gt(this._getCurrentParagraphIndex(),1)[0],F=U>0&&this._ps[U-1];if(Object(i.isObjectParagraph)(F)){Object(i.isParagraphEmpty)(this._ps[U])&&(this._ps.splice(U,1),this._redraw(!0));var Y=this._getParagraphElByIndex(U-1);return Object(i.focusEl)(Y),Object(w.cancelEvent)(t)}}this._setAllParagraphsDirty(),browser.msie&&setTimeout(()=>{this._triggerInputEvent()})}if(e==It){var W=this._ps[v],G=this._ps[v+1],X=gt(Object(O.getCaretCharacterOffsetWithin)(u.startContainer),1)[0],K=u.startContainer.textContent.length==X;if(m)if(!(W._object.isCaptionFocused()&&!!W.lines[0].text)){var V=this._getParagraphElByIndex(v),Q=Object(i.createParagraphEl)();return Object(o.domReplaceEl)(V,Q),Object(i.focusEl)(Q),this._setAllParagraphsDirty(),this._triggerInputEvent(),Object(w.cancelEvent)(t)}if(g&&Object(i.hasSeparator)(G)&&K)return this._setParagraphDirty(v+1),delete G.sep,this._redraw(!1,!0),Object(w.cancelEvent)(t);if(g&&K&&Object(i.isObjectParagraph)(G))return Object(i.isParagraphEmpty)(W)&&W.type!=b.ParagraphType.Header1&&(this._ps.splice(v,1),this._redraw(!0,!0)),Object(i.focusEl)(G._object.getCaptionEl()),Object(w.cancelEvent)(t);G&&Object(i.isParagraphEmpty)(W)&&Object(O.inArray)(G.type,[b.ParagraphType.Header2,b.ParagraphType.Header3])&&(W.type=G.type,this._setParagraphDirty(v),this._redraw()),this._setAllParagraphsDirty(),(browser.msie&&0==u.startOffset&&0==v||p)&&setTimeout(()=>{this._setCurrentParagraphDirty(),this._triggerInputEvent()})}else if(e==Ct){if(I&&T&&C==b.ParagraphType.Code&&g){var q=T.textContent.search(/[^\s]/);return-1==q&&(q=T.textContent.length),document.execCommand("insertText",!1,"\n"+" ".repeat(q)),Object(w.cancelEvent)(t)}if(this._isWithinObjectParagraphEl(Object(i.getFocusedElement)())){var J=gt(this._getContainingParagraphEl(Object(i.getFocusedElement)()),2),Z=J[0],tt=J[1],et=Object(i.createParagraphEl)(),rt=this._ps[tt]._object;return!rt.isCaptioned||rt.isCaptionFocused()?Object(o.domInsertAfter)(et,Z):Object(o.domInsertBefore)(et,Z),this._setAllParagraphsDirty(),Object(i.focusEl)(et),this._triggerInputEvent(),Object(w.cancelEvent)(t)}var at=gt(this._getContainingParagraphEl(Object(i.getFocusedElement)()),3),it=at[0],ot=at[2],nt=gt(Object(O.getCaretCharacterOffsetWithin)(it),2)[1];if(t.shiftKey||t.ctrlKey&&browser.safari){var ct=gt(Object(O.getCaretCharacterOffsetWithin)(it),2)[1],lt=Object(o.domClosestByTag)("li",u.startContainer),ht=0;lt&&(ht=Object(o.domChildIndex)(lt));var dt=!1;if(Object(st.each)(ot.lines,(t,e)=>{var r=e.brs,a=e.text.length;return 0==ct||ct<=a&&Object(O.inArray)(ct,r)?(dt=!0,!1):!((ct-=a)<=0&&t==ht)&&void 0}),dt){n=!0,this._setParagraphDirty(v,j),document.execCommand("insertParagraph");var pt=Object(o.domNS)(it);return pt&&(Object(i.focusEl)(pt),pt.focus()),this._triggerInputEvent(),Object(w.cancelEvent)(t)}browser.msie&&0==ct&&u.insertNode(Object(o.se)("<br>"))}var _t=g&&u.startContainer.nodeType==Node.TEXT_NODE&&!u.startContainer.nextSibling&&nt==it.textContent.length;h=_t&&!Object(i.isListParagraph)(this._ps[v])&&!t.shiftKey&&Object(O.inArray)(ot.type,[b.ParagraphType.Quote,b.ParagraphType.Quote2]),window.browser&&window.browser.msie&&setTimeout(this._triggerInputEvent.bind(this)),this._setParagraphDirty(v,j)}else t.key&&1==t.key.length?(this._setParagraphDirty(v),this._setParagraphDirty(j),t.metaKey||(k=!0,t.key&&(Object(i.isCyrillicChar)(t.key)?d+=1:Object(i.isLatinChar)(t.key)&&(d-=1),d=Math.min(Math.max(d,-5),5))),r=Object(i.isWhiteSpaceChar)(t.key),k&&!r&&(a=!0),setTimeout(()=>{var t=gt(Object(i.getRange)(),2),e=t[0],r=t[1],a=this._getParagraph(v);if(a&&(a.type!=b.ParagraphType.Code&&!!!(Object(o.gpeByTag)("code",e.startContainer)||e.startContainer.nodeType==Node.ELEMENT_NODE&&"CODE"==e.startContainer.tagName)&&(c=c||d>0,r&&e))){var s=e.startContainer;if(s.nodeType==Node.TEXT_NODE&&e.startOffset>0)for(var n=s.textContent.substring(e.startOffset-5,e.startOffset),h=0,p=$.length;h<p;h++){var _=$[h];if(void 0===_.cyrillic||_.cyrillic===c)if(_.pattern instanceof RegExp){var u=n.match(_.pattern);if(u){var g=_.substitution;u.length>1&&(g=g.replace("$1",u[1])),f.call(this,e.startOffset,s,u[0],g,_.noUndo);break}}else if(n.endsWith(_.pattern)){f.call(this,e.startOffset,s,_.pattern,_.substitution,_.noUndo);break}}}function f(t,e,r,a,i){var s=this._getCursor(),o=e.textContent.substring(0,t-r.length),n=e.textContent.substring(t);i||(l=[e,o+r+n,s]),e.textContent=o+a+n,this._restoreCursor(s),this._setParagraphDirty(v),this._triggerInputEvent()}},0)):!1;l=!1}}),this._setEventListener(window,"resize",()=>{this._resizeTooltip&&this._resizeTooltip.isShown()&&this._updatePositionResizeTooltip()})}}_isParagraphEl(t){return t&&Object(o.hasClass)(t,i.ArticleEditorParagraphClass)}_isWithinObjectParagraphEl(t){var e=gt(this._getContainingParagraphEl(t),1)[0];return e&&Object(i.isObjectParagraphEl)(e)}_highlightObjectsInCurrentSelection(){var t=gt(this._getCurrentParagraphIndex(),2),e=t[0],r=t[1];!1!==e&&!1!==r&&this._ps.forEach((t,a)=>{if(t._object){var i=e!=r;t._object.highlight(a>=e&&a<=r,i)}})}_getOrCreateParagraphObject(t){t._uuid||(t._uuid=Dt());var e=this._getObject(t._uuid);if(!e){var r=t.mediaId||"";switch(parseInt(t.type)){case b.ParagraphType.ObjectPhoto:e=new x(r,this,t);break;case b.ParagraphType.ObjectVideo:e=new k(r,this);break;case b.ParagraphType.ObjectGIF:e=new A(r,this);break;case b.ParagraphType.ObjectAudio:e=new B(r,this);break;case b.ParagraphType.ObjectAudioPlaylist:e=new v(r,this);break;case b.ParagraphType.ObjectPodcast:e=new D(r,this);break;case b.ParagraphType.ObjectTwitter:e=new G(r,this);break;case b.ParagraphType.ObjectInstagram:e=new Q(r,this);break;case b.ParagraphType.ObjectFacebook:e=new K(r,this);break;case b.ParagraphType.ObjectVK:e=new J(r,this);break;case b.ParagraphType.ObjectTelegram:e=new tt(r,this);break;case b.ParagraphType.ObjectPoll:e=new rt(r,this);break;case b.ParagraphType.ObjectMarketItem:e=new H(r,this);break;case b.ParagraphType.ObjectAliExpressProduct:e=new F(r,this)}this._setObject(t._uuid,e)}return t._object=e,e}_forgetObject(t){delete this._objects[t]}_getObject(t){return this._objects[t]||null}_setObject(t,e){return this._objects[t]=e}_updateLineData(t){var e=this._getParagraphElByIndex(t);if(e){if(this._isWithinObjectParagraphEl(e)){var r=gt(Object(i.paragraphElProperties)(e),3),a=r[0],s=r[1],n=r[2],c=this._getObject(s);if(!c)return;var l=Object(i.buildParagraph)();if(c.getCaptionEl()){var h=this._getParagraphFromHTML("",c.getCaptionEl().innerHTML,!0);if(a==b.ParagraphType.ObjectPhoto){var d=Object(o.domData)(c.el(),"paragraph-lines");d&&(l.lines=JSON.parse(d));var p=c.getImageIndex();l.lines[p]=h.lines[0];for(var _=0;_<l.lines.length;_++)l.lines[_]=l.lines[_]||{text:"",decorations:{}}}else l.lines[0]=h.lines[0]}l.type=a,l.mode=n,l._uuid=s,l._object=c,this._ps[t]=l}else if(e.nodeType==Node.ELEMENT_NODE){var u=e.tagName.toLowerCase();this._ps[t]=this._getParagraphFromHTML(u,e.innerHTML)}else this._ps[t]=this._getParagraphFromHTML("p",e.textContent);e.nodeType==Node.ELEMENT_NODE&&Object(o.domData)(e,"sep")&&(this._ps[t].sep=!0)}}onDragEnd(){this._dragEnterEventsHandler&&(this._els.canvas.removeEventListener("dragenter",this._dragEnterEventsHandler),delete this._dragEnterEventsHandler),this._dragLeaveEventsHandler&&(this._els.canvas.removeEventListener("dragleave",this._dragLeaveEventsHandler),delete this._dragLeaveEventsHandler),this._dragDropEventsHandler&&(this._els.canvas.removeEventListener("drop",this._dragDropEventsHandler),delete this._dragDropEventsHandler),this._dragEndEventsHandler&&(this._els.canvas.removeEventListener("dragend",this._dragEndEventsHandler),delete this._dragEndEventsHandler)}getCurrentParagraphs(){var t=gt(this._getCurrentParagraphIndex(),2),e=t[0],r=t[1];return[this._getParagraphElByIndex(e),this._getParagraphElByIndex(r)]}_initObjectDrag(){var t,e,r,a,n,c=this,l=0,h=!1,d=null,p=this._els;function u(t){!1!==t&&t===d||f(),n!=t&&(Object(st.each)(Object(o.geByClass)("article_ed__drag_hovered"),(t,e)=>{Object(o.removeClass)(e,"article_ed__drag_hovered")}),t&&Object(o.addClass)(t,"article_ed__drag_hovered"),n=t)}function g(){window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e),h=!1,Object(o.removeClass)(p.canvas,"no_select"),clearTimeout(l),clearInterval(a),u(!1),Object(o.re)(r),r=!1}function f(){d&&(Object(o.removeClass)(d._objectEl,"article__carousel--noHover"),d.removeCarouselHover(),d=null)}var v=t=>{t&&(Object(o.addClass)(t._object._objectEl,"article__carousel--noHover"),(d=this._getOrCreateParagraphObject(t)).renderCarouselHover())};function O(t){t.preventDefault(),t.stopPropagation()}var y=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=!1;e&&(r=c._getOrCreateParagraphObject(e).isCarouselEditorOpened());var a=c._getContainingParagraphEl(t.target),i=gt(a,3),s=i[0],n=i[2],l=n&&+n.type===b.ParagraphType.ObjectPhoto;if(n&&parseInt(n.mode)===b.ObjectResizeType.Float)return!1;if(e===n||r)return!1;if(l){var h=Object(o.getXY)(s),d=Object(o.getSize)(s),p=.7;if(t.pageY<h[1]+d[1]*p)return!0}return!1},m=(t,e)=>{var r=t.isCarouselEditorOpened();e&&(r||t.createCarousel(),e.forEach((e,r)=>{var a={editable:{sizes:_(b.ParagraphType.ObjectPhoto,e).sizes}};t.addPhotoInCarousel(e,a,r)}))},P=t=>{l&&(clearTimeout(l),Object(w.cancelEvent)(t)),l=setTimeout(()=>{var e=gt(this._getContainingParagraphEl(t.target),3),r=e[0],i=e[1],s=e[2];s&&+s.type===b.ParagraphType.ObjectPhoto&&y(t)?(u(!1),v(s)):u(r),h=i,Object(o.addClass)(this._els.canvas,"no_select"),clearInterval(a),t.pageY<200+Object(lt.scrollGetY)()?a=setInterval(()=>this._options.layer.scrollTop-=10,10):Object(lt.scrollGetY)()+window.innerHeight-200<t.pageY&&(a=setInterval(()=>this._options.layer.scrollTop+=10,10))})};["dragenter","dragover","dragleave","drop"].forEach(t=>{this._els.canvas.addEventListener(t,O,!1)}),["dragenter","dragover"].forEach(t=>{this._els.canvas.addEventListener(t,P)}),this._els.canvas.addEventListener("dragleave",t=>{l&&(clearTimeout(l),Object(w.cancelEvent)(t)),l=setTimeout(()=>g(),100)}),this._els.canvas.addEventListener("drop",t=>{var e=t.dataTransfer.files;if(e.length){if(!function(t){return Array.from(t).every(t=>!!t.name&&b.ALLOWED_FILE_TYPES_FOR_PASTE.split(";").some(e=>(e=e.slice(1),t.name.substr(-e.length).toLowerCase()===e)))}(e))return Object(j.showFastBox)(Object(s.getLang)("global_error"),Object(s.getLang)("pages_article_ed_paste_photo_file_error")),void g();if(!1!==h){f(),this._photoPasteUploadingProcess=!0;var r=gt(this._getContainingParagraphEl(t.target),3)[2],a=Array.from(e),o=r&&+r.type===b.ParagraphType.ObjectPhoto&&y(t),n=(t,e)=>new Promise(r=>{var a=new FileReader;a.onload=()=>{this._photoPasteUploadingProcess=!1;var a=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPhoto}),s=this._getOrCreateParagraphObject(e);s.setLoadingState(!0,!0);this._getOrCreateParagraphObject(a).setBLOB(t,()=>{var t=this._getOrCreateParagraphObject(a).getMediaId(0);s.setLoadingState(!1),m(s,[t]),this._forgetObject(a._uuid),r()}),this._resizeTooltip&&this._resizeTooltip.isShown()&&this._resizeTooltip.hide()},a.readAsDataURL(t)});o?Promise.all(a.map(t=>n(t,r))).then(()=>{this._focusParagraph(h),this._showObjectPicker(),this.saveUndoStateAndDraft(),g()}):((t,e)=>new Promise(r=>{var a=new FileReader;a.onload=()=>{this._photoPasteUploadingProcess=!1;var s=e,o=Object(i.buildParagraph)({type:b.ParagraphType.ObjectPhoto});this._getOrCreateParagraphObject(o).setBLOB(t,()=>{r(o)}),Object(i.isParagraphEmpty)(this._ps[e])&&e?(Object(i.hasSeparator)(this._ps[e])&&(o.sep=1),this._ps[e]=o):(s=e+1,this._insertParagraphAt(s,o)),e||this._updateTextPlaceholders(),this._redraw(!0,!0),(new Image).src=a.result,this._resizeTooltip&&this._resizeTooltip.isShown()&&this._resizeTooltip.hide()},a.readAsDataURL(t)}))(e[0],h).then(t=>{for(var e=[],r=1;r<a.length;r++)e.push(n(a[r],t));return Promise.all(e)}).then(()=>{this._showObjectPicker(),this._focusParagraph(h+1),this.saveUndoStateAndDraft(),g()})}}}),this._els.canvas.addEventListener("mousedown",s=>{if(r&&Object(o.re)(r),2==s.button)return g(),Object(w.cancelEvent)(s);var n=Object(o.getSize)(this._els.canvas)[1];Object(o.removeClass)(this._els.canvas,"no_select"),u(!1);var c=gt(this._getContainingParagraphEl(s.target),3),l=c[0],d=c[1],p=c[2];if(Object(i.isObjectParagraph)(p)){var _,O,j,P,E,C=s.pageY;window.addEventListener("mousemove",t=t=>{if(r||!(Math.abs(C-t.pageY)<10)){r||(r=Object(o.se)('<div class="article_ed__drag_shadow"></div>'),this._els.editor.appendChild(r),(_=Object(o.getXY)(this._els.canvas))[1]-=Object(lt.scrollGetY)(),O=Object(o.getSize)(l),j=Object(o.getXY)(l),P=t.pageX-j[0],E=t.pageY-j[1]+this._options.layer.scrollTop,Object(o.setStyle)(r,{width:O[0],height:O[1]}),this._focusParagraph(d)),Object(o.addClass)(this._els.canvas,"no_select"),_||g(),Object(o.setStyle)(r,{left:t.pageX-_[0]-P,top:t.pageY-Object(lt.scrollGetY)()-E-_[1]+this._options.layer.scrollTop}),clearInterval(a),t.pageY-Object(lt.scrollGetY)()<200?a=setInterval(()=>{this._options.layer.scrollTop-=10},10):t.pageY-Object(lt.scrollGetY)()>window.innerHeight-200&&(a=setInterval(()=>{this._options.layer.scrollTop+window.innerHeight>n+300?clearInterval(a):this._options.layer.scrollTop+=10},10));var e=gt(this._getContainingParagraphEl(t.target),3),i=e[0],s=e[1],c=e[2];if(+p.type===b.ParagraphType.ObjectPhoto){if(y(t,p))return u(!1),v(c),void(h=s);f()}i&&i!=l&&i!=Object(o.domPS)(l)?(u(i),h=s):(u(!1),h=!1)}}),window.addEventListener("mouseup",e=t=>{if(!1!==h&&d){var e=this._getParagraph(h),r=e&&+e.type===b.ParagraphType.ObjectPhoto&&y(t,p);if(this._ps.splice(d,1),Object(i.hasSeparator)(p)&&(this._ps[d].sep=1,delete p.sep),r){var a=this._getOrCreateParagraphObject(p).getMediaIds(),s=this._getOrCreateParagraphObject(e);m(s,a)}else this._ps.splice(h+1,0,p);if(this._redraw(!0,!0),r){var o=this.getObjectParagraphIndex(e);this._focusParagraph(o)}else this._focusParagraph(h+1);this.saveUndoStateAndDraft(),this._resizeTooltip&&this._resizeTooltip.isShown()&&this._resizeTooltip.hide()}g()})}})}isLocked(){return!!this.getOptions().editLockMessage}showEditLockInfo(){this.isLocked()?(this.showWarningInfo(this.getOptions().editLockMessage),this._els.canvas.removeAttribute("contenteditable"),Object(o.hide)(this._objectPickerEl),this._hideObjectPicker(),this._hideFormatTooltip()):this.showWarningInfo(!1)}showRevEditInfo(){nav.objLoc.from_rev&&this.showWarningInfo(Object(s.getLang)("pages_article_rev_edit"))}showWarningInfo(t){var e=Object(o.geByClass1)("article_ed__warn_info",this._els.editor);e&&!t&&(Object(o.removeClass)(this._els.editor,"article_ed__warn_shown"),Object(o.re)(e)),e||t&&(e=Object(o.se)(`<div class="article_ed__warn_info">${t}</div>`),this._els.editor.appendChild(e),Object(o.addClass)(this._els.editor,"article_ed__warn_shown"))}_initResizeTooltip(){var t=Object(o.se)('<div class="resize-tooltip__btns article_format_btns clear_fix"></div>');this._resizeTooltip=new _t.default(this._els.editor.parentNode,{content:t,autoShow:!1,customShow:!0,forceSide:"top",cls:"resize-tooltip article_format_tt"}),t.addEventListener("click",t=>{if(t.target.classList.contains("article_format_btn")){var e=parseInt(t.target.dataset.mode);this.setModeCurrentObject(e)}})}_showResizeTooltip(){var t=gt(this._getCurrentParagraphIndex(),1)[0],e=this._getParagraphElByIndex(t),r=this._getParagraph(t),a=Object(st.intval)(r.type);if(b.ResizableObjectTypes.includes(a))if(this._resizeTooltip&&!this._resizeTooltip.isShown()&&this._resizeTooltip.show(),Object(o.hasClass)(e,"article_ed__carousel_edit_open"))this._resizeTooltip.hide();else if(r._object.isLoading())this._resizeTooltip.hide();else{var i=[{id:b.ObjectResizeType.Float,type:"inline"},{id:b.ObjectResizeType.Normal,type:"text"},{id:b.ObjectResizeType.Medium,type:"bigger"},{id:b.ObjectResizeType.Large,type:"cover"}],s=Object(o.geByClass1)("resize-tooltip__btns"),n=[1,1,1,1];switch(a){case b.ParagraphType.ObjectPhoto:r._object.isCarousel()?n=[0,1,1,0]:r._object.isSmallPhotoSize()||(n=[1,1,0,0]);break;case b.ParagraphType.ObjectGIF:r._object._isSmallGifSize()||(n=[1,1,0,0]);break;case b.ParagraphType.ObjectTwitter:case b.ParagraphType.ObjectFacebook:case b.ParagraphType.ObjectInstagram:case b.ParagraphType.ObjectVK:case b.ParagraphType.ObjectTelegram:n=[1,1,0,0]}s.innerHTML="",i.forEach((t,e)=>{n[e]&&s.appendChild(Object(o.se)(`\n          <button class="article_format_btn${r.mode==t.id||!r.mode&&!t.id?" article_format_btn_active":""}" id="article_format_btn_${t.type}"  data-mode=${t.id} ></button>\n        `))}),this._updatePositionResizeTooltip()}}_updatePositionResizeTooltip(){var t=this._resizeTooltip,e=gt(Object(o.getXY)(this._els.editor),2)[1],r=gt(this._getCurrentParagraphIndex(),1)[0],a=this._getParagraphElByIndex(r).getBoundingClientRect(),i=a.top,s=a.left,n=a.width,c=Object(o.getSize)(t._ttel)[0]/2;Object(o.setStyle)(t._ttel,{top:i-e-60+window.scrollY+140,left:s+n/2-c})}setModeObject(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:b.ObjectResizeType.Normal,r=this._getParagraph(t);Object(i.isObjectParagraph)(r)&&(r.mode=e,this._correctEmptyParagraphAfterFloatObjects(),this._redraw(!0,!0),this.saveUndoStateAndDraft())}setModeCurrentObject(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b.ObjectResizeType.Normal,e=gt(this._getCurrentParagraphIndex(),1)[0];this.setModeObject(e,t)}_uploadFloatList(){var t=Object(o.getXY)(this._els.editor);this._floatedObjects=[],this._ps.forEach((e,r)=>{if(e.mode&&parseInt(e.mode)===b.ObjectResizeType.Float){var a=this._getParagraphElByIndex(r),i=a.getBoundingClientRect().height,s=Object(o.getXY)(a);this._floatedObjects.push({startY:s[1]-t[1],endY:s[1]-t[1]+i})}})}_correctEmptyParagraphAfterFloatObjects(){for(var t=0;t<this._ps.length;t++){var e=this._ps[t],r=this._ps[t+1];if(Object(i.isObjectResize)(e)>=0)if(1===parseInt(e.mode)&&Object(i.isObjectParagraph)(r)){var a=Object(i.buildParagraph)();a._autoInsert=!0,this._insertParagraphAt(t+1,a)}else 1!==parseInt(e.mode)&&r&&r._autoInsert&&this._deleteParagraphFrom(t+1)}}}},fA63:function(t,e,r){"use strict";r("qncB")("trimRight",(function(t){return function(){return t(this,2)}}),"trimEnd")},qncB:function(t,e,r){var a=r("XKFU"),i=r("vhPU"),s=r("eeVq"),o=r("/e88"),n="["+o+"]",c=RegExp("^"+n+n+"*"),l=RegExp(n+n+"*$"),h=function(t,e,r){var i={},n=s((function(){return!!o[t]()||"​"!="​"[t]()})),c=i[t]=n?e(d):o[t];r&&(i[r]=c),a(a.P+a.F*n,"String",i)},d=h.trim=function(t,e){return t=String(i(t)),1&e&&(t=t.replace(c,"")),2&e&&(t=t.replace(l,"")),t};t.exports=h}});