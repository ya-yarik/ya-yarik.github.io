!function(e){function t(t){for(var s,r,n=t[0],h=t[1],d=t[2],u=0,c=[];u<n.length;u++)r=n[u],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&c.push(o[r][0]),o[r]=0;for(s in h)Object.prototype.hasOwnProperty.call(h,s)&&(e[s]=h[s]);for(g&&g(t);c.length;)c.shift()();return i.push.apply(i,d||[]),a()}function a(){for(var e,t=0;t<i.length;t++){for(var a=i[t],s=!0,n=1;n<a.length;n++){var h=a[n];0!==o[h]&&(s=!1)}s&&(i.splice(t--,1),e=r(r.s=a[0]))}return e}var s={},o={"web/photos_module":0},i=[];function r(t){if(s[t])return s[t].exports;var a=s[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.e=function(){return Promise.resolve()},r.m=e,r.c=s,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(a,s,function(t){return e[t]}.bind(null,s));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/js/cmodules/";var n=window.webpackJsonp=window.webpackJsonp||[],h=n.push.bind(n);n.push=t,n=n.slice();for(var d=0;d<n.length;d++)t(n[d]);var g=h;i.push([260,"common","404c8348f788d0ca8871b1cd5f462b00"]),a()}({260:function(e,t,a){e.exports=a("Lrwn")},"7lz1":function(e,t,a){"use strict";a.r(t),a.d(t,"decrementLeftMenuPhotoCounter",(function(){return r})),a.d(t,"resetLeftMenuPhotoCounter",(function(){return n}));var s=a("t7n3"),o=a("HLtZ"),i=a("kHqu");function r(e){void 0===e&&(e=1);try{var t=function(){var e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");var t=e.querySelector(".left_count");return t?Object(s.intval)(t.textContent):0}();Object(i.handlePageCount)("ph",Math.max(t-e,0))}catch(e){console.error(e),Object(o.logError)(e)}}function n(){try{Object(i.handlePageCount)("ph",0)}catch(e){console.error(e),Object(o.logError)(e)}}},Lrwn:function(e,t,a){"use strict";a.r(t);var s=a("g/In"),o=a("yTQ2");window.PhotoTags=s.default,window.PhotoTooltip=o.default;try{stManager.done(jsc("web/photos_module.js"))}catch(e){}},"g/In":function(e,t,a){"use strict";a.r(t);a("HEwt"),a("a1Th"),a("rE2o"),a("ioFf"),a("KKXr"),a("pIFo"),a("rGqo"),a("Btvt");var s=a("zxIV"),o=a("EasH"),i=a("4+be"),r=a("yTQ2"),n=a("Nk8j"),h=a("dBLD"),d=a("W9Tc"),g=a("7lz1");function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],s=!0,o=!1,i=void 0;try{for(var r,n=e[Symbol.iterator]();!(s=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);s=!0);}catch(e){o=!0,i=e}finally{try{s||null==n.return||n.return()}finally{if(o)throw i}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return c(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,s=new Array(t);a<t;a++)s[a]=e[a];return s}t.default=class{constructor(e,t){this.imageNode=e,this.containerNode=t,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this.updatePhotoViewTags=this.updatePhotoViewTags.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}_init(){var e=Object(d.partConfigEnabled)("photo_recognition_web");this.photoTooltip=new r.default(window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined,hideAfterDecline:e}),this.photoView=window.Photoview,this.areasContainer=ce("div",{className:"photo_tags_suggested_areas_list"}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),addEvent(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()}_handleImageMouseMove(e){if(!this.areasHidden){var t=getXY(e.target),a=Math.round(100*(e.pageX-t[0])/e.target.offsetWidth),s=Math.round(100*(e.pageY-t[1])/e.target.offsetHeight);for(var o in clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout(()=>{this.photoTooltip.isActive||this.activeAreaId||this.hideAllSuggestedAreas()},700),this.showAllSuggestedAreas(),this.areas)if(this.areas.hasOwnProperty(o)){var i=this.areas[o],r=i.x,n=i.y,h=i.x2,d=i.y2;if(a>parseInt(r)&&a<parseInt(h)&&s>parseInt(n)&&s<parseInt(d)){if(o===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(o),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}}_handleAreaClick(e){cancelEvent(e),this.photoTooltip.showAndFocusFriendsList(e)}showTagArea(e){var t=this.areas[e];return!(!t||t.isDeleted)&&(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&Object(s.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,Object(s.addClass)(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)}hideTagArea(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&Object(s.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()}_removeActiveAreaAfterTimeout(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout(()=>{!this.photoTooltip.isActive&&!this.tagAreaFound&&!this.photoTooltip.interaction&&this.hideTagArea(),this.waitToRemove=!1},e))}showTooltip(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,a=this._getTooltipOptions(e);if(t){var o=Object(s.getXYRect)(t,!0),i=o.top,r=o.right,n=o.bottom,h=o.left;this.photoTooltip.show({top:i,right:r,bottom:n,left:h},a)}}}showAllSuggestedAreas(){Object(s.addClass)(this.areasContainer,"visible_all"),Object(s.removeClass)(this.areasContainer,"area_hover"),this.activeAreaId&&Object(s.addClass)(this.areasContainer,"area_hover")}hideAllSuggestedAreas(){Object(s.removeClass)(this.areasContainer,"visible_all")}pauseTooltips(){this.hideTagArea(),this.tooltipsPaused=!0}resumeTooltips(){this.tooltipsPaused=!1}_createTagElement(e,t,a,s){var o=cur.pvPhWidth,i=cur.pvPhHeight/o,r=a-e,n=s-t,h=ce("div",{className:"photo_tags_suggested_area"},{left:e+"%",marginTop:i*t+"%",width:r+"%"}),d=ce("div",{},{paddingBottom:100*i*(n/r)+"%"});return h.appendChild(d),h}renderTagAreas(){this.areas={},this.areasContainer.innerHTML="";var e=Object(n.getPhotoData)("tags"),t=Object(n.getPhotoData)("suggested_tags"),a=Object(d.partConfigEnabled)("photo_recognition_web");for(var s in!a&&cur.postTo&&cur.postTo<0&&(t=[]),e)if("0"!==s&&e.hasOwnProperty(s)){var o=u(e[s],7),i=o[0],r=o[1],h=o[2],g=o[3],c=o[4],l=o[5],p=o[6],v=this._createTagElement(i,r,h,g);this.areas[s]={ele:v,x:i,y:r,x2:h,y2:g,userName:c,userHref:l,canDeleteTag:Boolean(p),confirmedTag:!1},this.areasContainer.appendChild(v)}for(var f in t)if(f&&t.hasOwnProperty(f)){var m=u(t[f],7),_=m[0],b=m[1],T=m[2],A=m[3],w=m[4],O=m[5],j=m[6],S=this._createTagElement(_,b,T,A),I=void 0;w&&(I="/id"+w),this.areas[f]={ele:S,x:_,y:b,x2:T,y2:A,userHref:I,suggestedUserId:w,suggestedUserName:O,usersList:j,confirmedTag:!1},this.areasContainer.appendChild(S)}}_userSelectedCallback(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=Object(n.getPhotoData)("tags"),o=Object(n.getPhotoData)("suggested_tags"),i=Object(d.partConfigEnabled)("photo_recognition_web"),r=this.activeAreaId,h=this.areas[r],g=h.x,u=h.y,c=h.x2,l=h.y2,p="/id"+e,v=cur.pvAskForAutoTag&&a,f=clean(t),m={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:f,userHref:p,canDeleteTag:!0},_=this.activeAreaId;i?this.confirmSuggestedTags([r],()=>{this.activeAreaId=_,this.photoTooltip.updateState(m),this.showTagArea(_),this._removeActiveAreaAfterTimeout(1e3)}):(s[r]=[g,u,c,l,f,p,!0],delete o[r],this._confirmSuggestedTag(r,e,t,i,()=>{this.activeAreaId=_,this.areas[_]=extend(h,m),this.photoTooltip.updateState(m),this.showTagArea(_),this._removeActiveAreaAfterTimeout(1e3),v&&(cur.pvAskForAutoTag=!1,this.showSettingsBox())}))}showSettingsBox(){showBox("/al_photos.php",{act:"show_autotag_settings"},{params:{containerClass:"autotag_settings_box",grey:!0,width:450}})}confirmAlert(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=cur.pvOneSuggestHintId,a=cur.pvOneSuggestHintHash;e?(t=cur.pvSomeSuggestsHintId,a=cur.pvSomeSuggestsHintHash,cur.pvNeedShowAlertForSomeSuggests=!1):cur.pvNeedShowAlertForOneSuggest=!1,window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:t,hash:a},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}deleteTag(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=extend(t,{isDeleted:!0}),Object(s.addClass)(t.ele,"deleted"))}_getTooltipOptions(e){var t=this.areas[e],a=t.suggestedUserId,s=t.suggestedUserName;return{suggestedUserId:a,userName:t.userName,userHref:t.userHref,suggestedUserName:s,usersList:t.usersList,canDeleteTag:t.canDeleteTag}}_handleSuggestionDeclined(){var e=this.activeAreaId,t=this.areas[e];if(t){var a=Object(n.getPhotoData)("suggested_tags"),s=Object(d.partConfigEnabled)("photo_recognition_web");this.areas[e]=extend(t,{suggestedUserId:!1,suggestedUserName:!1,userHref:null}),a&&a[e]&&(a[e][4]=0),s?this.declineSuggestedTags([e]):(this.showTagArea(e),this._declineSuggestedTag(e))}}declineSuggestedTags(e,t,a){var o=Object(n.getPhotoData)("id"),r=Object(n.getPhotoData)("hash"),d=cur.pvListId,g=cur.pvIndex,u=cur.pvData[d][g],c=Object(n.getPhotoData)("tags"),l=e.map(e=>`${o}_${e}`).join(",");ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:l,hash:r,extended:1},{onDone:(a,r,n)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewSuggestedTags(a,r,u),this.dispatchEvent(h.TagEventTypes.DECLINE_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:o}),d===cur.pvListId&&g===cur.pvIndex&&(!u.taginfo&&u.actions.tag&&c[0]<cur.pvMaxTags?Object(s.show)(cur.pvTagLink):Object(s.hide)(cur.pvTagLink),a||r||this.photoView.toggleTopInfoPanel(Object(i.getLang)("photos_tag_deleted"),n)),t&&t()},onFail:e=>(e||(e=Object(i.getLang)("global_unknown_error")),a&&a(),this.handleTagRequestFail(e))})}confirmSuggestedTags(e,t,a){var r=cur.pvListId,d=cur.pvIndex,g=cur.pvData[r][d],u=Object(n.getPhotoData)("id"),c=Object(n.getPhotoData)("hash"),l=Object(n.getPhotoData)("suggested_tags"),p=e.length>1,v=e[0],f=l[v][4],m=()=>{var o=e.map(e=>`${u}_${e}`).join(",");ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:o,hash:c,extended:1},{onDone:(a,o,i,n,c)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewTags(a,o,i,g),this.updatePhotoViewSuggestedTags(n,c,g),this.dispatchEvent(h.TagEventTypes.CONFIRM_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:u}),r===cur.pvListId&&d===cur.pvIndex&&(!g.taginfo&&g.actions.tag&&a[0]<cur.pvMaxTags?Object(s.show)(cur.pvTagLink):Object(s.hide)(cur.pvTagLink)),t&&t()},onFail:e=>(e||(e=Object(i.getLang)("global_unknown_error")),a&&a(),this.handleTagRequestFail(e))})};if(cur.pvNeedShowAlertForOneSuggest&&!p&&f!==window.vk.id||cur.pvNeedShowAlertForSomeSuggests&&p){var _="",b="",T="";if(p){var A=e.reduce((e,t)=>{var a=l[t],s=a&&a[4];return s&&s!==window.vk.id&&(e[s]=!0),e},{}),w=Object.keys(A).length;b=Object(i.getLang)("photo_recognition_some_tag_alert",w),_=Object(i.getLang)("photo_recognition_some_friends_alert_text",w),T=Object(i.getLang)("photo_recognition_some_friends_submit_btn")}else{var O=l[v][5],j=l[v][7];b=Object(i.getLang)("photo_recognition_one_tag_alert"),_=Object(i.langSex)(j,Object(i.getLang)("photo_recognition_one_tag_alert_text","raw")).replace("{name}",O),T=Object(i.getLang)("photo_recognition_one_friend_submit_btn")}var S=Object(o.showFastBox)(b,_,T,()=>{S.hide(),m(),this.confirmAlert(p)},Object(i.getLang)("global_cancel"),()=>{S.hide(),a&&a()})}else m()}decrementLeftMenuCounterIfNeeded(e){var t=Object(n.getPhotoData)("suggested_tags");e.forEach(e=>{var a=t[e],s=a&&a[4];s&&s===window.vk.id&&Object(g.decrementLeftMenuPhotoCounter)()})}_confirmSuggestedTag(e,t,a,s,o){var i=Object(n.getPhotoData)("id"),r=Object(n.getPhotoData)("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:a,photo:i,hash:r},{onDone:(e,t,a)=>{this.updatePhotoViewTags(e,t,a),o()},onFail:this.handleTagRequestFail})}_declineSuggestedTag(e){var t=Object(n.getPhotoData)("id"),a=Object(n.getPhotoData)("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:t,hash:a},{onFail:this.handleTagRequestFail})}dispatchEvent(e,t){this.areasContainer.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}))}handleTagRequestFail(e){var t=Object(i.getLang)("global_error");return setTimeout(Object(o.showFastBox)(t,e).hide,3e3),!0}unMount(){removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),removeEvent(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""}hideAreas(){this.areasHidden=!0,Object(s.hide)(this.areasContainer),this.photoTooltip.hide()}showAreas(){this.areasHidden=!1,Object(s.show)(this.areasContainer),removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove)}reload(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()}_queueCheckUpdates(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)}updatePhotoViewTags(e,t,a){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(s=s||Object(n.getCurrentPhoto)())&&(s.tags=e,s.tagged=t,s.tagshtml=a,this.photoView.setTags(a))}updatePhotoViewSuggestedTags(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(a=a||Object(n.getCurrentPhoto)())&&(e&&Object.keys(e).length?a.suggested_tags=e:delete a.suggested_tags,t?(a.suggestedTagsInfo=t,this.photoView.showSuggestedInfoTopPanel(cur.pvCurPhoto)):(delete a.suggestedTagsInfo,this.photoView.toggleTopInfoPanel(!1)),this.reload())}_queueReceiveUpdates(e,t){t.events&&t.events.forEach(e=>{var t=e.split("<!>"),a=t[1],s=t[2],o=JSON.parse(s),i=JSON.parse(t[3]),r=JSON.parse(t[4]),h=t[5];if(Object(n.getPhotoData)("id")===a)Object(n.setPhotoData)("suggested_tags",o),this.updatePhotoViewTags(i,r,h),this.renderTagAreas();else if(cur.pvData){var d=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach((t,s)=>{if(t.id&&t.id===a){var n=cur.pvData[e][s];n.suggested_tags=o,n.tags=i,n.tagged=r,n.tagshtml=h}})}};for(var g in cur.pvData)d(g)}})}}}});