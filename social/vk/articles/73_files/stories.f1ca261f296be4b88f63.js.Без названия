!function(e){function t(t){for(var i,a,s=t[0],c=t[1],l=t[2],u=0,p=[];u<s.length;u++)a=s[u],Object.prototype.hasOwnProperty.call(o,a)&&o[a]&&p.push(o[a][0]),o[a]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(e[i]=c[i]);for(d&&d(t);p.length;)p.shift()();return n.push.apply(n,l||[]),r()}function r(){for(var e,t=0;t<n.length;t++){for(var r=n[t],i=!0,s=1;s<r.length;s++){var c=r[s];0!==o[c]&&(i=!1)}i&&(n.splice(t--,1),e=a(a.s=r[0]))}return e}var i={},o={"web/stories":0},n=[];function a(t){if(i[t])return i[t].exports;var r=i[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,a),r.l=!0,r.exports}a.e=function(){return Promise.resolve()},a.m=e,a.c=i,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(r,i,function(t){return e[t]}.bind(null,i));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/js/cmodules/";var s=window.webpackJsonp=window.webpackJsonp||[],c=s.push.bind(s);s.push=t,s=s.slice();for(var l=0;l<s.length;l++)t(s[l]);var d=c;n.push([300,"audioplayer","lottie","common","palette","9b5c1549562b5997058328b940973c18","71af34534be10395f7f6bb3e2039fd2e","983f42e70b3e18d97715513130ff4d9c"]),r()}({"0PSK":function(e,t,r){"use strict";r.r(t);var i=r("q1tI"),o=r.n(i);t.default=o.a.createContext(null)},300:function(e,t,r){e.exports=r("uXyw")},"4WSo":function(e,t,r){"use strict";r.r(t),r.d(t,"NarrativeItemPreviewCover",(function(){return a}));var i=r("q1tI"),o=r.n(i),n=r("ZxpX"),a=o.a.memo((function(e){var t=e.title,r=e.onClick,i=e.cover,a=e.href,s=e.className,c=void 0===s?"":s,l=e.extra,d=i?{backgroundImage:"url("+i+")"}:{},u=Object(n.classNames)("NarrativeItemPreviewCover",c),p=o.a.createElement("div",{className:"NarrativeItemPreviewCover__image",style:d,title:t||void 0},l);return o.a.createElement(o.a.Fragment,null,a&&o.a.createElement("a",{href:a,className:u,onClick:r},p),!a&&o.a.createElement("div",{className:u,onClick:r},p))}))},"4amH":function(e,t,r){"use strict";r.r(t),r.d(t,"MODULE",(function(){return a})),r.d(t,"ReportTypeId",(function(){return i})),r.d(t,"setServerConnectionErrorSkip",(function(){return c})),r.d(t,"handleBackendError",(function(){return l})),r.d(t,"renderFullId",(function(){return d})),r.d(t,"renderReportFullId",(function(){return u})),r.d(t,"parseBackendReportsResponse",(function(){return p})),r.d(t,"parseBackendReportResponse",(function(){return _})),r.d(t,"createReportDecisionButtonsLoadings",(function(){return h})),r.d(t,"areReportsEqual",(function(){return m})),r.d(t,"doesReportHaveTheseIds",(function(){return v}));var i,o=r("976x"),n=r("kcIO"),a="sf",s=!1;function c(e){s=e}function l(e,t,r,i){var a="object"==typeof t;t=(t=a?"Ошибка соединения с сервером":t)||"Неизвестная ошибка",a&&s||Object(n.showDoneBox)(t);var c=r+": "+JSON.stringify(t);o.logError(e,c,i)}function d(e,t){return e+"_"+t}function u(e){return d(e.receiverId,e.id)}function p(e,t){return e.map((function(e){return _(e,t)}))}function _(e,t){return e.decision&&(e.decision.typeId=t(e)),e}function h(e,t,r){var i={};return e.forEach((function(e){var o=u(e);if(t[o])i[o]=t[o];else{var n={};r.forEach((function(e){return n[e.decisionTypeId]=!1})),i[o]=n}})),i}function m(e,t){return v(e,t.receiverId,t.id)}function v(e,t,r){return e.receiverId===t&&e.id===r}!function(e){e[e.WallComment=1]="WallComment",e[e.Photo=2]="Photo",e[e.WallPost=3]="WallPost",e[e.VideoComment=4]="VideoComment",e[e.PhotoComment=5]="PhotoComment",e[e.Mail=6]="Mail",e[e.TopicComment=7]="TopicComment",e[e.Video=8]="Video",e[e.FriendRequest=9]="FriendRequest",e[e.GroupInvite=10]="GroupInvite",e[e.AppInvite=11]="AppInvite",e[e.MarketComment=14]="MarketComment",e[e.Story=15]="Story",e[e.Article=16]="Article",e[e.Poll=17]="Poll",e[e.GroupComments=18]="GroupComments"}(i||(i={}))},"60IB":function(e,t,r){"use strict";r.r(t),r.d(t,"triggerReactionsUpdate",(function(){return a}));var i=r("ha24"),o=r("pruO"),n=r("Kl2g"),a=function(e,t,r,a){var s=Object(i.parseLikeObjectId)(e);s&&s.objectType===o.SUPPORTED_OBJECT_TYPES.wall&&s.objectId?Object(n.emitEvent)(n.WallDataEvents.post_reactions_counts_update,{counts:t,isPrimaryLikeButtonClick:null==a?void 0:a.isPrimaryLikeButtonClick,postFullId:s.objectId,reactionIdState:r?{reactionId:r.id}:void 0}):s&&s.objectType===o.SUPPORTED_OBJECT_TYPES.wall_reply&&s.objectId?Object(n.emitEvent)(n.WallDataEvents.reply_reactions_counts_update,{counts:t,replyFullId:s.objectId,reactionIdState:r?{reactionId:r.id}:void 0}):console.warn("Unsupported reactions object update",e)}},"6qdA":function(e,t,r){"use strict";r.r(t),r.d(t,"NarrativeEditor",(function(){return D}));var i,o=r("q1tI"),n=r.n(o),a=r("6krn"),s=r("ppaw"),c=r("BiHW"),l=r("v+DW"),d=r("kcIO"),u=r("WfnU"),p=r("RlRI"),_=r("ZxpX"),h=(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),m=function(e){function t(t){var r=e.call(this,t)||this;return r.scrollContainerRef=n.a.createRef(),r}return h(t,e),t.prototype.getScrollContainer=function(){return this.scrollContainerRef.current},t.prototype.render=function(){var e=this.props,t=e.appearance,r=e.className,i=e.children;return n.a.createElement("div",{className:Object(_.classNames)("StoryArchiveGridContainer","StoryArchiveGridContainer--"+t,r),ref:this.scrollContainerRef},i)},t.defaultProps={className:""},t}(n.a.Component),v=r("4+be"),f=r("rJNF"),g=n.a.memo((function(e){var t=e.story,r=e.checked,i=void 0!==r&&r,o=e.selectable,a=void 0!==o&&o,c=e.draggable,l=void 0!==c&&c,d=e.className,u=void 0===d?"":d,p=e.appearance,h=void 0===p?s.EditorViewType.box:p,m=e.isEditingLinksAvailable,g=void 0!==m&&m,y=e.onToggleCheck,b=void 0===y?function(){}:y,w=e.onStoryLinkUpdate,k=void 0===w?function(){}:w,S=e.linkData,j=void 0===S?[]:S;return n.a.createElement("div",{className:Object(_.classNames)("StoryArchivePreview","StoryArchivePreview--"+h,u),onClick:function(){return b(t)},"data-id":t.rawId,style:{backgroundImage:"url("+t.preview+")"}},l&&n.a.createElement("div",{className:"StoryArchivePreview__draggableIcon"}),a&&n.a.createElement("div",{className:Object(_.classNames)("StoryArchivePreview__select",{"StoryArchivePreview__select--on":i})}),g&&n.a.createElement("div",{className:"StoryArchivePreview__linkBtnWrapper"},n.a.createElement("div",{className:"StoryArchivePreview__linkBtn",onClick:function(e){return function(e){Object(f.showStoryLinkEditorBox)({story:t,onStoryLinkUpdate:k,linkData:j}),e.stopPropagation()}(e)}},t.linkUrl?Object(v.getLang)("stories_edit_link"):Object(v.getLang)("stories_add_link"))))})),y=r("UCWv"),b=r("4PuL"),w=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),k=y.MAX_NARRATIVE_STORIES,S=function(e){function t(t){var r=e.call(this,t)||this;return r.onStoryToggle=function(e){var t=r.props.onToggleCheck,i=r.state.draggableStoryRawId;t&&(i!==e.rawId?t(e):r.setState({draggableStoryRawId:""}))},r.gridContainerRef=n.a.createRef(),r.gridRef=n.a.createRef(),r}return w(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.stories,i=t.appearance,o=t.selectedStoriesMap,a=t.selectType,c=t.className,l=t.isEditingLinksAvailable,d=t.onStoryLinkUpdate,u=t.linkData;return n.a.createElement(m,{className:Object(_.classNames)("StoryArchiveDraggableGrid",c),appearance:i,ref:this.gridContainerRef},n.a.createElement("div",{className:"StoryArchiveDraggableGrid__inner",ref:this.gridRef},r.map((function(t){var r=e.isSelectable(t);return n.a.createElement("div",{className:Object(_.classNames)("StoryArchiveDraggableGrid__story","StoryArchiveDraggableGrid__story--"+i),key:t.rawId},n.a.createElement(g,{className:"StoryArchiveDraggableGrid__storyPreview",appearance:i,story:t,draggable:!0,disable:a===s.GridSelectType.checkbox&&!r,checked:!!o[t.rawId],selectable:r,onToggleCheck:e.onStoryToggle,onStoryLinkUpdate:d,isEditingLinksAvailable:l,linkData:u}))}))))},t.prototype.isSelectable=function(e){var t=this.props,r=t.selectType,i=t.selectedStoriesMap,o=Object.keys(i).length;return!e.isUnavailable&&(!(r!==s.GridSelectType.checkbox||!(o<k||i[e.rawId]))||!(r!==s.GridSelectType.radio||!i[e.rawId]))},t.prototype.componentDidMount=function(){var e=this,t=this.props,r=t.onReorder,i=t.appearance,o=this.gridRef.current,n=this.getScrollContainer(),a={dragThreshold:0,onDragStart:function(t){var r=t.querySelector(".StoryArchiveDraggableGrid__storyPreview");if(r){var i=r.dataset.id;e.setState({draggableStoryRawId:i})}},onReorder:function(){var t=e.props.stories,i=document.querySelectorAll(".StoryArchiveDraggableGrid__storyPreview"),o=[];i.forEach((function(e){var r=e.getAttribute("data-id"),i=t.find((function(e){return e.rawId===r}));i&&o.push(i.rawId)})),r(o)}};n&&o&&(i===s.EditorViewType.box&&(a.wrapNode=n),this.sorter=new b.default(o,"",a))},t.prototype.componentWillUnmount=function(){this.sorter&&this.sorter.destroy()},t.prototype.getScrollContainer=function(){var e,t;return null===(t=null===(e=this.gridContainerRef)||void 0===e?void 0:e.current)||void 0===t?void 0:t.getScrollContainer()},t.defaultProps={useWindowScroll:!1},t}(n.a.Component),j=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),E=y.MAX_NARRATIVE_STORIES,O=function(e){function t(t){var r=e.call(this,t)||this;return r.gridContainerRef=n.a.createRef(),r}return j(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.stories,i=t.appearance,o=t.selectedStoriesMap,a=t.selectType,c=t.className,l=t.onToggleCheck,d=t.hint,u=t.isEditingLinksAvailable,p=t.onStoryLinkUpdate,h=t.linkData;return n.a.createElement(m,{className:Object(_.classNames)("StoryArchiveInfiniteGrid",c),appearance:i,ref:this.gridContainerRef},d&&n.a.createElement("div",{className:"StoryArchiveInfiniteGrid__hint"},d),n.a.createElement("div",{className:"StoryArchiveInfiniteGrid__inner"},r.map((function(t){var r=e.isSelectable(t);return n.a.createElement("div",{className:Object(_.classNames)("StoryArchiveInfiniteGrid__story","StoryArchiveInfiniteGrid__story--"+i),key:t.rawId},n.a.createElement(g,{appearance:i,story:t,draggable:!1,disable:a===s.GridSelectType.checkbox&&!r,checked:!!o[t.rawId],selectable:r,onToggleCheck:l,onStoryLinkUpdate:p,isEditingLinksAvailable:u,linkData:h}))}))))},t.prototype.isSelectable=function(e){var t=this.props,r=t.selectType,i=t.selectedStoriesMap,o=Object.keys(i).length;return!e.isUnavailable&&(!(r!==s.GridSelectType.checkbox||!(o<E||i[e.rawId]))||r===s.GridSelectType.radio)},t.defaultProps={isEditingLinksAvailable:!1},t}(n.a.Component),C=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),T=function(){return(T=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},L=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],a=0,s=n.length;a<s;a++,o++)i[o]=n[a];return i},I=function(e){function t(t){var r=e.call(this,t)||this;return r.onTabClick=function(e,t){r.setState({tabKey:t,selectedTabStoryIds:L(r.props.selectedStoryRawIds)})},r.onReorder=function(e){var t=r.props.onSelectedStoriesUpdate,i=r.getSelectedStoriesMap(),o=e.filter((function(e){return i[e]}));r.setState({selectedTabStoryIds:e}),t(o)},r.onStorySelectToggle=function(e){var t,i=r.props,o=i.selectedStoryRawIds,n=i.onSelectedStoriesUpdate,a=r.state,c=a.tabKey,l=a.selectedTabStoryIds,d=r.getSelectedStoriesMap();if(!l.length)return r.setState({selectedTabStoryIds:[e.rawId]}),void n([e.rawId]);if(d[e.rawId]){n(o.filter((function(t){return t!==e.rawId})))}else{var u=[],p=T(T({},d),((t={})[e.rawId]=e,t));if(c===s.EditorTabKey.selected)u=l.filter((function(e){return p[e]}));else if(c===s.EditorTabKey.all){if(l.includes(e.rawId))u=l.filter((function(e){return p[e]}));else u=L(l,[e.rawId]).filter((function(e){return p[e]})),r.setState({selectedTabStoryIds:L(l,[e.rawId])})}n(u)}},r.state={tabKey:t.selectedStoryRawIds.length?s.EditorTabKey.selected:s.EditorTabKey.all,selectedTabStoryIds:L(t.selectedStoryRawIds)},r}return C(t,e),t.prototype.render=function(){var e=this.props,t=e.selectedStoryRawIds,r=e.appearance,i=e.isEditingLinksAvailable,o=e.linkData,c=e.onStoryLinkUpdate,l=this.state.tabKey,d=this.getSelectedStoriesMap(),u=this.getAllStories();return n.a.createElement("div",{className:"NarrativeEditorSelectPanel"},n.a.createElement(p.default,{className:"NarrativeEditorSelectPanel__tabs",onTabClick:this.onTabClick,active:l},n.a.createElement("span",{key:s.EditorTabKey.selected},Object(a.getLang)("stories_narrative_editor_selected_tab"),t.length>0&&n.a.createElement("span",{className:"Tabs__desc"},t.length)),n.a.createElement("span",{key:s.EditorTabKey.all},Object(a.getLang)("stories_narrative_editor_all_tab"))),l===s.EditorTabKey.selected&&n.a.createElement(S,{className:Object(_.classNames)("NarrativeEditorSelectPanel__grid","NarrativeEditorSelectPanel__grid--"+r),appearance:r,stories:this.getSelectedTabStories(),onReorder:this.onReorder,onToggleCheck:this.onStorySelectToggle,selectedStoriesMap:d,selectType:s.GridSelectType.checkbox,onStoryLinkUpdate:c,isEditingLinksAvailable:i,linkData:o}),l===s.EditorTabKey.all&&n.a.createElement(O,{className:Object(_.classNames)("NarrativeEditorSelectPanel__grid","NarrativeEditorSelectPanel__grid--"+r),appearance:r,stories:u,onToggleCheck:this.onStorySelectToggle,selectedStoriesMap:d,selectType:s.GridSelectType.checkbox,onStoryLinkUpdate:c,isEditingLinksAvailable:i,linkData:o}))},t.prototype.getSelectedTabStories=function(){var e=this;return this.state.selectedTabStoryIds.map((function(t){return e.props.storyMap[t]}))},t.prototype.getAllStories=function(){var e=this;return this.props.storyRawIds.map((function(t){return e.props.storyMap[t]}))},t.prototype.getSelectedStoriesMap=function(){var e=this;return this.props.selectedStoryRawIds.reduce((function(t,r){return t[r]=e.props.storyMap[r],t}),{})},t.defaultProps={isEditingLinksAvailable:!1},t}(n.a.Component),N=r("4WSo"),B=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),x=function(e){function t(t){var r=e.call(this,t)||this;return r.getInputEl=function(){return r.nameInputRef&&r.nameInputRef.current},r.nameInputRef=n.a.createRef(),r}return B(t,e),t.prototype.render=function(){var e=this.props,t=e.name,r=e.onNameChange,i=e.selectedStoriesCount,o=e.coverUrl,s=e.onCoverClick,c=e.className,l=0===i,d="";return l||(d=Object(a.getLang)("stories_choose_cover")),n.a.createElement("div",{className:Object(_.classNames)("NarrativeEditorDataPanel",c)},n.a.createElement("div",{className:"NarrativeEditorDataPanel__preview"},n.a.createElement(N.NarrativeItemPreviewCover,{className:Object(_.classNames)("NarrativeEditorDataPanel__cover",{"NarrativeEditorDataPanel__cover--active":!l}),onClick:s,cover:o,title:d,extra:!l&&n.a.createElement("div",{className:"NarrativeEditorDataPanel__pencil"})}),n.a.createElement("span",{className:"NarrativeEditorDataPanel__name"},t||Object(a.getLang)("stories_narrative_name_full"))),n.a.createElement("div",{className:"NarrativeEditorDataPanel__form"},n.a.createElement("span",{className:"NarrativeEditorDataPanel__nameLabel"},Object(a.getLang)("stories_narrative_name")),n.a.createElement("input",{className:"NarrativeEditorDataPanel__nameInput",value:t,onChange:r,type:"text",placeholder:Object(a.getLang)("stories_enter_name"),maxLength:y.NARRATIVE_MAX_TITLE_LENGTH,ref:this.nameInputRef,autoFocus:!0}),i>0&&n.a.createElement("span",{className:"NarrativeEditorDataPanel__selectedStoryCount"},Object(a.getLang)("stories_selected_count",i))))},t}(n.a.Component),R=r("t7n3"),P=r("jmhT"),A=r("7ckd"),M=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),D=function(e){function t(t){var r=e.call(this,t)||this;return r.onSelectedStoriesUpdate=function(e){void 0===e&&(e=[]);var t=r.state.coverStoryId,i={selectedStoryRawIds:e};t&&e.includes(t)?e.length||(i.coverStoryId=""):i.coverStoryId=e[0]?e[0]:"",r.setState(i)},r.openCoverSelection=function(){var e=r.state.coverStoryId;e&&r.setState({unconfirmedCoverStoryId:e,section:s.EditorSectionType.cover})},r.cancelCoverSelection=function(){r.setState({unconfirmedCoverStoryId:"",section:s.EditorSectionType.main})},r.confirmSelectedCover=function(){var e=r.state.unconfirmedCoverStoryId;r.setState({coverStoryId:e,unconfirmedCoverStoryId:"",section:s.EditorSectionType.main})},r.toggleCover=function(e){var t=r.state.unconfirmedCoverStoryId,i=e.rawId;i!==t&&r.setState({unconfirmedCoverStoryId:i})},r.onNameChange=function(e){var t=e.target.value,i=Object(R.trim)(t)?t:"";r.setState({name:i})},r.close=function(e){r.props.onClose(e)},r.onSave=function(e){r.props.onSave(e)},r.getFooterButtons=function(){var e=r.props.type,t=r.state,i=t.selectedStoryRawIds,o=t.section,l=t.loading;return o===s.EditorSectionType.cover?[n.a.createElement(c.default,{key:"close",appearance:"tertiary",onClick:r.cancelCoverSelection},Object(a.getLang)("global_cancel")),n.a.createElement(u.default,{key:"save",onClick:r.confirmSelectedCover},Object(a.getLang)("global_save"))]:[n.a.createElement(c.default,{key:"close",appearance:"tertiary",onClick:function(){return r.close(!1)},disabled:l},Object(a.getLang)("global_cancel")),n.a.createElement(u.default,{loading:l,key:"save",onClick:r.save,disabled:0===i.length},e===s.EditorModeType.edit?Object(a.getLang)("global_save"):Object(a.getLang)("stories_create_narrative"))]},r.save=function(){var e=r.props,t=e.publishHash,i=e.editHash,o=e.type,n=r.state,c=n.coverStoryId,u=n.loading,p=r.getSelectedStories(),_=r.state.name,h=void 0===_?"":_,m=r.props.narrativeRawId;if(!u)if(h=Object(R.trim)(h)){if(c){var v="publish_narrative",f=t;o===s.EditorModeType.edit&&(v="edit_narrative",f=i);var g=c.split("_"),y=g[0],b=g[1],w={act:v,owner_id:y,title:h,cover_story_id:b,hash:f,stories:Object(A.prepareStoriesForPublishing)(p)};if(m){var k=m.split("_")[1];w.narrative_id=k}window.ajax.post("al_stories.php",w,{onDone:function(e){m||(m=y+"_"+e),r.onSave(m),r.close(!0),r.showDoneBox(m,h,o)},onFail:function(e){return Object(d.showDoneBox)(e||Object(a.getLang)("global_error")),!0},hideProgress:function(){r.setState({loading:!1})}}),r.setState({loading:!0})}}else r.dataPanelRef.current&&Object(l.notaBene)(r.dataPanelRef.current.getInputEl())},r.state={tabKey:t.activeTabKey,name:t.name,selectedStoryRawIds:t.selectedStoryRawIds,coverStoryId:t.coverStoryId?t.coverStoryId:t.selectedStoryRawIds.length?t.selectedStoryRawIds[0]:"",loading:!1,section:s.EditorSectionType.main},r.dataPanelRef=n.a.createRef(),r}return M(t,e),t.prototype.render=function(){return this.props.appearance===s.EditorViewType.box?n.a.createElement(P.BoxModal,{className:"NarrativeEditor NarrativeEditor--box",appearance:"blue",actionButtons:this.getFooterButtons(),title:this.getBoxTitle(),onClose:this.close,hasScroll:!1},this.renderInner()):n.a.createElement("div",{className:"NarrativeEditor NarrativeEditor--page",onClick:function(e){return e.preventDefault()}},this.renderInner(),n.a.createElement("div",{className:"NarrativeEditor__footer"},n.a.createElement("div",{className:"NarrativeEditor__footerControls"},this.getFooterButtons())))},t.prototype.renderInner=function(){var e,t=this.props,r=t.storyRawIds,i=t.storyMap,o=t.onStoryLinkUpdate,c=t.isEditingLinksAvailable,l=t.linkData,d=t.appearance,u=this.state,p=u.name,_=u.selectedStoryRawIds,h=u.coverStoryId,m=u.section,v=u.unconfirmedCoverStoryId,f=this.getSelectedStories(),g="";h&&(g=(null===(e=i[h])||void 0===e?void 0:e.preview)||"");var y={};return v&&(y[v]=i[v]),n.a.createElement("div",{className:"NarrativeEditor__inner"},m===s.EditorSectionType.main&&n.a.createElement(n.a.Fragment,null,n.a.createElement(x,{className:"NarrativeEditor__dataPanel",coverUrl:g,name:p,selectedStoriesCount:_.length,onNameChange:this.onNameChange,onCoverClick:this.openCoverSelection,ref:this.dataPanelRef}),n.a.createElement(I,{appearance:d,onSelectedStoriesUpdate:this.onSelectedStoriesUpdate,storyRawIds:r,selectedStoryRawIds:_,storyMap:i,linkData:l,isEditingLinksAvailable:c,onStoryLinkUpdate:o})),m===s.EditorSectionType.cover&&n.a.createElement(O,{appearance:s.EditorViewType.page,selectType:s.GridSelectType.radio,selectedStoriesMap:y,onToggleCheck:this.toggleCover,stories:f,hint:Object(a.getLang)("stories_choose_cover_hint")}))},t.prototype.getBoxTitle=function(){var e=this.props.type;return this.state.section===s.EditorSectionType.cover?Object(a.getLang)("stories_choose_cover_title"):e===s.EditorModeType.create?Object(a.getLang)("stories_creating_narrative"):Object(a.getLang)("stories_editing_narrative")},t.prototype.showDoneBox=function(e,t,r){var i=e.split("_"),o=i[0],n=i[1],c="if (!event.metaKey && !event.ctrlKey) { showNarrative("+Number(o)+", "+Number(n)+", 0, 'narrative"+e+"'); return false; }",l='\n      <div class="top_result_header">\n        '+(r===s.EditorModeType.create?Object(a.getLang)("stories_narrative_created"):Object(a.getLang)("stories_narrative_edited")).replace("{name}",'<a href="/narrative'+e+'" onclick="'+c+'">'+Object(R.clean)(t)+"</a>")+'\n      </div>\n      <a href="#" class="link" onclick="window.Likes.share(\'narrative'+e+"'); return false;\">"+Object(a.getLang)("stories_manage_share_narrative")+"</a>\n    ";Object(d.showDoneBox)(l)},t.prototype.getSelectedStories=function(){var e=this;return this.state.selectedStoryRawIds.map((function(t){return e.props.storyMap[t]}))},t.defaultProps={name:"",coverStoryId:"",type:s.EditorModeType.create,activeTabKey:s.EditorTabKey.selected,isEditingLinksAvailable:!1,appearance:s.EditorViewType.page},t}(n.a.Component)},"7ckd":function(e,t,r){"use strict";r.r(t),r.d(t,"reloadPage",(function(){return n})),r.d(t,"prepareStoriesForPublishing",(function(){return a}));var i=r("zxIV"),o=r("kcIO");function n(){window.boxQueue.hideAll();var e=document.querySelector("#box_layer_wrap"),t=document.querySelector("#box_loader");window.nav.reload({onDone:function(){},showProgress:function(){Object(i.show)(e),Object(i.show)(t),Object(o.boxRefreshCoords)(t)},hideProgress:function(){Object(i.hide)(e),Object(i.hide)(t)}})}function a(e){return JSON.stringify(e.map((function(e){return{raw_id:e.rawId,link_url:e.linkUrl,link_text:e.linkType}})))}},"976x":function(e,t,r){"use strict";r.r(t),r.d(t,"sections",(function(){return a})),r.d(t,"logEvent",(function(){return l})),r.d(t,"logError",(function(){return d})),r.d(t,"disableSections",(function(){return u})),r.d(t,"downloadLogsFile",(function(){return p}));var i=r("+tmx"),o=r("kcIO"),n=[],a={initialization:"Initialization",deinitialization:"Deinitialization",longPoll:"Long poll",subscriptions:"Subscriptions",settings:"Settings",privilegeSettings:"Privilege settings",reportsAmountCounter:"Reports amount counter",reports:"Reports",reportDecisions:"Report decisions",rendering:"Rendering",alarm:"Alarm",logger:"Logger",search:"Search",hotkeys:"Hotkeys",feed:"Feed"},s=[],c=(new Date).getTime();function l(e,t){_("message",e,t,function(e){switch(e){case a.initialization:return"#d4fde8";case a.deinitialization:return"#5d5f61";case a.longPoll:return"#735ce6";case a.subscriptions:return"#ffa000";case a.privilegeSettings:return"#ffc107";case a.settings:return"#4bb34b";case a.reportsAmountCounter:return"#b2deff";case a.reports:return"#5181b8";case a.reportDecisions:return"#63b9ba";case a.rendering:return"#faefd2";case a.alarm:return"#db3b3b";case a.logger:return"#aee6c9";case a.search:return"#6f7985";case a.hotkeys:return"#3dcc4b";case a.feed:return"#3dccff";default:return"#FFFFFF"}}(e))}function d(e,t,r){void 0===r&&(r=""),r&&(t=r+": "+t),_("error",e,t,"#f05c44")}function u(e){0!==e.length&&(l(a.logger,"Disabled log sections: "+JSON.stringify(e)),s=e)}function p(){if(0!==n.length){var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n.join("\n"))),e.setAttribute("download","sf_logs.txt"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}else Object(o.showDoneBox)("Новых логов нет")}function _(e,t,r,o){if(!s.includes(t)){var a="["+function(){var e=(new Date).getTime()-c;e/=i.SECOND;var t=Math.floor(e/3600),r=Math.floor(e/60%60),o=Math.floor(e-60*r),n=("0"+t).slice(-2),a=("0"+r).slice(-2),s=("0"+o).slice(-2),l=a+":"+s;t>0&&(l=n+":"+l);return l}()+"] ("+t+" "+e+"): "+r;console.log("%c "+a,"background: #222; color: "+o),function(e){n.push(e),n.length>=300&&(n=n.slice(100))}(a)}}},"9R94":function(e,t,r){"use strict";r.r(t);t.default=function(e,t){if(!e)throw new Error("Invariant failed")}},KHCB:function(e,t,r){"use strict";r.r(t),r.d(t,"Stories",(function(){return Pt}));var i,o=r("q1tI"),n=r.n(o),a=r("i8i4"),s=r.n(a),c=r("zxIV"),l=r("t7n3"),d={},u={},p=[],_=!1,h=!1;function m(e,t,r){var i=u[e];if(i)for(var o=0;o<i.length;o++){var n=i[o];t?n.resolve(r):n.reject(),i.splice(o,1),o--}}function v(e){_&&_.postMessage({cmd:"load",url:e})}function f(e){return _||((_=new Worker("/js/cmodules/workers/stories_loader_worker.js")).onmessage=function(e){var t=e.data;switch(t.type){case"loaded":d[t.url]=t.data,m(t.url,!0,t.data);break;case"error":m(t.url,!1);break;case"inited":h=!0;for(var r=0;r<p.length;r++)v(p[r])}}),new Promise((function(t,r){if(e||t(""),d[e])return t(d[e]);switch(function(e){return e.match(/\.mp4/)?"video":e.match(/\.(png|jpg|jpeg|gif)/)?"image":void 0}(e)){case"video":case"image":u[e]||(u[e]=[]);var i=0===u[e].length;if(u[e].push({resolve:t,reject:r}),!i)return;h?v(e):p.push(e);break;default:window.vk.dev&&console.error("wrong media url")}}))}function g(e){var t;return i||(t=function(e){try{if(e.contentDocument)return e.contentDocument;if(e.contentWindow&&e.contentWindow.document)return e.contentWindow.document}catch(e){}return!1}(window.utilsNode.appendChild(document.createElement("iframe"))),i=t&&t.body?t.body:window.utilsNode.appendChild(Object(c.ce)("div",{},{display:"none"}))),e.match(/\.mp4/)?function(e){return new Promise((function(t,r){var o=Object(c.ce)("video",{});o.oncanplay=function(){t(),Object(c.re)(o)},o.onerror=function(){r(),Object(c.re)(o)},i.appendChild(o),o.src=e}))}(e):function(e){return new Promise((function(t,r){var o=Object(l.vkImage)();o.onload=function(){t(),Object(c.re)(o)},o.onerror=function(){r(),Object(c.re)(o)},i.appendChild(o),o.src=e}))}(e)}var y=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],a=0,s=n.length;a<s;a++,o++)i[o]=n[a];return i};function b(){var e=window.ls.get("video_volume");return"number"==typeof e?Math.min(1,Math.max(0,e)):1}function w(e){window.ls.set("video_volume",e)}function k(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=[];return y(e).forEach((function(e){if(e)switch(typeof e){case"string":r.push(e);break;case"object":Object.keys(e).forEach((function(t){e[t]&&r.push(t)}));break;default:r.push(String(e))}})),r.join(" ")}var S=r("ErRf"),j=r("Egk5"),E=[],O=function(){window.cur.storyLayer&&window.cur.storyLayer.onVisibilityChange()},C=function(){window.cur.storyLayer&&window.cur.storyLayer.onResize()},T=function(e){window.cur.storyLayer&&window.cur.storyLayer.onKeyDown(e)},L=function(e){window.cur.storyLayer&&window.cur.storyLayer.onKeyUp(e)};function I(e,t){window.cur.storyLayer&&window.cur.storyLayer.pauseLayer(),Object(c.ge)("stories_layers_background")||(document.body.appendChild(Object(c.ce)("div",{id:"stories_layers_background",className:"stories_layers_background"})),window.layerQueue.hide(),window.layerQueue.push(),window.layers.fullhide=B,Object(j.addEvent)(window,"visibilitychange",O,void 0,void 0,!0),Object(j.addEvent)(window,"resize",C),Object(j.addEvent)(document,"keydown",T),Object(j.addEvent)(document,"keyup",L)),window.cur.storyLayer=e,e.animateStory("expand",t.fromEl).catch((function(){})),E.push(e),Object(c.addClass)(document.body,"stories_layer_shown"),Object(S.cancelStackPush)("stories_layer_close"+E.length,(function(t){void 0===t&&(t={}),t.byTimer?e.sendNavigationStatEvents("close_auto_by_time"):e.sendNavigationStatEvents("close_tap"),E.length>1&&!t.isCloseBtnClick?e.back():(e.hideAllLayers=t.isCloseBtnClick,e.hide(!1))}))}function N(){E.length>1?E[E.length-2].setLayerVisibility(!0):Object(c.setStyle)("stories_layers_background","opacity",0)}function B(e){void 0===e&&(e=!1);for(var t=0;t<E.length;t++)E[t].hide(!0);if(window.layers.fullhide=!1,Object(c.removeClass)(document.body,"stories_layer_shown"),Object(c.re)("stories_layers_background"),Object(j.removeEvent)(window,"visibilitychange",O),Object(j.removeEvent)(window,"resize",C),Object(j.removeEvent)(document,"keydown",T),Object(j.removeEvent)(document,"keyup",L),e){var r=window.nav.objLoc;delete r.w,window.nav.setLoc(r)}window.cur.needUpdateFeedStories&&window.Stories.updateFeedStories(),E=[]}function x(){return E[E.length-2]}function R(e){for(var t=0;t<E.length;t++)E[t].onReplyDeleted(e)}window.LayersX=E;var P,A=r("UCWv"),M=r("nAFc"),D=r("ZxpX"),F=r("6krn"),H=r("XuKo"),V=r("/PiP"),U=r("pp2G"),K=r("rEJs"),W=r("EasH"),G=r("Xrg9"),q=(P=function(e,t){return(P=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}P(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),z=function(){return(z=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},Q=function(e){function t(t){var r=e.call(this,t)||this;return r.componentDidMount=function(){var e=r.props,t=e.sticker,i=e.story;t.audioRestriction&&i.data.needMute&&i.video&&(i.video.muted=!0),r.playlist.on(r,K.events.ADDED,(function(){r.props.showMessage(Object(F.getLang)("stories_audio_added")),r.props.playStory()})),r.playlist.on(r,K.events.REMOVED,(function(){r.props.showMessage(Object(F.getLang)("stories_audio_deleted")),r.props.playStory()}))},r.componentWillUnmount=function(){r.playlist.off(r)},r.render=function(){var e,t,i=r.props,o=i.story,a=i.sticker,s=o.data.needMute,c=a.audioRestriction,l=(e=A.StickerTypes,t={},Object.keys(e).forEach((function(r){t[e[r]]=r})),t),d=G.default.get("story_show_clickable_zones"),u=Object(D.classNames)("StorySticker",{"StorySticker--clickableZones":d});return n.a.createElement(n.a.Fragment,null,n.a.createElement("div",{"data-type":l[a.type],className:u,style:r.getStickerStyle(),onMouseDown:function(e){return r.props.onMouseDownHandle(e)},onMouseUp:function(e){return r.props.onMouseUpHandle(e,(function(){return r.handleClick(e)}))}}),c&&s&&r.renderRestriction())},r.renderRestriction=function(){var e=r.props.sticker.audioRestriction;return e?n.a.createElement("div",{className:"StoryRestriction"},n.a.createElement("div",{className:"StoryRestriction__inner"},n.a.createElement("span",{className:"StoryRestriction__title"},e.title),e.buttonUrl&&n.a.createElement("a",{className:"StoryRestriction__link",href:e.buttonUrl},e.buttonText))):null},r.getStickerStyle=function(){var e=r.props,t=e.sticker,i=e.originalWidth,o=e.originalHeight,n=e.widthViewBox,a=e.heightViewBox,s=n,c=a;return a/n>1.77?s=i*a/o:c=o*n/i,{top:t.top*c-(c-a)/2,left:t.left*s-(s-n)/2,width:t.width*s,height:t.height*c,transform:"rotate("+t.rotate+"deg)"}},r.handleClick=function(e){switch(r.props.sticker.type){case A.StickerTypes.hashtag:r.handleClickHashtag(e);break;case A.StickerTypes.mention:r.handleClickMention(e);break;case A.StickerTypes.question:r.handleClickQuestion();break;case A.StickerTypes.place:r.handleClickPlace(e);break;case A.StickerTypes.music:r.handleClickMusic(e);break;case A.StickerTypes.marketItem:r.handleClickMarketItem(e);break;case A.StickerTypes.storyReply:r.handleClickStoryReply(e);break;case A.StickerTypes.owner:r.handleClickOwner(e);break;case A.StickerTypes.link:r.handleClickLink(e);break;case A.StickerTypes.post:r.handleClickPost(e);break;case A.StickerTypes.poll:r.handleClickPoll();break;case A.StickerTypes.app:r.handleClickApp();break;case A.StickerTypes.sticker:r.handleClickSticker(e);break;case A.StickerTypes.situationalTheme:r.handleClickStickerSituationalTheme()}},r.handleClickHashtag=function(e){var t=r.props.sticker.hashtag.replace("#","%23"),i=Object(F.getLang)("stories_show_hashtag_link"),o=n.a.createElement("a",{href:"/feed?q="+t+"&section=search",onClick:function(){return r.onClickToTooltip("hashtag")},target:"_blank",className:"StoriesTooltip__link"},i);r.props.toggleTooltip(e,o),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"hashtag"}})},r.handleClickMention=function(e){var t=r.props.sticker,i=t.mentionedOwnerHref,o=t.mentionedText,a=t.mentionedPhotoUrl,s=n.a.createElement("a",{href:i,onClick:function(){return r.onClickToTooltip("mention")},target:"_blank",className:"StoriesTooltip__link StoriesTooltip__link--mention"},n.a.createElement("div",{className:"StoriesTooltipMention"},n.a.createElement("div",{className:"StoriesTooltipMention__avatar",style:{backgroundImage:"url("+a+")"}}),n.a.createElement("span",{className:"StoriesTooltipMention__text"},Object(M.decodeHTMLEntities)(o))));r.props.toggleTooltip(e,s),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"mention"}})},r.handleClickQuestion=function(){r.props.showQuestionModal(),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"question"}})},r.handleClickPlace=function(e){var t=r.props,i=t.sticker,o=t.list,a=i.placeId,s=Object(F.getLang)("stories_go_to_place");if(window.layerQueue.count()||o.includes("archive")){var c="/feed?section=search&w=place"+a,l=n.a.createElement("a",{href:""+c,onClick:function(){return r.onClickToTooltip("place")},target:"_blank",className:"StoriesTooltip__link"},s);r.props.toggleTooltip(e,l)}else{l=n.a.createElement("div",{className:"StoriesTooltip__link",onClick:function(){r.onClickToTooltip("place"),window.layerQueue.count()?window.layerQueue.pop():window.layerQueue.push(),Object(V.showWiki)({w:"place"+a})}},s);r.props.toggleTooltip(e,l)}r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:i.id,type:"place"}})},r.handleClickMusic=function(e){var t=r.props,i=t.story,o=t.sticker,a=i.data.needMute,s=o.audioId,c=o.audioData;if(o.audioRestriction)a||U.AudioUtils.showAudioRestriction(JSON.parse(c),{onShow:function(){r.props.pauseStory()},onHide:function(){r.props.playStory()}});else{var l="added"===(U.AudioUtils.getAddRestoreInfo()[s]||{}).state?"stories_audio_delete":"stories_audio_add",d=n.a.createElement("ul",{className:"StoriesTooltipActions _audio_row","data-audio":c},n.a.createElement("li",{className:"StoriesTooltipActions__item",onClick:r.addAudio},Object(F.getLang)(l)),n.a.createElement("li",{className:"StoriesTooltipActions__item",onClick:r.setNext},Object(F.getLang)("stories_audio_next_audio")));r.props.toggleTooltip(e,d,"b"),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:o.id,type:"music"}})}},r.handleClickMarketItem=function(e){var t=r.props.sticker,i=t.photoUrl,o=t.link,a=t.isRestricted,s="market_item",c=a?{onClick:function(){Object(W.showFastBox)(Object(F.getLang)("stories_market_access_error_title"),Object(F.getLang)("stories_market_access_error_text")),r.onClickToTooltip(s)}}:{onClick:function(){return r.onClickToTooltip(s)},href:o},l=n.a.createElement("a",z({},c,{target:"_blank",className:"StoriesTooltip__link"}),i&&!a?n.a.createElement("img",{className:"StoriesTooltip__marketItemThumb",src:i,alt:""}):n.a.createElement("div",{className:"StoriesTooltip__marketItemThumb StoriesTooltip__marketItemThumb--stub"}),n.a.createElement("span",{className:"StoriesTooltip__marketItemText"},Object(F.getLang)("stories_go_to_market_item")));r.props.toggleTooltip(e,l),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:s}})},r.handleClickStoryReply=function(e){var t=r.props,i=t.sticker,o=t.story,a=i.ownerId,s=i.storyId,c=(o.data.reply_to||{}).is_expired;if(c)r.handleClickOwner(e);else{var l=n.a.createElement("a",{className:"StoriesTooltip__link",onClick:function(){Object(H.showStory)("story"+a+"_"+s),r.onClickToTooltip("story_reply")}},Object(F.getLang)("stories_go_to_story"));r.props.toggleTooltip(e,l),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:i.id,type:"story_reply"}})}},r.handleClickOwner=function(e){var t=r.props.sticker,i=t.ownerId,o=t.link,a=i>0?Object(F.getLang)("stories_go_to_profile"):Object(F.getLang)("stories_go_to_group"),s=n.a.createElement("a",{href:o,target:"_blank",className:"StoriesTooltip__link"},a);r.props.toggleTooltip(e,s)},r.handleClickLink=function(e){var t=r.props.sticker,i=t.link,o=t.tooltipText,a=n.a.createElement("a",{href:i,onClick:function(){return r.onClickToTooltip("link")},target:"_blank",className:"StoriesTooltip__link"},o);r.props.toggleTooltip(e,a),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"link"}})},r.handleClickPost=function(e){var t=r.props.sticker,i=t.postOwnerId,o=t.postId,a=Object(F.getLang)("stories_go_to_post"),s=n.a.createElement("a",{href:"/wall"+i+"_"+o,onClick:function(){return r.onClickToTooltip("post")},target:"_blank",className:"StoriesTooltip__link"},a);r.props.toggleTooltip(e,s),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"post"}})},r.handleClickPoll=function(){var e=r.props.sticker.pollId;r.props.pauseStory();var t={act:"get_layout",voting_id:e,ref:"story",for_box:!0},i={containerClass:"story_poll",params:{hideButtons:!0,width:510,onDestroy:function(){r.props.playStory()}}};Object(W.showBox)("al_voting.php",t,i),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"poll"}})},r.handleClickApp=function(){r.props.markAppNotificationsSeen(r.props.sticker),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"app"}})},r.handleClickStickerSituationalTheme=function(){var e=r.props.sticker,t=e.situationalAppId,i=e.situationalThemeId;window.layerQueue.count()?window.layerQueue.pop():window.layerQueue.push(),r.props.pauseStory(),Object(V.showWiki)({w:"app"+t+"#"+i}),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"situational_theme"}})},r.addAudio=function(e){U.AudioUtils.addAudio(e.target,void 0,(function(){r.props.sendNavigationStatEvents("music_added",!0,{clickable_sticker:{id:r.props.sticker.id,type:"music"}})})),r.props.hideTooltip()},r.handleClickSticker=function(e){var t=r.props.sticker,i=t.stickerPackId,o=t.tooltipText,a=n.a.createElement("span",{onClick:r.onClickToStickerTooltip.bind(r,i),className:"StoriesTooltip__link"},o);r.props.toggleTooltip(e,a),r.props.sendNavigationStatEvents("click_on_clickable_sticker",!0,{clickable_sticker:{id:r.props.sticker.id,type:"sticker"}})},r.onClickToStickerTooltip=function(e,t){window.Emoji.previewSticker(e,r,!1,t),r.onClickToTooltip("sticker")},r.setNext=function(e){var t=JSON.parse(r.props.sticker.audioData||"{}"),i=U.AudioUtils.asObject(t);r.playlist.setNext(e.currentTarget.parentNode,i,t),r.playlist.pause(),r.props.hideTooltip(),r.props.playStory()},r.onClickToTooltip=function(e){r.props.sendNavigationStatEvents("click_to_tooltip",!0,{clickable_sticker:{id:r.props.sticker.id,type:e}})},r.playlist=Object(V.getAudioPlayer)(),r}return q(t,e),t}(n.a.Component),X=function(e){var t=e.clientX,r=void 0===t?0:t,i=e.clientY,o=void 0===i?0:i,a=e.position,c=void 0===a?"t":a,l=e.layerEl,d=e.children,u=Object(D.classNames)("StoriesTooltip","StoriesTooltip--"+c);return n.a.createElement(n.a.Fragment,null,s.a.createPortal(n.a.createElement("div",{className:u,style:{top:o,left:r}},d),l))},Y=r("WfnU"),$=r("GSQL"),J=r("BiHW"),Z=r("hN/p"),ee=r("FWc3"),te=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),re=function(e){function t(t){var r=e.call(this,t)||this;r.componentDidMount=function(){window.addEventListener("resize",r.handleResize)},r.componentWillUnmount=function(){window.removeEventListener("resize",r.handleResize)},r.componentDidUpdate=function(){r.askTextarea.current&&r.askTextarea.current.focus()},r.onDisableAreaMouseDown=function(e){r.props.onMouseDownHandle(e.target)},r.onDisableAreaMouseUp=function(e,t){void 0===t&&(t=function(){}),r.props.onMouseUpHandle(e.target,t)},r.render=function(){var e=r.props,t=e.story,i=e.storyData,n=e.author,a=e.layerEl,s=e.showMessage,c=e.playStory,l=e.pauseStory,d=e.list,u=e.sendNavigationStatEvents,p=e.markAppNotificationsSeen,_=i.clickable_stickers,h=_.stickers,m=_.original_width,v=_.original_height,f=r.state,g=f.widthViewBox,y=f.heightViewBox,b=f.showTooltip,w=f.position,k=f.tooltipContent,S=f.showQuestionModal,j=f.clientX,E=f.clientY;return o.createElement("div",{className:"StoryStickers"},o.createElement("div",{className:"StoryStickers__disableArea StoryStickers__disableArea--left",onMouseDown:r.onDisableAreaMouseDown,onMouseUp:r.onDisableAreaMouseUp}),o.createElement("div",{className:"StoryStickers__disableArea StoryStickers__disableArea--right",onMouseDown:r.onDisableAreaMouseDown,onMouseUp:r.onDisableAreaMouseUp}),h.map((function(e,i){return o.createElement(Q,{key:i,story:t,sticker:e,originalWidth:m,originalHeight:v,widthViewBox:g,heightViewBox:y,toggleTooltip:r.toggleTooltip,sendNavigationStatEvents:u,hideTooltip:r.hideTooltip,showQuestionModal:r.showQuestionModal,markAppNotificationsSeen:p,showMessage:s,playStory:c,pauseStory:l,list:d,onMouseDownHandle:r.onDisableAreaMouseDown,onMouseUpHandle:r.onDisableAreaMouseUp})})),b&&o.createElement(X,{clientX:j,clientY:E,layerEl:a,position:w},k),S&&o.createElement($.default,{title:Object(F.getLang)("stories_question_ask_box_title").replace("{name}",Object(M.decodeHTMLEntities)(n.name_get)),actionButtons:r.getQuestionModalActions(),className:"StoryQuestionAskForm",onClose:r.closeQuestionModal,appearance:"blue"},o.createElement("div",{className:"StoryQuestionAskForm__inner"},o.createElement("textarea",{ref:r.askTextarea,className:"StoryQuestionAskForm__textarea",maxLength:80,placeholder:Object(F.getLang)("stories_question_ask_placeholder"),onChange:r.handleChange,onKeyDown:r.handleKeyDown}))))},r.handleResize=function(){var e=Object(c.getSize)(r.props.el),t=e[0],i=e[1];r.setState({widthViewBox:t,heightViewBox:i,showTooltip:!1})},r.toggleTooltip=function(e,t,i){void 0===i&&(i="t"),e.preventDefault(),e.stopPropagation();var o=e.clientX,n=e.clientY,a=r.props,s=a.pauseStory,c=a.playStory,l=a.hideFeedbackTooltip,d=a.sendNavigationStatEvents;l(),r.setState({showTooltip:!r.state.showTooltip,tooltipContent:t,clientX:o,clientY:n,position:i}),setTimeout((function(){r.state.showTooltip?(d("click_on_clickable_sticker"),s()):c()}),0)},r.hideTooltip=function(){r.setState({showTooltip:!1})},r.isShownTooltip=function(){return r.state.showTooltip||r.state.showQuestionModal},r.showQuestionModal=function(){var e=r.props,t=e.storyData,i=e.showMessage,o=e.pauseStory,n=e.onModalShownChange;if(!t.can_ask)return i(Object(F.getLang)("stories_question_forbidden"));r.setState({showQuestionModal:!0}),r.hideTooltip(),n(!0),o()},r.closeQuestionModal=function(){var e=r.props,t=e.playStory,i=e.onModalShownChange;r.setState({showQuestionModal:!1}),i(!1),t()},r.handleChange=function(e){r.setState({questionText:e.target.value})},r.handleKeyDown=function(e){var t=r.state.questionText;Object(l.trim)(t)&&"keydown"===e.type&&(e.ctrlKey||e.metaKey)&&e.keyCode==j.KEY.RETURN&&r.sendQuestion()},r.resetAskText=function(){r.setState({questionText:""})},r.getQuestionModalActions=function(){var e=r.props.storyData.can_ask_anonymous,t=r.state,i=t.isQuestionButtonLoading,n=t.questionText,a=[{value:A.QUESTION_SELECT_MODE.AUTHOR_ONLY,label:Object(F.getLang)("stories_question_select_author_only")},{value:A.QUESTION_SELECT_MODE.PUBLIC,label:Object(F.getLang)("stories_question_select_public")}];return e&&a.splice(1,0,{value:A.QUESTION_SELECT_MODE.ANONYMOUS,label:Object(F.getLang)("stories_question_select_anonymous")}),o.createElement("div",{className:"StoryQuestionAskForm__footer"},o.createElement("div",{className:"StoryQuestionAskForm__cell StoryQuestionAskForm__cell--select"},o.createElement(Z.default,{value:r.state.selected,options:a,onChange:r.onSelectChange,onShow:r.onSelectShow,onHide:r.onSelectHide})),o.createElement("div",{className:"StoryQuestionAskForm__cell"},o.createElement(J.default,{key:"b",appearance:"tertiary",onClick:r.closeQuestionModal},Object(F.getLang)("global_cancel")),o.createElement(Y.default,{key:"s",loading:i,disabled:!Object(l.trim)(n),onClick:r.sendQuestion},Object(F.getLang)("stories_question_reply_send"))))},r.onSelectChange=function(e){r.setState({selected:Number(e.selected.value)})},r.onSelectShow=function(){var e=r.props,t=e.storyData,i=e.author,o=t.can_ask_anonymous,n=document.querySelector(".StoryQuestionAskForm__cell--select");if(n){var a=o?"stories_question_about_user_tooltip":"stories_question_about_user_tooltip_without_anon",s=o?"stories_question_about_group_tooltip":"stories_question_about_group_tooltip_without_anon",c="";c=i.id>0?Object(F.getLang)(a).replace(/{name}/g,Object(M.decodeHTMLEntities)(i.firstName)):Object(F.getLang)(s),Object(ee.showTooltip)(n,{text:c,width:350,slideX:15,className:"",nohide:!0,asrtl:!0,shift:[350,-15],dir:"left",showdt:1e3})}},r.onSelectHide=function(){var e=document.querySelector(".StoryQuestionAskForm__cell--select");e&&e.tt&&e.tt.destroy()},r.sendQuestion=function(){var e=r.state.questionText,t=r.props,i=t.showMessage,o=t.storyData,n=t.author,a=t.sendNavigationStatEvents,s=o.raw_id,c=o.askQuestionHash,l=o.accessKey,d=s.split("_"),u=d[0],p=d[1],_=!1,h=!1;r.state.selected===A.QUESTION_SELECT_MODE.PUBLIC?_=!0:r.state.selected===A.QUESTION_SELECT_MODE.ANONYMOUS&&(h=!0),window.ajax.post("al_stories.php",{act:"ask_question",story_owner_id:u,story_id:p,question_text:e,is_anonymous:+h,with_mention:+_,hash:c,access_key:l},{onDone:function(){switch(r.closeQuestionModal(),r.resetAskText(),i(Object(F.getLang)("stories_question_sent").replace("{name}",n.first_name_ins)),r.state.selected){case A.QUESTION_SELECT_MODE.PUBLIC:a("question_reply_publish");break;case A.QUESTION_SELECT_MODE.AUTHOR_ONLY:a("question_reply");break;case A.QUESTION_SELECT_MODE.ANONYMOUS:a("question_reply_anonymous")}},onFail:function(e){return r.closeQuestionModal(),r.resetAskText(),i(e),!0},showProgress:function(){return r.setState({isQuestionButtonLoading:!0})},hideProgress:function(){return r.setState({isQuestionButtonLoading:!1})}})};var i=Object(c.getSize)(r.props.el),n=i[0],a=i[1];return r.askTextarea=o.createRef(),r.state={widthViewBox:n,heightViewBox:a,clientX:0,clientY:0,showTooltip:!1,tooltipContent:"",position:"t",showQuestionModal:!1,isQuestionButtonLoading:!1,selected:A.QUESTION_SELECT_MODE.AUTHOR_ONLY,questionText:""},r}return te(t,e),t}(o.Component),ie=r("qrY5"),oe=r("RbYe"),ne=r("kcIO"),ae=r("W9Tc"),se=function(e){var t=e.story;if(!t.getCurStoryData())return null;var r,i=function(e){var t=e.getCurStoryData(),r=[];if(!t)return r;var i=t.raw_id,o=t.can_hide_reply,n=t.report_hash,a=t.can_remove,s=t.narrative,c=t.narrative_prepared,d=t.isAds,u=t.canMarkNotInterested,p=e.data.can_blacklist,_=i.split("_").map((function(e){return Object(l.intval)(e)})),h=_[0],m=_[1];h===window.vk.id||!p||s||d||r.push({label:Object(F.getLang)("stories_add_blacklist_button"),onClick:function(){return e.addToBlacklist()}});u&&r.push({label:Object(F.getLang)("stories_mark_not_interested"),onClick:function(t){var r,i=new MouseEvent("mouseout",{bubbles:!0});null===(r=t.nativeEvent.target)||void 0===r||r.dispatchEvent(i),e.markNotInterested()}});o&&r.push({label:Object(F.getLang)("stories_hide_reply_button"),onClick:function(){return e.hideReply()}});s&&(r.push({label:s.is_bookmarked?Object(F.getLang)("stories_narrative_remove_bookmark_button"):Object(F.getLang)("stories_narrative_add_bookmark_button"),onClick:function(){return e.sendNarrativeBookmarkButtonDidPress()}}),r.push({label:Object(F.getLang)("stories_narrative_copy_link"),onClick:function(){var e=location.protocol+"//"+location.host+"/narrative"+h+"_"+s.id+"_"+m;Object(oe.copyToClipboard)(e),Object(ne.showDoneBox)(Object(F.getLang)("stories_narrative_copy_link_done"))}}));(null==s?void 0:s.can_edit)&&(Object(ae.partConfigEnabled)("narratives_new")&&(i===c.coverStoryRawId?r.push({label:Object(F.getLang)("stories_story_is_cover_narrative")}):r.push({label:Object(F.getLang)("stories_set_cover_narrative"),onClick:function(){return e.setStoryAsCover()}})),r.push({label:Object(F.getLang)("stories_narrative_edit_button"),onClick:function(){return e.sendNarrativeEditButtonDidPress()}}));a&&Object(ae.partConfigEnabled)("narratives_new")&&s&&r.push({label:Object(F.getLang)("stories_remove_from_narrative"),onClick:function(){return e.removeStoryFromNarrative()}});a&&(Object(ae.partConfigEnabled)("narratives_new")||e.getOwnerId()<0)&&r.push({label:s?Object(F.getLang)("global_narrative_delete"):Object(F.getLang)("global_delete"),onClick:function(){return s?e.removeNarrativeBox():e.removeStoryBox()}});n&&r.push({label:Object(F.getLang)("stories_report"),onClick:function(){return e.report()}});h===window.vk.id||s||r.push({label:Object(F.getLang)("stories_settings"),onClick:function(){return window.Stories.showBlackList()}});return r}(t);if(0===i.length)return null;var o=n.a.createRef();return n.a.createElement("div",{className:"stories_button more ui_actions_menu_wrap _ui_menu_wrap ui_actions_menu_top stories_actions",onMouseEnter:function(e){clearTimeout(r),t.pauseStory(),ie.default.show(o.current,e)},onMouseLeave:function(){ie.default.hide(o.current),clearTimeout(r),r=setTimeout((function(){return t.autoResumeStory()}),300)},ref:o},n.a.createElement("div",{className:"ui_actions_menu _ui_menu"},i.map((function(e){var t=e.label,r=e.onClick;return n.a.createElement("div",{key:t,className:"ui_actions_menu_item",onClick:r},t)}))))};var ce=r("3blr"),le=function(e){var t=e.title,r=e.subtitle,i=e.appearance,o=void 0===i?"preview":i;return n.a.createElement("div",{className:"InfoAside InfoAside--"+o},n.a.createElement("div",{className:"InfoAside__image"}),n.a.createElement("div",{className:"InfoAside__description"},n.a.createElement("span",{className:"InfoAside__title"},t),n.a.createElement("span",{className:"InfoAside__subtitle"},r)))},de=r("yuXj"),ue=r("W8yn"),pe=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),_e=function(e){function t(t){var r=e.call(this,t)||this;return r.componentDidMount=function(){var e=r.questionTextEl.current;e&&r.adjustQuestionTextSize(e)},r.componentDidUpdate=function(){r.replyTextareaEl.current&&r.replyTextareaEl.current.focus()},r.render=function(){var e=r.state,t=e.isOpenReplyModal,i=e.replyText,o=e.isOpenReportModal,a=e.reportReasons,s=r.props,c=s.question,l=s.storyUrl,d=c.author,u=c.canAnswer,p=c.text,_=Object(M.decodeHTMLEntities)(p),h=Object(D.classNames)("StoryQuestion__title",{"StoryQuestion__title--free":!u});return n.a.createElement("div",{className:"StoryQuestion"},n.a.createElement("div",{className:"StoryQuestion__content"},r.renderAuthor(),n.a.createElement("span",{className:h,title:_,ref:r.questionTextEl},_)),n.a.createElement("div",{className:"StoryQuestion__controls"},u&&n.a.createElement(J.default,{className:"StoryQuestion__reply",appearance:c.isPublished?"secondary":"primary",size:"s",wide:!0,onClick:r.openReplyModal},Object(F.getLang)("stories_question_reply"))),t&&n.a.createElement($.default,{title:Object(F.getLang)("stories_question_reply_box_title").replace("{name}",Object(M.decodeHTMLEntities)(d.nameDat)),actionButtons:r.getReplyModalActions(),className:"StoryQuestion__replyModal",onClose:r.closeReplyModal,appearance:"blue"},n.a.createElement("div",{className:"StoryQuestion__inner"},n.a.createElement("textarea",{ref:r.replyTextareaEl,className:"StoryQuestion__textarea",placeholder:Object(F.getLang)("stories_question_reply_placeholder"),onChange:r.handleChange,onKeyDown:r.handleKeyDown,value:i}),n.a.createElement("img",{srcSet:l,className:"StoryQuestion__image"}))),o&&n.a.createElement($.default,{title:Object(F.getLang)("stories_question_report_title"),actionButtons:r.getReportModalActions(),className:"StoryQuestionReportForm",onClose:r.closeReportModal,appearance:"blue"},n.a.createElement("div",{className:"StoryQuestionReportForm__content"},n.a.createElement("h4",{className:"StoryQuestionReportForm__title"},Object(F.getLang)("stories_question_report_reason")),n.a.createElement("div",{className:"StoryQuestionReportForm__items"},!a&&n.a.createElement(ce.default,{size:15}),a&&a.map((function(e,t){return n.a.createElement(ue.default,{key:e[0],name:"questionReport",value:e[0],defaultChecked:!t,onChange:function(){return r.handleReason(e[0])}},e[1])}))))))},r.renderAuthor=function(){var e=r.props.question,t=e.id,i=e.isAnonymous,o=e.author,a=Object(M.decodeHTMLEntities)(o.name);return n.a.createElement("div",{className:"StoryQuestion__header"},i&&n.a.createElement("span",{className:"StoryQuestion__author"},a),!i&&n.a.createElement("a",{href:o.link,className:"StoryQuestion__author",onClick:function(){return window.cur.storyLayer.sendNavigationStatEvents("question_go_to_author",!0,{questionId:t})}},a),n.a.createElement(de.default,{position:"b",align:"right",trigger:"hover",data:r.getActions()},n.a.createElement("a",{className:"StoryQuestion__actions"})))},r.getActions=function(){var e=r.props.question,t=r.state.isAuthorBan,i=[{text:Object(F.getLang)("stories_question_delete"),onClick:function(){return r.props.removeQuestion(e)}}];return e.canBlocked&&(t?i.push({text:Object(F.getLang)("stories_question_author_unban"),onClick:r.unbanAuthor}):i.push({text:Object(F.getLang)("stories_question_author_ban"),onClick:r.banAuthor}),i.push({text:Object(F.getLang)("stories_question_author_report"),onClick:r.openReportModal})),i},r.adjustQuestionTextSize=function(e){if(e.scrollHeight>e.offsetHeight){var t=getComputedStyle(e),i=parseInt(t.fontSize)-.5,o=i+2.5,n=Math.floor(parseInt(t.height)/o);i>10&&(e.setAttribute("style","font-size: "+i+"px; line-height: "+o+"px; -webkit-line-clamp: "+n+";"),setTimeout((function(){r.adjustQuestionTextSize(e)}),0))}},r.getReplyModalActions=function(){var e=r.state,t=e.isReplyButtonLoading,i=e.replyText;return[n.a.createElement(J.default,{key:"closeReplyModal",appearance:"tertiary",onClick:r.closeReplyModal},Object(F.getLang)("global_cancel")),n.a.createElement(Y.default,{key:"replySend",loading:t,disabled:!Object(l.trim)(i),onClick:r.sendReply},Object(F.getLang)("stories_question_reply_send"))]},r.openReplyModal=function(){r.setState({isOpenReplyModal:!0})},r.closeReplyModal=function(){r.setState({isOpenReplyModal:!1})},r.handleChange=function(e){r.setState({replyText:e.target.value})},r.handleKeyDown=function(e){var t=r.state.replyText;Object(l.trim)(t)&&"keydown"===e.type&&(e.ctrlKey||e.metaKey)&&e.keyCode==j.KEY.RETURN&&r.sendReply()},r.resetReplyText=function(){r.setState({replyText:""})},r.sendReply=function(){var e=r.state.replyText,t=r.props,i=t.question,o=t.showMessage,n=i.text,a=i.id,s=i.ownerId,c=i.storyOwnerId,d=i.storyId,u=i.sendHash,p=e+"\n\n🗣 "+Object(l.unclean)(n),_="story:"+c+"_"+d;window.ajax.post("al_im.php",{act:"a_send",msg:p,hash:u,media:_,to:s},{onDone:function(){r.closeReplyModal(),r.resetReplyText(),o(Object(F.getLang)("stories_answer_sent")),window.cur.storyLayer.sendNavigationStatEvents("question_send_message",!0,{questionId:a})},onFail:function(e){return r.closeReplyModal(),r.resetReplyText(),o(e),!0},showProgress:function(){return r.setState({isReplyButtonLoading:!0})},hideProgress:function(){return r.setState({isReplyButtonLoading:!1})}})},r.banAuthor=function(){var e=r.props,t=e.question,i=e.showMessage,o=t.storyOwnerId,n=t.storyId,a=t.id,s=t.banHash,c=t.isAnonymous;window.ajax.post("al_stories.php",{act:"ban_author_question",story_owner_id:o,story_id:n,question_id:a,ban_hash:s},{onDone:function(){r.setState({isAuthorBan:!0}),i(Object(F.getLang)("stories_question_author_blocked"));var e="question_ban_author";c&&(e="question_ban_anonymous_author"),window.cur.storyLayer.sendNavigationStatEvents(e,!0,{questionId:a})},onFail:function(e){return i(e),!0}})},r.unbanAuthor=function(){var e=r.props,t=e.question,i=e.showMessage,o=t.storyOwnerId,n=t.storyId,a=t.id,s=t.banHash;window.ajax.post("al_stories.php",{act:"unban_author_question",story_owner_id:o,story_id:n,question_id:a,ban_hash:s},{onDone:function(){r.setState({isAuthorBan:!1}),i(Object(F.getLang)("stories_question_author_unblocked"))},onFail:function(e){return i(e),!0}})},r.getReportModalActions=function(){var e=r.state,t=e.isReportButtonLoading,i=e.reportReasons;return[n.a.createElement(J.default,{key:"closeReplyModal",appearance:"tertiary",onClick:r.closeReportModal},Object(F.getLang)("global_cancel")),n.a.createElement(Y.default,{key:"reportSend",disabled:!i,loading:t,onClick:r.sendReport},Object(F.getLang)("stories_question_report_send"))]},r.openReportModal=function(){r.setState({isOpenReportModal:!0}),r.props.getReportReasons().then((function(e){r.setState({reportReasons:e})}),(function(e){r.closeReportModal(),r.props.showMessage(e)}))},r.closeReportModal=function(){r.setState({isOpenReportModal:!1})},r.handleReason=function(e){r.setState({selectReasons:e})},r.sendReport=function(){var e=r.props.question,t=e.storyOwnerId,i=e.id,o=e.reportHash;window.ajax.post("al_stories.php",{act:"question_report",story_owner_id:t,question_id:i,reason:r.state.selectReasons,report_hash:o},{onDone:function(){r.closeReportModal(),r.props.showMessage(Object(F.getLang)("stories_report_sent")),r.closeReportModal()},onFail:function(e){return r.props.showMessage(e),r.closeReportModal(),!0},showProgress:function(){return r.setState({isReportButtonLoading:!0})},hideProgress:function(){return r.setState({isReportButtonLoading:!1})}})},r.state={isAuthorBan:t.question.isOwnerBlocked,replyText:"",isOpenReplyModal:!1,isReplyButtonLoading:!1,isOpenReportModal:!1,isReportButtonLoading:!1,reportReasons:null,selectReasons:0},r.replyTextareaEl=n.a.createRef(),r.questionTextEl=n.a.createRef(),r}return pe(t,e),t}(n.a.Component),he=function(e){var t=e.title,r=e.additionalTitle;return n.a.createElement("div",{className:"FeedbackTitle"},n.a.createElement("span",{dangerouslySetInnerHTML:{__html:t}}),r&&n.a.createElement("span",{className:"FeedbackTitle__additional"},r))},me=function(e){var t=e.title,r=e.additionalTitle,i=e.needSeparator,o=void 0===i||i,a=e.className,s=e.children;return n.a.createElement("div",{className:Object(D.classNames)("FeedbackBaseBlock",a,{"FeedbackSeparator FeedbackSeparator--top":o})},n.a.createElement(he,{title:t,additionalTitle:r}),s)},ve=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),fe=function(e){function t(t){var r=e.call(this,t)||this;return r.componentDidMount=function(){var e=r.scrollElement.current;e&&e.addEventListener("wheel",r.questionsMouseWheel)},r.componentWillUnmount=function(){var e=r.positionElement.current;e&&e.removeEventListener("wheel",r.questionsMouseWheel)},r.questionsMouseWheel=function(e){e.preventDefault(),r.props.questions.items.length<=1||r.setPosition(Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX)},r.setPosition=function(e){var t=r.positionElement.current;if(t){var i=r.state.scrollBlockPosition,o=Object(c.getSize)(t)[0],n=Math.max(0,Math.min(i+e,t.scrollWidth-o));r.setState({scrollBlockPosition:n})}},r.removeQuestion=function(e){var t=e.storyOwnerId,i=e.storyId,o=e.id,n=e.removeHash;window.ajax.post("al_stories.php",{act:"remove_question",story_owner_id:t,story_id:i,question_id:o,remove_hash:n},{onDone:function(){r.props.sendNavigationStatEvents("question_delete",!0,{question_id:o}),r.props.questions.items.length?r.setPosition(0):r.props.onQuestionRemove(o)}})},r.getReportReasons=function(){return new Promise((function(e,t){r.reportReasons.length?e(r.reportReasons):window.ajax.post("al_stories.php",{act:"question_report_box"},{onDone:function(t){return r.reportReasons=t,e(r.reportReasons),!0},onFail:function(e){return t(e),!0}})}))},r.state={scrollBlockPosition:0},r.reportReasons=[],r.scrollElement=o.createRef(),r.positionElement=o.createRef(),r}return ve(t,e),t.prototype.render=function(){var e=this,t=this.props.questions,r=this.state.scrollBlockPosition,i=t.items;return o.createElement(me,{className:"FeedbackQuestionsBlock",title:t.title},o.createElement("div",{className:"FeedbackQuestionsBlock__questions"},o.createElement("div",{className:"FeedbackQuestionsBlock__wrapper",ref:this.scrollElement},o.createElement("div",{className:"FeedbackQuestionsBlock__items",style:{transform:"translateX(-"+r+"px)"},ref:this.positionElement},i.map((function(t,r){return o.createElement(_e,{question:t,storyUrl:e.props.storyUrl,showMessage:e.props.showMessage,removeQuestion:e.removeQuestion,getReportReasons:e.getReportReasons,key:r})}))))))},t}(o.Component),ge=r("n3cE"),ye=function(e){var t=e.stats,r=e.extendedStats,i=e.onExtendedStatsPreviewClick,o=e.onSettingsBtnClick,a=e.onPrivacyHintHide;return n.a.createElement(me,{className:"FeedbackStatsBlock",title:t.title},t.cells&&n.a.createElement("div",{className:"FeedbackTooltip__cells"},t.cells.map((function(e,t){return n.a.createElement("div",{className:"FeedbackTooltip__cell",key:t},n.a.createElement("div",{className:"FeedbackStatCounter",dangerouslySetInnerHTML:{__html:e.counter}}),n.a.createElement("div",{className:"FeedbackStatName"},e.name))}))),r&&n.a.createElement("div",{className:"FeedbackStatsBlock__extendedStatsPreview FeedbackSeparator FeedbackSeparator--top",onClick:i,role:"button"},n.a.createElement(le,{appearance:"preview",title:Object(F.getLang)("stories_detailed_stats"),subtitle:r.preview}),n.a.createElement("div",{className:"FeedbackStatsBlock__chevron"})),t.showPrivacyHint&&n.a.createElement("div",{className:"FeedbackStatsBlock__privacyHint FeedbackSeparator FeedbackSeparator--top"},Object(F.getLang)("stories_privacy_feedback_hint"),n.a.createElement("div",{className:"FeedbackStatsBlock__links"},n.a.createElement(ge.default,{href:"/settings?act=privacy",onClick:o},Object(F.getLang)("stories_go_to_settings")),n.a.createElement("span",{className:"dvd"}),n.a.createElement(ge.default,{onClick:a},Object(F.getLang)("global_hide_notify")))),t.showEmptyStatsPrivacyHint&&n.a.createElement("div",{className:"FeedbackStatsBlock__emptyStatsPrivacyHint"},n.a.createElement("div",{className:"FeedbackStatsBlock__emptyStatsPrivacyIcon"}),n.a.createElement("div",{className:"FeedbackStatsBlock__emptyStatsPrivacyText"},Object(F.getLang)("stories_privacy_empty_views_hint")),n.a.createElement("div",{className:"FeedbackStatsBlock__emptyStatsPrivacyLink"},n.a.createElement(ge.default,{href:"/settings?act=privacy",onClick:o},Object(F.getLang)("stories_go_to_settings")))))};function be(e){return e.items.some((function(e){return e.unread}))}var we,ke=function(e){var t=e.storyPack,r=e.listName,i=e.source;return n.a.createElement("a",{href:t.author.href,className:Object(D.classNames)("StoryReply",{"StoryReply--new":be(t)}),onClick:function(e){e.metaKey||e.ctrlKey||(Object(H.showStory)(t.author.id+"/"+r,{fromEl:e.target,source:i}),e.preventDefault())},role:"button"},n.a.createElement("div",{className:"StoryReply__avatar"},n.a.createElement("div",{className:"StoryReply__image",style:{backgroundImage:"url("+t.author.photo+")"}})),n.a.createElement("div",{className:"StoryReply__caption"},t.author.firstName))},Se=r("4+be"),je=function(e){var t=e.replies,r=e.showMore,i=t.list,o=Boolean(t.moreRepliesCount);return n.a.createElement(me,{className:"FeedbackRepliesBlock",title:t.title,additionalTitle:t.additionalTitle},n.a.createElement("div",{className:"FeedbackRepliesBlock__replies"},null==i?void 0:i.map((function(e){return n.a.createElement(ke,{storyPack:e,listName:t.listName,source:t.source,key:e.author.id})}))),o&&n.a.createElement(J.default,{className:"FeedbackRepliesBlock__showMore",appearance:"tertiary",onClick:r},Object(Se.langNumeric)(t.moreRepliesCount,Object(F.getLang)("stories_replies_more_button",!0))))};!function(e){e.photo="photo",e.gradient="gradient",e.default="default"}(we||(we={}));function Ee(e){var t="";if(e.type===we.photo)t="#"+e.backgroundColor;else if(e.type===we.gradient){t="linear-gradient("+(e.angle-90)+"deg, "+e.points.map((function(e){return"#"+e.color+" "+Math.round(100*e.position)+"%"})).join(", ")+")"}return t}function Oe(e){var t=e.ownerId,r=e.pollId;if(e.needShowResults)Object(V.showWiki)({w:"poll"+t+"_"+r},!1,void 0,{customRef:"story"});else{var i={act:"get_layout",voting_id:r,ref:"story",for_box:!0};Object(W.showBox)("al_voting.php",i,{containerClass:"story_poll",params:{hideButtons:!0,width:510}})}}var Ce,Te=function(e){var t=e.poll,r=function(e){var t=e.background;return n.a.createElement("div",{className:"PollSnippet__background",style:{background:Ee(t)}},t.type===we.photo&&n.a.createElement("div",{className:"PollSnippet__photo",style:{backgroundImage:"url("+t.photoUrl+")"}}))}(t);return n.a.createElement("div",{className:Object(D.classNames)("PollSnippet",{"PollSnippet--default":t.background.type===we.default})},r,n.a.createElement("div",{className:"PollSnippet__question"},t.question),n.a.createElement("div",{className:"PollSnippet__countVoters"},t.votersCountText),n.a.createElement("div",{className:"PollSnippet__showResult",onClick:Oe.bind(null,t)},Object(F.getLang)("stories_voting_show_result")))},Le=function(e){var t=e.poll;return n.a.createElement(me,{className:"FeedbackPollBlock",title:t.title},n.a.createElement("div",{className:"FeedbackPollBlock__poll"},n.a.createElement(Te,{poll:t.data})))},Ie=r("RXF5"),Ne=r("0+cD"),Be=function(e){var t=e.user;return n.a.createElement("a",{href:t.url,className:"Viewer",role:"button"},n.a.createElement(Ie.default,{className:Object(D.classNames)("Viewer__avatar",{"Viewer__avatar--isLiked":t.isLiked}),title:t.name,photo:t.photoUrl}),n.a.createElement(Ne.default,{className:"Viewer__name",isVerified:t.isVerified},Object(M.decodeHTMLEntities)(t.name)))},xe=function(e){var t=e.viewers,r=e.isLoading,i=void 0!==r&&r,o=e.needSeparator,a=void 0===o||o;return n.a.createElement(me,{className:"FeedbackViewersBlock",title:t.title,needSeparator:a},t.hiddenReason&&n.a.createElement("span",{className:"FeedbackViewersBlock__hiddenReason"},t.hiddenReason),n.a.createElement("div",{className:"FeedbackViewersBlock__items"},t.items.map((function(e,t){return n.a.createElement(Be,{user:e,key:t})}))),i&&n.a.createElement("div",{className:"FeedbackViewersBlock__spinner"},n.a.createElement(ce.default,{size:18,color:"#6590c7",strokeWidth:2})))},Re=r("BJj/"),Pe=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),Ae=function(e){function t(t){var r=e.call(this,t)||this;return r.onQuestionRemove=function(e){r.props.onQuestionRemove(e)},r.close=function(){r.props.toggleFeedbackTooltip(!1)},r.onSettingsBtnClick=function(){r.props.sendNavigationStatEvents("go_to_settings")},r.onPrivacyHintHide=function(){r.props.onPrivacyHintHide()},r.onExtendedStatsPreviewClick=function(){var e=r.props.sendNavigationStatEvents;r.unObserveViewerScroll(),r.unObserveTitleChanges(),r.setState({extendedStatsActive:!0}),e("open_advanced_statistic")},r.onBackBtnClick=function(){r.unObserveTitleChanges(),r.setState({extendedStatsActive:!1})},r.state={isViewersLoading:!1,extendedStatsActive:!1},r.mounted=!1,r.scrollContainerRef=n.a.createRef(),r.viewsSentinelRef=n.a.createRef(),r.titles=[],r.viewsObserver=null,r.activeHeader=null,r.onScrollHandler=null,r}return Pe(t,e),t.prototype.render=function(){var e=this.props,t=e.feedback,r=e.showMessage,i=e.sendNavigationStatEvents,o=e.storyImageUrl,a=e.showMoreReplies,s=e.needShowEmptyStats,c=this.state,l=c.isViewersLoading,d=c.extendedStatsActive,u=null==t?void 0:t.stats,p=null==u?void 0:u.extendedStats,_=null==t?void 0:t.replies,h=null==t?void 0:t.poll,m=null==t?void 0:t.questions,v=null==t?void 0:t.viewers;return n.a.createElement("div",{className:Object(D.classNames)("FeedbackTooltip",{"FeedbackTooltip--empty":s}),onClick:function(e){return e.stopPropagation()}},n.a.createElement("div",{className:"FeedbackTooltip__wrapper"},n.a.createElement("div",{className:"FeedbackTooltip__close",onClick:this.close}),!t&&n.a.createElement("div",{className:"FeedbackTooltip__spinner"},n.a.createElement(ce.default,{size:36,color:"#6590c7",strokeWidth:3})),t&&n.a.createElement(n.a.Fragment,null,!d&&n.a.createElement("div",{className:"FeedbackTooltip__inner",ref:this.scrollContainerRef},n.a.createElement("div",{className:"FeedbackTooltip__content"},u&&n.a.createElement(ye,{stats:u,extendedStats:p,onExtendedStatsPreviewClick:this.onExtendedStatsPreviewClick,onSettingsBtnClick:this.onSettingsBtnClick,onPrivacyHintHide:this.onPrivacyHintHide}),_&&n.a.createElement(je,{replies:_,showMore:a}),h&&n.a.createElement(Le,{poll:h}),m&&n.a.createElement(fe,{showMessage:r,storyUrl:o,questions:m,sendNavigationStatEvents:i,onQuestionRemove:this.onQuestionRemove}),v&&n.a.createElement(xe,{viewers:v,isLoading:l,needSeparator:!t.questions}),Boolean(null==v?void 0:v.nextFrom)&&n.a.createElement("div",{className:"FeedbackTooltip__sentinel",ref:this.viewsSentinelRef}))),p&&d&&n.a.createElement(n.a.Fragment,null,n.a.createElement("div",{className:"FeedbackTooltip__header FeedbackSeparator FeedbackSeparator--bottom"},n.a.createElement("div",{className:"FeedbackTooltip__back",onClick:this.onBackBtnClick},Object(F.getLang)("global_back")),Object(F.getLang)("stories_detailed_stats")),n.a.createElement("div",{className:"FeedbackTooltip__inner",ref:this.scrollContainerRef},n.a.createElement("div",{className:"FeedbackTooltip__content"},p.achievement&&n.a.createElement("div",{className:"FeedbackTooltip__achievement"},n.a.createElement(le,{appearance:"achievement",title:p.achievement,subtitle:p.achievementSubtitle})),p.categories.map((function(e,t){return n.a.createElement(me,{title:e.title,key:t},n.a.createElement("div",{className:"FeedbackTooltip__lines"},e.lines.map((function(e,t){return n.a.createElement("div",{className:"FeedbackTooltip__line",key:t},n.a.createElement("div",{className:"FeedbackStatName"},Object(M.decodeHTMLEntities)(e.name)),n.a.createElement("div",{className:"FeedbackStatCounter",dangerouslySetInnerHTML:{__html:e.counter}}))}))))}))))))))},t.prototype.componentDidMount=function(){var e=this,t=this.props,r=t.feedback,i=t.storyRawId,o=t.onFetchFeedbackData;if(this.mounted=!0,r)return this.observeTitleChanges(),void this.observeViewerScrollIfNeeded();window.ajax.post("al_stories.php",{act:"get_feedback",story_raw:i},{onDone:function(t){e.mounted&&o(t)},onFail:function(){return Object(W.showFastBox)(Object(F.getLang)("global_error"),Object(F.getLang)("global_unknown_error")),e.close(),!0}})},t.prototype.componentDidUpdate=function(e,t){!e.feedback&&this.props.feedback&&(this.observeTitleChanges(),this.observeViewerScrollIfNeeded()),!t.extendedStatsActive&&this.state.extendedStatsActive?this.observeTitleChanges():t.extendedStatsActive&&!this.state.extendedStatsActive&&(this.observeTitleChanges(),this.observeViewerScrollIfNeeded())},t.prototype.componentWillUnmount=function(){this.unObserveTitleChanges(),this.unObserveViewerScroll(),this.mounted=!1},t.prototype.loadViewers=function(){var e,t=this,r=this.props,i=r.storyRawId,o=r.feedback,n=r.onFetchViewers;this.state.isViewersLoading||(null===(e=null==o?void 0:o.viewers)||void 0===e?void 0:e.nextFrom)&&(this.setState({isViewersLoading:!0}),window.ajax.post("al_stories.php",{act:"get_viewers",story_raw:i,offset:o.viewers.nextFrom},{onDone:function(e){n(e),t.setState({isViewersLoading:!1})},onFail:function(){return Object(W.showFastBox)(Object(F.getLang)("global_error"),Object(F.getLang)("global_unknown_error")),t.setState({isViewersLoading:!1}),!0}}))},t.prototype.observeViewerScrollIfNeeded=function(){var e,t=this,r=this.props.feedback;if(null===(e=null==r?void 0:r.viewers)||void 0===e?void 0:e.nextFrom){var i=this.scrollContainerRef.current,o=this.viewsSentinelRef.current;if(!o)return;this.viewsObserver=new IntersectionObserver((function(e){e.forEach((function(e){e.intersectionRatio>0&&t.loadViewers()}))}),{threshold:[0,1],root:i,rootMargin:"0px 0px 336px 0px"}),this.viewsObserver.observe(o)}},t.prototype.unObserveViewerScroll=function(){this.viewsObserver&&this.viewsObserver.disconnect()},t.prototype.observeTitleChanges=function(){var e=this,t=this.scrollContainerRef.current;t&&(this.updateTitles(),this.onScrollHandler=Object(Re.debounce)((function(){!e.titles.some((function(t,r){if(t.offsetTop)return t===e.activeHeader||e.setActiveHeader(t),!0;if(e.titles[r+1]){var i=e.titles[r+1],o=e.titles[r+1].parentElement,n=o&&o.offsetHeight;return!!n&&(i.offsetTop+i.offsetHeight===n&&(t===e.activeHeader||e.setActiveHeader(t),!0))}return!1}))&&e.activeHeader&&(e.activeHeader.classList.remove("FeedbackTitle--active"),e.activeHeader=null)}),5),t.addEventListener("scroll",this.onScrollHandler))},t.prototype.updateTitles=function(){var e=this.scrollContainerRef.current;e&&(this.titles=Array.from(e.querySelectorAll(".FeedbackTitle")),this.titles.reverse())},t.prototype.unObserveTitleChanges=function(){this.scrollContainerRef.current&&this.onScrollHandler&&this.scrollContainerRef.current.removeEventListener("scroll",this.onScrollHandler),this.onScrollHandler=null,this.titles=[]},t.prototype.setActiveHeader=function(e){this.activeHeader&&this.activeHeader.classList.remove("FeedbackTitle--active"),this.activeHeader=e,e.classList.add("FeedbackTitle--active")},t}(n.a.Component),Me=r("pQ8y"),De=function(e){var t=e.story,r=t.getReplies(),i=t.getViews()||"",o=t.getCurStoryData();if(!o)return null;var a=o.can_manage,s=o.isNewQuestions,c=o.needShowEmptyStats,l=o.small_preview,d=!(!a||!i&&!c),u=t.isActiveLive(),p=t.getRawId(),_=t.isFeedbackTooltipShow,h=t.toggleFeedbackTooltip,m=t.onFetchFeedbackData,v=t.onFetchViewers,f=t.onQuestionRemove,g=t.feedback,y=t.showMoreReplies,b=t.onPrivacyHintHide;if(u||!i&&!r&&!c)return null;var w=t.showMessage.bind(t),k=t.layer.sendNavigationStatEvents.bind(t.layer),S="stories_button views _views_button";return(c||s)&&(S+=" stories_button_new_notify "+(s?"stories_button_new_questions":"stories_button_new_hint")),n.a.createElement("div",{className:S,onClick:function(e){h(),c&&k("open_empty_feedback"),e.stopPropagation()}},r&&n.a.createElement("div",{className:"stories_button_replies"},r),d&&n.a.createElement("div",{className:"stories_button_views"},i),n.a.createElement(Me.default,{in:_,timeout:200,classNames:{enter:"FeedbackTooltipTransitionWrapper--enter",enterActive:"FeedbackTooltipTransitionWrapper--enterActive",exit:"FeedbackTooltipTransitionWrapper--exit",exitActive:"FeedbackTooltipTransitionWrapper--exitActive"},unmountOnExit:!0},n.a.createElement(Ae,{feedback:g,storyRawId:p,storyImageUrl:l,toggleFeedbackTooltip:h,onFetchFeedbackData:m,onFetchViewers:v,showMessage:w,sendNavigationStatEvents:k,onQuestionRemove:f,showMoreReplies:y,onPrivacyHintHide:b,needShowEmptyStats:c})))},Fe=r("vzBJ"),He=function(e){var t=e.className,r=e.stickers,i=e.onStickerClick,o=function(e){Fe.StickersAnimation.loadAndPlaySticker(e.currentTarget)};return n.a.createElement("div",{className:Object(D.classNames)("ReactionsPanel",t)},n.a.createElement("div",{className:"ReactionsPanel__container"},n.a.createElement("div",{className:"ReactionsPanel__title"},Object(F.getLang)("stories_reactions_title")),n.a.createElement("div",{className:"ReactionsPanel__items"},r.map((function(e,t){return function(e,t){var r=!!e.animationUrl?"sticker_img":"";return n.a.createElement("div",{className:"ReactionsPanel__item","data-pack-id":e.packId,"data-sticker-id":e.id,"data-uniq-id":e.uniqId,"data-animation-path":e.animationUrl,"data-animation-class":"ReactionsPanel__itemAnimation",onMouseDown:function(){return i(e.id,t)},onMouseEnter:o,key:e.id},n.a.createElement("div",{className:Object(D.classNames)("ReactionsPanel__itemImage",r),style:{backgroundImage:"url("+e.imageUrl+")"}}))}(e,t)})))))},Ve=r("TxR4"),Ue=r("L7cl"),Ke=r("o7bv"),We=r("HLtZ"),Ge=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),qe=function(){return(qe=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},ze=function(e){function t(t){var r=e.call(this,t)||this;return r._onReactionClick=function(e,t){r._sendMessage([["sticker",e,""]],{sticker_referrer:"story_reaction"},{reactionName:A.EMOJI_REACTIONS_ARR[t].name})},r.addToNarrativePress=function(){r.props.story.onAddToNarrativeBtnClick()},r.emojiId=!1,r.state={story:t.story,sendFormHasText:!1,sendFormFocused:!1,linkObjectAudioPlaying:!1,isReactionsPanelShow:!1,reactionStickers:r._getReactionsStickers(),needAnimateLikeButton:!1},r.addToNarrativeRef=o.createRef(),r}return Ge(t,e),t.prototype.componentDidMount=function(){this.checkFeatureTooltip(),this.emojiInit()},t.prototype.checkFeatureTooltip=function(){var e=this.addToNarrativeRef.current;e&&this.props.story.showFeatureTooltipIfNeed(e)},t.prototype.componentWillUnmount=function(){this.emojiId&&(window.Emoji.destroy(this.emojiId),delete this.emojiId,window.cur.reactionFeatureTooltipTimeoutId&&(clearTimeout(window.cur.reactionFeatureTooltipTimeoutId),window.cur.reactionFeatureTooltipTimeoutId=null))},t.prototype.componentDidUpdate=function(){this.emojiInit()},t.prototype.render=function(){var e=this.props.story,t=this.props.story.getCurStoryData();if(!e.story||!t)return"";var r={left_side_empty:this._leftSideIsEmpty()},i=t.canLike,n=t.canAddToNarrative,a=this.state.reactionStickers;return o.createElement(o.Fragment,null,this.state.isReactionsPanelShow&&a.length>0&&o.createElement(He,{className:"stories_story_reactions",stickers:a,onStickerClick:this._onReactionClick}),o.createElement("div",{className:k("stories_story_bottom",r)},o.createElement("div",{className:"stories_story_bottom_controls",ref:"controls"},o.createElement(De,{story:e}),this._renderMessageForm(),this._renderLink(),n&&this.renderAddToNarrativeBtn(),i&&this._renderLike(),this._renderMask(),this._renderShare(),this._renderRemove(),o.createElement(se,{story:e}),this._renderAppButton())))},t.prototype._renderAppButton=function(){var e=this,t=this.props.story.getSticker(A.StickerTypes.app);if(t){var r="stories_button app _stories_button_app";return t.hasNewInteractions&&(r+=" has_new"),o.createElement("a",{target:"_blank",className:r,onClick:function(){return e.props.markAppNotificationsSeen(t)}})}},t.prototype._renderLink=function(){var e=this,t=this.props.story.getCurStoryData();if(!t)return Object(We.logError)(new Error("Fail: _renderLink"),{environment:"stories"}),"";var r=t.link;if(!Object(l.isObject)(r))return"";var i="stories_link";return r.object_type&&(i+=" story_link_object_"+r.object_type),this.state.linkObjectAudioPlaying&&(i+=" story_link_object_audio_playing"),o.createElement("div",{className:"stories_link_wrap"},o.createElement("a",{target:"_blank",rel:"noopener noreferrer",className:i,href:r.url,title:r.text,onClick:function(t){e.linkDidPress(t,r)}},o.createElement("span",{className:"stories_link__inner",dangerouslySetInnerHTML:{__html:r.text}})))},t.prototype._renderMask=function(){var e=this.props.story.getCurStoryData();return e?e.mask_id?o.createElement("div",{className:"stories_button mask _mask_button",onMouseOver:function(e){return Object(ee.showTooltip)(e.target,{black:1,center:1,shift:[1,13,0],text:Object(F.getLang)("stories_mask_tooltip")})},onClick:this._maskButtonDidPress.bind(this)}):"":(Object(We.logError)(new Error("Fail: _renderMask"),{environment:"stories"}),"")},t.prototype._renderShare=function(){var e=this.props.story.getCurStoryData();return e?e.can_share?o.createElement("div",{className:"stories_button share _share_button",onMouseOver:function(e){return Object(ee.showTooltip)(e.target,{black:1,center:1,shift:[1,13,0],text:Object(F.getLang)("stories_share")})},onClick:this._shareButtonDidPress.bind(this)}):"":(Object(We.logError)(new Error("Fail: _renderShare"),{environment:"stories"}),"")},t.prototype.renderAddToNarrativeBtn=function(){var e=this.props.story.getCurStoryData();return e?o.createElement("div",{className:k("stories_button stories_add_to_narrative",{"stories_button--addedToNarrative":e.isPartOfNarrative||e.narrative}),onMouseOver:function(e){return Object(ee.showTooltip)(e.target,{black:1,center:1,shift:[1,13,0],text:Object(F.getLang)("stories_add_to_narrative")})},onClick:this.addToNarrativePress,ref:this.addToNarrativeRef}):(Object(We.logError)(new Error("Fail: renderAddToNarrativeBtn"),{environment:"stories"}),"")},t.prototype._renderLike=function(){var e=this.props.story.getCurStoryData();if(!e)return Object(We.logError)(new Error("Fail: _renderLike"),{environment:"stories"}),"";var t=this.state.needAnimateLikeButton,r=e.isLiked;return o.createElement("div",{className:k("stories_button stories_like",{"stories_button--isLiked":r,"stories_button--animating":t}),onMouseOver:function(e){return Object(ee.showTooltip)(e.target,{black:1,center:1,shift:[1,13,0],text:Object(F.getLang)("stories_like")})},onClick:this._likeButtonDidPress.bind(this)})},t.prototype._renderRemove=function(){var e=this.props.story,t=e.getCurStoryData();return t?!t.can_remove||e.getOwnerId()<0||Object(ae.partConfigEnabled)("narratives_new")?"":o.createElement("div",{className:"stories_button remove _remove_button",onMouseOver:function(e){return Object(ee.showTooltip)(e.target,{black:1,center:1,shift:[1,13,0],text:Object(F.getLang)("global_delete")})},onClick:this._removeButtonDidPress.bind(this)}):(Object(We.logError)(new Error("Fail: _renderRemove"),{environment:"stories"}),"")},t.prototype._canMessage=function(){var e=this.props.story,t=e.getCurStoryData();if(!t)return Object(We.logError)(new Error("Fail: _canMessage"),{environment:"stories"}),!1;var r=t.link,i=t.can_comment;return!(Object(l.isObject)(r)||!i||e.isLiveEnded())},t.prototype._renderMessageForm=function(){var e=this;if(this._canMessage())return o.createElement("div",{ref:"sendForm",className:"stories_send_form _emoji_field_wrap emoji_rpointer"},o.createElement("div",{className:"stories_send_form_text_wrap"},o.createElement("div",{contentEditable:!0,ref:"messageInput",className:"stories_send_form_text",placeholder:Object(F.getLang)("stories_answer_placeholder"),onFocus:this._sendFormDidFocus.bind(this),onBlur:this._sendFormDidBlur.bind(this),onInput:this._checkReactionsPanel.bind(this)})),o.createElement("div",{className:"stories_send_form_helper"},o.createElement("div",{className:k("stories_send_form_buttons _emoji_wrap",{shown:this.state.sendFormFocused||this.state.sendFormHasText})},o.createElement("div",{ref:"smileButton",className:"stories_send_form_button smile _emoji_btn emoji_smile",onMouseEnter:function(t){window.Emoji.clearSizeCached(e.refs.smileButton),window.Emoji.show(e.refs.smileButton,t.nativeEvent)},onMouseLeave:function(t){return window.Emoji.hide(e.refs.smileButton,t.nativeEvent)},onMouseDown:function(e){return Object(j.cancelEvent)(e.nativeEvent)}}),o.createElement("div",{className:k("stories_send_form_button send",{active:this.state.sendFormHasText}),onClick:this._onSendMessageButtonCLick.bind(this)}))))},t.prototype._isReactionAvailable=function(){return!this.props.story.isActiveLive()},t.prototype._onChangeReactionsPanelVisibility=function(e){void 0===e&&(e=!1),this._isReactionAvailable()&&this.setState({isReactionsPanelShow:e})},t.prototype.emojiInit=function(){var e,t=this;if(!this.emojiId&&this.refs.messageInput){var r=this._isReactionAvailable();if(this.emojiId=window.Emoji.init(this.refs.messageInput,{ttDiff:29,ref:"stories",ttWrap:this.refs.controls,checkEditable:function(){t.props.story.isActiveLive()&&Ue.default.checkTextLen(t.refs.messageInput)},noStickers:!r,noStickersStore:!r,onSend:function(){return t._sendMessage()},onStickerSend:function(e,r,i){t._sendMessage([["sticker",e,i]],{sticker_referrer:r})},forceUp:!0,controlsCont:this.refs.sendForm,onKeyAction:function(){return t._emojiDidKeyAction()},onEmojiAdded:function(){return t._emojiDidKeyAction()},onStoreHide:function(){t._updateReactionStickers(),t.props.story.autoResumeStory()}}),Object(j.addEvent)(this.refs.smileButton,"click",j.cancelEvent),Object(Ke.placeholderInit)(this.refs.messageInput,{editable:!0}),!this._checkLoadedStickers()){var i=Object(l.isRetina)()?"256b":"128b";window.Emoji.emojiLoadMore(this.emojiId,{sizes:(e={},e[i]=!0,e)},(function(){t._updateReactionStickers()}))}}else this.emojiId&&!this.refs.messageInput&&(Object(j.removeEvent)(this.refs.smileButton,"click",j.cancelEvent),window.Emoji.destroy(this.emojiId),delete this.emojiId)},t.prototype._checkLoadedStickers=function(){return this._getReactionsStickers().length>=A.EMOJI_REACTIONS_ARR.length},t.prototype._leftSideIsEmpty=function(){var e=this.props.story,t=e.getCurStoryData();if(!t)return Object(We.logError)(new Error("Fail: _leftSideIsEmpty"),{environment:"stories"}),!1;var r=t.can_manage,i=t.link,o=t.can_comment,n=e.getReplies(),a=e.getViews();return!(a&&0!==parseInt(a))&&(!n||!r)&&!Object(l.isObject)(i)&&!o||e.isLiveEnded()},t.prototype._sendFormDidFocus=function(){var e=this.props.story;this.setState({sendFormFocused:!0}),this._isReactionAvailable()&&this._checkReactionsPanel(),e.onSendFormFocus(),e.layer.sendNavigationStatEvents("comment_tap")},t.prototype._sendFormDidBlur=function(){this.props.story.onSendFormBlur(),this.setState({sendFormFocused:!1}),this._isReactionAvailable()&&this._hideReactionPanel(),this._emojiDidKeyAction()},t.prototype._emojiDidKeyAction=function(){var e=Object(l.trim)(window.Emoji.editableVal(this.refs.messageInput));this.setState({sendFormHasText:e.length>0}),this.refs.messageInput.check()},t.prototype._hideReactionPanel=function(){this._onChangeReactionsPanelVisibility(!1)},t.prototype._showReactionPanel=function(){this._onChangeReactionsPanelVisibility(!0)},t.prototype._checkReactionsPanel=function(){this._isReactionAvailable()&&(this.props.story.getSendText().length?this._hideReactionPanel():this._showReactionPanel())},t.prototype._shareButtonDidPress=function(){this.props.story.shareBox()},t.prototype._likeButtonDidPress=function(){this.setState({needAnimateLikeButton:!0}),this.props.story.toggleLikeStory()},t.prototype._removeButtonDidPress=function(){this.props.story.removeStoryBox()},t.prototype._maskButtonDidPress=function(){this.props.story.sendMask()},t.prototype.linkDidPress=function(e,t){if(t){var r=this.props.story,i=t.object_type,o=t.object,n=t.url.match(/\/narrative(-?\d+)_(\d+)/);if(n){e.preventDefault();var a=n[1],s=n[2];a&&s&&(r.pauseStory(),Object(H.showNarrative)(a,s,0,"",{fromEl:r.wrapEl,source:"narrative_story"}))}else r.layer.sendNavigationStatEvents("link_click"),r.sendStatEvent("url_view");switch(i){case"audio":this.state.linkObjectAudioPlaying?(window.getAudioPlayer().pause(),this.setState({story:qe(qe({},this.state.story),{audioPlaying:!1})}),window.cur.storyLayer.resumeLayer()):(window.getAudioPlayer().playAudio(o),this.setState({story:qe(qe({},this.state.story),{audioPlaying:!0})}),window.cur.storyLayer.pauseLayer()),this.setState({linkObjectAudioPlaying:!this.state.linkObjectAudioPlaying}),e.preventDefault()}}},t.prototype._updateReactionStickers=function(){this.setState({reactionStickers:this._getReactionsStickers()})},t.prototype._getReactionsStickers=function(){var e=[];if(window.stickersKeywords&&window.Emoji.stickersById){var t=window.Emoji.stickersById,r=Object(l.isRetina)()?"256b":"128b",i={};A.EMOJI_REACTIONS_ARR.forEach((function(o){var n=window.stickersKeywords[Object(Ve.emojiRemoveSkinToneModifiers)(window.Emoji.codeToChr(o.code))],a=n&&window.Emoji.sortStickersHints(n),s={};a&&a.every((function(e){return!(e>0&&t[e]&&t[e].sticker&&!i[e])||(s=t[e].sticker,!1)})),s[6]&&s[6][r]&&(e.push({id:s[0],packId:0,uniqId:Object(l.irand)(0,1e5),imageUrl:s[6][r],animationUrl:s[3]}),i[s[0]]=!0)}))}return e},t.prototype._hideStickerHints=function(){var e=Object(c.geByClass1)("_sticker_hints",Object(c.domPN)(this.refs.messageInput));e&&"number"==typeof this.emojiId&&window.Emoji.stickersHintsHide(e,window.Emoji.opts[this.emojiId],100)},t.prototype._onSendMessageButtonCLick=function(){this._sendMessage()},t.prototype._sendMessage=function(e,t,r){var i=this;void 0===e&&(e=[]),void 0===t&&(t={}),void 0===r&&(r={});var o=e.length;this._hideStickerHints(),this.props.story.onAnswerSend((function(){i._emojiDidKeyAction(),o&&i._updateReactionStickers()}),e,t,r)},t}(o.Component),Qe=function(){function e(e,t){this.data=e,this.opts=t,this.paused=!0,this.loaded=!1,this.elems={},this.startTs=0,this.isPausedByMetaScroll=!1;var r=e.is_expired,i=e.is_deleted,o=e.is_private,n=e.narrative,a=e.isOneTimeSeen;r?this._error("expired"):i?n?this._error("deleted-narrative"):this._error("deleted"):a?this._error("isOneTimeSeen"):o&&(n?this._error("private-narrative"):this._error("private")),(r||i||o||a)&&(this.failed=!0)}return e.prototype.render=function(){var e=this;this.isGroupsMetaStory||this.isAppsMetaStory||(this.longLoadingTimer=setTimeout((function(){e.isLoaded()||e.opts.onLongLoading()}),1e3),this.opts.onLoadingStart())},e.prototype.renderAppsMetaStory=function(){var e=this,t=Object(c.ce)("div",{className:"MetaStory"}),r=window.Stories._getList("apps");if(r){this.coverItems=r,this.coverCount=this.coverItems?this.coverItems.length:0,this.elems.recBlock=Object(c.ce)("div",{className:"MetaStory__rec"}),this.elems.recInner=Object(c.ce)("div",{className:"MetaStory__rec-inner"}),this.elems.recItems=Object(c.ce)("div",{className:"MetaStory__rec-items"}),this.elemOffset=286,this.scrollOffset=0,this.metaStoryGridMarginTop=this.elemOffset;var i=Object(c.ce)("div",{className:"MetaStory__infoWrapper"}),o=Object(c.ce)("div",{className:"MetaStory__info"}),n=Object(c.ce)("a",{className:"MetaStory__appWrapper",href:this.data.app.url,target:"_blank"});n.appendChild(Object(c.ce)("div",{className:"MetaStory__appIcon"},{backgroundImage:"url("+this.data.app.photoUrl+")"})),n.appendChild(Object(c.ce)("div",{className:"MetaStory__appName",innerHTML:this.data.app.name})),n.appendChild(Object(c.ce)("span",{className:"MetaStory__appLink",innerHTML:Object(Se.getLang)("stories_go_to_app")})),o.appendChild(n),i.appendChild(o),Object(c.setStyle)(i,{paddingBottom:this.elemOffset+"px"}),Object(c.setStyle)(this.elems.recItems,{minHeight:"calc(100% - "+this.elemOffset+"px"}),t.appendChild(i);var a=Object(c.ce)("div",{className:"MetaStory__navigationBtn MetaStory__backBtn"}),s=Object(c.ce)("div",{className:"MetaStory__navigationBtn MetaStory__nextBtn"}),l=Object(c.ce)("div",{className:"MetaStory__clickableArea"});l.appendChild(a),l.appendChild(s),Object(j.addEvent)(l,"mousedown",this.handleGridInfoWrapperMouseDown.bind(this)),Object(j.addEvent)(l,"mouseup",this.handleGridInfoWrapperMouseUp.bind(this)),this.coverItems.forEach((function(t){var r=t.items.filter((function(e){return e.unread})),i=!!r.length,o=t.items[0];i&&(o=r[0]);var n=Object(c.ce)("span",{className:"GridStoryPreview"+("live"===o.type?" GridStoryPreview--live":""),onclick:function(e){var r=e.target;window.Stories.show(window.cur.storyLayer.getBlockKey(t)+"/apps",{fromEl:r})}}),a=Object(c.ce)("div",{className:"GridStoryPreview__inner",innerHTML:'\n            <a href="'+t.author.href+'" data-author-id="'+t.author.id+'" class="GridStoryPreview__author'+(i?" GridStoryPreview__author--unread":"")+'" style="background-image: url(\''+t.author.photo+'\')"></a>\n            <span class="GridStoryPreview__title">'+t.author.name+"</span>\n          "},{backgroundImage:"url('"+o.preview_url+"')"}),s=new Image;s.src=o.small_preview,s.onload=function(){Object(c.setStyle)(a,{backgroundImage:"url('"+o.small_preview+"')"})},n.appendChild(a),e.elems.recItems.appendChild(n)})),Object(j.addEvent)(this.elems.recInner,"scroll",this.handleRecommendationsScroll.bind(this)),this.elems.recInner.appendChild(l),this.elems.recInner.appendChild(this.elems.recItems),this.elems.recBlock.appendChild(this.elems.recInner),t.appendChild(this.elems.recBlock)}return t},e.prototype.renderGroupsMetaStory=function(){var e=this,t=Object(c.ce)("div",{className:"MetaStory"}),r=window.Stories._getList("groups");if(r){this.coverItems=r,this.coverCount=this.coverItems?this.coverItems.length:0,this.elems.recBlock=Object(c.ce)("div",{className:"MetaStory__rec"}),this.elems.recInner=Object(c.ce)("div",{className:"MetaStory__rec-inner"}),this.elems.recItems=Object(c.ce)("div",{className:"MetaStory__rec-items"}),this.elemOffset=286,this.scrollOffset=0,this.metaStoryGridMarginTop=this.elemOffset;var i=Object(c.ce)("div",{className:"MetaStory__infoWrapper"}),o=Object(c.ce)("div",{className:"MetaStory__info"});o.appendChild(Object(c.ce)("div",{className:"MetaStory__infoTitle",innerHTML:Object(Se.getLang)("stories_groups_grid_title")})),o.appendChild(Object(c.ce)("div",{className:"MetaStory__infoDescription",innerHTML:Object(Se.getLang)("stories_groups_grid_text")})),i.appendChild(o),Object(c.setStyle)(i,{paddingBottom:this.elemOffset+"px"}),Object(c.setStyle)(this.elems.recItems,{minHeight:"calc(100% - "+this.elemOffset+"px"}),t.appendChild(i);var n=Object(c.ce)("div",{className:"MetaStory__navigationBtn MetaStory__backBtn"}),a=Object(c.ce)("div",{className:"MetaStory__navigationBtn MetaStory__nextBtn"}),s=Object(c.ce)("div",{className:"MetaStory__clickableArea"});s.appendChild(n),s.appendChild(a),Object(j.addEvent)(s,"mousedown",this.handleGridInfoWrapperMouseDown.bind(this)),Object(j.addEvent)(s,"mouseup",this.handleGridInfoWrapperMouseUp.bind(this)),this.coverItems.forEach((function(t){var r=t.items.filter((function(e){return e.unread})),i=!!r.length,o=t.items[0];i&&(o=r[0]);var n=Object(c.ce)("span",{className:"GridStoryPreview"+("live"===o.type?" GridStoryPreview--live":""),onclick:function(e){var r=e.target;window.Stories.show(window.cur.storyLayer.getBlockKey(t)+"/groups",{fromEl:r})}}),a=Object(c.ce)("div",{className:"GridStoryPreview__inner",innerHTML:'\n            <a href="'+t.author.href+'" data-author-id="'+t.author.id+'" class="GridStoryPreview__author'+(i?" GridStoryPreview__author--unread":"")+'" style="background-image: url(\''+t.author.photo+'\')"></a>\n            <span class="GridStoryPreview__title">'+t.author.name+"</span>\n          "},{backgroundImage:"url('"+o.preview_url+"')"}),s=new Image;s.src=o.small_preview,s.onload=function(){Object(c.setStyle)(a,{backgroundImage:"url('"+o.small_preview+"')"})},n.appendChild(a),e.elems.recItems.appendChild(n)})),Object(j.addEvent)(this.elems.recInner,"scroll",this.handleRecommendationsScroll.bind(this)),this.elems.recInner.appendChild(s),this.elems.recInner.appendChild(this.elems.recItems),this.elems.recBlock.appendChild(this.elems.recInner),t.appendChild(this.elems.recBlock)}return t},e.prototype.handleRecommendationsScroll=function(){var e=Math.min(this.elems.recInner.scrollTop/(this.scrollOffset/100),70)/100;Object(c.setStyle)(this.elems.recBlock,{backgroundColor:"rgba(0, 0, 0, "+e+")"}),this.elems.recInner.scrollTop?(this.isPausedByMetaScroll=!0,Object(c.addClass)(this.elems.recBlock,"scroll"),this.pause()):(this.isPausedByMetaScroll=!1,this.play(),Object(c.removeClass)(this.elems.recBlock,"scroll"),Object(c.setStyle)(this.elems.recBlock,{backgroundColor:"rgba(0, 0, 0, 0)"})),(this.data.is_groups_meta_story||this.data.is_apps_meta_story)&&(this.elems.blockHeader||(this.elems.blockHeader=window.cur.storyLayer.activeStory.authorButtons.querySelector(".stories_groups_settings_text")),this.elems.recInner.scrollTop&&Object(c.removeClass)(window.cur.storyLayer.activeStory.wrapEl,"paused"),this.elems.recInner.scrollTop>this.metaStoryGridMarginTop?(Object(c.removeClass)(window.cur.storyLayer.activeStory.wrapEl,"paused"),Object(c.removeClass)(this.elems.blockHeader,"stories_groups_settings_text_hide")):Object(c.addClass)(this.elems.blockHeader,"stories_groups_settings_text_hide"))},e.prototype.handleGridInfoWrapperMouseDown=function(){this.downTs=Object(l.vkNow)(),this.longTapTimer=setTimeout(e.longTapInfoWrapper.bind(this),A.LONG_PRESS_DELAY_MS)},e.prototype.handleGridInfoWrapperMouseUp=function(e){if(window.cur.storyLayer.activeStory){clearTimeout(this.longTapTimer);var t=!(Object(l.vkNow)()-this.downTs<A.LONG_PRESS_DELAY_MS);if(Object(c.hasClass)(e.target,"MetaStory__backBtn")&&!t)return window.cur.storyLayer.activeStory.prevStory();t?window.cur.storyLayer.activeStory.isPaused()&&window.cur.storyLayer.activeStory.playStory(!1,!!this.downTs):window.cur.storyLayer.activeStory._onPlayEnd()}},e.longTapInfoWrapper=function(){window.cur.storyLayer.activeStory&&window.cur.storyLayer.activeStory.longTapHandle()},e.prototype.getContainer=function(){},e.prototype.play=function(){this.paused=!1,this.isLoaded()&&this.opts.onPlay()},e.prototype.pause=function(){this.paused=!0,this.opts.onPause()},e.prototype.setCurrentTime=function(e){void 0===e&&(e=0)},e.prototype.destroy=function(){Object(j.removeEvent)(this.elems.recBlock),clearTimeout(this.longLoadingTimer)},e.prototype.isPaused=function(){return this.paused},e.prototype.isLoaded=function(){return this.loaded},e.prototype.getCurrentTime=function(){return 0},e.prototype.getDuration=function(){return 0},e.prototype.getId=function(){return this.data.raw_id},e.prototype.getTrackCode=function(){return this.data.track_code},e.prototype.getAccessKey=function(){return this.data.accessKey},e.prototype.getDate=function(){return this.data.date},e.prototype.getViews=function(){return this.data.views},e.prototype.getReplies=function(){return this.data.replies},e.prototype.setViews=function(e){this.data.views=e},e.prototype.setReplies=function(e){this.data.repliesCountText=e},e.prototype.isOneTime=function(){return this.data.isOneTime&&this.data.authorId!==window.vk.id},e.prototype._onCanPlay=function(){if(clearTimeout(this.longLoadingTimer),this.loaded=!0,this.opts.onLoadingEnd(),this.startTs=Date.now(),this.data.seenProgress&&this.isOneTime()&&this.setCurrentTime(+(this.data.seenProgress*this.getDuration()/100).toFixed(1)),!this.isPaused()){var e=document.visibilityState;if(e&&"visible"!==e)return;this.play()}},e.prototype._loadingError=function(){this._error("load")},e.prototype._isFailed=function(){return this.failed},e.prototype._error=function(e){clearTimeout(this.longLoadingTimer),this.opts.onError(e)},e}(),Xe=r("Ia1d"),Ye=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),$e=function(e){function t(t,r,i){var o=e.call(this,t,r)||this;return o.wrapEl=i,o.videoRaw=o.data.video.owner_id+"_"+o.data.video.video_id,o}return Ye(t,e),t.prototype.render=function(){var t=this;e.prototype.render.call(this),this.el=Object(c.ce)("div",{className:"stories_live"});var r=Object(c.ce)("div",{className:"stories_live_player"},{height:"100%",width:"100%"});return this.el.appendChild(r),this.chatEl=Object(c.se)('\n      <div class="stories_live_chat">\n        <div class="mv_chat_messages_wrap">\n          <div class="mv_chat_messages"></div>\n        </div>\n        <div class="mv_chat_stickers_wrap"></div>\n      </div>\n    '),this.el.appendChild(this.chatEl),window.mvcur&&window.mvcur.player&&window.Videoview.hide(!1,!0),setTimeout((function(){Object(Xe.showInlineVideo)(t.videoRaw,"",{autoplay:1,module:"story",onLoaded:function(){t._onPlayerInited()}},!1,r)})),this.el},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._resetTimer(),window.mvcur={},this.player&&(this.player.destroy(),Ue.default.destroy()),window.cur.storyLayer.sendNavigationStatEvents("live_player_close",!1),delete this.el},t.prototype.getContainer=function(){return this.el||this.render()},t.prototype.onLiveEnded=function(){var e=this;this.liveEnded=!0,Object(c.hide)(Object(c.geByClass1)("_error_msg",Object(c.geByClass1)("videoplayer_error")));var t=this.mvData.oid<0?Object(Se.getLang)("stories_live_ended_desc_club"):Object(Se.langSex)(this.mvData.author_sex,Object(Se.getLang)("stories_live_ended_desc_user","raw"));t=t.replace("{name}",this.mvData.md_author);var r=this.mvData.oid<0?Object(Se.getLang)("stories_live_ended_open_club"):Object(Se.getLang)("stories_live_ended_open_user");Object(c.hide)(this.chatEl),Object(c.hide)(Object(c.domByClass)(this.player.ui.thumb,"videoplayer_big_play_btn"));var i=window.cur.storyLayer.storiesBlocks.length>1;this.el.appendChild(Object(c.se)('\n    <div class="stories_live_end">\n      <div class="stories_live_end_author_photo" style="background-image: url('+this.mvData.author_photo+')"></div>\n      <div class="stories_live_end_title">'+Object(Se.getLang)("stories_live_ended_title")+'</div>\n      <div class="stories_live_end_desc">'+t+'</div>\n      <a href="'+this.mvData.author_href+'" class="stories_live_end_open_owner">'+r+'</a>\n      <div class="stories_live_end_timer" onclick="cur.storyLayer.nextStory()" style="'+(i?"":"display: none;")+'">\n        <canvas class="_timer_canvas" width="100" height="100"></canvas>\n        <div class="stories_live_end_timer_text">'+Object(Se.getLang)("stories_live_ended_watch_next")+"</div>\n      </div>\n    </div>\n    ")),i&&setTimeout((function(){e._startTimer()}))},t.prototype.pause=function(){},t.prototype.play=function(){this.player&&!this.liveEnded&&(e.prototype.play.call(this),this.player&&this.player.play())},t.prototype.sendMessage=function(e,t){e.length>window.mvcur.maxChatReplyLength||(window.ajax.post("al_video.php?act=post_comment",{comment:e,video:this.videoRaw,hash:this.mvData.hash,videoviewer_chat:1}),window.cur.storyLayer.activeStory.onAnswerSent(t))},t.prototype.volumeUpdate=function(){this.player.setVolume(b())},t.prototype._onCanPlay=function(){e.prototype._onCanPlay.call(this),Object(c.setStyle)(this.el,"opacity",1)},t.prototype._onPlayerInited=function(){this._onCanPlay(),this.player=window.cur.videoInlinePlayer,this.play(),window.cur.storyLayer.sendNavigationStatEvents("live_player_show",!1),window.browser.safari&&this.player.toggleMute(!0,!1),this.mvData=window.Videoview.getMvData(),window.mvcur={chatMode:!0,maxChatReplyLength:this.mvData.maxChatReplyLength,mvData:this.mvData,mvShown:!0,queueKey:this.mvData.queue_params.key,qversion:this.mvData.qversion},Ue.default.init(this.chatEl,{scrollHidden:!0}),window.Videoview.queueCheckUpdates(this.mvData.queue_params)},t.prototype._startTimer=function(){var e=this;if(window.CanvasRenderingContext2D){var t=Object(c.domByClass)(this.el,"_timer_canvas"),r=t.getContext("2d");r.lineWidth=6,r.lineCap="round",r.strokeStyle="#fff";var i=Date.now(),o=function(){var t=(Date.now()-i)/5e3;t<1?(r.clearRect(0,0,100,100),r.beginPath(),r.arc(50,50,47,-Math.PI/2,-Math.PI/2+2*Math.PI*t),r.stroke(),e._nextTO=setTimeout(o,16)):window.cur.storyLayer.nextStory()};Object(c.show)(t),this.timerInProgress=!0,o()}},t.prototype._resetTimer=function(){window.CanvasRenderingContext2D&&(clearTimeout(this._nextTO),this.timerInProgress=!1,Object(c.hide)(Object(c.domByClass)(this.el,"_timer_canvas")))},t}(Qe),Je=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),Ze=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.isFirstChunkLoaded=!1,i}return Je(t,e),t.prototype.render=function(){var t=this;if(e.prototype.render.call(this),this.video)return this.video;var r=this.data.video_url;return this.video=document.createElement("video"),this.video.setAttribute("class","stories_video"),this.video.setAttribute("autoplay","false"),this.video.setAttribute("volume",Object(V.getAudioPlayer)().getVolume()),this.video.setAttribute("x-yandex-pip","false"),this.video.setAttribute("disablePictureInPicture","true"),Object(j.addEvent)(this.video,"error",(function(){t._loadingError()})),this._isFailed()||(this.loaded&&(this.video.currentTime=0),Object(j.addEvent)(this.video,"canplay",this._onCanPlay.bind(this)),this.video.src=r,this.volumeUpdate()),this.video},t.prototype.getContainer=function(){return this.video||this.render()},t.prototype.getImage=function(){var e=Object(c.getSize)(this.video),t=document.createElement("canvas");t.setAttribute("width",e[0].toString()),t.setAttribute("height",e[1].toString());var r=t.getContext("2d");return r&&r.drawImage(this.video,0,0,e[0],e[1]),t.toDataURL()},t.prototype.destroy=function(){e.prototype.destroy.call(this),Object(j.removeEvent)(this.video),delete this.video},t.prototype.play=function(){var t=this;if(e.prototype.play.call(this),this.loaded&&this.video){var r=this.video.play();void 0!==r&&r.catch((function(){t.opts.onAutoPlayFail()}))}},t.prototype.pause=function(){e.prototype.pause.call(this),this.video&&this.video.pause()},t.prototype.setCurrentTime=function(e){void 0===e&&(e=0),e=+(e/1e3).toFixed(1),this.loaded&&this.video.currentTime<e&&(this.video.currentTime=e)},t.prototype.getCurrentTime=function(){return 1e3*this.video.currentTime},t.prototype.getDuration=function(){return 1e3*this.video.duration},t.prototype.volumeUpdate=function(){this.video.volume=b()},t.prototype._onCanPlay=function(){e.prototype._onCanPlay.call(this),!this.isFirstChunkLoaded&&window.cur.storyLayer&&(this.isFirstChunkLoaded=!0,window.cur.storyLayer.sendNavigationStatEvents("view_story",!0,{preloading_duration:window.cur.storyLayer.activeStory&&window.cur.storyLayer.activeStory.loadingTime||0})),Object(c.setStyle)(this.video,"opacity",1),Object(j.removeEvent)(this.video,"canplay")},t}(Qe),et=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),tt=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.pauseTime=0,i}return et(t,e),t.prototype.render=function(){var t=this;if(e.prototype.render.call(this),this.photo)return this.photo;var r=this.data.photo_url;return this.photo=document.createElement("div"),this.photo.setAttribute("class","stories_photo"),this._isFailed()||f(r).then((function(e){t.photo&&(Object(c.setStyle)(t.photo,"backgroundImage","url('"+e+"')"),t._onCanPlay())})).catch((function(){t.isGroupsMetaStory||t.isAppsMetaStory?t._onCanPlay():t._loadingError()})),this.photo},t.prototype.getContainer=function(){return this.isGroupsMetaStory||this.isAppsMetaStory||this.photo||this.render()},t.prototype.destroy=function(){e.prototype.destroy.call(this),delete this.photo},t.prototype.play=function(){(0===this.startTs||this.pauseTime>0)&&(this.startTs=Date.now()-this.pauseTime,this.pauseTime=0),e.prototype.play.call(this)},t.prototype.pause=function(){this.isPaused()||(e.prototype.pause.call(this),this.pauseTime=this.getCurrentTime())},t.prototype.setCurrentTime=function(e){void 0===e&&(e=0),this.startTs=Date.now()-e,this.isPaused()&&(this.pauseTime=e)},t.prototype.getCurrentTime=function(){return Date.now()-this.startTs||0},t.prototype.getDuration=function(){return 5e3},t.prototype._onCanPlay=function(){e.prototype._onCanPlay.call(this);var t=this.isGroupsMetaStory?"group_feed_view":"view_story";window.cur.storyLayer.sendNavigationStatEvents(t,!0,{preloading_duration:window.cur.storyLayer.activeStory&&window.cur.storyLayer.activeStory.loadingTime||0}),Object(c.setStyle)(this.photo,"opacity",1)},t}(Qe),rt=r("QChX"),it=r("DM2o");function ot(e){if(rt.HAS_MEDIA_SESSION){var t=(Ce=e).getCurStoryData();if(t)if(["video"].includes(t.type)&&!t.noSound){var r=Object(M.decodeHTMLEntities)(Ce.data.author.name),i=Object(M.decodeHTMLEntities)(t.date),o=t.small_preview||t.photo_url||t.first_frame||t.preview_url,n=o?[{sizes:"800x1497",src:o}]:[];!function(){if(!rt.HAS_MEDIA_SESSION)return;navigator.mediaSession.setActionHandler("play",nt),navigator.mediaSession.setActionHandler("pause",at),navigator.mediaSession.setActionHandler("seekbackward",null),navigator.mediaSession.setActionHandler("seekforward",null),navigator.mediaSession.setActionHandler("previoustrack",st),navigator.mediaSession.setActionHandler("nexttrack",ct)}(),Object(rt.updateMediaSessionMetadata)({title:r,artist:i,album:"",artwork:n})}else Object(rt.clear)();else Object(We.logError)(new Error("Fail story media session"),{environment:"stories"})}}function nt(){Ce.playStory(),Object(it.statlogsValueEvent)("global_media_controls","story_player","play")}function at(){Ce.pauseStory(),Object(it.statlogsValueEvent)("global_media_controls","story_player","pause")}function st(){Ce.prevStory(),Object(it.statlogsValueEvent)("global_media_controls","story_player","previous_track")}function ct(){Ce.nextStory(),Object(it.statlogsValueEvent)("global_media_controls","story_player","next_track")}var lt=r("lXE5"),dt=r("lBJi"),ut=r("k487"),pt=r("v+DW"),_t=r("rudk"),ht=r("FThC"),mt=r("El3O"),vt=r("rJNF"),ft=r("7ckd"),gt=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],a=0,s=n.length;a<s;a++,o++)i[o]=n[a];return i},yt=function(){function e(e,t){var r=this;this.updateBottom=function(e){var t=Object(c.geByClass1)("stories_bottom_wrap",r.wrapEl);!r.isActive||e||!r.story||r.story.isGroupsMetaStory||r.story.isAppsMetaStory?(a.unmountComponentAtNode(t),Object(c.val)(t,"")):a.render(o.createElement(ze,{story:r,markAppNotificationsSeen:r.markAppNotificationsSeen}),t)},this.markAppNotificationsSeen=function(e){var t=r.getCurStoryData();if(t){var i=t.raw_id,o=void 0===i?"":i,n=t.accessKey;if(e.appId&&e.appRef){var a=o.split("_"),s=a[0],c=a[1];e.hasNewInteractions&&window.ajax.post("al_stories.php",{act:"mark_app_notifications_seen",owner_id:s,story_id:c,sticker_id:e.id,access_key:n,hash:e.hash},{onDone:function(){t.clickable_stickers&&t.clickable_stickers.stickers&&t.clickable_stickers.stickers.forEach((function(t){t.id===e.id&&t.type===A.StickerTypes.app&&(t.hasNewInteractions=!1)}));var r=document.querySelector("._stories_button_app");r&&r.classList.contains("has_new")&&r.classList.remove("has_new");var i=document.querySelector("#feed_story_"+s+" .stories_feed_preview_app");i&&i.classList.contains("has_new")&&i.classList.remove("has_new")}}),window.layerQueue.count()?window.layerQueue.pop():window.layerQueue.push(),r.pauseStory(),Object(V.showWiki)({w:"app"+e.appId,app_ref:e.appRef,app_hash:e.appHash}),r.layer.sendNavigationStatEvents("click_to_app",!0,{clickable_sticker:{id:e.id,type:"app"}})}}else Object(We.logError)(new Error("Fail: markAppNotificationsSeen"),{environment:"stories"})},this.toggleFeedbackTooltip=function(e){void 0===e&&(e=!r.isFeedbackTooltipShow),e?r.showFeedbackTooltip():r.hideFeedbackTooltip()},this.onFetchFeedbackData=function(e){var t,i,o;r.feedback=e;var n=null===(i=null==e?void 0:e.replies)||void 0===i?void 0:i.repliesTotalCountText,a=null===(o=null==e?void 0:e.viewers)||void 0===o?void 0:o.viewsTotalCountText,s=null==e?void 0:e.replies,c=null==s?void 0:s.listName,d=null==s?void 0:s.list;n&&r.setReplies(n),a&&r.setViews(a),s&&d&&(window.cur=Object(l.extend)(window.cur,((t={})["stories_list_"+c]=d,t)),s.list=d.length>A.INIT_MAX_FEEDBACK_STORIES_COUNT?d.slice(0,A.INIT_MAX_FEEDBACK_STORIES_COUNT):d,s.moreRepliesCount=d.length-s.list.length),r.updateBottom()},this.showMoreReplies=function(){var e,t=null===(e=r.feedback)||void 0===e?void 0:e.replies,i=null==t?void 0:t.listName,o=null==t?void 0:t.list;if(t&&o){var n=window.Stories._getList(i);t.list=n.slice(0,t.list.length+A.MAX_FEEDBACK_STORIES_SLICE_COUNT),t.moreRepliesCount=n.length-t.list.length,r.updateBottom()}},this.onFetchViewers=function(e){var t,i;(null===(i=null===(t=r.feedback)||void 0===t?void 0:t.viewers)||void 0===i?void 0:i.items)&&(r.feedback.viewers.items=r.feedback.viewers.items.concat(e.viewers),r.feedback.viewers.nextFrom=e.nextFrom,r.updateBottom())},this.onQuestionRemove=function(e){var t,i;(null===(i=null===(t=r.feedback)||void 0===t?void 0:t.questions)||void 0===i?void 0:i.items)&&(r.feedback.questions.items=r.feedback.questions.items.filter((function(t){return t.id!==e})),r.feedback.questions.items.length||delete r.feedback.questions,r.updateBottom())},this.onPrivacyHintHide=function(){var e,t;(null===(t=null===(e=r.feedback)||void 0===e?void 0:e.stats)||void 0===t?void 0:t.showPrivacyHint)&&(window.ajax.post("al_stories.php",{act:"hide_privacy_hint",privacy_hint_hash:r.feedback.stats.privacyHintHash}),r.feedback.stats.cells||r.feedback.stats.extendedStats?r.feedback.stats.showPrivacyHint=!1:delete r.feedback.stats,r.updateBottom())},this.onAddToNarrativeBtnClick=function(){var e=r.getCurStoryData();if(e){r.pauseStory(),r.isModalShown=!0;var t=r.buildStoryArchiveByActive();if(t){var i={ownerId:r.getOwnerId(),story:t,onClose:function(){r.updateNarrativeBlockIfNeeded(),r.isModalShown=!1,r.updateBottom(),r.playStory()},onSave:function(t){e.isPartOfNarrative=t}};Object(vt.showNarrativeChooseBox)(i)}}},this.data=e,this.opts=t,this.id=t.id,this.isActive=!1,this.isSendFormActive=!1,this.isModalShown=!1,this.isFeedbackTooltipShow=!1,this.pressedStory=null,this.index=0,this._currentTimeLineAdditionalEl=null,this._currentTimeLineEl=null,this.preloadedStories={},this.layer=t.layer}return e.prototype.destroy=function(){this._destroyStory(),Object(j.removeEvent)(Object(c.geByClass1)("stories_item_cont",this.contWrap)),Object(j.removeEvent)(Object(c.geByClass1)("stories_reply_to",this.replyToWrap)),Object(j.removeEvent)(this.shareButton),delete this.shareButton,Object(j.removeEvent)(this.followBtn),delete this.followBtn,Object(j.removeEvent)(this.answersEl),delete this.answersEl,clearTimeout(this.showMessageTimer);for(var e=Object(c.geByClass)("stories_time_line",this.timeLineEl),t=0;t<e.length;t++)Object(j.removeEvent)(e[t]);Object(j.removeEvent)(this.viewsButton),Object(j.removeEvent)(Object(c.geByClass1)("stories_link",this.wrapEl)),delete this.contWrap,delete this.backButton,delete this.replyToWrap,delete this.descEl,delete this.replyToWrap,delete this.timeLineEl,delete this.authorButtons,delete this.inlineLoader,this.wrapEl&&this.wrapEl.parentNode&&this.wrapEl.parentNode.removeChild(this.wrapEl),delete this.wrapEl;var r=!1;for(t=0;t<this.data.items.length;t++)if(this.data.items[t].unread){r=!0;break}var i=x();if(!r&&i&&i.activeStory&&!this.data.is_apps){var o=Object(c.domQuery)("#feed_story_"+this.layer.getBlockKey(this.data),i.activeStory.wrapEl)[0];Object(c.removeClass)(o,"story_feed_new_item"),Object(c.removeClass)(o,"story_feed_new_item_promo")}Object(rt.clear)()},e.prototype._destroyTimeLine=function(){for(var e=Object(c.geByClass)("stories_time_line",this.timeLineEl),t=0;t<e.length;t++)Object(j.removeEvent)(e[t])},e.prototype.getOwnerId=function(){return this.data.author.id},e.prototype.getIndex=function(){return this.index},e.prototype.getRawId=function(){return this.story?this.story.getId():""},e.prototype.getTrackCode=function(){return!!this.story&&this.story.getTrackCode()},e.prototype.getAccessKey=function(){var e;return null===(e=this.story)||void 0===e?void 0:e.getAccessKey()},e.prototype.getReadHash=function(){return this.data.read_hash},e.prototype.getItems=function(){return this.data.items},e.prototype.getItemsLength=function(){return this.getItems().length},e.prototype.render=function(){var e=this;this.wrapEl=Object(c.ce)("div",{className:"stories_item"}),this.contWrap=Object(c.ce)("div",{className:"stories_item_cont_wrap"}),this.contStickers=Object(c.ce)("div",{className:"stories_item_cont_sticker"}),this.storiesHeader=Object(c.ce)("div",{className:"stories_header"}),this.contWrap.appendChild(this.contStickers),this.wrapEl.appendChild(this.contWrap);var t=Object(c.ce)("div",{className:"stories_item_cont"});return Object(j.addEvent)(t,"mousedown",(function(t){e._onMouseDownHandle(t.target)})),Object(j.addEvent)(t,"mouseup",(function(t){e._onMouseUpHandle(t.target)})),this.contWrap.appendChild(t),this.contWrap.appendChild(this.storiesHeader),this.storiesHeader.appendChild(this._renderAuthor()),this.storySendFormOverlay=Object(c.ce)("div",{className:"stories_bottom_overlay"}),this.storySendFormOverlay.appendChild(Object(c.ce)("div",{className:"stories_bottom_wrap"})),this.contWrap.appendChild(this.storySendFormOverlay),this.contWrap.appendChild(this._renderPreview()),this.indexToUnread(),window.cur.noStoriesBack||(this.backButton=Object(c.ce)("div",{className:"stories_item_back"}),t.appendChild(this.backButton)),this.replyToWrap=t.appendChild(Object(c.ce)("div",{className:"stories_reply_to_wrap"})),this.inlineLoader=t.appendChild(Object(c.ce)("div",{className:"stories_inline_loader",innerHTML:Object(mt.getProgressHtml)()})),this.contWrap.appendChild(Object(c.ce)("div",{className:"stories_play_button video_thumb_play",onclick:function(){e.story&&e.story.play()}})),this.isActiveLive()?Object(c.addClass)(this.wrapEl,"live"):this._initTimeLine(),Object(c.toggleClass)(this.wrapEl,"multi_stories",this.data.items.length>1),this.wrapEl},e.prototype._canForceDeleteStories=function(){return this.data.moder_remove_hash&&!this.data.items[0].is_deleted},e.prototype._initTimeLine=function(){this.timeLineEl&&(this._destroyTimeLine(),Object(c.re)(this.timeLineEl)),this.storiesHeader.appendChild(this._renderTimeLine())},e.prototype._isActionsShown=function(){var e=Object(c.domClosest)("_ui_menu_wrap",this.wrapEl);return Object(c.hasClass)(e,"shown")},e.prototype._renderPreview=function(){return Object(c.se)('<div class="stories_preview"></div>')},e.prototype._renderMessage=function(e){return Object(c.se)('<div class="stories_message">\n  <div class="stories_message_text">'+e+"</div>\n</div>")},e.prototype.showMessage=function(e){var t=this;Object(c.re)(Object(c.geByClass1)("stories_message",this.contWrap));var r=this._renderMessage(e);return this.contWrap.appendChild(r),clearTimeout(this.showMessageTimer),new Promise((function(e){t.showMessageTimer=setTimeout((function(){t.contWrap.removeChild(r),e()}),3e3)}))},e.prototype._setPreview=function(e,t){var r=this,i=this.index,o=this.data.items[i].preview_url;o!==this.curPreviewUrl&&o&&(e=e||Object(c.geByClass1)("stories_preview",this.contWrap),f(o).then((function(n){i===r.index&&o!==r.curPreviewUrl&&(r.curPreviewUrl=o,Object(c.setStyle)(e,"backgroundImage","url("+n+")")),Object(c.setStyle)(e,"opacity",1),t&&setTimeout(t,0)})).catch((function(e){Object(We.logError)(e)})))},e.prototype._renderAuthor=function(){var e,t=this,r=this.data.author,i=r.photo,o=r.href,n=r.name,a=r.verify,s="_self";(this.layer.list.includes("place")&&(s="_blank"),this.data.is_groups)?e='\n      <div class="stories_author_cont">\n        <a href="/groups" target="_blank" class="stories_author_name"><span>'+Object(Se.getLang)("stories_groups_feed_block")+'</span></a>\n        <div class="stories_desc"></div>\n      </div>':e='\n      <div class="stories_author_cont">\n        '+('<a href="'+o+'" class="stories_author_photo_wrap"><img src="'+i+'" class="stories_author_photo" /></a>')+'\n        <a href="'+o+'" target="'+s+'" class="stories_author_name"><span>'+n+"</span></a>\n        "+(a||"")+'\n        <div class="stories_desc"></div>\n      </div>';var l=Object(c.se)('\n      <div class="stories_author">\n        <div class="stories_author_cont_wrap">\n          <div class="stories_author_inner">'+e+'</div>\n          <div class="stories_author_buttons"></div>\n         </div>\n      </div>\n    ');return Object(j.addEvent)(l,"click",(function(e){Object(c.domClosestByTag)("a",e.target)&&t.layer.sendNavigationStatEvents("go_to_author")})),this.descEl=Object(c.geByClass1)("stories_desc",l),this.authorButtons=Object(c.geByClass1)("stories_author_buttons",l),l},e.prototype.showFeatureTooltipIfNeed=function(e){var t=this;window.cur.showStoriesFeatureTooltip&&!window.cur.storiesFeatureTooltip&&e&&(window.cur.storiesFeatureTooltipTimeoutId=setTimeout((function(){var r=Object(c.se)('\n        <div>\n          <div class="stories_feature_tt_close" onclick="window.cur.storiesFeatureTooltip.hide(); cancelEvent(event);"></div>\n          <div>'+Object(Se.getLang)("stories_feature_narrative_users")+"</div>\n        </div>\n     ");Object(j.addEvent)(r,"click",(function(){window.cur.storiesFeatureTooltip.hide()})),window.cur.storiesFeatureTooltip=new ut.default(e,{appendToParent:!0,autoShow:!1,forceSide:"top",cls:"eltt_fancy stories_feature_tt",offset:[1,-3],content:r,align:"right",onHide:t._closeFeatureTooltip.bind(t)}),t.pauseStory(),window.cur.storiesFeatureTooltip.show(),clearTimeout(window.cur.storiesFeatureTooltipTimeoutId)}),2e3),window.cur.destroy&&window.cur.destroy.push((function(){return clearTimeout(window.cur.storiesFeatureTooltipTimeoutId)})))},e.prototype._closeFeatureTooltip=function(e){void 0===e&&(e=!0),window.cur.storiesFeatureTooltip&&(window.cur.showStoriesFeatureTooltip=!1,window.cur.storiesFeatureTooltip.destroy(),window.cur.storiesFeatureTooltip=null,e&&this.playStory(),window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:window.cur.storiesFeatureTooltipKey,hash:window.cur.storiesFeatureTooltipHash},{onDone:function(){}}))},e.prototype._renderFollowButton=function(){var e=this;return this.followBtn=Object(c.ce)("div",{className:"stories_author_button stories_follow"}),Object(j.addEvent)(this.followBtn,"click",this._onFollowBtnClick.bind(this)),Object(j.addEvent)(this.followBtn,"mouseover",(function(){var t=Object(c.hasClass)(e.followBtn,"followed")?Object(Se.getLang)("stories_unfollow"):Object(Se.getLang)("stories_follow");Object(ee.showTooltip)(e.followBtn,{black:1,center:1,shift:[0,5,0],text:t,appendEl:e.contWrap})})),this.followBtn},e.prototype._renderTimeLine=function(){var e=this;this.timeLineEl=Object(c.ce)("div",{className:"stories_time_line"+(this.data.items.length>50?" stories_time_line_many_items":"")});var t=this.data.author.id;return this.data.items.map((function(r,i){var o=Object(c.ce)("div",{className:"stories_time_line_item"});Object(j.addEvent)(o,"click",(function(){e.layer.sendNavigationStatEvents("go_to_story_click"),e.changeStory(i)}));var n=Object(c.ce)("div",{className:"stories_time_line_item_cont"});n.appendChild(Object(c.ce)("div",{className:"stories_time_line_item_cont_active"})),o.appendChild(n),r.isOneTime&&window.vk.id!==t&&(o.appendChild(Object(c.ce)("div",{className:"stories_time_line_item_wick"})),Object(c.addClass)(o,"stories_time_line_item_is_one_time")),e.timeLineEl.appendChild(o)})),this.timeLineEl},e.prototype.isPaused=function(){return!this.story||this.story.isPaused()},e.prototype.isLoaded=function(){return!this.story||this.story.isLoaded()},e.prototype._onMouseDownHandle=function(e){this.pressedStory=e,this.isActive&&(this.isLocked()||(Object(c.hasClass)(e,"stories_item_cont")||Object(c.hasClass)(e,"stories_item_back")||Object(c.hasClass)(e,"StoryStickers__disableArea")||Object(c.hasClass)(e,"StorySticker"))&&!this.downTs&&(this.downTs=Object(l.vkNow)(),this.longTapTimer=setTimeout(this.longTapHandle.bind(this),A.LONG_PRESS_DELAY_MS)))},e.prototype._onMouseUpHandle=function(e,t){void 0===t&&(t=function(){}),clearTimeout(this.longTapTimer);var r=this.downTs;if(delete this.downTs,e===this.pressedStory){this.pressedStory=null;var i=Object(l.vkNow)()-r>=A.LONG_PRESS_DELAY_MS,o=i||this.isSendFormActive||Object(c.hasClass)(this.wrapEl,"autoplay_failed");if(this.isActive&&(Object(c.hasClass)(e,"stories_item_back")||Object(c.hasClass)(e,"StoryStickers__disableArea--left"))&&!o&&!this.isTooltipOpened())return this.prevStory();if(i||!Object(c.hasClass)(e,"StorySticker")){if(Object(c.hasClass)(e,"stories_item_cont")||Object(c.hasClass)(e,"stories_item_back")||Object(c.hasClass)(e,"StoryStickers__disableArea")||Object(c.hasClass)(e,"StorySticker"))if(this.isFeedbackTooltipShow&&this.hideFeedbackTooltip(),Object(c.removeClass)(this.wrapEl,"paused"),this.isTooltipOpened())this.hideTooltip();else{if(!this.isActive){this.id>=this.layer.activeStory.id&&this._markSeenCurrentStory(!0);var n=this.layer.storiesBlocks;return n.indexOf(this.layer.getBlockKey(this.data))>n.indexOf(this.layer.blockKey)?this.layer.sendNavigationStatEvents("go_to_next_author"):this.layer.sendNavigationStatEvents("go_to_previous_author"),void this.opts.onSelect(this)}o?this.isPaused()&&this.playStory(!1,!!r):this._onPlayEnd()}}else t()}},e.prototype._markSeenIfNeeded=function(e){this.isActiveStoryOneTime()&&this._markSeenCurrentStory(e)},e.prototype._markSeenCurrentStory=function(e){void 0===e&&(e=!1),this.opts.onSeen(this.layer.activeStory,e)},e.prototype.longTapHandle=function(){this.isActiveStoryOneTime()||(this.story&&this.story.pause(),Object(c.addClass)(this.wrapEl,"paused"),this.isTooltipOpened()||this.layer.sendNavigationStatEvents("pause_long_tap"))},e.prototype.isLocked=function(){return!!(this.getSendText()||!this.isActive||this.isSendFormActive||this.isModalShown||this.isFeedbackTooltipShow||document.hidden||this._isActionsShown()||Object(c.isVisible)(this.inlineLoader)||Object(c.hasClass)(this.wrapEl,"hiding_reply")||Object(ne.curBox)()&&"stories"!==Object(ne.curBox)().wkRaw||this.story&&this.story.isPausedByMetaScroll)},e.prototype.isSpaceLongTabAvailable=function(){return!(this.story&&this.story.isPausedByMetaScroll)},e.prototype.isGroupedStory=function(){return this.data.is_groups},e.prototype.autoResumeStory=function(e){void 0===e&&(e=!1),this.audioPlaying||this.isTooltipOpened()||this.playStory(!1,e)},e.prototype.playStory=function(e,t){void 0===e&&(e=!1),void 0===t&&(t=!1),this.isLocked()||(Object(c.removeClass)(this.wrapEl,"paused"),Object(c.hide)(Object(c.ge)("box_layer_bg")),Object(c.hide)(Object(c.ge)("box_layer_bg").nextSibling),this.story&&!e||this._initStory(),this.story&&this.story.play(),t&&this.layer.sendNavigationStatEvents("resume_release"),delete this.downTs)},e.prototype.pauseStory=function(e){this.story&&(this.isPaused()||(e&&Object(c.addClass)(this.wrapEl,"paused"),this.story.pause()))},e.prototype.changeStory=function(e){this.index===e||this.isSendFormActive||(this._destroyStory(),this.index=e,this.hideTooltip(),this._setPreview(),this.playStory())},e.prototype.getWrap=function(){return this.wrapEl},e.prototype.stop=function(){this._destroyFeedBackTT(),this.isActive=!1,this._destroyStory(),this._stopLoader(),Object(c.val)(Object(c.geByClass1)("stories_send_form_text",this.wrapEl),""),this._unlockSendForm(),Object(c.removeClass)(this.wrapEl,"autoplay_failed")},e.prototype.getCurStoryData=function(){var e=this.data.items[this.index];return e||Object(We.logError)(new Error("getCurStoryData: data is undefined"),{environment:"stories"}),e},e.prototype.isActiveLive=function(){var e;return"live"===(null===(e=this.getCurStoryData())||void 0===e?void 0:e.type)},e.prototype.isLiveEnded=function(){return!!this.story&&(this.isActiveLive()&&this.story.liveEnded)},e.prototype._initStory=function(){var e=this.getCurStoryData();if(e){var t=e.type,r=e.noSound;this.story&&this._destroyStory(),ot(this),Object.assign(e,{authorId:this.getOwnerId()});var i={onLoadingStart:this._onLoadingStart.bind(this),onLoadingEnd:this._onLoadingEnd.bind(this),onPlay:this._onPlay.bind(this),onPause:this._onPause.bind(this),onError:this._showError.bind(this),onLongLoading:this._showLoader.bind(this),onAutoPlayFail:this._onAutoPlayFail.bind(this)};if("live"===t)this.story=new $e(e,i,this.wrapEl);else{"video"===t?(this.story=new Ze(e,i),r&&this.opts.restoreAudioPlay(),Object(c.addClass)(this.wrapEl,"video")):(this.story=new tt(e,i),this.opts.restoreAudioPlay(),Object(c.removeClass)(this.wrapEl,"video"));var n=this.story.getDate();e.isPromo?n=e.promoCaption:e.narrative?n="· "+Object(Se.getLang)("global_type_narrative")+" · "+e.narrative.title:e.isAds&&(n=Object(Se.getLang)("stories_is_ad")),Object(c.val)(this.descEl,n),this.fillTimeLine()}if("live"===t||"video"===t)b()>0&&this.opts.onVideoPlay();this.opts.onStartStory(),Object(c.toggleClass)(this.wrapEl,"stories_can_comment",e.can_comment),e.reply_to&&!this.hasSticker(A.StickerTypes.storyReply)&&this.replyToWrap.appendChild(this._renderReplyTo()),this.story.isGroupsMetaStory=e.is_groups_meta_story,this.story.isAppsMetaStory=e.is_apps_meta_story,!this.data.author.can_follow||this.data.is_promo||this.isActiveLive()||this.authorButtons.appendChild(this._renderFollowButton()),this._destroyFeedBackTT(),this.story.isGroupsMetaStory||this.story.isAppsMetaStory||(this.updateBottom(),this.contWrap.appendChild(this.story.render())),e.clickable_stickers&&(this.stickerLayers=a.render(o.createElement(re,{story:this.story,storyData:e,author:this.data.author,showMessage:this.showMessage.bind(this),playStory:this.playStory.bind(this),pauseStory:this.pauseStory.bind(this),hideFeedbackTooltip:this.hideFeedbackTooltip.bind(this),onModalShownChange:this._onModalsShownChange.bind(this),onMouseUpHandle:this._onMouseUpHandle.bind(this),onMouseDownHandle:this._onMouseDownHandle.bind(this),sendNavigationStatEvents:this.layer.sendNavigationStatEvents.bind(this.layer),markAppNotificationsSeen:this.markAppNotificationsSeen,list:this.layer.list,layerEl:this.layer.layerEl,el:this.contWrap}),this.contStickers)),this.story.isGroupsMetaStory&&(Object(c.addClass)(this.contWrap,"stories_item_cont_wrap_meta_story"),Object(c.addClass)(this.contWrap,"stories_item_cont_wrap_meta_story_groups"),this.contWrap.appendChild(this.story.render()),this.authorButtons.appendChild(Object(c.ce)("div",{className:"stories_groups_settings_text stories_groups_settings_text_hide",innerHTML:Object(Se.getLang)("stories_groups_grid_title")})),Object(c.re)(Object(c.geByClass1)("stories_photo",this.contWrap)),Object(c.re)(Object(c.geByClass1)("stories_video",this.contWrap)),this.contWrap.appendChild(this.story.renderGroupsMetaStory())),this.data.is_apps&&(this.story.isAppsMetaStory?(Object(c.addClass)(this.contWrap,"stories_item_cont_wrap_meta_story"),Object(c.addClass)(this.contWrap,"stories_item_cont_wrap_meta_story_apps"),this.contWrap.appendChild(this.story.render()),this.authorButtons.appendChild(Object(c.ce)("div",{className:"stories_groups_settings_text stories_groups_settings_text_hide",innerHTML:Object(Se.getLang)("stories_groups_grid_title")})),Object(c.setStyle)(Object(c.geByClass1)("stories_preview",this.contWrap),{backgroundImage:""}),Object(c.re)(Object(c.geByClass1)("stories_photo",this.contWrap)),Object(c.re)(Object(c.geByClass1)("stories_video",this.contWrap)),this.contWrap.appendChild(this.story.renderAppsMetaStory())):(Object(c.removeClass)(this.contWrap,"stories_item_cont_wrap_meta_story"),Object(c.removeClass)(this.contWrap,"stories_item_cont_wrap_meta_story_apps")))}else Object(We.logError)(new Error("Fail: _initStory"),{environment:"stories"})},e.prototype.hasSticker=function(e){var t=this.getCurStoryData();if(!t||!t.clickable_stickers)return!1;var r=t.clickable_stickers.stickers;return!!Array.isArray(r)&&r.some((function(t){return t.type===e}))},e.prototype.getSticker=function(e){var t=this.getCurStoryData();if(t&&t.clickable_stickers){var r=t.clickable_stickers.stickers;if(Array.isArray(r))return r.find((function(t){return t.type===e}))}},e.prototype.isTooltipOpened=function(){return this.stickerLayers&&this.stickerLayers.isShownTooltip()},e.prototype.hideTooltip=function(e){void 0===e&&(e=!1),this.isTooltipOpened()&&(this.stickerLayers&&this.stickerLayers.hideTooltip(),e||this.playStory())},e.prototype.getReplies=function(){return this.story&&this.story.getReplies()},e.prototype.getViews=function(){return this.story&&this.story.getViews()},e.prototype.setReplies=function(e){return this.story&&this.story.setReplies(e)},e.prototype.setViews=function(e){return this.story&&this.story.setViews(e)},e.prototype.indexToUnread=function(e){void 0===e&&(e=!1);var t=this.data.items,r=0;for(var i in t)if(t[i].unread&&!this.layer._hasContext("all")){r=Number(i);break}if(e)return r;this.index=r,this._setPreview()},e.prototype.indexToStoryById=function(e){var t=this.data.items,r=-1;for(var i in t)if(t[i].raw_id===e){r=Number(i);break}this.layer._hasContext("all")&&(r=0),r>-1?(this.index=r,this._setPreview()):this.indexToUnread()},e.prototype.fillTimeLine=function(){var e=this.timeLineEl;if(e)for(var t=0;t<e.children.length;t++){var r=Object(c.geByClass1)("stories_time_line_item_cont_active",e.children[t]);t===this.index&&(this._currentTimeLineEl=r,this._currentTimeLineAdditionalEl=Object(c.geByClass1)("stories_time_line_item_wick",e.children[t]));var i=t<this.index?100:0;Object(c.setStyle)(r,"transform","translateX("+i+"%)")}},e.prototype._destroyStory=function(){if(this.story){this.updateBottom(!0),window.tooltips&&window.tooltips.hideAll(),this.hideTooltip(),this._resetErrors(),this._destroyFeedBackTT(),this._closeFeatureTooltip(!1),this.story.pause(),Object(c.removeClass)(this.contWrap,"stories_item_cont_wrap_meta_story"),Object(c.re)(Object(c.geByClass1)("MetaStory",this.contWrap)),Object(c.removeClass)("stories_item_cont_wrap_meta_story_groups",this.contWrap);var e=this.getCurStoryData();e&&e.clickable_stickers&&(a.unmountComponentAtNode(this.contStickers),delete this.stickerLayers),cancelAnimationFrame(this.timeLineAnim);try{this.contWrap.removeChild(this.story.getContainer()),this.story.destroy()}catch(e){Object(We.logError)(e)}this._replyHideEnd(),Object(j.removeEvent)(this.followBtn),Object(c.val)(this.authorButtons,""),Object(j.removeEvent)(this.answersEl),Object(j.removeEvent)(Object(c.geByClass1)("stories_reply_to",this.replyToWrap)),Object(c.val)(this.replyToWrap,""),this.hideInlineLoader(),delete this.story}},e.prototype._timeLineUpdate=function(){var e=this.story;if(e&&!e.isPaused()&&!this.isActiveLive()){var t=this.getStoryProgressPercent(),r=t/100;if(Object(c.setStyle)(this._currentTimeLineEl,"transform","translateX("+t+"%) translateZ(0)"),this._currentTimeLineAdditionalEl&&this._currentTimeLineEl){var i=this._currentTimeLineEl.clientWidth*r;Object(c.setStyle)(this._currentTimeLineAdditionalEl,"transform","translateX("+i+"px) translateZ(0)")}t<100?this.timeLineAnim=requestAnimationFrame(this._timeLineUpdate.bind(this)):this._onPlayEnd(!0)}},e.prototype.getStoryProgressPercent=function(){if(!this.story)return 0;var e=this.story.getCurrentTime(),t=this.story.getDuration();return Math.max(0,Math.min(100,e/t*100))},e.prototype._onLoadingStart=function(){this._loadingStartTime=+new Date},e.prototype._onLoadingEnd=function(){this._loadingStartTime&&(this.loadingTime=+Date.now()-this._loadingStartTime,this.layer.sendViewerStartTime(this.getRawId(),this.loadingTime),this._loadingStartTime=0)},e.prototype._onPlay=function(){this._resetErrors(),this._stopLoader(),this._timeLineUpdate(),this.preloadNextStory(),this.opts.onPlayStory(),Object(c.removeClass)(this.wrapEl,"animate_story"),Object(c.removeClass)(this.wrapEl,"autoplay_failed"),this.data.is_groups||this.isAppsMetaStoryActive()||(this.data.items[this.getIndex()].unread=!1),this._updateFeedStoryPreview(),ot(this)},e.prototype._onPause=function(){cancelAnimationFrame(this.timeLineAnim),ot(this)},e.prototype._onPlayEnd=function(e){void 0===e&&(e=!1),this._markSeenIfNeeded(),this.nextStory(e)},e.prototype.nextStory=function(e){if(void 0===e&&(e=!1),!this.isLocked()){var t=this.data.items;e||this.layer.sendNavigationStatEvents("go_to_next_story_tap");var r=this.index+1;r<t.length?(e&&this.layer.sendNavigationStatEvents("go_to_next_story_auto_by_time"),this.changeStory(r)):(this.opts.onStoriesEnd(e),this._destroyStory())}},e.prototype.prevStory=function(){if(this.isFeedbackTooltipShow&&this.hideFeedbackTooltip(),!this.isLocked()){this.layer.sendNavigationStatEvents("go_to_previous_story");var e=this.index-1;e>=0?this.changeStory(e):(this.opts.playPrevOwner(),this._destroyStory())}},e.prototype.getOffsetLeft=function(){return this.wrapEl.offsetLeft+this.wrapEl.offsetWidth/2},e.prototype.getWidth=function(){return this.wrapEl.offsetWidth},e.prototype.removeStoryBox=function(){var e=this,t=this.getCurStoryData();if(t){var r=t.isPartOfNarrative?Object(Se.getLang)("stories_remove_from_narrative_warning"):Object(Se.getLang)("stories_remove_warning");this.pauseStory(),Object(W.showFastBox)({title:Object(Se.getLang)("global_warning"),onHide:function(){e.playStory()}},r,Object(Se.getLang)("stories_remove_confirm"),this.removeStory.bind(this),Object(Se.getLang)("global_cancel"))}else Object(We.logError)(new Error("Fail: removeStoryBox"),{environment:"stories"})},e.prototype.removeStoryFromNarrative=function(){var e=this,t=this.getCurStoryData();if(t){var r=Object(Se.getLang)("stories_remove_only_from_narrative_warning");this.pauseStory();Object(W.showFastBox)({title:Object(Se.getLang)("global_warning"),onHide:function(){e.playStory()}},r,Object(Se.getLang)("stories_remove_confirm"),(function(r){var i=t.narrative_prepared,o=e.getIndex();i.stories=i.stories.filter((function(e){return e.rawId!==t.raw_id})),Object(pt.lockButton)(r),e.editNarrativeRequest(i).then((function(){var t=Object(ne.curBox)();t&&t.hide(),e.updateDataInPreparedNarrative("stories",i.stories),e.updateDataInOldNarrative("stories_count",i.stories.length),e._popStoryAndClearList(o),e.updateNarrativeBlockIfNeeded()})).catch((function(){var e=Object(ne.curBox)();e&&e.hide(),Object(We.logError)(new Error("Fail: removeStoryFromNarrative"),{environment:"stories"})}))}),Object(Se.getLang)("global_cancel"))}else Object(We.logError)(new Error("Fail: removeStoryFromNarrative"),{environment:"stories"})},e.prototype.removeStory=function(e){var t=this;this.pauseStory();var r=this.getIndex(),i={act:"remove_story",story_raw:this.getRawId(),hash:this.data.remove_hash,moder_remove_hash:this.data.moder_remove_hash};Object(ht.isClaimContent)()&&(i.claim=window.nav.objLoc.claim),window.ajax.post("al_stories.php",i,{onDone:function(){t.layer.sendNavigationStatEvents("delete"),Object(ne.curBox)().hide(),t._popStoryAndClearList(r),t.updateNarrativeBlockIfNeeded()},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}})},e.prototype.removeNarrativeBox=function(){var e=this;this.pauseStory(),Object(W.showFastBox)({title:Object(Se.getLang)("global_warning"),onHide:function(){e.playStory()}},Object(Se.getLang)("stories_narrative_remove_warning"),Object(Se.getLang)("stories_remove_confirm"),this.removeNarrative.bind(this),Object(Se.getLang)("global_cancel"))},e.prototype.removeNarrative=function(e){var t=this;this.pauseStory();var r=this.getCurStoryData();if(r){var i=r.narrative,o=i.owner_id,n=i.id;window.ajax.post("al_stories.php",{act:"remove_narrative",narrative_raw:o+"_"+n,hash:this.data.remove_hash,moder_remove_hash:this.data.moder_remove_hash},{onDone:function(){Object(ne.curBox)().hide(),t._popCoverAndCleanNarrativeList(),t.updateNarrativeBlockIfNeeded()},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}})}else Object(We.logError)(new Error("Fail: removeNarrative"),{environment:"stories"})},e.prototype._popCoverAndCleanNarrativeList=function(){this.opts.removeList(),this._remove(!1,function(){var e,t;null===(t=null===(e=window.cur.storyLayer)||void 0===e?void 0:e.activeStory)||void 0===t||t._popStoryAndClearList(window.cur.storyLayer.activeStory.getIndex())}.bind(this))},e.prototype.sendNarrativeBookmarkButtonDidPress=function(){var e=this,t=this.getCurStoryData();if(t){var r=t.narrative;window.ajax.post("al_bookmarks.php",{act:"bookmark",owner_id:r.owner_id,object_id:r.id,type:"narrative",state:r.is_bookmarked?1:0,hash:r.bookmark_hash,ref:window.cur.module},{onDone:function(t){Object(ne.showDoneBox)(t||Object(Se.getLang)("stories_narrative_bookmark_deleted"),{className:"stories_done_msg"}),r.is_bookmarked=!r.is_bookmarked,e.updateBottom()}})}else Object(We.logError)(new Error("Fail: sendNarrativeBookmarkButtonDidPress"),{environment:"stories"})},e.prototype.sendNarrativeEditButtonDidPress=function(){var e=this.getCurStoryData();if(e)if(this.getOwnerId()>0&&Object(ae.partConfigEnabled)("narratives_new"))this.editCurrentNarrative();else{var t=e.narrative;window.nav.go(this.data.author.href+"?act=narrative_edit&nid="+t.id)}else Object(We.logError)(new Error("Fail: sendNarrativeEditButtonDidPress"),{environment:"stories"})},e.prototype.setStoryAsCover=function(){var e=this,t=this.getCurStoryData();if(t){var r=t.narrative_prepared,i=r.coverStoryRawId;this.updateDataInPreparedNarrative("coverStoryRawId",t.raw_id),this.editNarrativeRequest(r).then((function(){e.updateNarrativeBlockIfNeeded(),e.showDoneBox(Object(Se.getLang)("stories_narrative_cover_updated"))})).catch((function(){e.updateDataInPreparedNarrative("coverStoryRawId",i)})).finally((function(){e.updateBottom()}))}},e.prototype.updateDataInPreparedNarrative=function(e,t){this.data.items.forEach((function(r){(null==r?void 0:r.narrative_prepared)&&(null==r?void 0:r.narrative_prepared[e])&&(r.narrative_prepared[e]=t)}))},e.prototype.updateDataInOldNarrative=function(e,t){this.data.items.forEach((function(r){(null==r?void 0:r.narrative)&&(null==r?void 0:r.narrative[e])&&(r.narrative[e]=t)}))},e.prototype.editNarrativeRequest=function(e){var t=e.id,r=e.ownerId,i=e.editHash,o=e.title,n=e.stories,a=e.coverStoryRawId.split("_")[1];return new Promise((function(e,s){window.ajax.post("al_stories.php",{act:"edit_narrative",owner_id:r,title:o,cover_story_id:a,hash:i,stories:Object(ft.prepareStoriesForPublishing)(n),narrative_id:t},{onDone:function(){e()},onFail:function(e){return Object(ne.showDoneBox)(e||Object(Se.getLang)("global_error")),s(),!0}})}))},e.prototype._popStoryAndClearList=function(e){this._removeStoryFromMemoryByIndex(e),0===this.data.items.length&&R(this.getOwnerId())},e.prototype._removeStoryFromMemoryByIndex=function(e,t){void 0===t&&(t=!1),this.data.items.splice(e,1);var r=this.data.items.length;r?(this._initTimeLine(),r>e?this.isActive&&this.playStory(!0):this.isActive&&this.nextStory()):this._remove(t)},e.prototype._remove=function(e,t){this.opts.onStoryRemoved(e,t)},e.prototype.shareBox=function(){var e=this;if(this.story){var t=this.getCurStoryData();if(t){var r,i=t.narrative;r=i?"narrative"+i.owner_id+"_"+i.id:"story"+this.story.getId(),this.pauseStory(),Object(W.showBox)("like.php",{act:"publish_box",object:r,from:"wkview"},{onDone:function(){e.autoResumeStory()},params:{onHide:function(){e.autoResumeStory()}}})}else Object(We.logError)(new Error("Fail: shareBox"),{environment:"stories"})}},e.prototype.toggleLikeStory=function(){var e=this;if(this.story){var t=this.story.data,r=t.isLiked,i=t.likeHash,o=t.accessKey,n=this.getRawId(),a={act:r?"delete_like":"like",hash:i,story_raw_id:n};r||Object.assign(a,{access_key:o}),t.isLiked=!r,this.updateBottom(),window.ajax.post("al_stories.php",a,{onDone:function(){e.layer.sendNavigationStatEvents(r?"click_to_unlike":"click_to_like")},onFail:function(){return t.isLiked=r,e.updateBottom(),!0}})}},e.prototype.onAnswerSend=function(e,t,r,i){var o=this;void 0===t&&(t=[]),void 0===r&&(r={}),void 0===i&&(i={});var n=this.getSendText();if((n||t.length)&&this.story)if(this.isActiveLive())this.story.sendMessage(n,e);else{var a=this.story.data.narrative;a?t.push(["narrative",a.owner_id+"_"+a.id]):t.push(["story",this.story.getId()]),window.ajax.post("al_im.php",Object.assign({act:"a_send",msg:n,hash:this.data.send_hash,media:Object(_t.convertAttachesToPhpMedia)(t),entrypoint:"stories_comment",to:this.getOwnerId()},r),{onDone:function(){o.onAnswerSent(e,r,i)},onFail:function(e){return o.showMessage(e).catch((function(e){Object(We.logError)(e)})),!0},showProgress:function(){Object(c.val)(o.sendFormButton,o._getLoaderHtml()),Object(c.addClass)(o.sendFormButton,"sending")},hideProgress:function(){Object(c.val)(o.sendFormButton,""),Object(c.removeClass)(o.sendFormButton,"sending")}})}},e.prototype.onAnswerSent=function(e,t,r){var i=this;if(void 0===e&&(e=function(){}),void 0===t&&(t={}),void 0===r&&(r={}),!this.isActiveLive()){this.showMessage(Object(Se.getLang)("stories_answer_sent")).then((function(){i.playStory()})).catch((function(e){Object(We.logError)(e)}));var o=t.sticker_referrer||"",n={},a="";"story_keyboard"===o?a="sticker_keyboard_send":o.startsWith("story_suggestion_")?a="sticker_suggestion_send":"story_reaction"===o?(a="sticker_reaction_send",n.reaction_name=r.reactionName):a="comment_send",this.layer.sendNavigationStatEvents(a,!0,n)}Object(c.val)(Object(c.geByClass1)("stories_send_form_text",this.wrapEl),""),Object(S.cancelStackPop)(),this.pauseStory(),e&&e()},e.prototype.onSendFormFocus=function(){var e=this;this.pauseStory(),this.isActiveLive()||this._toggleSendFormOverlay(!0),this.hideTooltip(!0),this.hideFeedbackTooltip(),Object(S.cancelStackPush)("stories_form_focus",(function(){dt.Emoji.shown||(e._resetFendForm(),e._blurSendForm())}))},e.prototype._toggleSendFormOverlay=function(e){void 0===e&&(e=!1),Object(c.toggleClass)(this.storySendFormOverlay,"stories_bottom_overlay_available",this.isSendFormActive=e)},e.prototype._blurSendForm=function(){var e=Object(c.geByClass1)("stories_send_form_text",this.wrapEl);e&&e.blur()},e.prototype.getSendText=function(){var e=dt.Emoji.editableVal(Object(c.geByClass1)("stories_send_form_text",this.wrapEl));return Object(l.trim)(e)},e.prototype.onSendFormBlur=function(){var e=this.getSendText();this.isActiveLive()||this._toggleSendFormOverlay(!1),e||this._resetFendForm()},e.prototype._unlockSendForm=function(){this.isSendFormActive&&(this.isSendFormActive=!1)},e.prototype._resetFendForm=function(){this._unlockSendForm(),this.playStory(),Object(c.val)(Object(c.geByClass1)("stories_send_form_text",this.wrapEl),"")},e.prototype._emojiOnKeyAction=function(){this.getSendText()?Object(c.addClass)(this.sendFormButton,"active"):Object(c.removeClass)(this.sendFormButton,"active")},e.prototype._getLoaderHtml=function(){return'<svg class="stories_view_loader_circular" viewBox="25 25 50 50">\n      <circle class="stories_view_loader_circular_path" cx="50" cy="50" r="20" fill="none" stroke-width="4" stroke-miterlimit="10"/>\n    </svg>'},e.prototype.preloadNextStory=function(e){if(void 0===e&&(e=this.index+1),!this.preloadedStories[e]){var t=this.data.items[e];if(t){this.preloadedStories[e]=!0;var r="video"===t.type?t.video_url:t.photo_url;r&&("video"===t.type?g(r).catch((function(e){return Object(We.logError)(e)})):f(r).catch((function(e){return Object(We.logError)(e)})))}}},e.prototype.addToBlacklist=function(){window.cur.storyLayer&&window.cur.storyLayer.pauseStory(),Object(W.showFastBox)({title:Object(Se.getLang)("stories_add_blacklist_title"),onHide:function(){window.cur.storyLayer&&window.cur.storyLayer.playStory()}},this.getOwnerId()<0?Object(Se.getLang)("stories_add_blacklist_message_group"):Object(Se.getLang)("stories_add_blacklist_message"),Object(Se.getLang)("stories_add_blacklist_button"),this._doAddToBlacklist.bind(this),Object(Se.getLang)("global_cancel"))},e.prototype._doAddToBlacklist=function(e){var t=this;window.ajax.post("al_stories.php",{act:"blacklist_add",owner_id:this.getOwnerId(),hash:this.data.blacklist_hash,source_story:this.getRawId(),track_code:this.getTrackCode()},{onDone:function(){t.data.can_blacklist=!1,t.layer.sendNavigationStatEvents("hide_from_stories"),Object(ne.curBox)().hide(),t.opts.removeList(),t._remove()},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}})},e.prototype.markNotInterested=function(){var e=this,t=this.getCurStoryData();if(t)if(t.isAds&&Object(ae.partConfigEnabled)("ads_new_reports_web_histories")){var r="",i=t.track_code,o=Object(W.showBox)("reports.php",{act:"hide_ad_box",track_code:i,type:"story"},{onDone:function(){var e=Object(c.geByClass)("radiobtn","ad_hide");window.radioBtns.ad_hide={val:0,els:e};var t=Object(c.ge)("ad_csrf");r=t?t.value:r},params:{onClean:function(){delete window.radioBtns.ad_hide,e.playStory()}},stat:["reports.css"]});o.removeButtons(),o.addButton(Object(Se.getLang)("box_send"),(function(n){Object(pt.lockButton)(n),window.ajax.post("reports.php",{act:"hide_ad",track_code:i,reason_id:window.radioBtns.ad_hide.val,hash:r},{onDone:function(){Object(pt.unlockButton)(n),o.hide(),e._markNotInterested(t.track_code,t.canMarkNotInterestedHash)}})})),o.addButton(Object(Se.getLang)("global_cancel"),!1,"no")}else this._markNotInterested(t.track_code,t.canMarkNotInterestedHash);else Object(We.logError)(new Error("Fail: markNotInterested"),{environment:"stories"})},e.prototype._markNotInterested=function(e,t){var r=this;this.showMessage(Object(Se.getLang)("stories_thanks_feedback")).catch((function(e){Object(We.logError)(e)})),window.ajax.post("al_stories.php",{act:"mark_not_interested",story_raw_id:this.getRawId(),track_code:e,hash:t},{onDone:function(){r.layer.sendNavigationStatEvents("mark_not_interested")}})},e.prototype._resetErrors=function(){var e=Object(c.geByClass1)("stories_error_wrap",this.contWrap);e&&(Object(j.removeEvent)(Object(c.geByClass1)("stories_error_button",e)),Object(c.re)(e)),Object(c.removeClass)(this.wrapEl,"failed"),Object(c.removeClass)(this.wrapEl,"fatal_error")},e.prototype._showError=function(e){var t=this;if(this.contWrap){var r,i,o=e;switch(e){case"load":r=Object(Se.getLang)("stories_error_cant_load"),i=Object(c.ce)("div",{className:"stories_error_button",innerHTML:Object(Se.getLang)("stories_try_again")}),Object(j.addEvent)(i,"click",(function(){t._destroyStory(),t.playStory()}));break;case"expired":r=Object(Se.getLang)("stories_error_expired");break;case"deleted":r=Object(Se.getLang)("stories_error_deleted");break;case"private":r=Object(Se.getLang)("stories_error_private");break;case"deleted-narrative":r=Object(Se.getLang)("stories_error_deleted_narrative");break;case"private-narrative":r=Object(Se.getLang)("stories_error_private_narrative");break;case"isOneTimeSeen":r=Object(Se.getLang)("stories_error_one_time_seen");break;default:r=Object(Se.getLang)("global_unknown_error")}this._resetErrors(),this._stopLoader();var n=Object(c.ce)("div",{className:"stories_error_wrap"}),a=Object(c.ce)("div",{className:"stories_error"}),s=Object(c.ce)("div",{className:"stories_error_cont"});a.appendChild(s),s.appendChild(Object(c.ce)("div",{className:"stories_error_icon "+o})),s.appendChild(Object(c.ce)("div",{className:"stories_error_caption",innerHTML:r})),i&&s.appendChild(i),n.appendChild(a),this.contWrap.appendChild(n),Object(c.addClass)(this.wrapEl,"failed"),Object(l.inArray)(e,["expired","deleted","private","deleted-narrative","private-narrative"])&&Object(c.addClass)(this.wrapEl,"fatal_error")}},e.prototype._stopLoader=function(){var e=this;setTimeout((function(){Object(c.re)(Object(c.geByClass1)("stories_loader",e.contWrap))}),0)},e.prototype._showLoader=function(){if(this._stopLoader(),this.isActive&&(!this.isLoaded()||this.isPaused())&&this.contWrap){var e=Object(c.ce)("div",{className:"stories_loader",innerHTML:this._getLoaderHtml()});this.contWrap.appendChild(e)}},e.prototype._onFollowBtnClick=function(){var e,t,r=this;(this.pauseStory(),this.followBtnLock)||(this.followBtnLock=!0,this.data.author.id>0?(t="al_friends",e=this.data.author.can_follow?"add":"remove"):(t="al_groups",e=this.data.author.can_follow?"a_enter":"a_leave"),window.ajax.post(t+".php",{act:e,mid:this.getOwnerId(),gid:-this.getOwnerId(),hash:this.data.author.hash,from:"stories"},{onDone:function(){r.data.author.can_follow&&r.sendStatEvent("follow"),r.data.author.can_follow=!r.data.author.can_follow,Object(c.toggleClass)(r.followBtn,"followed",!r.data.author.can_follow),r.showMessage(Object(Se.getLang)(r.data.author.can_follow?"stories_unfollowed":"stories_followed")).then((function(){return r.playStory()})).catch((function(e){Object(We.logError)(e)})),window.tooltips&&window.tooltips.destroy(r.followBtn),Object(j.triggerEvent)(r.followBtn,"mouseover")},showProgress:function(){return r.showInlineLoader()},hideProgress:function(){r.hideInlineLoader(),r.followBtnLock=!1}}))},e.prototype._getDimensions=function(){var e=Object(c.getSize)(this.wrapEl),t=e[0],r=e[1],i=Object(c.getXY)(this.wrapEl),o=i[0];return{width:t,height:r,top:i[1]-Object(lt.scrollGetY)(),left:o-Object(lt.scrollGetX)()}},e.prototype.markAsActive=function(){this.isActive=!0,Object(c.addClass)(this.wrapEl,"animate_story")},e.prototype._renderReplyTo=function(){var e=this,t=this.getCurStoryData();if(t){var r=t.reply_to,i=r.list,o=r.photo_url,n=r.name,a=r.is_deleted,s=r.is_private,l=r.is_expired,d=r.raw_id,u=Object(c.se)('<div class="stories_reply_to" style="background-image: url('+o+')">\n  <div class="stories_reply_to_error_msg"></div>\n  <div class="stories_reply_to_owner_name_wrap">\n    <div class="stories_reply_to_owner_name">'+n+"</div>\n  </div>\n</div>");Object(j.addEvent)(u,"click",(function(){e.layer.sendNavigationStatEvents("open_parent_story");var t=x();E.length>1&&t.getStoryRaw()===d?Object(S.cancelStackPop)():Object(H.showStory)(i,{fromEl:u,source:"reply_story"})}));var p="";return a?(Object(c.addClass)(u,"deleted"),p=Object(Se.getLang)("stories_deleted_story")):s?(Object(c.addClass)(u,"private"),p=Object(Se.getLang)("stories_private_story")):l&&(Object(c.addClass)(u,"expired"),p=Object(Se.getLang)("stories_expired_story")),p&&(Object(c.val)(Object(c.geByClass1)("stories_reply_to_error_msg",u),p),Object(c.re)(Object(c.geByClass1)("stories_reply_to_owner_name_wrap",u))),u}Object(We.logError)(new Error("Fail: _renderReplyTo"),{environment:"stories"})},e.prototype.sendMask=function(){var e=this;if(this.layer.sendNavigationStatEvents("click_to_mask"),!this._maskSending){var t=this.getCurStoryData();t?(this._maskSending=!0,this.pauseStory(),window.ajax.post("al_stories.php",{act:"send_mask",mask_id:t.mask_id,hash:this.data.send_mask_hash},{onDone:function(t,r,i,o){"cant_send"===t?Object(W.showFastBox)({title:r,width:460,onHide:function(){e.playStory()}},i,o):e.showMessage(Object(Se.getLang)("stories_mask_sent")).then((function(){return e.playStory()})).catch((function(e){Object(We.logError)(e)}))},showProgress:function(){return e.showInlineLoader()},hideProgress:function(){e._maskSending=!1,e.hideInlineLoader()}})):Object(We.logError)(new Error("Fail: sendMask"),{environment:"stories"})}},e.prototype._destroyFeedBackTT=function(){delete this.feedback,this.hideFeedbackTooltip()},e.prototype.hideFeedbackTooltip=function(){this.isFeedbackTooltipShow&&(this.isFeedbackTooltipShow=!1,this.autoResumeStory(),this.updateBottom(),Object(S.cancelStackPop)())},e.prototype.showFeedbackTooltip=function(){var e=this;this.isFeedbackTooltipShow||(this.hideTooltip(),this.pauseStory(),this.isFeedbackTooltipShow=!0,this.updateBottom(),this.layer.sendNavigationStatEvents("open_replies_list"),Object(S.cancelStackPush)("stories_feedback_tt",(function(){e.hideFeedbackTooltip()})))},e.prototype._onModalsShownChange=function(e){void 0===e&&(e=!1),this.isModalShown=e},e.prototype.showInlineLoader=function(){Object(c.show)(this.inlineLoader)},e.prototype.hideInlineLoader=function(){Object(c.hide)(this.inlineLoader)},e.prototype.volumeUpdate=function(){var e=this.story;e&&e.volumeUpdate&&e.volumeUpdate()},e.prototype._onAutoPlayFail=function(){Object(c.addClass)(this.wrapEl,"autoplay_failed")},e.prototype.hideReply=function(){var e=this;Object(W.showFastBox)({title:Object(Se.getLang)("global_warning"),onHide:function(){e.autoResumeStory()}},Object(Se.getLang)("stories_hide_reply_warning"),Object(Se.getLang)("global_continue"),this._doHideReply.bind(this),Object(Se.getLang)("global_cancel"))},e.prototype._doHideReply=function(){var e=this;this.pauseStory(),Object(c.addClass)(this.wrapEl,"hiding_reply"),Object(ne.curBox)().hide();var t=this.getIndex(),r=this.data.author.gender,i=Object(c.se)('<div class="stories_hide_reply_wrap loading">\n  <div class="stories_inline_loader">'+Object(mt.getProgressHtml)()+'</div>\n  <div class="stories_hide_reply_cont">\n    <div class="stories_hide_reply_icon"></div>\n    <div class="stories_hide_reply_info">'+Object(Se.getLang)("stories_reply_hidden")+'</div>\n    <div class="stories_hide_reply_continue_button _stories_reply_continue">'+Object(Se.getLang)("stories_hide_reply_continue")+'</div>\n  </div>\n  <div class="stories_hide_reply_other_actions">\n    <div class="stories_hide_reply_other_action _stories_hide_replies">'+Object(Se.langSex)(r,Object(Se.getLang)("stories_hide_all_replies"))+'</div>\n    <div></div>\n    <div class="stories_hide_reply_other_action _stories_reply_ban">'+Object(Se.getLang)("stories_reply_add_to_blacklist")+"</div>\n  </div>\n</div>");Object(j.addEvent)(Object(c.geByClass1)("_stories_reply_restore",i),"click",this._restoreReply.bind(this)),Object(j.addEvent)(Object(c.geByClass1)("_stories_reply_continue",i),"click",(function(){return e._replyHideEnd(t)})),Object(j.addEvent)(Object(c.geByClass1)("_stories_hide_replies",i),"click",this._hideAllReplies.bind(this)),Object(j.addEvent)(Object(c.geByClass1)("_stories_reply_ban",i),"click",this._ban.bind(this)),this.contWrap.appendChild(i),window.ajax.post("al_stories.php",{act:"hide_reply",raw_id:this.getRawId(),hash:this.data.reply_hide_hash},{onDone:function(){e.opts.removeList(),window.cur.needUpdateFeedStories=!0,Object(c.removeClass)(i,"loading")},onFail:function(){return e._resetReplyHide(),e.playStory(),!0}})},e.prototype._restoreReply=function(e){var t=this;Object(j.cancelEvent)(e);var r=Object(c.geByClass1)("stories_hide_reply_wrap",this.contWrap);window.ajax.post("al_stories.php",{act:"restore_reply",raw_id:this.getRawId(),hash:this.data.reply_hide_hash},{onDone:function(){t._resetReplyHide(),t.playStory()},showProgress:function(){return Object(c.addClass)(r,"loading")},hideProgress:function(){return Object(c.removeClass)(r,"loading")}})},e.prototype._resetReplyHide=function(){Object(c.re)(Object(c.geByClass1)("stories_hide_reply_wrap",this.contWrap)),Object(c.removeClass)(this.wrapEl,"hiding_reply")},e.prototype._hideAllReplies=function(){var e=this.data.author.first_name_gen;Object(W.showFastBox)({title:Object(Se.getLang)("global_warning")},Object(Se.getLang)("stories_delete_all_replies_confirm").replace("{name}",e),Object(Se.getLang)("global_continue"),this._doHideAllReplies.bind(this),Object(Se.getLang)("global_cancel"))},e.prototype._doHideAllReplies=function(e){var t=this;window.ajax.post("al_stories.php",{act:"hide_all_replies",owner_id:this.getOwnerId(),hash:this.data.reply_hide_hash},{onDone:function(){Object(ne.curBox)().hide(),t.opts.removeList(),t.data.items=[];var e=Object(c.geByClass1)("_stories_hide_replies",t.contWrap);Object(c.val)(e,Object(Se.getLang)("stories_all_replies_hidden")),Object(c.addClass)(e,"disabled")},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}})},e.prototype._ban=function(){var e=this.data.author.first_name_gen;Object(W.showFastBox)({title:Object(Se.getLang)("global_warning")},Object(Se.getLang)("stories_ban_confirm").replace("{name}",e),Object(Se.getLang)("global_continue"),this._doBan.bind(this),Object(Se.getLang)("global_cancel"))},e.prototype._doBan=function(e){var t=this;window.ajax.post("al_stories.php",{act:"ban",owner_id:this.getOwnerId(),hash:this.data.stories_ban_hash},{onDone:function(){Object(ne.curBox)().hide(),t.opts.removeList(),t.data.items=[];var e=Object(c.geByClass1)("_stories_reply_ban",t.contWrap);Object(c.val)(e,Object(Se.getLang)("stories_banned")),Object(c.addClass)(e,"disabled")},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}})},e.prototype._replyHideEnd=function(e){Object(c.geByClass1)("stories_hide_reply_wrap",this.contWrap)&&(this.data.items.length<=1&&R(this.getOwnerId()),this._resetReplyHide(),this._removeStoryFromMemoryByIndex(e||this.getIndex(),!Object(l.isNumeric)(e)))},e.prototype._feedbackRemoveReplyFromDom=function(e){var t=Object(c.geByClass1)("stories_feedback_content",this.wrapEl);if(t){var r=t.querySelector("#feed_story_"+e);r&&Object(c.addClass)(r,"removed")}},e.prototype.onReplyDeleted=function(e){this._feedbackRemoveReplyFromDom(e)},e.prototype._updateFeedStoryPreview=function(){var e=Object(c.ge)("feed_story_"+this.layer.getBlockKey(this.data));if(e&&!e.classList.contains("stories_feed_reply_item")&&e.classList.contains("stories_feed_preview_item")){var t=this.indexToUnread(!0);if(t){var r=this.data.items[t];r&&r.small_preview&&Object(c.setStyle)(e,"background-image","url("+r.small_preview+")"),e.classList.remove("stories_feed_sticker_icon_show")}}},e.prototype.sendStatEvent=function(e){var t=this.getCurStoryData();t?window.ajax.post("al_stories.php",Object(l.extend)({act:"stat",source_story:this.getRawId(),track_code:this.getTrackCode()},t.stats[e])):Object(We.logError)(new Error("Fail: sendStatEvent"),{environment:"stories"})},e.prototype._sendStatStickerEvent=function(e,t){var r=this.getCurStoryData();if(r){var i=r.clickable_stickers;window.ajax.post("al_stories.php",Object.assign({act:"stickers_stat",story_raw_id:this.getRawId(),action:e,hash:i.hash},t),{onDone:function(){}})}else Object(We.logError)(new Error("Fail: _sendStatStickerEvent"),{environment:"stories"})},e.prototype.report=function(){var e=this,t=this.getCurStoryData();if(t)if(t.isAds&&Object(ae.partConfigEnabled)("ads_new_reports_web_histories")){var r=t.track_code,i="",o=Object(W.showBox)("/reports.php",{act:"report_ad_box",track_code:r,type:"story"},{onDone:function(){var e=Object(c.geByClass)("radiobtn","ad_report");window.radioBtns.ad_report={val:0,els:e};var t=Object(c.ge)("ad_csrf");i=t?t.value:i},params:{onClean:function(){delete window.radioBtns.ad_report,e.playStory()}},stat:["reports.css"]});o.removeButtons(),o.addButton(Object(Se.getLang)("box_send"),(function(n){window.ajax.post("reports.php",{act:"report_ad_common",track_code:r,reason:window.radioBtns.ad_report.val,hash:i},{onDone:function(){var r=e.index,i="groups"===e.layer.list,n=t.narrative;o.hide(),e.layer.sendNavigationStatEvents("claim"),i||n||e._popStoryAndClearList(r),Object(ne.showDoneBox)(Object(Se.getLang)("stories_report_sent"),{className:"stories_done_msg"}),e.updateNarrativeBlockIfNeeded()},showProgress:function(){return Object(pt.lockButton)(n)},hideProgress:function(){return Object(pt.unlockButton)(n)}})})),o.addButton(Object(Se.getLang)("global_cancel"),!1,"no")}else{var n="story";this.isActiveLive()?n="live":t.narrative&&(n="narrative");var a=Object(W.showBox)("al_stories.php",{act:"report_box",type:n},{onDone:function(){var e=Object(c.geByClass)("radiobtn","stories_report");window.radioBtns.stories_report={val:0,els:e}},params:{onClean:function(){delete window.radioBtns.stories_report,e.playStory()}}});a.removeButtons(),a.addButton(Object(Se.getLang)("box_send"),this._sendReportButtonDidPress.bind(this)),a.addButton(Object(Se.getLang)("global_cancel"),!1,"no")}else Object(We.logError)(new Error("Fail: report"),{environment:"stories"})},e.prototype._sendReportButtonDidPress=function(e){var t=this,r=this.getCurStoryData();if(r){var i,o,n=this.index,a=r.narrative,s=r.report_hash,c="groups"===this.layer.list;a?(i=a.owner_id+"_"+a.id,o=a.report_hash):(i=this.getRawId(),o=s),window.ajax.post("al_stories.php",{act:"report",type:a?"narrative":"story",item_raw:i,reason:window.radioBtns.stories_report.val,hash:o},{onDone:function(){Object(ne.curBox)().hide(),t.layer.sendNavigationStatEvents("claim"),c||a||t._popStoryAndClearList(n),Object(ne.showDoneBox)(Object(Se.getLang)("stories_report_sent"),{className:"stories_done_msg"})},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}})}else Object(We.logError)(new Error("Fail: _sendReportButtonDidPress"),{environment:"stories"})},e.prototype.onLiveEnded=function(e){void 0===e&&(e=!1),this.isActiveLive()&&(this.data.items[this.index].can_share=!e,this.story&&this.story.onLiveEnded(),this.updateBottom())},e.prototype.updateLiveViewersCount=function(e){Object(c.val)(this.descEl,e)},e.prototype.isActiveStoryOneTime=function(){return this.story&&this.story.isOneTime()},e.prototype.isAppsMetaStoryActive=function(){return!(!this.story||!this.story.isAppsMetaStory)},e.prototype.buildStoryArchiveByActive=function(){var e=this.getRawId(),t=this.getCurStoryData();if(e&&t){var r=e.split("_")[1];return{id:Number(r),rawId:e,listId:this.layer.list,preview:t.small_preview}}},e.prototype.editCurrentNarrative=function(){var e=this,t=this.getCurStoryData();if(t){this.pauseStory(),this.isModalShown=!0;var r=t.narrative_prepared;if(r){var i=[];(null==r?void 0:r.stories.length)&&(i=gt(r.stories));var o={selectedStories:i,narrative:r,onClose:function(){e.updateNarrativeBlockIfNeeded(),e.isModalShown=!1,e.updateBottom(),e._popCoverAndCleanNarrativeList()}};Object(vt.showNarrativeEditorBox)(this.getOwnerId(),o)}}},e.prototype.updateNarrativeBlockIfNeeded=function(){window.cur.narrativeBlock&&window.cur.narrativeBlock.updateBlock()},e.prototype.showDoneBox=function(e){Object(ne.showDoneBox)(e,{className:"stories_done_msg"})},e}(),bt=r("mMuO"),wt="user_personal_card",kt="group_personal_card",St=r("4amH");r("HEwt"),r("a1Th"),r("Btvt"),r("rGqo"),r("rE2o"),r("ioFf"),r("KKXr");function jt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Et(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Et(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Et(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function Ot(){var e=navigator.connection;if(!e)return"";var t=e.effectiveType,r=e.downlink;switch(t){case"slow-2g":return"GPRS";case"2g":return"EDGE";case"3g":return"3G";case"4g":return r>8?"wi-fi":"LTE"}return""}var Ct=[];var Tt=[];var Lt=r("98sY"),It=function(){function e(e,t,r,i,o){this.storiesIdsSeen={};try{window.Videoview&&window.Videoview.togglePlay(!1)}catch(e){}this.initDOM(),this.show(),this._init(e,t,r,i),Object(c.addClass)(this.layerEl,"shown"),this._source=o.source,this._initViewerSource(),this._sendOpeningEvents()}return e.prototype._init=function(t,r,i,o){var n=t.split("&"),a=n[0],s=n[1],c=void 0===s?"":s,l=a.split("_"),d=l[0],u=l[1];this.storyRaw=a,this.storyOwner=d,this.storyId=+u,this.blockKey=""+d+c,this.list=r,this.storiesList=i,this.extra=e.parseExtra(o),this.extraRaw=o||"",this.initStories().catch((function(e){Object(Lt.debugLog)(e)}))},e.prototype.initStories=function(){var e=this;return new Promise((function(t){var r;e.storiesBlocks=e.storiesList.map((function(t){return e.getBlockKey(t)}));var i=!1,o=e.storiesBlocks.indexOf(e.blockKey);if(o>-1){var n=e.storiesList[o];i=n.items[n.items.length-1].unread}if(e.extra)switch(e.extra.context){case"new":i=!0;break;case"all":i=!1}if(i&&"replies"===e.list.substr(0,7)&&(i=!1),i){for(var a=[],s=0;s<e.storiesList.length;s++){var l=e.storiesList[s];(Array.isArray(l.items)&&l.items.length&&(null===(r=l.items[l.items.length-1])||void 0===r?void 0:r.unread)||0===s&&e._hasContext("new"))&&a.push(l)}a.length&&(e.storiesList=a,e.storiesBlocks=e.storiesList.map((function(t){return e.getBlockKey(t)})))}e.renderedStories={};var d=e._renderStories().activeStory;e.scrollToStory(d,!0),1===e.storiesList.length&&Object(c.addClass)(e.stories,"one_story"),e._startFirstStory(d,e.extra.story_id),Object(c.addClass)(e.stories,"inited"),t()}))},e.prototype.getBlockKey=function(e){return e.items&&e.items.length&&"live"===e.items[0].type?e.author.id+"live":e.is_narrative?e.author.id+"narrative"+e.items[0].narrative.id:this.list.includes("place")?e.author.id+"place":e.id?e.author.id+"id"+e.id:""+e.author.id},e.prototype._renderStories=function(){for(var e=this,t=[],r=0;r<this.storiesList.length;r++)this.storiesList[r]&&t.push(this.storiesList[r]);var i=this._getScreenStoriesCount(),o=this._getCurStoryPos(t.map((function(t){return e.getBlockKey(t)}))),n=Math.floor(i/2),a=t.slice(Math.max(0,o-n)).slice(0,i),s=a.map((function(t){return e.getBlockKey(t)}));for(var c in this.renderedStories)if(this.renderedStories.hasOwnProperty(c)){var l=this.renderedStories[c];s.includes(c)||(l.story.destroy(),delete this.renderedStories[c])}var d=null;if(a.map((function(t,r){var i=e.getBlockKey(t);if(!e.renderedStories[i]){var o=e.storiesBlocks.indexOf(i),a=t.author.id,s=new yt(t,{id:r,layer:e,onSelect:e._onSelectStory.bind(e),onStoriesEnd:e._onStoriesEnd.bind(e,o),onStoryRemoved:function(t,r){return e._onStoryRemoved(a,o,t,r)},playPrevOwner:e._playPrevOwner.bind(e,o),onPlayStory:e._onPlayStory.bind(e,o),onSeen:e._readStories.bind(e),onVideoPlay:e._onVideoPlay.bind(e),restoreAudioPlay:e._restoreAudioPlay.bind(e),onStartStory:e._onStartStory.bind(e),removeList:function(){return window.Stories.removeList(e.list)}});r<=n&&e.stories.children[r]?e.stories.insertBefore(s.render(),e.stories.children[r]):e.stories.appendChild(s.render()),e.renderedStories[i]={story:s,index:o},i===e.blockKey&&(d=s)}})),!d){var u=s[0];d=this.renderedStories[u].story}return{activeStory:d}},e.prototype._sendOpeningEvents=function(){if(this._source){var e;switch(this._source){case"narrative_story":e="narrative_open_stories";break;case"narrative_snippet":case"narrative_link":e="narrative_open";break;case"narrative_recommendations":e="narrative_other"}if(e&&this.sendNavigationStatEvents(e,!1),"narrative_fave"===this._source){var t=this.activeStory.getCurStoryData();if(t&&t.narrative){var r=t.narrative,i=r.owner_id,o=r.id;Object(it.statlogsValueEvent)("bookmarks_product_analytics",{item_type:"narrative",item_owner_id:i,item_id:o,time:window.getServerTime()})}}}},e.prototype._destroyStories=function(){for(var e in this.renderedStories){if(this.renderedStories.hasOwnProperty(e))this.renderedStories[e].story.destroy()}},e.prototype.destroy=function(){clearTimeout(this.timer),clearTimeout(this.animationTimer),this._destroyStories(),this._onVideoEnd(),Object(j.removeEvent)(this.volumeControl),Object(j.removeEvent)(this.layerEl),delete this.activeStory,delete this.volumeControl,delete this.renderedStories;try{this.layerEl&&document.body.removeChild(this.layerEl)}catch(e){}delete window.cur.storyLayer},e.prototype.getList=function(){return"story"+this.activeStory.getRawId()+"/"+this.list+(this.extraRaw?"/"+this.extraRaw:"")},e.prototype.getStoryRaw=function(){return!!this.activeStory&&this.activeStory.getRawId()},e.prototype.initDOM=function(){this.layerEl=Object(c.ce)("div",{className:"stories_layer"});var e=Object(c.ce)("div",{className:"stories_layer_cont"});this.layerEl.appendChild(e),e.appendChild(this._renderBackButton()),e.appendChild(this._renderVolumeControl()),this._updateVolumeButton(),this.stories=Object(c.ce)("div",{id:"stories_list",className:"stories_list"}),e.appendChild(this.stories),e.appendChild(Object(c.ce)("div",{className:"stories_layer_close"})),Object(j.addEvent)(this.layerEl,"click",this._onLayerClick.bind(this)),document.body.appendChild(this.layerEl)},e.prototype.show=function(){window.onBodyResize()},e.prototype.hide=function(e){var t=this;Object(c.addClass)(this.layerEl,"stories_layer_hiding"),this.hideAllLayers||N(),this._source&&this._source.startsWith("narrative")&&this.sendNavigationStatEvents("narrative_close",!1),this.activeStory&&(this.activeStory.pauseStory(),this.activeStory.hideTooltip(),this.activeStory.isActiveLive()&&this.sendNavigationStatEvents("live_player_close",!1),this._readStoriesIfNeeded(this.activeStory),this.activeStory.isActiveStoryOneTime()&&window.Stories.removeList(this.list)),!0!==e&&this.activeStory?this.animateStory("minimize").then((function(){return t.doHide()})).catch((function(){Object(Lt.debugLog)("error animate story")})):this.doHide(e),Object(c.removeClass)(this.layerEl,"shown")},e.prototype.doHide=function(e){if(this.destroy(),e||(E.pop(),window.cur.storyLayer=E[E.length-1],window.cur.storyLayer?window.cur.storyLayer.resumeLayer():(B(!0),window.layerQueue.pop())),window.wkcur&&window.wkcur.shown&&window.WkView.restoreLayer({}),"group_stories"===this.list&&window.Stories.groupStoriesBlockUpdate(),this.list.startsWith("archive")&&this.hideAllLayers&&!e){if(!window._message_boxes[window.cur.storiesArchiveBoxGUID])return;window._message_boxes[window.cur.storiesArchiveBoxGUID].forceHide=!1,window._message_boxes[window.cur.storiesArchiveBoxGUID]._show(!0,!1,!0),window.updateStoriesArchiveBoxPosition&&window.updateStoriesArchiveBoxPosition()}Object(rt.clear)()},e.prototype.back=function(){this.hideAllLayers=!1;var e=window.cancelStack[window.cancelStack.length-1];e&&"stories_form_focus"===e.name&&Object(S.cancelStackPop)(),this.hide(!1)},e.prototype._getScreenStoriesCount=function(){return 2*Math.floor(window.innerWidth/(.563*window.innerHeight))+1},e.prototype._getCurStoryPos=function(e){return(e||this.storiesBlocks).indexOf(this.blockKey)},e.prototype._startFirstStory=function(e,t){var r=this;this.activeStory=e,Object(c.addClass)(e.getWrap(),"active"),this.scrollToStory(),t||(t=this._hasContext("new")?t:this.storyRaw),e.indexToStoryById(t),this._startActiveStory(),setTimeout((function(){Object(c.addClass)(r.stories,"animated"),r.inited=!0,"open"===r.extra.replies&&r.activeStory.showFeedbackTooltip()}))},e.prototype._markReadRestStories=function(e){e.data.is_groups?this._onGroupsStoriesBlockViewEnd(e):e.data.is_apps?this._onAppsStoriesBlockViewEnd(e):(this._markReadStoriesInRange(e,e.index,e.data.items.length),this._updateBadge(e))},e.prototype._onGroupsStoriesBlockViewEnd=function(e){var t=this,r=window.Stories._getList("groups");if(r){var i=Object(c.ge)("feed_story_"+this.getBlockKey(e.data)),o=r.map((function(e){return e.author.id}));this._readAllStoriesByOwners(o,(function(){r.forEach((function(e){return e.items.forEach((function(e){return e.unread=!1}))})),e.data.items[0].unread=!1,t.updateMetaStoryItems(),t._resetGroupsBlockPreview(r[0],i),Object(c.removeClass)(i,"story_feed_new_item")}))}},e.prototype._onAppsStoriesBlockViewEnd=function(e){var t=this,r=window.Stories._getList("apps");if(r){var i=Object(c.ge)("feed_story_"+this.getBlockKey(e.data)),o=r.map((function(e){return e.author.id}));this._readAllStoriesByOwners(o,(function(){r.forEach((function(e){return e.items.forEach((function(e){return e.unread=!1}))})),e.data.items[1].unread=!1,t.updateMetaStoryItems(),Object(c.removeClass)(i,"story_feed_new_item")}))}},e.prototype._readAllStoriesByOwners=function(e,t){void 0===t&&(t=function(){}),window.ajax.post("al_stories.php",{act:"mark_owners_seen",owners_ids:e.join(","),hash:this.storiesReadHash},{onDone:function(){t()}})},e.prototype._resetGroupsBlockPreview=function(e,t){var r=e.items[0];t.classList.contains("stories_feed_preview_item")&&r&&r.small_preview&&Object(c.setStyle)(t,"background-image","url("+r.small_preview+")")},e.prototype._onSelectStory=function(e){var t,r=this;this.activeStory&&(t=this.activeStory.getWrap(),this.activeStory.stop()),e.id-this.activeStory.id>0&&this._markReadRestStories(this.activeStory),this.activeStory=e,e.indexToUnread(),e.isActiveLive()||e.fillTimeLine(),this.blockKey=this.getBlockKey(e.data),clearTimeout(this.timer),Object(c.addClass)(this.stories,"animated"),this.timer=setTimeout((function(){Object(c.removeClass)(t,"active"),Object(c.addClass)(e.getWrap(),"active"),r.scrollToStory(),r.timer=setTimeout((function(){r.activeStory&&e.id!==r.activeStory.id||!r.activeStory||(e.indexToUnread(),r._startActiveStory(),r._renderStories(),r.scrollToStory(e,!0))}),200)}),0)},e.prototype._startActiveStory=function(){var e=this.activeStory;e.markAsActive(),e.playStory(!0)},e.prototype._onStartStory=function(){var e=this.activeStory,t=this.list;if(e){var r=this.activeStory.getCurStoryData();if(r){var i=window.nav.objLoc;if(i.w="story"+e.getRawId(),t.match(/^-?(\d+)_(\d+)$/)||(i.w+="/"+t),t.match(/^narrative[s]?-?\d+(_\d+)?/)){var o=r.narrative,n=r.raw_id.split("_"),a=n[0],s=n[1];i.w="narrative"+a+"_"+o.id+"_"+s}window.nav.setLoc(window.nav.toStr(i))}else Object(We.logError)(new Error("Fail: _onStartStory"),{environment:"stories"})}},e.prototype.scrollToStory=function(e,t){var r=this,i=this._getScrollLeft(e);t?(Object(c.removeClass)(this.stories,"animated"),this._setScrollLeft(i)):this.inited&&Object(c.addClass)(this.stories,"animated"),setTimeout((function(){r._setScrollLeft(i)}))},e.prototype._setScrollLeft=function(e){Object(c.setStyle)(this.stories,"transform","translateX("+Math.round(e)+"px) translateZ(0)")},e.prototype._getScrollLeft=function(e){return e=e||this.activeStory,window.innerWidth/2-e.getOffsetLeft()},e.prototype._onStoriesEnd=function(e,t){for(var r=-1,i=e+1;i<this.storiesList.length;i++){if(this.storiesList[i]){r=i;break}}var o=this._getStoryInstanceByIndex(r);if(r>-1&&o)t&&this.sendNavigationStatEvents("go_to_next_story_auto_by_time"),this._onSelectStory(o);else{window.cur.storyLayer.activeStory.data.is_groups&&this._onGroupsStoriesBlockViewEnd(window.cur.storyLayer.activeStory),window.cur.storyLayer.activeStory.isActiveStoryOneTime()&&window.Stories.removeList(this.list),window.cur.storyLayer.activeStory.isAppsMetaStoryActive()&&this._onAppsStoriesBlockViewEnd(window.cur.storyLayer.activeStory);var n=window.cancelStack[window.cancelStack.length-1];n&&"stories_form_focus"===n.name&&Object(S.cancelStackPop)(),Object(S.cancelStackPop)({byTimer:t})}},e.prototype._playPrevOwner=function(e){for(var t=-1,r=e-1;r>=0;r--){if(this.storiesList[r]){t=r;break}}var i=this._getStoryInstanceByIndex(t);t>-1&&i?this._onSelectStory(i):Object(S.cancelStackPop)()},e.prototype._markReadStoriesInRange=function(e,t,r){for(var i=e.data.items,o=t;o<r;o++){var n=i[o];n.unread&&(n.unread=!1)}},e.prototype._markReadPrevStories=function(e){this._markReadStoriesInRange(e,0,e.index)},e.prototype._updateBadge=function(e){var t=Object(c.ge)("feed_story_"+this.getBlockKey(e.data)),r=Object(c.geByClass1)("_stories_feed_item_replies",t);if((Object(c.hasClass)(t,"story_feed_new_item")||""!==Object(c.val)(r))&&!e.data.is_groups&&!e.data.is_apps){var i=e.data.items||[],o=i[e.index]||{};(o.answers||{}).new_count=0,o.unread=!1;var n=!0,a=0;i.forEach((function(e){var t=e.answers||{};a+=t.new_count||0,e.unread&&(n=!1)})),a>0?Object(c.val)(r,a):(Object(c.val)(r,""),n&&(Object(c.removeClass)(t,"story_feed_new_item"),Object(c.removeClass)(t,"story_feed_new_item_promo")))}},e.prototype._onPlayStory=function(e){var t=this._getStoryInstanceByIndex(e);t&&(this.storiesReadHash=t.getReadHash(),t.data.is_groups||t.isAppsMetaStoryActive()||t.isActiveStoryOneTime()||(this._readStories(t),this._markReadPrevStories(t)),this._updateBadge(t));var r=this._getStoryInstanceByIndex(e+1);r&&r.preloadNextStory(r.getIndex())},e.prototype._getStoryInstanceByIndex=function(e){var t=this.storiesList[e];if(!t)return!1;var r=this.getBlockKey(t);return this.renderedStories[r].story},e.prototype._onStoryRemoved=function(e,t,r,i){for(var o=0;o<this.storiesList.length;o++)this.storiesList[o]&&this.storiesList[o].author.id===e&&(this.storiesList[o]=!1);!r&&this._onStoriesEnd(t),window.Stories.updateFeedStories(null,{cb:i})},e.prototype.onVisibilityChange=function(){"visible"===document.visibilityState?window.cur.storyLayer&&window.cur.storyLayer.playStory():window.cur.storyLayer&&window.cur.storyLayer.pauseStory()},e.prototype.onResize=function(){this.activeStory&&window.cur.storyLayer.scrollToStory(this.activeStory,!0)},e.prototype.pauseStory=function(e){this.activeStory&&this.activeStory.pauseStory(e)},e.prototype.playStory=function(e){void 0===e&&(e=!1),this.activeStory&&this.activeStory.autoResumeStory(e)},e.prototype._onLayerClick=function(e){var t=Object(c.hasClass)(e.target,"stories_layer_close");(Object(c.hasClass)(e.target,"stories_layer_cont")||t)&&(this.storiesBlocks.length-1!==this._getCurStoryPos()||t||(this._readStories(this.activeStory,!0),this._markReadRestStories(this.activeStory)),Object(S.cancelStackPop)({isCloseBtnClick:t}))},e.prototype._getCurrentStoriesBlockIdx=function(){var e=this.renderedStories[this.getBlockKey(this.activeStory.data)];return e&&e.index},e.prototype._checkKeyEvents=function(e){return!(Object(c.attr)(e.target,"contenteditable")||Object(l.inArray)(e.target.tagName,["INPUT","TEXTAREA"])||window.curBox())},e.prototype.onKeyDown=function(e){if(window.cur.storiesKeyDown)window.cur.storyLayer&&window.cur.storyLayer._checkKeyEvents(e)&&Object(j.cancelEvent)(e);else if(window.cur.storiesKeyDown=e.keyCode!==j.KEY.ESC,[j.KEY.PAGEDOWN,j.KEY.PAGEUP].includes(e.keyCode))Object(j.cancelEvent)(e);else if(window.cur.storyLayer&&window.cur.storyLayer.inited&&window.cur.storyLayer._checkKeyEvents(e)){switch(e.keyCode){case j.KEY.LEFT:this._readStoriesIfNeeded(this.activeStory),window.cur.storyLayer.prevStory();break;case j.KEY.RIGHT:this._readStoriesIfNeeded(this.activeStory),window.cur.storyLayer.nextStory();break;case j.KEY.SPACE:Object(j.cancelEvent)(e);var t=window.cur.storyLayer.activeStory;t.isSpaceLongTabAvailable()&&(window.cur.storiesKeyDownLong=setTimeout(t.longTapHandle.bind(t),A.LONG_PRESS_DELAY_MS))}window.cur.storiesKeyDownTs=Object(l.vkNow)()}},e.prototype.onKeyUp=function(e){window.cur.storiesKeyDown=!1,clearTimeout(window.cur.storiesKeyDownLong),window.cur.storyLayer&&window.cur.storyLayer.inited&&window.cur.storyLayer._checkKeyEvents(e)&&e.keyCode===j.KEY.SPACE&&(Object(j.cancelEvent)(e),Object(l.vkNow)()-window.cur.storiesKeyDownTs>A.LONG_PRESS_DELAY_MS?window.cur.storyLayer.playStory(!0):(this._readStoriesIfNeeded(this.activeStory),window.cur.storyLayer.nextStory()))},e.prototype.nextStory=function(){this.activeStory&&this.activeStory.nextStory()},e.prototype.prevStory=function(){this.activeStory&&this.activeStory.prevStory()},e.prototype.changeStory=function(e){this.activeStory&&this.activeStory.changeStory(e)},e.prototype._readStoriesIfNeeded=function(e,t){void 0===t&&(t=!1),e.isActiveStoryOneTime()&&this._readStories(e,t)},e.prototype._readStories=function(e,t){var r=this;if(void 0===t&&(t=!1),e){var i=e.getRawId();if(i&&(!this.storiesIdsSeen[i]||t)&&e.isLoaded()){var o,n,a=e.getAccessKey(),s=e.getTrackCode(),c=0;e.isActiveStoryOneTime()&&(c=Math.max(Math.round(e.getStoryProgressPercent()),1)),s||(s=""),window.ajax.post("al_stories.php",{act:"read_stories",story_id:i,track_code:s,all:Number(t),progress:c,source:this._getSource(),navigation_stats:(n=Ct.map(e=>[e.ownerId,e.storyId,e.source,e.action].join(",")).join(";"),Ct=[],n),loading_stats:(o=Tt.map(e=>[e.ownerId,e.storyId,e.source,e.time].join(",")).join(";"),Tt=[],o),connection_type:Ot(),hash:e.getReadHash(),access_key:a},{onDone:function(){}}),this.storiesIdsSeen[i]=!0,t&&e.getItems().forEach((function(e){return r.storiesIdsSeen[e.raw_id]=!0}))}}},e.prototype._getSource=function(){return[wt,kt,A.STORIES_MANAGE_MODULE,St.MODULE].includes(window.cur.module)?window.cur.module:this._source?this._source:"list"},e.prototype.sendNavigationStatEvents=function(e,t,r){var i;void 0===t&&(t=!0),void 0===r&&(r={});var o=this.activeStory,n=this.getStoryRaw()||(null===(i=o.getCurStoryData())||void 0===i?void 0:i.raw_id),a=this._getSource();t&&this._sendProductAnalyticEvents(e,r),this._updateLastStoryOpenAction(e),function(e){var t=e.storyRawId,r=e.source,i=e.action,o=jt(t.split("_"),2);"reply"===r&&(r="replies_list");var n={ownerId:o[0],storyId:o[1],source:r,action:i};Ct.push(n)}({storyRawId:n,source:a,action:e})},e.prototype._sendProductAnalyticEvents=function(e,t){var r;void 0===t&&(t={});var i=this.activeStory,o=this.getStoryRaw()||(null===(r=i.getCurStoryData())||void 0===r?void 0:r.raw_id);if(o){var n=o.split("_"),a=Number(n[0]),s=Number(n[1]),c=i.getIndex(),l=i.getItemsLength()-c,d=i.story,u=this._getSource(),p=i.isGroupedStory(),_=0;if(e&&i&&d&&a&&s){p&&(s=0,a=0,_=0),"groups"===this.list&&(_=1);var h={event_type:e,story_owner_id:a,story_id:s,time:window.vk.ts+Math.floor(((new Date).getTime()-window.vk.started)/1e3),volume:100*b(),view_entry_point:u,stories_author_before:c,stories_author_after:l,nav_screen:window.cur.module,view_event_timeline_position:d.getCurrentTime(),story_type:p?"group_feed":"",is_grouped:_,track_code:d.getTrackCode()};Object.assign(h,t),Object(ae.partConfigEnabled)("web_stats_transport_story_view")?Object(bt.saveStoryViewStats)(h):Object(it.statlogsValueEvent)("story_product_analytics",h)}}else Object(We.logError)(new Error("_sendProductAnalyticEvents: storyRawId is undefined"),{environment:"stories"})},e.prototype._updateLastStoryOpenAction=function(e){switch(e){case"go_to_next_story_tap":case"go_to_next_story_click":case"go_to_next_story_auto_by_time":this.viewerSource="next_story";break;case"go_to_previous_story":this.viewerSource="previous_story";break;case"go_to_next_author":this.viewerSource="next_author";break;case"go_to_previous_author":this.viewerSource="previous_author"}},e.prototype._initViewerSource=function(){var e=this._getSource();switch(e){case"reply":this.viewerSource="replies_list";break;case"feed":this.viewerSource=window.cur.section;break;default:this.viewerSource=e}},e.prototype.sendViewerStartTime=function(e,t){!function(e){var t=e.storyRawId,r=e.source,i=e.time,o=jt(t.split("_"),2),n={ownerId:o[0],storyId:o[1],source:r,time:i};Tt.push(n)}({storyRawId:e,source:this.viewerSource,time:t})},e.prototype._onVideoPlay=function(){var e=this.activeStory.getCurStoryData();e?e.noSound||(window.Notifier.lcSend("stories_video_start"),window.getAudioPlayer().isPlaying()&&(Object(V.getAudioPlayer)().pause(),this.needAudioReset=!0)):Object(We.logError)(new Error("Fail: _onVideoPlay"),{environment:"stories"})},e.prototype._onVideoEnd=function(){this._restoreAudioPlay()},e.prototype._restoreAudioPlay=function(){window.Notifier.lcSend("stories_video_end"),this.needAudioReset&&(window.getAudioPlayer().play(),delete this.needAudioReset)},e.prototype._renderBackButton=function(){return this.backButton=Object(c.se)('<div class="stories_back_button_wrap">\n  <div class="stories_back_button">\n    <div class="stories_back_button_icon"></div>\n    <div class="stories_back_button_text">'+Object(Se.getLang)("global_back")+"</div>\n  </div>\n</div>"),Object(j.addEvent)(this.backButton,"click",(function(){Object(S.cancelStackPop)()})),this.backButton},e.prototype.showBackButton=function(){Object(c.show)(this.backButton),this.hideAllLayers=!0,Object(c.addClass)(this.layerEl,"with_back_button")},e.parseExtra=function(e){for(var t={},r=0,i=String(e).split(";");r<i.length;r++){var o=i[r].split(":"),n=o[0],a=o[1];n&&a&&(t[n]=a)}return t},e.prototype.getAnimateFromElem=function(){if(!this.hideAllLayers){var e=this.getBlockKey(this.activeStory.data);if(Object(c.hasClass)(this.animateFromEl,"stories_feed_reply_item")){var t=Object(c.domQuery)("#feed_story_"+e,Object(c.domPN)(this.animateFromEl))[0];if(t)return t}else if("feed"===window.cur.module&&!Object(c.isVisible)(this.backButton)){var r=Object(c.ge)("feed_story_"+e);if(r)return window.Stories.feedScrollToOwner(e),r}}return this.animateFromEl},e.prototype.animateStory=function(e,t){var r=this;return new Promise((function(i){if("expand"===e&&!t||"minimize"===e&&!r.animateFromEl)return Object(c.setStyle)("stories_layers_background","opacity",1),i();r.pauseStory(),Object(c.addClass)(r.layerEl,"animation"),Object(c.removeClass)(r.stories,"animated");var o="expand"===e?t:r.getAnimateFromElem();if(r.hideAllLayers&&"minimize"===e){var n=E[0];o=n.getAnimateFromElem(),function(){for(var e=E.length-2;e>=0;e--)E[e].doHide(!0);E.splice(0,E.length-1)}(),N()}Object(c.removeClass)(o,"stories_feed_item_ava_animate");var a=Object(c.getXY)(o),s=a[0],l=a[1],d=Object(c.getSize)(o),u=window.innerHeight,p=Math.min(540,Math.max(320,.563*u)),_=1.78*p,h=Math.max(0,(u-_)/2),m=Math.max(0,(window.innerWidth-p)/2);s=m-s+p/2-d[0]/2+Number(Object(lt.scrollGetX)()),l=h-l+_/2-d[1]/2+Number(Object(lt.scrollGetY)()),s=-s,l=-l;var v={};"expand"===e&&(v.transform="translate("+s+"px, "+l+"px) scale(0)",r.animateFromEl=t),Object(c.setStyle)(r.activeStory.wrapEl,v),"minimize"===e&&Object(c.setStyle)(o,"transform","scale(0)"),r.animationTimer=setTimeout((function(){Object(c.addClass)(r.stories,"animated"),Object(c.addClass)(o,"stories_feed_item_ava_animate"),r.animationTimer=setTimeout((function(){"expand"===e?(Object(c.setStyle)("stories_layers_background","opacity",1),Object(c.setStyle)(r.activeStory.wrapEl,"transform","translate(0, 0) scale(1)")):(Object(c.setStyle)(r.activeStory.wrapEl,"transform","translate("+s+"px, "+l+"px) scale(0.01)"),Object(c.setStyle)(o,"transform","scale(1)")),r.animationTimer=setTimeout((function(){i(),"expand"===e?(Object(c.setStyle)(r.activeStory.wrapEl,"transform",""),Object(c.removeClass)(r.layerEl,"animation"),Object(c.removeClass)(r.stories,"animated"),r.playStory(),E.length>1&&(E[E.length-2].setLayerVisibility(!1),E[E.length-1].showBackButton())):(Object(c.removeClass)(o,"stories_feed_item_ava_animate"),Object(c.setStyle)(o,"transform",""))}),330)}),30)}),30)}))},e.prototype.pauseLayer=function(){this.pauseStory(),Object(c.addClass)(this.layerEl,"paused")},e.prototype.resumeLayer=function(){this._updateVolumeButton(),this.activeStory.volumeUpdate(),this.activeStory&&(window.cur.storyLayer.activeStory.data.is_groups&&window.cur.storyLayer.activeStory.isAppsMetaStoryActive()&&this.updateMetaStoryItems(),this.activeStory.isFeedbackTooltipShow&&this.activeStory.updateBottom(),this.playStory(),Object(c.removeClass)(this.layerEl,"paused"))},e.prototype.updateMetaStoryItems=function(){if(window.cur.storyLayer&&window.cur.storyLayer.activeStory&&window.cur.storyLayer.activeStory.story&&(window.cur.storyLayer.activeStory.data.is_groups||window.cur.storyLayer.activeStory.isAppsMetaStoryActive())){var e="groups";window.cur.storyLayer.activeStory.isAppsMetaStoryActive()&&(e="apps");var t=window.cur.storyLayer.activeStory.story.elems.recItems.querySelectorAll(".GridStoryPreview:not(.GridStoryPreview--live)"),r=window.Stories._getList(e);if(!r)return this.hideAllLayers=!0,void this.hide();var i=0;t.forEach((function(e){var t=e.querySelector(".GridStoryPreview__author"),o=e.querySelector(".GridStoryPreview__inner");if(t&&o){var n=Number(t.getAttribute("data-author-id")),a=r.find((function(e){return e.author.id===n&&"live"!==e.items[0].type}));if(!a)return++i,void e.remove();var s=a.items.findIndex((function(e){return e.unread}));-1===s&&(s=0,Object(c.removeClass)(t,"GridStoryPreview__author--unread"));var l=a.items[s],d=new Image;d.src=l.small_preview,d.onload=function(){Object(c.setStyle)(o,{backgroundImage:"url('"+l.small_preview+"')"})}}})),t.length-i<3&&(this.hideAllLayers=!0,this.hide())}},e.prototype.setLayerVisibility=function(e){Object(c.toggle)(this.layerEl,e)},e.prototype._renderVolumeControl=function(){return this.volumeControl=Object(c.se)('<div class="stories_volume_control">\n  <div class="stories_volume_control_slide_wrap">\n    <div class="stories_volume_control_slide">\n      <div class="stories_volume_control_slide_indicator"></div>\n    </div>\n  </div>\n</div>'),Object(j.addEvent)(Object(c.geByClass1)("stories_volume_control_slide_wrap",this.volumeControl),"mousedown",this._volumeControlOnMouseDown.bind(this)),Object(j.addEvent)(this.volumeControl,"mousedown",this._volumeControlOnClick.bind(this)),this.volumeControlContainer=Object(c.ce)("div",{className:"stories_volume_control_container"}),this.volumeControlContainer.appendChild(this.volumeControl),this.volumeControlContainer},e.prototype._volumeControlOnMouseDown=function(e){var t=this;Object(c.addClass)(this.volumeControlContainer,"changing");var r=Object(c.geByClass1)("stories_volume_control_slide",this.volumeControl),i=Object(c.geByClass1)("stories_volume_control_slide_indicator",r),o=Object(c.getXY)(r)[0],n=Object(c.getSize)(r)[0],a=function(e){var r=Math.max(0,Math.min(e.pageX-o,n))/n*100;Object(c.setStyle)(i,"width",r+"%"),w(r/100),t.activeStory.volumeUpdate()},s=function(){Object(j.removeEvent)(window,"mousemove",a),Object(j.removeEvent)(window,"mouseup",s),t._updateVolumeButton(),Object(c.removeClass)(t.volumeControlContainer,"changing")};Object(j.addEvent)(window,"mousemove",a),Object(j.addEvent)(window,"mouseup",s),a(e)},e.prototype._updateVolumeButton=function(){var e=100*b();Object(c.toggleClass)(this.volumeControl,"low",e>0&&e<50),Object(c.toggleClass)(this.volumeControl,"high",e>=50);var t=Object(c.geByClass1)("stories_volume_control_slide_indicator",this.volumeControl);Object(c.setStyle)(t,"width",e+"%")},e.prototype._volumeControlOnClick=function(e){if(!Object(c.hasClass)(e.target,"stories_volume_control_slide_wrap")&&!Object(c.hasClass)(this.volumeControlContainer,"changing")){var t=b();w(t=t?0:1),this._updateVolumeButton(),this.activeStory.volumeUpdate()}},e.prototype.onReplyDeleted=function(e){this.activeStory&&this.activeStory.onReplyDeleted(e)},e.prototype._hasContext=function(e){return this.extra&&this.extra.context&&this.extra.context===e},e}(),Nt=r("btP0"),Bt=r("59zB"),xt=r("RdBX"),Rt={},Pt={show:function(e,t){if(void 0===t&&(t={}),e.match(/story/)&&(e=this._parseList(e)),window.cur.storyLayer&&window.cur.storyLayer.list===e.split("/")[1])return!1;Pt.getList(e).then((function(e){var r=e.blockKey,i=e.list,o=e.items,n=e.extra,a=Object(ne.curBox)();a&&"stories"!==a.wkRaw&&a.hide(),I(new It(r,i,o,n,t),t),a&&(t.fromEl=null,"stories"===a.wkRaw&&(a._hide(!1,!0,!0),a.forceHide=!0,window.cur.storiesArchiveBoxGUID=a.guid))})).catch((function(e){Object(We.logError)(new Error(e)),Object(W.showFastBox)(Object(Se.getLang)("global_error"),Object(Se.getLang)("global_unknown_error"))}))},_getUnreadStory:function(e,t){e=Object(l.intval)(e);for(var r=!1,i=0;i<t.length;i++)if(t[i].author.id===e){for(var o=t[i].items,n=0;n<o.length;n++)if(o[n].unread){r=o[n];break}r||(r=o[0]);break}return r},getList:function(e){return new Promise((function(t,r){var i=e.split("/"),o=i[0],n=i[1],a=i[2],s={blockKey:o,list:n,extra:a,items:[]},c=Pt._getList(n);Array.isArray(c)?(s.items=c,t(s)):window.ajax.post("al_stories.php",{act:"get_list",list:n,story_raw:o,extra:a},{loader:!0,onDone:function(e){window.cur["stories_list_"+n]=e,s.items=e,t(s)},onFail:function(e){return r(e),!0}})}))},_getList:function(e){return window.cur["stories_list_"+e]},_setList:function(e,t){window.cur["stories_list_"+e]=t},removeList:function(e){delete window.cur["stories_list_"+e]},_parseList:function(e){var t=(e=decodeURIComponent(e)).match(/^story(-?\d+)_(\d+)(\/([a-z0-9\_\-]+))?(\/([a-z0-9\_\:\;\-]+))?$/i),r=t[1],i=t[2],o=t[4],n=t[6],a=r+"_"+i;return e.match(/from_feed\=1/)?o="feed":e.match(/profile\=1/)?o="profile":o||(o=a),a+"/"+o+"/"+n},initFeed:function(e){var t=this;void 0===e&&(e="stories_feed_items_container"),"string"==typeof e&&(e=Object(c.ge)(e));var r=Object(c.geByClass1)("stories_feed_items",e),i=Object(c.attr)(r,"id");Pt.updateFeedArrows(i);var o=function(){Object(j.addEvent)(e,"wheel",t.feedMouseWheel)},n=function(){Object(j.removeEvent)(e,"wheel",t.feedMouseWheel)};Object(j.addEvent)(e,"mouseenter",o),Object(j.addEvent)(e,"mouseleave",n),window.cur.destroy&&window.cur.destroy.push((function(){Object(j.removeEvent)(e,"wheel",this.feedMouseWheel),Object(j.removeEvent)(e,"mouseenter",o),Object(j.removeEvent)(e,"mouseleave",n)}))},feedNext:function(e){var t=Object(c.ge)("stories_feed_wrap");return e&&(t=Object(c.domClosest)("stories_feed_wrap",e.target)),this.feedPaging("next",null,t)},feedPrev:function(e){var t=Object(c.ge)("stories_feed_wrap");return e&&(t=Object(c.domClosest)("stories_feed_wrap",e.target)),this.feedPaging("prev",null,t)},feedPaging:function(e,t,r){r||(r=Object(c.ge)("stories_feed_wrap"));var i=Object(c.geByClass1)("stories_feed_items",r),o=Object(c.attr)(i,"id"),n=o+"_position",a=Rt[n]||0,s=Object(c.getSize)(r)[0];if(Object(l.isNumeric)(e))a+=Number(e);else{var d=s-100;"next"===e?a+=d:a-=d}Rt[n]=Math.max(0,Math.min(a,i.scrollWidth-s)),t?Object(c.removeClass)(i,"animated"):Object(c.addClass)(i,"animated"),Object(c.setStyle)(i,"transform","translateX(-"+Rt[n]+"px)"),Pt.updateFeedArrows(o)},feedScrollToOwner:function(e){var t=Object(c.ge)("feed_story_"+e);if(t){var r=Object(c.domClosest)("stories_feed_items",t),i=r.offsetWidth,o=Object(c.attr)(r,"id")+"_position",n=t.offsetWidth,a=t.offsetLeft,s=Object(c.domClosest)("stories_feed_wrap",r);Rt[o]=a-i+i/2+n/2,Pt.feedPaging(0,!0,s)}},updateFeedStories:function(e,t,r){var i=this;void 0===r&&(r="stories_feed_items");var o=Object(c.ge)(r),n=Object(c.domClosest)("stories_feed_wrap",o);if(e=e||"news",o)if(Object(l.inArray)(e,["news","search"])){var a=function(e,o){t&&t.cb&&t.cb(),Object.keys(o).forEach((function(e){return i._setList(e,o[e])})),window.cur.storyLayer&&window.cur.storyLayer.updateMetaStoryItems();var a=Object(c.ge)(r);a&&(e?(Object(c.setStyle)(a,"transform","translateX(0px)"),Object(c.val)(a,e),a.children.length<6?Object(c.addClass)(n,"stories_feed_not_nav_buttons"):Object(c.removeClass)(n,"stories_feed_not_nav_buttons"),Rt[r+"_position"]=0,Pt.updateFeedArrows(r),Object(c.show)(n)):Object(c.hide)(n))};if(t&&t.stories){var s=t.section,d=t.q,u=t.stories,p=u.html,_=u.js,h=_.feed?_.feed:[];return"search"!==s||d&&h.length?void a(p,_):void Object(c.hide)(n)}window.ajax.post("al_stories.php",{act:"feed_stories"},{onDone:a})}else Object(c.hide)(n)},feedMouseWheel:function(e){var t=Object(c.domClosest)("stories_feed_wrap",e.target);if(!Object(c.hasClass)(t,"stories_feed_not_nav_buttons")){Object(j.cancelEvent)(e);var r=Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX;Pt.feedPaging(r,!0,t)}},updateFeedArrows:function(e){void 0===e&&(e="stories_feed_items");var t=Object(c.ge)(e),r=e+"_position";if(t){Rt[r]||(Rt[r]=0);var i=Object(c.geByClass1)("stories_feed_wrap").offsetWidth,o=t.scrollWidth-i,n=Object(c.geByClass1)("stories_feed_arrow_left",Object(c.domPN)(t)),a=Object(c.geByClass1)("stories_feed_arrow_right",Object(c.domPN)(t));0===Rt[r]?Object(c.addClass)(n,"disabled"):Object(c.removeClass)(n,"disabled"),Rt[r]===o||o<=0?Object(c.addClass)(a,"disabled"):Object(c.removeClass)(a,"disabled")}},showBlackList:function(){window.cur.storyLayer&&window.cur.storyLayer.pauseStory(),Object(W.showBox)("al_stories.php",{act:"black_list"},{onDone:function(){window.cur.storiesBlackListScroll=new Bt.default("stories_black_list_result")},params:{onHide:function(){window.cur.storyLayer&&window.cur.storyLayer.playStory()}}})},blackListItemClick:function(e,t){Object(j.cancelEvent)(t);var r=Object(l.intval)(Object(c.attr)(e,"data-id"));window.cur.storiesBlackListShown[r]?(delete window.cur.storiesBlackListShown[r],Object(c.removeClass)(e,"olist_item_wrap_on")):(window.cur.storiesBlackListShown[r]=1,Object(c.addClass)(e,"olist_item_wrap_on"))},saveBlackList:function(e){var t=Object.keys(window.cur.storiesBlackListShown);0!==t.length?window.ajax.post("al_stories.php",{act:"save_blacklist",hash:window.cur.storiesBlackList.hash,list:t.join(",")},{onDone:function(){Pt.updateFeedStories(),Object(ne.curBox)().hide()},showProgress:function(){return Object(pt.lockButton)(e)},hideProgress:function(){return Object(pt.unlockButton)(e)}}):Object(ne.curBox)().hide()},blacklistUpdateUsers:function(e){var t=e;if(e=Object(l.trim)(e).toLowerCase(),window.cur.storiesBlacklistLastQ!==e){window.cur.storiesBlacklistLastQ=e;var r=e?window.cur.storiesIndexer.search(e):window.cur.storiesBlackList.users,i=[];if(e)for(var o=0;o<e.length;o++)i.push(e.substr(o,1));var n=new RegExp(i.join(".*?"),"i"),a="";for(o=0;o<r.length;o++){var s=r[o],d=e?s.name.replace(n,(function(e){return"<em>"+e+"</em>"})):s.name;a+=window.cur.storiesBlackList.tpl.replace(/\{id\}/g,s.id).replace("{photo}",s.photo).replace("{name}",d).replace("{href}",s.href).replace("{class_name}",window.cur.storiesBlackListShown[s.id]?" olist_item_wrap_on":"")}a||(a='<div class="no_rows">'+Object(Se.getLang)("global_search_not_found").replace("{search}",Object(l.clean)(t))+"</div>"),Object(c.val)(Object(c.geByClass1)("olist","stories_black_list_result"),a)}},blackListInit:function(e){window.cur.storiesBlackListShown={},window.cur.storiesBlackList=e,Object(ne.curBox)().setOptions({width:450,bodyStyle:"padding: 0px",onClean:function(){this.storyLayer&&this.storyLayer.playStory(),window.cur.storiesBlackListScroll&&window.cur.storiesBlackListScroll.destroy()}}).removeButtons(),window.cur.storiesBlackList.users.length?(window.cur.storiesBlacklistLastQ=!1,window.cur.storiesIndexer=new xt.vkIndexer(window.cur.storiesBlackList.users,(function(e){return e.name}),(function(){Pt.blacklistUpdateUsers("")})),Nt.default.init("stories_blacklist"),Nt.default.focus("stories_blacklist"),Object(ne.curBox)().addButton(Object(Se.getLang)("global_save"),this.saveBlackList).addButton(Object(Se.getLang)("global_cancel"),void 0,"no")):Object(ne.curBox)().addButton(Object(Se.getLang)("global_close"))},preloadUrl:function(e){f(e).catch((function(e){Object(We.logError)(e)}))},groupStoriesBlockUpdate:function(){var e=Pt._getList("group_stories"),t=e&&e[0]&&e[0].items;if(t){for(var r=0,i=0;i<t.length;i++){t[i].unread&&r++}var o=Object(c.geByClass1)("stories_groups_block_stories_wrap"),n=Object(c.geByClass1)("stories_groups_block_stories_button",o);Object(c.toggleClass)(o,"has_unread",r>0),Object(c.toggleClass)(o,"has_stories",t.length>0),Object(c.toggleClass)(n,"has_stories",t.length>0);var a=Object(l.clone)(window.cur.storiesPreviews),s=a.splice(a.length-r,3);s.length<3&&(s=s.concat(a.slice(0,3-s.length))),s.reverse();var d="";for(i=s.length-1;i>=0;i--)d+=window.cur.storiesPreviewsRowHtml.replace("{url}",s[i]);Object(c.val)(Object(c.geByClass1)("stories_groups_block_stories_rows",o),d)}},isLiveShown:function(e){return!!(window.cur.storyLayer&&window.cur.storyLayer.activeStory&&window.cur.storyLayer.activeStory.isActiveLive())&&window.cur.storyLayer.activeStory.story.videoRaw===e},activeLiveEnded:function(e){window.cur.storyLayer.activeStory.onLiveEnded(e)},updateLiveViewersCount:function(e){var t=e?Object(Se.getLang)("stories_live_N_watching",e,!0):"";window.cur.storyLayer.activeStory.updateLiveViewersCount(t)}}},KkKZ:function(e,t,r){"use strict";r.r(t),t.default={disabled:!1}},Kl2g:function(e,t,r){"use strict";r.r(t),r.d(t,"WallDataEvents",(function(){return a})),r.d(t,"registerUniqueListener",(function(){return l})),r.d(t,"emitEvent",(function(){return d}));var i=r("uQjJ"),o=r("qYuU"),n=function(){return(n=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},a={post_reactions_counts_update:"wall/post_reactions_counts_update",reply_reactions_counts_update:"wall/reply_reactions_counts_update"},s=Object(o.makeSharedState)("wall-data",(function(){return{emitter:new i.default,keyedListeners:Object.create(null)}})),c=function(e,t,r){var i,o,a=s(),c=null===(o=null===(i=a.keyedListeners)||void 0===i?void 0:i[e])||void 0===o?void 0:o[t];return c&&a.emitter.removeListener(e,c),function(e,t,r){var i,o=s();o.emitter.addListener(e,r),o.keyedListeners[e]=n(n({},o.keyedListeners[e]),((i={})[t]=r,i));return function(){var i,n;o.emitter.removeListener(e,r),(null===(i=o.keyedListeners[e])||void 0===i?void 0:i[t])===r&&(null===(n=o.keyedListeners[e])||void 0===n||delete n[t])}}(e,t,r)},l=function(e,t,r){return c(t,e,r)},d=function(e,t){s().emitter.emit(e,t)}},L7cl:function(e,t,r){"use strict";r.r(t);r("HEwt"),r("a1Th"),r("Btvt"),r("rGqo"),r("rE2o"),r("ioFf");var i=r("zxIV"),o=r("FWc3"),n=r("JlTo");function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}t.default={SCROLL_EDGE_BELOW_THRESHOLD:20,MAX_COMMENTS_NUM:150,MAX_LIKES_PER_BATCH:7,MAX_STICKERS_PER_BATCH:7,init(e,t){VideoChat.block&&VideoChat.destroy(),e&&(VideoChat.block=e,VideoChat.options=extend({},t),VideoChat.messagesWrap=domByClass(e,"mv_chat_messages_wrap"),VideoChat.stickersWrap=domByClass(e,"mv_chat_stickers_wrap"),VideoChat.scroll=new uiScroll(domFC(VideoChat.messagesWrap),{global:!0,hidden:t.scrollHidden,reversed:!0,preserveEdgeBelow:!0,preserveEdgeBelowThreshold:VideoChat.SCROLL_EDGE_BELOW_THRESHOLD,theme:"videoview",onupdate:VideoChat.onScrollUpdate}),this.scrollBottomBtnWrap=domByClass(e,"mv_chat_new_messages_btn_wrap"),VideoChat.replyForm=domByClass(e,"mv_chat_reply_form"),VideoChat.replyForm&&(VideoChat.replyInput=domByClass(e,"mv_chat_reply_input"),VideoChat.initReplyInput()),VideoChat.firstMsgIntro=domByClass(e,"mv_chat_first_message_intro"))},initReplyInput(){placeholderInit(VideoChat.replyInput,{editable:!0,global:!0}),stManager.add([jsc("web/emoji.js"),"notifier.css"],(function(){var e=Emoji.init(VideoChat.replyInput,{forceStickerPack:VideoChat.options.forceStickerPack,controlsCont:VideoChat.replyForm,noLineBreaks:1,noCtrlSend:1,ref:"video_chat",onSend:function(){VideoChat.sendMessage()},checkEditable:function(){VideoChat.checkFormHeight(),VideoChat.checkTextLen()},onStickerSend:function(e){VideoChat.sendSticker(e)}});Object(i.data)(VideoChat.replyForm,"optId",e)}))},checkFormHeight(){var e=VideoChat.replyForm,t=e.offsetHeight;if(e.lastHeight!==t){e.lastHeight=t;var r=!VideoChat.scroll.data.scrollBottom;setStyle(VideoChat.messagesWrap,{bottom:t+"px"}),r&&VideoChat.scroll.scrollBottom()}},checkTextLen(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:VideoChat.replyInput,t=trim(Emoji.editableVal(e));if(e.lastLen!==t.length)if((e.lastLen=t.length)>mvcur.maxChatReplyLength){var r=cur.storyLayer?"stories_live_chat_msg_too_long":"video_live_chat_msg_too_long";Object(o.showTooltip)(e,{black:1,text:getLang(r),shift:!!cur.storyLayer&&[-30,10]})}else window.tooltips&&tooltips.destroy(e)},mentionOver:e=>window.mentionOver(e,{shift:[-20,7,7]}),stickerClick:(e,t,r)=>(stManager.add([jsc("web/emoji.js"),"notifier.css"],(function(){Emoji.clickSticker(e,t,r)})),!1),onScrollUpdate(e){e.data.scrollBottom<VideoChat.SCROLL_EDGE_BELOW_THRESHOLD&&VideoChat.toggleScrollBottomBtn(!1)},receiveMessage(e,t,r,i,o,n,a,s,c){if(intval(c))VideoChat.appendSticker(c,r);else{var l=!1;window.replyAsList&&window.replyAsList.length&&each(window.replyAsList,(function(){if(this[0]==r)return l=!0,!1}));var d=Videoview.getMvData(),u=d.adminLevel,p=d.canDeleteComments,_="";(u>constants.Groups.GROUPS_ADMIN_LEVEL_USER||p||e==vk.id||r==vk.id||l)&&(_+=getTemplate("video_chat_message_action_del",{video_owner_id:e,msg_id:t}));var h=psr(getTemplate("video_chat_message",{author_href:n,author_photo:psr(o),author_name:i,message:s,video_owner_id:e,msg_id:t,actions:_,classes:r==e?"mv_chat_admin_message":""}));VideoChat.appendMessage(h,t)}},receiveDelete(e,t){var r="#mv_chat_msg"+mvcur.mvData.oid+"_"+t,i=VideoChat._messagesBatch&&VideoChat._messagesBatch.querySelector(r);i?re(i):(i=VideoChat.messagesWrap.querySelector(r))&&!hasClass(i,"_deleting")&&VideoChat.scroll.updateAbove((function(){re(i)}))},checkStickerFlood(e,t){var r=mvcur.queueBatchId;VideoChat._stickersLimits&&VideoChat._stickersLimits.batch==r||(VideoChat._stickersLimits={batch:r,like:0,sticker:0},VideoChat._stickersDelay=0);var i="like"==e?"like":"sticker",o="like"==i?VideoChat.MAX_LIKES_PER_BATCH:VideoChat.MAX_STICKERS_PER_BATCH;return!(++VideoChat._stickersLimits[i]>o&&t!=vk.id)},appendSticker(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!VideoChat.isHidden()&&!Videoview.isFS&&"hidden"!=document.visibilityState&&"animation"in bodyNode.style&&"onanimationend"in window){if(t==vk.id){var i=VideoChat.recentlySentSticker;if(i&&i.stickerId==e&&i.fromQueue!=r&&Date.now()-i.time<3e3)return;VideoChat.recentlySentSticker={stickerId:e,fromQueue:r,time:Date.now()}}else if(!VideoChat.checkStickerFlood(e,t))return;if("like"==e){var o=ce("div",{className:"mv_chat_like"});a(o),addEvent(o,"animationend",c),s(o)}else{var n=ce("img",{className:"mv_chat_sticker",src:Stickers.getStickerUrl(e,(isRetina()?128:64)+"b")});a(n),addEvent(n,"error animationend",c),addEvent(n,"load",s)}}function a(e){for(var r="",i=0,o=0,n=0,a=intval((VideoChat.getHeight()-80)/6),s=0;s<=100;s+=20){s>0&&(i+=irand(-4,4),o-=a,n+=irand(-4,4),a=intval(.9*a)),r+=`\n          ${s}% {\n            transform: translate(${i}px, ${o}px) rotate(${n}deg) scale(${s?1:.7});\n            opacity: ${0==s||100==s?0:1};\n          }\n        `}var c="mv_chat_sticker_animation_"+Date.now()+"_"+irand(0,1e9);r=`@keyframes ${c} {${r}}`,e.appendChild(ce("style",{innerHTML:r}));var l=irand(1500,2500)+"ms",d=(t==vk.id?0:VideoChat._stickersDelay+=100)+"ms";setStyle(e,{animation:[c,l,d,"linear"].join(" ")})}function s(e){var t=e.currentTarget||e;(VideoChat._stickersBatch||(VideoChat._stickersBatch=document.createDocumentFragment())).appendChild(t),VideoChat._appendStickerTimeout||(VideoChat._appendStickerTimeout=setTimeout((function(){VideoChat.appendStickersBatch(),VideoChat._appendStickerTimeout=null}),0))}function c(e){var t=e.currentTarget||e;removeEvent(t),re(t)}},appendStickersBatch(){var e=VideoChat._stickersBatch;e&&(VideoChat._stickersBatch=null,VideoChat.isHidden()||VideoChat.stickersWrap.appendChild(e))},removeStickers(){if(VideoChat.stickersWrap)for(var e;e=domFC(VideoChat.stickersWrap);)removeEvent(e),re(e)},appendMessage(e,t){var r=VideoChat._messagesBatch||(VideoChat._messagesBatch=document.createDocumentFragment()),i="#mv_chat_msg"+mvcur.mvData.oid+"_"+t;if(!VideoChat.messagesWrap.querySelector(i)&&!r.querySelector(i)){r.appendChild(se(e));for(var o=r.childNodes;r.childNodes.length>VideoChat.MAX_COMMENTS_NUM;)re(o[0]);VideoChat.isHidden()||VideoChat._appendMessageTimeout||(VideoChat._appendMessageTimeout=setTimeout((function(){VideoChat.appendMessagesBatch(),VideoChat._appendMessageTimeout=null}),0))}},appendMessagesBatch(){if(!VideoChat.isHidden()){var e=VideoChat._messagesBatch;if(e){VideoChat._messagesBatch=null;var t=geByClass("mv_chat_message_author_thumb_img",e,"img");each(t,(function(e,t){attr(t,"src")||attr(t,"src",domData(t,"src"))})),VideoChat.firstMsgIntro&&(re(VideoChat.firstMsgIntro),VideoChat.firstMsgIntro=null);var r=VideoChat.scroll.content;VideoChat.scroll.updateBelow((function(){r.appendChild(e)})),VideoChat.scroll.updateAbove((function(){for(var e=r.childNodes;e.length>VideoChat.MAX_COMMENTS_NUM;)re(e[0])})),VideoChat.scroll.data.scrollBottom>100&&VideoChat.toggleScrollBottomBtn(!0)}}},toggleScrollBottomBtn(e){toggleClass(this.scrollBottomBtnWrap,"hidden",!e)},scrollBottom(){VideoChat.scroll.scrollBottom(0)},replyAsAnimate(e,t,r){var i=e&&geByClass1("mv_chat_reply_author_photo",e),o=i&&geByClass("mv_chat_reply_author_photo_img",i),n=hasClass(e,"mv_chat_author_secondary")?0:1;o&&o[n]&&(o[n].src=r),toggleClass(e,"mv_chat_author_secondary")},replyAsGroup(e,t){window.replyAsList?VideoChat.replyAsGroupTT(e,t):ajax.post("/al_groups.php?act=get_editor_clubs",{},{cache:1,onDone:function(r){window.replyAsList=r,window.replyAsData={},each(r,(function(e,t){var r=a(t,4),i=r[0];r[1],r[2],r[3];window.replyAsData[i]=this})),VideoChat.replyAsGroupTT(e,t)}})},replyAsGroupList(e,t){var r=[t];return each(window.replyAsList,(function(t,i){var o=a(i,4),n=o[0];o[1],o[2],o[3];n!=e&&r.push(this)})),r},replyAsGroupOver(e){var t=gpeByClass("mv_chat_reply_form",e);Object(o.showTooltip)(e,{text:function(){return domData(t,"from-oid")<0?getLang("global_on_behalf_group"):getLang("global_on_behalf_me")},black:1,shift:[9,8,8]})},replyAsGroupTT(e,t){var r=VideoChat.replyAsProfileData(),o=gpeByClass("mv_chat_reply_form",e),n=o&&domData(o,"from-oid"),s=Object(i.data)(e,"tt");if(!r)return!1;if(!s){var c=VideoChat.replyAsGroupList(t,r),l="";each(c,(function(e,t){var r=a(t,4),i=r[0],o=r[1],s=r[2],c=r[3];l+=getTemplate("video_chat_message_author_select_row",{author_id:i,author_href:s,author_photo:o,author_name:c,classes:n==i?" active":""})})),s=new ElementTooltip(e,{content:'<div class="post_from_tt_choose _post_scroll_wrap">'+l+"</div>",appendToParent:!0,autoHide:!0,customShow:!0,defaultSide:"top",offset:function(){return[0,-5]},onFirstTimeShow:function(t){var r=geByClass("post_from_tt_row",t);each(r,(function(t,r){addEvent(r,"click",VideoChat.setReplyAsGroup.pbind(e,{from:domData(this,"from-oid")}))})),this.rows=r,this.scroll=new uiScroll(geByClass1("_post_scroll_wrap",t)),setTimeout((function(){s.scroll.update(),s.updatePosition()}),0)},onShow:function(e){setTimeout((function(){if(s.scroll){var t=geByClass1("active",e),r=t?t.offsetTop-(s.scroll.data.viewportHeight-getSize(t)[1])/2:0;s.scroll.scrollTop(r)}}),0)},onHide:function(e){}}),Object(i.data)(e,"tt",s)}t&&s.isShown()&&VideoChat.setReplyAsGroup(e,{from:n==vk.id?t:vk.id}),e.tt&&e.tt.hide&&e.tt.hide(),s.isShown()||s.show()},replyAsProfileData:()=>window.mvcur&&mvcur.wallTpl&&mvcur.wallTpl.profileData,setReplyAsGroup(e,t){if(!e)return!1;var r=domClosest("mv_chat_reply_form",e),o=Object(i.data)(e,"tt"),n=t.from||(t.fromGroup?cur.oid:vk.id),a=n==vk.id?VideoChat.replyAsProfileData():window.replyAsData&&window.replyAsData[n];return!(domData(r,"from-oid")==n||!a||a[0]!=n)&&(domData(r,"from-oid",n),VideoChat.replyAsAnimate(r,a[2],a[1]),o&&o.rows&&each(o.rows,(function(){toggleClass(this,"active",domData(this,"from-oid")==n)})),e.setAttribute("aria-label",getLang(n<0?"wall_reply_as_group":"wall_reply_as_user")),!1)},sendMessage(){if(!VideoChat.messageSending){var e={message:trim(Emoji.val(VideoChat.replyInput))};if(e.message){if(vkNow()-VideoChat.lastMsgSent<1e3)return window.tooltips&&tooltips.destroy(VideoChat.replyInput),void Object(o.showTooltip)(VideoChat.replyInput,{text:getLang("video_live_chat_too_fast"),black:1});var t=Videoview.getMvData(),r=geByClass1("mv_chat_reply_form",this.block);r&&domData(r,"from-oid")&&(e.from_oid=domData(r,"from-oid")),ajax.post("al_video.php?act=post_comment",Wall.fixPostParams(extend(e,{video:t.videoRaw,hash:t.hash,videoviewer_chat:1})),{onDone:function(e,t){VideoChat.messageSending=!1,e&&t&&VideoChat.appendMessage(e,t),Emoji.val(VideoChat.replyInput,""),VideoChat.checkFormHeight(),VideoChat.scroll.data.scrollBottom&&VideoChat.scrollBottom(),VideoChat.lastMsgSent=vkNow(),mvcur.player&&mvcur.player.vars.stats_tmr&&Object(n.tmrTrackCustomGoal)("comment_in_sport_broadcast")},onFail:function(e){if(VideoChat.messageSending=!1,VideoChat.replyInput)return window.tooltips&&tooltips.destroy(VideoChat.replyInput),Object(o.showTooltip)(VideoChat.replyInput,{text:e,showdt:200,forcetodown:0,slide:15,black:1}),elfocus(VideoChat.replyInput),!0}}),VideoChat.messageSending=!0}else elfocus(VideoChat.replyInput)}},sendSticker(e){var t=Videoview.getMvData();ajax.post("al_video.php?act=live_send_sticker",{sticker_id:e,owner_id:t.oid,video_id:t.vid,hash:t.hash},{onDone(){VideoChat.appendSticker(e,vk.id,!1)}})},deleteMessage(e,t){var r=ge("mv_chat_msg"+e);addClass(r,"_deleting"),ajax.post("al_video.php?act=delete_comment",{comment:e,hash:t,videoview_chat:1},{onDone(e){val(domByClass(r,"mv_chat_message_content"),e)}})},isHidden(){return!!this.hidden||Videoview.isMinimized()},setHidden(e){this.hidden=e},toggle(){var e=VideoChat.isHidden();this.setHidden(!e),VideoChat.toggleStateClasses(),e&&VideoChat.scroll&&(VideoChat.appendMessagesBatch(),VideoChat.updateScroll()),e||VideoChat.removeStickers()},toggleStateClasses(){var e=!!this.block,t=VideoChat.isHidden(),r=Videoview.isMinimized();toggleClass("mv_box","_has_chat",e&&!r),toggleClass("mv_box","_hide_chat",e&&!r&&t);var i="";e&&(VideoChat.appendMessagesBatch(),i=getLang(t?"video_aria_expand_chat":"video_aria_minimize_chat")),ge("mv_top_pl_toggle")&&attr("mv_top_pl_toggle","aria-label",i)},updateScroll(){VideoChat.scroll.update(),VideoChat.scroll.scrollBottom(),VideoChat.toggleScrollBottomBtn(!1)},onResize(){VideoChat.block&&(VideoChat._chatHeight=VideoChat.block.offsetHeight)},getHeight:()=>VideoChat.block?VideoChat._chatHeight||(VideoChat._chatHeight=VideoChat.block.offsetHeight):0,destroy(){if(VideoChat.block){if(VideoChat.scroll&&(VideoChat.scroll.destroy(),VideoChat.scroll=null),VideoChat.replyForm){var e=Object(i.data)(VideoChat.replyForm,"optId");void 0!==e&&Emoji.destroy(e),Object(i.removeData)(VideoChat.replyForm),Object(i.removeData)(VideoChat.replyInput),VideoChat.replyForm=VideoChat.replyInput=null}VideoChat.removeStickers(),Object(i.removeData)(VideoChat.block),re(VideoChat.block),VideoChat.block=null,VideoChat.messagesWrap=null,VideoChat.stickersWrap=null,VideoChat.options=null,clearTimeout(VideoChat._appendMessageTimeout),clearTimeout(VideoChat._appendStickerTimeout),VideoChat._appendMessageTimeout=null,VideoChat._appendStickerTimeout=null,VideoChat._messagesBatch=null,VideoChat.firstMsgIntro=null,VideoChat.messageSending=!1,VideoChat.toggleStateClasses()}}}},RdBX:function(e,t,r){"use strict";r.r(t),r.d(t,"vkIndexer",(function(){return i}));r("Vd3H"),r("OG14"),r("a1Th"),r("Btvt"),r("KKXr"),r("Oyvg");function i(e,t,r){this.list=e,this.iterCur=0,this.iterEnd=e?e.length:0,this.index={},this.callback=r||function(){},this.prepareFunc=t||function(e){return e},setTimeout(this.indexIteration.bind(this),10)}i.prototype.delimiter=i.delimiter=new RegExp("[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\#\\+\\?\\\\]+","g"),i.prototype.trimmer=new RegExp("^[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\+\\?\\\\]+|[\\s\\-,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\\\]+$","g"),i.prototype.toTranslit={1072:"a",1073:"b",1074:"v",1075:"g",1076:"d",1077:"e",1078:"zh",1079:"z",1080:"i",1081:"y",1082:"k",1083:"l",1084:"m",1085:"n",1086:"o",1087:"p",1088:"r",1089:"s",1090:"t",1091:"u",1092:"f",1093:"h",1094:"ts",1095:"ch",1096:"sh",1097:"sh",1099:"y",1101:"e",1102:"yu",1103:"ya",1105:"e",1098:"",1100:""},i.prototype.toLocalCase={f:"a",",":"b","<":"b",d:"v",u:"g",l:"d",t:"e",";":"zh",":":"zh",p:"z",b:"i",q:"y",r:"k",k:"l",v:"m",y:"n",j:"o",g:"p",h:"r",c:"s",n:"t",e:"u",a:"f","[":"h","{":"kh",w:"ts",x:"ch",i:"sh",o:"sh",s:"y","'":"e",'"':"e",".":"yu",">":"yu",z:"ya","`":"e","~":"e",m:"","]":"","}":""},i.prototype.toLocalTranslit={1072:"f",1074:"d",1075:"u",1076:"l",1077:"t",1079:"p",1080:"b",1081:"q",1082:"r",1083:"k",1084:"v",1085:"y",1086:"j",1087:"g",1088:"h",1089:"c",1090:"n",1091:"e",1092:"a",1094:"w",1095:"x",1096:"i",1097:"o",1099:"s",1103:"z",1098:"m"},i.prototype.indexIteration=function(){for(var e=Math.min(this.iterEnd,this.iterCur+200),t=this.iterCur;t<e;t++){var r=this.list[t];try{r._order=t}catch(e){}this.add(r)}this.iterCur=t,t>=this.iterEnd?this.callback(this):setTimeout(this.indexIteration.bind(this),10)},i.prototype.strToPrefixes=function(e){for(var t={},r=winToUtf(e).toLowerCase().split(this.delimiter),i=r.length;i--;){var o=r[i],n="";if(o){for(var a=0;a<6;a++){var s=o.charCodeAt(a);if(s){var c=this.toTranslit[s],l=o.substr(a,1);n+=null!=c?c:l}}t[n]=1}}return t},i.prototype.strToSearchPrefixes=function(e){for(var t=[],r=e.toLowerCase().split(this.delimiter),i=r.length;i--;){var o={},n=r[i],a="",s="",c="",l=n.length>1;if(n){for(var d=0;d<6;d++){var u=n.charCodeAt(d);if(u){var p=this.toTranslit[u],_=n.substr(d,1);if(a+=null!=p?p:_,l){var h=this.toLocalCase[_],m=this.toLocalTranslit[u];s+=null!=h?h:_,c+=null!=m?m:_}}}o[a]=1,l&&(o[s]=2,o[c]=3),t.push(o)}}return t},i.prototype.toIndexTree=function(e,t){for(var r=this.index,i=0;i<6;i++){var o=e.substr(i,1)||-1;r=r[o]?r[o]:r[o]=5==i?[]:{}}r.push(t)},i.prototype.remove=function(e){var t=this.prepareFunc(e),r=this.strToPrefixes(t);for(var i in r)if(r.hasOwnProperty(i)){for(var o=this.index,n=0;n<6;n++){var a=i.substr(n,1)||-1;if(!o[a])break;o=o[a]}if(o.length)for(var s in o)if(this.equals(o[s],e)){o.splice(s,1);break}}},i.prototype.equals=function(e,t){for(var r in e)if(e.hasOwnProperty(r))switch(typeof e[r]){case"object":if(!this.equals(e[r],t[r]))return!1;break;case"function":if(void 0===e[r]||e[r].toString()!=t[r].toString())return!1;break;default:if(e[r]!=t[r])return!1}for(var i in t)if(void 0===t[i])return!1;return!0},i.prototype.intersect=function(e,t){var r=[];if(isNumeric(e[0])||isNumeric(t[0]))return e.filter((function(e){return-1!==t.indexOf(e)}));for(;e.length>0&&t.length>0;)e[0]._order<t[0]._order?e.shift():(e[0]._order>t[0]._order||this.equals(e[0],t[0])&&r.push(e.shift()),t.shift());return r},i.prototype.add=function(e){var t=this.prepareFunc(e),r=this.strToPrefixes(t);for(var i in r)r.hasOwnProperty(i)&&this.toIndexTree(i,e)},i.prototype.search=function(e){var t=this.index,r=this.strToSearchPrefixes(e),i=[],o=!1;for(var n in r)if(r.hasOwnProperty(n)){if(o&&!i)break;var a=this.localSearch(r[n],0,t);a.sort((function(e,t){return e._order-t._order})),i=o?this.intersect(i,a):a,o=!0}for(var s=i[0],c=i.length+1,l=[],d=1;d<c;d++){var u=i[d];u!=s&&(l.push(s),s=u)}return l},i.prototype.localSearch=function(e,t,r){if(!r)return[];var i={};for(var o in e)if(e.hasOwnProperty(o)){var n=o.substr(t,1)||-1;i[n]||(i[n]={}),i[n][o]=1}if(6==t++||!r)return r;var a=[];for(var s in i)if(-1==s)for(var c in r)r.hasOwnProperty(c)&&a.push.apply(a,this.localSearch(i[s],t,r[c]));else{var l=this.localSearch(i[s],t,r[s]);a.push.apply(a,l)}return a}},UCWv:function(e,t,r){"use strict";r.r(t),r.d(t,"STORIES_MANAGE_MODULE",(function(){return i})),r.d(t,"LONG_PRESS_DELAY_MS",(function(){return o})),r.d(t,"StickerTypes",(function(){return n})),r.d(t,"EMOJI_REACTIONS_ARR",(function(){return a})),r.d(t,"QUESTION_SELECT_MODE",(function(){return s})),r.d(t,"MAX_FEEDBACK_STORIES_SLICE_COUNT",(function(){return c})),r.d(t,"INIT_MAX_FEEDBACK_STORIES_COUNT",(function(){return l})),r.d(t,"MAX_NARRATIVE_STORIES",(function(){return d})),r.d(t,"NARRATIVE_MAX_TITLE_LENGTH",(function(){return u})),r.d(t,"BOX_ITEM_DRAGGABLE_CLASS",(function(){return p}));var i="stories_manage",o=200,n={hashtag:1,mention:2,question:3,place:4,music:5,storyReply:6,owner:7,link:8,marketItem:9,post:10,poll:11,sticker:12,app:13,situationalTheme:14},a=[{code:"f09f9882",name:"face_with_tears_of_happiness"},{code:"f09f988d",name:"smiling_face_with_heart_eyes"},{code:"f09f918df09f8fbf",name:"thumbs_up"},{code:"f09f98ad",name:"loud_crying_face"},{code:"f09f98b1",name:"face_screaming_in_fear"},{code:"e298ba",name:"smiling_face"}],s={PUBLIC:0,AUTHOR_ONLY:1,ANONYMOUS:3},c=50,l=10,d=100,u=23,p="NarrativeBox__draggable"},dI71:function(e,t,r){"use strict";function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}r.r(t),r.d(t,"default",(function(){return i}))},dRu9:function(e,t,r){"use strict";r.r(t),r.d(t,"UNMOUNTED",(function(){return u})),r.d(t,"EXITED",(function(){return p})),r.d(t,"ENTERING",(function(){return _})),r.d(t,"ENTERED",(function(){return h})),r.d(t,"EXITING",(function(){return m}));var i=r("zLVn"),o=r("dI71"),n=(r("17x9"),r("q1tI")),a=r.n(n),s=r("i8i4"),c=r.n(s),l=r("KkKZ"),d=r("0PSK"),u="unmounted",p="exited",_="entering",h="entered",m="exiting",v=function(e){function t(t,r){var i;i=e.call(this,t,r)||this;var o,n=r&&!r.isMounting?t.enter:t.appear;return i.appearStatus=null,t.in?n?(o=p,i.appearStatus=_):o=h:o=t.unmountOnExit||t.mountOnEnter?u:p,i.state={status:o},i.nextCallback=null,i}Object(o.default)(t,e),t.getDerivedStateFromProps=function(e,t){return e.in&&t.status===u?{status:p}:null};var r=t.prototype;return r.componentDidMount=function(){this.updateStatus(!0,this.appearStatus)},r.componentDidUpdate=function(e){var t=null;if(e!==this.props){var r=this.state.status;this.props.in?r!==_&&r!==h&&(t=_):r!==_&&r!==h||(t=m)}this.updateStatus(!1,t)},r.componentWillUnmount=function(){this.cancelNextCallback()},r.getTimeouts=function(){var e,t,r,i=this.props.timeout;return e=t=r=i,null!=i&&"number"!=typeof i&&(e=i.exit,t=i.enter,r=void 0!==i.appear?i.appear:t),{exit:e,enter:t,appear:r}},r.updateStatus=function(e,t){if(void 0===e&&(e=!1),null!==t){this.cancelNextCallback();var r=c.a.findDOMNode(this);t===_?this.performEnter(r,e):this.performExit(r)}else this.props.unmountOnExit&&this.state.status===p&&this.setState({status:u})},r.performEnter=function(e,t){var r=this,i=this.props.enter,o=this.context?this.context.isMounting:t,n=this.getTimeouts(),a=o?n.appear:n.enter;!t&&!i||l.default.disabled?this.safeSetState({status:h},(function(){r.props.onEntered(e)})):(this.props.onEnter(e,o),this.safeSetState({status:_},(function(){r.props.onEntering(e,o),r.onTransitionEnd(e,a,(function(){r.safeSetState({status:h},(function(){r.props.onEntered(e,o)}))}))})))},r.performExit=function(e){var t=this,r=this.props.exit,i=this.getTimeouts();r&&!l.default.disabled?(this.props.onExit(e),this.safeSetState({status:m},(function(){t.props.onExiting(e),t.onTransitionEnd(e,i.exit,(function(){t.safeSetState({status:p},(function(){t.props.onExited(e)}))}))}))):this.safeSetState({status:p},(function(){t.props.onExited(e)}))},r.cancelNextCallback=function(){null!==this.nextCallback&&(this.nextCallback.cancel(),this.nextCallback=null)},r.safeSetState=function(e,t){t=this.setNextCallback(t),this.setState(e,t)},r.setNextCallback=function(e){var t=this,r=!0;return this.nextCallback=function(i){r&&(r=!1,t.nextCallback=null,e(i))},this.nextCallback.cancel=function(){r=!1},this.nextCallback},r.onTransitionEnd=function(e,t,r){this.setNextCallback(r);var i=null==t&&!this.props.addEndListener;e&&!i?(this.props.addEndListener&&this.props.addEndListener(e,this.nextCallback),null!=t&&setTimeout(this.nextCallback,t)):setTimeout(this.nextCallback,0)},r.render=function(){var e=this.state.status;if(e===u)return null;var t=this.props,r=t.children,o=Object(i.default)(t,["children"]);if(delete o.in,delete o.mountOnEnter,delete o.unmountOnExit,delete o.appear,delete o.enter,delete o.exit,delete o.timeout,delete o.addEndListener,delete o.onEnter,delete o.onEntering,delete o.onEntered,delete o.onExit,delete o.onExiting,delete o.onExited,"function"==typeof r)return a.a.createElement(d.default.Provider,{value:null},r(e,o));var n=a.a.Children.only(r);return a.a.createElement(d.default.Provider,{value:null},a.a.cloneElement(n,o))},t}(a.a.Component);function f(){}v.contextType=d.default,v.propTypes={},v.defaultProps={in:!1,mountOnEnter:!1,unmountOnExit:!1,appear:!1,enter:!0,exit:!0,onEnter:f,onEntering:f,onEntered:f,onExit:f,onExiting:f,onExited:f},v.UNMOUNTED=0,v.EXITED=1,v.ENTERING=2,v.ENTERED=3,v.EXITING=4,t.default=v},hC3G:function(e,t,r){"use strict";r.r(t),r.d(t,"PINNED_CONVERSATION_BIT_MASK",(function(){return i})),r.d(t,"MASS_MENTION_ALIASES",(function(){return o})),r.d(t,"MASS_MENTION_REGEXP",(function(){return n}));r("Oyvg");var i=112,o={all:["all","everyone","все"],online:["online","here","здесь","тут"]},n=new RegExp(['(?!,|;|:|\\.|\\s|<br ?/?>|"|\\(|\\)|\\[|\\]|!|\\?)',"(",[].concat(o.all).concat(o.online).map(e=>`@${e}|\\*${e}`).join("|"),")",'(?=$|,|;|:|\\.(?![a-z0-9_-])|\\s|<br ?/?>|"|\\(|\\)|\\[|\\]|!|\\?)'].join(""),"gi")},ha24:function(e,t,r){"use strict";function i(e){var t=e.match(/^([a-z_]+)([0-9\-_]+)$/);return t?{objectType:t[1],objectId:t[2]}:null}r.r(t),r.d(t,"parseLikeObjectId",(function(){return i})),r.d(t,"likePostObjectId",(function(){return o})),r.d(t,"likeReplyObjectId",(function(){return n})),r.d(t,"getElementLikeButtonCount",(function(){return a}));var o=function(e){return"wall"+e},n=function(e){return"wall_reply"+e},a=function(e){var t;return null!==(t=e.querySelector(".like_button_count"))&&void 0!==t?t:void 0}},jmhT:function(e,t,r){"use strict";r.r(t),r.d(t,"BoxModal",(function(){return l}));var i,o=r("q1tI"),n=r.n(o),a=r("ZxpX"),s=r("GSQL"),c=(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.render=function(){var e=this.props,t=e.className,r=e.appearance,i=e.title,o=e.actionButtons,c=e.onClose,l=e.children,d=e.hint,u=e.hasScroll;return n.a.createElement("div",{className:"BoxModal"},n.a.createElement("div",{className:Object(a.classNames)("Modal","Modal--"+r,t)},n.a.createElement(s.default.Header,{title:i,onClose:c,appearance:r}),Boolean(l)&&n.a.createElement(s.default.Body,{hasScroll:u},l),n.a.createElement(s.default.Footer,{actionButtons:o,hint:d})))},t.defaultProps={appearance:"white",hasScroll:!0},t}(n.a.Component)},lBJi:function(e,t,r){"use strict";r.r(t),r.d(t,"Emoji",(function(){return hr}));r("a1Th"),r("rE2o"),r("ioFf"),r("Vd3H"),r("91GP"),r("KKXr"),r("rGqo"),r("Btvt"),r("HEwt"),r("Oyvg"),r("SRfc"),r("pIFo");var i=r("S6+Z"),o=r("TxR4"),n=r("yqpO"),a={1:["😀","😃","😄","😁","😅","😆","😂","🤣","😉","😊","☺","🙂","🙃","😇","😗","😙","😚","😘","😍","🥰","🤩","🤗","😋","😜","🤪","😛","😝","🤑","🤭","🤐","🤫","😶","🤔","🤨","🧐","😐","😑","🙄","😬","🤥","😏","😌","🤤","😴","🤓","😎","🥳","🤠","😒","😔","😪","😕","😟","🙁","☹","😮","😯","😲","😳","🥺","😦","😧","😨","😰","😥","😢","😭","😱","😖","😣","😞","😓","😩","😫","😷","🤒","🤕","🤢","🤮","🤧","🥶","🥵","🥴","😵","🤯","😤","😠","😡","🤬","😈","👿","💀","☠","💩","🤡","👹","👺","👻","👽","👾","🤖","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🙈","🙉","🙊","🦠"],2:["🐵","🐒","🦍","🐶","🐕","🐩","🐺","🦊","🦝","🐱","🐈","🦁","🐯","🐅","🐆","🐴","🐎","🦄","🦓","🦌","🐮","🐂","🐃","🐄","🐷","🐽","🐖","🐗","🐏","🐑","🐐","🐪","🐫","🦙","🦒","🐘","🦏","🦛","🐭","🐁","🐀","🐹","🐰","🐇","🐿","🦔","🦇","🐻","🐨","🐼","🦘","🦡","🐾","🦃","🐔","🐓","🐣","🐤","🐥","🐦","🐧","🕊","🦅","🦆","🦢","🦉","🦚","🦜","🐸","🐊","🐢","🦎","🐍","🐲","🐉","🦕","🦖","🐳","🐋","🐬","🐟","🐠","🐡","🦈","🐙","🦀","🦞","🦐","🦑","🐚","🐌","🦋","🐛","🐜","🐝","🐞","🦗","🕷","🕸","🦂","🦟","💐","🌸","💮","🏵","🌹","🥀","🌺","🌻","🌼","🌷","🌳","🌲","🎄","🌴","🌵","🌾","🌱","🌿","☘","🍀","🍁","🍂","🍃","🌑","🌒","🌓","🌔","🌕","🌖","🌗","🌘","🌙","🌚","🌛","🌜","🌡","☀","🌝","🌞","⭐","🌟","🌠","☁","⛅","⛈","🌤","🌥","🌦","🌧","🌨","🌩","🌪","🌫","🌬","💨","🌀","🌈","🌂","☂","☔","⛱","⚡","❄","☃","⛄","☄","🔥","💦","💧","🌊"],3:["👍🏻","👎🏻","👌🏻","✌🏻","🤞🏻","🤟🏻","🤘🏻","🤙🏻","🖕🏻","✊🏻","👊🏻","🤛🏻","🤜🏻","👈🏻","👉🏻","👆🏻","👇🏻","☝🏻","👋🏻","🤚🏻","🖐🏻","✋🏻","🖖🏻","👏🏻","🙌🏻","👐🏻","🤲🏻","🤝🏻","🙏🏻","💪🏻","🦵🏻","🦶🏻","👂🏻","👃🏻","🧠","🦷","🦴","👀","👁","👅","👄","✍🏻","💅🏻","🤳","👫","👭","👬","👩‍❤️‍💋‍👨","👨‍❤️‍💋‍👨","👩‍❤️‍💋‍👩","👩‍❤️‍👨","👨‍❤️‍👨","👩‍❤️‍👩","👪","👶","🧒","👦","👧","🧑","👱","👨","🧔","👱‍♂️","👨‍🦰","👨‍🦱","👨‍🦳","👨‍🦲","👩","👱‍♀️","👩‍🦰","👩‍🦱","👩‍🦳","👩‍🦲","🧓️","👴️","👵️","🙍‍♂️️","🙍‍♀️️","🙎‍♂️","🙎‍♀️️","🙅‍♂️","🙅‍♀️","🙆‍♂️","🙆‍♀️","💁‍♂️","💁‍♀️️","🙋‍♂️","🙋‍♀️️","🙇‍♂️","🙇‍♀️️","🤦‍♂️","🤦‍♀️","🤷‍♂️","🤷‍♀️","💆‍♂️️","💆‍♀️","💇‍♂️️","💇‍♀️","🚶‍♂️️","🚶‍♀️️","🏃‍♂️️","🏃‍♀️","💃","🕺","🕴️","👯‍♂️️","👯‍♀️","🧖‍♂️","🧖‍♀️️","👼","🎅","🤶","🦸‍♂️","🦸‍♀️","🦹‍♂️","🦹‍♀️","🧙‍♂️","🧙‍♀️","🧚‍♂️","🧚‍♀️","🧛‍♂️","🧛‍♀️","🧜‍♂️","🧜‍♀️","🧝‍♂️","🧝‍♀️","🧞‍♂️","🧞‍♀️","🧟‍♂️","🧟‍♀️","👨‍⚕️","👩‍⚕️","👨‍🎓","👩‍🎓","👨‍🏫","👩‍🏫","👨‍⚖️","👩‍⚖️","👨‍🌾","👩‍🌾","👨‍🍳","👩‍🍳","👨‍🔧","👩‍🔧","👨‍🏭","👩‍🏭","👨‍💼","👩‍💼","👨‍🔬","👩‍🔬","👨‍💻","👩‍💻","👨‍🎤","👩‍🎤","👨‍🎨","👩‍🎨","👨‍✈️","👩‍✈️","👨‍🚀","👩‍🚀","👨‍🚒","👩‍🚒","👮‍♂️","👮‍♀️","🕵️‍♂️","🕵️‍♀️","💂‍♂️","💂‍♀️","👷‍♂️","👷‍♀️","🤴","👸","👳‍♂️","👳‍♀️","👲","🧕","🤵","👰","🤰","🤱","🛀","🛌"],4:["🍏","🍎","🍐","🍅","🥝","🍑","🍒","🍓","🍇","🍈","🍉","🍊","🍋","🍌","🍍","🥭","🥥","🥑","🍆","🥔","🥕","🌽","🌶","🥒","🥬","🥦","🍄","🥜","🌰","🍞","🥐","🥖","🥨","🥯","🥞","🧀","🍖","🍗","🥩","🥓","🍔","🍟","🍕","🌭","🥪","🌮","🌯","🥙","🥚","🍳","🥘","🍲","🥣","🥗","🍿","🧂","🥫","🍱","🍘","🍙","🍚","🍛","🍜","🍝","🍠","🍢","🍣","🍤","🍥","🥮","🍡","🥟","🥠","🥡","🍦","🍧","🍨","🍩","🍪","🎂","🍰","🧁","🥧","🍫","🍬","🍭","🍮","🍯","🍼","🥛","☕","🍵","🍶","🍾","🍷","🍸","🍹","🍺","🍻","🥂","🥃","🥤","🥢","🍽","🍴","🥄"],5:["⚽","⚾","🥎","🏀","🏐","🏈","🏉","🎾","🥏","🎳","🏏","🏑","🏒","🥍","🏓","🏸","🥊","🥋","🥅","⛳","⛸","🎣","🎽","🛹","🎿","🛷","🥌","🎯","🎱","🎮","🕹","🎰","🎲","🧩","♟","🧗‍♂️️","🧗‍♀️","🤺","🏇","⛷","🏂","🏌️‍♂️","🏌️‍♀️","🏄‍♂️","🏄‍♀️","🚣‍♂️","🚣‍♀️","🏊‍♂️","🏊‍♀️","⛹️‍♂️","⛹️‍♀️","🏋️‍♂️","🏋️‍♀️","🚴‍♂️","🚴‍♀️","🚵‍♂️","🚵‍♀️","🤸","🤼‍♂️","🤼‍♀️","🤽‍♂️","🤽‍♀️","🤾‍♂️","🤾‍♀️","🤹‍♂️","🤹‍♀️","🧘‍♂️","🧘‍♀️","🎖","🏆","🏅","🥇","🥈","🥉"],6:["🚂","🚃","🚄","🚅","🚆","🚇","🚈","🚉","🚊","🚝","🚞","🚋","🚌","🚍","🚎","🚐","🚑","🚒","🚓","🚔","🚕","🚖","🚗","🚘","🚙","🚚","🚛","🚜","🏎","🏍","🛵","🚲","🛴","🚏","🛣","🛤","🛢","⛽","🚨","🚥","🚦","🛑","🚧","⚓","⛵","🛶","🚤","🛳","⛴","🛥","🚢","✈","🛩","🛫","🛬","💺","🚁","🚟","🚠","🚡","🛰","🚀","🛸","🌍","🌎","🌏","🌐","🗺","🗾","🧭","🏔","⛰","🌋","🗻","🏕","🏖","🏜","🏝","🏞","🏟","🏛","🏗","🧱","🏘","🏚","🏠","🏡","🏢","🏣","🏤","🏥","🏦","🏨","🏩","🏪","🏫","🏬","🏭","🏯","🏰","💒","🗼","🗽","⛪","🕌","🕍","⛩","🕋","⛲","⛺","🌁","🌃","🏙","🌄","🌅","🌆","🌇","🌉","♨","🌌","🎠","🎡","🎢","💈","🎪"],7:["🎙","🎚","🎛","🎤","🎧","📻","🎷","🎸","🎹","🎺","🎻","🥁","📯","🎭","🖼","🎨","🧵","🧶","🔮","🧿","🧸","🃏","🀄","🎴","🎃","🎆","🎇","🧨","✨","🎈","🎉","🎊","🎋","🎍","🎎","🎏","🎐","🎑","🧧","🎀","🎁","🎗","🎟","🎫","🛎","🧳","⌛","⏳","⌚","⏰","⏱","⏲","🕰","👓","🕶","🥽","🥼","👔","👕","👖","🧣","🧤","🧥","🧦","👗","👘","👙","👚","👛","👜","👝","🛍","🎒","👞","👟","🥾","🥿","👠","👡","👢","👑","👒","🎩","🎓","🧢","⛑","📿","💄","💍","💎","📱","📲","☎","📞","📟","📠","🔋","🔌","💻","🖥","🖨","⌨","🖱","🖲","💽","💾","💿","📀","🧮","🎥","🎞","📽","🎬","📺","📷","📸","📹","📼","🔍","🔎","🕯","💡","🔦","🏮","📔","📕","📖","📗","📘","📙","📚","📓","📒","📃","📜","📄","📰","🗞","📑","🔖","🏷","💰","💴","💵","💶","💷","💸","💳","🧾","💹","💱","💲","✉","💌","📧","📨","📩","📤","📥","📦","📫","📪","📬","📭","📮","🗳","✏","✒","🖋","🖊","🖌","🖍","📝","💼","📁","📂","🗂","📅","📆","🗒","🗓","📇","📈","📉","📊","📋","📌","📍","📎","🖇","📏","📐","✂","🗃","🗄","🗑","🔒","🔓","🔏","🔐","🔑","🗝","🔨","⛏","⚒","🛠","🗡","⚔","🔪","🔫","🏹","🛡","🔧","🔩","⚙","🗜","⚖","🔗","⛓","🧰","🧲","⚗","🧪","🧫","🧬","🔬","🔭","📡","💉","💊","🚪","🛏","🛋","🚽","🚿","🛁","🧴","🧷","🧹","🧺","🧻","🧼","🧽","🧯","🛒","🚬","⚰","⚱","🏺","🗿"],8:["💋","❤","💔","❣","💘","💝","💖","💗","💓","💞","💕","💟","💜","🧡","💛","💚","💙","🖤","💯","💢","💥","💫","🕳","💣","💬","👁️‍🗨️","🗨","🗯","💭","💤","🗣","👤","👥","👣","🔇","🔊","📢","📣","🔔","🔕","🎼","🎵","🎶","⚠","🚸","☢","☣","🆚","🆓","🆕","🚮","🚾","🚭","✅","♻","⚕","🔱","‼","⁉","❓","❗","🆘","⛔","🚫","🚳","🚯","🚱","🚷","📵","🔞"],9:["🇷🇺","🇰🇿","🇧🇾","🇺🇦","🇲🇳","🇬🇪","🇦🇿","🇹🇯","🇧🇷","🇱🇹","🇱🇻","🇪🇪","🇦🇲","🏁","🚩","🎌","🏴","🏳","🏳️‍🌈","🏴‍☠️","🇦🇨","🇦🇩","🇦🇪","🇦🇫","🇦🇬","🇦🇮","🇦🇱","🇦🇴","🇦🇶","🇦🇷","🇦🇸","🇦🇹","🇦🇺","🇦🇼","🇦🇽","🇧🇦","🇧🇧","🇧🇩","🇧🇪","🇧🇫","🇧🇬","🇧🇭","🇧🇮","🇧🇯","🇧🇱","🇧🇲","🇧🇳","🇧🇴","🇧🇶","🇧🇸","🇧🇹","🇧🇻","🇧🇼","🇧🇿","🇨🇦","🇨🇨","🇨🇩","🇨🇫","🇨🇬","🇨🇭","🇨🇮","🇨🇰","🇨🇱","🇨🇲","🇨🇳","🇨🇴","🇨🇵","🇨🇷","🇨🇺","🇨🇻","🇨🇼","🇨🇽","🇨🇾","🇨🇿","🇩🇪","🇩🇬","🇩🇯","🇩🇰","🇩🇲","🇩🇴","🇩🇿","🇪🇨","🇪🇬","🇪🇭","🇪🇷","🇪🇸","🇪🇹","🇪🇺","🇫🇮","🇫🇯","🇫🇰","🇫🇲","🇫🇴","🇫🇷","🇬🇦","🇬🇧","🇬🇩","🇬🇫","🇬🇬","🇬🇭","🇬🇮","🇬🇱","🇬🇲","🇬🇳","🇬🇵","🇬🇶","🇬🇷","🇬🇸","🇬🇹","🇬🇺","🇬🇼","🇬🇾","🇭🇰","🇭🇲","🇭🇳","🇭🇷","🇭🇹","🇭🇺","🇮🇨","🇮🇩","🇮🇪","🇮🇱","🇮🇲","🇮🇳","🇮🇴","🇮🇶","🇮🇷","🇮🇸","🇮🇹","🇯🇪","🇯🇲","🇯🇴","🇯🇵","🇰🇪","🇰🇬","🇰🇭","🇰🇮","🇰🇲","🇰🇳","🇰🇵","🇰🇷","🇰🇼","🇰🇾","🇱🇦","🇱🇧","🇱🇨","🇱🇮","🇱🇰","🇱🇷","🇱🇸","🇱🇺","🇱🇾","🇲🇦","🇲🇨","🇲🇩","🇲🇪","🇲🇫","🇲🇬","🇲🇭","🇲🇰","🇲🇱","🇲🇲","🇲🇴","🇲🇵","🇲🇶","🇲🇷","🇲🇸","🇲🇹","🇲🇺","🇲🇻","🇲🇼","🇲🇽","🇲🇾","🇲🇿","🇳🇦","🇳🇨","🇳🇪","🇳🇫","🇳🇬","🇳🇮","🇳🇱","🇳🇴","🇳🇵","🇳🇷","🇳🇺","🇳🇿","🇴🇲","🇵🇦","🇵🇪","🇵🇫","🇵🇬","🇵🇭","🇵🇰","🇵🇱","🇵🇲","🇵🇳","🇵🇷","🇵🇸","🇵🇹","🇵🇼","🇵🇾","🇶🇦","🇷🇪","🇷🇴","🇷🇸","🇷🇼","🇸🇦","🇸🇧","🇸🇨","🇸🇩","🇸🇪","🇸🇬","🇸🇭","🇸🇮","🇸🇯","🇸🇰","🇸🇱","🇸🇲","🇸🇳","🇸🇴","🇸🇷","🇸🇸","🇸🇹","🇸🇻","🇸🇽","🇸🇾","🇸🇿","🇹🇦","🇹🇨","🇹🇩","🇹🇫","🇹🇬","🇹🇭","🇹🇰","🇹🇱","🇹🇲","🇹🇳","🇹🇴","🇹🇷","🇹🇹","🇹🇻","🇹🇼","🇹🇿","🇺🇬","🇺🇲","🇺🇳","🇺🇸","🇺🇾","🇺🇿","🇻🇦","🇻🇨","🇻🇪","🇻🇬","🇻🇮","🇻🇳","🇻🇺","🇼🇫","🇼🇸","🇽🇰","🇾🇪","🇾🇹","🇿🇦","🇿🇲","🇿🇼"]},s=Object.keys(a).reduce((e,t)=>(e[t]=a[t].map(e=>Object(o.emojiSymbolToByteHex)(e)),e),{});r("hhXQ");function c(e,t){var r=e;return e>68&&(r=68),t>68&&(r=68*e/t),[r,r*(t/e)]}var l=r("W9Tc"),d=r("t7n3"),u=r("zxIV");r("/8Fb");function p(){return(p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}function _(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return h(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var m=["мне","тебе","ему","ей","маме","папе","сестре","брату","родителям"],v=["ден(?:ьги|ежки|ьгу|ежку|ег|ежек|як)","дол(?:г|жок)","(?:(?:в|на)\\s)подар(?:ок|ки)"],f=["переводом","(?:(?:по|на)\\s)(?:номеру?\\s)?(?:карт(?:у|очку|ы|очки)|тел(?:ефона)?)","(?:по\\s)?безнал(?:у|ичке|ом|ичкой)","на\\sсбер(?:банк)?"],g=["сот(?:оч)ку","\\d+(?:\\s*р(?:[.,\\s]|уб(?:лей)?|$))?"],y=new RegExp(`(${g.join(")|(")})`);function b(e,t){return"amount"===e?function(e){var t=e.match(y);if(t){if(t[1])return 100;if(t[2])return parseInt(t[2])}return 0}(t):t}var w=new RegExp(`^(?:(${["(?:за|с|пере)?кин(?:ь(?:ся)?|ьте(?:сь)?|ешь(?:ся)?|ете(?:сь)?)","переве(?:ди|дите|дешь|дете)","отправ(?:ь|ьте|ишь|ите)","соб(?:ери|ерите|ерешь|ерете)","(?:от)?да(?:й|йте|шь|дите)","верн(?:и|ите|ешь|ете)","возвра(?:ти|тите|тишь|щай|щайте)","займ(?:и|ите|ешь)"].join("|")})|(${["перевод","(?:за|с|пере)?кин(?:уть(?:ся)?|у(?:сь)?|ем(?:ся)?)","переве(?:сти|вожу|дим|ду|ем)","отправ(?:ить|ляю|ляем|лю|им)","(?:со)?б(?:рать|ираю|ираем|еру|ерем)","(?:от)?да(?:ть|ю|ем|м|дим)","верн(?:уть|у|ем)","возвра(?:тить|щу|тим|щаю|щаем)"].join("|")}))((?:\\s+(?:${[...m,...v,...f,...g].join("|")}))+)\\s*$`),k=new RegExp(`(${m.join("|")})|(${v.join("|")})|(${f.join("|")})|(${g.join("|")})`,"gi"),S={DEFAULT_QUERY:"деньги",introViewed:!1,match:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=e.toLowerCase().replace(/ё/g,"е").match(w);if(t){for(var r={input:e,request:t[1],send:t[2],context:t[3]};t=k.exec(r.context),t;)for(var i={receiver:t[1],subject:t[2],method:t[3],amount:t[4]},o=0,n=Object.entries(i);o<n.length;o++){var a=_(n[o],2),s=a[0],c=a[1];c&&(r[s]=b(s,c))}if(r.subject||r.method||r.amount)return r}return null},setIntroViewed:function(e){this.introViewed=e},onClick:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this.introViewed){var n=[e,t,r,i].join("_");showBox("al_payments.php",{act:"money_transfer_box",tab:r,amount:i,owner_id:e,to_id:t,from:"sticker_link"},{cache:this.lastBoxId===n,onDone:()=>{cur.paymentsOptions&&(cur.paymentsOptions.onSendStart=o.onSendStart)}}),this.lastBoxId=n}else showWiki(p({w:"moneysend_promo",fromId:e,toId:t,action:r},i?{amount:i}:{})),this.introViewed=!0}},j=r("jE6c");function E(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return O(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return O(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var C=Object.entries(i.EMOJI_HINTS).map(e=>{var t=E(e,2),r=t[0],i=E(t[1],2),o=(i[0],i[1]);return[new RegExp(`(\\s|^)(${Object(j.escapeRE)(o)}${o.endsWith(")")||o.endsWith("(")?"+":""})([\\s\\.,]|$)`,"gi"),r]}),T={q:"й",w:"ц",e:"у",r:"к",t:"е",y:"н",u:"г",i:"ш",o:"щ",p:"з","[":"х","]":"ъ",a:"ф",s:"ы",d:"в",f:"а",g:"п",h:"р",j:"о",k:"л",l:"д",";":"ж","'":"э",z:"я",x:"ч",c:"с",v:"м",b:"и",n:"т",m:"ь",",":"б",".":"ю","/":"."};browser.mac?T["\\"]="ё":T["`"]="ё";var L=new RegExp(`[${Object(j.escapeRE)(Object.keys(T).join(""))}]`,"gi"),I=e=>e.replace(L,e=>T[e]),N=Object.entries(T).reduce((e,t)=>{var r=E(t,2),i=r[0];return e[r[1]]=i,e}),B=new RegExp(`[${Object(j.escapeRE)(Object.keys(N).join(""))}]`,"gi"),x=e=>e.replace(B,e=>N[e]);var R,P=class{constructor(e){this.config={mvk:!1,peerId:null,maxInputLength:256},this.setConfig(e)}setConfig(e){Object.assign(this.config,e)}getQueries(e){if(!e||e.length>this.config.maxInputLength)return[""];var t=window.Wall&&window.Wall.replyNamesRE||window.post&&window.post.replyNamesRE;if(t){var r=t();r&&(e=e.replace(r,""))}e=e.toLowerCase(),e=(e=C.reduce((e,t)=>{var r=E(t,2),i=r[0],n=r[1];return e.replace(i,(e,t,r,i)=>(t||"")+Object(o.emojiByteHexToSymbol)(n)+(i||""))},e)).replace(/^[\s\uFEFF\xA0]+|\n+$/g,"");for(var i=[e=Object(o.emojiRemoveSkinToneModifiers)(e)],n=0,a=[...i];n<a.length;n++){var s=a[n];i.push(I(s)),i.push(x(s))}for(var c=0,l=[...i];c<l.length;c++){var d=l[c];i.push(d.replace(/ё/g,"е")),i.push(d.replace(/е/g,"ё"))}for(var u=0,p=[...i];u<p.length;u++){var _=p[u];i.push(_.replace(/[.!?]+$/,""))}return Object.keys(i.reduce((e,t)=>(e[t]=1,e),{}))}isBotLinkEnabled(){return Object(l.partConfigEnabled)("stickers_bot_link")&&-184940019!==this.config.peerId}getBotLinkUrl(){return this.config.mvk?"/mail?act=show&peer=-184940019":"/im?sel=-184940019"}getBotLinkImageUrl(e){return`/images/stickers_suggestions_bot_${arguments.length>1&&void 0!==arguments[1]?arguments[1]:"light"}_${e}.png`}getBotLinkClickStatName(){return"stickers_suggestions_bot_link"}getBotLinkClickStatKeys(){return[]}isMoneyTransferEnabled(){return Object(l.partConfigEnabled)("stickers_money_transfer_suggestions")&&(this.isMoneySendEnabled()||this.isMoneyRequestEnabled())}isMoneySendEnabled(){return Boolean(this.config.moneyTransfer&&this.config.moneyTransfer.send)}isMoneyRequestEnabled(){return Boolean(this.config.moneyTransfer&&this.config.moneyTransfer.request)}},A=r("QGEU"),M=r("v+DW"),D=r("EasH"),F=r("FWc3"),H=r("4+be"),V=r("ZxpX");!function(e){e.LIGHT="light",e.DARK="dark",e.DEFAULT="light"}(R||(R={}));var U,K=Symbol(),W=Symbol();!function(e){e.IsNew="is_new"}(U||(U={}));var G,q=function(e){return void 0!==e.sticker_ids},z=function(e){return void 0!==e.base_id},Q=function(e){return q(e)&&!z(e)};!function(e){e.Pack="pack",e.Style="style"}(G||(G={}));var X,Y,$,J,Z=function(){function e(e){var t=this;void 0===e&&(e=[]),this.pack=new Set,this.style=new Set,e.forEach((function(e){return t.add(e)}))}return e.prototype.add=function(e){e&&(Q(e)?this.pack.add(e):z(e)&&this.style.add(e))},e.prototype.getPack=function(){return this.pack.values().next().value},e.prototype.getStyles=function(){return Array.from(this.style.values())},e.prototype.getCount=function(){return this.pack.size+this.style.size},e}(),ee=(function(){function e(e){var t=this;this.pack=[],this.style=[],e.forEach((function(e){return t.add(e)}))}e.prototype.add=function(e){var t=e.product;t&&(Q(t)?this.pack.push(e):z(t)&&this.style.push(e))}}(),{square_png:{id:"square.png",width:104,height:104},square_15x_png:{id:"square_1.5x.png",width:156,height:156},square_2x_png:{id:"square_2x.png",width:208,height:208},square_3x_png:{id:"square_3x.png",width:312,height:312},square_4x_png:{id:"square_4x.png",width:416,height:416}}),te=(R.LIGHT,R.LIGHT,R.LIGHT,R.LIGHT,R.LIGHT,R.LIGHT,R.DARK,R.DARK,R.DARK,R.DARK,R.DARK,R.DARK,{"64_png":{id:"64.png",width:64,height:64,theme:R.LIGHT},"128_png":{id:"128.png",width:128,height:128,theme:R.LIGHT},"256_png":{id:"256.png",width:256,height:256,theme:R.LIGHT},"352_png":{id:"352.png",width:352,height:352,theme:R.LIGHT},"512_png":{id:"512.png",width:512,height:512,theme:R.LIGHT},"64b_png":{id:"64b.png",width:64,height:64,theme:R.DARK},"128b_png":{id:"128b.png",width:128,height:128,theme:R.DARK},"256b_png":{id:"256b.png",width:256,height:256,theme:R.DARK},"352b_png":{id:"352b.png",width:352,height:352,theme:R.DARK},"512b_png":{id:"512b.png",width:512,height:512,theme:R.DARK}}),ie=((X={})[R.LIGHT]="animation.json",X[R.DARK]="animation.b.json",X),oe={products:(Y=[],new Map(Y)),productIdsQueue:new Set,productsPromise:void 0,productPromises:new Map,stickers:new Map};!function(e){e.NOT_SIGNED_IN="not_signed_in",e.NO_VALID_ITEMS="no_valid_items"}($||($={})),function(e){e.DUPLICATE_PRODUCT="duplicate_product"}(J||(J={}));var ne=function(e,t,r,i){void 0===i&&(i=R.DEFAULT);var o=window.devicePixelRatio,n=[t*=o,r*=o,i].toString(),a=e[W];if(a&&a.has(n)){var s=a.get(n);if(s)return s}a||(a=new Map,e[W]=a);var c=function(e){var t=e[K];return t||(t=Object.values(e).sort((function(e,t){return e.width-t.width||e.height-t.height})),e[K]=t),t}(e).filter((function(e){return!e.theme||e.theme===i})),l=c.find((function(e){return e.width>=t&&e.height>=r}))||c[c.length-1];return a.set(n,l),l},ae=function(e,t,r,i){return void 0===i&&(i=R.DEFAULT),function(e,t){return e.image.base_url+"/"+t.id+(e.image.version?"?"+e.image.version:"")}(e,function(e,t,r){return void 0===r&&(r=R.DEFAULT),ne(te,e,t,r)}(t,r,i))},le=function(e,t,r,i){return void 0===i&&(i=R.DEFAULT),function(e,t){return e.icon.base_url+"/"+t.id+(e.thumb.version?"?"+e.thumb.version:"")}(e,function(e,t,r){return void 0===r&&(r=R.DEFAULT),ne(ee,e,t,r)}(t,r,i))},de=function(e){return-1===e.recipient_id},ue=r("3oLO"),pe=r("Xrg9"),_e=function(){return(_e=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},he=function(){if(!window.stickersCache){var e=pe.default.get("stickers_cache");window.stickersCache=_e(_e({},oe),e)}return window.stickersCache},me=function(e){window.stickersCache=_e(_e({},he()),e)},ve=function(e){return he().stickers.get(e)},fe=function(e){var t=ve(e);if(!t||!t.pack_id)return null;var r=we(t.pack_id);return r&&q(r)?r:null},ye=function(){return(ye=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},be=function(e,t){void 0===t&&(t=[]);var r=he();if(e.stickers)for(var i=r.stickers,o=0,n=e.stickers;o<n.length;o++){var a=n[o];i.has(a.id)?i.set(a.id,ye(ye({},i.get(a.id)),a)):i.set(a.id,a)}if(e.products)for(var s=0,c=e.products;s<c.length;s++){var l=c[s];r.products.set(l.id,l),r.productPromises.delete(l.id)}for(var d=0,u=t;d<u.length;d++){var p=u[d];r.products.has(p)||r.products.set(p,null),r.productPromises.delete(p)}e.emoji&&window.Emoji&&window.Emoji.updateTabs(e.emoji.stickers,e.emoji.keywords,!0),me(r)},we=function(e){return he().products.get(e)},ke=function(e){var t=he().products;return e.map((function(e){return t.get(e)}))};var Se=function(e){if(!e.length)return Promise.resolve([]);for(var t,r=he(),i=r.productPromises,o=r.productIdsQueue,n=new Set,a=0,s=e;a<s.length;a++){var c=s[a];if(i.has(c)){(l=i.get(c))&&n.add(l)}else{o.add(c);var l=(t=void 0,(t=he().productsPromise)||(t=new Promise((function(e){return setTimeout((function(){var t=he().productIdsQueue,r=Array.from(t);t.clear(),me({productIdsQueue:t,productsPromise:void 0}),ue.ajax.post("stickers.php",{act:"get_products",product_ids:r},{onDone:function(t){be(t,r),e()},onFail:function(t){return console.error(t),be({},r),e(),!0}})}),300)})),me({productsPromise:t})),t);i.set(c,l),n.add(l)}}return me({productIdsQueue:o,productPromises:i}),Promise.all(n).then((function(){return ke(e)}))},je=function(e,t){void 0===t&&(t=!0);var r=t?e.filter((function(e){return void 0===we(e)})):e;return r.length?Se(r).then((function(){return ke(e)})):Promise.resolve(ke(e))},Ee=function(e,t,r,i){return void 0===i&&(i=!0),new Promise((function(o){ue.ajax.post("stickers.php",{act:"update_user_product_state",product_ids:[e],key:t,value:r},{onDone:function(e){i&&be(e),o()},onFail:function(e){return console.error(e),o(),!0}})}))},Oe=r("q1tI"),Ce=r.n(Oe),Te=r("i8i4"),Le=r.n(Te),Ie=r("Syzc"),Ne=function(){return(Ne=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},Be=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],a=0,s=n.length;a<s;a++,o++)i[o]=n[a];return i},xe=function(){function e(e,t){void 0===t&&(t=[]),this.loadTimeout=null,this.loadCancellationToken=null,this.isGift=!1,this.onChange=null,this._order=null,this.setItems(e),this.recipientIds=new Set(t),this.recipients=new Map}return e.create=function(t,r){return void 0===r&&(r=[]),new e(t.map((function(e){return{product_id:e,amount:1}})),r)},e.prototype.copy=function(){var t=new e(this.getItems(),this.getRecipientIds());return t.setOrder(this.getOrder()),t},e.prototype.getItems=function(){return Array.from(this.items.values())},e.prototype.setItems=function(e){this.items=new Map(e.map((function(e){return[e.product_id,e]})))},e.prototype.loadItems=function(){var e=this,t=Array.from(this.items.keys());return je(t).then((function(){for(var t=0,r=Array.from(e.items.values());t<r.length;t++){var i=r[t];i.product=we(i.product_id)}}))},e.prototype.getProducts=function(){return ke(Array.from(this.items.keys()))},e.prototype.hasProduct=function(e){return this.items.has(e)},e.prototype.addProduct=function(e,t){if(void 0===t&&(t=!1),!this.hasProduct(e)){var r={product_id:e,amount:1};t?this.setItems(Be(this.getItems(),[r])):this.setItems(Be([r],this.getItems())),this.onChange&&this.onChange()}},e.prototype.removeProduct=function(e){this.hasProduct(e)&&(this.items.delete(e),this.onChange&&this.onChange())},e.prototype.getRecipientIds=function(e){return void 0===e&&(e=!1),this.recipientIds.size?Array.from(this.recipientIds.values()):this.isGift&&e?[-1]:[]},e.prototype.setRecipientIds=function(e){this.recipientIds=new Set(e)},e.prototype.hasRecipientId=function(e){return this.recipientIds.has(e)},e.prototype.addRecipientId=function(e){this.hasRecipientId(e)||(this.recipientIds.add(e),this.onChange&&this.onChange())},e.prototype.removeRecipientId=function(e){this.hasRecipientId(e)&&(this.recipientIds.delete(e),this.onChange&&this.onChange())},e.prototype.setOrder=function(e){if(this._order=e,e){this.recipientIds.clear();for(var t=0,r=e.items;t<r.length;t++){var i=r[t];-1!==i.recipient_id&&this.recipientIds.add(i.recipient_id)}}},e.prototype.loadOrder=function(e){var t=e.items.map((function(e){return e.product_id}));return je(t).then((function(t){return Ne(Ne({},e),{items:e.items.map((function(e,r){return Ne(Ne({},e),{product:t[r]})}))})}),(function(){return e}))},e.prototype.getOrder=function(){return this._order},e.prototype.getRecipientsMap=function(){return this.recipients},e.prototype.getRecipients=function(){return Array.from(this.recipients.values())},e.prototype.getRecipientById=function(e){return this.recipients.get(e)},e.prototype.addRecipients=function(e){this.recipients=new Map(Be(this.getRecipients(),e).map((function(e){return[e[0],e]})))},e.prototype.getJSON=function(){return JSON.stringify({items:this.getItems().map((function(e){return Ne(Ne({},e),{product:void 0})})),recipient_ids:this.getRecipientIds(!0)})},e.prototype.isLoaded=function(){return null!==this.getOrder()},e.prototype.cancelLoad=function(){this.loadTimeout&&(window.clearTimeout(this.loadTimeout),this.loadTimeout=null),this.loadCancellationToken&&(this.loadCancellationToken.cancel(),this.loadCancellationToken=null)},e.prototype.load=function(e){var t=this;return void 0===e&&(e=!1),this.cancelLoad(),new Promise((function(r){t.loadTimeout=window.setTimeout((function(){t.loadCancellationToken=new Ie.AjaxCancellationToken,ue.ajax.post("stickers.php",{act:"preview_products_order",cart:t.getJSON(),with_suggested_recipients:e?1:0},{cancellationToken:t.loadCancellationToken,onDone:function(e){be(e),Promise.all([t.loadItems(),t.loadOrder(e.order)]).then((function(i){var o=i[1];t.setOrder(o),e.recipients&&t.addRecipients(e.recipients),r(t)}),(function(){}))},onFail:function(e){return e&&window.__dev&&console.error(e),r(t),!0}})}),300)}))},e.prototype.order=function(e){var t=this;return void 0===e&&(e={}),new Promise((function(r){ue.ajax.post("stickers.php",{act:"order_products",cart:t.getJSON(),message:e.message,is_private:e.is_private?1:0,ref:e.ref,gift_ref:e.gift_ref},{onDone:function(e){be(e),Promise.all([t.loadOrder(e.order),t.loadOrder(e.result)]).then((function(e){var i=e[0],o=e[1];t.setOrder(i),r(o)}),(function(){}))},onFail:function(e){return e&&console.error(e),r(null),!0}})}))},e}(),Re=r("6krn"),Pe=r("kcIO"),Ae=Re.default.getLang;function Me(){return document.querySelector("#box_loader")}function De(){return document.querySelector("#box_layer_wrap")}function Fe(){var e=Me();Object(Pe.boxRefreshCoords)(e),Object(u.show)(e),Object(u.show)(De())}function He(){Object(u.hide)(Me())}function Ve(e){var t=new Z(e.items.filter((function(e){return!e.error})).map((function(e){return e.product}))),r=t.getPack(),i=t.getStyles();if(r)return i.length?Object(H.langStr)(Ae("purchases_stickers_purchase_result_pack_and_styles",i.length),"pack_title",r.title,"n",i.length):Object(H.langStr)(Ae("purchases_stickers_purchase_result_pack"),"title",r.title);if(i.length)switch(i.length){case 1:return Object(H.langStr)(Ae("purchases_stickers_purchase_result_1_style"),"title",i[0].title);case 2:return Object(H.langStr)(Ae("purchases_stickers_purchase_result_2_styles"),"title1",i[0].title,"title2",i[1].title);case 3:return Object(H.langStr)(Ae("purchases_stickers_purchase_result_3_styles"),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title);case 4:return Object(H.langStr)(Ae("purchases_stickers_purchase_result_3_styles_and_1_more"),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title);default:var o=i.length-3;return Object(H.langStr)(Ae("purchases_stickers_purchase_result_3_styles_and_n_more",o),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title,"n",o)}return null}var Ue=r("85vT"),Ke=r("BiHW"),We=r("WfnU"),Ge=function(e){var t=Object(Oe.useState)({})[1],r=we(e);return void 0===r?(function(e,t){if(void 0===t&&(t=!0),t){var r=we(e);if(void 0!==r)return Promise.resolve(r)}return Se([e]).then((function(){return we(e)}))}(e,!1).then((function(){return t({})}),(function(){})),[r,!0]):[r,!1]},qe=function(e){var t=Ge(e),r=t[0],i=t[1];return r&&Q(r)?[r,i]:[void 0===r?void 0:null,i]},ze=function(e){var t=Object(Oe.useState)({})[1],r=ke(e);return r.some((function(e){return void 0===e}))?(je(e,!1).then((function(){return t({})}),(function(){})),[r,!0]):[r,!1]},Qe=function(e){for(var t=ze(e),r=t[0],i=t[1],o=[],n=0,a=r;n<a.length;n++){var s=a[n];s&&z(s)&&o.push(s)}return[o,i]},Xe=function(){return(Xe=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};var Ye=function(e){var t=Object(Oe.useState)(e),r=t[0],i=t[1],o=Object(Oe.useState)(null),n=o[0],a=o[1],s=Object(Oe.useCallback)((function(){var e=r.load();a(e),e.then((function(t){i(t),a((function(t){return t===e?null:t}))}),(function(){}))}),[r]);return Object(Oe.useEffect)((function(){return r.onChange=s,r.isLoaded()||s(),function(){r.onChange=null,r.cancelLoad()}}),[r]),[r,null!==n]},$e=r("9R94");function Je(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ze(){return(Ze=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}function et(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var tt=new Map,rt=new Map,it=new Map,ot=0;function nt(e,t,r){void 0===r&&(r={}),r.threshold||(r.threshold=0);var i=r,o=i.root,n=i.rootMargin,a=i.threshold;if(tt.has(e)&&Object($e.default)(!1),e){var s=function(e){return e?it.has(e)?it.get(e):(ot+=1,it.set(e,ot.toString()),it.get(e)+"_"):""}(o)+(n?a.toString()+"_"+n:a.toString()),c=rt.get(s);c||(c=new IntersectionObserver(st,r),s&&rt.set(s,c));var l={callback:t,element:e,inView:!1,observerId:s,observer:c,thresholds:c.thresholds||(Array.isArray(a)?a:[a])};return tt.set(e,l),c.observe(e),l}}function at(e){if(e){var t=tt.get(e);if(t){var r=t.observerId,i=t.observer,o=i.root;i.unobserve(e);var n=!1,a=!1;r&&tt.forEach((function(t,i){i!==e&&(t.observerId===r&&(n=!0,a=!0),t.observer.root===o&&(a=!0))})),!a&&o&&it.delete(o),i&&!n&&i.disconnect(),tt.delete(e)}}}function st(e){e.forEach((function(e){var t=e.isIntersecting,r=e.intersectionRatio,i=e.target,o=tt.get(i);if(o&&r>=0){var n=o.thresholds.some((function(e){return o.inView?r>e:r>=e}));void 0!==t&&(n=n&&t),o.inView=n,o.callback(n,e)}}))}var ct=function(e){var t,r;function i(){for(var t,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return Je(et(t=e.call.apply(e,[this].concat(i))||this),"state",{inView:!1,entry:void 0}),Je(et(t),"node",null),Je(et(t),"handleNode",(function(e){t.node&&(at(t.node),e||t.props.triggerOnce||t.setState({inView:!1,entry:void 0})),t.node=e||null,t.observeNode()})),Je(et(t),"handleChange",(function(e,r){(e!==t.state.inView||e)&&t.setState({inView:e,entry:r}),t.props.onChange&&t.props.onChange(e,r)})),t}r=e,(t=i).prototype=Object.create(r.prototype),t.prototype.constructor=t,t.__proto__=r;var o=i.prototype;return o.componentDidMount=function(){this.node||Object($e.default)(!1)},o.componentDidUpdate=function(e,t){e.rootMargin===this.props.rootMargin&&e.root===this.props.root&&e.threshold===this.props.threshold||(at(this.node),this.observeNode()),t.inView!==this.state.inView&&this.state.inView&&this.props.triggerOnce&&(at(this.node),this.node=null)},o.componentWillUnmount=function(){this.node&&(at(this.node),this.node=null)},o.observeNode=function(){if(this.node){var e=this.props,t=e.threshold,r=e.root,i=e.rootMargin;nt(this.node,this.handleChange,{threshold:t,root:r,rootMargin:i})}},o.render=function(){var e=this.state,t=e.inView,r=e.entry;if(!function(e){return"function"!=typeof e.children}(this.props))return this.props.children({inView:t,entry:r,ref:this.handleNode});var i=this.props,o=i.children,n=i.as,a=i.tag,s=(i.triggerOnce,i.threshold,i.root,i.rootMargin,i.onChange,function(e,t){if(null==e)return{};var r,i,o={},n=Object.keys(e);for(i=0;i<n.length;i++)r=n[i],t.indexOf(r)>=0||(o[r]=e[r]);return o}(i,["children","as","tag","triggerOnce","threshold","root","rootMargin","onChange"]));return Object(Oe.createElement)(n||a||"div",Ze({ref:this.handleNode},s),o)},i}(Oe.Component);Je(ct,"displayName","InView"),Je(ct,"defaultProps",{threshold:0,triggerOnce:!1});var lt={inView:!1,entry:void 0};var dt=function(e){var t=e.className,r=e.sticker,i=e.theme,o=e.width,n=e.height,a=e.isInView,s=void 0===a||a,c=Ce.a.useRef(null),l=ae(r,o,n,i);return Ce.a.useLayoutEffect((function(){c.current&&c.current.src!==l&&s&&(c.current.src=l)}),[s,l]),Ce.a.createElement("div",{className:Object(V.classNames)("StickerImage",t),style:{width:o,height:n}},Ce.a.createElement("img",{className:"StickerImage__image",ref:c}))},ut=r("lPHp"),pt=r.n(ut),_t=function(){return(_t=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},ht=function(e){var t=e.className,r=e.sticker,i=e.theme,o=e.width,n=e.height,a=e.isInView,s=void 0===a||a,c=e.play,l=void 0!==c&&c,d=Ce.a.useRef(null),u=Ce.a.useState(null),p=u[0],_=u[1],h=function(e,t){return void 0===t&&(t=R.DEFAULT),e.animation?e.animation.base_url+"/"+ie[t]:""}(r,i);return Ce.a.useEffect((function(){if(p&&p.isLoaded){var e=l&&s;e&&!p.playing&&(p.item.play(),_(_t(_t({},p),{playing:!0}))),!e&&p.playing&&(p.item.pause(),_(_t(_t({},p),{playing:!1})))}}),[p,l,s]),Ce.a.useEffect((function(){if(!p||p.url!==h)if(p&&p.item.destroy(),h&&s){var e=pt.a.loadAnimation({container:d.current,path:h,renderer:"svg",autoplay:!1,loop:!0,rendererSettings:{className:"StickerAnimation__animation",progressiveLoad:!0,hideOnTransparent:!0}}),t={url:h,isLoaded:!1,item:e,playing:!1};e.addEventListener("DOMLoaded",(function(){_(_t(_t({},t),{isLoaded:!0}))})),_(t)}else _(null)}),[h,s]),Ce.a.createElement("div",{className:Object(V.classNames)("StickerAnimation",t),style:{width:o,height:n},ref:d})},mt=function(e){var t=e.className,r=e.sticker,i=e.theme,o=void 0===i?R.LIGHT:i,n=e.width,a=e.height,s=function(e){void 0===e&&(e={});var t=Object(Oe.useRef)(),r=Object(Oe.useState)(lt),i=r[0],o=r[1],n=Object(Oe.useCallback)((function(r){t.current&&at(t.current),r&&nt(r,(function(t,i){o({inView:t,entry:i}),t&&e.triggerOnce&&at(r)}),e),t.current=r}),[e.threshold,e.root,e.rootMargin,e.triggerOnce]);return Object(Oe.useEffect)((function(){t.current||i===lt||e.triggerOnce||o(lt)})),[n,i.inView,i.entry]}({threshold:0}),c=s[0],l=s[1],d=void 0!==r.animation,u=Ce.a.useState(!1),p=u[0],_=u[1];return Ce.a.createElement("div",{className:Object(V.classNames)("Sticker",t),ref:c,onMouseEnter:function(){_(!0)},onMouseLeave:function(){_(!1)}},d?Ce.a.createElement(ht,{sticker:r,theme:o,width:n,height:a,isInView:l,play:p}):Ce.a.createElement(dt,{sticker:r,theme:o,width:n,height:a,isInView:l}))},vt=r("IrTF"),ft=r("JxXo"),gt=r("b8Q7"),yt=function(){return(yt=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},bt={getOffset:function(){return{x:0,y:0}},scrollTo:function(){},scrollBy:function(){},onWheel:function(){},updateItems:function(){},hasPrev:!1,hasNext:!1,prev:function(){},next:function(){}};function wt(e,t){switch(t.type){case"updateState":return yt(yt({},e),t.state);case"updateNav":return t.hasPrev!==e.hasPrev||t.hasNext!==e.hasNext?yt(yt({},e),{hasPrev:t.hasPrev,hasNext:t.hasNext}):e;default:throw new Error}}var kt=function(e){for(var t=Array.from(e.entries()),r=0;r<t.length;r++){var i=t[r],o=i[0],n=i[1];if(n&&n.intersectionRatio)return n.intersectionRatio<1?o:t[r-1]?t[r-1][0]:null}return null},St=function(e){for(var t=Array.from(e.entries()),r=t.length-1;r>=0;r--){var i=t[r],o=i[0],n=i[1];if(n&&n.intersectionRatio)return n.intersectionRatio<1?o:t[r+1]?t[r+1][0]:null}return null};var jt=function(e){var t=Ce.a.useRef(null),r=Ce.a.useReducer(wt,bt),i=r[0],o=r[1],n=Ce.a.useCallback((function(e){o({type:"updateState",state:e})}),[o]),a=Ce.a.useCallback((function(r){if(t.current&&i.onMouseWheel&&t.current.removeEventListener("mousewheel",i.onMouseWheel),r){var a=r.querySelector(e.wrapperSelector);if(a){var s,c={x:0,y:0},l=new Map,d=function(t){var i=0;a.offsetWidth>r.offsetWidth&&(i=Math.max(0,Math.min(a.offsetWidth-r.offsetWidth,t.x)));var o=0;a.offsetHeight>r.offsetHeight&&(o=Math.max(0,Math.min(a.offsetHeight-r.offsetHeight,t.y))),a.style.transform="translate3d(-"+i+"px, -"+o+"px, 0)",a.style.transitionDuration=t.noTransition?"0s":"",c={x:i,y:o},e.onScroll&&e.onScroll(i,o)},u=function(e){d(yt(yt({},e),{x:c.x+e.x,y:c.y+e.y}))},p=function(e){e.deltaX&&e.preventDefault()};r.addEventListener("mousewheel",p),n(yt(yt({},i),{onMouseWheel:p,updateItems:function(){s&&s.disconnect(),s=new IntersectionObserver((function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];l.has(i.target)&&l.set(i.target,i)}o({type:"updateNav",hasPrev:null!==kt(l),hasNext:null!==St(l)})}),{root:r,threshold:[0,1]}),l.clear();for(var t=0,i=r.querySelectorAll(e.itemSelector);t<i.length;t++){var n=i[t];l.set(n,null),s.observe(n)}},getOffset:function(){return c},scrollTo:d,scrollBy:u,onWheel:function(e){u({x:e.deltaX,y:e.deltaY,noTransition:!0})},prev:function(){var e=kt(l);if(e){var t=getComputedStyle(a),r=parseInt(t.paddingLeft)||0,i=parseInt(t.paddingTop)||0,o=a.getBoundingClientRect(),n=e.getBoundingClientRect();d({x:n.left-o.left-r,y:n.top-o.top-i})}},next:function(){var e=St(l);if(e){var t=getComputedStyle(a),i=parseInt(t.paddingBottom)||0,o=parseInt(t.paddingRight)||0,n=r.getBoundingClientRect(),s=a.getBoundingClientRect(),c=e.getBoundingClientRect();d({x:c.left-s.left-n.width+c.width+o,y:c.top-s.top-n.height+c.height+i})}}}))}}t.current=r}),[e.wrapperSelector,e.itemSelector,e.onScroll]);return Ce.a.useLayoutEffect((function(){i.updateItems()})),yt({ref:a},i)},Et=Re.default.getLang,Ot=function(e){var t,r=e.className,i=e.style,o=e.isAdded,n=void 0!==o&&o,a=e.add,s=e.remove,c=e.gift,l=e.isActive,d=e.isSelected,u=e.select;t=i.is_new?i.title.trim().replace(/(^|\s)([^\s]+)$/,'$1<span class="StickerStylesMenuItem__titleLastWord">$2</span>'):i.title;var p=ve(i.style_sticker_ids[0]),_=function(e){return function(t){t.stopPropagation(),e()}};return Ce.a.createElement("div",{className:Object(V.classNames)("StickerStylesMenuItem",r,{"StickerStylesMenuItem--selected":Boolean(d),"StickerStylesMenuItem--added":Boolean(n),"StickerStylesMenuItem--new":i.is_new}),onClick:function(){u?u():n?s&&s():a&&a()}},p&&Ce.a.createElement(mt,{className:"StickerStylesMenuItem__icon",sticker:p,width:100,height:100}),Ce.a.createElement(Ue.default,{element:"div",className:"StickerStylesMenuItem__title"},t),i.is_purchased?void 0===l?Ce.a.createElement("div",{className:"StickerStylesMenuItem__notice"},Et("purchases_stickers_you_have_it")):l&&Ce.a.createElement("div",{className:"StickerStylesMenuItem__notice"},Et("purchases_stickers_active_style")):i.price.purchase.regular?Ce.a.createElement("div",{className:"StickerStylesMenuItem__price"},Et("global_n_votes",i.price.purchase.current)):Ce.a.createElement("div",{className:"StickerStylesMenuItem__price"},Et("purchases_for_free_btn")),(a||s||c&&i.can_gift)&&Ce.a.createElement("div",{className:"StickerStylesMenuItem__actions"},n?s&&Ce.a.createElement(Ke.default,{className:"StickerStylesMenuItem__remove",appearance:"secondary",size:"s",onClick:_(s)},Et("purchases_stickers_preview_remove_item")):a&&Ce.a.createElement(Ke.default,{className:"StickerStylesMenuItem__add",appearance:"primary",size:"s",onClick:_(a)},Et("purchases_stickers_preview_add_item")),c&&i.can_gift&&Ce.a.createElement(Ke.default,{className:"StickerStylesMenuItem__gift",size:"s",appearance:"primary",onClick:_(c)})))},Ct=Re.default.getLang,Tt=function(e){var t=e.className,r=e.styles,i=e.isLoading,o=e.isAdded,n=e.add,a=e.remove,s=e.gift,c=e.activeStyle,l=e.selectedStyle,d=e.select,u=jt({wrapperSelector:".StickerStylesMenu__wrapper",itemSelector:".StickerStylesMenu__item"});if(i)return Ce.a.createElement("section",{className:Object(V.classNames)("StickerStylesMenu","StickerStylesMenu--loading",t)},Ce.a.createElement(vt.default,{className:"StickerStylesMenu__progress"}));var p=[{title:Ct("purchases_stickers_purchased_styles"),styles:r.filter((function(e){return e.is_purchased&&!e.is_disabled}))},{title:Ct("purchases_stickers_other_styles"),styles:r.filter((function(e){return!e.is_purchased&&!e.is_disabled&&!e.is_hidden})),tooltip:Ct("purchases_stickers_styles_hint")}].filter((function(e){return e.styles.length}));return p.length?Ce.a.createElement("section",{className:Object(V.classNames)("StickerStylesMenu",t),ref:u.ref,onWheel:function(e){return u.onWheel(e)}},Ce.a.createElement("a",{className:Object(V.classNames)("StickerStylesMenu__nav","StickerStylesMenu__nav--prev",{"StickerStylesMenu__nav--disabled":!u.hasPrev}),onClick:function(){return u.prev()}}),Ce.a.createElement("a",{className:Object(V.classNames)("StickerStylesMenu__nav","StickerStylesMenu__nav--next",{"StickerStylesMenu__nav--disabled":!u.hasNext}),onClick:function(){return u.next()}}),Ce.a.createElement("div",{className:"StickerStylesMenu__wrapper"},p.map((function(e,t){return Ce.a.createElement("section",{className:"StickerStylesMenu__group",key:t},Ce.a.createElement("h2",{className:"StickerStylesMenu__groupTitle"},e.title,e.tooltip&&Ce.a.createElement(ft.default,{className:"StickerStylesMenu__groupTitleHint",text:e.tooltip,position:"b",align:"center",appearance:"light"},Ce.a.createElement(gt.default,{className:"StickerStylesMenu__groupTitleHintIcon"}))),Ce.a.createElement("div",{className:"StickerStylesMenu__groupItems"},e.styles.map((function(e){return Ce.a.createElement(Ot,{className:"StickerStylesMenu__item",style:e,isLoading:i,isAdded:o&&o(e),add:n&&function(){return n(e)},remove:a&&function(){return a(e)},gift:s&&function(){return s(e)},isActive:void 0===c?void 0:e===c,isSelected:void 0===l?void 0:e===l,select:d&&function(){return d(e)},key:e.id})}))))})))):null},Lt=function(e){var t=e.className,r=e.product;if(!Q(r)&&!z(r))return null;var i=function(e){var t=he().stickers;return e.map((function(e){return t.get(e)}))}(z(r)?r.style_sticker_ids:r.sticker_ids);return Ce.a.createElement("div",{className:Object(V.classNames)("StickersProductPreview",t)},Ce.a.createElement("ul",{className:"StickersProductPreview__stickers"},i.map((function(e){return e&&Ce.a.createElement(mt,{className:"StickersProductPreview__sticker",sticker:e,width:128,height:128,key:e.id})}))))},It=Re.default.getLang,Nt=function(e){var t=e.item,r=e.showHeader,i=void 0!==r&&r,o=e.remove;if(!t.product)return null;var n="";return Q(t.product)?n=Object(H.langStr)(It("purchases_stickers_product_preview_title_pack"),"title",t.product.title):z(t.product)&&(n=Object(H.langStr)(It("purchases_stickers_product_preview_title_style"),"title",t.product.title)),Ce.a.createElement("div",{className:"StickersCartItem"},i&&Ce.a.createElement("div",{className:"StickersCartItem__header"},Ce.a.createElement(Ue.default,{element:"span",className:"StickersCartItem__title"},n),o&&Ce.a.createElement("span",{className:"StickersCartItem__actions"},Ce.a.createElement("button",{className:"StickersCartItem__remove",onClick:function(){return o()}},It("purchases_stickers_preview_remove_item")))),Ce.a.createElement(Lt,{className:"StickersCartItem__preview",product:t.product}))},Bt=function(){return(Bt=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},xt=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(r[i[o]]=e[i[o]])}return r},Rt=Re.default.getLang,Pt=function(e){var t=e.className,r=e.price,i=e.text,o=e.placeholder,n=xt(e,["className","price","text","placeholder"]),a=Object(Oe.useMemo)((function(){if(r){var e;r.current!==r.regular&&r.regular&&(e=Ce.a.createElement("span",{className:"StickersPriceButton__regular",key:"regular"},r.current?r.regular:Object(H.langStr)(Rt("purchases_stickers_n_for_m"),"%n","","%m",Rt("global_n_votes",r.regular))));var t=Ce.a.createElement("span",{className:"StickersPriceButton__current",key:"current"},r.current?Rt("global_n_votes",r.current):Rt("purchases_for_free_btn").toLowerCase());return i?i.split(/(\{regular_price\}|\{price\})/).map((function(r,i){return"{regular_price}"===r?e:"{price}"===r?t:r?Ce.a.createElement("span",{className:"StickersPriceButton__label",key:"label"+i},r):void 0})):[e,t]}return[o]}),[i,o,null==r?void 0:r.regular,null==r?void 0:r.current]);return Ce.a.createElement(We.default,Bt({className:Object(V.classNames)("StickersPriceButton",t)},n),a)};Pt.defaultProps=Bt({},We.default.defaultProps);var At=Pt,Mt=r("euvX"),Dt=r("3blr"),Ft=r("s1Gz"),Ht=r("wQFj"),Vt={s:56,m:96,l:168},Ut=function(e){var t,r,i,o=e.order,n=e.forceValid,a=void 0!==n&&n,s=new Map,c=new Map;if(o)for(var l=0,d=o.items;l<d.length;l++){var u=d[l],p=u.product;p&&(Q(p)?s.has(p)?null===(t=s.get(p))||void 0===t||t.push(u):s.set(p,[u]):z(p)&&(c.has(p)?null===(r=c.get(p))||void 0===r||r.push(u):c.set(p,[u])))}var _=s.keys().next().value,h=(_?1:0)+c.size,m=h>1?h>2?"s":"m":"l",v=Vt[m],f=Array.from(c.entries());a||f.sort((function(e,t){var r=e[1];return t[1].filter((function(e){return!e.error})).length-r.filter((function(e){return!e.error})).length}));var g=f.slice(0,3),y=f.slice(3),b=!0;if(!a){var w=y.filter((function(e){return e[1].find((function(e){return!e.error}))}));w.length?y=w:b=!1}return Ce.a.createElement("ul",{className:"StickerProductsGiftIcons"},_&&Ce.a.createElement("li",{className:Object(V.classNames)("StickerProductsGiftIcons__icon","StickerProductsGiftIcons__icon--"+m,"StickerProductsGiftIcons__icon--pack",{"StickerProductsGiftIcons__icon--invalid":!a&&!(null===(i=s.get(_))||void 0===i?void 0:i.find((function(e){return!e.error})))}),style:{backgroundImage:"url("+le(_,v,v)+")"},key:_.id}),g.map((function(e){var t=e[0],r=e[1];return Ce.a.createElement("li",{className:Object(V.classNames)("StickerProductsGiftIcons__icon","StickerProductsGiftIcons__icon--"+m,"StickerProductsGiftIcons__icon--style",{"StickerProductsGiftIcons__icon--invalid":!a&&!r.find((function(e){return!e.error}))}),style:{backgroundImage:"url("+le(t,v,v)+")"},key:t.id})})),y.length?Ce.a.createElement("li",{className:Object(V.classNames)("StickerProductsGiftIcons__icon","StickerProductsGiftIcons__icon--"+m,"StickerProductsGiftIcons__icon--more",{"StickerProductsGiftIcons__icon--invalid":!b}),key:"more"},"+",y.length):null)},Kt=Re.default.getLang;var Wt=function(e){for(var t=e.order,r=e.recipients,i=function(e){if(!e)return null;var t=e.items.filter((function(e){var t=e.product;return null==t?void 0:t.can_gift})),r=t.filter((function(e){return!e.error&&!de(e)}));r.length&&(t=r);for(var i=[],o=[],n=0,a=t;n<a.length;n++){var s=a[n],c=s.product;c&&(Q(c)?i.push(s):z(c)&&o.push(s))}var l=o.reduce((function(e,t){var r;return e+((null===(r=t.price)||void 0===r?void 0:r.current)||0)}),0);if(i.length){var d=i.reduce((function(e,t){var r;return e+((null===(r=t.price)||void 0===r?void 0:r.current)||0)}),0);return o.length?Object(H.langStr)(Kt("purchases_stickers_gift_details_summary_pack_with_styles",o.length),"pack_price_sum",Kt("global_n_votes",d),"styles_num",o.length,"styles_price_sum",Kt("global_n_votes",l)):Object(H.langStr)(Kt("purchases_stickers_gift_details_summary_pack"),"pack_price_sum",Kt("global_n_votes",d))}if(o.length)return Object(H.langStr)(Kt("purchases_stickers_gift_details_summary_styles",o.length),"styles_num",o.length,"styles_price_sum",Kt("global_n_votes",l));return null}(t),o=new Map,n=0,a=t.items;n<a.length;n++){var s=a[n],c=s.error,l=s.product,d=s.recipient_id;if(!c){var u=r.get(d);if(u){var p=o.get(u);p||(p=new Z,o.set(u,p)),p.add(l)}}}var _=Array.from(o.entries()),h=Object(Oe.useRef)(null);return Object(Oe.useEffect)((function(){var e=h.current;e&&(e.style.maxHeight=e.getBoundingClientRect().bottom-22+"px")})),Ce.a.createElement("div",{className:"StickerProductsGiftDetails",ref:h},i&&Ce.a.createElement(Ue.default,{element:"p",className:"StickerProductsGiftDetails__summary"},i),_.length>0&&Ce.a.createElement("ul",{className:"StickerProductsGiftDetails__recipients"},_.map((function(e){var t=e[0],r=e[1];return Ce.a.createElement("li",{className:"StickerProductsGiftDetails__recipient",key:t[0]},Ce.a.createElement(Ue.default,{element:"div",className:"StickerProductsGiftDetails__recipientName"},t[1]),Ce.a.createElement("div",{className:"StickerProductsGiftDetails__recipientProducts"},function(e){var t=e.getPack(),r=e.getStyles(),i="";r.length&&(i=r.map((function(e){return Object(H.langStr)(Kt("purchases_stickers_gift_details_recipient_style_title"),"title",e.title)})).join(", "));if(t)return i?Object(H.langStr)(Kt("purchases_stickers_gift_details_recipient_pack_and_styles"),"pack_title",t.title,"style_titles",i):Object(H.langStr)(Kt("purchases_stickers_gift_details_recipient_pack"),"title",t.title);if(i)return Object(H.langStr)(Kt("purchases_stickers_gift_details_recipient_styles"),"style_titles",i);return null}(r)))}))))},Gt=Re.default.getLang;var qt=function(e){var t=e.cart,r=e.options,i=r.ref,o=r.gift_ref,n=e.closeBox,a=e.updateBox,s=Ye(t),c=s[0],l=s[1],d=!c.isLoaded()&&l;Object(Oe.useEffect)((function(){a()}),[d]);var u=c.getRecipientIds(),p=c.getOrder(),_=p&&!p.error&&p.items.find((function(e){return!e.error&&!de(e)})),h=function(e){if(!e)return[null,null];for(var t,r=0,i=e.items;r<i.length;r++){var o=i[r].product;if(o&&Q(o)){t=o;break}}var n=e.items.filter((function(e){var t=e.product;return null==t?void 0:t.can_gift})),a=n.filter((function(e){return!e.error&&!de(e)}));a.length&&(n=a);var s=new Z(n.map((function(e){return e.product}))),c=s.pack.values().next().value,l=Array.from(s.style),d="",u="";if(1===l.length)d=Object(H.langStr)(Gt("purchases_stickers_gift_title_1_style"),"title",l[0].title),c?u=Object(H.langStr)(Gt("purchases_stickers_gift_description_with_pack"),"title",c.title):t&&(u=Object(H.langStr)(Gt("purchases_stickers_gift_description_for_pack"),"title",t.title));else if(c){if(d=Object(H.langStr)(Gt("purchases_stickers_gift_title_pack"),"title",c.title),l.length)switch(l.length){case 2:u=Object(H.langStr)(Gt("purchases_stickers_gift_description_with_2_styles"),"title1",l[0].title,"title2",l[1].title);break;case 3:u=Object(H.langStr)(Gt("purchases_stickers_gift_description_with_3_styles"),"title1",l[0].title,"title2",l[1].title,"title3",l[2].title);break;case 4:u=Object(H.langStr)(Gt("purchases_stickers_gift_description_with_3_styles_and_1_more"),"title1",l[0].title,"title2",l[1].title,"title3",l[2].title);break;default:var p=l.length-3;u=Object(H.langStr)(Gt("purchases_stickers_gift_description_with_3_styles_and_n_more",p),"title1",l[0].title,"title2",l[1].title,"title3",l[2].title,"n",p)}}else if(l.length){switch(l.length){case 2:d=Object(H.langStr)(Gt("purchases_stickers_gift_title_2_styles"),"title1",l[0].title,"title2",l[1].title);break;case 3:d=Object(H.langStr)(Gt("purchases_stickers_gift_title_3_styles"),"title1",l[0].title,"title2",l[1].title,"title3",l[2].title);break;case 4:d=Object(H.langStr)(Gt("purchases_stickers_gift_title_3_styles_and_1_more"),"title1",l[0].title,"title2",l[1].title,"title3",l[2].title);break;default:p=l.length-3;d=Object(H.langStr)(Gt("purchases_stickers_gift_title_3_styles_and_n_more",p),"title1",l[0].title,"title2",l[1].title,"title3",l[2].title,"n",p)}t&&(u=Object(H.langStr)(Gt("purchases_stickers_gift_description_for_pack"),"title",t.title))}l.length?u+=" "+Gt("purchases_stickers_gift_description_styles"):u+=" "+Gt("purchases_stickers_gift_description");return[d,u]}(p),m=h[0],v=h[1],f=Object(Oe.useState)(null)[1];Object(Oe.useEffect)((function(){var e=c.getRecipients();if(f(window.WideDropdown.init("StickerProductsGiftRecipientsDropdown",{defaultItems:e,items:e,noResult:Gt("gifts_nobody_found"),introText:Gt("gifts_start_typing_recipient"),maxItems:20,onChange:function(e,t){1===e?c.addRecipientId(+t):c.removeRecipientId(+t)}})),u.length)for(var t=0,r=u;t<r.length;t++){var i=r[t],o=c.getRecipientById(i);o&&window.WideDropdown.select("StickerProductsGiftRecipientsDropdown",!1,o)}else window.WideDropdown.focus("StickerProductsGiftRecipientsDropdown");return function(){window.WideDropdown.deinit("StickerProductsGiftRecipientsDropdown")}}),[d]);var g=Object(Oe.useState)(""),y=g[0],b=g[1],w=Object(Oe.useState)(!1),k=w[0],S=w[1],j=Object(Oe.useState)(!1),E=j[0],O=j[1],C=function(){E||(O(!0),c.order({message:y,is_private:k,ref:i,gift_ref:o}).then((function(e){O(!1),e&&!e.error&&(Object(Pe.showDoneBox)(function(e,t){var r=new Z(e.items.filter((function(e){return!e.error})).map((function(e){return e.product}))),i=function(e){var t=e.getPack(),r=e.getStyles();if(t)return r.length?Object(H.langStr)(Gt("purchases_stickers_gift_result_products_pack_and_styles",r.length),"title",t.title,"styles_num",r.length):Object(H.langStr)(Gt("purchases_stickers_gift_result_products_pack"),"title",t.title);if(r.length)switch(r.length){case 1:return Object(H.langStr)(Gt("purchases_stickers_gift_result_products_1_style"),"title",r[0].title);case 2:return Object(H.langStr)(Gt("purchases_stickers_gift_result_products_2_styles"),"title1",r[0].title,"title2",r[1].title);case 3:return Object(H.langStr)(Gt("purchases_stickers_gift_result_products_3_styles"),"title1",r[0].title,"title2",r[1].title,"title3",r[2].title);case 4:return Object(H.langStr)(Gt("purchases_stickers_gift_result_products_3_styles_and_1_more"),"title1",r[0].title,"title2",r[1].title,"title3",r[2].title);default:var i=r.length-3;return Object(H.langStr)(Gt("purchases_stickers_gift_result_products_3_styles_and_n_more",i),"title1",r[0].title,"title2",r[1].title,"title3",r[2].title,"n",i)}return null}(r);if(!i)return null;for(var o=new Set,n=0,a=e.items;n<a.length;n++){var s=a[n],c=s.error,l=s.recipient_id;if(!c){var d=t(l);d&&o.add(d)}}var u=function(e,t){var r=Array.from(e.values());switch(r.length){case 0:return null;case 1:var i=1===t?"purchases_stickers_gift_result_1_recipient_single":"purchases_stickers_gift_result_1_recipient_multiple";return Object(H.langStr)(Object(H.langSex)(r[0][7],Gt(i,!0)),"name",r[0][8]);case 2:return Object(H.langStr)(Gt("purchases_stickers_gift_result_2_recipients",t),"name1",r[0][8],"name2",r[1][8]);case 3:return Object(H.langStr)(Gt("purchases_stickers_gift_result_3_recipients",t),"name1",r[0][8],"name2",r[1][8],"name3",r[2][8]);case 4:return Object(H.langStr)(Gt("purchases_stickers_gift_result_4_recipients",t),"name1",r[0][8],"name2",r[1][8],"name3",r[2][8],"name4",r[3][8]);case 5:return Object(H.langStr)(Gt("purchases_stickers_gift_result_5_recipients",t),"name1",r[0][8],"name2",r[1][8],"name3",r[2][8],"name4",r[3][8],"name5",r[4][8]);default:var o=r.length-4;i=1===t?"purchases_stickers_gift_result_4_recipients_and_n_more_single":"purchases_stickers_gift_result_4_recipients_and_n_more_multiple";return Object(H.langStr)(Gt(i),"name1",r[0][8],"name2",r[1][8],"name3",r[2][8],"name4",r[3][8],"n",o)}return null}(o,r.getCount());if(!u)return null;return Object(H.langStr)(u,"products",i)}(e,(function(e){return c.getRecipientById(e)}))),n())}),(function(){})))};return Object(Oe.useEffect)((function(){window.WideDropdown.disable("StickerProductsGiftRecipientsDropdown",E)}),[E]),Ce.a.createElement("article",{className:"StickerProductsGift"},Ce.a.createElement(Mt.ModalHeader,{className:"StickerProductsGift__header",title:Gt("purchases_stickers_gift_box_title"),appearance:"blue",onClose:n}),d?Ce.a.createElement("section",{className:"StickerProductsGift__content StickerProductsGift__content--loading"},Ce.a.createElement(Dt.default,{size:24})):Ce.a.createElement(Ce.a.Fragment,null,Ce.a.createElement("section",{className:"StickerProductsGift__content"},Ce.a.createElement(Ut,{order:p,forceValid:!_}),Ce.a.createElement("h1",{className:"StickerProductsGift__productsTitle"},m),Ce.a.createElement("p",{className:"StickerProductsGift__productsDescription"},v),p&&Ce.a.createElement(Ce.a.Fragment,null,Ce.a.createElement("dl",{className:"StickerProductsGift__price"},Ce.a.createElement("dt",{className:"StickerProductsGift__priceLabel"},Gt("purchases_gift_price_label"))," ",Ce.a.createElement("dd",{className:"StickerProductsGift__priceValue"},Gt("global_n_votes",p.price.current))),Ce.a.createElement("div",{className:"StickerProductsGift__balance"},Object(H.langStr)(Gt("gifts_you_have_X_votes"),"votes",Gt("global_n_votes",p.balance)))),Ce.a.createElement("div",{className:"StickerProductsGift__recipients"},Ce.a.createElement("label",{className:"StickerProductsGift__recipientsLabel",htmlFor:"StickerProductsGiftRecipientsInput"},Gt("gifts_receiver")),Ce.a.createElement("div",{className:"wdd StickerProductsGift__recipientsDropdown",id:"StickerProductsGiftRecipientsDropdown"},Ce.a.createElement("div",{className:"fl_r wdd_arr"}),Ce.a.createElement("input",{className:"wdd_text fl_l",id:"StickerProductsGiftRecipientsInput",placeholder:Gt("gifts_choose_recipients")}))),Ce.a.createElement("div",{className:"StickerProductsGift__message"},Ce.a.createElement("label",{className:"StickerProductsGift__messageLabel",htmlFor:"StickerProductsGiftMessageInput"},Gt("purchases_gift_your_message")),Ce.a.createElement(Ft.default,{className:"StickerProductsGift__messageInput",id:"StickerProductsGiftMessageInput",value:y,onChange:function(e){return b(e.currentTarget.value)},onResize:function(){return a()},style:{height:80},disabled:E})),Ce.a.createElement(Ht.default,{className:"StickerProductsGift__isPrivate",checked:k,disabled:E,onChange:function(){return S(!k)}},Gt("gifts_receiver_only"))),Ce.a.createElement("footer",{className:"StickerProductsGift__footer"},Ce.a.createElement("div",{className:"StickerProductsGift__footerNote"},!l&&p&&Ce.a.createElement("div",{className:"StickerProductsGift__details"},Gt("purchases_stickers_gift_details_label"),Ce.a.createElement(ft.default,{className:"StickerProductsGift__detailsTooltip",text:Ce.a.createElement(Wt,{order:p,recipients:c.getRecipientsMap()}),position:"t",align:"center",appearance:"light"},Ce.a.createElement(gt.default,{className:"StickerProductsGift__detailsHintIcon"})))),Ce.a.createElement("div",{className:"StickerProductsGift__footerButtons"},Ce.a.createElement(At,{className:"StickerProductsGift__gift",appearance:_?"primary":"secondary",size:"m",loading:l||E,disabled:!_,price:null==p?void 0:p.price,text:_?Object(H.langStr)(Gt("purchases_stickers_gift_send_for"),"price",Gt("global_n_votes",null==p?void 0:p.price.current)):Gt("purchases_stickers_gift_send"),onClick:function(){return C()}})))))},zt=function(){return(zt=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function Qt(e,t){var r;if(he().productsGiftLock)return null;me({productsGiftLock:!0});var i=zt({},t);function o(){return null==r?void 0:r.bodyNode.querySelector(".StickersProductsGift")}function n(){null==r||r.hide()}function a(){null==r||r.updateBoxCoords()}return Fe(),e.isGift=!0,Promise.all([e.load(!0),window.stManager.add(["stickers.css","wide_dd.js","wide_dd.css"])]).then((function(e){var t=e[0];e[1];He(),(r=new D.MessageBox({hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:450,onShow:function(){!function(e){var t=o();t&&Le.a.render(Ce.a.createElement(qt,{cart:e,options:i,closeBox:n,updateBox:a}),t)}(t),requestAnimationFrame((function(){a()}))},onHideAttempt:function(){var e;return(e=o())&&Le.a.unmountComponentAtNode(e),!0},onHide:function(){me({productsGiftLock:!1})}})).content('<div class="StickersProductsGift"></div>'),r.show()}),(function(){})),{hide:n}}function Xt(e,t,r){return void 0===t&&(t=[]),Qt(xe.create(e,t),r)}var Yt=Re.default.getLang;var $t=function(e){var t=e.pack,r=e.cart,i=e.options,o=i.recipientIds,n=void 0===o?[]:o,a=i.ref,s=i.gift_ref,c=e.closeBox,l=qe(t.id)[0];l&&(t=l);var d=Qe(t.style_ids||[]),u=d[0],p=d[1],_=Ye((function(){return r})),h=_[0],m=_[1],v=function(e){var t=ze(e.map((function(e){return e.product_id}))),r=t[0],i=t[1];return[Object(Oe.useMemo)((function(){return e.map((function(e,t){return Xe(Xe({},e),{product:r[t]})}))}),[e]),i]}(h.getItems())[0],f=h.getProducts(),g=h.getOrder(),y=ve(t.sticker_ids[0]),b=function(e){if(!e)return null;for(var t=[],r=[],i=0,o=e.items;i<o.length;i++){var n=o[i],a=n.product,s=n.error;a&&!s&&(Q(a)?t.push(n):z(a)&&r.push(n))}var c=r.reduce((function(e,t){var r;return e+((null===(r=t.price)||void 0===r?void 0:r.current)||0)}),0);if(t.length){var l=t.reduce((function(e,t){var r;return e+((null===(r=t.price)||void 0===r?void 0:r.current)||0)}),0);return l?r.length?c?Object(H.langStr)(Yt("purchases_stickers_order_summary_pack_for_styles_for",r.length),"pack_price",Yt("global_n_votes",l),"styles_num",r.length,"styles_price_sum",c):Object(H.langStr)(Yt("purchases_stickers_order_summary_pack_for_styles_free",r.length),"pack_price",Yt("global_n_votes",l),"styles_num",r.length):Object(H.langStr)(Yt("purchases_stickers_order_summary_pack_for"),"pack_price",Yt("global_n_votes",l)):r.length?c?Object(H.langStr)(Yt("purchases_stickers_order_summary_pack_free_styles_for",r.length),"styles_num",r.length,"styles_price_sum",Yt("global_n_votes",c)):Object(H.langStr)(Yt("purchases_stickers_order_summary_pack_free_styles_free",r.length),"styles_num",r.length):Object(H.langStr)(Yt("purchases_stickers_order_summary_pack_free"))}if(r.length)return c?Object(H.langStr)(Yt("purchases_stickers_order_summary_styles_for",r.length),"styles_num",r.length,"styles_price_sum",Yt("global_n_votes",c)):Object(H.langStr)(Yt("purchases_stickers_order_summary_styles_free",r.length),"styles_num",r.length);return null}(g),w=!m&&g&&!g.error,k=Object(Oe.useState)(!1),S=k[0],j=k[1],E=null;if(g)if(g.error){if(g.error===$.NOT_SIGNED_IN){E=Ce.a.createElement(We.default,{className:"StickerPackPreview__purchase",size:"m",loading:m,onClick:function(){Object(Pe.showDoneBox)(Yt("purchases_please_sign_in").replace(/\{link\}(.*?)\{\/link\}/,"<a href=\"/join\" onclick=\"return !showBox('join.php', { act: 'box', from: nav.strLoc }, {}, event)\">$1</a>"))}},Yt("purchases_stickers_get_pack_btn"))}else if(g.error===$.NO_VALID_ITEMS){if(1===g.items.length){var O=g.items[0],C=O.product,T=O.error;if(C&&T!==J.DUPLICATE_PRODUCT&&C.purchase_details){var L=C.purchase_details,I=L.label,N=L.title,B=L.text,x=L.button_title,R=L.button_url;E=Ce.a.createElement(We.default,{className:"StickerPackPreview__purchase",size:"m",appearance:"primary",loading:m,onClick:function(){Object(D.showFastBox)(N||Yt("purchases_stickers_catalog_purchase_details_title"),B,R&&x||null,R?function(){window.location.href=R}:null)}},I||Yt("purchases_stickers_product_unavailable"))}}if(!E){var P=!g.items.find((function(e){return e.error!==J.DUPLICATE_PRODUCT}));E=Ce.a.createElement(We.default,{className:"StickerPackPreview__purchase",size:"m",appearance:"secondary",loading:m,disabled:!0},Yt(P?"purchases_stickers_product_purchased":"purchases_stickers_product_unavailable"))}}}else{var A=m||S;E=Ce.a.createElement(At,{className:"StickerPackPreview__purchase",size:"m",loading:A,disabled:A,price:g.price,text:g.price.current?Yt("purchases_stickers_buy_for"):Yt("purchases_stickers_get_for_free"),onClick:function(){S||(j(!0),h.order({ref:a,gift_ref:s}).then((function(e){j(!1),e&&!e.error&&Object(Pe.showDoneBox)(Ve(e))}),(function(){})))}})}var M=!m&&void 0!==f.find((function(e){return null==e?void 0:e.can_gift})),F=v.reduce((function(e,t){return t.product&&t.product.copyright&&e.add(t.product.copyright),e}),new Set);return Ce.a.createElement("article",{className:"StickerPackPreview"},Ce.a.createElement("header",{className:"StickerPackPreview__header"},Ce.a.createElement("a",{className:"StickerPackPreview__close",onClick:c}),y&&Ce.a.createElement(mt,{className:"StickerPackPreview__icon",sticker:y,width:128,height:128}),Ce.a.createElement("div",{className:"StickerPackPreview__info"},Ce.a.createElement(Ue.default,{element:"h1",className:"StickerPackPreview__title"},t.title),Ce.a.createElement(Ue.default,{element:"div",className:"StickerPackPreview__author"},t.author),Ce.a.createElement(Ue.default,{element:"div",className:"StickerPackPreview__description"},t.description))),u.length>0&&Ce.a.createElement(Tt,{className:"StickerPackPreview__styles",styles:u,isLoading:p,isAdded:function(e){return h.hasProduct(e.id)},add:function(e){return h.addProduct(e.id)},remove:function(e){return h.removeProduct(e.id)},gift:function(e){Xt([e.id],n)}}),Ce.a.createElement("div",{className:"StickerPackPreview__footerContainer"},Ce.a.createElement("section",{className:"StickerPackPreview__items"},v.map((function(e){return Ce.a.createElement(Nt,{item:e,showHeader:u.length>0,remove:e.product&&z(e.product)?function(){return h.removeProduct(e.product_id)}:void 0,key:e.product_id})}))),F.size>0&&Ce.a.createElement("section",{className:"StickerPackPreview__copyrights"},Array.from(F).map((function(e,t){return Ce.a.createElement("div",{key:t,className:"StickerPackPreview__copyright"},e)}))),Ce.a.createElement("footer",{className:"StickerPackPreview__footer"},!m&&(w||M)&&Ce.a.createElement("div",{className:"StickerPackPreview__footerNote"},b),Ce.a.createElement("div",{className:"StickerPackPreview__footerButtons"},M&&Ce.a.createElement(Ke.default,{className:"StickerPackPreview__gift",appearance:"primary",size:"m",onClick:function(){return(e=h.copy()).setRecipientIds(n),void Qt(e);var e}},Yt("purchases_stickers_gift")),E))))},Jt=function(){return(Jt=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},Zt=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],a=0,s=n.length;a<s;a++,o++)i[o]=n[a];return i},er=Re.default.getLang,tr=function(e){var t=e.pack,r=e.options,i=e.closeBox,o=e.updateBox,n=qe(t.id),a=n[0],s=n[1];a&&(t=a);var c=Qe(t.style_ids||[]),l=c[0],d=c[1],u=s||d;Object(Oe.useEffect)((function(){o()}),[u]);var p=Jt(Jt({},t),{base_id:t.id,title:er("purchases_stickers_product_preview_title_base_pack"),style_sticker_ids:t.sticker_ids}),_=Zt([p],l),h=_.find((function(e){return e&&e.is_active}))||p,m=Object(Oe.useState)(),v=m[0],f=m[1],g=v&&_.find((function(e){return e&&e.id===v})),y=function(e){f(e&&e.id)},b=g||h,w=b===p?er("purchases_stickers_product_preview_title_base_pack"):Object(H.langStr)(er("purchases_stickers_product_preview_title_style"),"title",b.title);Object(Oe.useEffect)((function(){b.is_new&&Ee(b.id,U.IsNew,0).finally((function(){}))}),[b,b.is_new]);var k=Object(Oe.useState)(!1),S=k[0],j=k[1],E=Object(Oe.useState)(!1),O=E[0],C=E[1],T=function(e){O||(C(!0),function(e){return new Promise((function(t){ue.ajax.post("stickers.php",{act:"activate_product",product_id:e.id,hash:e.csrf_hash},{onDone:function(e){be(e),t()},onFail:function(e){return console.error(e),t(),!0}})}))}(e).then((function(){C(!1),y(void 0)}),(function(){})))};return Ce.a.createElement("article",{className:"StickerPackSettings"},Ce.a.createElement(Mt.ModalHeader,{className:"StickerPackSettings__header",title:t?Object(H.langStr)(er("purchases_stickers_style_selection_for_pack"),"title",t.title):"",appearance:"blue",onClose:i}),u?Ce.a.createElement("section",{className:"StickerPackSettings__content StickerPackSettings__content--loading"},Ce.a.createElement(Dt.default,{size:24})):Ce.a.createElement(Ce.a.Fragment,null,_.length>0&&Ce.a.createElement(Tt,{className:"StickerPackSettings__styles",styles:_,isLoading:d,activeStyle:h,selectedStyle:b,select:function(e){return y(e)}}),Ce.a.createElement("div",{className:"StickerPackSettings__footerContainer"},Ce.a.createElement("section",{className:"StickerPackSettings__stylePreview"},Ce.a.createElement(Ue.default,{element:"h2",className:"StickerPackSettings__stylePreviewTitle"},w),Ce.a.createElement(Lt,{product:b})),Ce.a.createElement("footer",{className:"StickerPackSettings__footer"},Ce.a.createElement("div",{className:"StickerPackSettings__footerButtons"},b.can_gift&&Ce.a.createElement(Ke.default,{className:"StickerPackSettings__gift",appearance:"secondary",size:"m",onClick:function(){Xt([b.id],r.recipientIds||[])}}),b.is_purchased?Ce.a.createElement(We.default,{className:"StickerPackSettings__activate",appearance:"primary",size:"m",disabled:b===h,loading:O,onClick:function(){return T(b)}},er("purchases_stickers_product_settings_save")):Ce.a.createElement(At,{className:"StickerPackSettings__buy",appearance:"primary",size:"m",price:b.price.purchase,text:er(b.price.purchase.current?"purchases_stickers_buy_for":"purchases_stickers_get_for_free"),loading:S,onClick:function(){return e=b,void(S||(j(!0),xe.create([e.id]).order().then((function(){j(!1)}),(function(){}))));var e}}))))))},rr=Re.default.getLang,ir=function(e){var t=e.style,r=e.options.add,i=e.closeBox;return Ce.a.createElement("article",{className:"StickerStylePreview"},Ce.a.createElement(Mt.ModalHeader,{className:"StickerStylePreview__header",title:Object(H.langStr)(rr("purchases_stickers_stickers_of_style"),"title",t.title),onClose:i}),Ce.a.createElement(Lt,{className:"StickerStylePreview__content",product:t}),Ce.a.createElement("footer",{className:"StickerStylePreview__footer"},Ce.a.createElement(Ke.default,{className:"StickerStylePreview__cancel",appearance:"tertiary",size:"m",onClick:i},rr("global_cancel")),r&&Ce.a.createElement(Ke.default,{className:"StickerStylePreview__add",appearance:"primary",size:"m",onClick:function(){return r(t)}},rr("purchases_stickers_preview_add_item"))))},or=function(){return(or=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},nr=new Map;function ar(e,t){Fe(),function(e){var t=fe(e);return t?Promise.resolve(t):new Promise((function(t){ue.ajax.post("stickers.php",{act:"get_products",sticker_ids:[e]},{onDone:function(r){be(r),t(fe(e))},onFail:function(e){return console.error(e),t(null),!0}})}))}(e).then((function(e){e?sr(e.id,t):He()}),(function(){}))}function sr(e,t){var r,i=or({},t);function o(){return null==r?void 0:r.bodyNode.querySelector(".StickersProductPreviewBox")}function n(){null==r||r.hide(),window.nav.objLoc[0].match(/^stickers\/(.*?)$/)&&window.nav.setLoc({0:"stickers"})}function a(){null==r||r.updateBoxCoords()}Fe();var s=xe.create([e]);return Promise.all([s.load(),window.stManager.add(["stickers.css"])]).then((function(t){var s=t[0];t[1];He();var c=we(e);c&&!c.is_disabled?((r=new D.MessageBox({hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:640,onShow:function(){!function e(t,r){var s=null,c=null;if(Q(t))s=t.is_purchased&&(null==i?void 0:i.settings)?Ce.a.createElement(tr,{pack:t,options:i,closeBox:n,updateBox:a}):Ce.a.createElement($t,{pack:t,cart:r,options:i,closeBox:n,updateBox:a}),c=t.name;else if(z(t)){var l=we(t.base_id);if(l)return r.addProduct(l.id,!0),void e(l,r);s=Ce.a.createElement(ir,{style:t,options:i,closeBox:n,updateBox:a}),c=t.name}var d=o();if(d&&s&&(Le.a.render(s,d),c)){var u=window.nav.objLoc[0].split("/");"stickers"===u[0]&&u[1]!==c&&window.nav.setLoc({0:"stickers/"+c})}}(c,s),requestAnimationFrame((function(){a(),function(){if(nr.has(e)){var t=De();t&&(t.scrollTop=nr.get(e)||0),nr.delete(e)}}()}))},onBeforeHide:function(){!function(){var t=De();t&&nr.set(e,t.scrollTop)}()},onHideAttempt:function(){var e;return(e=o())&&Le.a.unmountComponentAtNode(e),!0}})).content('<div class="StickersProductPreviewBox"></div>'),r.show()):Object(D.showFastBox)(Object(H.getLang)("global_box_error_title"),Object(H.getLang)("purchases_stickers_product_not_found"))}),(function(){})),{hide:n}}function cr(){return(cr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}function lr(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=ur(e))){var t=0,r=function(){};return{s:r,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o,n=!0,a=!1;return{s:function(){i=e[Symbol.iterator]()},n:function(){var e=i.next();return n=e.done,e},e:function(e){a=!0,o=e},f:function(){try{n||null==i.return||i.return()}finally{if(a)throw o}}}}function dr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(e,t)||ur(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ur(e,t){if(e){if("string"==typeof e)return pr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(r):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?pr(e,t):void 0}}function pr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function _r(){return Object(l.partConfigEnabled)("stickers_web_new_ui")}var hr={opts:{},raw:{},last:0,shownId:!1,hasNewStickers:!1,preventMouseOver:!1,stickerPacksToLoad:[],ttShift:45,favoriteAvailable:!1,favoriteRemindOn:!1,favoriteRemindOff:!1,favoriteLimit:20,favoriteLimitNoticed:!1,stickerSizes:{},stickers:{},TAB_EMOJI:0,TAB_RECENT_STICKERS:-1,TAB_FAVORITE_STICKERS:-2,CLICK_DELAY:500,SORTED_EMOJI_SECTIONS_CODES:[-1,1,3,8,2,4,5,6,7,9],CACHED_HEIGHT_PROP:"_emojiHeight",CACHED_WIDTH_PROP:"_emojiWidth",BOTTOM_REST_FOR_ADD_EMOJI_CATEGORY:150,SHOW_TT_TIMEOUT:100,HIDE_TT_TIMEOUT:300,SHOWN_TT_CLS:"emoji_tt_shown",STICKER_REFERRERS:{RECENT:"recent",FAVORITE:"favourite",KEYBOARD:"keyboard",STORY_KEYBOARD:"story_keyboard"},DELETE_FAV_STICKER_ELEMENTS_DELAY:500,FAV_ICON_TT_MIN_HEIGHT:35,SUGGESTION_WORD_MAX_LENGTH:256,logHintsDelay:0,tabDefaultId:0,stickersKeywordsExpire:36e5*(6+2*Math.random()),init:function(e,t){var r=hr.last;hr.tabDefaultId=hr.TAB_RECENT_STICKERS,t.txt=e,t.id=r,t.fieldWrap=gpeByClass("_emoji_field_wrap",e),t.emojiWrap=domByClass(t.fieldWrap,"_emoji_wrap"),t.emojiBtn=domByClass(t.emojiWrap,"_emoji_btn"),t.emojiWrap&&Object(u.data)(t.emojiWrap,"optId",r),e.emojiId=r,t.lastLoadedEmojiCategoriesIdxes={},t.preventDoubleClick=vkNow(),t.deletedFavoriteStickers=[],t.deleteFavoriteStickersTimeout=null,t.suggestions=new P(t.suggestionsConfig);var i=Object(d.isRetina)()?128:64;if(hr.stickerSizes[i]=!0,t.forceTxt)t.editable=0,placeholderInit(e);else{if(t.editable=1,setTimeout((function(){placeholderInit(e,{editable:1,editableFocus:hr.editableFocus,global:t.global}),t.shouldFocus&&hr.editableFocus(e,!1,!0)}),0),browser.mozilla)try{document.execCommand("enableObjectResizing",!1,!1),cur.destroy.push((function(){document.execCommand("enableObjectResizing",!1,!0)}))}catch(e){}addEvent(window,"mousemove",hr.preventMouseOverHandle),addEvent(e,browser.opera&&!browser.chrome?"click":"mousedown",(function(i){if(i.target&&"IMG"==i.target.tagName&&hr.getCode(i.target))return hr.editableFocus(e,i.target,i.offsetX>8),cancelEvent(i);hr.shown&&hr.ttClick(r,geByClass1("emoji_smile",t.controlsCont),!0)})),t.noLineBreaks&&addEvent(e,"blur",(function(t){e.textContent||e.innerText||each(geByTag("br",e),(function(e,t){re(t)}))})),addEvent(e,"keypress keydown keyup input paste",(function(i){if(i.canceled)return!1;if("keydown"===i.type){t.onChange&&(hr.raw[r]=e.innerHTML);var o=t.ctrlSend?t.ctrlSend():t.noEnterSend;if(i.keyCode==KEY.RETURN||10==i.keyCode){if(t.forceEnterSend&&t.onSend)return t.onSend(),cancelEvent(i);var n=cur.ctrl_submit&&!t.noCtrlSend;if((n||o)&&(i.ctrlKey||browser.mac&&i.metaKey)||!n&&!i.shiftKey&&!(i.ctrlKey||browser.mac&&i.metaKey)){var a=Object(u.data)(e,"composer");if(!hr.emojiEnter(r,i)||!hr.stickerHintMove(i)||a&&a.wdd&&isVisible(a.wdd.listWrap))return!1;if(!o||i.ctrlKey||browser.mac&&i.metaKey)return hr.ttClick(r,geByClass1("emoji_smile",t.controlsCont),!0),t.onSend&&t.onSend(),cancelEvent(i)}if(t.noLineBreaks)return cancelEvent(i)}if(i.ctrlKey&&i.keyCode==KEY.RETURN){var s=this.value;if(t.editable)hr.insertHTML("<div><br/></div>");else{if("number"==typeof this.selectionStart&&"number"==typeof this.selectionEnd){var c=this.selectionStart;this.value=s.slice(0,c)+"\n"+s.slice(this.selectionEnd),this.selectionStart=this.selectionEnd=c+1}else if(document.selection&&document.selection.createRange){this.focus();var d=document.selection.createRange();d.text="\r\n",d.collapse(!1),browser.opera&&!browser.chrome&&(d.moveEnd("character",0),d.moveStart("character",0)),d.select()}e.autosize.update(),setTimeout((function(){e.autosize.update()}),0)}return!1}var p=Object(A.hasAccessibilityMode)()&&Object(l.partConfigEnabled)("emoji_tooltip_a11y_mode");if(i.keyCode===KEY.TAB&&!(i.ctrlKey||browser.mac&&i.metaKey)&&!p){var _=geByClass1("_sticker_hints",domPN(t.txt));if(_&&isVisible(_)){var h=geByClass1("over",_);if(h?hr.stickerHintKeyOut(r,h):hr.stickerHintKeyOver(r,geByClass1("emoji_sticker_item",_)),!hr.shown)return cancelEvent(i)}return hr.shown?(hr.editableFocus(e,!1,!0,void 0,!0),hr.ttClick(r,geByClass1("emoji_smile",t.controlsCont),!0)):hr.ttClick(r,geByClass1("emoji_smile",t.controlsCont),!1,!0,void 0,!0),cancelEvent(i)}if(i.keyCode==KEY.ESC){var m=geByClass1("_sticker_hints",domPN(t.txt)),v=!1;if(m&&isVisible(m)&&(hr.stickerHintKeyOut(r,geByClass1("emoji_sticker_item",m)),hr.stickersHintsHide(m,t,100),v=!0),hr.shown&&(hr.editableFocus(e,!1,!0,void 0,!0),hr.ttClick(r,geByClass1("emoji_smile",t.controlsCont),!0),v=!0),v)return cancelEvent(i);if(t.onEsc)return t.onEsc(i)}}return"paste"===i.type?(hr.onEditablePaste(e,t,r,i),t.checkEditable&&setTimeout(t.checkEditable.pbind(r,e),0),hr.checkStickersKeywords(r,t)):"keyup"===i.type?(!t.noLineBreaks||e.textContent||e.innerText||each(geByTag("br",e),(function(e,t){re(t)})),t.checkEditable&&t.checkEditable(r,e),hr.checkStickersKeywords(r,t),t.onChange&&(hr.raw[r]!=e.innerHTML&&hr.onChange(t),delete hr.raw[r])):"keydown"!==i.type&&"input"!==i.type||(t.checkEditable&&setTimeout(t.checkEditable.pbind(r,e),0),hr.checkStickersKeywords(r,t)),t.onKeyAction&&t.onKeyAction(i),cur.onReplyFormSizeUpdate&&cur.onReplyFormSizeUpdate(i),!0}))}return window.Notifier&&Notifier.addRecvClbk("emoji",0,hr.lcRecv,!0),hr.initStickersKeywords(),hr.initPromotedStickerUrls(),hr.checkNewStickers(t),hr.opts[hr.last]=t,hr.last++},setSuggestionsConfig:function(e,t){hr.opts[e].suggestions.setConfig(t)},onChange:function(e){Object(j.isFunction)(e.onChange)&&setTimeout(e.onChange,0)},preventMouseOverHandle:function(){hr.preventMouseOver=!1},lcRecv:function(e){switch(e.act){case"updateTabs":hr.updateTabs(e.newStickers,e.keywords)}},correctCaret:function(e){var t=e?function(e){var t=e.getBoundingClientRect(),r=null,i=null;if(t.top===t.bottom)return{left:0,top:0,bottom:0};if(document.selection)(r=(i=document.selection.createRange()).getClientRects()||[]).length||(i.text="_",i.moveStart("character",-1),r=i.getClientRects(),i.text=""),r=r[r.length-1];else if(window.getSelection){var o=getSelection();if(o.anchorNode){if((i=o.getRangeAt(0)).collapsed){var n=i.startOffset;i.setStart(i.startContainer,0),r=i.getClientRects(),i.setStart(i.startContainer,n)}r=r&&r.length?r[r.length-1]:{right:t.left,top:t.top,bottom:t.top}}else r={right:0,top:0,bottom:0}}return{left:r.right-t.left,top:r.top-t.top,bottom:r.bottom-t.top}}(e).bottom:0;(t<0||t>e.offsetHeight)&&(e.scrollTop+=t-e.offsetHeight)},insertWithBr:function(e,t){if(t){var r=t.replace(/\n/g,"<br/>"),i=ce("div",{innerHTML:r});hr.cleanCont(i),hr.insertHTML(i.innerHTML)}},insertWithoutNL:function(e,t){if(t){var r=t.replace(/\n/g,""),i=ce("div",{innerHTML:r});hr.cleanCont(i),hr.insertHTML(i.innerHTML)}},focusTrick:function(e,t,r,i,o){o||(o=e);var n=ce("TEXTAREA",{className:"emoji_tmp_textarea"});e.parentNode.appendChild(n),n.focus(),setTimeout((function(){var a=o.scrollTop;re(n),e.focus(),o.scrollTop=a,hr.setRange(i),t(clean(val(n))),r(e)}),0)},finalizeInsert:function(e){hr.cleanCont(e),setTimeout(hr.correctCaret.pbind(e),10)},getClipboard:function(e){return e.clipboardData?clean(e.clipboardData.getData("text")):!!window.clipboardData&&clean(window.clipboardData.getData("Text"))},processImagePaste:function(e,t,r,i){if(null!=e.clipboardData){var o=function(){var o=e.clipboardData;function n(e){if(!e.match(/^webkit\-fake\-url\:\/\//)){var o=new Image;return o.crossOrigin="anonymous",o.onload=function(){var e=document.createElement("canvas");e.width=o.width,e.height=o.height,e.getContext("2d").drawImage(o,0,0,e.width,e.height),e.toBlob((function(e){!function(e){var i,o;if(e.name=e.filename="upload_"+(new Date).toISOString()+"_"+irand(0,100)+".png",hasClass(t,"_im_text")){if(r.uploadActions)return void r.uploadActions.paste([e])}else i="post_field"==t.id?cur.wallAddMedia:(o=Object(u.data)(t,"composer"))&&o.addMedia;i&&Object(j.isFunction)(r.initUploadForImagePasteCallback)&&r.initUploadForImagePasteCallback(t,i,e)}(e)}),"image/png"),i(!0)},o.src=e}}if(o.items){for(var a=!1,s=0,c=o.items.length;s<c;s++){var l=o.items[s];if(l.type.match(/^image\//)){var d=new FileReader;d.onload=function(e){return n(e.target.result)},d.readAsDataURL(l.getAsFile()),a=!0}else if("text/plain"===l.type)return{v:i()}}return{v:a}}if(-1!==Array.prototype.indexOf.call(o.types,"text/plain"))return{v:i()};!function(e){for(var r=Math.floor(1e3*Math.random()),o=geByTag("img",t),n=0,a=o.length;n<a;n++){o[n]["_before_paste_"+r]=!0}setTimeout((function(){for(var o=geByTag("img",t),n=!1,a=0,s=o.length;a<s;a++){var c=o[a];c["_before_paste_"+r]||(e(c.src),re(c),n=!0)}n||i()}),1)}((function(e){return n(e)}))}();if("object"==typeof o)return o.v}else i()},detectInvalidClipboardData(e){if(!e.clipboardData)return!1;var t=e.clipboardData.types;if(t.includes("text/html")){if(t.includes("Files"))return!0;var r=e.clipboardData.getData("text/html");return r&&r.match(/<iframe/i)}return!1},onEditablePaste:function(e,t,r,i,o){var n=!1;"true"===e.getAttribute("contenteditable")&&(n=hr.getRange());var a=this.getClipboard(i),s=a&&n&&!o;this.detectInvalidClipboardData(i)&&cancelEvent(i),(this.processImagePaste(i,e,t,function(r){r||(s?(t.noLineBreaks?this.insertWithoutNL(n,a):this.insertWithBr(n,a),setTimeout(this.finalizeInsert.bind(this,e),0)):n&&this.focusTrick(e,t.noLineBreaks?this.insertWithoutNL.pbind(n):this.insertWithBr.pbind(n),this.finalizeInsert.bind(this,e),n))}.bind(this))||s)&&cancelEvent(i),hr.onChange(t)},cleanCont:function(e){for(var t=e.firstChild;t;){var r=t.nextSibling;switch(t.nodeType){case 1:if("tmp_paste_cont"==t.id)break;if("DIV"==t.tagName||"P"==t.tagName||"SPAN"==t.tagName)t.setAttribute("style",""),t.className="",t.id="",hr.cleanCont(t);else if("IMG"==t.tagName)hr.getCode(t)||re(t);else if("BR"!=t.tagName){var o=hr.editableVal(t,{saveEmoji:!0}),a=cf(clean(o).replace(/\n/g,"<br/>"));t.parentNode.replaceChild(a,t)}break;case 3:var s=clean(t.textContent||t.innerText),c=Object(i.emojiRegex)();s&&s.match(c)&&(s=s.replace(c,n.emojiReplace),t.parentNode.replaceChild(cf(s),t))}t=r}},focus:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];hr.editableFocus(e,!1,!0);var i=r||e.parentNode;if(t){var o=getXY(i)[1],n=scrollGetY(),a=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:boxLayerBG.offsetHeight,s=getSize(i)[1];n+a<o+s?scrollToY(o-a+s+60,100):n>o&&scrollToY(o-60,100)}},destroy:function(e){if(hr.opts.hasOwnProperty(e)){var t=hr.opts[e];t.txt&&t.txt.blur(),t.imagesLoader&&t.imagesLoader.destroy(),e===hr.shownId&&(hr.shownId=!1,hr.shown=!1),delete hr.opts[e]}},editableFocus:function(e,t,r,i,o){if(!e||o&&document.activeElement===e)return!1;if((e=ge(e)).focus(),e.phonfocus&&e.phonfocus(),void 0!==window.getSelection&&void 0!==document.createRange){var n=window.getSelection();if(!browser.opera||browser.chrome||r){var a=document.createRange();t?a.selectNode(t):a.selectNodeContents(e),browser.mozilla&&e.innerHTML.endsWith("<br>")&&e.removeChild(e.lastChild),i||a.collapse(!r),(n=window.getSelection()).removeAllRanges(),n.addRange(a)}else n.collapse(t||e,0)}else if(void 0!==document.body.createTextRange){var s=document.body.createTextRange();s.moveToElementText(t||e),s.collapse(!r),s.select()}},getRange:function(){if(window.getSelection){var e=window.getSelection();if(e.getRangeAt&&e.rangeCount)return e.getRangeAt(0)}else if(document.selection&&document.selection.createRange)return document.selection.createRange();return null},setRange:function(e){if(window.getSelection){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else document.selection&&e.select&&e.select()},val:function(e,t){if(void 0===t)return hr.editableVal(e);t=(t=Object(n.emojiToHTML)(t,!0)).replace(/ $/,"&nbsp;"),e.setValue?(e.setValue(t),e.phonblur&&e.phonblur()):e.innerHTML=t,hr.updateStickersHints();var r=Object(u.data)(e,"composer");return r&&window.Composer&&setTimeout(Composer.updateAutoComplete.pbind(r)),!0},editableVal:function(e,t){if(!e)return"";if("TEXTAREA"==e.tagName)return val(e);for(var r,i=e.firstChild,o="",n=new RegExp("^(DIV|P|LI|OL|TR|TD|BLOCKQUOTE)$");i;){switch(i.nodeType){case 3:o+=r=i.data.replace(/^\n|\n$/g," ").replace(/[\n\xa0]/g," ").replace(/[ ]+/g," ");break;case 1:if(r=hr.editableVal(i),i.tagName&&i.tagName.match(n)&&r){"\n"!=r.substr(-1)&&(r+="\n");for(var a=i.previousSibling;a&&3==a.nodeType&&""==trim(a.nodeValue);)a=a.previousSibling;!a||a.tagName&&(a.tagName.match(n)||"BR"==a.tagName)||(r="\n"+r)}else if("IMG"==i.tagName){var s=hr.getCode(i);s&&(t&&t.saveEmoji?r+=hr.getEmojiHTML(s):r+=hr.codeToChr(s))}else"BR"==i.tagName&&(r+="\n");o+=r}i=i.nextSibling}return o},cssEmoji:i.EMOJI_HINTS,getEmojiHTML:n.getEmojiHTML,codeToChr:o.emojiByteHexToSymbol,checkEditable:function(e,t,r){var i=t.scrollHeight,o=hr.opts[e];if(!o)return!1;o.scPaddings||(o.scPaddings=intval(getStyle(t,"paddingTop"))+intval(getStyle(t,"paddingBottom"))),i-=o.scPaddings;var n=o.tt;if(i>r.height+(browser.mozilla&&o.isChat?0:5)){if(!o.isSized){setStyle(t,{height:r.height+"px",overflowY:"auto"});var a=geByClass1("emoji_smile",o.controlsCont),s=geByClass1("emoji_smile_icon_promo",o.controlsCont),c=ge("im_upload"),l=Object(M.sbWidth)();o.ttWrap&&(l+=getSize(o.ttWrap)[0]-(getXY(o.emojiBtn)[0]-getXY(o.ttWrap)[0])),setStyle(a,vk.rtl?{left:1+l}:{right:1+l}),s&&setStyle(s,vk.rtl?{left:2+l}:{right:2+l}),c&&setStyle(c.parentNode,vk.rtl?{left:1+l}:{right:1+l}),n&&setStyle(n,vk.rtl?{left:(o.ttDiff||31)+l}:{right:(o.ttDiff||31)+l}),o.isSized=!0}}else if(o.isSized){setStyle(t,{height:"auto",overflowY:"hidden"});var d=geByClass1("emoji_smile",o.controlsCont),u=geByClass1("emoji_smile_icon_promo",o.controlsCont),p=ge("im_upload");setStyle(d,vk.rtl?{left:1}:{right:1}),u&&setStyle(u,vk.rtl?{left:2}:{right:2}),p&&setStyle(p.parentNode,vk.rtl?{left:1}:{right:1}),n&&setStyle(n,vk.rtl?{left:o.ttDiff||31}:{right:o.ttDiff||31}),o.isSized=!1}o.onResize&&o.onResize()},stickersHintsShow:function(e,t,r){(isVisible(e)||fadeIn(e,r),t.stickerEventsInited)||((e&&geByClass1("_sticker_hints_inner",e)).addEventListener("wheel",hr.onWheelStickersHints),addEvent(document,"keydown",hr.stickerHintMove),t.onHintsMouseDown=function(){t.hintsClicked=!0,setTimeout((function(){delete t.hintsClicked}),0)},addEvent(e,"mousedown",t.onHintsMouseDown),t.txt&&(t.onTxtFocus&&(removeEvent(t.txt,"focus",t.onTxtFocus),delete t.onTxtFocus),t.onTxtBlur=function(i){if(t.hintsClicked)return cancelEvent(i),!0;hr.stickersHintsHide(e,t,r)},addEvent(t.txt,"blur",t.onTxtBlur)),t.stickerEventsInited=!0);hr.checkStickersHintsSize(e,t)},stickersHintsHide:function(e,t,r){(fadeOut(e,r),removeEvent(document,"keydown",hr.stickerHintMove),t.onHintsMouseDown&&removeEvent(e,"mousedown",hr.onHintsMouseDown),t.onHintsWheel)&&(e&&geByClass1("_sticker_hints_inner",e)).removeEventListener("wheel",hr.onWheelStickersHints);t.txt&&(t.onTxtBlur&&(removeEvent(t.txt,"blur",t.onTxtBlur),delete t.onTxtBlur),t.onTxtFocus&&removeEvent(t.txt,"focus",t.onTxtFocus),t.onTxtFocus=function(){var e=t.txt&&geByClass1("_sticker_hints",domPN(t.txt));e&&!isVisible(e)&&(delete t.stickerHintsString,hr.checkStickersKeywords(t.id,t,!1))},addEvent(t.txt,"focus",t.onTxtFocus)),delete t.stickerEventsInited,delete hr.shownHintId,hr.sendHintsLog()},stickerHintOver:function(e){hr.stickerHintOut(e),addClass(e,"over")},stickerHintOut:function(e){each(geByClass("over",domPN(e)),(function(){removeClass(this,"over")}))},stickerHintClick:function(e,t,r,i){var o=hr.opts[e]||{},n=o.txt,a=n&&geByClass1("_sticker_hints",domPN(n)),s="suggestion_"+hr.stickerSuggestionQuery;return"stories"===o.ref&&(s="story_suggestion_"+hr.stickerSuggestionQuery),t<0?hr.previewSticker(!1,i,{stickerId:-t,sticker_referrer:s}):(val(n,""),hr.stickerClick(e,t,256,r,i,s),o.checkEditable&&o.checkEditable(e,n)),hr.stickersHintsHide(a,o,0),!1},stickerHintKeyOver:function(e,t){hr.stickerHintOver(t),hr.shownHintId=e},stickerHintKeyOut:function(e,t){hr.stickerHintOut(t),delete hr.shownHintId},stickerHintMove:function(e){var t=hr.shownHintId;if(void 0===t)return!0;var r=hr.opts[t],i=r&&geByClass1("_sticker_hints",domPN(r.txt));if(i&&isVisible(i)){var o=geByClass1("over",i)||geByClass1("emoji_sticker_item",i);switch(e.keyCode){case KEY.LEFT:return(o=domPS(o))&&(hr.stickerHintOver(o),hr.checkStickersHintsScroll(o)),cancelEvent(e),!1;case KEY.RIGHT:return(o=domNS(o))&&(hr.stickerHintOver(o),hr.checkStickersHintsScroll(o)),cancelEvent(e),!1;case KEY.ENTER:return o.click(),cancelEvent(e),!1}}return!0},checkStickersHintsSize:function(e,t,r){r&&(addClass(e,"_margin_transition"),Object(u.removeClassDelayed)(e,"_margin_transition")),setStyle(e,{marginLeft:0});var i=getXY(e),o=getSize(e),n=hr.getEmojiTtXY(t.tt);t.tt&&n&&n[0]&&i[0]+o[0]+10>n[0]&&i[1]+o[1]>n[1]&&setStyle(e,{marginLeft:n[0]-i[0]-o[0]-10}),domFC(e)||hr.stickersHintsHide(e,t,0)},getEmojiTtXY:function(e){return e&&hasClass(e,hr.SHOWN_TT_CLS)?getXY(e):[0,0]},hintachCache:{},hintachNotFoundStickers:{},checkHintach:function(e,t,r){if(Object(l.partConfigEnabled)("hintach"))return hr.hintachCache[e]?requestAnimationFrame(()=>hr.renderHintach(e,t,r,hr.hintachCache[e])):void ajax.post("/hintach",{query:e},{onDone:i=>{hr.hintachCache[e]=i,hr.renderHintach(e,t,r,hr.hintachCache[e])}})},onHintachItemClick:function(e){var t=e.currentTarget.dataset.hint,r=parseInt(e.currentTarget.parentNode.dataset.opt);if(t&&!isNaN(r)){var i=hr.opts[r]||{},o=i.txt,n=o&&geByClass1("_sticker_hints",domPN(o)),a=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/(photo|doc)(-?\d+)_(\d+)/);if(!t)return null;var r=t[1],i=parseInt(t[2]),o=parseInt(t[3]),n=[i,o].join("_");return{type:r,ownerId:i,id:o,rawId:n}}(t);return a&&i.onHintachSend&&(val(o,""),i.onHintachSend(a.type,a.rawId),i.checkEditable&&i.checkEditable(r,o),hr.stickersHintsHide(n,i,0)),!1}},renderHintach:function(e,t,r,i){var o=t.txt,n=geByClass1("_sticker_hints",domPN(o)),a=isArray(i.photos)&&i.photos.length||isArray(i.docs)&&i.docs.length;if(e&&t.stickerHintsString&&a){var s=n&&geByClass1("_sticker_hints_inner",n);if(!s||t.noStickers)return!1;hr.clearHintsLog(),hr.hintachNotFoundStickers[e]&&(s.innerHTML="");var l=s.querySelector(".Hintach");l||(l=s.appendChild(ce("div",{className:"Hintach"}))),l.setAttribute("data-opt",t.id),l.innerHTML="";var d=64*window.devicePixelRatio,u=64*window.devicePixelRatio;(i.photos||[]).forEach(e=>{var t=function(e,t,r){if(!e||!t||!r)return null;var i=Object.values(e).sort((e,t)=>e[1]-t[1]||e[2]-t[2]);return i.find(e=>e[1]>=t&&e[2]>=r)||i[parseInt(i.length/2)]||i[0]}(e.sizes,d,u);if(t){var r=dr(t,3),i=r[0],o=dr(c(r[1],r[2]),2),n=o[0],a=o[1],s=ce("div",{className:"Hintach__item Hintach__item--photo"});s.setAttribute("data-hint","photo"+e.id),s.appendChild(ce("div",{className:"Hintach__itemThumb"},{width:n,height:a,backgroundImage:`url(${i})`})),s.onclick=hr.onHintachItemClick,l.appendChild(s)}}),(i.docs||[]).forEach(e=>{if(e.preview&&(e.preview.video||e.preview.graffiti)){var t=dr(e.preview.video||e.preview.graffiti,3),r=t[0],i=dr(c(t[1],t[2]),2),o=i[0],n=i[1],a=ce("div",{className:"Hintach__item Hintach__item--doc"});a.setAttribute("data-hint","doc"+e.id);var s=a.appendChild(ce(e.preview.video?"video":"img",{className:"Hintach__itemPreview",src:r},{width:o,height:n}));e.preview.video&&(a.appendChild(ce("div",{className:"Hintach__itemType",innerHTML:"GIF"})),s.autoplay=!0,s.loop=!0),a.onclick=hr.onHintachItemClick,l.appendChild(a)}}),l.childElementCount>0&&(hr.stickersHintsShow(n,t,100),s.scrollLeft=0,hr.checkStickersHintsScroll(n,s.scrollLeft))}},onMoneyTransferSuggestionClick:function(e,t,r){var i=hr.opts[e],o=i.txt.parentNode.querySelector("._sticker_hints");if(hr.stickersHintsHide(o,i,0),"send"===t&&i.suggestions.isMoneySendEnabled()||"request"===t&&i.suggestions.isMoneyRequestEnabled()){var n=i.suggestions.config,a=n.fromId,s=n.peer;S.onClick(a,s,t,r,{onSendStart:()=>{i.clearText&&i.clearText()}});var c=hr.moneyTransferTextMatch&&hr.moneyTransferTextMatch.input||"";statlogsValueEvent("stickers_money_transfer_suggestions","select",[t],c)}},renderMoneyTransferSuggestions:function(e,t){var r=hr.opts[e],i=Object(d.isRetina)()?128:64,o={};return r.suggestions.isMoneyRequestEnabled()?o.request=`<a\n        class="emoji_sticker_item"\n        data-money-transfer-type="request"\n        onclick="Emoji.onMoneyTransferSuggestionClick(${e}, 'request', ${t.amount||0});">\n        <img class="emoji_sticker_image" src="/images/money/request/${i}.png" />\n      </a>`:o.request="",r.suggestions.isMoneySendEnabled()?o.send=`<a\n        class="emoji_sticker_item"\n        data-money-transfer-type="send"\n        onclick="Emoji.onMoneyTransferSuggestionClick(${e}, 'send', ${t.amount||0});">\n        <img class="emoji_sticker_image" src="/images/money/send/${i}.png" />\n      </a>`:o.send="",t.request?o.request+o.send:o.send+o.request},checkStickersKeywords:function(e,t,r){if(t.noStickers||!window.stickersKeywords||!window.stickersKeywordsData||!window.stickersKeywordsData.length)return!1;var i=r?0:100,o=t.txt,n=geByClass1("_sticker_hints",domPN(o)),a=function(r,i){if(hr.stickers[hr.TAB_RECENT_STICKERS]){var o=hr.sortStickersHints(window.stickersKeywords[r]),a=hr.stickers[hr.TAB_RECENT_STICKERS].promoted,s="";i&&(s+=hr.renderMoneyTransferSuggestions(e,i)),each(o,(function(){s+=hr.render.stickerHintRs(e,this,a[this])})),t.suggestions.isBotLinkEnabled()&&(s+=hr.renderSuggestionsBotLink(e)),hr.showStickersHints(n,t,s)}},s=function(){var s=t.suggestions.getQueries(hr.val(o));if(s.length){var c=s[0],l=t.suggestions.isMoneyTransferEnabled()&&S.match(c,1);if(l&&(s=[S.DEFAULT_QUERY]),hr.moneyTransferTextMatch=l,!n&&!(n=hr.initStickersHints(o)))return!1;if(c!=t.stickerHintsString){var d=s.find(e=>e&&window.stickersKeywords[e]&&window.stickersKeywords[e].length);if(hr.stickerSuggestionQuery=d,d)if(hr.stickers[hr.TAB_RECENT_STICKERS])a(d,l);else{var u=t.onRecentEmojiUpdate;t.onRecentEmojiUpdate=function(e){u&&u(),e&&(u?t.onRecentEmojiUpdate=u:delete t.onRecentEmojiUpdate,a(d,l))},hr.emojiLoadMore(e)}else hr.hintachNotFoundStickers[c]=!0,hr.stickersHintsHide(n,t,i);!l&&c&&c.length<20&&t.onHintachSend&&(clearTimeout(t.hintachCheckTimeout),t.hintachCheckTimeout=setTimeout(()=>{hr.checkHintach(c,t,r)},160)),t.stickerHintsString=c}}};r?s():(clearTimeout(t.stickerHintTT),t.stickerHintTT=setTimeout(s,n&&isVisible(n)?0:200))},showStickersHints:function(e,t,r){var i=e&&geByClass1("_sticker_hints_inner",e);if(!i||t.noStickers)return!1;hr.clearHintsLog(),val(i,r),hr.stickersHintsShow(e,t,100),i.scrollLeft=0,hr.checkStickersHintsScroll(e,i.scrollLeft)},checkStickersHintsScroll:function(e,t){var r=domClosest("_sticker_hints",e),i=r&&geByClass1("_sticker_hints_inner",r),o=r&&geByClass1("_sticker_left",r),n=r&&geByClass1("_sticker_right",r);if(!i)return!1;var a=getSize(o)[0],s=getSize(n)[0];if(hasClass(e,"emoji_sticker_item")){var c=e.offsetLeft-8-a,l=e.offsetLeft+getSize(e)[1]+2+s-i.clientWidth;i.scrollLeft>c&&(i.scrollLeft=c),i.scrollLeft<l&&(i.scrollLeft=l),t=i.scrollLeft}var d=t>0,u=t+i.clientWidth<i.scrollWidth;toggle(o,d),toggleClass(r,"sticker_hints_left_pad",d),toggle(n,u),toggleClass(r,"sticker_hints_right_pad",u),t=void 0===t?i.scrollLeft:t;var p=i.querySelectorAll(".emoji_sticker_item"),_=d?a+8:0,h=u?s+2:0,m=Array.from(p).filter(e=>e.offsetLeft-_>=t&&e.offsetLeft+e.offsetWidth+h-i.clientWidth<=t);hr.logHints(m.map(e=>intval(e.getAttribute("data-sticker-id"))).filter(e=>e));var v=m.map(e=>e.getAttribute("data-money-transfer-type")).filter(e=>e);if(v.length){var f=hr.moneyTransferTextMatch&&hr.moneyTransferTextMatch.input||"";statlogsValueEvent("stickers_money_transfer_suggestions","show",v,f)}},logHints:function(e){hr.logHintsTimeout&&clearTimeout(hr.logHintsTimeout),hr.logHintsTimeout=setTimeout(()=>{hr.hintsLogBuffer=e.reduce((e,t)=>(e[t]=1,e),hr.hintsLogBuffer||{})},hr.logHintsDelay)},clearHintsLog:function(){hr.logHintsTimeout&&clearTimeout(hr.logHintsTimeout),hr.hintsLogBuffer={}},sendHintsLog:function(){var e=hr.hintsLogBuffer&&Object.keys(hr.hintsLogBuffer),t=window.cur&&window.cur.emojiHintsSendLogHash;e&&e.length&&t&&ajax.post("stickers.php",{act:"log_hints",sticker_ids:e,hash:t}),hr.clearHintsLog()},scrollStickersHints:function(e,t,r){var i=domClosest("_sticker_hints",e),o=i&&geByClass1("_sticker_hints_inner",i),n=i&&geByClass1("_sticker_left",i),a=i&&geByClass1("_sticker_right",i);if(!o)return!1;var s=o.scrollLeft+t*(o.clientWidth-2*getSize(e)[0]),c=geByClass("emoji_sticker_item",o);each(c,(function(e,r){return t>0&&r.offsetLeft-8-getSize(n)[0]>s?(s=c[e-1]&&c[e-1].offsetLeft-8-getSize(n)[0]||s,!1):t<0&&r.offsetLeft+getSize(r)[1]+2+getSize(a)[0]-o.clientWidth>s?(s=r.offsetLeft+getSize(r)[1]+2+getSize(a)[0]-o.clientWidth||s,!1):void 0})),s=Math.max(0,Math.min(o.scrollWidth-o.clientWidth,s)),animate(o,{scrollLeft:s},{duration:Math.abs(o.scrollLeft-s)+50,transition:Fx.Transitions.easeOutCubic}),hr.checkStickersHintsScroll(o,s)},onWheelStickersHints:function(e){e.preventDefault(),e.stopPropagation();var t=e.currentTarget;t.scrollLeft+=Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX,hr.checkStickersHintsScroll(t,t.scrollLeft)},sortStickersHints:function(e){var t=[];hr.stickers[-1]&&(t=hr.stickers[-1].stickers);var r={},i=[];return each(t,(function(){inArray(this[0],e)&&!r[this[0]]&&(i.push(this[0]),r[this[0]]=1)})),each(e,(function(){r[this]||i.push(this)})),i},initStickersHints:function(e){return!!e&&domPN(e).insertBefore(se('<div class="_sticker_hints sticker_hints_tt">\n      <div class="sticker_hints_arrow sticker_left _sticker_left" onmousedown="Emoji.scrollStickersHints(this, -1, event);cancelEvent(event);" onclick="cancelEvent(event);"></div>\n      <div class="_sticker_hints_inner sticker_hints_inner"></div>\n      <div class="sticker_hints_arrow sticker_right _sticker_right" onmousedown="Emoji.scrollStickersHints(this, 1, event);cancelEvent(event);" onclick="cancelEvent(event);"></div>\n    </div>'),e)},updateStickersHints:function(e){hr.opts&&each(hr.opts,(function(t,r){e&&delete r.stickerHintsString,hr.checkStickersKeywords(t,r,!0)}))},renderSuggestionsBotLink(e){var t=hr.opts[e].suggestions,r=Object(d.isRetina)()?128:64;return`<a\n    class="emoji_sticker_item"\n    href="${t.getBotLinkUrl()}"\n    onClick="Emoji.onSuggestionsBotLinkClick(event, ${e});"\n    target="_blank">\n    <img class="emoji_sticker_image" src="${t.getBotLinkImageUrl(r)}" />\n  </a>`},onSuggestionsBotLinkClick(e,t){e.stopPropagation();var r=hr.opts[t].suggestions;statlogsValueEvent(r.getBotLinkClickStatName(),0,...r.getBotLinkClickStatKeys())},initStickersKeywords:function(){if(!window.stickersKeywordsData){var e=ls.get("stickers_keywords");e&&e.time&&e.time>vkNow()-hr.stickersKeywordsExpire&&(window.stickersKeywordsData=e.keywords)}window.stickersKeywordsData&&hr.setStickersKeywords(window.stickersKeywordsData)},initPromotedStickerUrls:function(){if(!window.promotedStickerUrls){var e=ls.get("promoted_stickers_urls");if(e&&e.time&&e.time>vkNow()-hr.stickersKeywordsExpire)window.promotedStickerUrls=e.stickerUrls;else{ajax.post("al_im.php",{act:"get_promoted_stickers"},{onDone:function(e){ls.set("promoted_stickers_urls",{time:vkNow(),stickerUrls:e}),window.promotedStickerUrls=e}})}}},cachedStickersKeywordsTime:function(){var e=ls.get("stickers_keywords");return e&&e.time?Math.floor(e.time/1e3):0},setStickersKeywords:function(e,t){if(!e)return!1;window.stickersKeywords={};var r=ce("div"),i=[],o="";if(e.forEach((function(e){var t=e.words||[],r=e.user_stickers||[],n=e.promoted_stickers||[],a=r.concat(n.map((function(e){return-e})));t.forEach((function(e){o+="\n"+e,i.push(a)}))})),val(r,o),(o=r.textContent||r.innerText)&&o.slice("\n".length).split("\n").forEach((function(e,t){window.stickersKeywords[e]=i[t]})),!hr.stickers[hr.TAB_RECENT_STICKERS]){var n=ls.get("recent_stickers");n&&(hr.stickers[hr.TAB_RECENT_STICKERS]=n)}t&&(ls.set("stickers_keywords",{time:vkNow(),keywords:e}),hr.updateStickersHints(!0))},emojiEnter:function(e,t){var r=hr.opts[e],i=(r.ctrlSend?r.ctrlSend():r.noEnterSend)||cur.ctrl_submit&&!r.noCtrlSend;if(r.emojiFocused&&r.emojiOvered&&r.openedByTabKey&&(i?!(t.ctrlKey||browser.mac&&t.metaKey):!t.shiftKey)){if(0===r.curTab){var o=geByTag1("img",r.emojiOvered)||geByTag1("i",r.emojiOvered);hr.addEmoji(e,hr.getCode(o),r.emojiOvered)}return cancelEvent(t)}return!0},insertHTML:function(e){if(browser.msie&&parseInt(browser.version)<12)if(document.selection){var t=document.selection.createRange();t.pasteHTML&&t.pasteHTML(e)}else{var r=document.getSelection().getRangeAt(0),i=document.createElement("span");r.surroundContents(i),i.innerHTML=e,r.collapse(!1)}else e&&document.execCommand("insertHTML",!1,e)},addEmoji:function(e,t,r){if(!1===e||!1===t)return!1;var i=hr.opts[e];if(!(vkNow()-i.ttShowT<hr.CLICK_DELAY)){if(i.editable){var o=hr.getEmojiHTML(t,hr.codeToChr(t),!0),n=i.txt,a=!!window.getSelection&&window.getSelection(),s=!1;if(a&&a.rangeCount){var c=a.getRangeAt(0);s=c.commonAncestorContainer?c.commonAncestorContainer:c.parentElement?c.parentElement():c.item(0)}for(var l=s;l&&l!=n;)l=l.parentNode;var d=n.lastChild||{};browser.mozilla&&"BR"==d.tagName&&!d.previousSibling&&re(n.lastChild),l||hr.editableFocus(n,!1,!0),hr.insertHTML(o);var p=geByClass("emoji",n);for(var _ in p.push.apply(p,geByClass("emoji_css",n)),p)if(p.hasOwnProperty(_)){var h=p[_].previousSibling;if(h&&3==h.nodeType&&h.textContent&&32==h.textContent.charCodeAt(0)){var m=h.previousSibling;m&&3==m.nodeType&&m.textContent&&160==m.textContent.charCodeAt(m.textContent.length-1)&&re(h)}}n.check&&n.check(),setTimeout(hr.correctCaret.pbind(n),5),hr.onChange(i);var v=Object(u.data)(n,"composer");v&&window.Composer&&Composer.updateAutoComplete(v)}else{var f,g,y,b=i.txt,w=b.value;f=browser.iphone||browser.ipad?hr.codeToChr(t):hr.cssEmoji[t][1]+" ",null!=b.selectionStart&&null!=b.selectionEnd?(g=b.selectionEnd,b.value=w.slice(0,b.selectionStart)+f+w.slice(g),b.selectionStart=b.selectionEnd=g+f.length):void 0!==document.selection&&void 0!==document.selection.createRange&&(b.focus(),(y=document.selection.createRange()).text=f,y.select())}i.checkEditable&&i.checkEditable(e,i.txt),hr.checkStickersKeywords(e,i),i.saveDraft&&i.saveDraft(),i.onEmojiAdded&&i.onEmojiAdded(),hr.incrRecentEmojiRate(e,t)}},showShadow:function(){return!(browser.msie&&browser.version<10)},scrollToggleArrow:function(e,t,r,i){var o=geByClass1("emoji_tabs_"+t+"_s",r.tt);i?(e?show:hide)(o):e?fadeIn(o,200):fadeOut(o,200),r[t+"Shown"]=e},scrollTabs:function(e,t){var r=hr.opts[e];if(r){var i,o=geByClass1("emoji_tabs_wrap",r.tt),n=o.firstChild.clientWidth-o.clientWidth;if(t){if((i=2==t?o.scrollLeft:o.scrollLeft+170)>=n){i=n;var a=geByClass1("emoji_tabs_r_s",r.tt);fadeOut(a,200),r.rShown=!1,hr.scrollToggleArrow(!1,"r",r)}i&&!r.lShown&&hr.scrollToggleArrow(!0,"l",r)}t&&2!=t||((i=2==t?o.scrollLeft:Math.max(o.scrollLeft-170,0))<=0&&(i=0,hr.scrollToggleArrow(!1,"l",r)),i<n&&!r.rShown&&hr.scrollToggleArrow(!0,"r",r)),2!=t&&(r.scrollLeft=i,animate(o,{scrollLeft:i},300))}},scrollToTab:function(e,t){var r=hr.opts[t],i=r.tt,o=geByClass1("emoji_tabs_wrap",i),n=geByClass1("emoji_tab_"+e,i);if(n){var a=Object(u.data)(o,"tween");if(!a||!a.isTweening||e!=r.curTab){var s=getSize(n)[0],c=n.offsetLeft,l=getSize(o)[0],d=c-l/2+10;c+s<o.scrollLeft?o.scrollLeft=Math.max(c,o.scrollLeft-l/2):c+s-o.scrollLeft>l&&(o.scrollLeft=Math.min(c+s-o.scrollLeft,o.scrollLeft+l/2)),animate(o,{scrollLeft:d},300,(function(){hr.scrollTabs(t,2)})),hr.selectTab(t,e,n)}}},selectTab:function(e,t,r){var i=hr.opts[e],o=i.tt,n=geByClass1("emoji_tabs",o),a=geByClass1("emoji_tab_sel",n);removeClass(a,"emoji_tab_sel"),addClass(r,"emoji_tab_sel"),i.curTab=t,cur.stickersTab=t,ls.set("stickers_tab",t)},tabsWheel:function(e,t){cancelEvent(e);var r=hr.opts[t],i=Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX,o=geByClass1("emoji_tabs_wrap",r.tt),n=o.scrollLeft;o.scrollLeft+=i,n!=o.scrollLeft&&hr.scrollTabs(t,2)},show:function(e,t){var r=Object(u.data)(domPN(e),"optId");void 0!==r&&hr.ttShow(r,e,t)},hide:function(e,t,r){var i=Object(u.data)(domPN(e),"optId");void 0!==i&&hr.ttHide(i,e,t,r)},ttShow:function(e,t,r){var i=hr.opts[e];clearTimeout(i.ctt),clearTimeout(i.stt),i.scrolling&&(i.afterScrollFn=!1),i.ttShown||(t?i.obj=t:t=i.obj,i.stt=setTimeout((function(){hr.ttClick(e,t,!1,!0,r)}),hr.SHOW_TT_TIMEOUT))},ttHide:function(e,t,r,i){var o=hr.opts[e];if(clearTimeout(o.stt),o.ttShown)if(o.scrolling)o.afterScrollFn=hr.ttHide.pbind(e,t,r,i);else{t=t||o.obj||geByClass1("emoji_smile",o.controlsCont);var n=function(){hr.ttClick(e,t,!0,!1,r)};i?n():(clearTimeout(o.ctt),o.ctt=setTimeout(n,hr.HIDE_TT_TIMEOUT))}},ttClick:function(e,t,r,i,o,n){var a=hr.opts[e];if(a&&!(r&&!hr.shown||i&&hr.shown)&&(t||(t=hr.shown||ge(-3==cur.peer?"imw_smile":"im_smile")))){t.tt&&t.tt.destroy&&t.tt.destroy(),!a.tt&&a.sharedTT&&a.sharedTT.emojiTT&&(a.tt=a.sharedTT.emojiTT,a.emojiScroll=a.sharedTT.emojiScroll,a.allEmojiId=a.sharedTT.emojiAllId);var s,c=a.tt;if(!c){var l=ls.get("stickers_tab");l||(l=hr.TAB_EMOJI),a.curTab=cur.stickersTab=hr.TAB_EMOJI,l==hr.TAB_EMOJI||a.noStickers||(hr.stickers[hr.TAB_RECENT_STICKERS]=ls.get("recent_stickers"),a.curTab=cur.stickersTab=l);var d='<div class="emoji_tabs_l_s" onmousedown="Emoji.scrollTabs('+e+', 0); return cancelEvent(event);" onclick="return cancelEvent(event)"><div class="emoji_sprite emoji_tabs_l_sc"></div><div class="emoji_sprite emoji_tabs_l_si"></div></div><div class="emoji_tabs_r_s" onmousedown="Emoji.scrollTabs('+e+', 1); return cancelEvent(event);" onclick="return cancelEvent(event);"><div class="emoji_sprite emoji_tabs_r_sc"></div><div class="emoji_sprite emoji_tabs_r_si"></div></div>';d+=hr.getTabsCode([[0,1]],e),d+='<span class="emoji_tabs_wrap"><span id="emoji_tabs_cont_'+e+'" class="emoji_tabs_cont">',a.noStickers||!1===window.emojiStickers||void 0===window.emojiStickers||(d+=hr.getTabsCode(window.emojiStickers,e));var u="",p='onmousedown="Emoji.showStickersStore('+e+'); return cancelEvent(event);" onclick="return cancelEvent(event);"',_="showTooltip(this, {text: '"+Object(H.getLang)("global_store_stickers")+"', shift: [4,6,6], showdt: 0, black: 1});";a.rPointer?p+=" onmouseover=\"addClass(this.parentNode.parentNode.parentNode, 'emoji_shop_over');"+_+'" onmouseout="removeClass(this.parentNode.parentNode.parentNode, \'emoji_shop_over\');"':p+=' onmouseover="'+_+'"',d+="</span></span>",a.noStickers||(d+='<a class="fl_r emoji_shop" '+p+'><div class="emoji_sprite emoji_shop_icon">'+(hr.hasNewStickers?'<div class="emoji_shop_icon_badge">'+Math.abs(hr.hasNewStickers)+"</div>":"")+"</div></a>"),hr.showShadow()||(u+=" emoji_no_opacity"),(a.noStickers||a.hideStickersInitial)&&(u+=" emoji_no_tabs"),c=ce("div",{id:"emoji_block_"+e,className:"emoji_tt_wrap tt_down"+u,innerHTML:'<div class="emoji_block_cont"><div class="emoji_block_rel"><div class="emoji_list_cont"><div class="emoji_cats_title_helper"></div><div class="emoji_list"><div class="emoji_scroll emoji_scroll_smiles"></div><div class="emoji_scroll emoji_scroll_stickers"></div></div></div></div><div class="emoji_tabs clear_fix">'+d+"</div></div>",onmouseover:function(t){hasClass(c,"emoji_animated")||hr.ttShow(e,!1,t)},onmouseout:function(t){hasClass(c,"emoji_animated")||hr.ttHide(e,!1,t)}}),a.tt=c,hr.reappendEmoji(e,c),hr.emojiOver(e,geByClass1("emoji_scroll_smiles",c).firstChild),each(["emoji_tabs_l_s","emoji_tabs_r_s","emoji_tabs_wrap"],(function(){addEvent(geByClass1(this,a.tt),"DOMMouseScroll wheel",(function(t){hr.tabsWheel(t,e)}))})),a.sharedTT&&(a.sharedTT.emojiTT=c),hr.checkEmojiSlider(a)}if(clearTimeout(a.ttEmojiHide),!1!==hr.shownId&&hr.shownId!=e&&hr.ttClick(hr.shownId,geByClass1("emoji_smile",hr.opts[hr.shownId].controlsCont),!0),hr.preventMouseOver=!1,a.emojiExpanded||hr.emojiExpand(e,c),hr.shown)hr.hideTt(c),(s=geByClass1("_sticker_hints",domPN(a.txt)))&&isVisible(s)&&hr.checkStickersHintsSize(s,a,!0),hr.shown=!1,hr.shownId=!1,a.ttShown=!1,a.emojiFocused=!1,a.emojiOvered=!1,cur.onMouseClick=!1,removeEvent(document,"keydown",hr.emojiMove),removeClass(t,"emoji_smile_on"),a.onHide&&a.onHide(),hr.favorite.deleteFavoriteStickerElements(e);else{if(a.needUpdateRecentStickers&&(hr.updateRecentStickers(e),a.needUpdateRecentStickers=!1),!getXY(a.emojiBtn)[0]||!getXY(a.emojiBtn)[1])return;a.openedByTabKey=!!n,hr.showTt(c),hr.repositionEmoji(e,t,c),(s=geByClass1("_sticker_hints",domPN(a.txt)))&&isVisible(s)&&hr.checkStickersHintsSize(s,a,!0),hr.shownId=e,hr.shown=t,cur.emojiList=geByClass1("emoji_list",c),a.ttShown=!0,a.ttShowT=vkNow(),a.emojiFocused=!0,removeEvent(document,"keydown",hr.emojiMove),setTimeout((function(){cur.onMouseClick=function(t){for(var r=t.target;r;){if("im_texts"==r.id||hasClass(r,"emoji_tt_wrap")||hasClass(r,"imw_emoji_wrap"))return!1;r=r.parentNode}hr.ttClick(e,!1,!0)},addEvent(document,"keydown",hr.emojiMove)}),0),addClass(t,"emoji_smile_on"),a.emojiScroll&&a.emojiExpanded&&(a.emojiScroll.update(),browser.msie&&0===a.curTab&&a.emojiOvered&&hr.scrollToListEl(e,a.emojiOvered)),hr.tabSwitch(a.curTab,a.curTab,e),a.onRecentEmojiUpdate&&a.onRecentEmojiUpdate(!0),a.onShow&&a.onShow()}return each(geByClass("emoji_smile_icon_promo"),(function(e,t){removeEvent(geByClass1("emoji_smile_icon",t.parentNode),"mouseover"),re(t),hr.noNewStickers=!0})),a.noStickersStore?addClass(geByClass1("emoji_tabs","emoji_block_"+e),"emoji_tabs_no_store"):removeClass(geByClass1("emoji_tabs","emoji_block_"+e),"emoji_tabs_no_store"),cancelEvent(o)}},curEmojiKeys:{},curEmojiRecent:{},emojiLoadMore:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,i=hr.opts[e];if(!i.emojiMoreSt){i.emojiMoreSt=1,t.act="get_emoji_list",hr.stickerPacksToLoad&&(t.sticker_packs_to_load=hr.stickerPacksToLoad.join(",")),hr.hasNewStickers<0&&(t.new_shown=1);var o=Object.assign(t.sizes||{},hr.stickerSizes);t.sizes=o&&Object.keys(o).join(","),ajax.post("al_im.php",t,{onDone:function(t,n,a,s,c,l){if(hr.buildStickersIndex(t),void 0!==t[hr.TAB_FAVORITE_STICKERS]){var d=t[hr.TAB_FAVORITE_STICKERS];hr.tabDefaultId=hr.TAB_FAVORITE_STICKERS,hr.favoriteAvailable=!0,hr.favoriteRemindOn=!!d.remind_on,hr.favoriteRemindOff=!!d.remind_off,hr.favoriteLimit=d.limit,hr.favoriteLimitNoticed=d.limit_noticed,hr.sendHintsLogHash=c,S.setIntroViewed(l)}s&&extend(cur.lang,s),a?stManager.add([jsc("web/stickers.js")],(function(){hr.updateEmojiList(t,n,e,i)})):hr.updateEmojiList(t,n,e,i),Object.assign(hr.stickerSizes,o),Object(j.isFunction)(r)&&r()},onFail:function(){i.emojiMoreSt=0}}),hr.curEmojiRecent&&i.onRecentEmojiUpdate&&i.onRecentEmojiUpdate()}},buildStickersIndex:function(e){var t={};if(e)for(var r in e)if(e.hasOwnProperty(r)&&r>0&&e[r].stickers)for(var i=e[r].stickers,o=i.length;o--;){var n=i[o];t[n[0]]={sticker:n,packId:r}}hr.stickersById=t},updateEmojiList:function(e,t,r,i){hr.stickers=e,i.emojiMoreSt=0,hr.stickers[-1]&&(ls.set("recent_stickers",hr.stickers[-1]),hr.updateRecentEmoji(r)),hr.stickers[-2],i.allEmojiId=0,i.sharedTT&&(i.sharedTT.emojiAllId=0),hr.onStickersLoad&&(i.afterLoad=1),hr.onStickersLoad&&window.emojiStickers&&(hr.onStickersLoad(),hr.onStickersLoad=!1);var o=hr.emojiGetRecentFromStorage();o?hr.curEmojiRecent=hr.filterEmoji(o):(hr.emojiOldRecentPrepare(t,r),hr.updateEmojiCont(r)),hr.updateRecentEmoji(r),i.onRecentEmojiUpdate&&i.onRecentEmojiUpdate(!0)},filterEmoji:function(e){var t=Object.keys(e);e:for(var r in s)if(s.hasOwnProperty(r))for(var i in s[r])if(s[r].hasOwnProperty(i)){var o=s[r][i],n=t.indexOf(o);if(-1!=n&&(t.splice(n,1),0==t.length))break e}var a={};for(var c in e)e.hasOwnProperty(c)&&-1==t.indexOf(c)&&(a[c]=e[c]);return t.length>0&&hr.setRecentEmojiList(a),a},emojiGetRecentFromStorage:function(){try{return JSON.parse(localStorage.getItem("emoji_recent_list"))}catch(e){return!1}},emojiOldRecentPrepare:function(e){var t={};for(var r in e)if(e.hasOwnProperty(r)){var i=e[r],o=void 0,n=void 0;isString(i)?(o=1,n=i):(o=i,n=r),t[n]=o}hr.setRecentEmojiList(hr.filterEmoji(t))},getRecentEmojiSorted:function(){var e=[];for(var t in hr.curEmojiRecent)if(hr.curEmojiRecent.hasOwnProperty(t)){var r=hr.curEmojiRecent[t];e.push([t,r])}e.sort((function(e,t){return t[1]-e[1]}));var i=[];for(var o in e)e.hasOwnProperty(o)&&i.push(e[o][0]);return i.slice(0,20)},incrRecentEmojiRate:function(e,t){hr.emojiRecentRateTime||(hr.emojiRecentRateTime=Date.now()/1e3-6);var r=Date.now()/1e3-hr.emojiRecentRateTime;if(r>=6){var i=Math.min(100,Math.floor(r/6));for(var o in hr.curEmojiRecent)if(hr.curEmojiRecent.hasOwnProperty(o)){if(o==t)continue;hr.curEmojiRecent[o]*=Math.pow(.998076,i)}hr.emojiRecentRateTime+=6*i}hr.curEmojiRecent[t]||(hr.curEmojiRecent[t]=0),hr.curEmojiRecent[t]+=1;var n=hr.getRecentEmojiSorted();s[-1]=n,n.length>=20&&-1==n.indexOf(t)&&(n.splice(-1),n.push(t));var a={};for(var c in n)if(n.hasOwnProperty(c)){var l=n[c];a[l]=hr.curEmojiRecent[l]}hr.setRecentEmojiList(a),window.Notifier&&Notifier.lcSend("recent_emoji_set",a)},setRecentEmojiList:function(e){localStorage.setItem("emoji_recent_list",JSON.stringify(e)),hr.curEmojiRecent=e},updateEmojiCont:function(e){var t=hr.opts[e];0==t.curTab&&(val(geByClass1("emoji_scroll_smiles",t.tt),hr.getInitEmojiContent(e)),hr.updateEmojiCatTitle(e))},ttEmojiList:function(e,t){var r="",i=hr.emojiGetRecentFromStorage();i&&hr.setRecentEmojiList(i),s[-1]=hr.getRecentEmojiSorted();var o=t||hr.SORTED_EMOJI_SECTIONS_CODES;for(var n in o)if(o.hasOwnProperty(n)){var a=o[n];r+=hr.getEmojiCategoryHtml(e,a)}return r},getInitEmojiContent:function(e){hr.setEmojiLastAddedCategoryIdx(e,1);return hr.ttEmojiList(e,[-1,1])},getEmojiCategoryHtml:function(e,t){var r="",i=s[t];if(!i.length)return r;var o=-1==t?"recent":t,n='<div class="emoji_cat_title_helper" data-id="'+t+'" id="emoji_recent_list'+e+"_"+t+'"><div class="emoji_cat_title">'+Object(H.getLang)("global_emoji_cat_"+o)+"</div></div>";return r+=n+=hr.emojiGetCatCont(e,i)},getEmojiLastAddedCategoryIdx:function(e){return hr.opts[e].lastLoadedEmojiCategoriesIdxes[e]},setEmojiLastAddedCategoryIdx:function(e,t){hr.opts[e].lastLoadedEmojiCategoriesIdxes[e]=t},addNextEmojiCategoty:function(e){var t=hr.opts[e],r=t.tt,i=hr.getEmojiLastAddedCategoryIdx(e);if(!t.emojiCategoryAdding&&!t.allEmojiLoaded)if(t.emojiCategoryAdding=!0,i){var o=geByClass1("emoji_scroll_smiles",r);if(i++,hr.SORTED_EMOJI_SECTIONS_CODES.length>i){var n=hr.SORTED_EMOJI_SECTIONS_CODES[i];o.insertAdjacentHTML("beforeEnd",hr.getEmojiCategoryHtml(e,n)),hr.setEmojiLastAddedCategoryIdx(e,i),t.emojiScroll.update()}else t.allEmojiLoaded=!0;t.emojiCategoryAdding=!1}else debugLog("No emoji last category idx")},hideTt:function(e){removeClass(e,hr.SHOWN_TT_CLS)},showTt:function(e){addClass(e,hr.SHOWN_TT_CLS)},emojiGetCatCont:function(e,t){for(var r="",i="",o=t.length-1,n=0;n<=o;n++)i+=hr.emojiWrapItem(e,t[n],n),(n>0&&n%10==9||n>=o)&&(r+='<div class="emoji_smiles_row">'+i+"</div>",i="");return r},updateRecentEmoji:function(e){var t=hr.getRecentEmojiSorted(),r=hr.emojiGetCatCont(e,t),i=ge("emoji_recent_list"+e+"_-1");if(i){for(var o=i.nextSibling;o&&(o=o.nextSibling,hasClass(o.previousSibling,"emoji_smiles_row"));)re(o.previousSibling);for(var n=ce("div",{innerHTML:r}),a=i.nextSibling,s=i.parentNode;o=n.firstChild;)s.insertBefore(o,a)}},updateRecentStickers:function(e){var t=hr.opts[e];if(hr.stickers[hr.TAB_RECENT_STICKERS]&&t&&t.emojiExpanded){var r=ge("emoji_recent_stickers_cont"+e);if(r){val(r,"");for(var i=hr.stickers[hr.TAB_RECENT_STICKERS].stickers,o=cf(),n=0;n<i.length;n++){var a=hr.render.sticker(e,hr.TAB_RECENT_STICKERS,i[n]);o.appendChild(a);var s=68*Math.ceil((n+1)/4);t.needLoadStickers.unshift([e+"_"+hr.TAB_RECENT_STICKERS+"_"+i[n][0],s])}r.appendChild(o),hr.updateStickersPos(e)}}},findStickerIndex:function(e,t){if(e)for(var r=e.stickers,i=r.length;i--;)if(String(r[i][0])===String(t))return i;return-1},findSticker:function(e,t){var r=hr.findStickerIndex(e,t);if(-1!==r)return e.stickers[r]},findFavoriteStickerIndex:function(e){return hr.findStickerIndex(hr.stickers[hr.TAB_FAVORITE_STICKERS],e)},findFavoriteSticker:function(e){return hr.findSticker(hr.stickers[hr.TAB_FAVORITE_STICKERS],e)},findRecentStickerIndex:function(e){return hr.findStickerIndex(hr.stickers[hr.TAB_RECENT_STICKERS],e)},findRecentSticker:function(e){return hr.findSticker(hr.stickers[hr.TAB_RECENT_STICKERS],e)},findPackSticker:function(e){if(hr.stickersById&&hr.stickersById.hasOwnProperty(e))return hr.stickersById[e].sticker},isStickersLoaded:function(){if(hr.stickers)for(var e in hr.stickers)if(hr.stickers.hasOwnProperty(e)&&e!==String(hr.TAB_RECENT_STICKERS))return!0;return!1},tabs:{favoriteTabContent:function(e,t){var r=hr.TAB_FAVORITE_STICKERS,i="emoji_tab emoji_tab_img_cont emoji_tab_favorite emoji_tab_"+r;if(cur.stickersTab===r&&(i+=" emoji_tab_sel"),0===t&&hr.isStickersLoaded()){var o=hr.stickers[r];t=o?o.stickers.length:0}return 0===t&&(i+=" unshown"),'<a class="'+i+'" onmousedown="'+e+'" onclick="return cancelEvent(event)"><span class="emoji_tab_icon emoji_sprite emoji_tab_icon_favorite"></span></a>'}},favorite:{reminder:function(e){var t=hasClass(e,"on"),r=t?"favoriteRemindOff":"favoriteRemindOn";if(!hr[r]){var i={text:function(){return Object(H.getLang)(t?"purchases_stickers_favorite_rm_tt":"purchases_stickers_favorite_add_tt")},black:1,hidedt:100,typeClass:"tt_black",noZIndex:!0,shift:[10,8]},o=domClosest("ui_scroll_container",e);i.appendEl=o;var n=domClosest("ui_scroll_overflow",e),a=getXYRect(e),s=getXYRect(n),c=a.top-s.top,l=(s.right,a.right,s.bottom-a.bottom),d=a.left-s.left,u=(s.width||s.right-s.left)/2;(!vk.rtl&&d>u||vk.rtl&&d<u)&&(i.needLeft=!0,i.shift[0]=9),i.forcetodown=c<hr.FAV_ICON_TT_MIN_HEIGHT,i.forcetoup=l<hr.FAV_ICON_TT_MIN_HEIGHT,Object(F.showTooltip)(e,i),hr[r]=!0,ajax.post("stickers.php",{act:"tt_favorite_off",tt_type:t?1:2})}},addFavoriteSticker:function(e,t,r){var i=hr.stickers[hr.TAB_FAVORITE_STICKERS];if(i){var o=hr.findPackSticker(t);if(o){o[4]=1,i.stickers.unshift(o);var n=hr.opts[e],a=n.deletedFavoriteStickers;for(n.deletedFavoriteStickers=[t];i.stickers.length>hr.favoriteLimit;)hr.favorite.deleteFavoriteSticker(e,i.stickers[i.stickers.length-1][0]);hr.favorite.deleteFavoriteStickerElements(e),n.deletedFavoriteStickers=a;var s=hr.findRecentSticker(t);s&&(s[4]=1);var c=ge("emoji_favorite_stickers_cont"+e);if(c){var l=hr.opts[e].emojiScroll.data.scrollHeight,d=hr.opts[e].emojiScroll.data.scrollTop,u=ge("emoji_sticker_item"+e+"_"+hr.TAB_FAVORITE_STICKERS+"_"+t);if(!u){u=hr.render.sticker(e,hr.TAB_FAVORITE_STICKERS,o),hr.render.stickerContent(e,u,!1);var p=domFC(c);p?domInsertBefore(u,p):c.appendChild(u),hr.opts[e].emojiScroll.update();var _=hr.opts[e].emojiScroll.data.scrollHeight-l;hr.opts[e].emojiScroll.scrollTop(d+_),hr.updateStickersPos(e)}}var h=geByClass1("emoji_tab_"+hr.TAB_FAVORITE_STICKERS);if(hasClass(h,"unshown")&&(hr.opts[e].curTab===hr.TAB_FAVORITE_STICKERS&&removeClass(geByClass1("emoji_tab_"+hr.TAB_RECENT_STICKERS),"emoji_tab_sel"),removeClass(h,"unshown")),hr.favorite.updateFavoriteStickerElements(e,t,!0),hr.opts[e].deletedFavoriteStickers.length>0){var m=indexOf(hr.opts[e].deletedFavoriteStickers,t);-1!==m&&hr.opts[e].deletedFavoriteStickers.splice(m,1)}}}},deleteFavoriteSticker:function(e,t,r){var i=hr.stickers[hr.TAB_FAVORITE_STICKERS];if(i){var o=hr.findFavoriteStickerIndex(t);if(-1!==o){if(i.stickers.splice(o,1),hr.opts[e].deletedFavoriteStickers.push(t),0===i.stickers.length&&r)addClass(geByClass1("emoji_tab_"+hr.TAB_FAVORITE_STICKERS),"unshown"),domData(r.parentElement,"pack-id")===String(hr.TAB_FAVORITE_STICKERS)&&addClass(geByClass1("emoji_tab_"+hr.TAB_RECENT_STICKERS),"emoji_tab_sel");hr.favorite.updateFavoriteStickerElements(e,t,!1);var n=hr.findRecentSticker(t);n&&(n[4]=0);var a=hr.findPackSticker(t);a&&(a[4]=0)}}},deleteFavoriteStickerElement:function(e,t){re("emoji_sticker_item"+e+"_"+hr.TAB_FAVORITE_STICKERS+"_"+t)},deleteFavoriteStickerElements:function(e){var t=hr.opts[e];t.deletedFavoriteStickers.length>0&&(t.deletedFavoriteStickers.forEach((function(t){hr.favorite.deleteFavoriteStickerElement(e,t)})),t.deletedFavoriteStickers=[],hr.updateStickersPos(e))},deleteFavoriteStickerElementsAsync:function(e){var t=hr.opts[e];t.deleteFavoriteStickersTimeout||(t.deleteFavoriteStickersTimeout=setTimeout((function(){hr.favorite.deleteFavoriteStickerElements(e),t.deleteFavoriteStickersTimeout=null}),hr.DELETE_FAV_STICKER_ELEMENTS_DELAY))},updateFavoriteStickerElements:function(e,t,r){geByClass("sticker_item_"+t).forEach((function(e){domData(e,"fav",r?"1":null),toggleClass(e,"faved",r),toggleClass(geByClass1("emoji_sticker_item_fav",e),"on",r)}))}},updateEmojiCatTitle:function(e){var t=hr.opts[e];if(t&&t.emojiScroll){var r,i,o,n=ge("emoji_block_"+e),a=geByClass("emoji_cat_title_helper",n),s=t.emojiScroll.data.scrollTop,c=geByClass1("emoji_cats_title_helper",t.tt);if(a.length){var l=a[0];r=hr.getSizeCached(l)[1]}for(var d=a.length-1;d>=0;d--)if(s>a[d].offsetTop-r){i=a[d],o=d;break}if(!i)return debugLog("title not found");var u=intval(attr(i,"data-id"));if(t.curEmojiCatId!=u){t.curEmojiCatId=u;var p=[i],_=a[o-1];_&&(addClass(_,"emoji_cat_title_fix"),setStyle(_.firstChild,"transform","translateY("+(i.offsetTop-_.offsetTop-r)+"px)"));for(var h=i.nextSibling;h;)hasClass(h,"emoji_cat_title_fix")&&p.push(h),h=h.nextSibling;for(var m in p)p.hasOwnProperty(m)&&(removeClass(p[m],"emoji_cat_title_fix"),setStyle(p[m].firstChild,"transform","translateY(0px)"));val(c,""),t.emojiTitleHelperIsSet=0}!t.emojiTitleHelperIsSet&&s>=i.offsetTop&&s>0?(val(c,val(i)),t.emojiTitleHelperIsSet=1):t.emojiTitleHelperIsSet&&(s<i.offsetTop||0==s)&&(val(c,""),t.emojiTitleHelperIsSet=0)}},emojiWrapItem:function(e,t,r){var i,o=hr.cssEmoji[t];i=o?' title="'+o[1]+'"':"";var n="";return browser.mobile||(n=' onmouseover="return Emoji.emojiOver('+e+', this, true);"'),'<a class="emoji_smile_cont '+("2764"!=t&&r&&r<54?"emoji_smile_shadow":"")+'" '+i+" onmousedown=\"Emoji.addEmoji(Emoji.shownId, '"+t+'\', this); return cancelEvent(event);" onclick="return cancelEvent(event);" '+n+'><div class="emoji_bg"></div><div class="emoji_shadow"></div>'+hr.getEmojiHTML(t,!1,!1,!0)+"</a>"},reappendEmoji:function(e,t){var r=hr.opts[e];r&&r.rceCont&&(r.addMediaBtn?r.sendWrap.insertBefore(r.rceCont,r.addMediaBtn):r.sendWrap.appendChild(r.rceCont)),t&&(r.ttWrap?r.ttWrap.appendChild(t):r.emojiWrap?r.emojiWrap.appendChild(t):r.obj.appendChild(t),clearTimeout(cur.ttEmojiHide),hr.hideTt(t))},ttCalcHeight:function(e,t,r){window.headH=window.headH||ge("page_header")&&hr.getSizeCached(ge("page_header"))[1]||0;var i=(window.pageNode&&window.browser.mozilla?Math.min(getSize(pageNode)[1],window.lastWindowHeight):window.lastWindowHeight)||getScroll()[3],o=window.scrollGetY?scrollGetY():getScroll()[1],n=getXY(t)[1],a=hr.getSizeCached(t)[1],s=geByClass1("emoji_list",r),c=hr.opts[e].emojiSmileHeigh,l=window.headH,d=hr.opts[e].emojiRowsCount;isAncestor(t,pageNode)||(l=0),setStyle(s,{height:d*c+8});for(var p,_,h,m,v=o+l,f=o+i,g=r,y=getSize(r)[1];g!==bodyNode&&(g=Object(u.domClosestOverflowHidden)(g));){var b=getXY(g)[1];v=Math.max(v,b),f=Math.min(f,b+getSize(g)[1])}for(h=f-n-a-9,p=(_=n-9-v)<y&&h<y?_>=h:_>=y,hr.opts[e].forceUp&&(p=!0),m=p?_:h;m<y&&d>3;)d--,y-=c;hr.opts[e].emojiRowsCount=d,hr.opts[e].emojiSmileHeigh=c,setStyle(s,{height:d*c+8}),toggleClass(r,"tt_down",p),toggleClass(r,"tt_up",!p)},repositionEmoji:function(e,t,r){var i,o=hr.opts[e];if(o){if(r.parentNode&&getXY&&getStyle&&setStyle&&geByClass&&(i=geByClass1("emoji_rpointer",r))){var n=parseInt(getStyle(r,"width")),a=getXY(t)[0],s=parseInt(getStyle(t,"width")),c=getXY(r.parentNode)[0];a+s/2<283?(setStyle(r,"left",-n-c),setStyle(i,"left",a+s/2-20+"px")):(setStyle(r,"left",""),setStyle(i,"left",""))}else setStyle(r,"left","");var l=geByClass1("emoji_list",r),d=geByClass1("emoji_smile_cont",l);if(hr.opts[e].emojiSmileHeigh=d&&hr.getSizeCached(d)[1]||26,hr.opts[e].emojiRowsCount=9,hr.ttCalcHeight(e,t,r),o.ttWrap){var u=getSize(o.ttWrap)[0]-(getXY(o.emojiBtn)[0]-getXY(o.ttWrap)[0]);setStyle(r,"right",u-o.ttDiff+"px")}}},emojiOver:function(e,t,r){if(browser.mobile||r&&hr.preventMouseOver)return!0;var i=hr.opts[e];addClass(t,"emoji_over"),i.emojiOvered&&i.emojiOvered!=t&&removeClass(i.emojiOvered,"emoji_over"),i.emojiOvered=t},emojiExpand:function(e,t){var r=hr.opts[e];addClass(t,"emoji_expanded"),hr.emojiLoadMore(e),r.emojiScroll?r.emojiScroll.update():(r.emojiScroll=new uiScroll(geByClass1("emoji_list",t),{theme:"default emoji no_transition",shadows:!0,global:!0,noForceReFlow:!0,ondragstart:function(){r.scrolling=!0},ondragstop:function(){r.scrolling=!1,Object(j.isFunction)(r.afterScrollFn)&&r.afterScrollFn()},onscrollstart:function(){window.tooltips&&tooltips.destroyAll(),r.scrollStarted=!0},onupdate:function(t){r.curTab==hr.TAB_EMOJI?hr.updateEmojiCategories(t,r,e):hr.updateShownStickers(e)}}),r.imagesLoader=r.imagesLoader||imagesLoader(r.emojiScroll.scroller,{use_iframe:!0,need_load_class:"emoji_need_load"}),r.sharedTT&&(r.sharedTT.emojiScroll=r.emojiScroll)),r.emojiExpanded=!0},updateEmojiCategories:function(e,t,r){e.data.scrollBottom-hr.BOTTOM_REST_FOR_ADD_EMOJI_CATEGORY<=0&&t.scrollStarted&&setTimeout((function(){hr.addNextEmojiCategoty(r),hr.updateEmojiCatTitle(r)}),0),hr.updateEmojiCatTitle(r)},updateShownStickers:function(e,t){var r=hr.opts[e];if(r.emojiScroll&&r.stickersSplitersPos){r.needLoadStickers||(r.needLoadStickers=[]);var i=r.emojiScroll.data.scrollTop,o=i,n=i+r.emojiScroll.data.viewportHeight,a=r.needLoadStickers;clearTimeout(r.preloadStickersTimer);for(var s=[],c=0;c<a.length;c++){var l=a[c];if(l[1]+72>=o&&l[1]<=n){var d=ge("emoji_sticker_item"+l[0]);if(!d||hasClass(d,"__loaded"))continue;var u=hr.render.stickerContent(e,d,!0);s.push([u,l[0]])}}if(hr.loadStickers(e,s),s.length||hr.preloadStickers(e),!(t||r.scrollAnimation||hr.onStickersLoad)){for(var p=-1,_=0;_<r.stickersSplitersPos.length;_++){var h=r.stickersSplitersPos[_];if(!(h[1]-30<i))break;p=h[0]}p!=hr.TAB_FAVORITE_STICKERS&&hr.favorite.deleteFavoriteStickerElementsAsync(e),r.curTab!=p&&hr.scrollToTab(p,e)}}},loadStickers:function(e,t){var r=hr.opts[e];if(t.length){for(var i={},o=0;o<t.length;o++){var n=t[o][0]+":"+t[o][1];r.imagesLoading[n]&&(i[n]=r.imagesLoading[n],delete r.imagesLoading[n],t.splice(o,1),o--)}for(var a in r.imagesLoading)if(r.imagesLoading.hasOwnProperty(a)){var s=r.imagesLoading[a];if(!s)return;s.src=""}for(var c in r.imagesLoading=i,t)if(t.hasOwnProperty(c)){var l=t[c][0]+":"+t[c][1];r.imagesLoading[l]=r.imagesLoader.iloader.add(t[c][0],hr.onStickerLoaded,e+":"+t[c][1])}}},preloadStickers:function(e){var t=hr.opts[e];t.imagesLoading&&Object.keys(t.imagesLoading).length>0||(clearTimeout(t.preloadStickersTimer),t.preloadStickersTimer=setTimeout((function(){var r=t.emojiScroll.data.scrollTop,i=t.emojiScroll.data.viewportHeight,o=r+i,n=r-i,a=r,s=o,c=o+i,l=geByClass1("emoji_scroll_stickers",t.tt);if(isVisible(l)){for(var d=l.firstChild,u=[];d;){if(hasClass(d,"emoji_sticker_item")&&!hasClass(d,"__loaded")){var p=d.offsetTop;if(p>=n&&p<=a||p>=s&&p<=c){var _=d.id.replace("emoji_sticker_item",""),h=hr.render.stickerContent(e,d,!0);u.push([h,_])}}d=d.nextSibling}hr.loadStickers(e,u)}}),50))},onStickerLoaded:function(e){var t=String(this).split(":"),r=t[1],i=intval(t[0]),o=hr.opts[i],n=ge("emoji_sticker_item"+r);if(n){var a=geByTag1("img",n);if(a){addClass(n,"__loaded"),attr(a,"src",e),delete hr.opts[i].imagesLoading[e+":"+r];for(var s=0;s<o.needLoadStickers.length;s++){if(r==o.needLoadStickers[s][0]){o.needLoadStickers.splice(s,1);break}}Object.keys(hr.opts[i].imagesLoading).length||hr.preloadStickers(i)}}},emojiMove:function(e){var t=hr.shownId,r=hr.opts[t];if(hr.shown&&r&&r.emojiFocused&&r.openedByTabKey){var i=null;if(r.emojiOvered)switch(e.keyCode){case KEY.LEFT:i=hr.getEmojiEl(r.emojiOvered,"left"),cancelEvent(e);break;case KEY.RIGHT:i=hr.getEmojiEl(r.emojiOvered,"right"),cancelEvent(e);break;case KEY.UP:i=hr.getEmojiEl(r.emojiOvered,"up");break;case KEY.DOWN:i=hr.getEmojiEl(r.emojiOvered,"down");break;case KEY.ENTER:if(!hr.emojiEnter(t,e))return cancelEvent(e),!1;break;default:return!0}else i=hr.getFirstEmojiEl(t);if(i)return hr.preventMouseOver=!0,hr.emojiOver(t,i),hr.scrollToListEl(t,i),!1}return!0},scrollToListEl:function(e,t){var r=hr.opts[e];if(r&&r.emojiScroll){var i=t.offsetTop,o=Math.max(i+30-r.emojiScroll.data.viewportHeight,Math.min(r.emojiScroll.data.scrollTop,i-30));r.emojiScroll.data.scrollTop!=o&&r.emojiScroll.scrollTop(o)}},anim:function(e,t){clearInterval(cur._imAnim);var r=Math.floor(300/13),i=0,o=domLC(e),n=domFC(e),a=t?0:45,s=t?45:0,c=t?1:0,l=t?0:1;cur._imAnim=setInterval((function(){var d=++i>=r?s:a+1.95*i*(t?1:-1),u=d-45,p=i>=r?l:c+1/(300/13)*i*(t?-1:1),_=1-p;o.style.WebkitTransform=o.style.OTransform=o.style.transform="rotate("+d+"deg)",n.style.WebkitTransform=n.style.OTransform=n.style.transform="rotate("+u+"deg)",o.style.opacity=p,n.style.opacity=_,i>=r&&(clearInterval(cur._imAnim),(t?addClass:removeClass)(e,"emoji_smile_on"),o.style.WebkitTransform=o.style.OTransform=o.style.transform=n.style.WebkitTransform=n.style.OTransform=n.style.transform=o.style.opacity=n.style.opacity="")}),13)},tplSmile:function(e){return'<div class="emoji_smile_wrap _emoji_wrap"><div class="emoji_smile _emoji_btn" title="'+e+'" onmouseover="return Emoji.show(this, event);" onmouseout="return Emoji.hide(this, event);" onclick="return cancelEvent(event);"><div class="emoji_smile_icon"></div></div></div>'},emojiToHTML:n.emojiToHTML,emojiReplace:n.emojiReplace,emojiRegex:Object(i.emojiRegex)(),getCode:function(e){var t=!1;if("emoji_css"==e.className)t=e.getAttribute("emoji");else if(-1!=e.className.indexOf("emoji")){var r=e.src&&e.src.match(/\/([a-f0-9*]+)(_2x)?.png/);t=r?r[1]:e.getAttribute("emoji")}return t},showProductSettings(e){sr(e,{settings:!0})},getTabCont:function(e,t){var r="";if(t){var i,o="",n="",a=hr.opts[e].forceStickerPack,s=lr(window.emojiStickers);try{for(s.s();!(i=s.n()).done;){var c=i.value,l=c[0],d=l===hr.TAB_RECENT_STICKERS,u=l===hr.TAB_FAVORITE_STICKERS,p=c[1],_=c[4]&&a==l;if(p||_){var h=c[8];if(hr.stickers.hasOwnProperty(l)){var m=hr.stickers[l],v=m.stickers,f=m.title,g=m.base_id,y='<div class="clear emoji_stickers_spliter" id="emoji_tab_cont_'+l+"_"+e+'"></div>';if(d)y+='<div class="emoji_recent_stickers_cont" id="emoji_recent_stickers_cont'+e+'">';else if(u)y+='<div class="emoji_favorite_stickers_cont" id="emoji_favorite_stickers_cont'+e+'">';else if(g&&!vk.widget){y+=`<div class="clear emoji_stickers_pack_header">\n          <div class="emoji_stickers_pack_title">${f}</div>\n          <a class="${Object(V.classNames)("emoji_stickers_pack_select_style",{"emoji_stickers_pack_select_style--new":h})}" href="javascript:void(0);" onclick="Emoji.showProductSettings(${g});">${Object(H.getLang)("purchases_stickers_select_style")}</a>\n        </div>`}var b,w=lr(v);try{for(w.s();!(b=w.n()).done;){var k=b.value;y+=hr.render.stickerRs(e,l,k)}}catch(e){w.e(e)}finally{w.f()}d?o=y+"</div>":u?n=y+"</div>":_?r=y+r:r+=y}}}}catch(e){s.e(e)}finally{s.f()}r=n+o+r}else r=hr.ttEmojiList(e);return r},updateStickersCont:function(e){var t=hr.opts[e],r=hr.getTabCont(e,hr.tabDefaultId);geByClass1("emoji_scroll_stickers",t.tt).innerHTML=r,t.initedStickers=1,t.imagesLoading=[],clearTimeout(t.preloadStickersTimer),hr.updateStickersPos(e)},updateStickersPos:function(e){for(var t=hr.opts[e],r=[],i=[],o=geByClass1("emoji_scroll_stickers",t.tt).firstChild,n=!1,a=!1;o;){if(!n&&hasClass(o,"emoji_recent_stickers_cont")?(o=o.firstChild,n=!0):!a&&hasClass(o,"emoji_favorite_stickers_cont")&&o.firstChild&&(o=o.firstChild,a=!0),hasClass(o,"emoji_sticker_item")){var s=o.id.replace("emoji_sticker_item","");r.push([s,o.offsetTop])}else if(hasClass(o,"emoji_stickers_spliter")){var c=o.id.replace("emoji_tab_cont_","").split("_");i.push([intval(c[0]),o.offsetTop])}(!o.nextSibling&&n||!o.nextSibling&&a)&&(o=o.parentNode),o=o.nextSibling}t.needLoadStickers=r,t.stickersSplitersPos=i},stickerItem:function(){return'<a id="emoji_sticker_item%optId%_%selId%_%stickerId%" data-opt-id="%optId%" data-sticker-id="%stickerId%" data-pack-id="%selId%" data-src="%stickerUrl%" data-fav="%fav%" data-fav-hash="%favHash%" class="emoji_sticker_item sticker_item_%stickerId% %favClass%" onclick="Emoji.stickerClick(%optId%, %stickerId%, %size%, \'%stickerUrl%\', this, \'%referrer%\');"></a>'},stickerItemAnimation:function(){return'<a id="emoji_sticker_item%optId%_%selId%_%stickerId%" data-opt-id="%optId%" data-uniq-id="%uniqId%" data-sticker-id="%stickerId%" data-pack-id="%selId%" data-src="%stickerUrl%" data-animation-path="%animationUrl%" data-fav="%fav%" data-fav-hash="%favHash%" class="emoji_sticker_item sticker_item_%stickerId% %favClass%" onclick="Emoji.stickerClick(%optId%, %stickerId%, %size%, \'%stickerUrl%\', this, \'%referrer%\');"></a>'},hintsStickerItemAnimation:function(){return'<a id="emoji_sticker_item%optId%_%selId%_%stickerId%" data-pack-id="%selId%" data-sticker-id="%stickerId%" class="emoji_sticker_item %class%" onclick="%onclick%" onmouseover="Emoji.stickerHintOver(this)" onmouseout="Emoji.stickerHintOut(this)" onmouseenter="StickersAnimation.loadAndPlaySticker(this);" data-animation-path="%animationUrl%" data-uniq-id="%uniqId%" data-sticker-id="%stickerId%"><img class="emoji_sticker_image sticker_img" src="%stickerUrl%" /></a>'},hintsStickerItem:function(){return'<a id="emoji_sticker_item%optId%_%selId%_%stickerId%" data-pack-id="%selId%" data-sticker-id="%stickerId%" class="emoji_sticker_item %class%" onclick="%onclick%" onmouseover="Emoji.stickerHintOver(this)" onmouseout="Emoji.stickerHintOut(this)"><img class="emoji_sticker_image" src="%stickerUrl%" /></a>'},tabSwitch:function(e,t,r,i){if(null!=e){var o=hr.opts[r],n=o.tt;"number"==typeof e&&(e=geByClass1("emoji_tab_"+e,n));var a=geByClass1("emoji_scroll_smiles",n),s=geByClass1("emoji_scroll_stickers",n),c=geByClass1("emoji_cats_title_helper",n);if(val(c,""),o.curEmojiCatId=null,t==hr.TAB_EMOJI)hide(s),show(a),show(c),o.emojiInited||(val(a,hr.getInitEmojiContent(r)),o.emojiInited=!0),o.imagesLoader&&o.imagesLoader.processLoad(),o.emojiOvered&&0===o.curTab&&hr.emojiOver(r,hr.getFirstEmojiEl(r)),o.curTab!=hr.TAB_EMOJI&&o.emojiScroll&&o.emojiScroll.scrollTop(0),hr.updateRecentEmoji(r),hr.updateEmojiCatTitle(r);else{hide(a),show(s),hide(c);var l=hr.stickers&&clone(hr.stickers);if(l&&delete l[hr.TAB_RECENT_STICKERS],!window.emojiStickers||!l||isEmpty(l)||!l[t]&&t!=hr.TAB_RECENT_STICKERS)hr.onStickersLoad=function(){hr.updateTabsOpt(r),hr.tabSwitch(t,t,r,i)},hr.stickersLoadingProgress(r,t,e),o.stickersInited=!1,o.curTab=null,hr.emojiLoadMore(r);else{var d=window.emojiStickers.find(e=>e[0]===t);d&&d[7]&&Ee(t,U.IsNew,0,!1).then(()=>{Array.from(document.querySelectorAll(".emoji_tab_"+t)).forEach(e=>{e.classList.remove("emoji_tab_is_new")})}),o.stickersInited||(hr.updateStickersCont(r),o.stickersInited=!0)}(o.curTab!=t||o.afterLoad)&&(hr.scrollToStickerPack(r,t,o.curTab==hr.TAB_EMOJI),o.afterLoad=0),hr.updateShownStickers(r,!0)}hr.onStickersLoad&&t!=hr.TAB_EMOJI||hr.selectTab(r,t,e)}},getFirstEmojiEl:function(e){for(var t=hr.opts[e],r=geByClass1("emoji_scroll_smiles",t.tt).firstChild;r;){if(hasClass(r,"emoji_smiles_row"))return r.firstChild;r=r.nextSibling}return null},getEmojiEl:function(e,t){for(var r,i=0,o=e.parentNode,n=0,a=o.firstChild;a&&(n++,a!==e);)a=a.nextSibling;for(;e&&!r;){if("left"==t||"right"==t)(r="left"==t?e.previousSibling:e.nextSibling)||("left"==t?(t="up",n=10):(t="down",n=1));else{if("up"!=t&&"down"!=t)break;for(var s=o;s&&(s="up"==t?s.previousSibling:s.nextSibling)&&!hasClass(s,"emoji_smiles_row"););if(!s)break;if(n&&s)for(var c=0,l=s.firstChild;l&&c<n;){if(++c>=n){r=l;break}l=l.nextSibling}if(r||!s)break;r="up"==t||n&&"down"==t?s.lastChild:s.firstChild}if(++i>20){debugLog("ERR!!");break}}return r},stickerClick:function(e,t,r,i,o,n){var a=hr.opts[e];if(!(Date.now()-a.ttShowT<hr.CLICK_DELAY||a.preventDoubleClick&&Date.now()-a.preventDoubleClick<hr.CLICK_DELAY)){hr.opts[e].preventDoubleClick=Date.now();var s=parseInt(attr(o,"data-pack-id")),c=!0;if(window.emojiStickers&&each(window.emojiStickers,(function(e,t){if(t[0]==s)return c=!!t[1],!1})),c){var l=hr.findRecentStickerIndex(t);-1!==l?hr.stickers[hr.TAB_RECENT_STICKERS].stickers.splice(l,1):hr.stickers[hr.TAB_RECENT_STICKERS]||(hr.stickers[hr.TAB_RECENT_STICKERS]={stickers:[]});var d=domData(o,"animation-path")||"",u=domData(o,"fav"),p=domData(o,"fav-hash");hr.stickers[hr.TAB_RECENT_STICKERS].stickers.unshift([t,r,i,d,u,p]),ls.set("recent_stickers",hr.stickers[hr.TAB_RECENT_STICKERS]),a.needUpdateRecentStickers=!0}a.onStickerSend&&a.onStickerSend(t,n,"animation"),statlogsValueEvent("stickers_usage",a.ref,t,n),hr.ttHide(e,!1,!1,!0),a.recentSticker=t}},stickerOver:function(e,t){var r={act:"a_stickers_hover",sticker_id:e,from:cur.module};if(isObject(t.tt)&&"IMG"===t.firstChild.nodeName)return t.tt.show();ajax.post("al_im.php",r,{onDone:function(e,r){var i=(cur.tooltips||[]).length,o=["subscribe_post_tt","sticker_extra_tt","sticker_extra_tt"+i,e.image?"":"tt_text_only"];if(o=o.join(" "),e.show){var n={index:i,className:o,content:r,shift:function(){return[-138,0,-200]},hasover:1,slideX:15,showsp:150,cache:1,forcetodown:!0,no_shadow:!0,dir:"left",onShowStart:function(e){var t=e.container,r=getSize(e.container)[1];if(!(r>=225)){var i=intval((225-r)/2)+10,o=intval(getStyle(t,"top",!0));setStyle(t,"top",o+i)}}};gpeByClass("_im_peer_history_w",t)&&(n.appendParentCls="_im_peer_history_w"),Object(F.showTooltip)(t,n)}}})},selectPeer:function(e){if(void 0!==e){var t=hr.opts[e];if(t.peer)return t.peer}var r=cur.peer||(cur.mbTo?cur.mbTo[0]:"");if(-3==r&&cur.wdd.imw_dd){var i=0;for(var o in cur.wdd.imw_dd.selected)cur.wdd.imw_dd.selected.hasOwnProperty(o)&&(r=cur.wdd.imw_dd.selected[o][0],i+=1);i>1&&(r="")}return r},showMyStickers:function(){cur.boxMyStickers=showBox("al_im.php",{act:"stickers_my"},{dark:1,stat:["im.css","imn.js",jsc("web/sorter.js")]})},getSelectedStickersStoreTabId(){var e=document.querySelector("#im_stickers_tabs");if(e){var t=e.querySelector(".ui_tab_sel");if(t)return dr(t.parentNode.id.match(/^tbt_stickers_(.*)$/)||[],2)[1]}},showStickersStore:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=hr.selectPeer(!1!==e?e:void 0),n=hr.opts[e];r=cr({},r,{act:"stickers_store",peer:o,box:1}),t&&(r.ref=t),cur.boxStickersStore=showBox("al_im.php",r,{dark:1,stat:["im.css","imn.js","page_help.css",jsc("web/sorter.js")],params:{onDestroy(){n&&n.onStoreHide&&n.onStoreHide(),cur.boxStickersStore=null}},onDone(){void 0!==i.scrollTop&&(De().scrollTop=i.scrollTop)}}),cur.boxStickersStore.reload=()=>{if(cur.boxStickersStore){var r=hr.getSelectedStickersStoreTabId(),i=De().scrollTop;cur.boxStickersStore.hide(),hr.showStickersStore(e,t,{tab:r},{scrollTop:i})}},each(geByClass("emoji_smile_icon_promo"),(function(e,t){geByClass1("emoji_smile_icon",t.parentNode),re(t)})),each(geByClass("emoji_shop_icon_badge"),(function(e,t){re(t)})),hr.hasNewStickers=!1},previewSticker:function(e,t,r,i){if(_r()){var o=(r=r||{}).peerId||hr.selectPeer(),n={recipientIds:o?[o]:[],preview_ref:r.sticker_referrer||"store"};return r.stickerId?ar(r.stickerId,n):sr(e,n),cancelEvent(i),!1}if(r=r||{},i&&checkEvent(i))return!0;var a={act:"sticker_preview",pack_id:e},s=hr.selectPeer();if(r.peer?a.peer=r.peer:s&&(a.peer=s),r.preview&&(a.preview=1),r.gift&&(a.gift=1),r.giftTo&&(a.gift_to=r.giftTo),r.stickerId&&(a.sticker_id=r.stickerId),a.sticker_referrer=r.sticker_referrer||"store",r.name){var c=nav.objLoc[0].split("/");"stickers"==c[0]&&c[1]!=r.name&&nav.setLoc({0:"stickers/"+r.name})}return cur.boxStickersPreview=showBox("al_im.php",a,{dark:1,stat:["im.css","imn.js"],onFail:function(t){if(window.cur.emojiStickersDisabled||(window.cur.emojiStickersDisabled={}),e&&(window.cur.emojiStickersDisabled[e]=!0),t)return!0}}),cancelEvent(i),!1},isStickerPackEnabled:function(e,t){var r=!1;if(!window.emojiStickers&&t)return ajax.post("al_im.php",{act:"a_stickers_list"},{onDone:function(e){window.emojiStickers=e,t()}}),0;if(!window.emojiStickers)return!1;for(var i in window.emojiStickers)if(window.emojiStickers.hasOwnProperty(i)&&window.emojiStickers[i][0]==e){r=!!window.emojiStickers[i][1];break}return r},clickSticker:function(e,t,r){if(window.cur.emojiStickersDisabled&&window.cur.emojiStickersDisabled[e])return!0;var i;if(t){if(0===(i=hr.isStickerPackEnabled(e,hr.clickSticker.pbind(e,t,r))))return!1;if(i){var o=!1;if(t.getAttribute("contenteditable"))o=t;else{for(var n=t.parentNode,a=!1;(n=n.parentNode)&&!hasClass(n,"js-im-page");){if(hasClass(n,"fc_tab")){a=!0;break}if(hasClass(n,"mv_chat"))break}if(!n)return!1;a?o=geByClass1("fc_editable",n):hasClass(n,"js-im-page")?o=geByClass1("_im_text"):hasClass(n,"mv_chat")&&(o=domByClass(n,"mv_chat_reply_input"))}if(o){var s=hr.opts[o.emojiId];hr.ttClick(o.emojiId,geByClass1("_emoji_btn",o.parentNode.parentNode),!1,!0);var c=geByClass1("emoji_tab_"+e,s.tt),l=hr.stickers&&clone(hr.stickers);l&&delete l[-1],!l||isEmpty(l)?(hr.onStickersLoad=hr.tabSwitch.pbind(e,e,o.emojiId),hr.stickersLoadingProgress(o.emojiId,e,c)):(s.initedStickers=0,hr.tabSwitch(c,e,o.emojiId))}}}return t&&i||hr.previewSticker(e,!1,{sticker_referrer:"message"}),r&&cancelEvent(r),!1},stickersLoadingProgress:function(e,t,r){var i=hr.opts[e];removeClass(geByClass1("emoji_tab_sel",i.tt),"emoji_tab_sel"),addClass(r,"emoji_tab_sel"),geByClass1("emoji_scroll_stickers",i.tt).innerHTML='<div class="emoji_scroll_progress">'+rs(vk.pr_tpl,{id:"",cls:"pr_big"})+"</div>"},buyStickers:function(e,t,r,i,o){if(r&&hasClass(r,"secondary"))return!0;if(_r())return Object(M.lockButton)(r),xe.create([e]).order({ref:o}).then(t=>{if(Object(M.unlockButton)(r),t&&!t.error){showDoneBox(Ve(t));try{vk.widget&&window.Rpc&&window.Rpc.callMethod("proxy","updateStickers")}catch(e){}"video_live"===o&&window.Videoview&&window.Videoview.onStickersPurchased(e),Object(l.partConfigEnabled)("stickers_catalog_reload_after_buy")&&(cur.boxStickersStore?cur.boxStickersStore.reload():nav.reload({params:{tab:hr.getSelectedStickersStoreTabId()},preventScroll:!0}))}}),cancelEvent(t);var n=hr.selectPeer();return ajax.post("/al_im.php",{act:"a_stickers_buy",pack_id:e,hash:i,peer:n,sticker_referrer:unclean(o)},{onDone:function(t,r,i,n,a,s){if(each(geByClass("_sticker_btn_"+e),(function(){this.innerHTML=n,this.onmouseover="",this.onclick="",addClass(this,"secondary")})),cur.boxStickersPreview&&cur.boxStickersPreview.hide(),a&&cur.boxStickersStore&&cur.boxStickersStore.hide(),showDoneBox(t),r){hr.stickers[hr.TAB_RECENT_STICKERS].promoted=s,hr.updateTabs(r,i,!0);try{vk.widget&&window.Rpc&&window.Rpc.callMethod("proxy","updateStickers")}catch(e){}"video_live"===o&&window.Videoview&&window.Videoview.onStickersPurchased(e)}var c=cur.tabbedStickersBox;if(c&&c.tbUpdate)for(var d in c.tbUpdate)c.tbUpdate.hasOwnProperty(d)&&(c.tbUpdate[d]=1);var u=cur.emojiId&&cur.emojiId[cur.peer];if(u){var p=geByClass1("emoji_tab_"+e,hr.opts[u].tt);p&&hr.tabSwitch(p,e,u)}Object(l.partConfigEnabled)("stickers_catalog_reload_after_buy")&&nav.reload({preventScroll:!0})},showProgress:M.lockButton.pbind(r),hideProgress:M.unlockButton.pbind(r),onFail:function(e){return e&&setTimeout(Object(D.showFastBox)(Object(H.getLang)("global_error"),e).hide,3e3),!0}}),cancelEvent(t)},stickerAct:function(e,t,r,i,o){if(o&&hasClass(e,"secondary"))return!0;var n=(o?hasClass(e,"secondary"):hasClass(e,"_im_sticker_activated"))?1:0,a=cur.tabbedStickersBox;if(a)for(var s in a.tbUpdate)a.tbUpdate.hasOwnProperty(s)&&(a.tbUpdate[s]=1);return ajax.post("/al_im.php",{act:"a_stickers_switch",pack_id:t,hash:r,state:n,from_btn:o?1:0},{onDone:function(r,i,a,s){o||(e.innerHTML=r,e.onmouseover="",setStyle(e,{width:"auto"}),toggleClass(e,"_im_sticker_activated",!n)),each(geByClass("_sticker_btn_"+t),(function(){this.innerHTML=s,this.onmouseover="",toggleClass(this,"secondary",!n)})),hr.updateTabs(i,a,!0);var c=e.parentNode.parentNode;if(!o){if(cur.stickersSorter.destroy(),n){show("im_stickers_deact");var l=ge("im_stickers_deact_wrap");l.firstChild?l.insertBefore(c,l.firstChild):l.appendChild(c),setStyle(c,{cursor:"default"})}else{geByTag1("div","im_stickers_my_wrap").appendChild(c),ge("im_stickers_deact_wrap").childNodes.length||hide("im_stickers_deact")}cur.stickersSorterInit()}},showProgress:M.lockButton.pbind(e),hideProgress:M.unlockButton.pbind(e)}),cancelEvent(i)},getTabsCode:function(e,t){var r=[];e&&r.push.apply(r,e),r.length>1&&(hr.hasNewStickers=!1);for(var i=hr.opts[t].forceStickerPack,o="",n="",a=0,s=r;a<s.length;a++){var c=s[a],l=c[0],d=c[1],u=c[3],p=c[4]&&l===i,_=c[5];if(d||u||p){var h=c[6],m=c[7],v=c[8],f=void 0;if(d||p?(l>0&&-1===hr.stickerPacksToLoad.indexOf(l)&&hr.stickerPacksToLoad.push(l),f="Emoji.tabSwitch(this, "+l+", "+t+"); return cancelEvent(event);"):f="Emoji.previewSticker("+l+", false, {sticker_referrer: 'keyboard'}); return cancelEvent(event);",c[2]&&(hr.hasNewStickers=c[2]),l===hr.TAB_RECENT_STICKERS){var g="emoji_tab emoji_tab_img_cont emoji_tab_recent emoji_tab_"+l;cur.stickersTab==l&&(g+=" emoji_tab_sel"),o+='<a class="'+g+'" onmousedown="'+f+'" onclick="return cancelEvent(event);"><span class="emoji_tab_icon emoji_sprite emoji_tab_icon_recent"></span></a>'}else if(l===hr.TAB_FAVORITE_STICKERS)o+=hr.tabs.favoriteTabContent(f,h);else if(l){var y="emoji_tab emoji_tab_img_cont emoji_tab_"+l;(m||v)&&(y+=" emoji_tab_is_new"),cur.stickersTab==l&&(y+=" emoji_tab_sel"),d||p||(y+=" emoji_tab_promo");var b='<a class="'+y+'" onmousedown="'+f+'" onclick="return cancelEvent(event);"><img width="22" height="22" src="'+_+'" class="emoji_tab_img" /></a>';p?n=b+n:n+=b}else{var w="emoji_tab emoji_tab_"+l;cur.stickersTab==l&&(w+=" emoji_tab_sel"),d||(w+=" emoji_tab_promo"),o+='<a class="'+w+'" onmousedown="'+f+'" onclick="return cancelEvent(event);"><div class="emoji_tab_icon emoji_sprite emoji_tab_icon_'+l+'"></div></a>'}}}return o+n},updateTabsOpt:function(e,t){var r=hr.opts[e];if(!r.noStickers){var i=ge("emoji_tabs_cont_"+e);i&&(i.innerHTML=hr.getTabsCode(window.emojiStickers,e)),hr.checkEmojiSlider(r),hr.checkNewStickers(r),void 0!==typeof t&&(r.stickersInited=!!t)}},updateTabs:function(e,t,r){e&&r&&window.Notifier&&Notifier.lcSend("emoji",{act:"updateTabs",newStickers:e,keywords:t});var i=0;for(var o in void 0===t?(hr.initStickersKeywords(),window.stickersKeywordsData||(i=1)):(window.stickersKeywordsData=t,hr.setStickersKeywords(window.stickersKeywordsData,r)),void 0===e?window.emojiStickers&&window.stickersKeywordsData||ajax.post("al_im.php",{act:"a_stickers_list",need_keywords:i,cache_time:hr.cachedStickersKeywordsTime()},{onDone:hr.updateTabs}):window.emojiStickers=e,hr.opts)hr.opts.hasOwnProperty(o)&&hr.updateTabsOpt(o,!1);var n=hr.stickers&&clone(hr.stickers);n&&delete n[hr.TAB_RECENT_STICKERS],hr.onStickersLoad&&window.emojiStickers&&!isEmpty(n)&&(hr.onStickersLoad(),hr.onStickersLoad=!1)},checkNewStickers:function(e){var t=e.txt;if(!e.noStickers&&!e.noStickersStore&&window.emojiStickers&&t&&t.getAttribute("contenteditable")){for(var r in window.emojiStickers)if(window.emojiStickers.hasOwnProperty(r)&&window.emojiStickers[r][2]){hr.hasNewStickers=window.emojiStickers[r][2];break}hr.hasNewStickers<0&&!hr.noNewStickers&&setTimeout((function(){each(geByClass("emoji_smile_icon"),(function(e,t){var r=t.parentNode;geByClass1("emoji_smile_icon_promo",r)||(r.appendChild(ce("div",{className:"emoji_smile_icon_promo"})),addEvent(t,"mouseover",(function(){Object(F.showTooltip)(this,{text:Object(H.getLang)("global_store_stickers_new_available"),shift:[7,1,4],showdt:0,black:1})})))}))}),hasClass(t,"fc_editable")?200:0)}},checkEmojiSlider:function(e){var t=geByClass1("emoji_tabs_wrap",e.tt),r=!1;if(t){if(t.firstChild.clientWidth&&t.firstChild.clientWidth>t.clientWidth+t.scrollLeft)r=!0;else{var i=t.firstChild.childNodes;i.length>6&&(e.scrollLeft||0)<34*(i.length-6)-16&&(r=!0)}var o=vk.rtl?"l":"r";r?(e.sliderShown=!0,hr.scrollToggleArrow(!0,o,e,!0)):e.sliderShown&&(e.sliderShown=!1,hr.scrollToggleArrow(!1,o,e,!0))}},giftSticker:function(e,t,r,i){if(_r())return Xt([e],String(t).split(",").map(e=>Number(e)),{ref:i.sticker_referrer||"store",gift_ref:i.ref}),cancelEvent(r);var o={act:"stickers_gift_box",pack_id:e,peers:t,ref:(i=i||{}).ref};return i.from&&(o.from=i.from),o.sticker_referrer=i.sticker_referrer||"store",boxLayerWrap.scrollTop=0,showBox("/al_im.php",o,{stat:["wide_dd.js","wide_dd.css","notifier.css","notifier.js"],dark:1}),cancelEvent(r)},showStickerTT:function(e){var t=e.getAttribute("data-title");t&&Object(F.showTooltip)(e,{text:t,slide:15,shift:[74-getSize(e)[0]/2,120,5],className:"sticker_hint_tt",hasover:1})},scrollToStickerPack:function(e,t,r){var i=hr.opts[e],o=ge("emoji_tab_cont_"+t+"_"+e),n=o&&t!=hr.tabDefaultId?o.offsetTop+getSize(o)[1]:0;i.scrollAnimation=1,i.emojiScroll.scrollTop(n,r?0:200,(function(){i.scrollAnimation=0})),hr.scrollToTab(t,e)},toggleStickers:function(e,t){var r=hr.opts[e];r&&r.tt?(r.noStickers=t,toggleClass(r.tt,"emoji_no_tabs",t),r.curTab&&hr.tabSwitch(0,0,e)):r&&(r.hideStickersInitial=t)},getSizeCached:function(e){return(e=ge(e))?(void 0!==e[hr.CACHED_WIDTH_PROP]&&void 0!==e[hr.CACHED_HEIGHT_PROP]||(e[hr.CACHED_WIDTH_PROP]=e.offsetWidth,e[hr.CACHED_HEIGHT_PROP]=e.offsetHeight),[e[hr.CACHED_WIDTH_PROP],e[hr.CACHED_HEIGHT_PROP]]):[0,0]},clearSizeCached:function(e){(e=ge(e))&&(e[hr.CACHED_WIDTH_PROP]=void 0,e[hr.CACHED_HEIGHT_PROP]=void 0)},getStickerReferrer:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=hr.opts[t];return r&&"stories"===r.ref?hr.STICKER_REFERRERS.STORY_KEYBOARD:e===hr.TAB_RECENT_STICKERS?hr.STICKER_REFERRERS.RECENT:e===hr.TAB_FAVORITE_STICKERS?hr.STICKER_REFERRERS.FAVORITE:hr.STICKER_REFERRERS.KEYBOARD},render:{sticker:function(e,t,r){var i=hr.render.stickerRs(e,t,r);return se(i)},stickerRs:function(e,t,r){var i={optId:e,selId:t,stickerId:r[0],size:r[1]?r[1]:256,stickerUrl:r[2],fav:r[4]||"",favHash:r[5]||"",referrer:hr.getStickerReferrer(t,e),favClass:r[4]?"faved":""},o="";if(browser.msie&&!browser.msie_edge||!r[3])o=hr.stickerItem();else{o=hr.stickerItemAnimation();var n=rand(1,1e5);i.animationUrl=r[3],i.uniqId=n}return rs(o,i)},stickerHintRs:function(e,t,r){var i=t,o="";if(t<0)o=window.promotedStickerUrls&&window.promotedStickerUrls[-i];else if(r)o=r[2];else{var n=ve(i);n&&(o=ae(n,64,64))}var a=r?r[3]:"",s={optId:e,selId:0,stickerId:i,stickerUrl:o,class:i<0?"promo":"",onclick:"Emoji.stickerHintClick("+e+", "+i+", '"+o+"', this)"},c="";return(!browser.msie||browser.msie_edge)&&a&&o?(c=hr.hintsStickerItemAnimation(),s.animationUrl=a,s.class+=" sticker_animation"):o&&(c=hr.hintsStickerItem()),rs(c,s)},stickerContent:function(e,t,r){var i=attr(t,"data-animation-path"),o=attr(t,"data-src"),n="/images/blank.gif";r||(n=o);var a=attr(t,"data-sticker-id"),s=attr(t,"data-fav-hash"),c=attr(t,"data-fav"),l="";i?l='<div data-uniq-id="'+attr(t,"data-uniq-id")+'" onmouseenter="StickersAnimation.loadAndPlaySticker(this);" class="sticker_animation" data-sticker-id="'+a+'" data-animation-path="'+i+'"><img class="sticker_img emoji_sticker_image" src="'+n+'" data-src="'+o+'"/></div>':l='<img class="emoji_sticker_image" src="'+n+'" data-src="'+o+'"/>';if(hr.favoriteAvailable){var d="";1==c&&(d="on"),l+=`<span role="link"\n               onmouseover="Emoji.favorite.reminder(this)"\n               class="emoji_sticker_item_fav ${d}"\n               data-sticker-id="${a}"\n               data-hash="${s}"\n               onmousedown="Stickers.toggleFavorite(this, event, ${e}); cancelEvent(event);"\n               onclick="cancelEvent(event)"></span>`}return val(t,l),o}},__eof:1}},nTq2:function(e,t,r){"use strict";r.r(t),r.d(t,"Likes",(function(){return w}));r("91GP"),r("rGqo"),r("Btvt"),r("hhXQ"),r("pIFo"),r("SRfc");var i=r("zxIV"),o=r("Egk5"),n=r("FWc3"),a=r("t7n3"),s=r("7jxN"),c=r("/PiP"),l=r("jE6c"),d=r("EasH"),u=r("4+be"),p=r("ha24"),_=r("pruO"),h=r("60IB"),m=r("jXbq");function v(){return(v=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}var f="like",g="share",y="views",b="comment",w={toggle(e,t,r,n){if(Object(o.cancelEvent)(t),Object(l.isObject)(window.cur)&&Object(l.isFunction)(cur.viewAsBox))return cur.viewAsBox();if(vk.widget&&!vk.id)return window.Widgets.oauth();var a=Object(i.hasClass)(e,"active");Object(i.addClass)(e,"animate"),this.clientUpdate(r,f,a?-1:1,!a);var s=()=>{Object(i.toggleClass)(e,"active",a),this.clientUpdate(r,f,a?1:-1,a)};window.ajax.post("like.php",{act:a?"a_do_unlike":"a_do_like",object:r,hash:n,list:cur.pvListId,wall:2,from:this._getReference(r),from_widget:vk.widget?1:0},{onDone:t=>{if(t.unauth_action_box)return s(),void m.UnauthActionBox.show(t.unauth_action_box);this.update(r,t);var i=r.match(/^(wall|market)(.*)/);i&&cur.onLike&&cur.onLike(e,i[1],i[2],a)},onFail:()=>(s(),!1)}),Object(l.intval)(Object(i.domData)(e,"count"))>0?w.showLikes(e,r,{fast:!0}):e.tt&&e.tt.destroy&&e.tt.destroy()},_getReference:e=>cur.pvShown?"photo_viewer":e===cur.wallLayer?"wkview":window.mvcur&&window.mvcur.mvShown?"videoview":cur.wallType?"feed"===cur.wallType?"news"===cur.section?"feed_"+(cur.subsection?cur.subsection:cur.section):"recommended"===cur.section?"feed_recommended"+("recent"!==cur.subsection?"_"+cur.subsection:""):Object(a.inArray)(cur.section,["friends","groups","videos","photos"])?"feed_"+(cur.subsection?"_"+cur.subsection:""):"feed_"+cur.section:"top"===cur.wallType?"wall_top":"wall_"+(cur.onepost?"one":(cur.wallType||"").indexOf("full_")?"page":"full"):cur.module,share(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(vk.widget&&!vk.id)return window.Widgets.oauth();if(Object(l.isObject)(window.cur)&&Object(l.isFunction)(cur.viewAsBox))return cur.viewAsBox();var r=Object(p.parseLikeObjectId)(e),i=r.objectType,o=r.objectId;(vk.widget?window.showBox:d.showBox)("like.php",v({act:"publish_box",object:e,from_widget:vk.widget?1:0},t),{onDone:(e,t)=>{t.unauth_action_box&&(e.hide(),m.UnauthActionBox.show(t.unauth_action_box))},stat:["page.js","page.css","wide_dd.js","wide_dd.css",window.jsc("web/sharebox.js")]}),"wall"===i&&window.Wall&&window.Wall.triggerAdPostStat(o,"share_post"),cur.RpcMethods&&(cur.RpcMethods.likeFullUpdate=t=>w.update(e,window.cleanObj(t)))},clientUpdate(e,t,r,o){var n=this._getButtonsByType(e,t);if(n.length){var a=Object(l.intval)(Object(i.domData)(n[0],"count"))+r;this._updateDom(e,t,a,o),this.updateExternalIndex(e,{type:t,count:a,isActive:o})}},update(e,t){if(!isNaN(parseInt(t.like_num))){var r=Object(l.isUndefined)(t.like_my)?void 0:!!Object(l.intval)(t.like_my);this._updateDom(e,f,t.like_num,r,t.like_title),this.updateExternalIndex(e,{type:f,count:t.like_num,isActive:r})}if(!isNaN(parseInt(t.share_num))){var i=Object(l.isUndefined)(t.share_my)?void 0:!!Object(l.intval)(t.share_my);this._updateDom(e,g,t.share_num,i,t.share_title),this.updateExternalIndex(e,{type:g,count:t.share_num})}Object(a.isNumeric)(t.views_num)&&this._updateDom(e,y,t.views_num,void 0,t.views_title),Object(a.isNumeric)(t.comment_num)&&this._updateDom(e,b,t.comment_num),t[_.REACTIONS_COUNTS_RESPONSE_FIELD]&&Object(h.triggerReactionsUpdate)(e,t[_.REACTIONS_COUNTS_RESPONSE_FIELD])},updateComments(e,t){this.update(e,{comment_num:t})},_updateDom(e,t,r,o,n){var c=this._getButtonsByType(e,t),d=t===y,_="";d?_=r:r>0&&(_=vk.widget?Object(a.formatCount)(r):Object(u.langNumeric)(r,"%s",!0)),d||(r=Object(l.intval)(r));for(var h=0;h<c.length;h++){var m=c[h];if(!Object(i.hasClass)(m,"no_counter")){var v=d?c[h]:Object(p.getElementLikeButtonCount)(c[h]);Object(s.animateCount)(v,_,{str:"auto",noWrapWidth:!d,noSpaceIfEmpty:!0}),Object(i.toggleClass)(m,"empty",r<=0),"boolean"==typeof o&&Object(i.toggleClass)(m,"active",o),Object(i.attr)(c[h],"data-count",r),d&&Object(i.attr)(c[h],"title",n||"");var b=c[h].tt;if(b){var w=Object(i.domByClass)(b.container,"_content"),k=Object(i.domByClass)(b.container,"_value"),S=Object(i.domByClass)(b.container,"_title"),j=Object(l.intval)(Object(i.val)(k));Object(i.val)(k,r),n&&Object(i.val)(S,n),Object(l.isObject)(b)&&(b.likeInvalidated=!0),(j!==r&&j<7||!1===n)&&(t===f?m.needReinitLikesTT=!0:t===g&&(m.needReinitShareTT=!0)),t===f&&Object(i.toggleClass)(w,"me_hidden",!o),!1===n&&b.destroy&&b.destroy()}}}},_getButtonsByType:(e,t)=>Object(i.domQuery)(`._like_${e} ._${t}`),showLikes(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!(e.postDontShowLikes||vk.widget&&vk.show_external_auth_box)){var o=r.views?{views:1}:r.share?{published:1}:{};r.listId&&(o.list=r.listId);var s,c,d=!!Object(i.geByClass1)("share",Object(i.gpeByClass)("like_wrap",e)),u=getComputedStyle(e),p=Object(l.intval)(u.getPropertyValue("padding-left").replace("px","")),_=Object(l.intval)(u.getPropertyValue("padding-top").replace("px","")),h=Object(i.geByClass1)("like_button_icon",e),m=[40-Object(i.getSize)(h)[0]/2-p,10-_],v=r.cl||"";if(r.share)v+="likes_tt_share";else if(v+="likes_tt_like","wpost"===r.from)m[0]=12;else if("widget_community"===r.from)m[0]=6;else if("wcomments"===r.from||"widget_comments"===cur.wallType){m[0]=Object(i.getSize)(e)[0]+16-Object(i.getSize)(h)[0]/2-10}else"photo_carousel"===r.from&&(m[1]=10);r.share?(s="needReinitLikesTT",c="resetLikesTTTimer"):(s="needReinitShareTT",c="resetShareTTTimer"),clearTimeout(e[c]),Object(n.showTooltip)(e,{url:"/like.php",params:Object(a.extend)({act:"a_get_stats",object:t,has_share:d?1:""},o),appendEl:document.body,slide:15,shift:m,ajaxdt:r.fast?0:100,showdt:r.fast?0:400,hidedt:200,dir:"auto",checkLeft:!0,reverseOffset:80,noZIndex:!0,hasover:!0,tip:{over:()=>{w.showLikes(e,t,r)}},typeClass:"like_tt",className:v,onHide:()=>{clearTimeout(e[c]),e[s]&&(e[c]=setTimeout(()=>{delete e[s],e.tt&&e.tt.destroy&&e.tt.destroy()},200))}})}},showShare:function(e,t,r){w.showLikes(e,t,Object(a.extend)(r,{share:1}))},updateViews:function(e){vk.widget&&vk.show_external_auth_box||window.ajax.post("like.php",{act:"a_get_stats",object:e,views:1},{cache:1,onDone(t,r){var o=Object(i.ce)("div",{innerHTML:r});w._updateDom(e,y,t,void 0,o.innerText||o.textContent)}})},makeTemplate(e,t){if(!e)return"";(t=Object(a.extend)({buttons_prepend:"",object_raw:"",likes_count:"",liked:!1,share_count:"",shared:"",views_count:"",share_opts:{},like_opts:{},class_name:"",like_cont_class:"",like_class_name:"",[_.REACTIONS_COUNTS_RESPONSE_FIELD]:"",reactions_class_name:""},t)).like_active=t.liked?"active":"",t.share_active=t.shared?"active":"",t.comment_active="",t.likes_formatted_count=t.likes_count>0?Object(u.langNumeric)(t.likes_count,"%s",!0):"",t.share_formatted_count=t.share_count>0?Object(u.langNumeric)(t.share_count,"%s",!0):"",t.share_opts=this._convertOptsToString(t.share_opts),t.like_opts=this._convertOptsToString(t.like_opts),t.like_class_name+=t.likes_count>0?"":" empty",t.share_class_name=t.share_count>0?"":"empty";var r=t[_.REACTIONS_COUNTS_RESPONSE_FIELD],o=!!r&&Object.values(r).some(e=>!!e);return t.reactions_class_name+=o?"":" empty",Object(i.rs)(e,t)},_convertOptsToString:e=>JSON.stringify(e).replace(/\"/g,"'"),updateExternalIndex(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=Object(p.parseLikeObjectId)(e),i=r.objectType,o=r.objectId;switch(i){case"photo":if(!cur.pvShown||!cur.pvCurPhoto||cur.pvCurPhoto.id!==o)return;var n=cur.pvListId,a=cur.pvIndex,s=cur.pvData[n][a];t.type===f?(s.likes=t.count,s.liked=t.isActive,cur.pvCommsLikes[s.id][1]=t.count):t.type===g&&(s.shares=t.count);break;case"video":if(window.mvcur&&window.mvcur.mvShown&&window.mvcur.videoRaw===o&&t.type===f){var c=window.Videoview.getMvData();c.likes=t.count,void 0!==t.isActive&&(c.liked=t.isActive,window.Videoview.playerOnLiked(t.isActive),window.Videoview.recache())}}},showLikesList(e,t){cur.viewAsBox||Object(i.hasClass)(Object(i.gpeByClass)("like_btn",e),"no_counter")||Object(c.showWiki)({w:"likes/"+Object(a.clean)(t)},!1,!1,{queue:1})},showSharesList(e,t){cur.viewAsBox||Object(i.hasClass)(Object(i.gpeByClass)("like_btn",e),"no_counter")||Object(c.showWiki)({w:"shares/"+Object(a.clean)(t)},!1,!1,{queue:1})}}},pQ8y:function(e,t,r){"use strict";r.r(t);var i=r("wx14"),o=r("zLVn"),n=r("dI71");r("17x9");function a(e,t){return e.replace(new RegExp("(^|\\s)"+t+"(?:\\s|$)","g"),"$1").replace(/\s+/g," ").replace(/^\s*|\s*$/g,"")}var s=r("q1tI"),c=r.n(s),l=r("dRu9"),d=function(e,t){return e&&t&&t.split(" ").forEach((function(t){return i=t,void((r=e).classList?r.classList.remove(i):"string"==typeof r.className?r.className=a(r.className,i):r.setAttribute("class",a(r.className&&r.className.baseVal||"",i)));var r,i}))},u=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).appliedClasses={appear:{},enter:{},exit:{}},t.onEnter=function(e,r){t.removeClasses(e,"exit"),t.addClass(e,r?"appear":"enter","base"),t.props.onEnter&&t.props.onEnter(e,r)},t.onEntering=function(e,r){var i=r?"appear":"enter";t.addClass(e,i,"active"),t.props.onEntering&&t.props.onEntering(e,r)},t.onEntered=function(e,r){var i=r?"appear":"enter";t.removeClasses(e,i),t.addClass(e,i,"done"),t.props.onEntered&&t.props.onEntered(e,r)},t.onExit=function(e){t.removeClasses(e,"appear"),t.removeClasses(e,"enter"),t.addClass(e,"exit","base"),t.props.onExit&&t.props.onExit(e)},t.onExiting=function(e){t.addClass(e,"exit","active"),t.props.onExiting&&t.props.onExiting(e)},t.onExited=function(e){t.removeClasses(e,"exit"),t.addClass(e,"exit","done"),t.props.onExited&&t.props.onExited(e)},t.getClassNames=function(e){var r=t.props.classNames,i="string"==typeof r,o=i?""+(i&&r?r+"-":"")+e:r[e];return{baseClassName:o,activeClassName:i?o+"-active":r[e+"Active"],doneClassName:i?o+"-done":r[e+"Done"]}},t}Object(n.default)(t,e);var r=t.prototype;return r.addClass=function(e,t,r){var i=this.getClassNames(t)[r+"ClassName"];"appear"===t&&"done"===r&&(i+=" "+this.getClassNames("enter").doneClassName),"active"===r&&e&&e.scrollTop,this.appliedClasses[t][r]=i,function(e,t){e&&t&&t.split(" ").forEach((function(t){return i=t,void((r=e).classList?r.classList.add(i):function(e,t){return e.classList?!!t&&e.classList.contains(t):-1!==(" "+(e.className.baseVal||e.className)+" ").indexOf(" "+t+" ")}(r,i)||("string"==typeof r.className?r.className=r.className+" "+i:r.setAttribute("class",(r.className&&r.className.baseVal||"")+" "+i)));var r,i}))}(e,i)},r.removeClasses=function(e,t){var r=this.appliedClasses[t],i=r.base,o=r.active,n=r.done;this.appliedClasses[t]={},i&&d(e,i),o&&d(e,o),n&&d(e,n)},r.render=function(){var e=this.props,t=(e.classNames,Object(o.default)(e,["classNames"]));return c.a.createElement(l.default,Object(i.default)({},t,{onEnter:this.onEnter,onEntered:this.onEntered,onEntering:this.onEntering,onExit:this.onExit,onExiting:this.onExiting,onExited:this.onExited}))},t}(c.a.Component);u.defaultProps={classNames:""},u.propTypes={};t.default=u},ppaw:function(e,t,r){"use strict";var i,o,n,a,s;r.r(t),r.d(t,"EditorModeType",(function(){return i})),r.d(t,"EditorTabKey",(function(){return o})),r.d(t,"EditorViewType",(function(){return n})),r.d(t,"EditorSectionType",(function(){return a})),r.d(t,"GridSelectType",(function(){return s})),function(e){e[e.create=0]="create",e[e.edit=1]="edit"}(i||(i={})),function(e){e.all="all",e.selected="selected"}(o||(o={})),function(e){e.box="box",e.page="page"}(n||(n={})),function(e){e.main="main",e.cover="cover"}(a||(a={})),function(e){e[e.none=0]="none",e[e.checkbox=1]="checkbox",e[e.radio=2]="radio"}(s||(s={}))},pruO:function(e,t,r){"use strict";r.r(t),r.d(t,"SUPPORTED_OBJECT_TYPES",(function(){return i})),r.d(t,"SIZE_MENU",(function(){return o})),r.d(t,"SIZE_PREVIEW",(function(){return n})),r.d(t,"REACTIONS_COUNTS_RESPONSE_FIELD",(function(){return a}));var i={wall:"wall",wall_reply:"wall_reply"},o={width:96,height:96},n={width:48,height:48},a="reactions_counts"},qrY5:function(__webpack_module__,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var core_js_modules_es6_regexp_replace__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("pIFo"),_web_lib_dom_events__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("Egk5"),_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("zxIV"),_web_lib_utils_common__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("t7n3"),_web_lib_scroll__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("lXE5"),_web_lib_debug_tools__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("98sY"),_web_legacy_ui_ui_scroll__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("59zB"),uiActionsMenu={keyToggle:function(e,t){if(!Object(_web_lib_dom_events__WEBPACK_IMPORTED_MODULE_1__.checkKeyboardEvent)(t))return!1;var r=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.domClosest)("_ui_menu_wrap",e);r&&uiActionsMenu.toggle(r,!hasClass(r,"shown"))},toggle:function toggle(el,s,options){var dummyMenu=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(el,"dummyMenu");dummyMenu&&(el=dummyMenu),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.toggleClass)(el,"shown",s);var onhide=attr(el,"onHide");if(onhide&&!hasClass(el,"shown"))try{eval(onhide)}catch(e){Object(_web_lib_debug_tools__WEBPACK_IMPORTED_MODULE_5__.logEvalError)(e,onhide)}if(options&&options.onToggle){var script=options.onToggle.replace("{isShow}",""+s);try{eval(script)}catch(e){Object(_web_lib_debug_tools__WEBPACK_IMPORTED_MODULE_5__.logEvalError)(e,script)}}},show:function(e,t,r){var i=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidetimer");i&&(clearTimeout(i),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidetimer",0));var o=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"origMenu");if(o&&(i=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(o,"hidetimer"))&&(clearTimeout(i),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidetimer",0)),r&&r.delay){cur.uiActionsMenuShowTimeout&&clearTimeout(cur.uiActionsMenuShowTimeout);var n=r.delay;return delete r.delay,void(cur.uiActionsMenuShowTimeout=setTimeout(uiActionsMenu.show.pbind(e,t,r),n))}if(cur.uiActionsMenuShowTimeout&&(clearTimeout(cur.uiActionsMenuShowTimeout),delete cur.uiActionsMenuShowTimeout),r&&r.appendParentCls){var a,s,c=geByClass1("_ui_menu",e);if(c){s=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.domClosest)(r.appendParentCls,c),a=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.domClosest)("_ui_menu_wrap",e);var l=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.se)(`<div class="${a.className} ui_actions_menu_dummy_wrap" onmouseover="uiActionsMenu.show(this);" onmouseout="uiActionsMenu.hide(this);"></div>`);if(l.appendChild(c),s.appendChild(l),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"dummyMenu",l),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(l,"origMenu",e),e=l,Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(c,"top",Object(_web_lib_utils_common__WEBPACK_IMPORTED_MODULE_3__.intval)(Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getStyle)(c,"top"))),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(c,"left",Object(_web_lib_utils_common__WEBPACK_IMPORTED_MODULE_3__.intval)(Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getStyle)(c,"left"))),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(c,"right",Object(_web_lib_utils_common__WEBPACK_IMPORTED_MODULE_3__.intval)(Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getStyle)(c,"right"))),r.processHoverCls){var d=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.domClosest)(r.processHoverCls,a);addEvent(e,"mouseover",addClass.pbind(d,"hover")),addEvent(e,"mouseout",removeClass.pbind(d,"hover"))}}else e=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"dummyMenu");var u=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"origMenu");c=geByClass1("_ui_menu",e),a=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.domClosest)("_ui_menu_wrap",u),s=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.domClosest)(r.appendParentCls,c),setStyle(c,{display:"block"});var p=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getXY)(s),_=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getXY)(a),h=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(c,"top"),m=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(c,"left"),v=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(c,"right"),f={top:_[1]-p[1]+h};v?f.right=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getSize)(s)[0]+p[0]-_[0]-Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getSize)(a)[0]+v:f.left=_[0]-p[0]+m,setStyle(c,f)}var g=geByClass1("_ui_menu",e);if(r&&r.autopos&&g&&!hasClass(e,"shown")){removeClass(e,"ui_actions_menu_left");var y=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getXY)(e)[1],b=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getSize)(e)[1],w=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getSize)(g)[1],k=r.dy||10,S=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getXY)(g)[0];removeClass(e,"ui_actions_menu_top"),addClass(e,"no_transition"),y+b+k+w>Object(_web_lib_scroll__WEBPACK_IMPORTED_MODULE_4__.scrollGetY)()+(window.lastWindowHeight||0)&&addClass(e,"ui_actions_menu_top"),y-k-w<Object(_web_lib_scroll__WEBPACK_IMPORTED_MODULE_4__.scrollGetY)()+Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.getSize)("page_header_wrap")[1]&&removeClass(e,"ui_actions_menu_top"),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.toggleClass)(e,"ui_actions_menu_left",S<0),removeClass(e,"no_transition")}r&&r.hasOwnProperty("alwaysTop")&&g&&!hasClass(e,"shown")&&(removeClass(e,"ui_actions_menu_top"),r.alwaysTop&&addClass(e,"ui_actions_menu_top")),r&&r.scroll&&r.maxHeight&&(g.style.maxHeight=(Object(_web_lib_utils_common__WEBPACK_IMPORTED_MODULE_3__.intval)(r.maxHeight)||200)+"px",g.__uiScroll__||new _web_legacy_ui_ui_scroll__WEBPACK_IMPORTED_MODULE_6__.default(g)),uiActionsMenu.toggle(e,!0,r)},hide:function(e,t,r){cur.uiActionsMenuShowTimeout&&(clearTimeout(cur.uiActionsMenuShowTimeout),delete cur.uiActionsMenuShowTimeout);var i=Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidedelay");i?Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidedelay",!1):i=200,Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidetimer")||Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidetimer",setTimeout((function(){uiActionsMenu.toggle(e,!1,r),Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidetimer",0)}),i))},hideDelay:function(e,t){Object(_web_lib_dom__WEBPACK_IMPORTED_MODULE_2__.data)(e,"hidedelay",t)}};__webpack_exports__.default=uiActionsMenu},rJNF:function(e,t,r){"use strict";r.r(t),r.d(t,"showNarrativeEditorBox",(function(){return se})),r.d(t,"showNarrativeBox",(function(){return ce})),r.d(t,"showNarrativeChooseBox",(function(){return le})),r.d(t,"showNarrativeCreateLiteBox",(function(){return de})),r.d(t,"showStoryLinkEditorBox",(function(){return ue}));var i,o=r("q1tI"),n=r.n(o),a=r("ppaw"),s=r("vkmG"),c=r("dV62"),l=r("jmhT"),d=r("BiHW"),u=r("6krn"),p=function(e){var t=e.title,r=e.count,i=void 0===r?0:r;return n.a.createElement("div",{className:"NarrativeBoxTitle"},t,i>0&&n.a.createElement("span",{className:"NarrativeBoxTitle__count"},i))};!function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(i||(i={}));var _,h,m=r("XuKo"),v=r("ZxpX"),f=function(){return(f=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},g=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(r[i[o]]=e[i[o]])}return r},y=n.a.memo((function(e){var t=e.id,r=e.title,i=e.subtitle,o=e.preview,a=e.aside,c=e.href,l=e.onClick,d=e.className,u=void 0===d?"":d,p=g(e,["id","title","subtitle","preview","aside","href","onClick","className"]),_=null;return r=Object(s.decodeHTMLEntities)(r),_=c?n.a.createElement("a",{href:c,className:"NarrativeRowBaseItem__title",onClick:l},r):n.a.createElement("span",{className:"NarrativeRowBaseItem__title",onClick:l},r),n.a.createElement("div",f({className:Object(v.classNames)("NarrativeRowBaseItem",u),"data-id":t},p),n.a.createElement("div",{className:"NarrativeRowBaseItem__wrapper"},n.a.createElement("div",{className:"NarrativeRowBaseItem__preview"},o),n.a.createElement("div",{className:"NarrativeRowBaseItem__inner"},n.a.createElement("div",{className:"NarrativeRowBaseItem__main"},n.a.createElement("div",{className:"NarrativeRowBaseItem__title"},_),i&&n.a.createElement("div",{className:"NarrativeRowBaseItem__subtitle"},i)),a&&n.a.createElement("div",{className:"NarrativeRowBaseItem__aside"},a))))})),b=function(){return(b=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},w=n.a.memo((function(e){var t=e.onClick,r=Object(u.getLang)("stories_create_new_narrative"),i=n.a.createElement("div",{className:"NarrativeRowCreateItem"});return n.a.createElement(y,b({title:r,onClick:t,preview:i},{nodrag:"true"}))})),k=r("4PuL"),S=r("3blr"),j=r("kcIO"),E=r("jE6c"),O=r("n3cE"),C=r("yuXj"),T=r("/PiP"),L=r("nTq2"),I=r("4WSo"),N=n.a.memo((function(e){var t=e.id,r=e.title,i=e.subtitle,o=e.href,a=e.preview,s=e.aside,c=e.onClick,l=e.className;return"string"==typeof a&&(a=n.a.createElement(I.NarrativeItemPreviewCover,{onClick:c,cover:a,href:o})),n.a.createElement(y,{title:r,href:o,onClick:c,preview:a,subtitle:i,id:t,aside:s,className:l})})),B=r("UCWv"),x=(_=function(e,t){return(_=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}_(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),R=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),o=0;for(t=0;t<r;t++)for(var n=arguments[t],a=0,s=n.length;a<s;a++,o++)i[o]=n[a];return i},P=function(e){function t(t){var r=e.call(this,t)||this;return r.getBoxActionButtons=function(){var e=r.props,t=e.onClose,o=e.boxData,a=e.type,s=[n.a.createElement(d.default,{key:"close",appearance:"primary",onClick:function(){return t()}},Object(u.getLang)("global_close"))];if(a===i.edit&&o.userId===o.ownerId){var c=o.ownerDomain||"id"+o.userId;s.unshift(n.a.createElement(O.default,{key:"archive",href:c+"?w=stories",onClick:function(){t(),Object(T.showWiki)({w:"stories"})},className:"NarrativeBox__additionalFooterButton"},Object(u.getLang)("stories_archive")))}return s},r.onNarrativeClick=function(e,t){e.ctrlKey||e.metaKey||(e.preventDefault(),e.stopPropagation(),Object(m.showNarrative)(t.ownerId,t.id,0,"narrative"+t.ownerId+"_"+t.id))},r.onCreateNarrativeClick=function(){var e=r.props.boxData;if(e.ownerId>0)r.openNarrativeEditorBox();else{var t=e.ownerDomain?e.ownerDomain:"club"+-e.ownerId;window.open("https://"+location.hostname+"/"+t+"?act=narrative_create")}},r.openNarrativeEditorBox=function(e){var t=r.props,i=t.onSave,o=t.boxData,n=t.onClose,a=[];(null==e?void 0:e.stories.length)&&(a=R(e.stories));var s={narrative:e,selectedStories:a,publishHash:o.publishHash,onSave:function(e){i(e),n()}};se(o.ownerId,s)},r.getNarrativeItemActions=function(e){var t=[];if(r.props.boxData.canEdit)t.push({text:Object(u.getLang)("global_edit"),onClick:function(){return r.editNarrative(e)}}),t.push({text:Object(u.getLang)("stories_share"),onClick:function(){return r.shareNarrative(e)}}),t.push({separator:!0}),t.push({text:Object(u.getLang)("global_delete"),onClick:function(){return r.removeNarrative(e)}});else{var i=e.bookmarked?Object(u.getLang)("global_remove_from_bookmarks"):Object(u.getLang)("global_add_to_bookmarks");t.push({text:i,onClick:function(){return r.bookmarkNarrative(e)}}),t.push({text:Object(u.getLang)("stories_share"),onClick:function(){return r.shareNarrative(e)}})}return t},r.state={isLoad:!1},r.scrollContainerRef=n.a.createRef(),r.gridRef=n.a.createRef(),r.sentinelRef=n.a.createRef(),r}return x(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.narratives,o=t.onClose,a=t.type,s=t.boxData,c=this.state.isLoad,d=r.length<s.count;return n.a.createElement(l.BoxModal,{className:"NarrativeBox",title:n.a.createElement(p,{title:Object(u.getLang)("stories_narratives_title"),count:s.count}),actionButtons:this.getBoxActionButtons(),onClose:o,hasScroll:!1},n.a.createElement("div",{className:"NarrativeBox__scrollContainer",ref:this.scrollContainerRef},n.a.createElement("div",{className:"NarrativeBox__scrollInner"},n.a.createElement("div",{className:"NarrativeBox__list",ref:this.gridRef},a===i.edit&&n.a.createElement(n.a.Fragment,null,n.a.createElement(w,{key:"create",onClick:this.onCreateNarrativeClick}),r.map((function(t){return n.a.createElement(N,{className:B.BOX_ITEM_DRAGGABLE_CLASS,key:t.rawId,title:t.title,subtitle:Object(u.getLang)("groups_narrative_box_stories_count",t.storiesCount),href:"/narrative"+t.ownerId+"_"+t.id,preview:t.coverUrl,onClick:function(r){return e.onNarrativeClick(r,t)},id:t.id,aside:n.a.createElement("div",{className:"NarrativeBox__aside"},n.a.createElement(C.default,{position:"b",align:"center",trigger:"hover",data:e.getNarrativeItemActions(t)},n.a.createElement("div",{className:"NarrativeBox__action NarrativeBox__action--more"})),n.a.createElement("div",{className:"NarrativeBox__action NarrativeBox__action--burger"}))})}))),a===i.view&&n.a.createElement(n.a.Fragment,null,r.map((function(t){return n.a.createElement(N,{key:t.rawId,title:t.title,subtitle:Object(u.getLang)("groups_narrative_box_stories_count",t.storiesCount),href:"/narrative"+t.ownerId+"_"+t.id,preview:t.coverUrl,onClick:function(r){return e.onNarrativeClick(r,t)},id:t.id,aside:n.a.createElement("div",{className:"NarrativeBox__aside"},n.a.createElement(C.default,{position:"b",align:"right",trigger:"hover",data:e.getNarrativeItemActions(t)},n.a.createElement("div",{className:"NarrativeBox__action NarrativeBox__action--more"})))})})))),c&&n.a.createElement("div",{className:"NarrativeBox__loader",key:"loader"},n.a.createElement(S.default,null)),d&&n.a.createElement("div",{className:"NarrativeBox__sentinel",ref:this.sentinelRef}))))},t.prototype.componentDidMount=function(){this.initSorter(),this.observeNarrativeScrollIfNeeded()},t.prototype.componentWillUnmount=function(){this.deInitSorter(),this.unObserveNarrativeScrollIfNeeded()},t.prototype.editNarrative=function(e){this.props.boxData.ownerId>0?this.openNarrativeEditorBox(e):window.open("https://"+location.hostname+location.pathname+"?act=narrative_edit&nid="+e.id)},t.prototype.shareNarrative=function(e){L.Likes.share("narrative"+e.rawId)},t.prototype.bookmarkNarrative=function(e){var t=this.props.onBookmark;Object(T.bookmark)(e.ownerId,e.id,"narrative",e.bookmarkHash,e.bookmarked),t(e)},t.prototype.removeNarrative=function(e){this.props.onRemove(e)},t.prototype.observeNarrativeScrollIfNeeded=function(){var e=this,t=this.props,r=t.narratives,i=t.boxData;if(r.length<i.count){var o=this.scrollContainerRef.current,n=this.sentinelRef.current;if(!n)return;this.observer=new IntersectionObserver((function(t){t.forEach((function(t){t.intersectionRatio>0&&e.loadViewers()}))}),{threshold:[0],root:o,rootMargin:"0px 0px 480px 0px"}),this.observer.observe(n)}},t.prototype.unObserveNarrativeScrollIfNeeded=function(){this.observer&&this.observer.disconnect()},t.prototype.loadViewers=function(){var e=this,t=this.props.loadMore;this.state.isLoad||(this.setState({isLoad:!0}),t().finally((function(){e.setState({isLoad:!1})})))},t.prototype.initSorter=function(){var e,t,r=this;if(this.props.boxData.canEdit){var i=null===(e=this.scrollContainerRef)||void 0===e?void 0:e.current,o=null===(t=this.gridRef)||void 0===t?void 0:t.current;if(o&&i){var n={dragThreshold:0,wrapNode:i,onReorder:function(e){var t=r.props.narratives,i=r.getNarrativeIdByEl(e),n=Array.from(o.querySelectorAll("."+B.BOX_ITEM_DRAGGABLE_CLASS));if(1!==n.length){var a=[],s=0,c=0;n.forEach((function(e){var i=r.getNarrativeIdByEl(e),o=t.find((function(e){return e.id===i}));o&&a.push(o)}));var l=n.findIndex((function(e){return r.getNarrativeIdByEl(e)===i}));n[l-1]&&(s=r.getNarrativeIdByEl(n[l-1])),n[l+1]&&(c=r.getNarrativeIdByEl(n[l+1])),r.saveReorder(a,i,c,s)}}};this.sorter=new k.default(o,"",n)}}},t.prototype.saveReorder=function(e,t,r,i){var o=this.props,n=o.boxData,a=o.onReorder;window.ajax.post("al_stories.php",{act:"narratives_reorder",narrative_id:t,before_narrative_id:r,after_narrative_id:i,hash:n.reorderHash,owner_id:n.ownerId},{onDone:function(){Object(j.showDoneBox)(Object(u.getLang)("stories_narrative_order_saved")),a(e)},onFail:function(e){return Object(j.showDoneBox)(e||Object(u.getLang)("global_error")),!0}})},t.prototype.getNarrativeIdByEl=function(e){return Object(E.intval)(e.getAttribute("data-id"))},t.prototype.deInitSorter=function(){this.sorter&&this.sorter.destroy()},t.defaultProps={type:i.view},t}(n.a.Component),A=r("4+be"),M=r("v+DW"),D=r("EasH"),F=r("WfnU"),H=r("URsI");!function(e){e.Add="add",e.Delete="delete"}(h||(h={}));var V=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),U=function(){return(U=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},K=function(e){function t(t){var r=e.call(this,t)||this;return r.loadMore=function(){var e=r.props,t=e.loadMore,i=e.story,o=r.state.selectedNarrativeIds;return t().then((function(e){void 0===e&&(e=[]),r.setState({selectedNarrativeIds:U(U({},o),r.getSelectedNarrativeIdsMap(i.id,e))})}))},r.onCheckboxClick=function(e){var t=r.state.selectedNarrativeIds,i=U({},t);i[e.id]?delete i[e.id]:i[e.id]=!0,r.setState({selectedNarrativeIds:i})},r.getBoxActionButtons=function(){var e=r.props,t=e.onClose,i=e.story,o=e.narratives,a=r.state,s=a.isLoad,c=a.selectedNarrativeIds,l=r.getSelectedNarrativeIdsMap(i.id,o),p=r.getDiffOperations(i.id,c,l);return[n.a.createElement(d.default,{key:"close",appearance:"tertiary",onClick:function(){return t()}},Object(u.getLang)("global_close")),n.a.createElement(F.default,{key:"save",appearance:"primary",disabled:!p.length,onClick:r.save,loading:s},Object(u.getLang)("global_save"))]},r.save=function(){var e=r.props,t=e.story,i=e.narratives,o=e.boxData,n=e.onClose,a=e.onSave,s=r.state.selectedNarrativeIds,c=r.getSelectedNarrativeIdsMap(t.id,i),l=r.getDiffOperations(t.id,s,c),d=Boolean(Object.keys(s).length);r.setState({isLoad:!0}),window.ajax.post("al_stories.php",{act:"batch_edit",owner_id:o.ownerId,operations:JSON.stringify(l),hash:o.editHash},{onDone:function(){a(d),n(),Object(j.showDoneBox)(Object(u.getLang)("stories_settings_saved"))},onFail:function(e){return Object(j.showDoneBox)(e||Object(u.getLang)("global_error")),!0},hideProgress:function(){r.setState({isLoad:!1})}})},r.onCreateNarrativeClick=function(){var e=r.props,t=e.story,i=e.narratives,o=e.onSave,n=e.onClose,a=e.boxData;if(a.ownerId>0){var s=r.getSelectedNarrativeIdsMap(t.id,i),c=Boolean(Object.keys(s).length),l={selectedStories:[t],onSave:function(){c=!0},onClose:function(){o(c),n()}};se(a.ownerId,l)}else{var d=a.ownerDomain?a.ownerDomain:"club"+-a.ownerId;window.nav.go(d+"?act=narrative_create&story_id="+t.id)}},r.onNarrativeClick=function(e,t){e.ctrlKey||e.metaKey||(Object(m.showNarrative)(t.ownerId,t.id,0,"narrative"+t.ownerId+"_"+t.id),e.preventDefault(),e.stopPropagation())},r.state={isLoad:!1,selectedNarrativeIds:r.getSelectedNarrativeIdsMap(t.story.id,t.narratives)},r}return V(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.onClose,i=t.narratives,o=t.boxData,a=this.state.selectedNarrativeIds,s=i.length<o.count;return n.a.createElement(l.BoxModal,{className:"NarrativeChooseBox",title:Object(u.getLang)("stories_narrative_choosing"),actionButtons:this.getBoxActionButtons(),onClose:r,hasScroll:!1,appearance:"blue"},n.a.createElement(H.default,{className:"NarrativeChooseBox__list",itemHeight:80,loadMore:this.loadMore,hasMore:s},n.a.createElement(w,{key:"create",onClick:this.onCreateNarrativeClick}),i.map((function(t){return n.a.createElement(N,{key:t.rawId,title:t.title,subtitle:Object(u.getLang)("groups_narrative_box_stories_count",t.storiesCount),href:"/narrative"+t.ownerId+"_"+t.id,preview:t.coverUrl,onClick:function(r){return e.onNarrativeClick(r,t)},id:t.id,aside:n.a.createElement("div",{className:Object(v.classNames)("NarrativeChooseBox__checkbox",{"NarrativeChooseBox__checkbox--checked":a[t.id]}),onClick:function(){return e.onCheckboxClick(t)}})})}))))},t.prototype.getDiffOperations=function(e,t,r){var i=[];return Object.keys(t).forEach((function(t){r[t]||i.push({op:h.Add,story_id:e,narrative_id:Number(t)})})),Object.keys(r).forEach((function(r){t[r]||i.push({op:h.Delete,story_id:e,narrative_id:Number(r)})})),i},t.prototype.getSelectedNarrativeIdsMap=function(e,t){return t.reduce((function(t,r){return r.stories.find((function(t){return t.id===e}))&&(t[r.id]=!0),t}),{})},t}(n.a.Component),W=r("t7n3"),G=function(e){var t=e.className,r=e.coverUrl,i=e.title,o=e.ownerName,a=e.storyCount;return n.a.createElement("div",{className:Object(v.classNames)("NarrativeSnippet",t)},n.a.createElement("div",{className:"NarrativeSnippet__inner"},n.a.createElement("div",{className:"NarrativeSnippet__cover",style:{backgroundImage:"url("+r+")"}}),n.a.createElement("div",{className:"NarrativeSnippet__info"},n.a.createElement("div",{className:"NarrativeSnippet__title"},i),n.a.createElement("span",{className:"NarrativeSnippet__author"},o),n.a.createElement("span",{className:"NarrativeSnippet__description"},n.a.createElement("span",null,Object(u.getLang)("global_type_narrative")),n.a.createElement("span",{className:"dvd"}),n.a.createElement("span",null,Object(u.getLang)("global_narrative_stories_count",a))))))},q=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),z=function(e){function t(t){var r=e.call(this,t)||this;return r.onNameChange=function(e){var t=e.target.value,i=Object(W.trim)(t)?t:"";r.setState({name:i})},r.getBoxActionButtons=function(){var e=r.state.isLoad;return[n.a.createElement(F.default,{key:"publish",appearance:"primary",onClick:r.save,loading:e},Object(u.getLang)("groups_edit_narrative_publish"))]},r.save=function(){var e=r.state.isLoad,t=r.state.name,i=void 0===t?"":t;e||((i=Object(W.trim)(i))?(r.setState({isLoad:!0}),r.props.onSave(i).catch((function(){r.setState({isLoad:!1})}))):Object(M.notaBene)(r.nameInputRef.current))},r.state={isLoad:!1,name:"",coverStory:t.stories[0]},r.nameInputRef=n.a.createRef(),r}return q(t,e),t.prototype.render=function(){var e=this.props,t=e.onClose,r=e.ownerName,i=e.stories,o=this.state,a=o.name,s=o.coverStory,c=null==s?void 0:s.preview;return n.a.createElement(l.BoxModal,{className:"NarrativeCreateLiteBox",title:Object(u.getLang)("stories_creating_narrative"),actionButtons:this.getBoxActionButtons(),onClose:t,hasScroll:!1,appearance:"blue"},n.a.createElement("div",{className:"NarrativeCreateLiteBox__inner"},n.a.createElement("div",{className:"NarrativeCreateLiteBox__title"},Object(u.getLang)("groups_edit_narrative_title")),n.a.createElement("input",{type:"text",className:"NarrativeCreateLiteBox__nameInput",value:a,onChange:this.onNameChange,placeholder:Object(u.getLang)("stories_enter_name"),maxLength:B.NARRATIVE_MAX_TITLE_LENGTH,ref:this.nameInputRef,autoFocus:!0}),n.a.createElement("div",{className:"NarrativeCreateLiteBox__title"},Object(u.getLang)("groups_edit_narrative_preview")),n.a.createElement("div",{className:"NarrativeCreateLiteBox__text"},Object(u.getLang)("groups_edit_narrative_pin_text")),n.a.createElement("div",{className:"NarrativeCreateLiteBox__previews"},n.a.createElement("div",{className:"NarrativeCreateLiteBox__previewWrapper"},n.a.createElement("div",{className:"NarrativeCreateLiteBox__previewTitle"},Object(u.getLang)("stories_narrative_preview_block_title")),n.a.createElement("div",{className:"NarrativeCreateLiteBox__smallPreview"},n.a.createElement(I.NarrativeItemPreviewCover,{cover:c}),n.a.createElement("span",{className:"NarrativeCreateLiteBox__smallPreviewName"},a||Object(u.getLang)("stories_narrative_name_full")))),n.a.createElement("div",{className:"NarrativeCreateLiteBox__previewWrapper NarrativeCreateLiteBox__previewWrapper--snippet"},n.a.createElement("div",{className:"NarrativeCreateLiteBox__previewTitle"},Object(u.getLang)("stories_narrative_preview_feed_title")),n.a.createElement(G,{className:"NarrativeCreateLiteBox__snippet",ownerName:r,coverUrl:c,title:a||Object(u.getLang)("stories_narrative_name_full"),storyCount:i.length})))))},t}(n.a.Component),Q=r("x9XA"),X=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),Y=function(){return(Y=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},$=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(r[i[o]]=e[i[o]])}return r},J=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.inputRef=n.a.createRef(),t.componentRef=n.a.createRef(),t}return X(t,e),t.prototype.notaBene=function(){var e,t=null===(e=this.componentRef)||void 0===e?void 0:e.current;t&&Object(M.notaBene)(t)},t.prototype.focus=function(){var e,t;null===(t=null===(e=this.inputRef)||void 0===e?void 0:e.current)||void 0===t||t.focus()},t.prototype.render=function(){var e=this.props,t=e.className,r=e.prefix,i=$(e,["className","prefix"]);return n.a.createElement("div",{className:Object(v.classNames)("InputWithPrefix",t),ref:this.componentRef},n.a.createElement("div",{className:"InputWithPrefix__text"},r),n.a.createElement("input",Y({className:"InputWithPrefix__input"},i,{ref:this.inputRef})))},t}(n.a.Component),Z=r("hN/p"),ee=r("6x0M"),te=function(e){var t=e.text,r=e.children,i=e.open,o=void 0!==i&&i,a=n.a.createElement("div",{className:"StoryLinkHint"},n.a.createElement("div",{className:"StoryLinkHint__inner"},t));return n.a.createElement(ee.Popper,{open:o,position:"t",align:"left",content:a},r)},re=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),ie=function(e){function t(t){var r=e.call(this,t)||this;return r.inputRef=n.a.createRef(),r.needCleanLink=!1,r.onChangeLink=function(e){var t=Object(W.trim)(e.target.value);r.needCleanLink&&(r.needCleanLink=!1,t=r.cleanLink(t)||t),r.setState({link:t,needShowHint:!r.isLinkValid(t)})},r.onKeyUpLink=function(){var e=r.state.link;r.setState({needShowHint:!r.isLinkValid(e)})},r.onPasteLink=function(){r.needCleanLink=!0},r.onChangeLinkType=function(e){r.setState({linkType:String(e.selected.value)})},r.onSave=function(){var e,t,i,o,n=r.props,a=n.onStoryLinkUpdate,s=n.onClose,c=n.story,l=r.state.linkType,d=r.state.link;if(d=Object(W.trim)(d),!r.isLinkValid(d))return null===(t=null===(e=r.inputRef)||void 0===e?void 0:e.current)||void 0===t||t.focus(),null===(o=null===(i=r.inputRef)||void 0===i?void 0:i.current)||void 0===o||o.notaBene(),void r.setState({needShowHint:!0});var u=d?"https://vk.com/"+d:"";s(),a(c.rawId,u,l)},r.onDelete=function(){var e=r.props,t=e.onStoryLinkUpdate,i=e.onClose,o=e.story;i(),t(o.rawId,"","")},r.state={link:t.story.linkUrl?r.cleanLink(t.story.linkUrl):"",linkType:t.story.linkType||t.linkData[0].value,needShowHint:!1},r}return re(t,e),t.prototype.render=function(){var e=this.props,t=e.onClose,r=e.linkData,i=this.state,o=i.linkType,a=i.link,s=i.needShowHint,c=this.isEditMode()?Object(A.getLang)("stories_edit_link_title"):Object(A.getLang)("stories_add_link_title");return n.a.createElement(l.BoxModal,{className:"StoryLinkEditorBox",appearance:"blue",onClose:t,title:c,actionButtons:this.getActionButtons(),hasScroll:!1},n.a.createElement("div",{className:"StoryLinkEditorBox__inner"},n.a.createElement("div",{className:"StoryLinkEditorBox__row"},n.a.createElement("span",{className:"StoryLinkEditorBox__label"},Object(A.getLang)("stories_link_label_url")),n.a.createElement("div",{className:"StoryLinkEditorBox__control"},n.a.createElement(te,{open:s,text:Object(A.getLang)("stories_upload_link_format")},n.a.createElement("div",{className:"StoryLinkHint__input"},n.a.createElement(J,{className:"StoryLinkEditorBox__input",prefix:"https://vk.com/",value:a,onChange:this.onChangeLink,onKeyUp:this.onKeyUpLink,onPaste:this.onPasteLink,autoFocus:!0,ref:this.inputRef}))))),n.a.createElement("div",{className:"StoryLinkEditorBox__row"},n.a.createElement("span",{className:"StoryLinkEditorBox__label"},Object(A.getLang)("stories_link_label_text")),n.a.createElement("div",{className:"StoryLinkEditorBox__control"},n.a.createElement(Z.default,{className:"StoryLinkEditorBox__select",appearance:"secondary",options:r,value:o,onChange:this.onChangeLinkType})))))},t.prototype.isEditMode=function(){return Boolean(this.props.story.linkUrl)},t.prototype.isLinkValid=function(e){return Boolean(e)&&e.length>=2&&Boolean(e.match(/^[a-z0-9\/\-._%=?&@#]+$/i))&&!decodeURIComponent(e).match(/away.php/)},t.prototype.cleanLink=function(e){var t=(e=Object(W.trim)(e)).match(/[https?:\/\/]*((?:[a-z0-9_\-]+\.)+(?:[a-z]{2,9})\/)(.*?)?(\#.*?)?(?:[\.!:;,\*\(\)&]*&nbsp;|[ \t\r\n \u00A0]|$)/i);return(t&&t[2]?t[2]:"")+(t&&t[3]?t[3]:"")},t.prototype.getActionButtons=function(){var e=this.props.onClose,t=[n.a.createElement(d.default,{key:"close",appearance:"tertiary",onClick:function(){return e()}},Object(A.getLang)("global_cancel")),n.a.createElement(d.default,{key:"save",appearance:"primary",onClick:this.onSave},this.isEditMode()?Object(A.getLang)("global_save"):Object(A.getLang)("stories_add_link"))];return this.isEditMode()&&t.unshift(n.a.createElement(Q.default,{key:"delete",className:"StoryLinkEditorBox__extraFooterBtn",onClick:this.onDelete},Object(A.getLang)("stories_delete_link"))),t},t}(n.a.Component),oe=r("HLtZ"),ne=r("6qdA"),ae=function(){return(ae=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function se(e,t){void 0===t&&(t={});var r={},i=t.narrative,o=t.onClose,l=t.onSave,d=t.stories,u=t.selectedStories,p=void 0===u?[]:u,_=t.publishHash,h=t.editHash,m=t.linkData,v=t.isEditingLinksAvailable;function f(){window.stManager.add(["NarrativeEditor.css"]).then((function(){r.box=Object(c.showComponentInBox)(w(),{width:638,onDestroy:function(e){Object(c.destroyComponentInBox)(e),o&&o()}})})).catch((function(e){console.error(e),Object(oe.logError)(e)}))}function g(e){l&&l(e)}function y(){r.box&&r.box.hide()}function b(e,t,r){if(null==d?void 0:d.length){var i=function(i){return null==i?void 0:i.map((function(i){return i.rawId===e?ae(ae({},i),{linkUrl:t,linkType:r}):i}))};d=i(d),p=i(p)||[],(null==d?void 0:d.length)&&_&&h&&Object(c.updateCurrentComponentInBox)(w())}}function w(){if((null==d?void 0:d.length)&&_&&h){var t=d.reduce((function(e,t){return e[t.rawId]=t,e}),{});p=p.filter((function(e){return t[e.rawId]}));var r=d.map((function(e){return e.rawId})),o=p.map((function(e){return e.rawId})),c=i?a.EditorModeType.edit:a.EditorModeType.create,l=(null==i?void 0:i.title)?Object(s.decodeHTMLEntities)(i.title):"";return n.a.createElement(ne.NarrativeEditor,{ownerId:e,type:c,name:l,narrativeRawId:null==i?void 0:i.rawId,coverStoryId:null==i?void 0:i.coverStoryRawId,selectedStoryRawIds:o,storyRawIds:r,storyMap:t,onClose:y,onSave:g,publishHash:_,editHash:h,linkData:m,isEditingLinksAvailable:v,onStoryLinkUpdate:b,appearance:a.EditorViewType.box})}}d&&_&&h?f():new Promise((function(t,r){window.ajax.post("al_stories.php",{act:"get_narrative_editor_data",owner_id:e},{loader:!0,onDone:function(e,r,i,o,n){t([d=e,_=r,h=i,m=o,v=n])},onFail:function(e){return r(e),!0}})})).then((function(){f()})).catch((function(e){Object(j.showDoneBox)(e||Object(A.getLang)("global_error")),Object(oe.logError)(e)}))}function ce(e){var t=e.ownerId,r=e.onClose,o=e.onSave,a=e.onRemove,s=e.onReorder,l={narratives:[],ownerId:t,boxAct:"get_narrative_box_data"},d=!1;function u(){return _e(l).then((function(){p()})).catch((function(e){Object(j.showDoneBox)(e||Object(A.getLang)("global_error"))}))}function p(){if(l.boxData){var e=l.boxData.canEdit?i.edit:i.view;Object(c.updateCurrentComponentInBox)(n.a.createElement(P,{type:e,boxData:l.boxData,narratives:l.narratives,onClose:v,onSave:_,onRemove:h,onBookmark:g,onReorder:f,loadMore:u}))}}function _(e){o&&o(e),d=!0}function h(e){var t,r;t=e,r={title:Object(A.getLang)("global_warning")},Object(D.showFastBox)(r,Object(A.getLang)("stories_narrative_remove_warning"),Object(A.getLang)("stories_remove_confirm"),(function(e){var r=l.boxData;r&&window.ajax.post("al_stories.php",{act:"remove_narrative",narrative_raw:t.rawId,hash:r.removeHash},{onDone:function(){r.count-=1,l.narratives=l.narratives.filter((function(e){return e.rawId!==t.rawId})),p(),Object(j.showDoneBox)(Object(A.getLang)("stories_deleted_narrative")),a&&a()},onFail:function(e){return Object(j.showDoneBox)(e||Object(A.getLang)("global_error")),!0},showProgress:function(){return Object(M.lockButton)(e)},hideProgress:function(){Object(j.curBox)().hide(),Object(M.unlockButton)(e)}})}),Object(A.getLang)("global_cancel"))}function m(){d&&v()}function v(){l.box&&l.box.hide()}function f(e){l.narratives=e,p(),s&&s()}function g(e){e.bookmarked=!e.bookmarked,p()}pe(l).then((function(e){var t=e[0],o=e[1],a=e[2];l.narratives=t,l.boxData=o,l.startFrom=a,l.box=function(e,t){var o=t.canEdit?i.edit:i.view;return Object(c.showComponentInBox)(n.a.createElement(P,{type:o,boxData:t,narratives:e,loadMore:u,onClose:v,onSave:_,onReorder:f,onBookmark:g,onRemove:h}),{width:560,onShow:m,onDestroy:function(e){Object(c.destroyComponentInBox)(e),r&&r()}})}(t,o)})).catch((function(e){Object(j.showDoneBox)(e||Object(A.getLang)("global_error")),r&&r()}))}function le(e){var t=e.ownerId,r=e.story,i=e.onClose,o=e.onSave,a={narratives:[],ownerId:t,boxAct:"get_narrative_choose_box_data"},s=!1;function l(){return _e(a).then((function(e){return function(){if(!a.boxData)return;Object(c.updateCurrentComponentInBox)(n.a.createElement(K,{story:r,narratives:a.narratives,onClose:p,onSave:d,boxData:a.boxData,loadMore:l}))}(),e})).catch((function(e){return Object(j.showDoneBox)(e||Object(A.getLang)("global_error")),[]}))}function d(e){o&&o(e),s=!0}function u(){s&&p()}function p(){a.box&&a.box.hide()}pe(a).then((function(e){var t=e[0],o=e[1],s=e[2];a.narratives=t,a.boxData=o,a.startFrom=s,a.box=function(e,t){return Object(c.showComponentInBox)(n.a.createElement(K,{story:r,narratives:e,boxData:t,loadMore:l,onClose:p,onSave:d}),{width:560,onShow:u,onDestroy:function(e){Object(c.destroyComponentInBox)(e),i&&i()}})}(t,o)})).catch((function(e){Object(j.showDoneBox)(e||Object(A.getLang)("global_error")),i&&i()}))}function de(e){var t=e.onSave,r=e.onClose,i=e.ownerId,o=e.ownerName,a=e.stories,s=e.publishNarrativeHash,l=Object(c.showComponentInBox)(n.a.createElement(z,{stories:a,ownerId:i,ownerName:o,publishNarrativeHash:s,onSave:t,onClose:function(){l&&l.hide()}}),{width:560,onDestroy:function(e){Object(c.destroyComponentInBox)(e),r&&r()}})}function ue(e){var t=e.story,r=e.onClose,i=e.onStoryLinkUpdate,o=e.linkData,a=Object(c.showComponentInBox)(n.a.createElement(ie,{story:t,onClose:function(){a&&a.hide()},onStoryLinkUpdate:i,linkData:o}),{width:450,onDestroy:function(e){Object(c.destroyComponentInBox)(e),r&&r()}})}function pe(e){return new Promise((function(t,r){window.ajax.post("al_stories.php",{act:e.boxAct,owner_id:e.ownerId,start_from:e.startFrom},{loader:!e.narratives.length,onDone:function(e,r,i){t([e,r,i])},onFail:function(e){return r(e),!0}})}))}function _e(e){return pe(e).then((function(t){var r,i=t[0],o=t[2];return e.narratives=(null===(r=e.narratives)||void 0===r?void 0:r.concat(i))||i,e.startFrom=o,i}))}},rudk:function(e,t,r){"use strict";r.r(t),r.d(t,"parseFwd",(function(){return s})),r.d(t,"convertKludgesToAttaches",(function(){return c})),r.d(t,"isReservedPeer",(function(){return l})),r.d(t,"isUserPeer",(function(){return d})),r.d(t,"isChatPeer",(function(){return u})),r.d(t,"isEmailPeer",(function(){return p})),r.d(t,"isContactPeer",(function(){return _})),r.d(t,"convertAttachesToPhpMedia",(function(){return h})),r.d(t,"isPinnedSortId",(function(){return m}));var i=r("jE6c"),o=r("hC3G");function n(e,t){void 0===t&&(t=[]);var r=e.split("_");return[r[0],r[1],t]}var a={};function s(e){if(a[e])return a[e];for(var t=e?e.length:0,r=[],i=[],o="",s=0;s<t;s++){var c=e[s],l=c.charCodeAt(0);l>=48&&l<=57||"_"===c||"-"===c?o+=c:"("!==c&&")"!==c&&":"!==c&&","!==c||(""!==o&&(i.push(o),r.push("id"),o=""),i.push(c),r.push(c))}o.length>0&&(i.push(o),r.push("id"));var d=function e(t,r,i,o){if(void 0===i&&(i=0),void 0===o&&(o=0),o>50)return[[],t.length];for(var a=[],s="";i<t.length;){var c=t[i];if("id"===c)s=r[i];else if(","===c&&s)a.push(n(s)),s="";else if("("===c){var l=e(t,r,i+1,o+1),d=l[0];i=l[1],a.push(n(s,d)),s=""}else if(")"===c)return""!==s&&a.push(n(s)),[a,i];i++}return s&&a.push(n(s)),[a,i]}(r,i)[0];return Object.keys(a).length>300&&(a={}),a[e]=d,d}function c(e,t){var r=[];e.fwd_count?r.push({type:"mail",id:-t,object:{fwd_count:e.fwd_count}}):e.fwd&&r.push({type:"mail",id:-t,object:{fwd_count:s(e.fwd).length}});for(var o=1;e["attach"+o+"_type"];++o)"call"===e["attach"+o+"_type"]?r.push({type:e["attach"+o+"_type"],id:e["attach"+o],initiatorId:Object(i.intval)(e["attach"+o+"_call_initiator_id"]),state:e["attach"+o+"_call_state"],duration:Object(i.intval)(e["attach"+o+"_call_duration"]),receiverId:Object(i.intval)(e["attach"+o+"_call_receiver_id"])}):r.push({type:e["attach"+o+"_type"],id:e["attach"+o],kind:e["attach"+o+"_kind"],productId:e["attach"+o+"_product_id"]});return e.geo&&r.push({type:"geo",id:e.geo}),r}function l(e){return 0==e}function d(e){return e>0&&e<2e9}function u(e){return e>2e9}function p(e){return e<-2e9}function _(e){return e>19e8&&e<2e9}function h(e){return e.map((function(e){var t="audiomsg"===e[2]?"audio_message":e[2];return e[0]+":"+e[1]+":"+t})).join(",")}function m(e){return e>0&&(e|o.PINNED_CONVERSATION_BIT_MASK)===o.PINNED_CONVERSATION_BIT_MASK}},uXyw:function(e,t,r){"use strict";r.r(t);var i=r("KHCB");window.Stories=i.Stories;try{window.stManager.done(window.jsc("web/stories.js"))}catch(e){}},vzBJ:function(e,t,r){"use strict";r.r(t),r.d(t,"StickersAnimation",(function(){return i}));r("VRzm"),r("Btvt"),r("a1Th");var i=function(){var e,t,r,o=!1,n=!1,a={},s={},c={},l={};function d(e){var t=_(e),r=1;if(t){hasClass(e,"animation_play")||(hide(geByClass1("sticker_img",e)),addClass(e,"animation_play")),t.play();var i=attr(e,"data-loop-count");i=parseInt(i),isNaN(i)&&(i=3),-1!==i&&(!t._cbs.loopComplete||t._cbs.loopComplete&&0===t._cbs.loopComplete.length)&&t.addEventListener("loopComplete",(function o(n){r++;var a=!0;i>=r&&(a=!1),a&&(p(e,!1),""!==t._cbs.loopComplete&&t.removeEventListener("loopComplete",o),t.stop())}))}}function u(e){var t=attr(e,"data-uid");return t||(t=attr(e,"data-uid",Math.random().toString(32).substr(2))),t}function p(e,t){l[u(e)]=t}function _(e){var t=attr(e,"data-uniq-id");if(!geByClass1("svg_sticker_animation",e))return!1;var r=s[t];return r||!1}function h(e,t){var i=_(e);if(i)"function"==typeof t&&t(i);else{var o=attr(e,"data-uniq-id");if(!l[u(e)]){p(e,!0);var n=attr(e,"data-animation-path"),c=attr(e,"data-sticker-id"),d=!1;if(c&&(d=(a[c]||n)&&v(e)),d){var h=attr(e,"data-animation-class")||"",m={container:e,renderer:"svg",loop:!0,autoplay:!1,name:o,rendererSettings:{scaleMode:"noScale",progressiveLoad:!0,hideOnTransparent:!0,className:"svg_sticker_animation "+h}};a[c]?m.animationData=a[c]:m.path=n;var f=geByClass1("svg_sticker_animation",e);if(f&&re(f),i=r.loadAnimation(m),!a[c])return void i.addEventListener("data_ready",(function(){a[c]=i.animationData,s[o]=i,"function"==typeof t&&t(i)}))}"function"==typeof t&&(s[o]=i,"function"==typeof t&&t(i))}}}function m(){return t().then(e=>(r=e,e))}return{init(e){t=e.animatorLoader},checkSettingsAndLoadInWeb:function(e){if(StickersSettings.getAutoplay()){var t=ge("fc_msg"+e),r=geByClass1("sticker_animation",t);i.loadAndPlaySticker(r)}},checkSettingsAndLoad:function(e){if(StickersSettings.getAutoplay()){var t=$(`.msg_id_${e} .sticker_animation`);i.loadAndPlaySticker(t)}},loadStickerInMvkIMAndPlay:function(e,t){var r="_msg"+e;t&&(r="msg_id_"+e);var o=geByClass1("sticker_animation",geByClass1(r));i.loadAndPlayStickerWithTimer(o,500)},loadAutoplayAnimationStickers:function(e){if(r){if(e){if(n)return;n=!0}if(!o){o=!0;var t=geByClass("sticker_animation_autoplay");t&&each(t,(function(e,t){h(t,(function(){d(t)}))})),o=!1}}else m().then(()=>{i.loadAutoplayAnimationStickers(e)})},loadAndPlaySticker:function(e){e&&(r?requestAnimationFrame(()=>{h(e,(function(){d(e)}))}):m().then(()=>{i.loadAndPlaySticker(e)}))},loadAndPlayStickerWithTimer:function(e,t){if(e&&!c[e]){t||(t=1e3);var r=ge(e);hasClass(r,"sticker_animation_disabled_timer")||(c[e]=setTimeout((function(){!r&&(r=ge(e),hasClass(r,"sticker_animation_disabled_timer"))||(i.loadAndPlaySticker(r),clearTimeout(c[e]),c[e]=!1)}),t))}},reloadStickers:function(){s={}},touchStartSticker:function(t){t.addEventListener("contextmenu",i.preventContextMenu,!1),e=setTimeout((function(){i.loadAndPlaySticker(t)}),500)},touchEndSticker:function(){e&&clearTimeout(e)},preventContextMenu:function(e){e.preventDefault(),e.stopPropagation()}};function v(e){var t=e.getBoundingClientRect().top,r=e.getBoundingClientRect().bottom;return t<window.innerHeight&&r>=0&&isVisible(e)}}(),o=r("Jph1");i.init({animatorLoader:()=>Promise.resolve(o.default)})},wx14:function(e,t,r){"use strict";function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}r.r(t),r.d(t,"default",(function(){return i}))},zLVn:function(e,t,r){"use strict";function i(e,t){if(null==e)return{};var r,i,o={},n=Object.keys(e);for(i=0;i<n.length;i++)r=n[i],t.indexOf(r)>=0||(o[r]=e[r]);return o}r.r(t),r.d(t,"default",(function(){return i}))}});