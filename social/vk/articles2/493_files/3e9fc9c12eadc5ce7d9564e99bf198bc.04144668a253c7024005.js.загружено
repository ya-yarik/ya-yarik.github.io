(self.webpackChunkvk=self.webpackChunkvk||[]).push([[1690],{464380:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Api:()=>Wn,BaseApi:()=>g,BaseLogger:()=>v,BaseSignaling:()=>E,CallDirection:()=>y,CallType:()=>I,ChatRoomEventType:()=>A,ConversationOption:()=>N,DebugMessageType:()=>Me,ExternalIdType:()=>At,HangupReason:()=>Ct,HangupType:()=>x,MediaOption:()=>V,MediaType:()=>Ot,ParticipantState:()=>W,ParticipantStatus:()=>Re,Signaling:()=>Yn,SignalingCommandType:()=>$n,SignalingConnectionType:()=>K,SignalingNotification:()=>Q,UserRole:()=>oe,UserType:()=>de,Utils:()=>bt,acceptCall:()=>pi,addMovie:()=>tr,addParticipant:()=>vi,addParticipantInternal:()=>Si,apiCall:()=>li,authorize:()=>ui,browser:()=>Zn,callInternal:()=>si,callTo:()=>ai,captureScreen:()=>Ci,changeConversationOptions:()=>Fi,changeDevice:()=>yi,changeParticipantState:()=>Oi,changePriorities:()=>wi,changeVideoEffect:()=>or,chatHistory:()=>Bi,chatMessage:()=>Hi,chatMessageInternal:()=>ji,createJoinLink:()=>qi,customData:()=>Wi,customDataInternal:()=>$i,debug:()=>ar,debugMessage:()=>sr,declineCall:()=>hi,forceRelayPolicy:()=>Xi,getAnonymTokenByLink:()=>Yi,getStreamInfo:()=>er,getTokenForAnonym:()=>di,getWaitingHall:()=>dr,grantRoles:()=>Di,grantRolesInternal:()=>Ni,hangup:()=>gi,init:()=>ri,joinCall:()=>_i,joinCallByLink:()=>fi,joinCallInternal:()=>mi,muteParticipant:()=>ki,muteParticipantInternal:()=>Mi,pinParticipant:()=>xi,pinParticipantInternal:()=>Gi,processPush:()=>oi,processPushInternal:()=>ci,promoteParticipant:()=>lr,removeJoinLink:()=>Ji,removeMovie:()=>ir,removeParticipant:()=>Ei,removeParticipantInternal:()=>Ti,setApi:()=>ei,setAudioStream:()=>cr,setLocalResolution:()=>Ai,setLogger:()=>ni,setMediaModifiers:()=>Vi,setSignalingFactory:()=>ti,setStatisticsInterval:()=>rr,setVideoEffects:()=>ii,setVideoStream:()=>Ri,setVolume:()=>zi,startConversation:()=>Ki,startStream:()=>Qi,stopStream:()=>Zi,toggleLocalAudio:()=>Pi,toggleLocalVideo:()=>Ii,unmuteRequest:()=>Li,unmuteRequestInternal:()=>Ui,updateDisplayLayout:()=>bi,updateMovie:()=>nr});var i,r,a=n(545580),s=n(224736),o=n.n(s),c=n(535557),d=n(406257),l=n.n(d),u=Object.defineProperty,p=Object.getOwnPropertySymbols,h=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable,m=(e,t,n)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,f=(e,t,n)=>new Promise(((i,r)=>{var a=e=>{try{o(n.next(e))}catch(e){r(e)}},s=e=>{try{o(n.throw(e))}catch(e){r(e)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,s);o((n=n.apply(e,t)).next())})),g=class{createJoinLink(e){return f(this,null,(function*(){return{join_link:"nop"}}))}removeJoinLink(e){return f(this,null,(function*(){return{success:!0}}))}getAnonymTokenByLink(e,t){return f(this,null,(function*(){return""}))}log(e){}prepareUserIds(e){return f(this,null,(function*(){}))}getCachedOkIdByExternalId(e){return null}cacheExternalId(e,t){}hangupConversation(e){}cleanup(){}getTokenForAnonym(e,t){return f(this,null,(function*(){return""}))}call(e){return f(this,arguments,(function*(e,t={}){return null}))}},v=class{log(e,t,n=!1){}destroy(){}},S=class{constructor(){this._handlers={},this._listeners=[]}_triggerEvent(e,...t){if(this._handlers.hasOwnProperty(e))for(let n of this._handlers[e])setTimeout(n,0,...t)}addEventListener(e,t){if("function"!=typeof t)throw new Error("Listener should be a function");return this._handlers.hasOwnProperty(e)||(this._handlers[e]=[]),this._handlers[e].push(t),{dispose:this.removeEventListener.bind(this,e,t)}}removeEventListener(e,t){if(!this._handlers.hasOwnProperty(e))return;t||delete this._handlers[e];let n=this._handlers[e].indexOf(t);n>=0&&this._handlers[e].splice(n,1)}subscribe(e,t,n){let i=e.addEventListener(t,n);this._listeners.push(i)}unsubscribe(){this._listeners.forEach((e=>{e.dispose()}))}},E=class extends S{get ready(){return!0}setParticipantIdRegistry(e){}requestRealloc(){}setEndpoint(e){}setConversationId(e){}readyToSend(){}cleanup(){}requestTestMode(e){}getNextCommandSequenceNumber(){return 0}};(r=i||(i={})).INCOMING="INCOMING",r.OUTGOING="OUTGOING",r.JOINING="JOINING";var T,y=i;!function(e){e.USER="USER",e.GROUP="GROUP",e.CHAT="CHAT"}(T||(T={}));var C,R,I=T;(R=C||(C={})).ATTENDEE="ATTENDEE",R.HAND_UP="HAND_UP";var P,A=C;!function(e){e.ADD_PARTICIPANT="ADD_PARTICIPANT",e.RECORD="RECORD"}(P||(P={}));var w,O=P;!function(e){e.REQUIRE_AUTH_TO_JOIN="REQUIRE_AUTH_TO_JOIN",e.AUDIENCE_MODE="AUDIENCE_MODE",e.WAITING_HALL="WAITING_HALL"}(w||(w={}));var b,D,N=w;(D=b||(b={})).CAMERA_PERMISSION="camera",D.MIC_PERMISSION="mic",D.CAMERA_ACCESS="cameralock",D.MIC_ACCESS="miclock",D.MIC_NOT_FOUND="nomic",D.SCREEN_PERMISSION="screenpermission",D.SCREEN_ACCESS="screenlock",D.CONNECTION="connection",D.NETWORK="network",D.UNKNOWN="unknown",D.UNSUPPORTED="unsupported",D.SIGNALING_FAILED="signalingfailed",D.API="api",D.AUTH="auth";var k,M,L=b;(M=k||(k={})).CANCELED="CANCELED",M.REJECTED="REJECTED",M.REMOVED="REMOVED",M.HUNGUP="HUNGUP",M.MISSED="MISSED",M.BUSY="BUSY",M.FAILED="FAILED",M.NETWORK_ERROR="NETWORK_ERROR",M.CALLER_IS_BLOCKED="CALLER_IS_BLOCKED",M.NOT_FRIENDS="NOT_FRIENDS",M.CALLEE_IS_OFFLINE="CALLEE_IS_OFFLINE",M.UNKNOWN_ERROR="UNKNOWN_ERROR",M.UNSUPPORTED="UNSUPPORTED",M.OLD_VERSION="OLD_VERSION",M.SERVICE_DISABLED="SERVICE_DISABLED",M.EXTERNAL_API_ERROR="EXTERNAL_API_ERROR",M.SOCKET_CLOSED="SOCKET_CLOSED",M.ENDED="ENDED";var U,x=k;!function(e){e.AUDIO="AUDIO",e.VIDEO="VIDEO",e.SCREEN_SHARING="SCREEN_SHARING"}(U||(U={}));var G,V=U;!function(e){e.UNMUTE="UNMUTE",e.MUTE="MUTE",e.MUTE_PERMANENT="MUTE_PERMANENT"}(G||(G={}));var F,H,j=G;(H=F||(F={})).CALLED="CALLED",H.ACCEPTED="ACCEPTED",H.REJECTED="REJECTED",H.HUNGUP="HUNGUP";var B,W=F;!function(e){e.START="start",e.ACCEPT="accept",e.JOIN="join",e.RETRY="retry"}(B||(B={}));var $,K=B;!function(e){e.NOTIFICATION="NOTIFICATION",e.FAILED="FAILED",e.RECONNECT="RECONNECT"}($||($={}));var q,J,Y=$;(J=q||(q={})).TRANSMITTED_DATA="transmitted-data",J.ACCEPTED_CALL="accepted-call",J.HUNGUP="hungup",J.PARTICIPANT_ADDED="participant-added",J.PARTICIPANT_JOINED="participant-joined",J.CLOSED_CONVERSATION="closed-conversation",J.MEDIA_SETTINGS_CHANGED="media-settings-changed",J.PARTICIPANT_STATE_CHANGED="participant-state-changed",J.RATE_CALL_DATA="rate-call-data",J.FEATURE_SET_CHANGED="feature-set-changed",J.TOPOLOGY_CHANGED="topology-changed",J.PRODUCER_UPDATED="producer-updated",J.CONSUMER_ANSWERED="consumer-answered",J.MULTIPARTY_CHAT_CREATED="multiparty-chat-created",J.FORCE_MEDIA_SETTINGS_CHANGE="force-media-settings-change",J.SETTINGS_UPDATE="settings-update",J.VIDEO_QUALITY_UPDATE="video-quality-update",J.REGISTERED_PEER="registered-peer",J.SWITCH_MICRO="switch-micro",J.RECORD_STARTED="record-started",J.RECORD_STOPPED="record-stopped",J.REALLOC_CON="realloc-con",J.AUDIO_ACTIVITY="audio-activity",J.SPEAKER_CHANGED="speaker-changed",J.STALLED_ACTIVITY="stalled-activity",J.CHAT_MESSAGE="chat-message",J.CUSTOM_DATA="custom-data",J.ROLES_CHANGED="roles-changed",J.MUTE_PARTICIPANT="mute-participant",J.PIN_PARTICIPANT="pin-participant",J.OPTIONS_CHANGED="options-changed",J.NETWORK_STATUS="network-status",J.PARTICIPANT_SOURCES_UPDATE="participant-sources-update",J.PROMOTE_PARTICIPANT="promote-participant",J.CHAT_ROOM_UPDATED="chat-room-updated",J.PROMOTION_APPROVED="promotion-approved",J.JOIN_LINK_CHANGED="join-link-changed";var z,X,Q=q;(X=z||(z={})).ERROR="callError",X.DEVICES="callDevices",X.CALL_SPEC_ERROR="callSpecError",X.ICE_CONNECTION_STATE="callIceConnectionState",X.ICE_CONNECTION_TYPE="callIceConnectionType",X.ICE_RESTART="callIceRestart",X.PUSH="callPush",X.OUTGOING_CALL="callStart",X.OUTGOING_MULTIPARTY_CALL="callStartMultiparty",X.JOIN_CONVERSATION="callJoinConversation",X.ACCEPTED_OUTGOING="callAcceptedOutgoing",X.ACCEPT_INCOMING="callAcceptIncoming",X.DECLINE_INCOMING="callDeclineIncoming",X.ACCEPT_CONCURRENT="callAcceptConcurrent",X.HANGUP="callHangup",X.MEDIA_STATUS="callMediaStatus",X.DEVICE_CHANGED="callDeviceChanged",X.SOCKET_ACTION="callSocketAction",X.ADD_PARTICIPANT="callAddParticipant",X.REMOVE_PARTICIPANT="callRemoveParticipant",X.POOR_CONNECTION="callPoorConnection",X.TOPOLOGY_CHANGE_REQUESTED="callTopologyChangeRequested",X.RELAY_POLICY="callForceRelay",X.PAT_ALLOCATED="patAllocate",X.PAT_DEALLOCATED="patDeallocate",X.PAT_ERROR="patError",X.PAT_WAITING_TIME_ERROR="patWaitingTimeError",X.PAT_OUTDATED_RESPONSE="patOutdatedResponse";var Z,ee=z;!function(e){e.AUDIO_MIX="audio-mix",e.PARTICIPANT_AGNOSTIC_TRACK_PREFIX="pat"}(Z||(Z={}));var te,ne=Z;!function(e){e.NO_AVAILABLE_TRACKS="no-available-tracks",e.UNKNOWN_ERROR="unknown-error"}(te||(te={}));var ie,re=te;function ae(e){switch(e){case 1:return te.NO_AVAILABLE_TRACKS;default:return te.UNKNOWN_ERROR}}!function(e){e.CREATOR="CREATOR",e.ADMIN="ADMIN"}(ie||(ie={}));var se,oe=ie;function ce(e,t){if(e.length!==t.length)return!1;for(let n of e)if(!t.includes(n))return!1;return!0}!function(e){e.USER="USER",e.GROUP="GROUP"}(se||(se={}));var de=se,le=2097152,ue=102400,pe="_okcls_logs_session_";function he(){return`${pe}${Date.now()}`}function _e(e){return new Blob([e]).size}function me(e){try{window.localStorage.removeItem(e)}catch(e){console.error("Failed to remove log from storage",e)}}function fe(){let e=Te.toString();if(!Ee.available||!e)return;let t=_e(e);Ee.cleanup(t);try{window.localStorage.setItem(ye,e)}catch(e){return console.warn("Failed to write log to storage",e),Ee.storageSize=Ee.size+t,Ee.cleanup(ue+t),Ee.available>=ue+t?void fe():t>ue?(Te.bisect(),void fe()):void(Ee.storageSize=0)}t>524288&&(Ee.add(ye,t),ye=he(),Te.clear(),Ee.cleanup(ue))}function ge(){!Ee.available||!Te.length||fe()}function ve(e=!1){let t=[];try{let e=window.localStorage;for(let n of Ee.items){let i=e.getItem(n.key);t.push(i)}let n=Te.toString();n&&t.push(n)}catch(e){console.error("Storage is blocked",e)}let n=`[${t.join(",")}]`;if(e)return n;let i=`logs_${Date.now()}.json`;return function(e,t){let n=document.createElement("a"),i=new Blob([e],{type:"text/json"});n.href=URL.createObjectURL(i),n.download=t,n.click()}(n,i),i}function Se(){Ee||(Ee=new class{constructor(){this._items=[],this._itemsSize=0,this._storageSize=le;try{let e=window.localStorage;for(let t of Object.keys(e)){if(0!==t.indexOf(pe))continue;let n=e.getItem(t);if(!n){me(t);continue}let i=_e(n);this.add(t,i)}}catch(e){console.error("Storage is blocked",e),this._storageSize=0}this._items.sort(((e,t)=>e.date-t.date)),this.cleanup(ue)}get size(){return this._itemsSize}get length(){return this._items.length}get available(){return Math.max(this._storageSize-this._itemsSize,0)}get items(){return this._items}set storageSize(e){this._storageSize=e}add(e,t){let n=parseInt(e.replace(pe,""),10);this._itemsSize+=t,this._items.push({key:e,size:t,date:n})}deleteOldestItem(){let e=this._items.shift();e&&(me(e.key),this._itemsSize-=e.size)}cleanup(e){for(;this.length&&(this.size>le||this.length>4||this.size+e>this.available);)this.deleteOldestItem()}},Te=new class{constructor(){this._items=[]}get length(){return this._items.length}push(e){this._items.push(e)}shift(){return this._items.shift()||null}bisect(){let e=this.length>1?Math.floor(this.length/2):1;this._items=this._items.slice(e)}clear(){this._items=[]}toString(){return this._items.length?JSON.stringify(this._items,((e,t)=>t instanceof Error?String(t):t)):""}},ye=he(),window.addEventListener("beforeunload",ge))}var Ee,Te,ye,Ce=null;window.__VKCallsSDKLogs__=(e=!1)=>(Ee||Se(),ge(),ve(e));var Re,Ie,Pe,Ae,we=class{static get sessionKey(){return we._sessionKey}static set sessionKey(e){we._sessionKey=e}static get sessionSecretKey(){return we._sessionSecretKey}static set sessionSecretKey(e){we._sessionSecretKey=e}static get accessToken(){return we._accessToken}static set accessToken(e){we._accessToken=e}static isEmpty(){return!we._sessionKey||!we._sessionSecretKey}},Oe=class{static set(e){e.hasOwnProperty("voiceParams")&&(Object.assign(Oe._params.voiceParams,e.voiceParams),delete e.voiceParams),e.hasOwnProperty("specListenerParams")&&(Object.assign(Oe._params.specListenerParams,e.specListenerParams),delete e.specListenerParams),e.hasOwnProperty("unifiedPlanBrowsers")&&(Object.assign(Oe._params.unifiedPlanBrowsers,e.unifiedPlanBrowsers),delete e.unifiedPlanBrowsers),e.hasOwnProperty("apiAuth")&&(we.accessToken=e.apiAuth.accessToken,we.sessionKey=e.apiAuth.sessionKey,we.sessionSecretKey=e.apiAuth.sessionSecretKey),Object.assign(Oe._params,e)}static get(e){return Oe._params[e]}static get appName(){return"ok.calls.sdk.js"}static get appVersion(){return 1.1}static get sdkVersion(){return"2.4.3-beta.4"}static get debug(){return!1}static get protocolVersion(){return 5}static get platform(){return Oe._params.platform}static set platform(e){Oe._params.platform=e}static get clientType(){return Oe._params.clientType}static set clientType(e){Oe._params.clientType=e}static get device(){return Oe._params.device}static get apiAppId(){return 42}static get apiKey(){return Oe._params.apiKey}static get apiEnv(){switch(Oe._params.apiEnv){case"TEST":return{api:"https://apitest.ok.ru/api/",connect:"https://test.ok.ru/"};case"VIDEOTEST":return{api:"https://videotestapi.ok.ru/api/",connect:"https://test.ok.ru/"};case"DEV":return{api:"https://1.api.an-eremeev.devdc.odkl.ru/api/",connect:"https://1.web.an-eremeev.devdc.odkl.ru/"};default:return{api:"https://api.ok.ru/",connect:"https://connect.ok.ru/"}}}static get authToken(){return Oe._params.authToken}static set authToken(e){Oe._params.authToken=e}static get anonymToken(){return Oe._params.anonymToken}static set anonymToken(e){Oe._params.anonymToken=e}static get domain(){return Oe._params.domain}static get iceServers(){return Oe._params.iceServers}static set iceServers(e){Oe._params.iceServers=e}static get wssBase(){return Oe._params.wssBase}static set wssBase(e){Oe._params.wssBase=e}static get wssToken(){return Oe._params.wssToken}static set wssToken(e){Oe._params.wssToken=e}static get signalingReconnectDelay(){return Oe._params.signalingReconnectDelay}static get signalingReconnectMaxDelay(){return Oe._params.signalingReconnectMaxDelay}static get signalingReconnectMaxCount(){return Oe._params.signalingReconnectMaxCount}static get waitConnectionDelay(){return Oe._params.waitConnectionDelay}static get waitResponseDelay(){return Oe._params.waitResponseDelay}static get waitMessageDelay(){return Oe._params.waitMessageDelay}static get debugLog(){return Oe._params.debugLog}static get forceRelayPolicy(){return Oe._params.forceRelayPolicy}static set forceRelayPolicy(e){Oe._params.forceRelayPolicy=e}static get videoMinWidth(){return Oe._params.videoMinWidth}static get videoMaxWidth(){return Oe._params.videoMaxWidth}static set videoMaxWidth(e){Oe._params.videoMaxWidth=e}static get videoMinHeight(){return Oe._params.videoMinHeight}static get videoMaxHeight(){return Oe._params.videoMaxHeight}static set videoMaxHeight(e){Oe._params.videoMaxHeight=e}static get videoAspectRatio(){return Oe._params.videoAspectRatio}static get videoFrameRate(){return Oe._params.videoFrameRate}static get videoFacingMode(){return Oe._params.videoFacingMode}static get screenFrameRate(){return Oe._params.screenFrameRate}static get videoEffects(){return Oe._params.videoEffects}static set videoEffects(e){Oe._params.videoEffects=e}static get videoEffectMaxWidth(){return Oe._params.videoEffectMaxWidth}static set videoEffectMaxWidth(e){Oe._params.videoEffectMaxWidth=e}static get videoEffectMaxHeight(){return Oe._params.videoEffectMaxHeight}static set videoEffectMaxHeight(e){Oe._params.videoEffectMaxHeight=e}static get voiceParams(){return Oe._params.voiceParams}static get specListenerParams(){return Oe._params.specListenerParams}static get iceRestartWaitTime(){return Oe._params.iceRestartWaitTime}static get transportConnectionWaitTime(){return Oe._params.transportConnectionWaitTime}static get statisticsInterval(){return Oe._params.statisticsInterval}static set statisticsInterval(e){Oe._params.statisticsInterval=e}static get networkStatisticsInterval(){return Oe._params.networkStatisticsInterval}static get perfStatReportEnabled(){return Oe._params.perfStatReportEnabled}static get producerNotificationDataChannel(){return Oe._params.producerNotificationDataChannel}static get producerCommandDataChannel(){return Oe._params.producerCommandDataChannel}static get consumerScreenDataChannel(){return Oe._params.consumerScreenDataChannel}static set consumerScreenDataChannel(e){Oe._params.consumerScreenDataChannel=e}static get producerScreenDataChannel(){return Oe._params.producerScreenDataChannel&&Oe._params.producerNotificationDataChannel}static set producerScreenDataChannel(e){Oe._params.producerScreenDataChannel=e}static get noiseSuppression(){return Oe._params.noiseSuppression}static set noiseSuppression(e){Oe._params.noiseSuppression=e}static get preferH264(){return Oe._params.preferH264}static get preferVP9(){return Oe._params.preferVP9}static get audioNack(){return Oe._params.audioNack}static get consumerScreenTrack(){return Oe._params.consumerScreenTrack&&Oe._params.consumerScreenDataChannel}static get producerScreenTrack(){return Oe._params.producerScreenTrack&&Oe._params.producerScreenDataChannel}static isUnifiedPlanSupported(e,t){let n=Oe._params.unifiedPlanBrowsers;return!!n.hasOwnProperty(e)&&t>=n[e]}static get videoTracksCount(){return Oe._params.videoTracksCount}static get breakVideoPayloadTypes(){return Oe._params.breakVideoPayloadTypes}static get filteredMessages(){return Oe._params.filteredMessages}static get batchParticipantsOnStart(){return Oe._params.batchParticipantsOnStart}static get participantStateMapped(){return Oe._params.participantStateMapped}},be=Oe;function De(e,...t){let n=be.get(e);n&&setTimeout(n,0,...t)}function Ne(e){return Object.assign({},e)}function ke(e){return e.slice()}be._params={platform:"WEB",clientType:"PORTAL",device:"browser",apiKey:"",authToken:"",anonymToken:"",apiEnv:"PROD",domain:"",iceServers:[],wssBase:"",wssToken:"",signalingReconnectDelay:1e3,signalingReconnectMaxDelay:5e3,signalingReconnectMaxCount:20,waitConnectionDelay:1e4,waitResponseDelay:1e4,waitMessageDelay:15e3,debugLog:!1,forceRelayPolicy:!1,videoMinWidth:428,videoMinHeight:240,videoMaxWidth:1280,videoMaxHeight:720,videoAspectRatio:16/9,videoFrameRate:25,screenFrameRate:15,videoEffects:null,videoEffectMaxWidth:640,videoEffectMaxHeight:360,iceRestartWaitTime:2e4,transportConnectionWaitTime:5e3,statisticsInterval:5e3,networkStatisticsInterval:2e4,perfStatReportEnabled:!0,voiceParams:{smoothing:.8,minFreq:200,maxFreq:5e3,interval:500,threshold:.35,speakerLevelMultiplier:1.8},specListenerParams:{connectionTimeout:1e4,volumeTimeout:1e4},unifiedPlanBrowsers:{Firefox:10,Chrome:76,Safari:12},producerNotificationDataChannel:!0,producerCommandDataChannel:!0,consumerScreenDataChannel:!0,producerScreenDataChannel:!0,noiseSuppression:!0,preferH264:!1,preferVP9:!0,audioNack:!0,consumerScreenTrack:!1,producerScreenTrack:!1,videoTracksCount:0,filteredMessages:!1,breakVideoPayloadTypes:!1,batchParticipantsOnStart:!1,participantStateMapped:!1},(Ie=Re||(Re={})).WAITING_HALL="WAITING_HALL",Ie.WAITING="WAITING",Ie.CONNECTING="CONNECTING",Ie.CONNECTED="CONNECTED",Ie.RECONNECT="RECONNECT",Ie.ERROR="ERROR",Ie.HANGUP="HANGUP",Ie.PERMISSIONS="PERMISSIONS",(Ae=Pe||(Pe={})).onLocalStream=function(e,t){De("onLocalStream",e,Ne(t))},Ae.onScreenStream=function(e,t){De("onScreenStream",e,Ne(t))},Ae.onLocalStreamUpdate=function(e,t){De("onLocalStreamUpdate",Ne(e),t)},Ae.onLocalStatus=function(e){De("onLocalStatus",e)},Ae.onRemoteStream=function(e,t){De("onRemoteStream",e,t)},Ae.onRemoteLive=function(e,t,n){De("onRemoteLive",e,t,n)},Ae.onRemoteScreenStream=function(e,t){De("onRemoteScreenStream",e,t)},Ae.onConversation=function(e,t,n){De("onConversation",e,Ne(t),n)},Ae.onRemoteMediaSettings=function(e,t){De("onRemoteMediaSettings",e,Ne(t))},Ae.onRemoteParticipantState=function(e,t){De("onRemoteParticipantState",e,Ne(t))},Ae.onRemoteStatus=function(e,t,n=null){De("onRemoteStatus",e,t,n)},Ae.onParticipantStatus=function(e,t,n=null){De("onParticipantStatus",e,t,n)},Ae.onPermissionsRequested=function(){De("onPermissionsRequested")},Ae.onPermissionsError=function(e){De("onPermissionsError",e)},Ae.onRemoteRemoved=function(e){De("onRemoteRemoved",e)},Ae.onCallState=function(e,t,n){De("onCallState",e,t,Ne(n))},Ae.onDeviceSwitched=function(e,t){De("onDeviceSwitched",e,t)},Ae.onUnmuteRequest=function(e){De("onUnmuteRequest",e)},Ae.onUnmutePermission=function(e){De("onUnmutePermission",e)},Ae.onRolesChanged=function(e,t){De("onRolesChanged",e,ke(t))},Ae.onLocalRolesChanged=function(e){De("onLocalRolesChanged",ke(e))},Ae.onPinnedParticipant=function(e,t){De("onPinnedParticipant",e,t)},Ae.onLocalPin=function(e){De("onLocalPin",e)},Ae.onOptionsChanged=function(e){De("onOptionsChanged",ke(e))},Ae.onCallAccepted=function(){De("onCallAccepted")},Ae.onRateNeeded=function(){De("onRateNeeded")},Ae.onSpeakerChanged=function(e){De("onSpeakerChanged",e)},Ae.onVolumesDetected=function(e){De("onVolumesDetected",ke(e))},Ae.onLocalVolume=function(e,t){De("onLocalVolume",e,t)},Ae.onJoinStatus=function(e,t){De("onJoinStatus",e,t)},Ae.onHangup=function(e,t){De("onHangup",e,t)},Ae.onMultipartyChatCreated=function(e){De("onMultipartyChatCreated",Ne(e))},Ae.onDeviceChange=function(){De("onDeviceChange")},Ae.onFingerprintChange=function(e){De("onFingerprintChange",e)},Ae.onTokenExpired=function(){De("onTokenExpired")},Ae.onChatMessage=function(e,t,n=!1){De("onChatMessage",e,t,n)},Ae.onCustomData=function(e,t,n=!1){De("onCustomData",e,t,n)},Ae.onRecordStarted=function(e,t,n,i,r,a){De("onRecordStarted",e,t,n,i,r,a)},Ae.onRecordStopped=function(){De("onRecordStopped")},Ae.onLocalNetworkStatusChanged=function(e){De("onLocalNetworkStatusChanged",e)},Ae.onNetworkStatusChanged=function(e){De("onNetworkStatusChanged",e)},Ae.onDebugMessage=function(e,...t){De("onDebugMessage",e,...t)},Ae.onStatistics=function(e,t){De("onStatistics",Object.assign({},e,{memory:t}))},Ae.onAutoplayError=function(){De("onAutoplayError")},Ae.onChatRoomUpdated=function(e,t,n){De("onChatRoomUpdated",e,t,n)};var Me,Le,Ue=Pe;!function(e){e.DEBUG="DEBUG",e.LOG="LOG",e.WARN="WARN",e.ERROR="ERROR"}(Me||(Me={})),function(e){let t="📞",n=(e,...t)=>{Ue.onDebugMessage(e,...t)},i=!1,r=(e,t)=>(...n)=>{e(...n),function(e,t){!Ee.available||(Te.push({t:Date.now(),l:e,d:t}),Ce||(Ce=window.setTimeout((()=>{Ce=null,ge()}),3e4)))}(t,n)},a=console.debug.bind(console,t),s=console.log.bind(console,t),o=console.warn.bind(console,t),c=console.error.bind(console,t),d=n.bind(null,Me.DEBUG),l=n.bind(null,Me.LOG),u=n.bind(null,Me.WARN),p=n.bind(null,Me.ERROR);e.debug=d,e.log=l,e.warn=u,e.error=p,e.enabled=function(){return i},e.toggle=function(t){i=t,be.debugLog&&Se(),t?(e.debug=be.debugLog?r(a,Me.DEBUG):a,e.log=be.debugLog?r(s,Me.LOG):s,e.warn=be.debugLog?r(o,Me.WARN):o,e.error=be.debugLog?r(c,Me.ERROR):c):(e.debug=be.debugLog?r(d,Me.DEBUG):d,e.log=be.debugLog?r(l,Me.LOG):l,e.warn=be.debugLog?r(u,Me.WARN):u,e.error=be.debugLog?r(p,Me.ERROR):p)},e.send=function(t,...n){switch(t){case Me.DEBUG:e.debug(...n);break;case Me.LOG:e.log(...n);break;case Me.WARN:e.warn(...n);break;case Me.ERROR:e.error(...n)}}}(Le||(Le={}));var xe,Ge=Le,Ve="_okcls_",Fe=(()=>{try{let e=Date.now().toString(),t=window.localStorage,n=!1;return t.setItem(e,e),n=t.getItem(e)===e,t.removeItem(e),n?t:null}catch(e){return null}})();!function(e){e.get=function(e){return function(e){let t=Fe?Fe.getItem(Ve+e):null;if(null===t)return null;try{return JSON.parse(t)}catch(e){return null}}(e)||null},e.set=function(e,t){!function(e,t){try{Fe&&Fe.setItem(Ve+e,JSON.stringify(t))}catch(e){}}(e,t)},e.remove=function(e){!function(e){Fe&&Fe.removeItem(Ve+e)}(e)}}(xe||(xe={}));var He,je,Be,We,$e=xe,Ke=null,qe=null,Je=[],Ye=[],ze=[],Xe=null,Qe=null,Ze=null,et=!1,tt=!1,nt=!1,it=!1,rt=null,at="",st=[],ot=null,ct=navigator.appVersion,dt=navigator.appName,lt=navigator.userAgent;!function(e){e.USER="user",e.ENVIRONMENT="environment",e.LEFT="left",e.RIGHT="right"}(We||(We={}));var ut,pt=class{constructor(e,t=!1,n=be.videoMaxWidth,i=be.videoMaxHeight){let r=!1;if(e){let t;r={noiseSuppression:be.noiseSuppression,echoCancellation:!0,autoGainControl:!0},Qe&&(t=Qe.deviceId),"string"==typeof e&&(t=e),t&&(r.deviceId={exact:t})}let a=!1;if(t){let e;a={width:{min:be.videoMinWidth,max:n,ideal:n},height:{min:be.videoMinHeight,max:i,ideal:i},aspectRatio:{ideal:be.videoAspectRatio},frameRate:{ideal:be.videoFrameRate}},Xe&&(e=Xe.deviceId),"string"==typeof t&&(e=t),e&&(a.deviceId={exact:e}),be.videoFacingMode&&(a.facingMode={exact:be.videoFacingMode})}this.audio=r,this.video=a,this.needVideo=!!a}getNative(){return Object.assign({},{audio:this.audio,video:this.video})}simplify(){return"object"==typeof this.video&&(this.video.width||this.video.height?(delete this.video.width,delete this.video.height):this.video.aspectRatio?delete this.video.aspectRatio:this.video.frameRate?delete this.video.frameRate:(this.video.deviceId||this.video.facingMode)&&(delete this.video.deviceId,delete this.video.facingMode)),"object"==typeof this.audio&&(this.audio.echoCancellation||this.audio.autoGainControl||this.audio.noiseSuppression?(delete this.audio.echoCancellation,delete this.audio.autoGainControl,delete this.audio.noiseSuppression):this.audio.deviceId&&delete this.audio.deviceId),!0===this.video&&!0===this.audio?this.video=!1:!1===this.video&&!0===this.audio?(this.audio=!1,this.video=this.needVideo):!0===this.video&&!1===this.audio&&(this.video=!1),this.video&&!Object.keys(this.video).length&&(this.video=!0),this.audio&&!Object.keys(this.audio).length&&(this.audio=!0),this}canSimplify(){let e="object"==typeof this.video&&(this.video.width||this.video.height||this.video.aspectRatio||this.video.frameRate||this.video.facingMode||this.video.deviceId)||this.video;return!!("object"==typeof this.audio&&(this.audio.deviceId||this.audio.noiseSuppression||this.audio.echoCancellation||this.audio.autoGainControl)||this.audio||e)}isVideo(){return!!this.video}isAudio(){return!!this.audio}},ht=class extends pt{constructor(e,t){super(!1,!0),"object"==typeof this.video?(delete this.video.deviceId,delete this.video.aspectRatio,delete this.video.frameRate,delete this.video.facingMode):this.video={},this.video.cursor="motion",this.video.width=e,this.video.height=t,this.video.frameRate=be.screenFrameRate}};function _t(){Ke=null,mt().then((()=>Ue.onDeviceChange()))}function mt(){return f(this,null,(function*(){return Ke||(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(!qe&&navigator.mediaDevices.addEventListener&&(qe=bt.throttle(_t,1e3),navigator.mediaDevices.addEventListener("devicechange",qe)),Ke=navigator.mediaDevices.enumerateDevices().then((e=>{Je=e.filter((e=>"videoinput"===e.kind&&(e.label&&(et=!0),!0))),Ye=e.filter((e=>"audioinput"===e.kind&&(e.label?tt=!0:ut.isMobile()&&"Firefox"===ut.browserName()&&(tt=et),!0))),ze=e.filter((e=>"audiooutput"===e.kind));let t=$e.get("videoinput"),n=$e.get("audioinput"),i=$e.get("audiooutput");return Xe=Je.find((e=>e.deviceId===t))||null,Qe=Ye.find((e=>e.deviceId===n))||null,Ze=ze.find((e=>e.deviceId===i))||null,Ke=Promise.resolve(e),e})).catch((()=>(Ke=null,[])))):[])}))}function ft(e,t){return f(this,null,(function*(){Ge.debug("Try to get media",e.getNative());let n=ut.hasPermissions(e.isVideo());!n&&!t&&Ue.onPermissionsRequested();try{let t=yield navigator.mediaDevices.getUserMedia(e.getNative());return n||(yield function(){return f(this,null,(function*(){Ke=null,yield mt()}))}()),t}catch(n){switch(n.name){case"PermissionDeniedError":case"PermissionDismissedError":case"NotAllowedError":case"SecurityError":case"DOMException":t=e.isVideo()?L.CAMERA_PERMISSION:L.MIC_PERMISSION;break;case"OverconstrainedError":case"TypeError":case"NotFoundError":break;case"AbortError":case"NotReadableError":t=e.isVideo()?L.CAMERA_ACCESS:L.MIC_ACCESS}if(e.canSimplify())return ft(e.simplify(),t);let i=t||L.UNKNOWN;throw Ue.onPermissionsError(i),i}}))}function gt(){return st.length||(st=(()=>{let e,t=!1,n=0,i=lt.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(i[1]))return e=/\brv[ :]+(\d+)/g.exec(lt),["IE",e&&e[1]||"Unknown",t,n];if("Safari"===i[1]){if(e=lt.match(/\bEdge\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,n];if(e=lt.match(/\bCriOS\/(\d+)/),e)return["Chrome",e[1],!0,e[1]];if(e=lt.match(/\bFxiOS\/(\d+)/),e)return["Firefox",e[1],!1,n];if(e=lt.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1],!1,n];if(e=lt.match(/\bOPT\/(\d+)/),e)return["Opera",e[1],!1,n]}if("Chrome"===i[1]){if(t=!0,n=Number(i[2]),e=lt.match(/\bOPR\/(\d+)/),e)return["Opera",e[1]||"Unknown",t,n];if(e=lt.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1]||"Unknown",t,n];if(e=lt.match(/\bSferum\/((\d+)(?:\.\d+)*)/),e)return["Sferum",e[1]||"Unknown",t,n];if(e=lt.match(/\bEdge?\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,n];if(void 0!==window.opr&&/^(.+\.)?ok.ru$/.test(window.location.host))return["Opera","Hidden",t,n]}return e=lt.match(/version\/(\d+)/i),[i[2]?i[1]:dt,e&&e[1]||i[2]||ct,t,n]})()),st}!function(e){function t(){return Je.length>0}function n(){return Ye.length>0}function i(){return et}function r(){return tt}function a(){if(!Be||"ended"===Be.readyState){let e=d(),t=e.createMediaStreamDestination(),n=e.createGain();n.gain.value=1e-5,n.connect(t),n.connect(e.destination);let i=e.createOscillator();i.type="sine",i.frequency.value=0,i.connect(n),i.start(),Be=t.stream.getAudioTracks()[0]}return Object.assign(Be.clone(),{enabled:!1})}function s(e=be.videoMinWidth,t=be.videoMinHeight){return je||(je=document.createElement("canvas")).getContext("2d"),je.width=e,je.height=t,(!He||"ended"===He.readyState)&&(He=je.captureStream(be.videoFrameRate).getVideoTracks()[0]),Object.assign(He.clone(),{enabled:!1})}function o(){return gt()[0]}function c(){return gt()[1]}function d(){return ot||(ot=new(window.AudioContext||window.webkitAudioContext)),ot}e.init=function(){return f(this,null,(function*(){return yield function(){return f(this,null,(function*(){return ut.isBrowserSupported()?new Promise((e=>{(new window.RTCPeerConnection).createOffer({offerToReceiveVideo:!0}).then((t=>{/^a=rtpmap:\d+ VP8\/\d+$/m.test(t.sdp)&&(nt=!0),/^a=mid:0$/m.test(t.sdp)&&(it=!0),e()})).catch(e)})):Promise.resolve()}))}(),mt()}))},e.getCameras=function(){return Je},e.getMicrophones=function(){return Ye},e.getOutput=function(){return ze},e.hasCamera=t,e.hasMicrophone=n,e.getSavedCamera=function(){return Xe},e.getSavedMicrophone=function(){return Qe},e.getSavedOutput=function(){return Ze},e.hasCameraPermission=i,e.hasMicrophonePermission=r,e.hasPermissions=function(e=!1){return!!r()&&(!t()||!e||i())},e.getUserMedia=function(e=!1,i=!0){return f(this,null,(function*(){let r,o=n()&&i,c=t()&&e;if(o||c)try{r=yield ft(new pt(o,c))}catch(e){r=new MediaStream}else r=new MediaStream;return r.getVideoTracks().length||r.addTrack(s()),r.getAudioTracks().length||r.addTrack(a()),r}))},e.getScreenMedia=function(){return f(this,null,(function*(){return function(e){return f(this,null,(function*(){Ge.debug("Try to get screen",e.getNative());try{let t=yield navigator.mediaDevices.getDisplayMedia(e.getNative()),n=null==t?void 0:t.getVideoTracks()[0];return n&&(Ge.debug("Got display media track",n.id),n.contentHint="text"),t}catch(e){switch(e.name){case"PermissionDeniedError":case"NotAllowedError":case"SecurityError":throw L.SCREEN_PERMISSION;default:throw L.SCREEN_ACCESS}}}))}(new ht(window.screen.width,window.screen.height))}))},e.getUserVideo=function(e,t=!1){return f(this,null,(function*(){let n=t?be.videoEffectMaxWidth:be.videoMaxWidth,i=t?be.videoEffectMaxHeight:be.videoMaxHeight;return ft(new pt(!1,e||!0,n,i))}))},e.getUserAudio=function(e){return f(this,null,(function*(){return ft(new pt(e||!0,!1))}))},e.saveDeviceId=function(e,t){return f(this,null,(function*(){let n=(yield mt()).find((n=>n.kind===e&&n.deviceId===t));return n?("videoinput"===e?Xe=n:"audioinput"===e?Qe=n:"audiooutput"===e&&(Ze=n),$e.set(e,t),n):null}))},e.getSilentMediaTrack=a,e.getBlackMediaTrack=s,e.isBrowserSupported=function(){if("Edge"===o()&&c()<70)return!1;try{let e=window;return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&e.RTCPeerConnection&&e.RTCIceCandidate&&e.RTCSessionDescription&&e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype.captureStream&&e.RTCRtpSender&&e.RTCRtpSender.prototype.replaceTrack&&e.RTCRtpSender.prototype.getParameters&&navigator.sendBeacon)}catch(e){return!1}},e.isScreenCapturingSupported=function(){return!!navigator.mediaDevices.getDisplayMedia},e.canVP8=function(){return nt},e.isUnifiedPlan=function(){return it},e.isBrokenH264=function(){return"Opera"===e.browserName()&&"Windows"===e.os()},e.canPreferH264=function(){return!(e.baseChromeVersion()&&e.isMobile())},e.os=function(){return at||(at=(()=>{let e={Windows:/Win/,Android:/Android/,OpenBSD:/OpenBSD/,SunOS:/SunOS/,Linux:/(Linux|X11)/,iPad:/(iPad)/,iPhone:/(iPhone)/,iPod:/(iPod)/,MacOS:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh|Mac OS X)/,QNX:/QNX/,UNIX:/UNIX/,BeOS:/BeOS/,OS2:/OS\/2/,Bot:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/};for(let t in e)if(e.hasOwnProperty(t)&&e[t].test(lt))return t;return"Unknown"})()),at},e.isMobile=function(){return null===rt&&(rt=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(ct)),rt},e.browserName=o,e.browserVersion=c,e.baseChromeVersion=function(){return gt()[3]},e.getAudioContext=d}(ut||(ut={}));var vt=ut;function St(e,t){if(e.isAudioEnabled!==t.isAudioEnabled||e.isVideoEnabled!==t.isVideoEnabled||e.isScreenSharingEnabled!==t.isScreenSharingEnabled||e.videoStreams.length!==t.videoStreams.length)return!1;for(let n of e.videoStreams)if(!t.videoStreams.find((e=>e.name===n.name&&e.source===n.source)))return!1;return!0}function Et(e){return Object.assign({isAudioEnabled:!1,isVideoEnabled:!1,isScreenSharingEnabled:!1,videoStreams:[]},e||{})}var Tt,yt,Ct=class extends Error{constructor(e,t){super(),this.name="HangupReason",this.code=t&&t.code||0,this.remote=t&&t.remote||!1,Object.values(x).indexOf(e)>-1?this.hangup=e:this.error=e;let n=[];this.error&&n.push("error"),this.remote&&n.push("remote"),this.code&&n.push(`code: ${this.code}`),t&&t.message&&n.push(`message: '${t.message}'`),this.message=e+(n.length?` (${n.join(", ")})`:""),Error.captureStackTrace&&Error.captureStackTrace(this,Ct)}},Rt=class extends v{constructor(e,t){super(),this._batchInterval=3e3,this._batch=[],this._batchTimeout=null,this._api=e,this._externalLogger=t}_send(e){this._api.log(e)}_sendBatch(){this._stopTimeout(),this._batch.length>0&&(this._send(this._batch),this._batch=[],this._startTimeout())}_startTimeout(){this._batchTimeout=window.setTimeout((()=>this._sendBatch()),this._batchInterval)}_stopTimeout(){this._batchTimeout&&(clearTimeout(this._batchTimeout),this._batchTimeout=null)}_onUnload(){this._sendBatch(),this._stopTimeout()}log(e,t,n=!1){let i={type:1,time:0,operation:e,timestamp:Date.now(),custom:{},uid:this._api.getUserId()};void 0!==t&&(i.custom.param=t),this._batch.push(i),(n||!this._batchTimeout)&&this._sendBatch(),this._externalLogger&&this._externalLogger.log(e,t,n)}destroy(){this._sendBatch(),this._stopTimeout(),this._externalLogger&&this._externalLogger.destroy()}static create(e,t){Rt._instance||(Rt._instance=new Rt(e,t))}static log(e,t,n=!1){Rt._instance&&Rt._instance.log(e,t,n)}static destroy(){Rt._instance&&Rt._instance.destroy(),Rt._instance=null}};!function(e){e.SOURCE_CHANGED="SOURCE_CHANGED",e.TRACK_REPLACED="TRACK_REPLACED",e.SCREEN_STATUS="SCREEN_STATUS"}(Tt||(Tt={})),function(e){e.audio="audio",e.video="video",e.screen="screen"}(yt||(yt={}));var It,Pt=class extends S{constructor(){super(),this._stream=null,this._screenTrack=null,this._sendVideoTrack=null,this._mediaSettings=Et(),this._videoStatusOnScreenCapturingEnabled=!1,this._effect=null,this._initDeviceChangeListener()}request(){return f(this,arguments,(function*(e=[V.AUDIO]){if(this._stream)return;let t=e.includes(V.VIDEO),n=e.includes(V.AUDIO);if(!vt.isBrowserSupported())throw new Ct(L.UNSUPPORTED);try{this._stream=yield vt.getUserMedia(t,n),this._mediaSettings.isVideoEnabled=t&&this._stream.getVideoTracks().filter((e=>e.enabled)).length>0||!1,this._mediaSettings.isAudioEnabled=n&&this._stream.getAudioTracks().filter((e=>e.enabled)).length>0||!1}catch(e){throw new Ct(e)}}))}getStream(){return this._stream}getScreenTrack(){return this._screenTrack}getSendVideoTrack(e=!1){return this._sendVideoTrack&&!e?this._sendVideoTrack:this._stream?this._stream.getVideoTracks()[0]:null}_getSendAudioTrack(){var e;return(null==(e=this._stream)?void 0:e.getAudioTracks()[0])||null}addTrackToPeerConnection(e,t=!1){let n=this.getStream(),i=this._getSendAudioTrack(),r=this.getSendVideoTrack(t);if(!n||!i&&!r)throw new Error("No local stream found");i&&e.addTrack(i,n),r&&e.addTrack(r,n)}getMediaSettings(){return this._mediaSettings}changeDevice(e){return f(this,null,(function*(){switch(e){case"videoinput":return this._changeVideoInput();case"audioinput":return this._changeAudioInput();default:return Promise.reject()}}))}setVideoStream(e,t){return f(this,null,(function*(){return t?this._changeScreen(e):this._changeVideoInput(e)}))}_initDeviceChangeListener(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices||!navigator.mediaDevices.addEventListener)return;let e=!1,t=!1,n=bt.throttle((()=>{t&&this._changeVideoInput().catch((()=>{})),e&&this._changeAudioInput().catch((()=>{})),e=!1,t=!1}),1e3);navigator.mediaDevices.addEventListener("devicechange",(()=>f(this,null,(function*(){if(!this._stream)return;let i=this._stream.getAudioTracks()[0],r=i&&i.enabled&&i.getSettings(),a=r&&r.groupId,s=this._stream.getVideoTracks()[0],o=s&&s.enabled&&s.getSettings(),c=o&&o.groupId;if(!a&&!c)return;let d=yield navigator.mediaDevices.enumerateDevices();!e&&a&&(e=!d.find((e=>e.groupId===a))),!t&&c&&(t=!d.find((e=>e.groupId===c))),n()}))))}_changeVideoInput(e=null){return f(this,null,(function*(){try{let t=e?"stream":"video";if(e=e||(yield vt.getUserVideo(void 0,!!this._effect)),this._stream){this._disableScreenCapture();let n=yield this._videoEffect(this._effect,e.getVideoTracks()[0]);this._stopLocalTrack(yt.video),Rt.log(ee.DEVICE_CHANGED,t),Ge.log("Video stream changed"),yield this._replaceLocalTrack(n),this._mediaSettings.isVideoEnabled=!0,this._triggerEvent(Tt.SOURCE_CHANGED,{kind:yt.video,mediaSettings:this._mediaSettings})}else e.getTracks().forEach((e=>e.stop()))}catch(e){throw Rt.log(ee.ERROR,"change_video"),Ge.warn("Camera change failed",e),e}}))}setAudioStream(e){return f(this,null,(function*(){return this._changeAudioInput(e)}))}_changeAudioInput(e=null){return f(this,null,(function*(){try{if(e=e||(yield vt.getUserAudio()),this._stream){let t=e.getAudioTracks()[0];this._stopLocalTrack(yt.audio),Rt.log(ee.DEVICE_CHANGED,"audio"),Ge.log("Audio stream changed"),yield this._replaceLocalTrack(t),this._mediaSettings.isAudioEnabled=!0,this._triggerEvent(Tt.SOURCE_CHANGED,{kind:yt.audio,mediaSettings:this._mediaSettings})}else e.getTracks().forEach((e=>e.stop()))}catch(e){throw Rt.log(ee.ERROR,"change_audio"),Ge.error("Microphone change failed",e),e}}))}_changeScreen(e){return f(this,null,(function*(){try{if((e=e||(yield vt.getScreenMedia())).addEventListener("inactive",(()=>{this._mediaSettings.isScreenSharingEnabled&&this.toggleScreenCapturing(!1)}),!1),this._stream){let t=yield this._videoEffect(null,e.getVideoTracks()[0]);Rt.log(ee.DEVICE_CHANGED,"screen"),Ge.log("Screen capturing started"),this._screenTrack=t,this._mediaSettings.isScreenSharingEnabled=!0,be.consumerScreenTrack||(this._videoStatusOnScreenCapturingEnabled=this._mediaSettings.isVideoEnabled,this._mediaSettings.isVideoEnabled=!0,this._stopLocalTrack(yt.video),this._sendVideoTrack=be.consumerScreenDataChannel?vt.getBlackMediaTrack(be.videoMinWidth,be.videoMinHeight):t,yield this._replaceLocalTrack(t,this._sendVideoTrack)),this._triggerEvent(Tt.SCREEN_STATUS,{track:t,mediaSettings:this._mediaSettings}),this._triggerEvent(Tt.SOURCE_CHANGED,{kind:yt.screen,mediaSettings:this._mediaSettings})}else e.getTracks().forEach((e=>e.stop()))}catch(e){throw Rt.log(ee.ERROR,"screen"),Ge.warn("Screen capturing failed",e),e}}))}_disableScreenCapture(){this._sendVideoTrack&&(this._sendVideoTrack.stop(),this._sendVideoTrack=null),this._screenTrack&&(this._screenTrack.stop(),this._screenTrack=null),this._mediaSettings.isScreenSharingEnabled&&(this._mediaSettings.isScreenSharingEnabled=!1,this._triggerEvent(Tt.SCREEN_STATUS,{mediaSettings:this._mediaSettings}),this._triggerEvent(Tt.SOURCE_CHANGED,{kind:yt.screen,mediaSettings:this._mediaSettings}))}_replaceLocalTrack(e,t){return f(this,null,(function*(){!this._stream||this._stream.getTracks().forEach((n=>{var i,r;n.kind===e.kind&&(null==(i=this._stream)||i.removeTrack(n),null==(r=this._stream)||r.addTrack(e),this._triggerEvent(Tt.TRACK_REPLACED,e,t))}))}))}_stopLocalTrack(e){this._stream&&this._stream.getTracks().forEach((t=>{t.kind===e&&t.stop()}))}_videoEffect(e,t){return f(this,null,(function*(){if(!be.videoEffects)return t;try{return Rt.log(ee.DEVICE_CHANGED,`effect_${e}`),be.videoEffects.setEffect(e,t)}catch(e){return Ge.warn("Video effect failed",e),t}}))}destroy(){be.videoEffects&&(this._effect=null,be.videoEffects.stopEffect()),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null),this._disableScreenCapture()}toggleScreenCapturing(e){return f(this,null,(function*(){return e?this._changeScreen():be.consumerScreenTrack?this._disableScreenCapture():this._videoStatusOnScreenCapturingEnabled?this._changeVideoInput():this.toggleVideo(!1)}))}toggleVideo(e){return f(this,null,(function*(){if(!this._stream)return;let t;be.consumerScreenTrack||this._disableScreenCapture(),e?(t=(yield vt.getUserVideo(void 0,!!this._effect)).getVideoTracks()[0],t=yield this._videoEffect(this._effect,t)):(t=vt.getBlackMediaTrack(be.videoMinWidth,be.videoMinHeight),t=yield this._videoEffect(null,t)),this._stopLocalTrack(yt.video),yield this._replaceLocalTrack(t),this._mediaSettings.isVideoEnabled=e,this._triggerEvent(Tt.SOURCE_CHANGED,{kind:yt.video,mediaSettings:this._mediaSettings})}))}toggleAudio(e){return f(this,null,(function*(){if(!this._stream)return;let t;t=e?(yield vt.getUserAudio()).getAudioTracks()[0]:vt.getSilentMediaTrack(),this._stopLocalTrack(yt.audio),yield this._replaceLocalTrack(t),this._mediaSettings.isAudioEnabled=e,this._triggerEvent(Tt.SOURCE_CHANGED,{kind:yt.audio,mediaSettings:this._mediaSettings})}))}setResolution(e,t){return f(this,null,(function*(){if(!be.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled)return;if(!this._stream)throw new Error("Local stream not found");let n=this._stream.getVideoTracks()[0];if(!n)throw new Error("Local video track not found");return n.enabled?n.applyConstraints({width:{ideal:e},height:{ideal:t}}):void 0}))}updateNoiseSuppression(){return f(this,null,(function*(){if(!this._stream||!this._mediaSettings.isAudioEnabled)return;let e=this._stream.getAudioTracks()[0];if(!e)throw new Error("Local audio track not found");return e.enabled?e.applyConstraints({noiseSuppression:be.noiseSuppression}):void 0}))}videoEffect(e){return f(this,null,(function*(){if(!be.videoEffects)throw new Error("Video Effects library is not set");if(!be.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled)throw new Error("Can't apply effect to screensharing");if(this._mediaSettings.isVideoEnabled)return this._stream&&e!==this._effect?(this._effect=e,this._changeVideoInput()):void 0;this._effect=e}))}};!function(e){e.patchSDP=function(e,t,n,i,r=!1){let a=/[\r\n]+/,s="\r\n";if(!t&&!n&&!i)return r?o(e.split(a)).join(s):e;function o(e){let t=e.findIndex((e=>e.startsWith("a=rtcp-fb:111")));return~t&&(e[t]=e[t]+s+["a=rtcp-fb:111 nack","a=rtcp-fb:111 nack pli"].join(s)),e}function c(e,t,n){let i,r=e.split(" "),a=r.slice(0,3);for(i=3;i<r.length;i++)n.includes(r[i])&&a.push(r[i]);for(i=3;i<r.length;i++)!n.includes(r[i])&&!t.includes(r[i])&&a.push(r[i]);return a.join(" ")}function d(e,t){let n,i=new RegExp("a=rtpmap:(\\d+) ([a-zA-Z0-9-]+)\\/\\d+"),r=[];for(n=0;n<e.length;++n){let a=e[n].match(i);a&&3===a.length&&a[2]===t&&r.push(a[1])}return r}function l(e,t,n,i){let r,a="m="+t;for(r=0;r<e.length;++r)if(e[r].startsWith(a)){e[r]=c(e[r],n,i);break}}let u=[],p=e.split(a);(n||t)&&(u=d(p,"H264"));let h=[];if(i&&(h=d(p,"VP9")),n){let e,t=u.slice(0),n=new RegExp("a=fmtp:(\\d+) apt=(\\d+)");for(e=0;e<p.length;++e){let i=p[e].match(n);i&&3===i.length&&t.includes(i[2])&&t.push(i[1])}let i=new RegExp("a=(rtpmap|rtcp-fb|fmtp):(\\d+) .*");for(e=p.length;e--;){let n=p[e].match(i);n&&3===n.length&&t.includes(n[2])&&p.splice(e,1)}l(p,"video",t,[])}else t&&l(p,"video",[],u);return i&&l(p,"video",[],h),r&&o(p),p.join(s)},e.getPeerIdString=function(e){return e?`${e.type||"WEB_SOCKET"}_${e.id}`:"_"},e.comparePeerId=function(e,t){return e&&e.id===t.id&&(e.type||"WEB_SOCKET")===(t.type||"WEB_SOCKET")},e.getPeerConnectionHostInfo=function(e){return f(this,null,(function*(){return e&&e.getStats?e.getStats(null).then((e=>{let t=null,n=null;if(e.forEach((t=>{"transport"===t.type&&t.selectedCandidatePairId?n=e.get(t.selectedCandidatePairId):"candidate-pair"===t.type&&"succeeded"===t.state&&!n&&(!t.hasOwnProperty("selected")||t.selected)&&(n=t)})),n&&n.localCandidateId){let i=e.get(n.localCandidateId);i&&(t={type:i.candidateType,ip:i.ip||i.ipAddress,port:i.port||i.portNumber})}return t})).catch((()=>null)):Promise.resolve(null)}))};let t=/^[0-9]+$/,n=/^([gu])([0-9]+)$/;function i(e,i){let r=String(e);return n.test(r)?(Ge.warn(`Already composite id [${e}] type supplied [${i}]`),r):i===de.GROUP?"g"+r:i===de.USER?"u"+r:(Ge.warn(`Unknown type [${i}] for id [${e}]`),r.match(t)?"u"+r:r)}function r(e){return i(e.id,e.idType||de.USER)}function a(e,t,n,i,r){if(e&&n&&n.kind===yt.video){let a=n.getSettings();if(a){let s=e.maxBitrateK?1024*e.maxBitrateK:null,o=a.width,c=a.height,d=o&&c&&e.maxDimension?Math.max(1,Math.max(o,c)/e.maxDimension):null,l=e.maxFramerate?e.maxFramerate:null,u=e.degradationPreference?e.degradationPreference:"balanced",p=i[n.id];if(p&&p.bitrate===s&&p.scaleResolutionDownBy===d&&p.maxFramerate===l&&p.degradationPreference===u)return void(r[n.id]=p);r[n.id]={bitrate:s,scaleResolutionDownBy:d,maxFramerate:l,degradationPreference:u};let h=t.getParameters();h.encodings||(h.encodings=[{}]),h.encodings.forEach((e=>{s?e.maxBitrate=s:delete e.maxBitrate,d?e.scaleResolutionDownBy=d:delete e.scaleResolutionDownBy,l?e.maxFramerate=l:delete e.maxFramerate})),h.degradationPreference=u,t.setParameters(h)}}}e.composeId=i,e.composeParticipantId=r,e.composeMessageId=function(e){return e.participant?r(e.participant):i(e.participantId,e.participantType||de.USER)},e.decomposeId=function(e){let t=String(e),i=t.match(n);return i?{id:Number(i[2]),type:"g"===i[1]?de.GROUP:de.USER}:(Ge.warn(`Unsupported compositeId [${e}]`),{id:Number(t),type:de.USER})},e.uuid=function(){let e,t,n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=new Array(36),r=0;for(t=0;t<36;t++)8===t||13===t||18===t||23===t?i[t]="-":14===t?i[t]="4":(r<=2&&(r=33554432+16777216*Math.random()|0),e=15&r,r>>=4,i[t]=n[19===t?3&e|8:e]);return i.join("")},e.throttle=function(e,t){let n;return function(){let i=this,r=arguments;n&&window.clearTimeout(n),n=window.setTimeout((()=>{e.apply(i,r)}),t)}},e.sdpFingerprint=function(e){let t="",n=e.split("\n");for(let e of n)if(e.startsWith("a=fingerprint")){let n=e.split(" ");if(2===n.length){t=n[1];break}}if(!t)return o().minusOne;let i=t.split(":"),r=o().zero;for(let e=Math.min(7,i.length-1);e>=0;e--){let t=o()(i[e],16);r=r.shiftLeft(8).or(t)}return((e,t)=>{let n=t.value;if("bigint"==typeof n)return o()(BigInt.asIntN(64,n));let i=o().one.shiftLeft(64),r=t.and(i.subtract(1));return r.greaterOrEquals(i.subtract(r))?r.subtract(i):r})(0,r)},e.delay=function(e){return f(this,null,(function*(){return new Promise((t=>window.setTimeout(t,e)))}))},e.applySettings=function(e,t,n){let i=[];return e.getSenders().forEach((e=>a(t,e,e.track,n,i))),i},e.applyVideoTrackSettings=a,e.includesOneOf=function(e,t){Array.isArray(t)||(t=[t]);for(let n of t)if(e.includes(n))return!0;return!1},e.mapParticipantState=function(e){var t;return Object.entries((null==(t=e.participantState)?void 0:t.state)||{}).reduce(((t,[n,i])=>(e.participantState&&(t[n]={ts:e.participantState.stateUpdateTs[n],state:i}),t)),{})},e.mapLegacyParticipantState=function(e){return Object.entries(e).reduce(((e,[t,{state:n}])=>(e[t]=n,e)),{})},e.mapSharedParticipants=function(e){return e.map((e=>{let t={uid:e.externalId,mediaSettings:e.mediaSettings,status:e.status};return be.participantStateMapped&&(t.participantState=e.participantState),t}))},e.isEqualParticipantState=function(e,t){let n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(let r of n)if(!i.hasOwnProperty(r)||e[r].state!==t[r].state||e[r].ts!==t[r].ts)return!1;return!0}}(It||(It={}));var At,wt,Ot,bt=It;!function(e){e.USER="USER",e.ANONYM="ANONYM",e.GROUP="GROUP"}(At||(At={})),function(e){function t(e,t=At.USER){return{id:e,type:t}}function n(e){return`{"id":"${e.id}","type":"${e.type}"}`}e.fromIds=function(e){return e.length?"object"==typeof e[0]?e:e.map((e=>t(e))):[]},e.fromId=t,e.fromSignaling=function(e){return{id:e.id,type:"ANONYM"===e.type?At.ANONYM:At.USER}},e.toString=n,e.fromIdToString=function(e,i=At.USER){return n(t(e,i))},e.fromString=function(e){try{return JSON.parse(e)}catch(t){throw new Error(`Failed to parse ExternalId from string '${e}'`)}},e.compare=function(e,t){return e.id===t.id&&e.type===t.type}}(wt||(wt={})),function(e){e.CAMERA="CAMERA",e.SCREEN="SCREEN",e.STREAM="STREAM",e.MOVIE="MOVIE"}(Ot||(Ot={}));function Dt(e){return e.participantId+(e.mediaType?":s"+e.mediaType:"")+(e.streamName?":m"+e.streamName:"")}function Nt(e){let t=e.split(":"),n=t.shift();if(!n)throw new Error("Illegal stream description: "+e);let i={participantId:n,mediaType:null};for(let n of t)switch(n.charAt(0)){case"s":i.mediaType=kt(n.slice(1));break;case"m":i.streamName=n.slice(1);break;default:throw new Error("Unexpected parameter type "+n.charAt(0)+" in stream description "+e)}return i}function kt(e){for(let t of Object.keys(Ot))if(t===e)return Ot[t];return null}function Mt(e,t){return null===e||null===t?null===e&&null===t:!(e.maxDimension!==t.maxDimension||e.maxBitrateK!==t.maxBitrateK||e.maxFramerate!==t.maxFramerate||e.degradationPreference!==t.degradationPreference)}function Lt(e,t){return!(!Mt(e.camera,t.camera)||!Mt(e.screenSharing,t.screenSharing))}function Ut(e,t){return{camera:Object.assign({},e.camera,t.camera),screenSharing:Object.assign({},e.screenSharing,t.screenSharing)}}var xt=class{constructor(e){this._fixNoPacketsApplied=!1,this._fixNoPacketsChecked=!1,this._fixTooManyPacketsApplied=!1,this._fixTooManyPacketsSucceeded=!1,this._fixTooManyPacketsFailed=!1,this._mediaSource=e}_fixAudioDeviceNoPackets(e){if(!this._fixNoPacketsApplied||!this._fixNoPacketsChecked){if(this._fixNoPacketsApplied&&!this._fixNoPacketsChecked)return this._fixNoPacketsChecked=!0,void Rt.log(ee.ERROR,"audio_device_recover_"+(e.bandwidth?"success":"fail"));!this._fixNoPacketsApplied&&!e.bandwidth&&(this._fixNoPacketsApplied=!0,Rt.log(ee.ERROR,"audio_device_recover"),this._mediaSource.toggleAudio(!0))}}_fixAudioDeviceTooManyPackets(e){if(this._fixTooManyPacketsSucceeded||this._fixTooManyPacketsFailed)return;let t=Date.now();if(this._lastPacketsSentTime){if(t-this._lastPacketsSentTime>500){let n=1e3*(e.packetsSent-this._lastPacketsSent)/(t-this._lastPacketsSentTime);this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent,this._fixTooManyPacketsApplied?n>75?(Ge.log("Failed to fix RV"),Rt.log(ee.ERROR,"audio_device_recover_rv_fail"),this._fixTooManyPacketsFailed=!0):t-this._fixTooManyPacketsTime>6e4&&(Ge.log("Fixed RV"),Rt.log(ee.ERROR,"audio_device_recover_rv_success"),this._fixTooManyPacketsSucceeded=!0):n>75&&(this._fixTooManyPacketsApplied=!0,Ge.log("Trying to fix RV"),this._mediaSource.toggleAudio(!0),this._fixTooManyPacketsTime=t)}}else e.packetsSent>0&&(this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent)}fix(e){if(!this._mediaSource)return;let t=e.find((e=>e.kind===yt.audio));!t||(this._fixAudioDeviceNoPackets(t),this._fixAudioDeviceTooManyPackets(t))}},Gt=class extends S{constructor(){super(...arguments),this._lastMemoryStat={percent:0,bytes:0}}onRemoteDataStats(e,t){this._calcMemory(),e.inbound.rtps.map((e=>{let n="string"==typeof e.userId&&t[e.userId]||null;e.userId=null==n?void 0:n.externalId})),Ue.onStatistics(e,this._lastMemoryStat)}_calcMemory(){var e;let t=null==(e=null==window?void 0:window.performance)?void 0:e.memory;if(!t||!t.usedJSHeapSize||!t.jsHeapSizeLimit)return;let n=Number((100*t.usedJSHeapSize/t.jsHeapSizeLimit).toFixed(2)),i=Number((t.usedJSHeapSize/1024/1024).toFixed(1));n>90?Ge.warn(`High memory usage: ${n}% (${i} MiB)`):(!this._lastMemoryStat.percent||Math.abs(n-this._lastMemoryStat.percent)>=3)&&(Ge.debug(`Memory usage: ${n}% (${i} MiB)`),this._lastMemoryStat.percent=n,this._lastMemoryStat.bytes=t.usedJSHeapSize)}},Vt=class{constructor(e,t){this._analyser=null,this._gainNode=null,this._fftBins=null,this._mediaStreamSource=null,this._lastSmoothedLevel=0,this._trackId=e,this._stream=t;try{let e=vt.getAudioContext();this._gainNode=e.createGain(),this._gainNode.gain.value=1e-5,this._gainNode.connect(e.destination),this._analyser=e.createAnalyser(),this._analyser.fftSize=1024,this._analyser.smoothingTimeConstant=0,this._analyser.connect(this._gainNode),this._fftBins=new Uint8Array(this._analyser.frequencyBinCount),this._mediaStreamSource=e.createMediaStreamSource(t),this._mediaStreamSource.connect(this._analyser)}catch(e){}}get stream(){return this._stream}get trackId(){return this._trackId}_getBins(){if(!this._fftBins||!this._analyser)return new Uint8Array;this._analyser.getByteFrequencyData(this._fftBins);let e=44100/this._fftBins.length,t=Math.ceil(be.voiceParams.minFreq/e),n=Math.floor(be.voiceParams.maxFreq/e);return this._fftBins.subarray(t,n)}getLevel(){let e=this._getBins(),t=e.reduce(((e,t)=>e+t),0)/e.length/255,n=this._lastSmoothedLevel*be.voiceParams.smoothing+t*(1-be.voiceParams.smoothing);return this._lastSmoothedLevel=n,{real:t,smoothed:n}}destroy(){this._mediaStreamSource&&(this._mediaStreamSource.disconnect(),this._mediaStreamSource=null),this._gainNode&&(this._gainNode.disconnect(),this._gainNode=null),this._analyser&&(this._analyser.disconnect(),this._analyser=null,this._fftBins=null,this._lastSmoothedLevel=0)}},Ft=class extends S{constructor(e){super(),this._detector=null,this._track=null,this._interval=null;let t=()=>{this._detector&&Ue.onLocalVolume(this._detector.getLevel().real,e.getMediaSettings().isAudioEnabled),this._interval=window.setTimeout(t,be.voiceParams.interval)};this._interval=window.setTimeout(t,be.voiceParams.interval);let n=()=>{let t=e.getStream();t&&this.init(t)};this.subscribe(e,Tt.SOURCE_CHANGED,(e=>{e.kind===yt.audio&&e.mediaSettings.isAudioEnabled&&n()})),n()}init(e){this._stopDetector();let t=e.getAudioTracks();t.length&&(this._track=t[0].clone(),this._detector=new Vt("local",new MediaStream([this._track])))}_stopDetector(){this._detector&&(this._detector.destroy(),this._detector=null),this._track&&(this._track.stop(),this._track=null)}destroy(){this.unsubscribe(),this._interval&&(window.clearTimeout(this._interval),this._interval=null),this._stopDetector()}};function Ht(e,t,n=0){return t in e&&e[t]?e[t]:n}function jt(...e){return t=>{for(let n of e)if(n(t))return!0;return!1}}function Bt(e,t){return n=>n[e]===t}function Wt(e,t){return t.reduce(((t,n)=>(t[n[e]]=n,t)),{})}function $t(e){let t={},n=[];for(let i of e)t[i.id]||(t[i.id]=!0,n.push(i));return n}function Kt(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>[t,e[t]])).reduce(((e,t)=>(e[t[0]]=function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}(t[1])?Kt(t[1]):t[1],e)),{})}function qt(e){let t=[];for(let n of e)n.forEach((e=>t.push(e)));return t}function Jt(e){return f(this,null,(function*(){let t=[];return RTCRtpReceiver.prototype.getStats?(t.push(...e.getReceivers().map((e=>e.getStats()))),t.push(...e.getSenders().map((e=>e.getStats())))):t.push(e.getStats()),Promise.all(t).then(qt).then($t)}))}function Yt(e){let t=e.filter(Bt("type","candidate-pair")).sort(function(e){return(t,n)=>t[e]-n[e]}("priority")).find(jt(Bt("nominated",!0),Bt("selected",!0)));if(!t)return{totalRoundTripTime:0,currentRoundTripTime:0,bytesSent:0,bytesReceived:0};let n={totalRoundTripTime:t.totalRoundTripTime||0,currentRoundTripTime:t.currentRoundTripTime||0,bytesSent:t.bytesSent,bytesReceived:t.bytesReceived},i=e.find(Bt("id",t.remoteCandidateId));i&&(n=Object.assign({},n,{remote:{type:i.candidateType,address:i.ip||i.address,port:i.port,protocol:i.protocol}}));let r=e.find(Bt("id",t.localCandidateId));return r&&(n=Object.assign({},n,{local:{type:r.candidateType,address:r.ip||r.address,port:r.port,protocol:r.protocol,relayProtocol:r.relayProtocol,networkType:r.networkType}})),Kt(n)}function zt(e,t){let n=Wt("id",e),i=e.filter(jt(Bt("type","inbound-rtp"),Bt("type","outbound-rtp")));"Firefox"===vt.browserName()&&(i=Object.values(i.reduce(((e,t)=>{if(e[t.ssrc]){let n=Object.assign({},e[t.ssrc],t),i=e[t.ssrc].isRemote?t:e[t.ssrc];n.id=i.id,n.type=i.type,delete n.isRemote,delete n.remoteId,e[n.ssrc]=n}else e[t.ssrc]=t;return e}),{})));let r={};if("Safari"===vt.browserName()){let t=e.filter(Bt("type","track"));r=Wt("trackIdentifier",t)}return i.map((e=>{let i=Number(e.ssrc),a=e.mediaType||e.kind,s=e.trackId,o=e.type,c=e.codecId;if("Safari"===vt.browserName()){let n=/^.+_([\d]+)$/.exec(e.id);if(n&&(i=parseInt(n[1],10)),a=e.id.indexOf("Audio")>0?"audio":"video",t[i]){let e=a+"-"+t[i];r[e]&&(s=r[e].id)}}if(!o||!i||!a)return null;let d={ssrc:i,type:o,kind:a,bytesReceived:Ht(e,"bytesReceived"),bytesSent:Ht(e,"bytesSent"),jitter:Ht(e,"jitter"),packetsLost:Ht(e,"packetsLost"),packetsReceived:Ht(e,"packetsReceived"),packetsSent:Ht(e,"packetsSent"),fractionLost:Ht(e,"fractionLost"),pliCount:Ht(e,"pliCount"),firCount:Ht(e,"firCount"),nackCount:Ht(e,"nackCount"),userId:t[i]};if(c&&n[c]){let e=n[c];d.clockRate=e.clockRate,d.mimeType=e.mimeType}if(s&&n[s]){let e=n[s];d.frameHeight=e.frameHeight,d.frameWidth=e.frameWidth,d.framesDecoded=e.framesDecoded,d.framesReceived=e.framesReceived,d.framesDropped=e.framesDropped}return Kt(d)})).filter((e=>!!e))}function Xt(e,t){if(!t||!t.rtps||!e.rtps)return e;let n=Wt("ssrc",e.rtps),i=Wt("ssrc",t.rtps),r=(e.timestamp-t.timestamp)/1e3;return!n||!i||Object.keys(n).forEach((e=>{let t=n[e],a=i[e];if(t&&a){if(t.bytesReceived&&t.bytesReceived>a.bytesReceived&&(t.bandwidth=Math.round((t.bytesReceived-a.bytesReceived)/r)),t.bytesSent&&t.bytesSent>a.bytesSent&&(t.bandwidth=Math.round((t.bytesSent-a.bytesSent)/r)),t.packetsReceived)if(t.packetsReceived>a.packetsReceived||t.packetsLost>a.packetsLost){let e=t.packetsLost-a.packetsLost,n=t.packetsReceived-a.packetsReceived;t.packetLoss=parseFloat((100*e/(e+n)).toFixed(2))}else t.packetLoss=0;t.framesDropped&&a.framesDropped&&t.framesDropped>a.framesDropped&&(t.framesDroppedDelta=parseFloat(((t.framesDropped-a.framesDropped)/r).toFixed(0)))}})),e}function Qt(e,t){return f(this,arguments,(function*(e,t,n={}){let i=yield Jt(e),r={timestamp:Date.now(),transport:Yt(i),rtps:zt(i,n)};return t?Xt(r,t):(yield bt.delay(1e3),Qt(e,r,n))}))}var Zt,en=.8,tn=class extends S{constructor(e,t,n,i,r){if(super(),this._remoteSDP={},this._remoteCandidates={},this._state=gn.IDLE,this._isOpen=!1,this._remotePeerId=null,this._statInterval=null,this._settingsInterval=null,this._failedOnCreate=null,this._remoteStream=null,this._iceRestartTimeout=null,this._reconnectionTimeout=null,this._reconnectionPrevented=!1,this._fingerprint=null,this._neverConnected=!0,this._prevConsumerSettings={},this._lastNetworkStat={rtt:0,loss:0,date:0},this._remoteNetworkStat={rtt:0,loss:0},this._networkLimits={badNet:{loss:3,rtt:1e3},goodNet:{loss:.5,rtt:600}},this._signaling=n,this._mediaSource=i,this._participantId=e,this._isMaster=t,this._serverSettings=r,this.subscribe(this._signaling,Y.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,Tt.TRACK_REPLACED,this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,Tt.SOURCE_CHANGED,this._applySettings.bind(this)),this._pc=new RTCPeerConnection({iceServers:be.iceServers,iceTransportPolicy:be.forceRelayPolicy?"relay":"all"},{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.onicecandidate=this._handleIceCandidate.bind(this),this._pc.ontrack=this._onAddTrack.bind(this),this._pc.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this),this._pc.onconnectionstatechange=this._onConnectionStateChange.bind(this),this._pc.onsignalingstatechange=this._onSignalingStateChange.bind(this),this._prevConsumerSettings={},this._isMaster){try{this._mediaSource.addTrackToPeerConnection(this._pc,!0),this._applySettings()}catch(e){return Rt.log(ee.ERROR,"addTrack-direct"),Ge.error("Unable to add media source tracks",e,{participantId:this._participantId}),void(this._failedOnCreate=e)}this._createOffer(!1).catch((e=>{this._state===gn.IDLE?this._failedOnCreate=e:this.close(e)}))}this._startSettingsInterval(),this._startStatInterval()}getState(){return this._state}updateStatisticsInterval(){this._stopStatInterval();let e=this.getState();e!==gn.IDLE&&e!==gn.CLOSED&&e!==gn.FAILED&&this._startStatInterval()}open(e=null){return f(this,null,(function*(){if(this._isOpen)return void Ge.warn("DirectTransport: Already opened",{participantId:this._participantId});if(this._failedOnCreate)return void this.close(this._failedOnCreate);if(Ge.debug("DirectTransport: Open transport",{participantId:this._participantId}),this._isOpen=!0,this._remotePeerId=e,!this._isMaster)try{this._mediaSource.addTrackToPeerConnection(this._pc,!0),this._applySettings()}catch(e){return Rt.log(ee.ERROR,"addTrack-direct"),Ge.error("DirectTransport: Unable to add media source tracks",e,{participantId:this._participantId}),void this.close(e)}this._setState(gn.OPENED);let t=e;if(!e){let e=Object.keys(this._remoteSDP);t=e[e.length-1]}if(t&&this._remoteSDP[t])try{yield this._setRemoteDescription(t,this._remoteSDP[t])}catch(e){return void this.close()}this._remoteSDP={},this._remoteCandidates={},this._triggerEvent(fn.ACTIVE_PARTICIPANTS_NO_SIGNAL)}))}updateSettings(e){Lt(e,this._serverSettings)||(this._serverSettings=e,this._applySettings())}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}close(e){this._isOpen=!1,this._stopReconnection(),this._remoteStream&&(this._remoteStream.getTracks().forEach((e=>{e.stop(),this._triggerEvent(fn.REMOTE_TRACK_REMOVED,this._remoteStream,e)})),this._remoteStream=null),this._stopStatInterval(),this._stopSettingsInterval(),this._pc&&(this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.oniceconnectionstatechange=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._pc.close()),this.unsubscribe(),e?(Ge.error("DirectTransport: Closed",e,{participantId:this._participantId}),this._setState(gn.FAILED)):(Ge.debug("DirectTransport: Closed",{participantId:this._participantId}),this._setState(gn.CLOSED)),this._triggerEvent(fn.PEER_CONNECTION_CLOSED)}_setState(e){this._state!==e&&(Ge.debug(`DirectTransport: State changed to ${e}`,{participantId:this._participantId}),this._state=e,this._triggerEvent(fn.STATE_CHANGED,e))}_onSignalingNotification(e){var t,n,i,r;switch(e.notification){case Q.TRANSMITTED_DATA:this._handleTransmittedData(e);break;case Q.SETTINGS_UPDATE:Object.assign(this._networkLimits.badNet,(null==(t=e.settings)?void 0:t.badNet)||{}),Object.assign(this._networkLimits.goodNet,(null==(n=e.settings)?void 0:n.goodNet)||{});break;case Q.CUSTOM_DATA:e.data.hasOwnProperty("sdk")&&(this._remoteNetworkStat.rtt=(null==(i=e.data.sdk)?void 0:i.rtt)||0,this._remoteNetworkStat.loss=(null==(r=e.data.sdk)?void 0:r.loss)||0)}}_handleTransmittedData(e){let t=e.data,n=bt.getPeerIdString(e.peerId);bt.composeMessageId(e)===this._participantId&&(t.candidate&&t.candidate.candidate?this._addIceCandidate(n,t.candidate).catch(this.close.bind(this)):t.sdp&&this._setRemoteDescription(n,t.sdp).catch(this.close.bind(this)))}_addIceCandidate(e,t){return f(this,null,(function*(){if(this._isOpen&&(!this._remotePeerId||this._remotePeerId===e)&&this._pc&&this._pc.remoteDescription){Ge.debug("Add remote ice candidate",{participantId:this._participantId,candidate:t});try{yield this._pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){throw Rt.log(ee.ERROR,"addIceCandidate-direct"),Ge.error("Unable to add remote ice candidate",e,{participantId:this._participantId,candidate:t}),e}}else Ge.debug("Cache remote ice candidate",{participantId:this._participantId,candidate:t}),this._remoteCandidates[e]=this._remoteCandidates[e]||[],this._remoteCandidates[e].push(t)}))}_setRemoteCandidates(e){return f(this,null,(function*(){if(!this._remoteCandidates[e])return void Ge.log(`No cached candidates found for peer ${e}`);let t=this._remoteCandidates[e];this._remoteCandidates[e]=[];for(let n of t)try{yield this._addIceCandidate(e,n)}catch(e){}}))}_setRemoteDescription(e,t){return f(this,null,(function*(){if(!this._isOpen||this._remotePeerId&&this._remotePeerId!==e||!this._pc)this._remoteSDP[e]=t;else{Ge.debug("Add remote description",{participantId:this._participantId,sdp:t}),this._calcFingerprint(t.sdp);try{yield this._pc.setRemoteDescription(new RTCSessionDescription(t)),yield this._setRemoteCandidates(e)}catch(e){throw Rt.log(ee.ERROR,"setRemoteDescription-direct"),Ge.error("Unable to set remote description",e,{participantId:this._participantId,sdp:t}),e}}}))}_onAddTrack(e){Ge.debug("Added remote track",{participantId:this._participantId,kind:e.track.kind}),this._remoteStream?this._remoteStream.addTrack(e.track):(this._remoteStream=new MediaStream([e.track]),this._remoteStream.onremovetrack=e=>{this._triggerEvent(fn.REMOTE_TRACK_REMOVED,this._remoteStream,e.track)}),this._triggerEvent(fn.REMOTE_TRACK_ADDED,this._remoteStream,e.track)}_handleIceCandidate(e){return f(this,null,(function*(){e.candidate&&this._signaling.ready&&(Ge.debug("Local ice candidate",{participantId:this._participantId,candidate:e.candidate}),yield this._signaling.sendCandidate(this._participantId,e.candidate))}))}_onSignalingStateChange(){switch(Ge.debug(`DirectTransport: Signaling state changed to ${this._pc.signalingState}`,{participantId:this._participantId}),this._pc.signalingState){case"have-local-offer":let e=this._pc.localDescription;e?this._signaling.sendSdp(this._participantId,e).catch(this.close.bind(this)):this.close(new Error);break;case"have-remote-offer":this._createAnswer().catch(this.close.bind(this)).then((e=>f(this,null,(function*(){return this._signaling.sendSdp(this._participantId,e)})))).catch(this.close.bind(this))}}_onIceConnectionStateChange(){switch(Ge.debug(`DirectTransport: Ice Connection state changed to ${this._pc.iceConnectionState}`,{participantId:this._participantId}),this._pc.iceConnectionState){case"checking":let e=this.getState();e===gn.IDLE||e===gn.OPENED?this._setState(gn.CONNECTING):this._setState(gn.RECONNECTING)}}_onConnectionStateChange(){switch(Ge.debug(`DirectTransport: Connection state changed to ${this._pc.connectionState}`,{participantId:this._participantId}),Rt.log(ee.ICE_CONNECTION_STATE,this._pc.connectionState),this._pc.connectionState){case"connected":this._neverConnected=!1,this._setState(gn.CONNECTED),this._stopReconnection(),bt.getPeerConnectionHostInfo(this._pc).then((e=>{e&&Rt.log(ee.ICE_CONNECTION_TYPE,e.type)}));break;case"failed":case"disconnected":this._reconnectionPrevented?this.close(new Error(`Ice connection ${this._pc.connectionState}`)):(this._setState(gn.RECONNECTING),this._startReconnection());break;case"closed":this.close(new Error("Ice connection closed"))}}_startReconnection(){this._reconnectionTimeout||this._iceRestartTimeout||(Ge.log("Waiting for reconnection...",{participantId:this._participantId}),this._reconnectionTimeout=window.setTimeout((()=>{this._reconnectionTimeout=null,this._neverConnected?this._requestTopologySwitch():this._startIceRestart()}),be.transportConnectionWaitTime))}_requestTopologySwitch(){this._isMaster&&this._signaling.ready&&(Ge.log("Switch topology DIRECT to SERVER",{participantId:this._participantId}),this._signaling.switchTopology(Sn.SERVER))}_stopReconnection(){this._reconnectionTimeout&&(clearTimeout(this._reconnectionTimeout),this._reconnectionTimeout=null),this._iceRestartTimeout&&(clearTimeout(this._iceRestartTimeout),this._iceRestartTimeout=null)}_startIceRestart(){this._isMaster?(Rt.log(ee.ICE_RESTART),Ge.log("Ice restart",{participantId:this._participantId}),this._createOffer(!0).catch(this.close.bind(this))):Ge.debug("Waiting for ice restart...",{participantId:this._participantId}),this._iceRestartTimeout=window.setTimeout((()=>{this._iceRestartTimeout=null,Ge.error("Ice restart failed",{participantId:this._participantId}),Rt.log(ee.ERROR,"iceRestart-direct"),this._requestTopologySwitch()}),be.iceRestartWaitTime)}_createOffer(e){return f(this,null,(function*(){let t={iceRestart:e,offerToReceiveAudio:!0,offerToReceiveVideo:!0};return Ge.debug("Create offer",{participantId:this._participantId,options:t}),this._pc.createOffer(t).catch((e=>{throw Ge.error("Unable to create offer",e,{participantId:this._participantId}),Rt.log(ee.ERROR,"createOffer-direct"),e})).then((e=>f(this,null,(function*(){return Ge.debug("Created offer",{participantId:this._participantId,offer:e}),e=tn._patchDescription(e),Ge.debug("Set local description",{participantId:this._participantId,offer:e}),this._calcFingerprint(e.sdp),this._pc.setLocalDescription(e).then((()=>this._pc.localDescription))})))).catch((e=>{throw Ge.error("Unable to set local description",e,{participantId:this._participantId}),Rt.log(ee.ERROR,"setLocalDescription-direct"),e}))}))}_createAnswer(){return f(this,null,(function*(){return Ge.debug("Create answer",{participantId:this._participantId}),this._pc.createAnswer().catch((e=>{throw Ge.error("Unable to create answer",e,{participantId:this._participantId}),Rt.log(ee.ERROR,"createAnswer-direct"),e})).then((e=>f(this,null,(function*(){return Ge.debug("Created answer",{participantId:this._participantId,answer:e}),e=tn._patchDescription(e),Ge.debug("Set local description",{participantId:this._participantId,answer:e}),this._calcFingerprint(e.sdp),this._pc.setLocalDescription(e)})))).then((()=>this._pc.localDescription)).catch((e=>{throw Ge.error("Unable to set local description",e,{participantId:this._participantId}),Rt.log(ee.ERROR,"setLocalDescription-direct"),e}))}))}static _patchDescription(e){let t=!!vt.baseChromeVersion();return e.sdp=bt.patchSDP(e.sdp,be.preferH264&&vt.canPreferH264(),vt.isBrokenH264(),be.preferVP9,t&&be.audioNack),e}_onReplacedTrack(e){this._pc&&(this._pc.getSenders().forEach((t=>{t.track&&t.track.kind===e.kind&&(t.track.enabled=e.enabled,t.replaceTrack(e).catch((e=>{Ge.error("DirectTransport: Unable to replace track",e,{participantId:this._participantId}),Rt.log(ee.ERROR,"replaceTrack-direct")})))})),this._applySettings())}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._pc?Qt(this._pc,this._lastStat).then((t=>{this._lastStat=t;let n={inbound:{topology:Sn.DIRECT,transport:t.transport,rtps:t.rtps.filter((e=>"inbound-rtp"===e.type&&(e.userId=this._participantId,!0)))},outbound:{topology:Sn.DIRECT,transport:t.transport,rtps:t.rtps.filter((e=>"outbound-rtp"===e.type))}};this._checkBadNetwork(n),this._triggerEvent(fn.REMOTE_DATA_STATS,n),this._statInterval=window.setTimeout(e,be.statisticsInterval)})):this._stopStatInterval()};this._statInterval=window.setTimeout(e,be.statisticsInterval)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null)}_checkBadNetwork(e){if(!this._signaling.ready)return;let t=e=>e.rtt<=this._networkLimits.goodNet.rtt&&e.loss<=this._networkLimits.goodNet.loss,n=e=>e.rtt>=this._networkLimits.badNet.rtt||e.loss>=this._networkLimits.badNet.loss,i=Math.round(1e3*e.outbound.transport.currentRoundTripTime)||0,r=e.inbound.rtps.reduce(((e,t)=>Math.max(e,t.packetLoss||0)),0),a={rtt:this._lastNetworkStat.rtt*(1-en)+i*en,loss:this._lastNetworkStat.loss*(1-en)+r*en},s=n(a),o=t(a),c=n(this._remoteNetworkStat),d=t(this._remoteNetworkStat),l=n(this._lastNetworkStat),u=t(this._lastNetworkStat),p=s||c?.2:o&&d?1:0,h=Date.now();if((l!==s||u!==o||h-this._lastNetworkStat.date>be.networkStatisticsInterval)&&(this._lastNetworkStat.date=Date.now(),this._signaling.customData({sdk:Object.assign({type:"bad-net"},a)},null).catch((e=>{Ge.warn("Unable to send [bad-net]",e)}))),p){let e={};e[this._participantId]=e[""]=p,this._triggerEvent(fn.NETWORK_STATUS,e)}this._lastNetworkStat.rtt=a.rtt,this._lastNetworkStat.loss=a.loss}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applySettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_calcFingerprint(e){let t=bt.sdpFingerprint(e);null===this._fingerprint?this._fingerprint=t:(Ue.onFingerprintChange(this._fingerprint.xor(t).toString()),this._fingerprint=null)}_applySettings(){var e;let t=this._mediaSource.getMediaSettings().isScreenSharingEnabled?this._serverSettings.screenSharing:this._serverSettings.camera;t&&"connected"===(null==(e=this._pc)?void 0:e.connectionState)&&(this._prevConsumerSettings=bt.applySettings(this._pc,t,this._prevConsumerSettings))}};!function(e){e.producerNotification="producerNotification",e.producerCommand="producerCommand",e.consumerScreenShare="consumerScreenShare",e.producerScreenShare="producerScreenShare"}(Zt||(Zt={}));var nn,rn,an,sn=Zt;function on(e,t,n){let i=null,r=null,a=!0;t({locateFile:n}).then((e=>r=e)).then((()=>{self.onmessage=t=>{switch(t.data.type){case e.FRAME:!function(t,n,s,o,c){if(!r)return self.postMessage({type:e.LOG_ERROR,message:"decoder-init-fail-libvpx"}),void self.postMessage({type:e.FRAME,error:"Fatal initialization error"});if(a!==s&&(a=s,i&&(i=null,self.postMessage({type:e.DEBUG,message:`LibVPxDecoder codec changed to ${s?"VP9":"VP8"} - reinitialize`}))),!i&&(self.postMessage({type:e.DEBUG,message:"LibVPxDecoder codec "+(s?"VP9":"VP8")}),i=new r.VpxDecoder,i.debug(c),!i.init(s?r.VpxType.VP9:r.VpxType.VP8)))return i=null,void self.postMessage({type:e.FRAME,error:"Decoder failed to create"});try{i.allocateBuffer(n.byteLength).set(new Uint8Array(n))}catch(t){return self.postMessage({type:e.DEBUG,message:t}),i=null,void self.postMessage({type:e.FRAME,error:String(t)})}if(!i.decode()||!i.nextImage())return void self.postMessage({type:e.FRAME,error:"Decode failed"});let d=i.getImageBuffer();if(!d)return void self.postMessage({type:e.FRAME,error:"No decoded data"});let l=i.getImageWidth(),u=i.getImageHeight();i.nextImage()&&(self.postMessage({type:e.DEBUG,message:"LibVPxDecoder dropped frame"}),self.postMessage({type:e.LOG_ERROR,message:"LibVPxDecoder-drop"}));let p=new Uint8ClampedArray(d.byteLength);if(p.set(d),o){let t=new ImageData(p,l,u);createImageBitmap(t,0,0,l,u).then((t=>{self.postMessage({type:e.FRAME,data:t},[t]),t.close()}))}else self.postMessage({type:e.FRAME,data:p.buffer,width:l,height:u},[p.buffer])}(t.data.timestamp,t.data.data,t.data.isVP9,t.data.useImageBitmap,t.data.debug)}},self.postMessage({type:e.READY})})).catch((t=>{self.postMessage({type:e.ERROR,error:String(t)})}))}!function(e){e.VP9="vp09.00.50.08",e.VP8="vp8"}(nn||(nn={})),(an=rn||(rn={})).INIT="init",an.READY="ready",an.FRAME="frame",an.ERROR="error",an.DEBUG="debug",an.LOG_ERROR="log_error";var cn=class{constructor(){this._worker=null}_createWorker(e,t){return f(this,arguments,(function*(e,t,n=[],i={},r=[]){return new Promise(((a,s)=>{let o=n.join(","),c=new Blob([`(${e})(${o});`],{type:"application/javascript; charset=utf-8"}),d=window.URL.createObjectURL(c);this._worker=new Worker(d),this._worker.onmessage=e=>{switch(e.data.type){case rn.READY:a();break;case rn.ERROR:s(e.data.error);break;case rn.FRAME:t(e.data);break;case rn.DEBUG:Ge.debug(e.data.message);break;case rn.LOG_ERROR:Rt.log(ee.ERROR,e.data.message)}},this._sendToWorker(rn.INIT,i,r)}))}))}_removeWorker(){var e;null==(e=this._worker)||e.terminate(),this._worker=null}_sendToWorker(e,t={},n=[]){var i;null==(i=this._worker)||i.postMessage(Object.assign({type:e},t),n)}static isBrowserSupported(){throw new Error("Not implemented")}},dn=class extends cn{init(e){return f(this,null,(function*(){Ge.debug("LibVPxDecoder started"),yield this._createWorker(on,(t=>{if(t.error)Ge.warn("LibVPxDecoder",t.error);else if(t.data instanceof ArrayBuffer){let n=new ImageData(new Uint8ClampedArray(t.data),t.width,t.height);e(n)}else e(t.data)}),[JSON.stringify(rn),l(),l().getUrl])}))}decodeFrame(e,t,n,i){let r="ImageBitmap"in window;this._sendToWorker(rn.FRAME,{timestamp:e,data:t.buffer,isVP9:n,keyFrame:i,useImageBitmap:r,debug:Ge.enabled()},[t.buffer])}destroy(){this._removeWorker(),Ge.debug("LibVPxDecoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window}};function ln(e,t){let n=null,i=!0;self.onmessage=r=>{switch(r.data.type){case e.INIT:self.postMessage({type:e.READY});break;case e.FRAME:!function(r,a,s,o=!1){(!n||i!==s)&&(i=s,n?self.postMessage({type:e.DEBUG,message:"WebCodecsDecoder codec changed to "+(s?"VP9":"VP8")}):(self.postMessage({type:e.DEBUG,message:"WebCodecsDecoder codec "+(s?"VP9":"VP8")}),n=new VideoDecoder({output:t=>{("createImageBitmap"in t?t.createImageBitmap():createImageBitmap(t)).then((t=>{self.postMessage({type:e.FRAME,data:t}),t.close()})).finally((()=>t.close()))},error:t=>{n&&"closed"!==n.state&&n.close(),n=null,self.postMessage({type:e.FRAME,error:"WebCodecsDecoder failed, reinitialize"})}})),n.configure({codec:s?t.VP9:t.VP8}));let c=new EncodedVideoChunk({type:o?"key":"delta",timestamp:r,data:a});n.decode(c)}(r.data.timestamp,r.data.data,r.data.isVP9,r.data.keyFrame)}}}var un=class extends cn{init(e){return f(this,null,(function*(){Ge.debug("WebCodecsDecoder started"),yield this._createWorker(ln,(t=>{t.error?Ge.warn("WebCodecsDecoder",t.error):e(t.data)}),[JSON.stringify(rn),JSON.stringify(nn)])}))}decodeFrame(e,t,n,i=!1){this._sendToWorker(rn.FRAME,{timestamp:e,data:t.buffer,isVP9:n,keyFrame:i},[t.buffer])}destroy(){this._removeWorker(),Ge.debug("WebCodecsDecoder destroyed")}static isBrowserSupported(){return"VideoDecoder"in window&&"Worker"in window&&"VideoFrame"in window&&"ImageBitmap"in window&&"createImageBitmap"in window}};var pn=class{constructor(e,t,n,i){this._participantIdRegistry=null,this._streamBuilders={},this._onStream=()=>{},this._onEos=()=>{},Ge.debug("ScreenCaptureReceiver started"),this._datachannel=e,this._participantIdRegistry=t,this._onStream=n,this._onEos=i,this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)}_onDataChannelMessage(e){var t,n;let i=function(e){let t=new DataView(e),n=t.getUint8(0),i=t.getUint16(1),r=t.getUint32(3),a=1===t.getUint8(7),s=t.getUint16(8),o=t.getUint8(10),c=!!(1&o),d=!!(2&o),l=!!(4&o),u=!!(8&o);if(1!==n)throw new Error(`Unexpected protocol version. Got ${n}, expected 1`);return{timestamp:r,start:c,end:d,keyframe:l,sequence:i,isVP9:a,ssrc:s,eos:u,data:e.slice(11)}}(e),r=null==(n=null==(t=this._participantIdRegistry)?void 0:t.getStreamDescription(i.ssrc))?void 0:n.participantId;if(!r)return void Ge.warn(`Participant id for ssrc ${i.ssrc} not found in registry`);if(i.eos)return this.close(r),void this._onEos(r);let a=this._streamBuilders[r];a||(a=new class{constructor(e,t){this._decoderReady=!1,this._decoderQueue=[],this._chunks=[],this._onStream=()=>{},this._canvas=null,this._canvasContext=null,this._stream=null,this._track=null,Ge.debug(`StreamBuilder started for participant [${e}]`),this._participantId=e,this._onStream=t,this._useImageBitmap="ImageBitmap"in window,un.isBrowserSupported()?this._decoder=new un:this._decoder=new dn,this._decoder.init((e=>this._drawImage(e))).then((()=>{this._decoderReady=!0,this._decodeQueue()}))}_createStream(e,t){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=e,this._canvas.height=t,this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="0",this._canvas.style.zIndex="5000",document.body.appendChild(this._canvas),this._useImageBitmap?this._canvasContext=this._canvas.getContext("bitmaprenderer"):this._canvasContext=this._canvas.getContext("2d"),this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],this._track.contentHint="text")}_removeStream(){this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._canvasContext=null;try{this._canvas&&document.body.removeChild(this._canvas)}catch(e){}this._canvas=null}_processFrameData(){let e=new Uint8Array;for(let t of this._chunks){let n=new Uint8Array(e.byteLength+t.data.byteLength);n.set(new Uint8Array(e),0),n.set(new Uint8Array(t.data),e.byteLength),e=n}return this._chunks=[],e}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}_drawImage(e){this._track||(this._createStream(e.width,e.height),this._onStream(this._stream));let t=this._canvas;if(t.width=e.width,t.height=e.height,e instanceof ImageData){let n=this._canvasContext;n.clearRect(0,0,t.width,t.height),n.putImageData(e,0,0)}else this._canvasContext.transferFromImageBitmap(e);this._requestCanvasFrame()}_decodeFrame(e){!this._decoderReady||this._decoderQueue.length?(this._decoderQueue.push(e),this._decodeQueue()):this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe)}_decodeQueue(){if(!this._decoderReady)return;let e=this._decoderQueue;this._decoderQueue=[],e.forEach((e=>{this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe)}))}appendChunk(e){let t=this._chunks.length;if(e.start)t&&(Ge.warn("[FrameBuilder] Cleanup buffer",Array.prototype.slice.call(this._chunks)),this._chunks=[]);else if(!t||(this._chunks[t-1].sequence+1)%65536!==e.sequence)return void Ge.warn("[FrameBuilder] Got incorrect chunk");if(this._chunks.push(e),e.end){let t=this._processFrameData();this._decodeFrame({timestamp:e.timestamp,frameData:t,isVP9:e.isVP9,keyframe:e.keyframe})}}destroy(){this._decoder.destroy(),this._removeStream(),this._chunks=[],Ge.debug(`StreamBuilder destroyed for participant ${this._participantId}`)}}(r,(e=>this._onStream(r,e))),this._streamBuilders[r]=a),a.appendChunk(i)}close(e){let t=this._streamBuilders[e];t&&(t.destroy(),delete this._streamBuilders[e])}destroy(){this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null,this._onStream=()=>{},Object.values(this._streamBuilders).forEach((e=>e.destroy())),this._streamBuilders={},this._participantIdRegistry=null,Ge.debug("ScreenCaptureReceiver destroyed")}static isBrowserSupported(){return(un.isBrowserSupported()||dn.isBrowserSupported())&&("CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window)}};function hn(e,t,n){let i;self.onmessage=r=>{switch(r.data.type){case e.INIT:(function(r,a){return t({locateFile:n}).then((t=>{if(i=new t.VpxEncoder,i.debug(a),!i.init(r?t.VpxType.VP9:t.VpxType.VP8))throw self.postMessage({type:e.LOG_ERROR,message:"encoder-init-fail-libvpx"}),new Error("LibVPxEncoder failed to create");i.setMaxQuantizer(10),i.setTargetBitrate(1024)}))})(r.data.isVP9,r.data.debug).then((()=>self.postMessage({type:e.READY}))).catch((t=>self.postMessage({type:e.ERROR,error:String(t)})));break;case e.FRAME:!function(t,n,r,a){let s=i.allocateImage(t,n);if(!s)return void self.postMessage({type:e.FRAME,error:"No buffer data"});s.set(new Uint8Array(r));let o=Math.round(performance.now());if(!i.encode(o,150,a))return void self.postMessage({type:e.FRAME,error:"Encode failed"});let c=i.readFrame();if(!c)return void self.postMessage({type:e.FRAME,error:"No encoded data"});i.readFrame()&&(self.postMessage({type:e.DEBUG,message:"LibVPxEncoder dropped frame"}),self.postMessage({type:e.LOG_ERROR,message:"LibVPxEncoder-drop"}));let d=new Uint8Array(c.byteLength);d.set(c),self.postMessage({type:e.FRAME,frameType:a?"key":"delta",timestamp:o,duration:150,data:d.buffer},[d.buffer])}(r.data.width,r.data.height,r.data.imageData,r.data.keyFrame)}}}var _n=class extends cn{constructor(e,t){super(),this._video=null,this._imageCapture=null,this._canvas=null,this._canvasCtx=null,this._stream=null,this._track=null,this._frameReadTimeout=0,this._lastFrame=null,this._sourceTrack=e,this._onFrame=t,this._useImageCapture="ImageCapture"in window&&"ImageBitmap"in window,("live"!==e.readyState||!e.enabled||e.muted)&&(this._useImageCapture=!1)}_createDom(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="160px",this._canvas.style.zIndex="5000",this._canvasCtx=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)),!this._video&&!this._useImageCapture&&(this._video=document.createElement("video"),this._video.controls=!1,this._video.autoplay=!1,this._video.preload="auto",this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",document.body.appendChild(this._video))}_removeDom(){try{this._canvas&&document.body.removeChild(this._canvas),this._video&&document.body.removeChild(this._video)}catch(e){}this._canvasCtx=null,this._canvas=null,this._video=null}_createStream(e){return f(this,null,(function*(){if(!this._canvas)throw new Error("Canvas not found");if(!this._video&&!this._useImageCapture)throw new Error("Video element not found");return this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],new Promise(((t,n)=>{if(this._useImageCapture)this._imageCapture=new ImageCapture(e),t();else{let i=this._video;i.srcObject=new MediaStream([e]),i.onloadeddata=e=>t(),i.onerror=()=>n(new Error("Video element error"));let r=i.play(),a=()=>n(new Error("Autoplay is disabled"));r?r.catch(a):a()}}))}))}_removeStream(){var e;window.clearTimeout(this._frameReadTimeout),null==(e=this._lastFrame)||e.close(),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._video&&(this._video.pause(),this._video.srcObject=null),this._imageCapture&&(this._imageCapture=null)}_drawFrameVideo(){if(!(this._canvas&&this._canvasCtx&&this._video&&this._track))throw new Error("Fatal error");let e=this._video.videoWidth,t=this._video.videoHeight;return this._canvas.width=this._video.width=e,this._canvas.height=this._video.height=t,this._canvasCtx.clearRect(0,0,e,t),this._canvasCtx.drawImage(this._video,0,0,e,t),this._requestCanvasFrame(),this._canvasCtx.getImageData(0,0,e,t)}_getFrameBitmap(){return f(this,null,(function*(){if(!this._imageCapture)throw new Error("Destroyed");return this._imageCapture.grabFrame()}))}_drawFrameData(e){var t;if(!this._canvas||!this._canvasCtx||!this._track)throw new Error("Destroyed");let n=e.width,i=e.height;return this._canvas.width=n,this._canvas.height=i,this._canvasCtx.clearRect(0,0,n,i),this._canvasCtx.drawImage(e,0,0,n,i),this._requestCanvasFrame(),null==(t=this._canvasCtx)?void 0:t.getImageData(0,0,n,i)}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}init(){return f(this,null,(function*(){this._createDom();let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height;Ge.debug(`LibVPxEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createStream(this._sourceTrack),yield this._createWorker(hn,(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength})}),[JSON.stringify(rn),l(),l().getUrl],{isVP9:this.isVP9(),debug:Ge.enabled()})}))}_encode(e,t){let n=e.data.buffer;this._sendToWorker(rn.FRAME,{width:e.width,height:e.height,imageData:n,keyFrame:t},[n])}_requestFrameVideo(e){let t=this._drawFrameVideo();this._encode(t,e)}_requestFrameBitmap(e){this._frameReadTimeout=window.setTimeout((()=>{if(this._lastFrame){let t=this._drawFrameData(this._lastFrame);this._encode(t,e)}else this._onFrame(null)}),1e3),this._getFrameBitmap().then((t=>{var n;window.clearTimeout(this._frameReadTimeout),null==(n=this._lastFrame)||n.close(),this._lastFrame=t;let i=this._drawFrameData(t);this._encode(i,e)})).catch((()=>{}))}requestFrame(e=!1){this._useImageCapture?this._requestFrameBitmap(e):this._requestFrameVideo(e)}isVP9(){return!1}destroy(){this._removeWorker(),this._removeStream(),this._removeDom(),Ge.debug("LibVPxEncoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window&&("CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window)}};function mn(e,t){let n,i,r,a,s,o,c=null,d=0,l=!1;function u(e,n){(e.codedWidth!==r||e.codedHeight!==a)&&(r=e.codedWidth,a=e.codedHeight,p.configure({framerate:o,codec:s?t.VP9:t.VP8,width:r,height:a})),p.encode(e,{keyFrame:n})}let p=new VideoEncoder({output:t=>{let n;t.data?n=t.data:(n=new ArrayBuffer(t.byteLength),t.copyTo(n)),self.postMessage({type:e.FRAME,frameType:t.type,timestamp:t.timestamp,duration:t.duration,data:n},[n])},error:t=>{self.postMessage({type:e.FRAME,error:String(t)})}});self.onmessage=h=>{switch(h.data.type){case e.INIT:!function(c){n=c.readable,i=n.getReader(),r=c.width,a=c.height,s=c.isVP9,o=c.framerate,p.configure({framerate:o,codec:s?t.VP9:t.VP8,width:r,height:a}),self.postMessage({type:e.READY})}(h.data);break;case e.FRAME:!function(e){d=self.setTimeout((()=>{c&&u(c,e)}),1e3),!l&&(l=!0,i.read().finally((()=>{l=!1,self.clearTimeout(d)})).then((({done:t,value:r})=>{if(null==c||c.close(),c=null,!t&&r){if(!p)return i.releaseLock(),void n.cancel();c=r,u(r,e)}})))}(h.data.keyFrame)}}}var fn,gn,vn,Sn,En=class extends cn{constructor(e,t){super(),this._sourceTrack=e,this._onFrame=t,this._trackProcessor=new MediaStreamTrackProcessor(e)}init(){return f(this,null,(function*(){let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height,n=this._trackProcessor.readable;Ge.debug(`WebCodecsEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createWorker(mn,(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength})}),[JSON.stringify(rn),JSON.stringify(nn)],{readable:n,width:e,height:t,isVP9:this.isVP9(),framerate:be.screenFrameRate},[n])}))}requestFrame(e=!1){this._sendToWorker(rn.FRAME,{keyFrame:e})}isVP9(){return!0}destroy(){this._removeWorker(),Ge.debug("WebCodecsEncoder destroyed")}static isBrowserSupported(){return"VideoEncoder"in window&&"Worker"in window&&"EncodedVideoChunk"in window&&"MediaStreamTrackProcessor"in window}},Tn=0,yn=class{constructor(e,t){this._destroyed=!1,this._needKeyframe=!0,Ge.debug("ScreenCaptureSender started"),this._datachannel=t;let n=(e,t)=>{if(!this._destroyed){if(!e)return Ge.warn("requestFrame failed, keyFrame: "+this._needKeyframe,t),this._needKeyframe=!0,void this._requestFrame();this._send(e).catch((e=>{Ge.warn("sendFrame failed",e),this._needKeyframe=!0})).finally((()=>this._requestFrame()))}};En.isBrowserSupported()?this._encoder=new En(e,n):this._encoder=new _n(e,n),this._datachannel.onmessage=e=>{(function(e){if(!e||!e.byteLength||4!==e.byteLength)return!1;let t=new DataView(e);return!(1!==t.getUint8(0)||1!==t.getUint8(1)||0!==t.getUint16(2))})(e.data)&&(Ge.debug(`[${this._datachannel.label}] Requested keyframe`),this._needKeyframe=!0)},this._encoder.init().then((()=>this._requestFrame())).catch((e=>Ge.warn("ScreenCaptureSender init failed",e)))}_requestFrame(){this._destroyed||(this._encoder.requestFrame(this._needKeyframe),this._needKeyframe=!1)}_wrapHeader(e,t,n,i,r){let a=function(e,t,n,i,r,a,s){let o=0;t&&(o|=1),n&&(o|=2),i&&(o|=4),s||(o|=8);let c=new ArrayBuffer(11),d=new DataView(c);if(d.setUint8(0,1),d.setUint16(1,r),d.setUint32(3,e),d.setUint8(7,a?1:0),d.setUint16(8,0),d.setUint8(10,o),!s)return c;let l=new Uint8Array(c.byteLength+s.byteLength);return l.set(new Uint8Array(c),0),l.set(new Uint8Array(s),c.byteLength),l.buffer}(e,t,n,i,Tn,this._encoder.isVP9(),r);return Tn=(Tn+1)%65536,a}_stopPacket(){return this._wrapHeader(Date.now(),!1,!1,!1,null)}_send(e){return f(this,null,(function*(){return new Promise(((t,n)=>{this._sendChunk(e,0,t,n)}))}))}_sendChunk(e,t,n,i){if(!this._datachannel||"open"!==this._datachannel.readyState)return void i();let r=e.data.slice(t,t+16373),a=e.data.byteLength<=t+r.byteLength,s=this._wrapHeader(e.timestamp,!t,a,"key"===e.type,r);this._datachannel.onbufferedamountlow=a?()=>{this._datachannel.bufferedAmount<=this._datachannel.bufferedAmountLowThreshold&&n()}:null;try{this._datachannel.send(s)}catch(e){return Ge.warn("Error send data to DataChannel",e),void i()}a||window.setTimeout((()=>this._sendChunk(e,t+16373,n,i)),0)}destroy(){this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null,"open"===this._datachannel.readyState&&this._datachannel.send(this._stopPacket()),this._destroyed=!0,this._encoder.destroy(),Ge.debug("ScreenCaptureSender destroyed")}static isBrowserSupported(){return En.isBrowserSupported()||_n.isBrowserSupported()}},Cn="videochat-epi",Rn=class extends S{constructor(e,t){super(),this._previousTimestamp=0,this._signaling=t,this.subscribe(e,fn.REMOTE_DATA_STATS,this._handleStats.bind(this))}destroy(){this.unsubscribe()}static getEstimatedPerformanceIndex(){try{let e=parseInt(localStorage.getItem(Cn)||"",10);return isNaN(e)?0:e}catch(e){return 0}}_handleStats(e){return f(this,null,(function*(){if(!be.perfStatReportEnabled||!e.inbound||!e.inbound.rtps)return;let t=e.inbound.rtps.reduce(((e,t)=>("video"===t.kind&&(e.framesDecoded+=t.framesDecoded||0,e.framesReceived+=t.framesReceived||0),e)),{framesDecoded:0,framesReceived:0}),n=Date.now();if(!(this._previousTimestamp+5e3>n)){if(t.framesDecoded)try{let e=yield this._signaling.reportPerfStat(t);localStorage.setItem(Cn,e.estimatedPerformanceIndex)}catch(e){}this._previousTimestamp=n}}))}},In=class extends S{constructor(e,t,n){super(),this._pc=null,this._producerNotification=null,this._producerCommand=null,this._producerScreen=null,this._consumerScreen=null,this._isOpen=!1,this._reconnectionPrevented=!1,this._state=gn.IDLE,this._statInterval=null,this._settingsInterval=null,this._statBytes={},this._ssrcMap={},this._producerOfferIsProcessing=!1,this._producerNextOffer=null,this._prevConsumerSettings={},this._captureSender=null,this._captureReceiver=null,this._participantIdRegistry=null,this._disabledSenders=new Set,this._rtpReceiversByStreamId={},this._producerSessionId="",this._signaling=e,this._mediaSource=t,this.subscribe(this._signaling,Y.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,Tt.TRACK_REPLACED,this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,Tt.SOURCE_CHANGED,this._applyConsumerSettings.bind(this)),this.subscribe(this._mediaSource,Tt.SCREEN_STATUS,this._onScreenSharingStatus.bind(this)),this._perfStatReporter=new Rn(this,e),this._serverSettings=n,be.consumerScreenDataChannel&&!yn.isBrowserSupported()&&(be.consumerScreenDataChannel=!1),be.producerScreenDataChannel&&!pn.isBrowserSupported()&&(be.producerScreenDataChannel=!1),Ge.debug("ServerTransport: Created")}getState(){return this._state||gn.IDLE}updateStatisticsInterval(){this._stopStatInterval();let e=this.getState();e!==gn.IDLE&&e!==gn.CLOSED&&e!==gn.FAILED&&this._startStatInterval()}open(){this._isOpen?Ge.log("ServerTransport: Already opened connections"):(this._isOpen=!0,this._openConnection())}close(e){this._isOpen=!1,this._closeConnection(),this.unsubscribe(),e?(Ge.error("ServerTransport: Closed",e),this._setState(gn.FAILED)):(Ge.debug("ServerTransport: Closed"),this._setState(gn.CLOSED))}removeParticipant(e){var t;null==(t=this._captureReceiver)||t.close(e)}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}updateSettings(e){Lt(e,this._serverSettings)||(this._serverSettings=e,this._applyConsumerSettings())}_closeConnection(){this._stopStatInterval(),this._stopSettingsInterval(),this._removeCaptureSender(),this._removeCaptureReceiver(),this._pc&&(this._rtpReceiversByStreamId={},this._disabledSenders.forEach((e=>{var t;return null==(t=e.track)?void 0:t.stop()})),this._disabledSenders.clear(),this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._participantIdRegistry=null,In._closeDataChannel(this._producerNotification),In._closeDataChannel(this._producerCommand),In._closeDataChannel(this._producerScreen),In._closeDataChannel(this._consumerScreen),this._pc.close(),this._pc=null,this._producerOfferIsProcessing=!1,this._producerNextOffer=null),this._triggerEvent(fn.PEER_CONNECTION_CLOSED)}static _closeDataChannel(e){e&&(e.onopen=null,e.onmessage=null,e.onerror=null,e.close())}_createDataChannel(e,t,n){Ge.debug(`[${t}] data channel opening`);let i=e.createDataChannel(t,{ordered:!0});i.onopen=()=>{Ge.debug(`[${t}] data channel opened`),i.onerror=e=>{Ge.error(`[${t}] data channel error`,e)},n(i)}}_openConnection(e=!1){Ge.debug("ServerTransport: Open single connection");let t={};vt.baseChromeVersion()&&(t.sdpSemantics=In._isUnifiedPlanSupported()?"unified-plan":"plan-b"),this._pc=new RTCPeerConnection(t,{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.ontrack=this._onAddTrack.bind(this,this._pc),this._pc.onconnectionstatechange=bt.throttle((e=>{this._pc&&this._onConnectionStateChange(this._pc,e)}),500),this._pc.onsignalingstatechange=In._onSignalingStateChange.bind(this,this._pc),be.producerNotificationDataChannel&&this._createDataChannel(this._pc,sn.producerNotification,(e=>{this._producerNotification=e,this._producerNotification.binaryType="arraybuffer",this._participantIdRegistry=new class{constructor(){this.streamDescriptionByCompactId=new Map}getStreamDescription(e){return this.streamDescriptionByCompactId.get(e)}handleMessage(e){var t,n;let i=new Uint8Array(e),r=i[0],a=i.subarray(1);switch(r){case 1:let e=(0,c.decode)(a);return Object.entries(e).forEach((([e,t])=>{let n=Nt(e);this.streamDescriptionByCompactId.set(t,n)})),null;case 2:case 4:let i=(0,c.decode)(a),s=[];for(let e of i){let t=this.getStreamDescription(e);t&&s.push(t.participantId)}return 2===r?{type:"notification",notification:Q.AUDIO_ACTIVITY,activeParticipants:s}:{type:"notification",notification:Q.STALLED_ACTIVITY,stalledParticipants:s};case 3:let o=(0,c.decode)(a);return{type:"notification",notification:Q.SPEAKER_CHANGED,speaker:null==(t=this.getStreamDescription(o))?void 0:t.participantId};case 5:let d=(0,c.decode)(a);return{type:"notification",notification:Q.VIDEO_QUALITY_UPDATE,quality:{maxBitrate:d[0],maxDimension:d[1]}};case 6:let l=(0,c.decode)(a),u={};for(let[e,t]of Object.entries(l)){let i=null==(n=this.getStreamDescription(Number(e)))?void 0:n.participantId;i&&(u[i]=t/100)}return{type:"notification",notification:Q.NETWORK_STATUS,statuses:u};case 7:return this._createParticipantSourcesUpdateNotification(a);default:return Ge.debug("unsupported message type: "+r),null}}_createParticipantSourcesUpdateNotification(e){let t=(0,c.decode)(e),n=[];for(let[e,i]of Object.entries(t)){let t,r=i[0],a=i[1],s=i[2];if(null!==r){if(t=this.getStreamDescription(r),!t){Ge.error(`could not uncompress participant ID ${r}`);continue}}else t=null;if(null===s){Ge.error("unexpected null sequenceNumber",e,i);continue}let o=ne.PARTICIPANT_AGNOSTIC_TRACK_PREFIX+"-"+e,c=a?a>>>0:null;n.push({participantStreamDescription:t,streamId:o,rtpTimestamp:c,sequenceNumber:s})}return{type:"notification",notification:Q.PARTICIPANT_SOURCES_UPDATE,participantUpdateInfos:n}}},this._signaling.setParticipantIdRegistry(this._participantIdRegistry),this._signaling.setProducerNotificationDataChannel(e)})),be.producerCommandDataChannel&&this._createDataChannel(this._pc,sn.producerCommand,(e=>{this._producerCommand=e,this._signaling.setProducerCommandDataChannel(e)})),be.producerScreenDataChannel&&this._createDataChannel(this._pc,sn.producerScreenShare,(e=>{this._producerScreen=e,this._producerScreen.binaryType="arraybuffer",this._createCaptureReceiver()}));try{this._mediaSource.addTrackToPeerConnection(this._pc),this._prevConsumerSettings={},this._applyConsumerSettings()}catch(e){return Ge.error("ServerTransport: Unable to add media source tracks",e),Rt.log(ee.ERROR,"addTrack-single"),void this.close(e)}be.consumerScreenDataChannel&&this._createDataChannel(this._pc,sn.consumerScreenShare,(e=>{this._consumerScreen=e,this._consumerScreen.binaryType="arraybuffer";let t=this._mediaSource.getScreenTrack();t&&this._createCaptureSender(t)})),e||this._allocateConsumer(),this._setState(gn.OPENED),this._startStatInterval(),this._startSettingsInterval()}_reconnect(){this.getState()!==gn.OPENED&&(this._setState(gn.RECONNECTING),this._closeConnection(),this._openConnection(!0))}_signalActiveParticipants(e){this._triggerEvent(fn.SIGNALLED_ACTIVE_PARTICIPANTS,e)}_signalStalledParticipants(e){this._triggerEvent(fn.SIGNALLED_STALLED_PARTICIPANTS,e)}_signalSpeakerChanged(e){this._triggerEvent(fn.SIGNALLED_SPEAKER_CHANGED,e)}_signalNetworkStatus(e){this._triggerEvent(fn.NETWORK_STATUS,e)}_updateSSRCMap(e){e&&e.sdp.split("\n").forEach((e=>{let t=`a=ssrc:([0-9]+) label:(audio|video)-((?:[ug]?[\\d]+)|(?:mix)|(?:${ne.PARTICIPANT_AGNOSTIC_TRACK_PREFIX}-[0-9]+))`,n=new RegExp(t).exec(e);n&&(this._ssrcMap[n[1]]=n[3])}))}_createCaptureSender(e){!e||!be.consumerScreenDataChannel||!this._consumerScreen||!this._mediaSource.getMediaSettings().isScreenSharingEnabled||(this._captureSender&&this._removeCaptureSender(),this._captureSender=new yn(e,this._consumerScreen))}_removeCaptureSender(){var e;null==(e=this._captureSender)||e.destroy(),this._captureSender=null}_createCaptureReceiver(){!be.producerScreenDataChannel||!this._producerScreen||!this._participantIdRegistry||(this._captureReceiver&&this._removeCaptureReceiver(),this._captureReceiver=new pn(this._producerScreen,this._participantIdRegistry,((e,t)=>{this._triggerEvent(fn.REMOTE_STREAM_SECOND,e,t)}),(e=>{this._triggerEvent(fn.REMOTE_STREAM_SECOND,e,null)})))}_removeCaptureReceiver(){var e;null==(e=this._captureReceiver)||e.destroy(),this._captureReceiver=null}_applyConsumerSettings(){let e=this._mediaSource.getMediaSettings().isScreenSharingEnabled?this._serverSettings.screenSharing:this._serverSettings.camera;if(e&&this._pc){let t=[];this._pc.getSenders().forEach((n=>{if(!n.track||n.track.kind!==yt.video)return;let i=!this._disabledSenders.has(n),r=0!==e.maxDimension;if(i&&!r)return Ge.log("Disabling video upload"),this._disabledSenders.add(n),void n.replaceTrack(vt.getBlackMediaTrack()).catch((e=>{Ge.error("Could not disable video upload",e)}));let a=this._mediaSource.getSendVideoTrack();if(!i&&r&&a){Ge.log("Enabling video upload"),this._disabledSenders.delete(n);let e=n.track;e.enabled=a.enabled,n.replaceTrack(a).then((()=>e.stop())).catch((e=>{Ge.error("Could not enable video upload",e)}))}bt.applyVideoTrackSettings(e,n,null!=a?a:n.track,this._prevConsumerSettings,t)})),this._prevConsumerSettings=t}}_onScreenSharingStatus(e){e.track?this._createCaptureSender(e.track):this._removeCaptureSender()}_setState(e){this._state!==e&&(this._state=e,this._triggerEvent(fn.STATE_CHANGED,e))}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._pc?(this._collectStat().then((e=>{this._reportStats(e),this._detectStaleTracks(e)})).catch((()=>{})),this._statInterval=window.setTimeout(e,be.statisticsInterval)):this._stopStatInterval()};this._statInterval=window.setTimeout(e,be.statisticsInterval)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null),this._statBytes={}}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applyConsumerSettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_collectStat(){return f(this,null,(function*(){if(!this._pc)return Promise.reject();let e=yield Qt(this._pc,this._lastStat,this._ssrcMap);return this._lastStat=e,e}))}_reportStats(e){this._triggerEvent(fn.REMOTE_DATA_STATS,{inbound:{topology:Sn.SERVER,transport:e.transport,rtps:e.rtps.filter((e=>"inbound-rtp"===e.type))},outbound:{topology:Sn.SERVER,transport:e.transport,rtps:e.rtps.filter((e=>"outbound-rtp"===e.type))}})}_detectStaleTracks(e){let t=e.rtps.find((e=>"inbound-rtp"===e.type&&"audio"===e.kind&&"mix"===this._ssrcMap[e.ssrc]));if(!t)return;let n=ne.AUDIO_MIX,i=this._statBytes[n],r=!1;if(i){let e=t.bytesReceived-i.bytesReceived;e>=0&&e<=5&&(r=!0),i.stalled!==r&&this._triggerEvent(fn.REMOTE_ALL_STALL,r)}this._statBytes[n]={bytesReceived:t.bytesReceived,stalled:r}}_allocateConsumer(){if(!this._signaling.ready)return;let e={estimatedPerformanceIndex:Rn.getEstimatedPerformanceIndex(),audioMix:!0,consumerUpdate:!0,producerNotificationDataChannelVersion:be.producerNotificationDataChannel?6:0,producerCommandDataChannelVersion:be.producerCommandDataChannel?2:0,consumerScreenDataChannelVersion:be.consumerScreenDataChannel?1:0,producerScreenDataChannelVersion:be.producerScreenDataChannel?1:0,onDemandTracks:!0,unifiedPlan:In._isUnifiedPlanSupported(),singleSession:!0,videoTracksCount:be.videoTracksCount};this._signaling.allocateConsumer(null,e)}_acceptProducer(e){return f(this,null,(function*(){if(this._producerOfferIsProcessing)return this._producerNextOffer=e,void Ge.debug("[single] wait until other remote offer is processed");this._producerOfferIsProcessing=!0;let t=new RTCSessionDescription({type:"offer",sdp:e});if(Ge.debug("[single] set remote offer",{offer:t}),!this._pc)throw new Error("Interrupt allocation");this._pc.setRemoteDescription(t).catch((e=>{throw Ge.error("[single] unable to set remote offer",e),Rt.log(ee.ERROR,"setRemoteDescription-single"),e})).then((()=>f(this,null,(function*(){if(Ge.debug("[single] create local answer"),!this._pc)throw new Error("Interrupt allocation");return this._pc.createAnswer()})))).catch((e=>{throw Ge.error("[single] unable to create answer",e),Rt.log(ee.ERROR,"createAnswer-single"),e})).then((e=>(e.sdp=bt.patchSDP(e.sdp,!1,vt.isBrokenH264(),!1),e))).then((e=>f(this,null,(function*(){if(Ge.debug("[single] set local answer",{answer:e}),!this._pc)throw new Error("Interrupt allocation");return yield this._pc.setLocalDescription(e),e})))).catch((e=>{throw Ge.error("[single] unable to set local answer",e),Rt.log(ee.ERROR,"setLocalDescription-single"),e})).then((e=>f(this,null,(function*(){Ge.debug("[single] transmit local answer",{answer:e}),this._updateSSRCMap(t),yield this._signaling.acceptProducer(e,Object.keys(this._ssrcMap)),Ge.debug("[single] remote offer has been processed")})))).catch((e=>{Ge.warn("[single] unable to send local answer",e),Rt.log(ee.ERROR,"acceptProducer")})).then((()=>f(this,null,(function*(){if(this._producerOfferIsProcessing=!1,this._producerNextOffer){Ge.debug("[single] there is other unprocessed remote offer, process it");let e=this._producerNextOffer;return this._producerNextOffer=null,this._acceptProducer(e)}})))).catch((e=>this.close(e)))}))}_onSignalingNotification(e){return f(this,null,(function*(){if(this._isOpen)switch(e.notification){case Q.PRODUCER_UPDATED:yield this._onProducerUpdated(e);break;case Q.REALLOC_CON:this._reconnect();break;case Q.AUDIO_ACTIVITY:this._signalActiveParticipants(e.activeParticipants);break;case Q.SPEAKER_CHANGED:this._signalSpeakerChanged(e.speaker);break;case Q.STALLED_ACTIVITY:this._signalStalledParticipants(e.stalledParticipants);break;case Q.NETWORK_STATUS:this._signalNetworkStatus(e.statuses)}}))}_onProducerUpdated(e){return f(this,null,(function*(){this._producerSessionId&&this._producerSessionId!==e.sessionId&&this._reconnect(),be.breakVideoPayloadTypes&&(Ge.log("test mode enabled, video switched off"),this._signaling.requestTestMode("breakVideoPayloadTypes")),this._producerSessionId=e.sessionId,yield this._acceptProducer(e.description)}))}_onAddTrack(e,t){Ge.debug("[single] remote track (added)",{track:t.track});let n=t.streams[0];n?(n.onremovetrack||(n.onremovetrack=e=>{this._triggerEvent(fn.REMOTE_TRACK_REMOVED,n.id,n,e.track)}),n.getTracks().find((e=>e.id===t.track.id))||n.addTrack(t.track),this._rtpReceiversByStreamId[n.id]=t.receiver,this._triggerEvent(fn.REMOTE_TRACK_ADDED,n.id,n,t.track)):Ge.error("[single] unable to get media stream from track event")}static _onSignalingStateChange(e,t){Ge.debug("[single] signaling state changed",{state:e.signalingState},t)}_onConnectionStateChange(e,t){switch(Ge.debug("[single] connection state changed",{state:e.connectionState},t),Rt.log(ee.ICE_CONNECTION_STATE,e.connectionState),e.connectionState){case"failed":this._reconnectionPrevented?this.close(new Error("Ice connection failed")):this._reconnect();break;case"connecting":let t=this.getState();t===gn.IDLE||t===gn.OPENED?this._setState(gn.CONNECTING):"checking"===e.iceConnectionState&&this._setState(gn.RECONNECTING);break;case"disconnected":this._reconnectionPrevented?this.close(new Error("Ice connection disconnected")):this._setState(gn.RECONNECTING);break;case"connected":this._setState(gn.CONNECTED),bt.getPeerConnectionHostInfo(e).then((e=>{e&&Rt.log(ee.ICE_CONNECTION_TYPE,e.type)}))}}_onReplacedTrack(e,t){this._pc&&(be.consumerScreenDataChannel&&t&&(e=t),this._pc.getSenders().forEach((t=>{t.track&&t.track.kind===e.kind&&!this._disabledSenders.has(t)&&(t.track.enabled=e.enabled,t.replaceTrack(e).catch((e=>{Ge.error("ServerTransport: Unable to replace track",e),Rt.log(ee.ERROR,"replaceTrack-single")})))}))),this._applyConsumerSettings()}static _isUnifiedPlanSupported(){let e=vt.baseChromeVersion();return e?be.isUnifiedPlanSupported("Chrome",e):be.isUnifiedPlanSupported(vt.browserName(),vt.browserVersion())}getStreamWaitingTimeMs(e,t){if(!this._pc)return Rt.log(ee.PAT_WAITING_TIME_ERROR,"noConnection"),Ge.error("Cannot get stream waiting time, peer connection is not initialized"),0;let n=this._rtpReceiversByStreamId[e];if(!n)return Rt.log(ee.PAT_WAITING_TIME_ERROR,"noReceiver"),Ge.error(`Cannot get stream waiting time, cannot find RTP receiver by stream ID: ${e}`),0;let i=n.getSynchronizationSources();if(!i||!i.length)return Ge.log(`Cannot get stream waiting time, ${e} receiver has no synchronization sources`),0;let r=i[0].rtpTimestamp;if(!Number.isInteger(r))return Rt.log(ee.PAT_WAITING_TIME_ERROR,"timestampNotInteger"),Ge.error(`Cannot get stream waiting time, ${e} receiver's RTP timestamp is not an integer: ${r}`),0;let a=t-r&4294967295,s=Math.ceil(a/90);return Math.min(100,Math.max(0,s))}};!function(e){e.REMOTE_TRACK_ADDED="REMOTE_TRACK_ADDED",e.REMOTE_TRACK_REMOVED="REMOTE_TRACK_REMOVED",e.REMOTE_STREAM_SECOND="REMOTE_STREAM_SECOND",e.REMOTE_ALL_STALL="REMOTE_ALL_STALL",e.REMOTE_DATA_STATS="REMOTE_DATA_STATS",e.STATE_CHANGED="STATE_CHANGED",e.LOCAL_STATE_CHANGED="LOCAL_STATE_CHANGED",e.SIGNALLED_ACTIVE_PARTICIPANTS="SIGNALLED_ACTIVE_PARTICIPANTS",e.ACTIVE_PARTICIPANTS_NO_SIGNAL="ACTIVE_PARTICIPANTS_NO_SIGNAL",e.SIGNALLED_SPEAKER_CHANGED="SIGNALLED_SPEAKER_CHANGED",e.SIGNALLED_STALLED_PARTICIPANTS="SIGNALLED_STALLED_PARTICIPANTS",e.TOPOLOGY_CHANGED="TOPOLOGY_CHANGED",e.NETWORK_STATUS="NETWORK_STATUS",e.PEER_CONNECTION_CLOSED="PEER_CONNECTION_CLOSED"}(fn||(fn={})),(vn=gn||(gn={})).IDLE="IDLE",vn.OPENED="OPENED",vn.CONNECTING="CONNECTING",vn.RECONNECTING="RECONNECTING",vn.CONNECTED="CONNECTED",vn.CLOSED="CLOSED",vn.FAILED="FAILED",function(e){e.DIRECT="DIRECT",e.SERVER="SERVER"}(Sn||(Sn={}));var Pn,An=class extends S{constructor(e,t,n,i){super(),this._allocated=[],this._opened=[],this._directTransport=null,this._serverTransport=null,this._dtListeners=[],this._stListeners=[],this._states={},this._localState=gn.IDLE,this._signaling=t,this._mediaSource=n,this._topology=e,this._serverSettings=i,this.subscribe(this._signaling,Y.NOTIFICATION,this._onSignalingNotification.bind(this)),e===Sn.SERVER&&(this._serverTransport=this._createServerTransport())}updateSettings(e){this._serverSettings=e,this._directTransport&&this._directTransport.updateSettings(e),this._serverTransport&&this._serverTransport.updateSettings(e)}updateStatisticsInterval(){this._directTransport&&this._directTransport.updateStatisticsInterval(),this._serverTransport&&this._serverTransport.updateStatisticsInterval()}allocate(e,t=!1){-1===this._allocated.indexOf(e)?(this._allocated.push(e),this._topology===Sn.DIRECT&&!this._directTransport&&(this._directTransport=this._createDirectTransport(e,t)),this._topology===Sn.SERVER&&!this._serverTransport&&(this._serverTransport=this._createServerTransport())):Ge.warn(`The participant [${e}] has already had allocated transport`)}open(e,t=null){let n=!1;for(let t of e)-1===this._opened.indexOf(t)?-1!==this._allocated.indexOf(t)?(this._opened.push(t),n=!0):Ge.warn(`The participant [${t}] has no allocated transport`):Ge.warn(`The participant [${t}] has already had opened transport`);!n||(this._topology===Sn.DIRECT&&this._directTransport&&this._directTransport.open(t),this._topology===Sn.SERVER&&this._serverTransport&&(this._serverTransport.open(),this._setStates(e,this._serverTransport.getState()),this._setLocalState(this._serverTransport.getState())),Ge.debug("The transport has been opened",e))}close(e){var t;let n=this._allocated.indexOf(e),i=this._opened.indexOf(e);n<0&&Ge.warn(`The participant [${e}] transport has already deallocated`),this._topology===Sn.DIRECT&&this._directTransport&&(this._directTransport.close(),this._directTransport=null),this._topology===Sn.SERVER&&(null==(t=this._serverTransport)||t.removeParticipant(e),this._setState(e,gn.CLOSED)),i>=0&&this._opened.splice(i,1),n>=0&&this._allocated.splice(n,1)}destroy(){this.unsubscribe(),this._dtListeners&&this._dtListeners.forEach((e=>{e.dispose()})),this._stListeners&&this._stListeners.forEach((e=>{e.dispose()})),this._directTransport&&(this._directTransport.close(),this._directTransport=null),this._serverTransport&&(this._serverTransport.close(),this._serverTransport=null),this._allocated=[],this._opened=[]}getTopology(){return this._topology}isAllocated(e){return this._allocated.indexOf(e)>=0}allocated(){return this._allocated.slice()}opened(){return this._opened.slice()}_setStates(e,t){let n=e.filter((e=>this._states[e]!==t&&(this._states[e]=t,!0)));n.length&&this._triggerEvent(fn.STATE_CHANGED,n,t)}_setState(e,t){this._states[e]!==t&&(this._states[e]=t,this._triggerEvent(fn.STATE_CHANGED,[e],t))}_setLocalState(e){this._localState!==e&&(this._localState=e,this._triggerEvent(fn.LOCAL_STATE_CHANGED,e))}_onSignalingNotification(e){return e.notification===Q.TOPOLOGY_CHANGED?this._onTopologyChanged(e):e.notification===Q.RECORD_STARTED?this._onRecordStarted(e):void 0}_onTopologyChanged(e){var t;if(e.topology!==this._topology){if(Ge.log(`Topology changed ${this._topology} -> ${e.topology}`),Rt.log(ee.TOPOLOGY_CHANGE_REQUESTED,e.topology),this._topology=e.topology,this._topology===Sn.SERVER&&(this._serverTransport?this._serverTransport.allowRestart():(this._serverTransport=this._createServerTransport(),this._opened.length>0&&(null==(t=this._directTransport)||t.preventRestart(),this._serverTransport.open()))),this._topology===Sn.DIRECT){let t=e.offerTo||[],n=e.offerToTypes||[],i=t.length&&n.length?bt.composeId(t[0],n[0]):null;if(this._serverTransport&&this._serverTransport.preventRestart(),!this._allocated||0===this._allocated.length)return void Ge.error("Topology changed to DIRECT, but the list of allocated participants is empty");this._allocated.length>1&&Ge.warn("Topology changed to DIRECT, but the allocated participants count more then one");let r=this._allocated[0];if(this._directTransport)this._directTransport.allowRestart();else{let e=i===r;this._directTransport=this._createDirectTransport(r,e)}this._opened.indexOf(r)>=0&&this._directTransport.open()}this._triggerEvent(fn.TOPOLOGY_CHANGED,this._topology)}}_onRecordStarted(e){this._serverTransport&&this._serverTransport.open()}_createDirectTransport(e,t=!1){let n=new tn(e,t,this._signaling,this._mediaSource,this._serverSettings);return this._setLocalNoiseSuppression(!0),this._dtListeners&&this._dtListeners.length>0&&Ge.warn(`The list of direct listeners for the participant [${e}] is not empty`),this._dtListeners=[],this._dtListeners.push(n.addEventListener(fn.REMOTE_TRACK_ADDED,this._onDirectRemoteTrackAdded.bind(this,e)),n.addEventListener(fn.REMOTE_TRACK_REMOVED,this._onDirectRemoteTrackRemoved.bind(this,e)),n.addEventListener(fn.REMOTE_DATA_STATS,this._onDirectRemoteDataStats.bind(this)),n.addEventListener(fn.STATE_CHANGED,this._onDirectTransportChanged.bind(this,e)),n.addEventListener(fn.NETWORK_STATUS,this._onTransportNetworkStatus.bind(this)),n.addEventListener(fn.PEER_CONNECTION_CLOSED,this._onPeerConnectionClosed.bind(this,Sn.DIRECT))),n}_createServerTransport(){let e=new In(this._signaling,this._mediaSource,this._serverSettings);return this._setLocalNoiseSuppression(!1),this._stListeners&&this._stListeners.length>0&&Ge.warn("The list of server transport listeners is not empty"),this._stListeners=[],this._stListeners.push(e.addEventListener(fn.REMOTE_TRACK_ADDED,this._onServerRemoteTrackAdded.bind(this)),e.addEventListener(fn.REMOTE_TRACK_REMOVED,this._onServerRemoteTrackRemoved.bind(this)),e.addEventListener(fn.REMOTE_ALL_STALL,this._onServerRemoteAllStall.bind(this)),e.addEventListener(fn.REMOTE_DATA_STATS,this._onServerRemoteDataStats.bind(this)),e.addEventListener(fn.STATE_CHANGED,this._onServerTransportChanged.bind(this)),e.addEventListener(fn.ACTIVE_PARTICIPANTS_NO_SIGNAL,this._onTransportActiveParticipantsNoSignal.bind(this)),e.addEventListener(fn.SIGNALLED_ACTIVE_PARTICIPANTS,this._onTransportActiveParticipants.bind(this)),e.addEventListener(fn.SIGNALLED_SPEAKER_CHANGED,this._onTransportSpeakerChanged.bind(this)),e.addEventListener(fn.SIGNALLED_STALLED_PARTICIPANTS,this._onTransportStalledParticipants.bind(this)),e.addEventListener(fn.NETWORK_STATUS,this._onTransportNetworkStatus.bind(this)),e.addEventListener(fn.REMOTE_STREAM_SECOND,this._onRemoteStreamSecond.bind(this)),e.addEventListener(fn.PEER_CONNECTION_CLOSED,this._onPeerConnectionClosed.bind(this,Sn.SERVER))),e}_releaseDirectTransport(e){this._directTransport&&(e&&this._directTransport.close(),this._directTransport=null),this._dtListeners&&(this._dtListeners.forEach((e=>{e.dispose()})),this._dtListeners=[])}_releaseServerTransport(e){this._serverTransport&&(e&&this._serverTransport.close(),this._serverTransport=null),this._stListeners&&(this._stListeners.forEach((e=>{e.dispose()})),this._stListeners=[])}_setLocalNoiseSuppression(e){var t;be.noiseSuppression!==e&&(be.noiseSuppression=e,null==(t=this._mediaSource)||t.updateNoiseSuppression())}_onDirectTransportChanged(e,t){if(t===gn.CONNECTED&&this._topology===Sn.DIRECT&&this._releaseServerTransport(!0),(t===gn.CLOSED||t===gn.FAILED)&&(this._releaseDirectTransport(!1),this._topology===Sn.DIRECT)){let t=this._opened.indexOf(e);t>=0&&this._opened.splice(t,1);let n=this._allocated.indexOf(e);n>=0&&this._allocated.splice(n,1)}this._topology===Sn.DIRECT&&(this._setState(e,t),this._setLocalState(t))}_onServerTransportChanged(e){let t=this._opened.slice();e===gn.CONNECTED&&this._topology===Sn.SERVER&&this._releaseDirectTransport(!0),(e===gn.CLOSED||e===gn.FAILED)&&(this._releaseServerTransport(!1),this._topology===Sn.SERVER&&(this._allocated=[],this._opened=[])),this._topology===Sn.SERVER&&(this._setStates(t,e),this._setLocalState(e))}_onTransportActiveParticipantsNoSignal(){this._triggerEvent(fn.ACTIVE_PARTICIPANTS_NO_SIGNAL)}_onTransportActiveParticipants(e){this._topology===Sn.SERVER&&this._triggerEvent(fn.SIGNALLED_ACTIVE_PARTICIPANTS,e)}_onTransportStalledParticipants(e){this._topology===Sn.SERVER&&this._triggerEvent(fn.SIGNALLED_STALLED_PARTICIPANTS,e)}_onTransportSpeakerChanged(e){this._topology===Sn.SERVER&&this._triggerEvent(fn.SIGNALLED_SPEAKER_CHANGED,e)}_onTransportNetworkStatus(e){this._triggerEvent(fn.NETWORK_STATUS,e)}_onRemoteStreamSecond(e,t){this._triggerEvent(fn.REMOTE_STREAM_SECOND,e,t)}_onPeerConnectionClosed(e){this._triggerEvent(fn.PEER_CONNECTION_CLOSED,e)}_onServerRemoteAllStall(e){this._topology===Sn.SERVER&&this._triggerEvent(fn.REMOTE_ALL_STALL,e)}_onServerRemoteDataStats(e){this._triggerEvent(fn.REMOTE_DATA_STATS,e)}_onDirectRemoteTrackAdded(e,t,n){this._triggerEvent(fn.REMOTE_TRACK_ADDED,e,t,n)}_onDirectRemoteTrackRemoved(e,t,n){this._triggerEvent(fn.REMOTE_TRACK_REMOVED,e,t,n)}_onDirectRemoteDataStats(e){this._triggerEvent(fn.REMOTE_DATA_STATS,e)}_onServerRemoteTrackAdded(e,t,n){this._triggerEvent(fn.REMOTE_TRACK_ADDED,e,t,n)}_onServerRemoteTrackRemoved(e,t,n){this._triggerEvent(fn.REMOTE_TRACK_REMOVED,e,t,n)}getStreamWaitingTimeMs(e,t){return this._topology!==Sn.SERVER?(Rt.log(ee.PAT_WAITING_TIME_ERROR,"wrongTopology"),Ge.error(`Cannot get stream waiting time, incorrect topology: ${this._topology}`),0):this._serverTransport?this._serverTransport.getStreamWaitingTimeMs(e,t):(Rt.log(ee.PAT_WAITING_TIME_ERROR,"noTransport"),Ge.error("Cannot get stream waiting time, server transport is not initialized"),0)}};(Pn||(Pn={})).VOLUMES_DETECTED="VOLUMES_DETECTED";var wn,On=class extends S{constructor(e){super(),this._detector=null,this._interval=null,this.subscribe(e,fn.REMOTE_TRACK_ADDED,this._onRemoteTrackAdded.bind(this)),this.subscribe(e,fn.REMOTE_TRACK_REMOVED,this._onRemoteTrackRemoved.bind(this)),this.subscribe(e,fn.SIGNALLED_ACTIVE_PARTICIPANTS,this._onSignalledActiveParticipants.bind(this)),this.subscribe(e,fn.ACTIVE_PARTICIPANTS_NO_SIGNAL,this._onActiveParticipantsNoSignal.bind(this))}destroy(){var e;this._interval&&(window.clearTimeout(this._interval),this._interval=null),this.unsubscribe(),null==(e=this._detector)||e.destroy(),this._detector=null}_onRemoteTrackAdded(e,t,n){var i;if(n.kind===yt.audio&&(null==(i=this._detector)||i.destroy(),this._detector=new Vt(e,t),!this._interval)){let e=()=>{this._collectVolumes(),this._interval=window.setTimeout(e,be.voiceParams.interval)};this._interval=window.setTimeout(e,be.voiceParams.interval)}}_onRemoteTrackRemoved(e,t,n){n.kind===yt.audio&&(!this._detector||this._detector.stream!==t||(this._detector.destroy(),this._detector=null))}_collectVolumes(){if(!this._detector)return;let e={},t=this._detector.trackId,n=this._detector.getLevel();if(t===ne.AUDIO_MIX){if(this._activeParticipants)for(let t of this._activeParticipants)e[t]=n}else e[t]=n;this._triggerEvent(Pn.VOLUMES_DETECTED,e)}_onSignalledActiveParticipants(e){this._activeParticipants=e}_onActiveParticipantsNoSignal(){this._activeParticipants=null}};!function(e){e.SPEAKER_CHANGED="SPEAKER_CHANGED"}(wn||(wn={}));var bn,Dn=class extends S{constructor(e,t){super(),this._speakerId=null,this._serverAudioActivityAvailable=!1,this.subscribe(e,Pn.VOLUMES_DETECTED,this._onVolumesDetected.bind(this)),this.subscribe(t,fn.SIGNALLED_SPEAKER_CHANGED,this._onServerSpeakerChanged.bind(this)),this.subscribe(t,fn.SIGNALLED_ACTIVE_PARTICIPANTS,this._onReceivedServerAudioActivity.bind(this)),this.subscribe(t,fn.ACTIVE_PARTICIPANTS_NO_SIGNAL,this._onStoppedReceivingServerAudioActivity.bind(this))}destroy(){this.unsubscribe()}_onVolumesDetected(e){if(this._serverAudioActivityAvailable)return;let t=0,n=null;if(Object.keys(e).forEach((i=>{let r=e[i].smoothed;r>t&&r>be.voiceParams.threshold&&(t=r,n=i)})),n&&n!==this._speakerId){let i=this._speakerId&&e.hasOwnProperty(this._speakerId)?e[this._speakerId].smoothed:0;t>i*be.voiceParams.speakerLevelMultiplier&&(this._speakerId=n,this._triggerEvent(wn.SPEAKER_CHANGED,n))}}_onServerSpeakerChanged(e){this._serverAudioActivityAvailable&&this._triggerEvent(wn.SPEAKER_CHANGED,e)}_onReceivedServerAudioActivity(){this._serverAudioActivityAvailable=!0}_onStoppedReceivingServerAudioActivity(){this._serverAudioActivityAvailable=!1}},Nn=class extends S{constructor(e,t,n){super(),this._states={},this._volumes={},this._participants={},this._connectionTimeout=0,this._volumeTimeout=0,this._transport=e,this._participants=n,this.subscribe(e,fn.STATE_CHANGED,this._onTransportStateChanged.bind(this)),this.subscribe(t,Pn.VOLUMES_DETECTED,this._onVolumesDetected.bind(this))}destroy(){this.unsubscribe(),this._connectionTimeout&&window.clearTimeout(this._connectionTimeout),this._volumeTimeout&&window.clearTimeout(this._volumeTimeout)}onChangeRemoteMediaSettings(e,t){t.isAudioEnabled||(this._volumes[e]=1),t.isAudioEnabled&&(this._volumes[e]=0)}_onTransportStateChanged(e,t){e.forEach((e=>this._states[e]=t)),t===gn.OPENED&&(this._connectionTimeout||(this._connectionTimeout=window.setTimeout(this._onConnectionTimeout.bind(this),be.specListenerParams.connectionTimeout)),this._volumeTimeout||(this._volumeTimeout=window.setTimeout(this._onVolumeTimeout.bind(this),be.specListenerParams.volumeTimeout))),t===gn.FAILED&&this._connectionTimeout&&(Ge.warn("Transport failed, send callSpecError"),Rt.log(ee.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`))}_onVolumesDetected(e){Object.keys(e).forEach((t=>{this._volumes[t]=Math.max(e[t].real,this._volumes[t]||0)}))}_onConnectionTimeout(){let e=e=>e!==gn.CONNECTED;(()=>Object.values(this._states).filter(e).length>0)()&&(Ge.warn("There is not connected transport, send callSpecError"),Rt.log(ee.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`)),this._connectionTimeout=0}_onVolumeTimeout(){let e=[];Object.keys(this._volumes).forEach((t=>{if(this._volumes[t]>0)return;let n="UNKNOWN",i=this._participants[t];i&&i.platform&&(n=i.platform),e.indexOf(n)<0&&(e.push(n),Rt.log(ee.CALL_SPEC_ERROR,`${this._transport.getTopology()}_VOLUME_TIMEOUT_${n}`))})),e.length&&Ge.warn("There is silent participant, send callSpecError"),this._volumeTimeout=0}};!function(e){e.IDLE="IDLE",e.PROCESSING="PROCESSING",e.ACTIVE="ACTIVE",e.CLOSE="CLOSE"}(bn||(bn={}));var kn=class extends S{constructor(e,t,n){super(),this._mediaSource=null,this._conversation=null,this._state=bn.IDLE,this._participantState=W.CALLED,this._participants={},this._transport=null,this._debugInfo=null,this._volumesDetector=null,this._speakerDetector=null,this._localVolumeDetector=null,this._specListener=null,this._activeSpeakerId=null,this._lastSignalledActiveSpeakerId=null,this._serverSettings={camera:null,screenSharing:null},this._signalingServerSettings={camera:null,screenSharing:null},this._lastStalled={},this._remoteAllStalled=!1,this._audioFix=null,this._streamByStreamId=new Map,this._streamIdByStreamDescription=new Map,this._streamWaitTimerByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map,Rt.create(e,n),this._api=e,this._signaling=t,this._onUnload=()=>{this._conversation&&this._api&&this._api.hangupConversation(this._conversation.id),Rt.destroy()},window.addEventListener("unload",this._onUnload),this._audioOutput=new class{constructor(){this._output=null,this._volume=1,this._features={setSinkId:!!Audio.prototype.setSinkId}}add(e){this.destroy(),this._output={},this._output.audioTrack=e,this._initAudioElement()}remove(e){!this._output||this._output.audioTrack!==e||this.destroy()}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this._output&&this._output.audioElement&&(this._output.audioElement.volume=this._volume)}_initAudioElement(){var e;if(!(null==(e=this._output)?void 0:e.audioTrack))return;let t=new Audio;t.muted=!1,t.volume=this._volume,t.preload="auto";let n=()=>{Ge.warn("Error on play audio"),Ue.onAutoplayError()},i=e=>{t.srcObject=new MediaStream([e]),t.load();let i=t.play();i?i.catch(n):n()},r=()=>{var e;Ge.debug("Recover audio playback");let t=null==(e=this._output)?void 0:e.audioTrack;t?i(t):Ge.warn("Broken audio track")};t.onpause=r,t.onstalled=r,t.onerror=r,i(this._output.audioTrack),this._output.audioElement=t}_stopAudioElement(){var e,t,n;(null==(e=this._output)?void 0:e.audioElement)&&(this._output.audioElement.pause(),this._output.audioElement.srcObject=null),null==(n=null==(t=this._output)?void 0:t.audioTrack)||n.stop()}destroy(){!this._output||(this._stopAudioElement(),this._output=null)}changeOutput(){return f(this,null,(function*(){var e,t,n;try{if(!this._features.setSinkId)throw new Error('Feature "setSinkId" is not supported');if(!(null==(e=this._output)?void 0:e.audioElement))throw new Error("Audio Element is not initialized");let i=vt.getSavedOutput();i&&(yield null==(n=(t=this._output.audioElement).setSinkId)?void 0:n.call(t,i.deviceId))}catch(e){throw Rt.log(ee.ERROR,"change_output"),Ge.error("Output change failed",e),e}}))}},be.videoTracksCount>0&&(this._cooldownQueueCleanupTimer=window.setInterval(this._cleanupCooldownQueue.bind(this),1e3))}static current(){return kn._current}static hangupAfterInit(){kn._activationMutex&&!kn._current&&(kn._delayedHangup=!0)}static id(){var e,t;return(null==(t=null==(e=kn._current)?void 0:e._conversation)?void 0:t.id)||null}onStart(e,t,n,i="",r=!1,a=!1){return f(this,null,(function*(){if(kn._activationMutex)throw Rt.log(ee.ERROR,"startCall"),Ge.warn("Conversation: there is already running activation"),new Ct(x.FAILED);kn._activationMutex=!0;try{this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(n);let s=this._mediaSource.getMediaSettings();t===I.CHAT||e.length>1?this._logWithMediaSettings(ee.OUTGOING_MULTIPARTY_CALL,s):this._logWithMediaSettings(ee.OUTGOING_CALL,s);let o=yield this._startConversation(e,t,y.OUTGOING,n,i,r,a);if(!this._conversation)throw new Ct(x.UNKNOWN_ERROR);if(this._participantState=W.ACCEPTED,this._signaling.changeMediaSettings(s),yield this._registerParticipants(o.conversation.participants),this._processConnectionData(o),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),kn._delayedHangup)throw new Ct(x.CANCELED);Ge.debug("Outgoing call",{opponentIds:e,opponentType:t,mediaOptions:n});let c,d=Object.values(this._participants);return be.batchParticipantsOnStart&&(c=bt.mapSharedParticipants(d)),Ue.onLocalStream(this._mediaSource.getStream(),this._mediaSource.getMediaSettings()),Ue.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,c),Ue.onLocalStatus(Re.WAITING),this._toggleJoinAvailability(),this._changeFeatureSet(),this._changeNeedRate(),kn._current=this,this._conversation.concurrent?yield this._acceptConcurrent():be.batchParticipantsOnStart||this._setParticipantsStatus(d,Re.WAITING),this._conversation}catch(e){throw this._close(e,"Unable to start conversation"),e}finally{kn._activationMutex=!1}}))}onJoin(e){return f(this,null,(function*(){if(kn._activationMutex)throw Rt.log(ee.ERROR,"joinCall"),Ge.warn("Conversation: there is already running activation"),new Ct(x.FAILED);kn._activationMutex=!0,this._state=bn.PROCESSING;try{this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(e.mediaOptions);let t=this._mediaSource.getMediaSettings();this._logWithMediaSettings(ee.JOIN_CONVERSATION,t);let n=yield this._joinConversation(e);if(!this._conversation)throw new Ct(x.UNKNOWN_ERROR);return Ue.onLocalStream(this._mediaSource.getStream(),t),this._conversation.waitingHall?(Ge.log("In waiting hall"),kn._current=this,kn._activationMutex=!1,this._signaling.readyToSend(),Ue.onLocalStatus(Re.WAITING_HALL),this._conversation):this._onJoinPart2(n)}catch(e){throw kn._activationMutex=!1,this._close(e,"Unable to join conversation"),e}}))}_onJoinPart2(e){return f(this,null,(function*(){Ge.debug("Join conversation part 2"),kn._activationMutex=!0;try{if(this._participantState=W.ACCEPTED,!this._conversation||!this._mediaSource)throw new Ct(x.UNKNOWN_ERROR);if(this._signaling.changeMediaSettings(this._mediaSource.getMediaSettings()),yield this._registerParticipants(e.conversation.participants),this._processConnectionData(e),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),kn._delayedHangup)throw new Ct(x.CANCELED);let t,n=Object.values(this._participants);return be.batchParticipantsOnStart&&(t=bt.mapSharedParticipants(n)),Ue.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,t),Ue.onLocalStatus(Re.WAITING),this._toggleJoinAvailability(),this._changeNeedRate(),this._state=bn.ACTIVE,this._changeFeatureSet(),kn._current=this,be.batchParticipantsOnStart||this._setParticipantsStatus(n,Re.WAITING),this._openTransport(n,!1),this._conversation}catch(e){throw this._close(e,"Unable to join conversation"),e}finally{kn._activationMutex=!1}}))}onPush(e){return f(this,arguments,(function*(e,t=de.USER,n){if(kn._activationMutex)throw Ge.warn("Conversation: there is already running activation"),new Ct(x.REJECTED);kn._activationMutex=!0;try{let i=yield this._prepareConversation(e,t,n);if(this._mediaSource=this._createMediaSource(),!this._conversation)throw new Ct(x.UNKNOWN_ERROR);if(!i.conversation.participants.find((e=>{var t;return e.state===W.CALLED&&e.id===(null==(t=this._conversation)?void 0:t.userId)})))throw Ge.log("Push rejected (there is an active call)"),Rt.log(ee.PUSH,"rejected"),new Ct(x.REJECTED);if(yield this._registerParticipants(i.conversation.participants),this._processConnectionData(i),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),Rt.log(ee.PUSH,"accepted"),kn._current=this,kn._delayedHangup)throw new Ct(x.CANCELED);kn._activationMutex=!1}catch(e){throw kn._activationMutex=!1,this._close(e,"Unable to handle inbound call push"),e}}))}_isInWaitingHall(e){if(!e.conversation||(e.conversation.options||[]).indexOf(N.WAITING_HALL)<0)return!1;let t=(e.conversation.participants||[]).find((t=>bt.comparePeerId(t.peerId,e.peerId)));return t&&t.restricted||!1}_acceptConcurrent(){return f(this,null,(function*(){if(!this._mediaSource||!this._conversation)throw new Ct(x.UNKNOWN_ERROR);this._state=bn.PROCESSING;let e=this._mediaSource.getMediaSettings();this._logWithMediaSettings(ee.ACCEPT_CONCURRENT,e),Ge.debug("Concurrent call",{conversationId:this._conversation.id});try{yield this._signaling.acceptCall(this._mediaSource.getMediaSettings()),Ue.onCallAccepted(),this._state=bn.ACTIVE,this._participantState=W.ACCEPTED,this._changeFeatureSet(),this._openTransport(Object.values(this._participants),!0)}catch(e){this._close(e,"Unable to accept concurrent call")}}))}accept(e){return f(this,null,(function*(){if(this._state!==bn.IDLE)throw Rt.log(ee.ERROR,"acceptIncoming"),Ge.error("Unable to accept a call - invalid state"),new Error("Unable to accept a call - invalid state");if(!this._mediaSource||!this._conversation)throw new Ct(x.UNKNOWN_ERROR);this._state=bn.PROCESSING,Ge.debug("Accept incoming call",e);try{yield this._mediaSource.request(e);let t=this._mediaSource.getMediaSettings();this._logWithMediaSettings(ee.ACCEPT_INCOMING,t),this._signaling.changeMediaSettings(t),yield this._signaling.acceptCall(t),this._participantState=W.ACCEPTED;let n,i=Object.values(this._participants);return be.batchParticipantsOnStart&&(n=bt.mapSharedParticipants(i)),Ue.onCallAccepted(),Ue.onLocalStream(this._mediaSource.getStream(),t),Ue.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,n),Ue.onLocalStatus(Re.WAITING),this._toggleJoinAvailability(),this._changeNeedRate(),(this._conversation.muteState===j.MUTE||this._conversation.muteState===j.MUTE_PERMANENT)&&(yield this._processMuteState()),this._state=bn.ACTIVE,this._changeFeatureSet(),be.batchParticipantsOnStart||this._setParticipantsStatus(i,Re.WAITING),this._openTransport(i,!0),this._conversation}catch(e){throw this._close(e,"Unable to accept call"),e}}))}decline(){return f(this,null,(function*(){var e;if(this._state!==bn.IDLE)throw Rt.log(ee.ERROR,"declineIncoming"),Ge.error("Unable to decline a call - invalid state"),new Error("Unable to decline a call - invalid state");this._state=bn.PROCESSING,Ge.debug("Decline incoming call"),this._logWithMediaSettings(ee.DECLINE_INCOMING,null==(e=this._mediaSource)?void 0:e.getMediaSettings()),this._participantState=W.HUNGUP,this._signaling.ready&&(yield this._signaling.hangup(x.REJECTED)),this._close(new Ct(x.REJECTED))}))}hangup(){return f(this,null,(function*(){Ge.debug("Hangup");let e=this._state===bn.ACTIVE?x.HUNGUP:x.CANCELED;Rt.log(ee.HANGUP,e),this._signaling.ready?(yield this._signaling.hangup(e),this._close(new Ct(e))):Ue.onHangup(new Ct(x.HUNGUP),this._conversation&&this._conversation.id)}))}addParticipant(e,t){return f(this,null,(function*(){if(!this._signaling.ready)return void this._close(new Ct(x.UNKNOWN_ERROR),"Unable to add participant");let n=yield this._signaling.addParticipant(e,t),i=null;"error"===n.type&&(i="call-unfeasible"===n.error?n.status:x.UNKNOWN_ERROR),yield this._onAddParticipant(e,i)}))}removeParticipant(e,t=!1){return f(this,null,(function*(){this._signaling.ready&&(yield this._signaling.removeParticipant(e,t),this._onRemoveParticipant(e))}))}setVolume(e){this._audioOutput.volume=e}updateStatisticsInterval(){this._transport&&this._transport.updateStatisticsInterval()}_openTransport(e,t){if(!this._transport)return;let n=[];for(let i of e)(i.state===W.CALLED||i.state===W.ACCEPTED)&&this._transport&&!this._transport.isAllocated(i.id)&&this._transport.allocate(i.id,t),this._transport&&i.state===W.ACCEPTED&&n.push(i.id);n.length&&this._transport.open(n)}_close(e,t){t&&Ge.error(t,e),Ge.debug("Close conversation",e),e.error?this._signaling.ready&&this._signaling.hangup(x.FAILED):Rt.log(ee.ERROR,e.hangup),kn._activationMutex=!1;let n=this._conversation&&this._conversation.id;return-1!==[x.CANCELED,x.NOT_FRIENDS,x.CALLEE_IS_OFFLINE,x.CALLER_IS_BLOCKED].indexOf(e.hangup)||e.hangup===x.REJECTED&&!e.remote?(Ue.onHangup(e,n),void this.destroy()):(e.hangup!==x.HUNGUP||e.remote&&this._participantState!==W.CALLED)&&(e.hangup!==x.MISSED||e.remote)?e.hangup===x.SOCKET_CLOSED&&kn._current&&!this._conversation?(this._cleanupSignaling(),void this._cleanupMediaSource()):e.hangup!==x.BUSY||e.remote?(this._state=bn.CLOSE,this._participantState=W.HUNGUP,this._changeFeatureSet(),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),Rt.destroy(),this._conversation=null,kn._current=null,kn._delayedHangup=!1,void Ue.onHangup(e||new Ct(x.UNKNOWN_ERROR),n)):(this._cleanupSignaling(),void this._cleanupMediaSource()):(Ue.onHangup(e,n),void this.destroy())}destroy(){let e=this._conversation&&this._conversation.id;Ge.debug("Destroy conversation",{conversationId:e}),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),this._cleanupListeners(),Rt.destroy(),this._conversation=null,kn._current=null,kn._delayedHangup=!1}_getConversationParams(){return f(this,null,(function*(){let e=yield this._api.getConversationParams();Ge.debug("Api.getConversationParams",e);let t=[],{turn_server:n,stun_server:i}=e;if(i&&t.push(i),n){let e=n.urls.filter(((e,t,n)=>n.indexOf(e)===t));e.forEach((t=>e.push(`${t}?transport=tcp`))),t.push({urls:e,username:n.username,credential:n.credential})}be.iceServers=t,be.wssBase=e.endpoint,be.wssToken=e.token,e.client_type&&(be.clientType=e.client_type)}))}_startConversation(e,t,n,i,r="",a=!1,s=!1){return f(this,null,(function*(){let o=bt.uuid();Ge.debug("Conversation: start",{conversationId:o,opponentIds:e,opponentType:t,direction:n});let c=i.includes(V.VIDEO),d=yield this._api.startConversation(o,e,t,c,r,a,s);Ge.debug("Api.startConversation",d),yield this._getConversationParams();let l=yield this._connectSignaling(K.START,d);return yield this._setConversation(d,l,n),l}))}_joinConversation(e){return f(this,null,(function*(){let{conversationId:t,mediaOptions:n,chatId:i,joinLink:r}=e;Ge.debug("Conversation: join",{conversationId:t,joinLink:r});let a,s=n.includes(V.VIDEO);if(t)a=yield this._api.joinConversation(t,s,i);else{if(!r)throw new Ct(x.UNKNOWN_ERROR);a=yield this._api.joinConversationByLink(r,s)}Ge.debug("Api.joinConversation",a),yield this._getConversationParams();let o=yield this._connectSignaling(K.JOIN,a);return yield this._setConversation(a,o,y.JOINING),o}))}_prepareConversation(e){return f(this,arguments,(function*(e,t=de.USER,n){Ge.debug("Conversation: push",{conversationId:e,type:t,peerId:n}),yield this._getConversationParams();let i=this._api.getUserId();if(!i)throw new Ct(x.UNKNOWN_ERROR);let r={id:e,peerId:n,endpoint:`${be.wssBase}?userId=${i}&entityType=${t}&conversationId=${e}&token=${be.wssToken}`,is_concurrent:!1,p2p_forbidden:!1},a=yield this._connectSignaling(K.ACCEPT,r);return!kn._current||kn._current._participantState!==W.ACCEPTED&&kn._current._participantState!==W.CALLED?(kn._current&&(kn._current.destroy(),kn._current=null),yield this._setConversation(r,a,y.INCOMING,t),a):(Ge.log("Push rejected (busy)"),Rt.log(ee.PUSH,"busy"),this._signaling.ready&&this._signaling.hangup(x.BUSY),Promise.reject({hangup:x.BUSY}))}))}_createParticipant(e){return f(this,null,(function*(){let t=Object.assign({id:null,externalId:null,mediaSettings:Et(),participantState:{},state:W.CALLED,status:be.batchParticipantsOnStart?Re.WAITING:null,remoteStream:null,mediaSource:null,platform:null,clientType:null,roles:[],networkRating:1,lastRequestedLayouts:{}},e);return e.externalId?this._api.cacheExternalId(t.id,e.externalId):t.externalId=yield this._getUserId(t.id),t}))}_getUserId(e){return f(this,null,(function*(){try{return yield this._api.userId(e)}catch(e){throw this._close(new Ct(x.NETWORK_ERROR),e),e}}))}_setConversation(e,t,n){return f(this,arguments,(function*(e,t,n,i=de.USER){let r=t.conversation.participants.map((e=>e.id));yield this._api.prepareUserIds(r);let a=this._api.getUserId();if(!a){let e=(t.conversation.participants||[]).find((e=>bt.comparePeerId(e.peerId,t.peerId)));if(!e)throw new Ct(x.UNKNOWN_ERROR);a=Number(e.id),e.idType&&(i=e.idType),this._api.setUserId(a)}let s=bt.composeId(a,i),o=yield this._getUserId(s);this._conversation={userId:a,compositeUserId:s,externalId:o,acceptTime:t.conversation.acceptTime,features:t.conversation.features||[],id:t.conversation.id||e.id,participantsLimit:t.conversation.participantsLimit||30,topology:t.conversation.topology||Sn.DIRECT,direction:n,concurrent:t.isConcurrent||e.is_concurrent||!1,needRate:!1,chatId:t.conversation.multichatId,roles:[],recordInfo:null,joinLink:e.join_link,pinnedParticipantId:null,mediaModifiers:t.mediaModifiers,options:[],muteState:j.UNMUTE,muteOptions:[],networkRating:1,waitingHall:this._isInWaitingHall(t)},this._signaling.setConversationId(e.id),e.p2p_forbidden&&(be.forceRelayPolicy=e.p2p_forbidden),Rt.log(ee.RELAY_POLICY,be.forceRelayPolicy?"1":"0"),this._changeFeatureSet(),this._logDevices()}))}_updateConversation(e){if(!this._conversation)throw new Ct(x.UNKNOWN_ERROR);this._conversation.acceptTime=e.conversation.acceptTime,this._conversation.features=e.conversation.features||[],this._conversation.participantsLimit=e.conversation.participantsLimit||30,this._conversation.topology=e.conversation.topology||Sn.DIRECT,this._conversation.concurrent=e.isConcurrent||!1,this._conversation.chatId=e.conversation.multichatId,this._conversation.mediaModifiers=e.mediaModifiers,this._conversation.waitingHall=!1}_createMediaSource(){let e=new Pt;return this.subscribe(e,Tt.SOURCE_CHANGED,this._onLocalMediaStreamChanged.bind(this)),this.subscribe(e,Tt.SCREEN_STATUS,this._onScreenSharingStatus.bind(this)),this._audioFix=new xt(e),e}_connectSignaling(e,t){return f(this,null,(function*(){return this._signaling.setEndpoint(t.endpoint),this.subscribe(this._signaling,Y.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._signaling,Y.FAILED,this._onSignalingFailed.bind(this)),this.subscribe(this._signaling,Y.RECONNECT,this._onSignalingReconnect.bind(this)),this._signaling.connect(e,t)}))}_registerParticipants(e){return f(this,null,(function*(){if(this._conversation)for(let t of e){let e=bt.composeParticipantId(t);e!==this._conversation.compositeUserId?t.state!==W.HUNGUP&&t.state!==W.REJECTED?(this._participants[e]=yield this._createParticipant({id:e,externalId:t.externalId&&wt.fromSignaling(t.externalId),mediaSettings:Et(t.mediaSettings),participantState:bt.mapParticipantState(t),state:t.state,roles:t.roles||[]}),t.roles&&t.roles.length&&(Ge.debug(`Roles for participant [${e}] changed: ${t.roles}`),Ue.onRolesChanged(this._participants[e].externalId,t.roles))):this._participants[t.id]&&this._removeParticipant(this._participants[t.id],x.HUNGUP):(this._conversation.roles=t.roles||[],this._conversation.roles.length&&(Ge.debug(`Local roles changed: ${t.roles}`),Ue.onLocalRolesChanged(this._conversation.roles)))}}))}_processConnectionData(e){e.muteOptions&&(e.muteState===j.MUTE||e.muteState===j.MUTE_PERMANENT)&&this._onMuteParticipant(e.muteOptions,!1,e.muteState),e.conversation.pinnedParticipantId&&this._onPinParticipant(e.conversation.pinnedParticipantId),this._onRecordInfo(e.conversation.recordInfo),this._onOptionsChanged(e.conversation.options),e.chatRoom&&e.chatRoom.totalCount&&this._onChatRoomUpdated(A.ATTENDEE,e.chatRoom.totalCount,e.chatRoom.firstParticipants)}_allocateTransport(){if(!this._conversation||!this._mediaSource)return;this._transport=new An(this._conversation.topology,this._signaling,this._mediaSource,this._serverSettings),this._debugInfo=new Gt,this.subscribe(this._transport,fn.STATE_CHANGED,this._onTransportStateChanged.bind(this)),this.subscribe(this._transport,fn.LOCAL_STATE_CHANGED,this._onTransportLocalStateChanged.bind(this)),this.subscribe(this._transport,fn.REMOTE_TRACK_ADDED,this._onRemoteTrackAdded.bind(this)),this.subscribe(this._transport,fn.REMOTE_TRACK_REMOVED,this._onRemoteTrackRemoved.bind(this)),this.subscribe(this._transport,fn.REMOTE_ALL_STALL,this._onRemoteAllStall.bind(this)),this.subscribe(this._transport,fn.REMOTE_DATA_STATS,this._onRemoteDataStats.bind(this)),this.subscribe(this._transport,fn.SIGNALLED_STALLED_PARTICIPANTS,this._onRemoteSignalledStall.bind(this)),this.subscribe(this._transport,fn.ACTIVE_PARTICIPANTS_NO_SIGNAL,this._onRemoteActivityNoSignal.bind(this)),this.subscribe(this._transport,fn.TOPOLOGY_CHANGED,this._onTopologyChanged.bind(this)),this.subscribe(this._transport,fn.NETWORK_STATUS,this._onNetworkStatus.bind(this)),this.subscribe(this._transport,fn.REMOTE_STREAM_SECOND,this._onRemoteStreamSecond.bind(this)),this.subscribe(this._transport,fn.PEER_CONNECTION_CLOSED,this._onPeerConnectionClosed.bind(this));let e=this._conversation.direction===y.OUTGOING&&!this._conversation.concurrent;for(let t of Object.values(this._participants))(t.state===W.ACCEPTED||t.state===W.CALLED)&&this._transport.allocate(t.id,e)}_createSpeakerDetector(){this._transport&&(this._volumesDetector=new On(this._transport),this.subscribe(this._volumesDetector,Pn.VOLUMES_DETECTED,this._onVolumesDetected.bind(this)),this._speakerDetector=new Dn(this._volumesDetector,this._transport),this.subscribe(this._speakerDetector,wn.SPEAKER_CHANGED,this._onSpeakerChanged.bind(this)),this._localVolumeDetector=new Ft(this._mediaSource))}_createSpecListener(){this._transport&&this._volumesDetector&&(this._specListener=new Nn(this._transport,this._volumesDetector,this._participants))}_logDevices(){let e=vt.getCameras().length,t=vt.getMicrophones().length;Ge.debug("Cameras: "+e+(vt.hasCameraPermission()?"✔":"✖")+", Microphones: "+t+(vt.hasMicrophonePermission()?"✔":"✖")),Rt.log(ee.DEVICES,`${e}_${t}`)}_logWithMediaSettings(e,t){Rt.log(e,[(null==t?void 0:t.isAudioEnabled)&&"audio",(null==t?void 0:t.isVideoEnabled)&&"video"].filter(Boolean).join("_"))}_removeParticipant(e,t){var n;e.state===W.CALLED||e.state===W.ACCEPTED||this._state===bn.CLOSE||!this._participants[e.id]||(t===x.HUNGUP?this._setParticipantsStatus([e],Re.HANGUP):this._setParticipantsStatus([e],Re.ERROR,t),null==(n=e.mediaSource)||n.disconnect(),this._conversation&&this._conversation.pinnedParticipantId===e.id&&(this._conversation.pinnedParticipantId=null),this.updateDisplayLayout([{uid:e.externalId,mediaType:Ot.CAMERA,stopStream:!0}]),delete this._participants[e.id],Ue.onRemoteRemoved(e.externalId))}_cleanupListeners(){this.unsubscribe(),window.removeEventListener("unload",this._onUnload)}_cleanupMediaSource(){this._mediaSource&&(this._mediaSource.destroy(),this._mediaSource=null)}_cleanupParticipants(){Object.values(this._participants).forEach((e=>{var t,n,i;null==(t=e.remoteStream)||t.getTracks().forEach((e=>e.stop())),null==(n=e.secondStream)||n.getTracks().forEach((e=>e.stop())),null==(i=e.mediaSource)||i.disconnect()})),this._participants={},this._audioOutput&&this._audioOutput.destroy()}_cleanupParticipantAgnosticStreams(){Ge.debug("cleaning up participant-agnostic streams"),this._streamByStreamId.forEach((e=>{e.getTracks().forEach((e=>{e.stop()}))})),this._streamByStreamId=new Map,this._streamWaitTimerByStreamDescription.forEach((e=>{window.clearTimeout(e)})),this._streamWaitTimerByStreamDescription=new Map,this._streamIdByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map,window.clearInterval(this._cooldownQueueCleanupTimer)}_cleanupTransport(){this._transport&&(this._transport.destroy(),this._transport=null),this._debugInfo&&(this._debugInfo=null)}_cleanupSpeakerDetector(){this._speakerDetector&&(this._speakerDetector.destroy(),this._speakerDetector=null),this._volumesDetector&&(this._volumesDetector.destroy(),this._volumesDetector=null),this._localVolumeDetector&&(this._localVolumeDetector.destroy(),this._localVolumeDetector=null)}_cleanupSpecListener(){this._specListener&&(this._specListener.destroy(),this._specListener=null)}_cleanupSignaling(){this._signaling.close(),this._signaling.cleanup()}_onAddParticipant(e,t){return f(this,null,(function*(){Ge.debug(`Add new participant [${e}]`);let n=this._participants[e];!n||n.state!==W.ACCEPTED&&n.state!==W.CALLED?(n||(this._participants[e]=yield this._createParticipant({id:e}),n=this._participants[e]),this._setParticipantsStatus([n],Re.WAITING),t?(n.state=W.HUNGUP,this._removeParticipant(n,t)):this._transport&&(n.state=W.CALLED,this._transport.allocate(n.id,!0),Rt.log(ee.ADD_PARTICIPANT))):Ge.warn(`Participant [${n.id}:${n.state}] is already in conversation`)}))}_onRemoveParticipant(e){Ge.debug(`Remove participant [${e}]`);let t=this._participants[e];t?(this._transport&&this._transport.close(t.id),Rt.log(ee.REMOVE_PARTICIPANT)):Ge.warn(`Participant [${e}] isn't in conversation`)}changeDevice(e){return f(this,null,(function*(){return"audiooutput"===e?this._audioOutput.changeOutput():this._mediaSource?("audioinput"===e&&(this._audioFix=new xt(this._mediaSource)),this._mediaSource.changeDevice(e)):Promise.reject(L.UNKNOWN)}))}toggleScreenCapturing(e){return f(this,null,(function*(){return this._mediaSource?this._mediaSource.toggleScreenCapturing(e):Promise.reject(L.UNKNOWN)}))}setVideoStream(e,t=!1){return f(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setVideoStream(e,t)}))}setAudioStream(e){return f(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setAudioStream(e)}))}toggleLocalVideo(e){return f(this,null,(function*(){if(this._mediaSource)return Rt.log(ee.MEDIA_STATUS,e?"video_1":"video_0"),this._mediaSource.toggleVideo(e)}))}toggleLocalAudio(e){return f(this,null,(function*(){if(this._mediaSource)return Rt.log(ee.MEDIA_STATUS,e?"audio_1":"audio_0"),this._mediaSource.toggleAudio(e)}))}changePriorities(e){return f(this,null,(function*(){if(e.length<2||!this._signaling.ready)return;let t={},n={};for(let t of e){let e="object"==typeof t.uid?t.uid:wt.fromId(t.uid);n[wt.toString(e)]=t.priority}for(let e of Object.values(this._participants)){let i=wt.toString(e.externalId);n.hasOwnProperty(i)&&(t[e.id]=n[i])}yield this._signaling.changePriorities(t)}))}changeParticipantState(e){return f(this,null,(function*(){for(let[t,n]of Object.entries(e))if(t.length>5||n.length>5)throw new Error("key/value max length is 5 chars, mappings with empty values (null or empty string) are discarded");yield this._signaling.changeParticipantState(e)}))}updateDisplayLayout(e){return f(this,null,(function*(){if(e.length<1||!this._signaling.ready)return;Ge.log(`Update display layout [${this._signaling.getNextCommandSequenceNumber()}]`,e);let t={};for(let n of e){let e="object"==typeof n.uid?n.uid:wt.fromId(n.uid),i=wt.toString(e),r=this._api.getCachedOkIdByExternalId(e);if(!r){Ge.log(`Unknown participant external ID ${i}`);continue}let a=Dt({participantId:r,mediaType:n.mediaType,streamName:n.streamName}),s=this._participants[r];s&&(s.lastRequestedLayouts[a]=n),kn._isStopStreaming(n)?this._streamIdByStreamDescription.has(a)&&!this._cooldownTimestampByStreamDescription.has(a)&&this._cooldownTimestampByStreamDescription.set(a,Date.now()):(this._cooldownTimestampByStreamDescription.delete(a),!this._streamIdByStreamDescription.has(a)&&be.videoTracksCount>0&&this._streamIdByStreamDescription.set(a,null),t[a]=kn._layoutToString(n))}let n=this._cooldownTimestampByStreamDescription.keys();for(;this._streamIdByStreamDescription.size>be.videoTracksCount;){let e=n.next();if(e.done){Ge.error("Cannot accommodate all streaming requests: tracks available "+be.videoTracksCount+"; requested streams: "+Array.from(this._streamIdByStreamDescription.keys()));break}this._stopStreaming(e.value),t[e.value]=kn._layoutToString({stopStream:!0})}yield this._sendUpdateDisplayLayout(t)}))}_stopStreaming(e){if(this._cooldownTimestampByStreamDescription.delete(e),this._sequenceNumberByStreamDescription.set(e,this._signaling.getNextCommandSequenceNumber()),this._streamWaitTimerByStreamDescription.has(e)&&(Ge.log("Client asked to stop streaming before stream became available",e),window.clearTimeout(this._streamWaitTimerByStreamDescription.get(e)),this._streamWaitTimerByStreamDescription.delete(e)),this._streamIdByStreamDescription.get(e)){let t=Nt(e),n=this._participants[t.participantId];n?(!t.streamName||t.mediaType!==Ot.STREAM&&t.mediaType!==Ot.SCREEN?Ue.onRemoteStream(n.externalId,null):Ue.onRemoteLive(n.externalId,t.streamName,null),Rt.log(ee.PAT_DEALLOCATED)):Ge.log(`Cannot find participant to stop streaming: ${t.participantId}`)}this._streamIdByStreamDescription.delete(e)}_sendUpdateDisplayLayout(e){return f(this,null,(function*(){if(0===Object.keys(e).length)return;let t=yield this._signaling.updateDisplayLayout(e);if(!t)return;let n=[];for(let[e,i]of Object.entries(t.errorCodeByParticipantId||{})){let t=Nt(e),r=this._participants[t.participantId];if(r){let e;"number"!=typeof i?(Ge.warn(`Unexpected error code ${i} received for participant ${t.participantId}`),e=re.UNKNOWN_ERROR):e=ae(i),n.push({externalId:r.externalId,errorReason:e})}}if(n&&n.length)throw new Gn("Could not allocate one or more participants",n)}))}_cleanupCooldownQueue(){let e={},t=this._cooldownTimestampByStreamDescription.entries();for(;;){let n=t.next();if(n.done)break;let i=n.value;if(i[1]+12e4>Date.now())break;let r=i[0];this._stopStreaming(r),e[r]=kn._layoutToString({stopStream:!0})}this._sendUpdateDisplayLayout(e)}static _isStopStreaming(e){return e.stopStream}static _layoutToString(e){if(kn._isStopStreaming(e))return"ss";let t="";return void 0!==e.priority&&(t+="p="+e.priority),void 0!==e.width&&void 0!==e.height&&(""!==t&&(t+=":"),t+="sz="+Math.round(e.width)+"x"+Math.round(e.height)),void 0!==e.fit&&(""!==t&&(t+=":"),t+="fit="+e.fit),e.keyFrame&&(""!==t&&(t+=":"),t+="kf"),t}_onParticipantSourcesUpdate(e){if(this._conversation){Ge.log("Received participant sources update notification",e);for(let t of e)this._waitForStreamIfNeeded(t)}}_onParticipantPromoted(e){return f(this,null,(function*(){Ge.log("Promoted in waiting hall",!e.demote),e.demote?(Ge.log("Kicked from waiting hall"),this._close(new Ct(x.REMOVED))):(this._updateConversation(e),yield this._onJoinPart2(e))}))}_onChatRoomUpdated(e){return f(this,arguments,(function*(e,t=0,n=[]){Ge.log(`Chat room updated: ${e}`);let i=[],r=[];n.length&&(n.forEach((e=>{if(e.externalId){let t=wt.fromSignaling(e.externalId);i.push(t),this._api.cacheExternalId(e.id.id,t)}else r.push(bt.decomposeId(e.id.id).id)})),r.length&&!i.length&&(i=yield this._api.getExternalIdsByOkIds(r))),Ue.onChatRoomUpdated(e,t,i)}))}_waitForStreamIfNeeded(e){var t,n;let i=this._matchStreamDescription(e.participantStreamDescription);if(!i||be.producerScreenTrack&&i.mediaType===Ot.SCREEN)return;let r=Dt(i),a=this._sequenceNumberByStreamDescription.get(r);if(a&&a>e.sequenceNumber)return Ge.warn(`Participant ${i.participantId} received outdated PAT response: sequence number ${e.sequenceNumber}; last sent sequence number for given participant is ${a}`),void Rt.log(ee.PAT_OUTDATED_RESPONSE);let s=e.streamId,o=e.rtpTimestamp?this._getWaitingTime(s,e.rtpTimestamp):0;if(o<=0){this._streamWaitTimerByStreamDescription.delete(r);let a=i.participantId,o=this._participants[a];if(!o)return Rt.log(ee.PAT_ERROR,"participantMissing"),void Ge.error(`Could not find participant by ID: ${a}`);let c=this._streamByStreamId.get(s);if(!c)return Rt.log(ee.PAT_ERROR,"streamNotFound"),void Ge.error(`Could not find stream by ID: ${s}`);Rt.log(ee.PAT_ALLOCATED),this._streamIdByStreamDescription.set(r,s);let d=null==(t=e.participantStreamDescription)?void 0:t.mediaType;if(d===Ot.STREAM||d===Ot.MOVIE)(null==(n=e.participantStreamDescription)?void 0:n.streamName)&&Ue.onRemoteLive(o.externalId,e.participantStreamDescription.streamName,c);else{let e=(be.producerScreenTrack?null:o.secondStream)||c;Ue.onRemoteStream(o.externalId,e)}}else{Ge.debug(`Waiting for ${o} until stream ${s} for ${r} is switched`);let t=window.setTimeout(this._waitForStreamIfNeeded.bind(this,e),o);this._streamWaitTimerByStreamDescription.set(r,t)}}_matchStreamDescription(e){if(!e)return null;if(this._streamIdByStreamDescription.has(Dt(e)))return e;let t=e.participantId;if(e.mediaType){let e={participantId:t,mediaType:null};if(this._streamIdByStreamDescription.has(Dt(e)))return e}else{let e={participantId:t,mediaType:Ot.CAMERA};if(this._streamIdByStreamDescription.has(Dt(e)))return e;let n={participantId:t,mediaType:Ot.SCREEN};if(this._streamIdByStreamDescription.has(Dt(n)))return n}return Ge.error("Received unrequested allocation",e),null}_getWaitingTime(e,t){if(this._transport)return this._transport.getStreamWaitingTimeMs(e,t);throw new Error("transport is not initialized")}_isCallAdmin(){return!!this._conversation&&bt.includesOneOf(this._conversation.roles,[oe.ADMIN,oe.CREATOR])}_checkAdminRole(){if(this._conversation&&!bt.includesOneOf(this._conversation.roles,[oe.ADMIN,oe.CREATOR]))throw new Error("You don't have the required permission")}grantRoles(e,t,n){return f(this,null,(function*(){this._checkAdminRole(),yield this._signaling.grantRoles(e,t,n)}))}switchParticipantDevice(e=null,t,n,i=!1){return f(this,null,(function*(){this._checkAdminRole(),yield this._signaling.muteParticipant(e,t,n,i)}))}pinParticipant(e,t){return f(this,null,(function*(){this._checkAdminRole(),yield this._signaling.pinParticipant(e,t)}))}updateMediaModifiers(e){return f(this,null,(function*(){this._signaling.ready&&this._conversation&&(this._conversation.mediaModifiers=e,yield this._signaling.updateMediaModifiers(e))}))}changeOptions(e){return f(this,null,(function*(){if(this._signaling.ready&&this._conversation){this._checkAdminRole(),yield this._signaling.changeOptions(e);let t=function(e,t){let n=new Set(e);for(let[e,i]of Object.entries(t))i?n.add(e):n.delete(e);return Array.from(n)}(this._conversation.options,e);this._onOptionsChanged(t)}}))}getWaitingHall(e,t,n){return f(this,null,(function*(){if(!this._signaling)return Promise.reject();let i=null;e&&(i=function(e){try{return JSON.parse(atob(e))}catch(t){Ge.warn("WaitingParticipant: failed convert from string",e,t)}return null}(e));let r=yield this._signaling.getWaitingHall(i,t,n);if(r.error)return Promise.reject(r.message);let a=r.participants||[],s=[],o=[],c=null;return a.length&&(a.forEach((e=>{if(e.externalId){let t=wt.fromSignaling(e.externalId);s.push(t),this._api.cacheExternalId(e.id.id,t)}else o.push(bt.decomposeId(e.id.id).id)})),o.length&&!s.length&&(s=yield this._api.getExternalIdsByOkIds(o)),r.hasMore&&(c=function(e){try{return btoa(JSON.stringify(e))}catch(t){Ge.warn("WaitingParticipant: failed convert to string",e,t)}return null}(a[a.length-1].id))),{participants:s,pageMarker:c,totalCount:r.totalCount||0}}))}promoteParticipant(e,t){return f(this,null,(function*(){this._signaling&&(yield this._signaling.promoteParticipant(e,t))}))}chatMessage(e,t=null){return f(this,null,(function*(){this._signaling.ready&&(yield this._signaling.chatMessage(e,t))}))}chatHistory(e){return f(this,null,(function*(){if(this._signaling.ready){let t=yield this._signaling.chatHistory(e);for(let e=t.messages.length-1;e>=0;e--){let n=t.messages[e];yield this._onChatMessage(n)}}}))}customData(e,t=null){return f(this,null,(function*(){this._signaling.ready&&(yield this._signaling.customData(e,t))}))}createJoinLink(){return f(this,null,(function*(){if(this._conversation){let e=(yield this._api.createJoinLink(this._conversation.id)).join_link;if(e)return this._conversation.joinLink=e,e}return Promise.reject()}))}removeJoinLink(){return f(this,null,(function*(){if(!this._conversation||!(yield this._api.removeJoinLink(this._conversation.id)).success)return Promise.reject();delete this._conversation.joinLink}))}addMovie(e){return f(this,null,(function*(){var t;let n={movieId:e,participantId:null==(t=this._conversation)?void 0:t.compositeUserId},i=yield this._signaling.addMovie(n);if(i.error)throw new Error(i.error);return{movieId:i.movieId,streamType:i.streamType}}))}updateMovie(e,t){return f(this,null,(function*(){var n;let i={movieId:e,participantId:null==(n=this._conversation)?void 0:n.compositeUserId};(t||0===t)&&(i.gain=t);let r=yield this._signaling.updateMovie(i);if(r.error)throw new Error(r.error)}))}removeMovie(e){return f(this,null,(function*(){var t;let n={movieId:e,participantId:null==(t=this._conversation)?void 0:t.compositeUserId},i=yield this._signaling.removeMovie(n);if(i.error)throw new Error(i.error)}))}startStream(e=!1,t=null,n=null,i="DIRECT_LINK",r=null){return f(this,null,(function*(){let a={movieId:n,name:t,privacy:i,groupId:r,streamMovie:!e},s=yield this._signaling.startStream(a);return s.error?Promise.reject(s.message):s}))}stopStream(){return f(this,null,(function*(){let e=yield this._signaling.stopStream();return e.error?Promise.reject():e}))}getStreamInfo(){return f(this,null,(function*(){let e=yield this._signaling.getRecordStatus();return{movieId:e.recordMovieId,preview:e.recordMoviePreviewUrl}}))}setLocalResolution(e,t){return f(this,null,(function*(){var n;if(e<be.videoMinWidth||t<be.videoMinHeight)throw new Error("Sizes received are less than the `videoMinWidth` or `videoMinHeight`");return be.videoMaxWidth=e,be.videoMaxHeight=t,null==(n=this._mediaSource)?void 0:n.setResolution(e,t)}))}videoEffect(e){return f(this,null,(function*(){var t;return null==(t=this._mediaSource)?void 0:t.videoEffect(e)}))}_onLocalMediaStreamChanged(e){return f(this,null,(function*(){var t;!this._conversation||(Ge.debug("Local media stream changed",e.mediaSettings),Ue.onLocalStreamUpdate(e.mediaSettings,e.kind),this._signaling.ready&&!(null==(t=this._conversation)?void 0:t.waitingHall)&&(yield this._signaling.changeMediaSettings(e.mediaSettings)))}))}_onScreenSharingStatus(e){return f(this,null,(function*(){var t;if(Ge.log("Screen sharing changed",e.track,e.mediaSettings),be.consumerScreenTrack){let n=e.track?new MediaStream([e.track]):null;Ue.onScreenStream(n,e.mediaSettings),this._signaling.ready&&!(null==(t=this._conversation)?void 0:t.waitingHall)&&(yield this._signaling.changeMediaSettings(e.mediaSettings))}}))}_changeRemoteMediaSettings(e,t){Ge.debug(`Remote media settings changed [${e}]`,t);let n=this._participants[e];!n||(n.mediaSettings=t,this._state===bn.ACTIVE&&Ue.onRemoteMediaSettings(n.externalId,t),this._specListener&&this._specListener.onChangeRemoteMediaSettings(e,t))}_changeRemoteParticipantState(e,t){Ge.debug(`Remote participant state changed [${e}]`,t);let n=this._participants[e];!n||(n.participantState=t||{},this._state===bn.ACTIVE&&(be.participantStateMapped?Ue.onRemoteParticipantState(n.externalId,n.participantState):Ue.onRemoteParticipantState(n.externalId,bt.mapLegacyParticipantState(n.participantState))))}_onSignalingNotification(e){var t;switch(e.notification){case Q.ACCEPTED_CALL:return this._onAcceptedCall(e);case Q.HUNGUP:return this._onHungup(e);case Q.PARTICIPANT_ADDED:return this._onAddedParticipant(e);case Q.PARTICIPANT_JOINED:return this._onJoinedParticipant(e);case Q.CLOSED_CONVERSATION:return this._onClosedConversation(e);case Q.MEDIA_SETTINGS_CHANGED:return this._onMediaSettingsChanged(e);case Q.PARTICIPANT_STATE_CHANGED:return this._onParticipantStateChanged(e);case Q.RATE_CALL_DATA:return this._onNeedRate();case Q.FEATURE_SET_CHANGED:return this._onFeatureSetChanged(e);case Q.MULTIPARTY_CHAT_CREATED:return this._onMultipartyChatCreated(e);case Q.FORCE_MEDIA_SETTINGS_CHANGE:return this._onForceMediaSettingsChange(e);case Q.SETTINGS_UPDATE:return this._onSettingsUpdate(e);case Q.VIDEO_QUALITY_UPDATE:return this._onVideoQualityUpdate(e);case Q.REGISTERED_PEER:return this._onPeerRegistered(e);case Q.SWITCH_MICRO:return this._onMicSwitched(e);case Q.CHAT_MESSAGE:return this._onChatMessage(e);case Q.CUSTOM_DATA:return this._onCustomData(e);case Q.RECORD_STARTED:return this._onRecordInfo(e.recordInfo);case Q.RECORD_STOPPED:return this._onRecordInfo(null);case Q.ROLES_CHANGED:return this._onRolesChanged(e.participantId,e.roles||[]);case Q.MUTE_PARTICIPANT:let n=e.unmute?(null==(t=this._conversation)?void 0:t.muteState)||j.UNMUTE:e.mutePermanent?j.MUTE_PERMANENT:j.MUTE;return this._onMuteParticipant(e.mediaOptions||[],e.unmute||!1,n);case Q.PIN_PARTICIPANT:return this._onPinParticipant(e.participantId,e.unpin);case Q.OPTIONS_CHANGED:return this._onOptionsChanged(e.options||[]);case Q.PARTICIPANT_SOURCES_UPDATE:return this._onParticipantSourcesUpdate(e.participantUpdateInfos);case Q.PROMOTE_PARTICIPANT:return this._onParticipantPromoted(e);case Q.CHAT_ROOM_UPDATED:return this._onChatRoomUpdated(e.eventType,e.totalCount,e.firstParticipants)}}_onSignalingReconnect(e){return f(this,null,(function*(){if(!this._conversation)return;e.conversation.acceptTime&&(this._conversation.acceptTime=e.conversation.acceptTime),e.conversation.participantsLimit&&(this._conversation.participantsLimit=e.conversation.participantsLimit),e.conversation.features&&(this._conversation.features=e.conversation.features,this._changeFeatureSet()),e.conversation.pinnedParticipantId!==this._conversation.pinnedParticipantId&&(e.conversation.pinnedParticipantId?this._onPinParticipant(e.conversation.pinnedParticipantId,!1):this._conversation.pinnedParticipantId&&this._onPinParticipant(this._conversation.pinnedParticipantId,!0)),e.conversation.state;let t=null;if(e.conversation.participants){let n=Object.keys(this._participants),i=[];for(let n of e.conversation.participants){let e=bt.composeParticipantId(n),r=n.roles||[];if(e===this._conversation.compositeUserId){t=Et(n.mediaSettings),ce(this._conversation.roles,r)||this._onRolesChanged(e,r);continue}i.push(e);let a=this._participants[e];if(a){let t=Et(n.mediaSettings);St(t,a.mediaSettings)||this._changeRemoteMediaSettings(e,t);let i=bt.mapParticipantState(n),s=a.participantState;bt.isEqualParticipantState(i,s)||this._changeRemoteParticipantState(e,i),ce(r,a.roles)||this._onRolesChanged(a.id,r)}else yield this._onJoinedParticipant({participantId:n.id,participant:n,mediaSettings:n.mediaSettings})}for(let e of n)i.indexOf(e)<0&&this._removeParticipant(this._participants[e],x.HUNGUP)}(e.muteState===j.MUTE||e.muteState===j.MUTE_PERMANENT)&&this._onMuteParticipant(e.muteOptions,!1,e.muteState,t),e.unmuteOptions&&e.unmuteOptions.length&&this._onMuteParticipant(e.unmuteOptions,!0,e.muteState,t),this._onRecordInfo(e.conversation.recordInfo),this._onOptionsChanged(e.conversation.options)}))}_onSignalingFailed(e){Ge.error("Signaling failed",e),this._close(e)}_onAcceptedCall(e){return f(this,null,(function*(){let t=bt.composeMessageId(e),n=bt.getPeerIdString(e.peerId);if(Ge.debug(`Participant accepted call [${t}]`),this._conversation&&t===this._conversation.compositeUserId)return void this._close(new Ct(x.MISSED),"Call accepted on other device");let i=this._participants[t];i||(this._participants[t]=yield this._createParticipant({id:t,mediaSettings:Et(e.mediaSettings)}),i=this._participants[t]),i.state=W.ACCEPTED,i.mediaSettings=Et(e.mediaSettings),this._logWithMediaSettings(ee.ACCEPTED_OUTGOING,i.mediaSettings),this._conversation&&this._conversation.direction===y.OUTGOING&&(this._state===bn.IDLE||this._state===bn.PROCESSING)&&(this._state=bn.ACTIVE,this._changeFeatureSet()),this._state===bn.ACTIVE&&this._transport&&this._transport.open([i.id],n),this._changeRemoteMediaSettings(t,i.mediaSettings),this._changeRemoteParticipantState(t)}))}_onHungup(e){Ge.debug(`Participant hungup [${e.participantId}]`,{reason:e.reason});let t=bt.composeMessageId(e);if(this._conversation&&this._conversation.compositeUserId===t)return void this._close(new Ct(e.reason));let n=this._participants[t];n?(this._transport&&this._transport.close(t),n.state=e.reason===x.REJECTED?W.REJECTED:W.HUNGUP,this._state!==bn.CLOSE&&this._removeParticipant(n,x.HUNGUP)):Ge.warn(`Participant [${t}] isn't in conversation`)}_onAddedParticipant(e){return f(this,null,(function*(){var t,n;Ge.debug(`Participant added [${e.participantId}]`);let i=bt.composeMessageId(e),r=this._participants[i];r&&r.state!==W.HUNGUP&&r.state!==W.REJECTED?Ge.debug(`Participant [${i}] is already in conversation and is active`):(r||(this._participants[i]=yield this._createParticipant({id:i,externalId:e.participant.externalId&&wt.fromSignaling(e.participant.externalId),mediaSettings:Et(e.participant.mediaSettings),state:e.participant.state,participantState:bt.mapParticipantState(e.participant),roles:e.participant.roles||[]}),r=this._participants[i]),r.state=W.CALLED,r.mediaSettings=Et(null==(t=e.participant)?void 0:t.mediaSettings),r.participantState=bt.mapParticipantState(e.participant),r.roles=(null==(n=e.participant)?void 0:n.roles)||[],this._setParticipantsStatus([r],Re.WAITING),this._state===bn.ACTIVE&&this._transport&&this._transport.allocate(r.id,!0),this._changeRemoteMediaSettings(i,r.mediaSettings),this._changeRemoteParticipantState(i,r.participantState))}))}_onJoinedParticipant(e){return f(this,null,(function*(){var t;Ge.debug(`Participant joined [${e.participantId}]`);let n=bt.composeMessageId(e),i=this._participants[n];i&&i.state===W.ACCEPTED?Ge.warn(`Participant [${n}] is already in conversation and is active`):(i||(this._participants[n]=yield this._createParticipant({id:n,externalId:e.participant.externalId&&wt.fromSignaling(e.participant.externalId),mediaSettings:Et(e.participant.mediaSettings),state:e.participant.state,participantState:bt.mapParticipantState(e.participant),roles:e.participant.roles||[]}),i=this._participants[n]),this._conversation&&this._conversation.direction===y.OUTGOING&&(this._state===bn.IDLE||this._state===bn.PROCESSING)&&(this._state=bn.ACTIVE,this._changeFeatureSet()),i.state=W.ACCEPTED,i.mediaSettings=Et(e.mediaSettings),i.participantState=bt.mapParticipantState(e.participant),i.roles=e.participant.roles||[],(null==(t=this._transport)?void 0:t.isAllocated(i.id))?this._setParticipantsStatus([i],Re.CONNECTED):this._setParticipantsStatus([i],Re.WAITING),this._state===bn.ACTIVE&&this._transport&&(this._transport.isAllocated(i.id)||this._transport.allocate(i.id,!0),this._transport.open([i.id])),this._changeRemoteMediaSettings(n,i.mediaSettings),this._changeRemoteParticipantState(n,i.participantState))}))}_onClosedConversation(e){this._toggleJoinAvailability(),this._close(new Ct(e.reason,{remote:!0}))}_onMediaSettingsChanged(e){let t=bt.composeMessageId(e);this._changeRemoteMediaSettings(t,Et(e.mediaSettings))}_onParticipantStateChanged(e){let t=bt.composeMessageId(e);this._changeRemoteParticipantState(t,bt.mapParticipantState(e))}_onNeedRate(){this._conversation&&(this._conversation.needRate=!0,this._changeNeedRate())}_onFeatureSetChanged(e){this._conversation&&(this._conversation.features=e.features,this._changeFeatureSet())}_onMultipartyChatCreated(e){this._conversation&&(this._conversation.chatId=e.chatId,this._toggleJoinAvailability(),Ue.onMultipartyChatCreated(this._conversation))}_onForceMediaSettingsChange(e){return f(this,null,(function*(){if(!this._mediaSource)return;let t=this._mediaSource.getMediaSettings(),n=Et(e.mediaSettings);t.isAudioEnabled!==n.isAudioEnabled&&(yield this._mediaSource.toggleAudio(n.isAudioEnabled)),t.isVideoEnabled!==n.isVideoEnabled&&(yield this._mediaSource.toggleVideo(n.isVideoEnabled)),be.consumerScreenTrack&&t.isScreenSharingEnabled!==n.isScreenSharingEnabled&&(yield this._mediaSource.toggleScreenCapturing(n.isScreenSharingEnabled))}))}_onSettingsUpdate(e){let t={camera:e.camera,screenSharing:e.screenSharing};var n;this._serverSettings=Ut(this._serverSettings,t),this._signalingServerSettings=(n=this._serverSettings,{camera:Object.assign({},n.camera),screenSharing:Object.assign({},n.screenSharing)}),this._transport&&this._transport.updateSettings(this._serverSettings)}_onVideoQualityUpdate(e){let t=this._serverSettings.camera,n=this._signalingServerSettings.camera;if(!t||!n)return;let i=Math.min(Math.round(e.quality.maxBitrate/1024),n.maxBitrateK),r=Math.min(e.quality.maxDimension,n.maxDimension),a={camera:Object.assign({},t,{maxBitrateK:i,maxDimension:r}),screenSharing:null};this._serverSettings=Ut(this._serverSettings,a),Ge.log("Got video quality update notification",this._serverSettings),this._transport&&this._transport.updateSettings(this._serverSettings)}_onPeerRegistered(e){let t=bt.composeMessageId(e);this._participants[t]&&(this._participants[t].clientType=e.clientType,this._participants[t].platform=e.platform)}_onMicSwitched(e){return f(this,null,(function*(){Ue.onDeviceSwitched(V.AUDIO,!e.mute),yield this.toggleLocalAudio(!e.mute)}))}_onChatMessage(e){return f(this,null,(function*(){let t,n=bt.composeMessageId(e);t=this._participants[n]?this._participants[n].externalId:yield this._getUserId(n),Ue.onChatMessage(e.message,t,e.direct)}))}_onCustomData(e){return f(this,null,(function*(){if(e.data.hasOwnProperty("sdk"))return;let t,n=bt.composeMessageId(e);t=this._participants[n]?this._participants[n].externalId:yield this._getUserId(n),Ue.onCustomData(e.data,t,e.direct)}))}_onRecordInfo(e){return f(this,null,(function*(){if(!this._conversation)return;let t=!1;if(!this._conversation.recordInfo!=!e?t=!0:this._conversation.recordInfo&&e&&(t=this._conversation.recordInfo.recordMovieId!==e.recordMovieId),t)if(e){let t=yield this._getUserId(e.initiator);Ue.onRecordStarted(t,e.recordMovieId,e.recordStartTime,e.recordType,e.recordExternalMovieId,e.recordExternalOwnerId)}else Ue.onRecordStopped();this._conversation.recordInfo=e}))}_onRolesChanged(e,t){if(this._conversation&&e===this._conversation.compositeUserId&&!ce(this._conversation.roles,t))return Ge.debug(`Local roles changed: ${t}`),this._conversation.roles=t,void Ue.onLocalRolesChanged(t);let n=this._participants[e];n&&!ce(n.roles,t)&&(Ge.debug(`Roles for participant [${e}] changed: ${t}`),n.roles=t,Ue.onRolesChanged(n.externalId,t))}_onMuteParticipant(e,t,n,i){return f(this,null,(function*(){!this._conversation||(this._conversation.muteOptions=e,(this._conversation.muteState!==n||t)&&(this._conversation.muteState=n,yield this._processMuteState(t,i)))}))}_processMuteState(e=!1,t){return f(this,null,(function*(){if(!this._conversation||!this._mediaSource||this._participantState!==W.ACCEPTED)return;let n=this._conversation.muteState,i=this._conversation.muteOptions,r=n===j.MUTE_PERMANENT,a=this._mediaSource.getMediaSettings();if(e)for(let e of i)Ue.onUnmuteRequest(e);else i.includes(V.AUDIO)&&a.isAudioEnabled&&!(t&&t.isAudioEnabled)&&(Ue.onDeviceSwitched(V.AUDIO,!1),yield this.toggleLocalAudio(!1)),i.includes(V.VIDEO)&&a.isVideoEnabled&&!(t&&t.isVideoEnabled)&&(Ue.onDeviceSwitched(V.VIDEO,!1),yield this.toggleLocalVideo(!1)),i.includes(V.SCREEN_SHARING)&&a.isScreenSharingEnabled&&!(t&&t.isScreenSharingEnabled)&&(Ue.onDeviceSwitched(V.SCREEN_SHARING,!1),yield this.toggleScreenCapturing(!1)),Ue.onUnmutePermission(!r||this._isCallAdmin())}))}_onPinParticipant(e,t=!1){if(!this._conversation)return;let n=this._conversation.pinnedParticipantId;n&&n!==e&&(this._participants[n]?Ue.onPinnedParticipant(this._participants[n].externalId,!0):this._conversation.compositeUserId===n&&Ue.onLocalPin(!0)),this._participants[e]?Ue.onPinnedParticipant(this._participants[e].externalId,t):this._conversation.compositeUserId===e&&Ue.onLocalPin(t),this._conversation.pinnedParticipantId=t?null:e}_onOptionsChanged(e){this._conversation&&!function(e,t){if(e.length!==t.length)return!1;for(let n of e)if(!t.includes(n))return!1;return!0}(this._conversation.options,e)&&(this._conversation.options=e,Ue.onOptionsChanged(e))}_onNetworkStatus(e){if(this._conversation){let t=[];for(let[n,i]of Object.entries(e)){let e;if(n===this._conversation.compositeUserId||""===n)e=this._conversation.networkRating;else{if(!this._participants[n])continue;e=this._participants[n].networkRating}if(e!==i)if(n===this._conversation.compositeUserId||""===n)this._conversation.networkRating=i,Ue.onLocalNetworkStatusChanged(i);else{let e=this._participants[n];e.networkRating=i,t.push({uid:e.externalId,rating:i})}}if(0===t.length)return;Ge.log("Received network status update: ",e),Ue.onNetworkStatusChanged(t)}}_onRemoteStreamSecond(e,t){let n=this._participants[e];if(n){if(be.producerScreenTrack)return void Ue.onRemoteScreenStream(n.externalId,t);if(n.secondStream=t,be.videoTracksCount>0){let t=e;if(!this._streamIdByStreamDescription.has(t))return void Ge.error("Received remote stream notification for a participant that has no track associated with it",t);let i=this._streamIdByStreamDescription.get(t);if(!i||this._streamWaitTimerByStreamDescription.has(t))return void Ge.log("Delaying secondary stream start/stop until main stream becomes available",t);let r=this._streamByStreamId.get(i);if(!r)return Rt.log(ee.PAT_ERROR,"streamNotFound"),void Ge.error(`Could not find stream by ID: ${i}`);Ue.onRemoteStream(n.externalId,n.secondStream||r)}else{let e=t||n.remoteStream;e&&Ue.onRemoteStream(n.externalId,e)}}}_onPeerConnectionClosed(e){e===Sn.SERVER&&this._cleanupParticipantAgnosticStreams()}_changeFeatureSet(){if(this._conversation){let e=this._state===bn.ACTIVE,t=this._conversation.features.includes(O.ADD_PARTICIPANT);Ue.onCallState(e,t,this._conversation)}}_changeNeedRate(){this._conversation&&this._conversation.needRate&&Ue.onRateNeeded()}_onVolumesDetected(e){let t=[];for(let[n,i]of Object.entries(e)){let e=this._participants[n];e&&e.externalId&&t.push({uid:e.externalId,volume:i.real})}Ue.onVolumesDetected(t)}_onSpeakerChanged(e){this._activeSpeakerId=e,this._participants[e]&&this._lastSignalledActiveSpeakerId!==e&&(Ue.onSpeakerChanged(this._participants[e].externalId),this._lastSignalledActiveSpeakerId=e)}_onTransportStateChanged(e,t){return f(this,null,(function*(){let n;if(Ge.debug(`Transport state has changed: ${t}`,e),t===gn.CONNECTED?n=Re.CONNECTED:t===gn.CONNECTING||t===gn.OPENED?n=Re.CONNECTING:t===gn.RECONNECTING&&(n=Re.RECONNECT),!n)return;let i=e.reduce(((e,n)=>{if(n in this._participants){let i=this._participants[n];e.push(i),t===gn.CONNECTED&&(i.remoteStream||(i.mediaSettings&&this._changeRemoteMediaSettings(n,i.mediaSettings),this._changeRemoteParticipantState(n,i.participantState)),this._updateDisplayLayoutFromCache(n))}else Ge.warn(`Participant [${n}] isn't in conversation`);return e}),[]);!i.length||this._setParticipantsStatus(i,n)}))}_onTransportLocalStateChanged(e){return f(this,null,(function*(){Ge.debug(`Local transport state has changed: ${e}`),e===gn.CONNECTED&&Ue.onLocalStatus(Re.CONNECTED),e===gn.CONNECTING&&Ue.onLocalStatus(Re.CONNECTING),e===gn.RECONNECTING&&Ue.onLocalStatus(Re.RECONNECT),e===gn.FAILED&&this._transport&&0===this._transport.allocated().length&&(this._signaling.ready&&(yield this._signaling.hangup(x.FAILED)),this._close(new Ct(x.FAILED),"Transport failed"))}))}_onRemoteTrackAdded(e,t,n){return f(this,null,(function*(){if(e.endsWith(ne.AUDIO_MIX))Ge.debug("Remote audio mix track added"),this._audioOutput.add(n);else if(e.startsWith(ne.PARTICIPANT_AGNOSTIC_TRACK_PREFIX))Ge.debug(`Participant-agnostic track added: ${e}`),this._streamByStreamId.set(e,t);else{Ge.debug(`Remote track added on the participant [${e}]`,{kind:n.kind});let i=this._participants[e];if(i||(Ge.warn(`Conversation: track added before participant [${e}]`),this._participants[e]=yield this._createParticipant({id:e}),i=this._participants[e],this._setParticipantsStatus([i],Re.WAITING),this._activeSpeakerId===e&&this._lastSignalledActiveSpeakerId!==e&&(Ue.onSpeakerChanged(i.externalId),this._lastSignalledActiveSpeakerId=e)),this._transport&&!this._transport.isAllocated(i.id)&&this._transport.allocate(i.id,!1),n.kind===yt.audio&&this._audioOutput.add(n),i.remoteStream!==t){if(i.remoteStream=t,i.secondStream)return;Ue.onRemoteStream(i.externalId,t)}i.mediaSettings&&this._changeRemoteMediaSettings(e,i.mediaSettings),be.batchParticipantsOnStart||this._changeRemoteParticipantState(e,i.participantState)}}))}_onRemoteTrackRemoved(e,t,n){switch(Ge.debug(`[${e}] remote track (removed)`,{track:n}),n.kind){case yt.audio:this._removeAudioTrack(e,t,n);break;case yt.video:case yt.screen:this._removeVideoTrack(e,t,n)}}_removeAudioTrack(e,t,n){if(e!==ne.AUDIO_MIX){let n=this._participants[e];if(!n||n.remoteStream&&n.remoteStream!==t)return}this._audioOutput.remove(n)}_removeVideoTrack(e,t,n){}_onRemoteActivityNoSignal(){this._onRemoteSignalledStall([]),this._onRemoteAllStall(!1)}_onTopologyChanged(e){this._conversation&&(this._conversation.topology=e,this._changeFeatureSet())}_onRemoteAllStall(e){if(this._remoteAllStalled===e)return;this._remoteAllStalled=e;let t=[],n=[];for(let i in this._participants)if(this._participants.hasOwnProperty(i)){let r=this._participants[i];e||this._lastStalled[i]?t.push(r):n.push(r)}t.length&&this._setParticipantsStatus(t,Re.RECONNECT),n.length&&this._setParticipantsStatus(n,Re.CONNECTED)}_onRemoteSignalledStall(e){let t={},n=[],i=[];e.forEach((e=>{if(t[e]=!0,!this._lastStalled[e]){let t=this._participants[e];t&&!this._remoteAllStalled&&n.push(t)}delete this._lastStalled[e]})),Object.keys(this._lastStalled).forEach((e=>{let t=this._participants[e];t&&!this._remoteAllStalled&&i.push(t)})),n.length&&this._setParticipantsStatus(n,Re.RECONNECT),i.length&&this._setParticipantsStatus(i,Re.CONNECTED),this._lastStalled=t}_onRemoteDataStats(e){this._debugInfo&&this._debugInfo.onRemoteDataStats(e,this._participants),this._fixAudioDevice(e.outbound.rtps)}_fixAudioDevice(e){var t;!vt.hasMicrophone()||!this._audioFix||!(null==(t=this._mediaSource)?void 0:t.getMediaSettings().isAudioEnabled)||this._audioFix.fix(e)}_toggleJoinAvailability(){let e=this._conversation&&this._conversation.chatId,t=e&&this._state!==bn.CLOSE||!1;e&&(Ge.debug("Toggle join availability",{available:t,chatId:e}),Ue.onJoinStatus(t,e))}_updateDisplayLayoutFromCache(e){return f(this,null,(function*(){var t;if((null==(t=this._transport)?void 0:t.getTopology())!==Sn.SERVER)return;let n=this._participants[e];n&&n.lastRequestedLayouts&&Object.keys(n.lastRequestedLayouts).length&&(yield this.updateDisplayLayout(Object.values(n.lastRequestedLayouts)))}))}_setParticipantsStatus(e,t,n=null){if(!e.length)return;let i=e.reduce(((e,i)=>(i.status!==t&&(i.status=t,be.batchParticipantsOnStart?e.push(i.externalId):Ue.onParticipantStatus(i.externalId,t,n)),e)),[]);!i.length||be.batchParticipantsOnStart&&Ue.onRemoteStatus(i,t,n)}},Mn=kn;Mn._delayedHangup=!1;var Ln,Un,xn,Gn=class extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,Gn.prototype),this.participantErrors=t}};function Vn(e,t={},n=!1){if(!window.Blob||!window.navigator.sendBeacon)return;let i=Hn(e,t,n),r=new window.Blob([i],{type:"application/x-www-form-urlencoded"});window.navigator.sendBeacon(`${be.apiEnv.api}fb.do`,r)}function Fn(e){return f(this,null,(function*(){return new Promise(((t,n)=>{let i=new XMLHttpRequest;i.open("POST",`${be.apiEnv.api}fb.do`,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=()=>{if(i.readyState!==XMLHttpRequest.DONE)return;let e;try{e=JSON.parse(i.responseText)}catch(t){e={result:i.responseText}}200!==i.status||e.hasOwnProperty("error_msg")?n(e):t(e)},i.send(e)}))}))}function Hn(e,t={},n=!1){t.method=e,t.format="JSON",t.application_key||(t.application_key=be.apiKey),n||(we.sessionKey?t.session_key=we.sessionKey:we.accessToken&&(t.access_token=we.accessToken));for(let[e,n]of Object.entries(t))"object"==typeof n&&(t[e]=JSON.stringify(n));let i="";for(let[e,n]of Object.entries(t))i&&(i+="&"),i+=`${e}=${encodeURIComponent(n)}`;return i}(Un=Ln||(Ln={}))[Un.VCHAT_SERVICE_DISABLED=1101]="VCHAT_SERVICE_DISABLED",Un[Un.TARGET_USER_UNAVAILABLE=1102]="TARGET_USER_UNAVAILABLE",Un[Un.FRIENDSHIP_REQUIRED=1103]="FRIENDSHIP_REQUIRED",Un[Un.VCHAT_YOULA_API_ERROR=1104]="VCHAT_YOULA_API_ERROR",Un[Un.VCHAT_VK_API_ERROR=1106]="VCHAT_VK_API_ERROR",function(e){e[e.PARAM_SESSION_EXPIRED=102]="PARAM_SESSION_EXPIRED",e[e.PARAM_SESSION_KEY=103]="PARAM_SESSION_KEY",e[e.PARAM_SIGNATURE=104]="PARAM_SIGNATURE",e[e.AUTH_LOGIN=401]="AUTH_LOGIN"}(xn||(xn={}));var jn,Bn,Wn=class extends g{constructor(){super(...arguments),this._userId=null,this._externalUidsCache={}}_callUnsafe(e){return f(this,arguments,(function*(e,t={},n=!1){let i=r=>f(this,null,(function*(){try{return yield function(e){return f(this,arguments,(function*(e,t={},n=!1){return Fn(Hn(e,t,n))}))}(e,t,n)}catch(t){if(!t.hasOwnProperty("error_msg")&&(r++,Ge.debug(`${e} network error, attempt ${r}...`),r<10))return yield bt.delay(Math.min(700*r,3e3)),i(r);throw Ge.warn(e,"error",t),t}}));return i(0)}))}_call(e){return f(this,arguments,(function*(e,t={},n=!1){try{return yield this._callUnsafe(e,t,n)}catch(i){Ge.warn("Api call error",i);let r=L.API;switch(i.error_code){case 102:case 103:case 104:return yield this.authorize(),this._callUnsafe(e,t,n);case 1101:r=x.SERVICE_DISABLED;break;case 1102:r=x.CALLEE_IS_OFFLINE;break;case 1103:r=x.NOT_FRIENDS;break;case 1104:case 1106:r=x.EXTERNAL_API_ERROR}throw new Ct(r,{message:i.error_msg,code:i.error_code})}}))}userId(e){return f(this,null,(function*(){let t=bt.decomposeId(e).id;return we.isEmpty()?wt.fromId(String(t)):(this._externalUidsCache.hasOwnProperty(t)||Object.assign(this._externalUidsCache,yield this._getExternalIdsByOkIds([t])),wt.fromString(this._externalUidsCache[t]))}))}prepareUserIds(e){return f(this,null,(function*(){we.isEmpty()||Object.assign(this._externalUidsCache,yield this._getExternalIdsByOkIds(e))}))}authorize(){return f(this,null,(function*(){if(!this._uuid){let e=$e.get("uuid");e||(e=bt.uuid(),$e.set("uuid",e)),this._uuid=String(e)}let e={session_data:{version:2,device_id:this._uuid,client_version:be.appVersion,client_type:"SDK_JS"}};return be.authToken&&(e.session_data.auth_token=be.authToken,e.session_data.version=3),this._callUnsafe("auth.anonymLogin",e,!0).then((e=>{e.uid&&(this._userId=Number(e.uid)),we.sessionKey=e.session_key,we.sessionSecretKey=e.session_secret_key})).catch((e=>{throw 401===e.error_code&&Ue.onTokenExpired(),new Ct(L.AUTH,{message:e.error_msg,code:e.error_code})}))}))}log(e){Vn("log.externalLog",{collector:"ok.mobile.apps.video",data:JSON.stringify({application:`${be.appName}:${be.sdkVersion}`,platform:be.platform,items:e})})}init(){!function(){if(!be.apiAppId||!be.apiKey)throw new Ct(L.API,{message:"Required arguments apiAppId/apiAppKey not passed"})}()}joinConversation(e,t=!1,n){return f(this,null,(function*(){let i={conversationId:e,isVideo:t};return n&&(i.chatId=n),this._call("vchat.joinConversation",i)}))}createConversation(e,t="",n=!1){return f(this,null,(function*(){let i={conversationId:e,createJoinLink:!0,isVideo:!1};return t&&(i.payload=t),be.domain&&(i.domainId=be.domain),n&&(i.requireAuthToJoin=!0),this._startConversation(i)}))}startConversation(e,t,n,i=!1,r="",a=!1,s=!1){return f(this,null,(function*(){let o={conversationId:e,isVideo:i};if(t&&t.length)switch(n){case I.USER:o.uids=t.join(",");break;case I.GROUP:o.gid=t[0];break;case I.CHAT:o.chatId=t[0]}return a&&(o.createJoinLink=!0),r&&(o.payload=r),be.domain&&(o.domainId=be.domain),s&&(o.requireAuthToJoin=!0),this._startConversation(o)}))}_startConversation(e){return f(this,null,(function*(){return this._call("vchat.startConversation",e)}))}createJoinLink(e){return f(this,null,(function*(){return this._call("vchat.createJoinLink",{conversationId:e})}))}removeJoinLink(e){return f(this,null,(function*(){return this._call("vchat.removeJoinLink",{conversationId:e})}))}getAnonymTokenByLink(e,t){return f(this,null,(function*(){let n={joinLink:e};t&&(n.anonymName=t);let i=yield this._call("vchat.getAnonymTokenByLink",n);return this._userId=Number(i.uid),i.token}))}joinConversationByLink(e,t=!1){return f(this,null,(function*(){let n={joinLink:e,isVideo:t};return be.anonymToken&&(n.anonymToken=be.anonymToken),this._call("vchat.joinConversationByLink",n)}))}getOkIdsByExternalIds(e){return f(this,null,(function*(){let t=wt.fromIds(e),n=[],i={methods:[]},r=[],a=Object.keys(this._externalUidsCache),s=Object.values(this._externalUidsCache);for(let e of t){let t=wt.toString(e),o=s.indexOf(t);o>-1?n.push(Number(a[o])):(r.push(t),i.methods.push({"vchat.getOkIdByExternalId":{params:{externalId:e.id,anonym:e.type===At.ANONYM},onError:"SKIP"}}))}return i.methods.length&&(yield this._call("batch.executeV2",i)).forEach(((e,t)=>{if(e.ok){let i=Number(e.ok.ok_id);this._externalUidsCache[i]=r[t],n.push(i)}})),n}))}getExternalIdsByOkIds(e){return f(this,null,(function*(){let t=[],n=[];for(let i of e)this._externalUidsCache.hasOwnProperty(i)?t.push(wt.fromString(this._externalUidsCache[i])):n.push(i);if(!n.length)return t;let i=yield this._getExternalIdsByOkIds(n);Object.assign(this._externalUidsCache,i);for(let e of n)i.hasOwnProperty(e)&&t.push(wt.fromString(i[e]));return t}))}getCachedOkIdByExternalId(e){let t=Object.keys(this._externalUidsCache),n=Object.values(this._externalUidsCache),i=wt.toString(e),r=n.indexOf(i);return r>-1?bt.composeId(t[r],de.USER):null}cacheExternalId(e,t){let n=bt.decomposeId(e).id;this._externalUidsCache[n]=wt.toString(t)}getConversationParams(){return f(this,null,(function*(){let e={};return be.anonymToken&&(e.anonymToken=be.anonymToken),this._call("vchat.getConversationParams",e)}))}getUserId(){return this._userId}setUserId(e){this._userId=e}hangupConversation(e){let t={conversationId:e,reason:x.HUNGUP};be.anonymToken&&(t.anonymToken=be.anonymToken),Vn("vchat.hangupConversation",t)}cleanup(){}_getExternalIdsByOkIds(e){return f(this,null,(function*(){let t={};try{let n=yield this._call("vchat.getExternalIdsByOkIds",{uids:e.join(",")});if(n.external_ids)for(let[e,i]of Object.entries(n.external_ids))t[e]=wt.fromIdToString(i,At.USER);if(n.anonym_ids)for(let[e,i]of Object.entries(n.anonym_ids))t[e]=wt.fromIdToString(i,At.ANONYM);return t}catch(e){return t}}))}getTokenForAnonym(e,t){return f(this,null,(function*(){let n={id:e};return t&&(n.application_key=t),(yield this._callUnsafe("auth.getTokenForAnonym",n,!0)).token}))}call(e){return f(this,arguments,(function*(e,t={}){return this._call(e,t)}))}};(Bn=jn||(jn={})).RECOVER="recover",Bn.ACCEPT_CALL="accept-call",Bn.ADD_PARTICIPANT="add-participant",Bn.REMOVE_PARTICIPANT="remove-participant",Bn.HANGUP="hangup",Bn.TRANSMIT_DATA="transmit-data",Bn.ACCEPT_PRODUCER="accept-producer",Bn.ALLOCATE_CONSUMER="allocate-consumer",Bn.CHANGE_MEDIA_SETTINGS="change-media-settings",Bn.CHANGE_PARTICIPANT_STATE="change-participant-state",Bn.CHANGE_STREAM_PRIORITIES="change-streams-priorities",Bn.UPDATE_DISPLAY_LAYOUT="update-display-layout",Bn.REPORT_PERF_STAT="report-perf-stat",Bn.RECORD_START="record-start",Bn.RECORD_STOP="record-stop",Bn.RECORD_GET_STATUS="record-get-status",Bn.SWITCH_MICRO="switch-micro",Bn.SWITCH_TOPOLOGY="switch-topology",Bn.REQUEST_REALLOC="request-realloc",Bn.CHAT_MESSAGE="chat-message",Bn.CHAT_HISTORY="chat-history",Bn.CUSTOM_DATA="custom-data",Bn.GRANT_ROLES="grant-roles",Bn.MUTE_PARTICIPANT="mute-participant",Bn.PIN_PARTICIPANT="pin-participant",Bn.UPDATE_MEDIA_MODIFIERS="update-media-modifiers",Bn.CHANGE_OPTIONS="change-options",Bn.GET_WAITING_HALL="get-waiting-hall",Bn.PROMOTE_PARTICIPANT="promote-participant",Bn.REQUEST_TEST_MODE="request-test-mode",Bn.ADD_MOVIE="add-movie",Bn.UPDATE_MOVIE="update-movie",Bn.REMOVE_MOVIE="remove-movie";var $n=jn,Kn="open",qn=[()=>be.producerScreenTrack,()=>be.videoTracksCount>0,()=>!0,()=>be.filteredMessages,()=>be.consumerScreenTrack],Jn=class extends E{constructor(){super(...arguments),this.socket=null,this.sequence=1,this.lastStamp=0,this.websocketCommandsQueue=[],this.datachannelCommandsQueue=[],this.incomingCache=[],this.responseHandlers={},this.reconnectCount=0,this.conversationResolve=null,this.conversationReject=null,this.connected=!1,this.listenersReady=!1,this.postfix="&platform="+be.platform+"&appVersion="+be.appVersion+"&version="+be.protocolVersion+"&device="+be.device+"&capabilities="+Jn._getCapabilityFlags(),this.peerId=null,this.conversationId=null,this.reconnectTimer=0,this.connectionMessageWaitTimer=0,this.doctorTimer=0,this.participantIdRegistry=null,this.producerNotificationDataChannel=null,this.producerCommandDataChannel=null}static _getCapabilityFlags(){let e=0;for(let t=0;t<qn.length;t++)qn[t]()&&(e|=1<<t);return e.toString(16).toUpperCase()}get ready(){return null!==this.socket}setEndpoint(e){this.endpoint=e}setConversationId(e){this.conversationId=e}setParticipantIdRegistry(e){this.participantIdRegistry=e}setProducerNotificationDataChannel(e){this.producerNotificationDataChannel=e,this.producerNotificationDataChannel.onmessage=e=>{var t;let n=null==(t=this.participantIdRegistry)?void 0:t.handleMessage(e.data);n&&this._handleMessage(n)}}setProducerCommandDataChannel(e){this.producerCommandDataChannel=e,this.producerCommandDataChannel.onmessage=this._onMessage.bind(this),this._handleCommandsQueue(this.datachannelCommandsQueue)}cleanup(){this.datachannelCommandsQueue=[]}connect(e){return f(this,null,(function*(){return this.postfix+=`&clientType=${be.clientType}`,new Promise(((t,n)=>{if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return Rt.log(ee.SOCKET_ACTION,"already_opened"),void n(Error("Socket already opened"));this.conversationResolve=e=>{t(e),this.conversationResolve=null,this.conversationReject=null},this.conversationReject=e=>{n(e),this.conversationResolve=null,this.conversationReject=null},this._connect(e)}))}))}_send(e){return f(this,arguments,(function*(e,t={},n=0){if(t.participantId){let e=bt.decomposeId(t.participantId);t=Object.assign({},t,{participantId:e.id,participantType:e.type})}return this._sendRaw(e,t,n)}))}_sendRaw(e){return f(this,arguments,(function*(e,t={},n=0){let i=t=>{var n;if(this._isDataChannelCommand(e))this.datachannelCommandsQueue.push(t),(null==(n=this.producerCommandDataChannel)?void 0:n.readyState)===Kn&&this._handleCommandsQueue(this.datachannelCommandsQueue);else{if(!this.socket)return Rt.log(ee.SOCKET_ACTION,"not_opened"),Ge.warn("Socket not opened"),void t.reject(new Error(`Socket not opened [${e}]`),!0);this.socket.readyState>WebSocket.OPEN&&(Rt.log(ee.SOCKET_ACTION,"invalid_state"),Ge.warn(`Socket is not opened, state ${this.socket.readyState}`)),this.websocketCommandsQueue.push(t),this.socket&&this.socket.readyState===WebSocket.OPEN&&this._handleCommandsQueue(this.websocketCommandsQueue)}};return new Promise(((r,a)=>{let s={sequence:this.sequence++,name:e,params:t,responseTimer:0,resolve:r,reject:(t,r=!1)=>{!n||r?a(t):(Ge.debug("Resending a signaling message",e,s.sequence),n--,i(s))}};i(s)}))}))}_isDataChannelCommand(e){return!!this.producerCommandDataChannel&&(e===$n.UPDATE_DISPLAY_LAYOUT||e===$n.REPORT_PERF_STAT)}static _isDataChannelResponseRequired(e){return e===$n.UPDATE_DISPLAY_LAYOUT||e===$n.REPORT_PERF_STAT}getNextCommandSequenceNumber(){return this.sequence}hangup(e){return f(this,null,(function*(){return this._send($n.HANGUP,{reason:e}).catch((()=>{}))}))}sendCandidate(e,t){return f(this,null,(function*(){return this._send($n.TRANSMIT_DATA,{participantId:e,data:{candidate:t}})}))}requestTestMode(e){return f(this,null,(function*(){return this._send($n.REQUEST_TEST_MODE,{consumerCommand:e})}))}sendSdp(e,t){return f(this,null,(function*(){return this._send($n.TRANSMIT_DATA,{participantId:e,data:{sdp:t}})}))}acceptCall(e){return f(this,null,(function*(){return this._send($n.ACCEPT_CALL,{mediaSettings:e})}))}changeMediaSettings(e){return f(this,null,(function*(){return this._send($n.CHANGE_MEDIA_SETTINGS,{mediaSettings:e},10)}))}changeParticipantState(e){return f(this,null,(function*(){return this._send($n.CHANGE_PARTICIPANT_STATE,{participantState:{state:e}})}))}addParticipant(e,t){return f(this,null,(function*(){return this._send($n.ADD_PARTICIPANT,((e,t)=>{for(var n in t||(t={}))h.call(t,n)&&m(e,n,t[n]);if(p)for(var n of p(t))_.call(t,n)&&m(e,n,t[n]);return e})({participantId:e},t))}))}removeParticipant(e,t=!1){return f(this,null,(function*(){return this._send($n.REMOVE_PARTICIPANT,{participantId:e,ban:t})}))}allocateConsumer(e,t){return f(this,null,(function*(){let n={capabilities:t};return e&&(n.description=e.sdp),this._send($n.ALLOCATE_CONSUMER,n)}))}acceptProducer(e,t){return f(this,null,(function*(){let n={description:e.sdp};return t&&(n.ssrcs=t),this._send($n.ACCEPT_PRODUCER,n)}))}changePriorities(e){return f(this,null,(function*(){return this._send($n.CHANGE_STREAM_PRIORITIES,{typedPriorities:e}).catch((()=>{}))}))}updateDisplayLayout(e){return f(this,null,(function*(){return this._send($n.UPDATE_DISPLAY_LAYOUT,{layouts:e})}))}addMovie(e){return f(this,null,(function*(){return this._send($n.ADD_MOVIE,e)}))}updateMovie(e){return f(this,null,(function*(){return this._send($n.UPDATE_MOVIE,e)}))}removeMovie(e){return f(this,null,(function*(){return this._send($n.REMOVE_MOVIE,e)}))}startStream(e){return f(this,null,(function*(){return this._send($n.RECORD_START,e)}))}stopStream(){return f(this,null,(function*(){return this._send($n.RECORD_STOP)}))}getRecordStatus(){return f(this,null,(function*(){return this._send($n.RECORD_GET_STATUS)}))}switchTopology(e,t=!1){return f(this,null,(function*(){return this._send($n.SWITCH_TOPOLOGY,{topology:e,force:t})}))}requestRealloc(){return f(this,null,(function*(){return this._send($n.REQUEST_REALLOC)}))}reportPerfStat(e){return f(this,null,(function*(){return this._send($n.REPORT_PERF_STAT,{report:e})}))}chatMessage(e,t=null){return f(this,null,(function*(){return this._send($n.CHAT_MESSAGE,{message:e,participantId:t})}))}chatHistory(e){return f(this,null,(function*(){return this._send($n.CHAT_HISTORY,{count:e})}))}customData(e,t){return f(this,null,(function*(){return this._send($n.CUSTOM_DATA,{data:e,participantId:t})}))}grantRoles(e,t,n){return f(this,null,(function*(){let i={participantId:e,roles:t};return n&&(i.revoke=!0),this._sendRaw($n.GRANT_ROLES,i)}))}muteParticipant(e,t,n=!1,i=!1){return f(this,null,(function*(){return this._sendRaw($n.MUTE_PARTICIPANT,{participantId:e,mediaOptions:t,unmute:n,mutePermanent:i})}))}pinParticipant(e,t){return f(this,null,(function*(){let n={participantId:e};return t&&(n.unpin=!0),this._sendRaw($n.PIN_PARTICIPANT,n)}))}updateMediaModifiers(e){return f(this,null,(function*(){return this._send($n.UPDATE_MEDIA_MODIFIERS,{mediaModifiers:e})}))}changeOptions(e){return f(this,null,(function*(){return this._send($n.CHANGE_OPTIONS,{options:e})}))}getWaitingHall(e=null,t,n=!1){return f(this,null,(function*(){let i={};return e&&(i.fromId=e),t&&(i.count=t),n&&(i.backward=n),this._send($n.GET_WAITING_HALL,i)}))}promoteParticipant(e,t=!1){return f(this,null,(function*(){let n={participantId:e};return t&&(n.demote=t),this._sendRaw($n.PROMOTE_PARTICIPANT,n)}))}close(){this.socket&&this.socket.readyState<WebSocket.CLOSING&&this._closeSocket(),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}readyToSend(){this.listenersReady=!0,this._handleCachedMessages()}_connect(e){if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return;let t="";e&&(t+=`&tgt=${e}`),e===K.RETRY&&this.lastStamp&&(t+=`&recoverTs=${this.lastStamp}`),Ge.debug("Connecting to "+this.endpoint+this.postfix+t),this.socket=new WebSocket(this.endpoint+this.postfix+t),this.socket.onopen=this._onOpen.bind(this),this.socket.onmessage=this._onMessage.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this._startDoctor()}_disconnect(){this.socket&&this.socket.readyState<WebSocket.CLOSING&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.close(),this.socket=null),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}_onOpen(){Ge.debug("Socket opened"),Rt.log(ee.SOCKET_ACTION,"opened"),this._waitConnectionMessage(),this._startDoctor()}_onMessage(e){if(this._startDoctor(),"ping"!==e.data)try{this._handleMessage(JSON.parse(e.data))}catch(t){Rt.log(ee.SOCKET_ACTION,"parse_error"),Ge.error("Unable to parse message",t,e.data)}else this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send("pong")}_handleMessage(e){var t;"notification"===e.type?"connection"===e.notification?(Ge.debug("Signaling connected",e),this.connected=!0,this.reconnectCount=0,this.endpoint=e.endpoint,e.peerId&&this.peerId!==e.peerId.id&&(this.postfix+=`&peerId=${e.peerId.id}`,this.peerId=e.peerId.id),this._stopWaitConnectionMessage(),this.conversationResolve?this.conversationResolve(e):(this._triggerEvent(Y.RECONNECT,e),e.conversation.topology&&this._triggerEvent(Y.NOTIFICATION,{type:"notification",notification:Q.TOPOLOGY_CHANGED,topology:e.conversation.topology})),this.lastStamp&&this._handleCachedMessages(),null==(t=e.recoverMessages)||t.forEach((e=>this._handleMessage(e))),this._handleCommandsQueue(this.websocketCommandsQueue)):this.connected&&this.listenersReady?this._triggerEvent(Y.NOTIFICATION,e):this.incomingCache.push(e):"response"===e.type&&this.responseHandlers[e.sequence]?this._handleCommandResponse(!0,e):"error"===e.type&&this.responseHandlers[e.sequence]?(Rt.log(ee.SOCKET_ACTION,`error-${e.error}`),this._handleCommandResponse(!1,e)):"error"===e.type?(Rt.log(ee.SOCKET_ACTION,`error-${e.error}`),"service-unavailable"===e.error?this._reconnect():"conversation-ended"===e.error?this.conversationReject?this.conversationReject(new Ct(x.SOCKET_CLOSED,{message:`Unable to connect to the signaling: ${e.error}`})):this._triggerEvent(Y.NOTIFICATION,{notification:Q.CLOSED_CONVERSATION,reason:e.reason}):this.connected||"invalid-token"===e.error?this._throwError(new Error(`Signaling error: ${e.error}`)):e.sequence||(this.conversationReject&&this.conversationReject(new Ct(L.SIGNALING_FAILED,{message:`Unable to connect to the signaling: ${e.error}`})),this._closeSocket())):(Rt.log(ee.SOCKET_ACTION,"unknown_message"),Ge.warn("Unhandled message",e)),this.lastStamp=e.stamp||this.lastStamp}_handleCachedMessages(){let e=[...this.incomingCache];for(this.incomingCache=[];e.length>0;){let t=e.shift();this._handleMessage(t)}}_throwError(e){this._triggerEvent(Y.FAILED,e)}_onError(e){Rt.log(ee.SOCKET_ACTION,"error"),Ge.error("Signaling error",e)}_onClose(e){Rt.log(ee.SOCKET_ACTION,"closed"),Ge.debug("Connection closed",{code:e.code,reason:e.reason}),this.connected=!1,this._stopDoctor(),this.socket&&this.reconnectCount++<Jn.RECONNECT_MAX_COUNT?this._reconnect():this.socket&&this._closeSocket(new Error("Connection closed"))}_closeSocket(e=null){!this.socket||(this._disconnect(),Object.values(this.responseHandlers).forEach((t=>{window.clearTimeout(t.responseTimer),e&&t.reject(new Error("Connection closed"),!0)})),this.websocketCommandsQueue=[],this.responseHandlers={},this.lastStamp=0,e&&this._throwError(new Error("Connection closed")))}_reconnect(){let e=Math.min(Jn.RECONNECT_MAX_DELAY,Jn.RECONNECT_DELAY*Math.pow(2,this.reconnectCount-1));Ge.log(`Reconnect websocket after ${e}ms (${this.reconnectCount})`),Rt.log(ee.SOCKET_ACTION,"reconnect"),this.reconnectTimer=window.setTimeout(this._connect.bind(this,K.RETRY),e)}_handleCommandResponse(e,t){var n;if(!this.responseHandlers.hasOwnProperty(t.sequence))return;let i=this.responseHandlers[t.sequence];window.clearTimeout(i.responseTimer),e?(delete this.responseHandlers[t.sequence],i.resolve(t)):(null==(n=this.socket)?void 0:n.readyState)===WebSocket.OPEN?(delete this.responseHandlers[t.sequence],Rt.log(ee.SOCKET_ACTION,"response-timeout"),i.reject(new Error(t.error||`Response timeout [${i.name}]`))):i.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,t)),Jn.WAIT_RESPONSE_DELAY)}_handleCommandsQueue(e){for(var t,n;e.length>0;){let i=e.shift(),r=Object.assign({command:i.name,sequence:i.sequence},i.params);if(this._isDataChannelCommand(i.name)){if((null==(t=this.producerCommandDataChannel)?void 0:t.readyState)!==Kn)return void i.reject(new Error(`Invalid data channel state: ${null==(n=this.producerCommandDataChannel)?void 0:n.readyState}`));Jn._isDataChannelResponseRequired(i.name)&&(i.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,r)),Jn.WAIT_RESPONSE_DELAY),this.responseHandlers[i.sequence]=i),this.producerCommandDataChannel.send(JSON.stringify(r))}else{if(!this.socket||this.socket.readyState!==WebSocket.OPEN){i.reject(new Error("Invalid state or socket already closed"));continue}i.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,r)),Jn.WAIT_RESPONSE_DELAY),this.responseHandlers[i.sequence]=i,this.socket.send(JSON.stringify(r))}}}_waitConnectionMessage(){this.connectionMessageWaitTimer=window.setTimeout((()=>{this.conversationReject&&this.conversationReject(new Ct(L.SIGNALING_FAILED,{message:"Unable to connect to the signaling: connection timeout"}))}),Jn.WAIT_CONNECTION_DELAY)}_stopWaitConnectionMessage(){window.clearTimeout(this.connectionMessageWaitTimer),this.connectionMessageWaitTimer=0}_startDoctor(){this._stopDoctor(),this.doctorTimer=window.setTimeout((()=>{Ge.warn("Socket is dead, trying to reconnect"),this._disconnect(),this._connect(K.RETRY)}),Jn.WAIT_MESSAGE_DELAY)}_stopDoctor(){window.clearTimeout(this.doctorTimer),this.doctorTimer=0}},Yn=Jn;Yn.RECONNECT_DELAY=be.signalingReconnectDelay,Yn.RECONNECT_MAX_DELAY=be.signalingReconnectMaxDelay,Yn.RECONNECT_MAX_COUNT=be.signalingReconnectMaxCount,Yn.WAIT_CONNECTION_DELAY=be.waitConnectionDelay,Yn.WAIT_RESPONSE_DELAY=be.waitResponseDelay,Yn.WAIT_MESSAGE_DELAY=be.waitMessageDelay;var zn,Xn,Qn=null,Zn={getCameras:vt.getCameras,getMicrophones:vt.getMicrophones,getOutput:vt.getOutput,hasCamera:vt.hasCamera,hasMicrophone:vt.hasMicrophone,getSavedCamera:vt.getSavedCamera,getSavedMicrophone:vt.getSavedMicrophone,getSavedOutput:vt.getSavedOutput,hasCameraPermission:vt.hasCameraPermission,hasMicrophonePermission:vt.hasMicrophonePermission,hasPermissions:vt.hasPermissions,getUserMedia:vt.getUserMedia,getUserVideo:vt.getUserVideo,getUserAudio:vt.getUserAudio,saveDeviceId:vt.saveDeviceId,isBrowserSupported:vt.isBrowserSupported,isScreenCapturingSupported:vt.isScreenCapturingSupported,os:vt.os,isMobile:vt.isMobile,browserName:vt.browserName,browserVersion:vt.browserVersion,baseChromeVersion:vt.baseChromeVersion,getAudioContext:vt.getAudioContext};function ei(e){Xn=e}function ti(e){zn=e}function ni(e){Qn=e}function ii(e){be.videoEffects=e}function ri(e){return f(this,null,(function*(){if(be.set(e),"Sferum"===vt.browserName()&&(be.platform=`SFERUM:${vt.browserVersion()}`),Xn||ei(new Wn),zn||ti((()=>new Yn)),be.debug&&(a.default.disableLog(!1),Ge.toggle(!0)),Ge.log(`Calls SDK ${be.sdkVersion}`,e),yield vt.init(),!vt.isBrowserSupported())throw new Ct(L.UNSUPPORTED);Xn.init()}))}function ai(e){return f(this,arguments,(function*(e,t=[V.AUDIO],n="",i=!1,r=!1){let a=[],s=[];if(Array.isArray(e)?a=e.length?e:[]:e&&(a=[e]),a.length&&(s=yield Xn.getOkIdsByExternalIds(a),!s.length))throw new Ct(x.CALLEE_IS_OFFLINE);return si(s,I.USER,t,n,i,r)}))}function si(e){return f(this,arguments,(function*(e,t=I.USER,n,i="",r=!1,a=!1){if(Mn.current())throw Ge.error("There is already active call"),new Ct(x.FAILED);return new Mn(Xn,zn(),Qn).onStart(e,t,n,i,r,a)}))}function oi(e){return f(this,null,(function*(){return ci(e)}))}function ci(e){return f(this,arguments,(function*(e,t=de.USER,n){if(e===Mn.id())throw new Error("Push has already been processed");return new Mn(Xn,zn(),Qn).onPush(e,t,n)}))}function di(e,t){return f(this,null,(function*(){return Xn.getTokenForAnonym(e,t)}))}function li(e){return f(this,arguments,(function*(e,t={}){return Xn.call(e,t)}))}function ui(e){return f(this,null,(function*(){return e&&(be.authToken=e),Xn.authorize()}))}function pi(){return f(this,arguments,(function*(e=[V.AUDIO]){let t=Mn.current();if(t)return t.accept(e);throw new Error("Conversation not found")}))}function hi(){return f(this,null,(function*(){let e=Mn.current();if(e)return e.decline()}))}function _i(e){return f(this,arguments,(function*(e,t=[V.AUDIO]){return mi(e,t)}))}function mi(e,t,n){return f(this,null,(function*(){if(Mn.current())throw Ge.error("There is already active call"),new Ct(x.FAILED);return new Mn(Xn,zn(),Qn).onJoin({conversationId:e,mediaOptions:t,chatId:n})}))}function fi(e){return f(this,arguments,(function*(e,t=[V.AUDIO],n){if(Mn.current())throw Ge.error("There is already active call"),new Ct(x.FAILED);return n&&(be.anonymToken=n),new Mn(Xn,zn(),Qn).onJoin({joinLink:e,mediaOptions:t})}))}function gi(){return f(this,null,(function*(){let e=Mn.current();if(e)return e.hangup();Mn.hangupAfterInit()}))}function vi(e,t){return f(this,null,(function*(){let n=yield Xn.getOkIdsByExternalIds([e]);if(!n.length)throw new Error("User not found");return Si(n[0],t)}))}function Si(e,t){return f(this,null,(function*(){let n=Mn.current();n&&(yield n.addParticipant(bt.composeId(e,de.USER),t))}))}function Ei(e,t=!1){return f(this,null,(function*(){return Ti((yield Xn.getOkIdsByExternalIds([e]))[0],t)}))}function Ti(e,t=!1){return f(this,null,(function*(){let n=Mn.current();n&&(yield n.removeParticipant(bt.composeId(e,de.USER),t))}))}function yi(e,t){return f(this,null,(function*(){let n=yield vt.saveDeviceId(e,t),i=Mn.current();return n&&i?i.changeDevice(e):Promise.reject()}))}function Ci(e){return f(this,null,(function*(){let t=Mn.current();return t?t.toggleScreenCapturing(e):Promise.reject()}))}function Ri(e,t=!1){return f(this,null,(function*(){let n=Mn.current();n&&(yield n.setVideoStream(e,t))}))}function Ii(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.toggleLocalVideo(e))}))}function Pi(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.toggleLocalAudio(e))}))}function Ai(e,t){return f(this,null,(function*(){let n=Mn.current();if(n)return n.setLocalResolution(e,t)}))}function wi(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.changePriorities(e))}))}function Oi(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.changeParticipantState(e))}))}function bi(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.updateDisplayLayout(e))}))}function Di(e,t,n=!1){return f(this,null,(function*(){return Ni((yield Xn.getOkIdsByExternalIds([e]))[0],t,n)}))}function Ni(e,t,n=!1){return f(this,null,(function*(){let i=Mn.current();i&&(yield i.grantRoles(bt.composeId(e,de.USER),t,n))}))}function ki(){return f(this,arguments,(function*(e=null,t=[V.AUDIO],n=!1){let i=null;return e&&(i=(yield Xn.getOkIdsByExternalIds([e]))[0]),Mi(i,t,n)}))}function Mi(){return f(this,arguments,(function*(e=null,t=[V.AUDIO],n=!1){let i=Mn.current();if(i){let r=e?bt.composeId(e,de.USER):null;yield i.switchParticipantDevice(r,t,!1,n)}}))}function Li(){return f(this,arguments,(function*(e=null,t=[V.AUDIO]){let n=null;return e&&(n=(yield Xn.getOkIdsByExternalIds([e]))[0]),Ui(n,t)}))}function Ui(){return f(this,arguments,(function*(e=null,t=[V.AUDIO]){let n=Mn.current();if(n){let i=e?bt.composeId(e,de.USER):null;yield n.switchParticipantDevice(i,t,!0)}}))}function xi(e,t=!1){return f(this,null,(function*(){return Gi((yield Xn.getOkIdsByExternalIds([e]))[0],t)}))}function Gi(e,t=!1){return f(this,null,(function*(){let n=Mn.current();n&&(yield n.pinParticipant(bt.composeId(e,de.USER),t))}))}function Vi(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.updateMediaModifiers(e))}))}function Fi(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.changeOptions(e))}))}function Hi(e,t=null){return f(this,null,(function*(){let n=null;return t&&(n=(yield Xn.getOkIdsByExternalIds([t]))[0]),ji(e,n)}))}function ji(e,t=null){return f(this,null,(function*(){let n=Mn.current();if(n){let i=t?bt.composeId(t,de.USER):null;yield n.chatMessage(e,i)}}))}function Bi(e=10){return f(this,null,(function*(){let t=Mn.current();if(t)return t.chatHistory(e)}))}function Wi(e,t=null){return f(this,null,(function*(){let n=null;return t&&(n=(yield Xn.getOkIdsByExternalIds([t]))[0]),$i(e,n)}))}function $i(e,t=null){return f(this,null,(function*(){let n=Mn.current();if(n){let i=t?bt.composeId(t,de.USER):null;yield n.customData(e,i)}}))}function Ki(e="",t=!1){return f(this,null,(function*(){return(yield Xn.createConversation(bt.uuid(),e,t)).join_link}))}function qi(){return f(this,null,(function*(){let e=Mn.current();return e?e.createJoinLink():Promise.reject()}))}function Ji(){return f(this,null,(function*(){let e=Mn.current();return e?e.removeJoinLink():Promise.reject()}))}function Yi(e,t){return f(this,null,(function*(){return Xn.getAnonymTokenByLink(e,t)}))}function zi(e){let t=Mn.current();t&&t.setVolume(e)}function Xi(e){be.forceRelayPolicy=e}function Qi(e=!1,t=null,n=null,i="DIRECT_LINK",r=null){return f(this,null,(function*(){let a=Mn.current();return a?a.startStream(e,t,n,i,r):Promise.reject()}))}function Zi(){return f(this,null,(function*(){let e=Mn.current();return e?e.stopStream():Promise.reject()}))}function er(){return f(this,null,(function*(){let e=Mn.current();return e?e.getStreamInfo():Promise.reject()}))}function tr(e){return f(this,null,(function*(){let t=Mn.current();return t?t.addMovie(e):Promise.reject()}))}function nr(e,t){return f(this,null,(function*(){let n=Mn.current();return n?n.updateMovie(e,t):Promise.reject()}))}function ir(e){return f(this,null,(function*(){let t=Mn.current();return t?t.removeMovie(e):Promise.reject()}))}function rr(e){be.statisticsInterval=e;let t=Mn.current();if(t)return t.updateStatisticsInterval()}function ar(e){a.default.disableLog(!e),Ge.toggle(e)}function sr(e,...t){!be.debugLog||Ge.send(e,"[external]",...t)}function or(e){return f(this,null,(function*(){let t=Mn.current();if(t)return t.videoEffect(e)}))}function cr(e){return f(this,null,(function*(){let t=Mn.current();t&&(yield t.setAudioStream(e))}))}function dr(e=null,t,n=!1){return f(this,null,(function*(){let i=Mn.current();if(!i)throw new Error("Conversation not found");return i.getWaitingHall(e,t,n)}))}function lr(e,t=!1){return f(this,null,(function*(){let n=Mn.current();if(!n)throw new Error("Conversation not found");let i=yield Xn.getOkIdsByExternalIds([e]);return n.promoteParticipant(bt.composeId(i[0],de.USER),t)}))}},406257:e=>{var t=function(){"undefined"!=typeof document&&document.currentScript&&document.currentScript.src;return function(e){var t,n,i=void 0!==(e=e||{})?e:{};i.ready=new Promise((function(e,i){t=e,n=i}));var r,a={};for(r in i)i.hasOwnProperty(r)&&(a[r]=i[r]);var s,o=[],c="";"undefined"!=typeof document&&document.currentScript&&(c=document.currentScript.src),c=0!==c.indexOf("blob:")?c.substr(0,c.lastIndexOf("/")+1):"";var d=i.print||console.log.bind(console),l=i.printErr||console.warn.bind(console);for(r in a)a.hasOwnProperty(r)&&(i[r]=a[r]);a=null,i.arguments&&(o=i.arguments),i.thisProgram&&i.thisProgram,i.quit&&i.quit;var u,p=0;i.wasmBinary&&(u=i.wasmBinary);var h;i.noExitRuntime;"object"!=typeof WebAssembly&&j("no native wasm support detected");var _=!1;var m="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function f(e,t,n){for(var i=t+n,r=t;e[r]&&!(r>=i);)++r;if(r-t>16&&e.subarray&&m)return m.decode(e.subarray(t,r));for(var a="";t<r;){var s=e[t++];if(128&s){var o=63&e[t++];if(192!=(224&s)){var c=63&e[t++];if((s=224==(240&s)?(15&s)<<12|o<<6|c:(7&s)<<18|o<<12|c<<6|63&e[t++])<65536)a+=String.fromCharCode(s);else{var d=s-65536;a+=String.fromCharCode(55296|d>>10,56320|1023&d)}}else a+=String.fromCharCode((31&s)<<6|o)}else a+=String.fromCharCode(s)}return a}function g(e,t){return e?f(E,e,t):""}var v,S,E,T,y,C,R,I,P,A="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function w(e,t){for(var n=e,i=n>>1,r=i+t/2;!(i>=r)&&y[i];)++i;if((n=i<<1)-e>32&&A)return A.decode(E.subarray(e,n));for(var a="",s=0;!(s>=t/2);++s){var o=T[e+2*s>>1];if(0==o)break;a+=String.fromCharCode(o)}return a}function O(e,t,n){if(void 0===n&&(n=2147483647),n<2)return 0;for(var i=t,r=(n-=2)<2*e.length?n/2:e.length,a=0;a<r;++a){var s=e.charCodeAt(a);T[t>>1]=s,t+=2}return T[t>>1]=0,t-i}function b(e){return 2*e.length}function D(e,t){for(var n=0,i="";!(n>=t/4);){var r=C[e+4*n>>2];if(0==r)break;if(++n,r>=65536){var a=r-65536;i+=String.fromCharCode(55296|a>>10,56320|1023&a)}else i+=String.fromCharCode(r)}return i}function N(e,t,n){if(void 0===n&&(n=2147483647),n<4)return 0;for(var i=t,r=i+n-4,a=0;a<e.length;++a){var s=e.charCodeAt(a);if(s>=55296&&s<=57343)s=65536+((1023&s)<<10)|1023&e.charCodeAt(++a);if(C[t>>2]=s,(t+=4)+4>r)break}return C[t>>2]=0,t-i}function k(e){for(var t=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);i>=55296&&i<=57343&&++n,t+=4}return t}function M(e){v=e,i.HEAP8=S=new Int8Array(e),i.HEAP16=T=new Int16Array(e),i.HEAP32=C=new Int32Array(e),i.HEAPU8=E=new Uint8Array(e),i.HEAPU16=y=new Uint16Array(e),i.HEAPU32=R=new Uint32Array(e),i.HEAPF32=I=new Float32Array(e),i.HEAPF64=P=new Float64Array(e)}i.INITIAL_MEMORY;var L,U=[],x=[],G=[];var V=0,F=null,H=null;function j(e){i.onAbort&&i.onAbort(e),l(e+=""),_=!0,1,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw n(t),t}i.preloadedImages={},i.preloadedAudios={};var B,W;function $(e){return e.startsWith("data:application/octet-stream;base64,")}function K(e){try{if(e==B&&u)return new Uint8Array(u);if(s)return s(e);throw"both async and sync fetching of the wasm failed"}catch(e){j(e)}}function q(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var n=t.func;"number"==typeof n?void 0===t.arg?L.get(n)():L.get(n)(t.arg):n(void 0===t.arg?null:t.arg)}else t(i)}}function J(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}$(B="libvpx.wasm")||(W=B,B=i.locateFile?i.locateFile(W,c):c+W);var Y=void 0;function z(e){for(var t="",n=e;E[n];)t+=Y[E[n++]];return t}var X={},Q={},Z={};function ee(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function te(e,t){return e=ee(e),function(){return t.apply(this,arguments)}}function ne(e,t){var n=te(t,(function(e){this.name=t,this.message=e;var n=new Error(e).stack;void 0!==n&&(this.stack=this.toString()+"\n"+n.replace(/^Error(:[^\n]*)?\n/,""))}));return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var ie=void 0;function re(e){throw new ie(e)}var ae=void 0;function se(e){throw new ae(e)}function oe(e,t,n){function i(t){var i=n(t);i.length!==e.length&&se("Mismatched type converter count");for(var r=0;r<e.length;++r)ce(e[r],i[r])}e.forEach((function(e){Z[e]=t}));var r=new Array(t.length),a=[],s=0;t.forEach((function(e,t){Q.hasOwnProperty(e)?r[t]=Q[e]:(a.push(e),X.hasOwnProperty(e)||(X[e]=[]),X[e].push((function(){r[t]=Q[e],++s===a.length&&i(r)})))})),0===a.length&&i(r)}function ce(e,t,n){if(n=n||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var i=t.name;if(e||re('type "'+i+'" must have a positive integer typeid pointer'),Q.hasOwnProperty(e)){if(n.ignoreDuplicateRegistrations)return;re("Cannot register type '"+i+"' twice")}if(Q[e]=t,delete Z[e],X.hasOwnProperty(e)){var r=X[e];delete X[e],r.forEach((function(e){e()}))}}function de(e){if(!(this instanceof ye))return!1;if(!(e instanceof ye))return!1;for(var t=this.$$.ptrType.registeredClass,n=this.$$.ptr,i=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)n=t.upcast(n),t=t.baseClass;for(;i.baseClass;)r=i.upcast(r),i=i.baseClass;return t===i&&n===r}function le(e){re(e.$$.ptrType.registeredClass.name+" instance already deleted")}var ue=!1;function pe(e){}function he(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function _e(e){return"undefined"==typeof FinalizationGroup?(_e=function(e){return e},e):(ue=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var n=t.value;n.ptr?he(n):console.warn("object already deleted: "+n.ptr)}})),pe=function(e){ue.unregister(e.$$)},(_e=function(e){return ue.register(e,e.$$,e.$$),e})(e))}function me(){if(this.$$.ptr||le(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=_e(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t}function fe(){this.$$.ptr||le(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&re("Object already scheduled for deletion"),pe(this),he(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function ge(){return!this.$$.ptr}var ve=void 0,Se=[];function Ee(){for(;Se.length;){var e=Se.pop();e.$$.deleteScheduled=!1,e.delete()}}function Te(){return this.$$.ptr||le(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&re("Object already scheduled for deletion"),Se.push(this),1===Se.length&&ve&&ve(Ee),this.$$.deleteScheduled=!0,this}function ye(){}var Ce={};function Re(e,t,n){if(void 0===e[t].overloadTable){var i=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||re("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[i.argCount]=i}}function Ie(e,t,n){i.hasOwnProperty(e)?((void 0===n||void 0!==i[e].overloadTable&&void 0!==i[e].overloadTable[n])&&re("Cannot register public name '"+e+"' twice"),Re(i,e,e),i.hasOwnProperty(n)&&re("Cannot register multiple overloads of a function with the same number of arguments ("+n+")!"),i[e].overloadTable[n]=t):(i[e]=t,void 0!==n&&(i[e].numArguments=n))}function Pe(e,t,n,i,r,a,s,o){this.name=e,this.constructor=t,this.instancePrototype=n,this.rawDestructor=i,this.baseClass=r,this.getActualType=a,this.upcast=s,this.downcast=o,this.pureVirtualFunctions=[]}function Ae(e,t,n){for(;t!==n;)t.upcast||re("Expected null or instance of "+n.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function we(e,t){if(null===t)return this.isReference&&re("null is not a valid "+this.name),0;t.$$||re('Cannot pass "'+st(t)+'" as a '+this.name),t.$$.ptr||re("Cannot pass deleted object as a pointer of type "+this.name);var n=t.$$.ptrType.registeredClass;return Ae(t.$$.ptr,n,this.registeredClass)}function Oe(e,t){var n;if(null===t)return this.isReference&&re("null is not a valid "+this.name),this.isSmartPointer?(n=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,n),n):0;t.$$||re('Cannot pass "'+st(t)+'" as a '+this.name),t.$$.ptr||re("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&re("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;if(n=Ae(t.$$.ptr,i,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&re("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?n=t.$$.smartPtr:re("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:n=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)n=t.$$.smartPtr;else{var r=t.clone();n=this.rawShare(n,it((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,n)}break;default:re("Unsupporting sharing policy")}return n}function be(e,t){if(null===t)return this.isReference&&re("null is not a valid "+this.name),0;t.$$||re('Cannot pass "'+st(t)+'" as a '+this.name),t.$$.ptr||re("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&re("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var n=t.$$.ptrType.registeredClass;return Ae(t.$$.ptr,n,this.registeredClass)}function De(e){return this.fromWireType(R[e>>2])}function Ne(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function ke(e){this.rawDestructor&&this.rawDestructor(e)}function Me(e){null!==e&&e.delete()}function Le(e,t,n){if(t===n)return e;if(void 0===n.baseClass)return null;var i=Le(e,t,n.baseClass);return null===i?null:n.downcast(i)}function Ue(){return Object.keys(Ve).length}function xe(){var e=[];for(var t in Ve)Ve.hasOwnProperty(t)&&e.push(Ve[t]);return e}function Ge(e){ve=e,Se.length&&ve&&ve(Ee)}var Ve={};function Fe(e,t){return t=function(e,t){for(void 0===t&&re("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),Ve[t]}function He(e,t){return t.ptrType&&t.ptr||se("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!==!!t.smartPtr&&se("Both smartPtrType and smartPtr must be specified"),t.count={value:1},_e(Object.create(e,{$$:{value:t}}))}function je(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var n=Fe(this.registeredClass,t);if(void 0!==n){if(0===n.$$.count.value)return n.$$.ptr=t,n.$$.smartPtr=e,n.clone();var i=n.clone();return this.destructor(e),i}function r(){return this.isSmartPointer?He(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):He(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var a,s=this.registeredClass.getActualType(t),o=Ce[s];if(!o)return r.call(this);a=this.isConst?o.constPointerType:o.pointerType;var c=Le(t,this.registeredClass,a.registeredClass);return null===c?r.call(this):this.isSmartPointer?He(a.registeredClass.instancePrototype,{ptrType:a,ptr:c,smartPtrType:this,smartPtr:e}):He(a.registeredClass.instancePrototype,{ptrType:a,ptr:c})}function Be(e,t,n,i,r,a,s,o,c,d,l){this.name=e,this.registeredClass=t,this.isReference=n,this.isConst=i,this.isSmartPointer=r,this.pointeeType=a,this.sharingPolicy=s,this.rawGetPointee=o,this.rawConstructor=c,this.rawShare=d,this.rawDestructor=l,r||void 0!==t.baseClass?this.toWireType=Oe:i?(this.toWireType=we,this.destructorFunction=null):(this.toWireType=be,this.destructorFunction=null)}function We(e,t,n){return e.includes("j")?function(e,t,n){var r=i["dynCall_"+e];return n&&n.length?r.apply(null,[t].concat(n)):r.call(null,t)}(e,t,n):L.get(t).apply(null,n)}function $e(e,t){var n,i,r,a=(e=z(e)).includes("j")?(n=e,i=t,r=[],function(){r.length=arguments.length;for(var e=0;e<arguments.length;e++)r[e]=arguments[e];return We(n,i,r)}):L.get(t);return"function"!=typeof a&&re("unknown function pointer with signature "+e+": "+t),a}var Ke=void 0;function qe(e){var t=mt(e),n=z(t);return ht(t),n}function Je(e,t){var n=[],i={};throw t.forEach((function e(t){i[t]||Q[t]||(Z[t]?Z[t].forEach(e):(n.push(t),i[t]=!0))})),new Ke(e+": "+n.map(qe).join([", "]))}function Ye(e,t){for(var n=[],i=0;i<e;i++)n.push(C[(t>>2)+i]);return n}function ze(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function Xe(e,t,n,i,r){var a=t.length;a<2&&re("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var s=null!==t[1]&&null!==n,o=!1,c=1;c<t.length;++c)if(null!==t[c]&&void 0===t[c].destructorFunction){o=!0;break}var d="void"!==t[0].name,l=a-2,u=new Array(l),p=[],h=[];return function(){var n;arguments.length!==l&&re("function "+e+" called with "+arguments.length+" arguments, expected "+l+" args!"),h.length=0,p.length=s?2:1,p[0]=r,s&&(n=t[1].toWireType(h,this),p[1]=n);for(var a=0;a<l;++a)u[a]=t[a+2].toWireType(h,arguments[a]),p.push(u[a]);var c=i.apply(null,p);function _(e){if(o)ze(h);else for(var i=s?1:2;i<t.length;i++){var r=1===i?n:u[i-2];null!==t[i].destructorFunction&&t[i].destructorFunction(r)}if(d)return t[0].fromWireType(e)}return _(c)}}var Qe=[],Ze=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function et(e){e>4&&0==--Ze[e].refcount&&(Ze[e]=void 0,Qe.push(e))}function tt(){for(var e=0,t=5;t<Ze.length;++t)void 0!==Ze[t]&&++e;return e}function nt(){for(var e=5;e<Ze.length;++e)if(void 0!==Ze[e])return Ze[e];return null}function it(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Qe.length?Qe.pop():Ze.length;return Ze[t]={refcount:1,value:e},t}}function rt(e,t,n){switch(t){case 0:return function(e){var t=n?S:E;return this.fromWireType(t[e])};case 1:return function(e){var t=n?T:y;return this.fromWireType(t[e>>1])};case 2:return function(e){var t=n?C:R;return this.fromWireType(t[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function at(e,t){var n=Q[e];return void 0===n&&re(t+" has unknown type "+qe(e)),n}function st(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function ot(e,t){switch(t){case 2:return function(e){return this.fromWireType(I[e>>2])};case 3:return function(e){return this.fromWireType(P[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ct(e,t,n){switch(t){case 0:return n?function(e){return S[e]}:function(e){return E[e]};case 1:return n?function(e){return T[e>>1]}:function(e){return y[e>>1]};case 2:return n?function(e){return C[e>>2]}:function(e){return R[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function dt(e){try{return h.grow(e-v.byteLength+65535>>>16),M(h.buffer),1}catch(e){}}var lt={mappings:{},buffers:[null,[],[]],printChar:function(e,t){var n=lt.buffers[e];0===t||10===t?((1===e?d:l)(f(n,0)),n.length=0):n.push(t)},varargs:void 0,get:function(){return lt.varargs+=4,C[lt.varargs-4>>2]},getStr:function(e){return g(e)},get64:function(e,t){return e}};!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);Y=e}(),ie=i.BindingError=ne(Error,"BindingError"),ae=i.InternalError=ne(Error,"InternalError"),ye.prototype.isAliasOf=de,ye.prototype.clone=me,ye.prototype.delete=fe,ye.prototype.isDeleted=ge,ye.prototype.deleteLater=Te,Be.prototype.getPointee=Ne,Be.prototype.destructor=ke,Be.prototype.argPackAdvance=8,Be.prototype.readValueFromPointer=De,Be.prototype.deleteObject=Me,Be.prototype.fromWireType=je,i.getInheritedInstanceCount=Ue,i.getLiveInheritedInstances=xe,i.flushPendingDeletes=Ee,i.setDelayFunction=Ge,Ke=i.UnboundTypeError=ne(Error,"UnboundTypeError"),i.count_emval_handles=tt,i.get_first_emval=nt;var ut,pt={y:function(e,t,n,i,r){},H:function(e,t,n,i,r){var a=J(n);ce(e,{name:t=z(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?i:r},argPackAdvance:8,readValueFromPointer:function(e){var i;if(1===n)i=S;else if(2===n)i=T;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);i=C}return this.fromWireType(i[e>>a])},destructorFunction:null})},t:function(e,t,n,r,a,s,o,c,d,l,u,p,h){u=z(u),s=$e(a,s),c&&(c=$e(o,c)),l&&(l=$e(d,l)),h=$e(p,h);var _=ee(u);Ie(_,(function(){Je("Cannot construct "+u+" due to unbound types",[r])})),oe([e,t,n],r?[r]:[],(function(t){var n,a;t=t[0],a=r?(n=t.registeredClass).instancePrototype:ye.prototype;var o=te(_,(function(){if(Object.getPrototypeOf(this)!==d)throw new ie("Use 'new' to construct "+u);if(void 0===p.constructor_body)throw new ie(u+" has no accessible constructor");var e=p.constructor_body[arguments.length];if(void 0===e)throw new ie("Tried to invoke ctor of "+u+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(p.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),d=Object.create(a,{constructor:{value:o}});o.prototype=d;var p=new Pe(u,o,d,h,n,s,c,l),m=new Be(u,p,!0,!1,!1),f=new Be(u+"*",p,!1,!1,!1),g=new Be(u+" const*",p,!1,!0,!1);return Ce[e]={pointerType:f,constPointerType:g},function(e,t,n){i.hasOwnProperty(e)||se("Replacing nonexistant public symbol"),void 0!==i[e].overloadTable&&void 0!==n?i[e].overloadTable[n]=t:(i[e]=t,i[e].argCount=n)}(_,o),[m,f,g]}))},p:function(e,t,n,i,r,a){var s;t>0||j("Assertion failed: "+s);var o=Ye(t,n);r=$e(i,r),oe([],[e],(function(e){var n="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ie("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){Je("Cannot construct "+e.name+" due to unbound types",o)},oe([],o,(function(i){return i.splice(1,0,null),e.registeredClass.constructor_body[t-1]=Xe(n,i,null,r,a),[]})),[]}))},e:function(e,t,n,i,r,a,s,o){var c=Ye(n,i);t=z(t),a=$e(r,a),oe([],[e],(function(e){var i=(e=e[0]).name+"."+t;function r(){Je("Cannot call "+i+" due to unbound types",c)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),o&&e.registeredClass.pureVirtualFunctions.push(t);var d=e.registeredClass.instancePrototype,l=d[t];return void 0===l||void 0===l.overloadTable&&l.className!==e.name&&l.argCount===n-2?(r.argCount=n-2,r.className=e.name,d[t]=r):(Re(d,t,i),d[t].overloadTable[n-2]=r),oe([],c,(function(r){var o=Xe(i,r,e,a,s);return void 0===d[t].overloadTable?(o.argCount=n-2,d[t]=o):d[t].overloadTable[n-2]=o,[]})),[]}))},G:function(e,t){ce(e,{name:t=z(t),fromWireType:function(e){var t=Ze[e].value;return et(e),t},toWireType:function(e,t){return it(t)},argPackAdvance:8,readValueFromPointer:De,destructorFunction:null})},L:function(e,t,n,i){var r=J(n);function a(){}t=z(t),a.values={},ce(e,{name:t,constructor:a,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:rt(t,r,i),destructorFunction:null}),Ie(t,a)},x:function(e,t,n){var i=at(e,"enum");t=z(t);var r=i.constructor,a=Object.create(i.constructor.prototype,{value:{value:n},constructor:{value:te(i.name+"_"+t,(function(){}))}});r.values[n]=a,r[t]=a},r:function(e,t,n){var i=J(n);ce(e,{name:t=z(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+st(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:ot(t,i),destructorFunction:null})},h:function(e,t,n,i,r){t=z(t),-1===r&&(r=4294967295);var a=J(n),s=function(e){return e};if(0===i){var o=32-8*n;s=function(e){return e<<o>>>o}}var c=t.includes("unsigned");ce(e,{name:t,fromWireType:s,toWireType:function(e,n){if("number"!=typeof n&&"boolean"!=typeof n)throw new TypeError('Cannot convert "'+st(n)+'" to '+this.name);if(n<i||n>r)throw new TypeError('Passing a number "'+st(n)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+i+", "+r+"]!");return c?n>>>0:0|n},argPackAdvance:8,readValueFromPointer:ct(t,a,0!==i),destructorFunction:null})},g:function(e,t,n){var i=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=R,n=t[e>>=2],r=t[e+1];return new i(v,r,n)}ce(e,{name:n=z(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},s:function(e,t){var n="std::string"===(t=z(t));ce(e,{name:t,fromWireType:function(e){var t,i=R[e>>2];if(n)for(var r=e+4,a=0;a<=i;++a){var s=e+4+a;if(a==i||0==E[s]){var o=g(r,s-r);void 0===t?t=o:(t+=String.fromCharCode(0),t+=o),r=s+1}}else{var c=new Array(i);for(a=0;a<i;++a)c[a]=String.fromCharCode(E[e+4+a]);t=c.join("")}return ht(e),t},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var i="string"==typeof t;i||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||re("Cannot pass non-string to std::string");var r=(n&&i?function(){return function(e){for(var t=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++n)),i<=127?++t:t+=i<=2047?2:i<=65535?3:4}return t}(t)}:function(){return t.length})(),a=_t(4+r+1);if(R[a>>2]=r,n&&i)(function(e,t,n,i){if(!(i>0))return 0;for(var r=n,a=n+i-1,s=0;s<e.length;++s){var o=e.charCodeAt(s);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++s)),o<=127){if(n>=a)break;t[n++]=o}else if(o<=2047){if(n+1>=a)break;t[n++]=192|o>>6,t[n++]=128|63&o}else if(o<=65535){if(n+2>=a)break;t[n++]=224|o>>12,t[n++]=128|o>>6&63,t[n++]=128|63&o}else{if(n+3>=a)break;t[n++]=240|o>>18,t[n++]=128|o>>12&63,t[n++]=128|o>>6&63,t[n++]=128|63&o}}t[n]=0})(t,E,a+4,r+1);else if(i)for(var s=0;s<r;++s){var o=t.charCodeAt(s);o>255&&(ht(a),re("String has UTF-16 code units that do not fit in 8 bits")),E[a+4+s]=o}else for(s=0;s<r;++s)E[a+4+s]=t[s];return null!==e&&e.push(ht,a),a},argPackAdvance:8,readValueFromPointer:De,destructorFunction:function(e){ht(e)}})},m:function(e,t,n){var i,r,a,s,o;n=z(n),2===t?(i=w,r=O,s=b,a=function(){return y},o=1):4===t&&(i=D,r=N,s=k,a=function(){return R},o=2),ce(e,{name:n,fromWireType:function(e){for(var n,r=R[e>>2],s=a(),c=e+4,d=0;d<=r;++d){var l=e+4+d*t;if(d==r||0==s[l>>o]){var u=i(c,l-c);void 0===n?n=u:(n+=String.fromCharCode(0),n+=u),c=l+t}}return ht(e),n},toWireType:function(e,i){"string"!=typeof i&&re("Cannot pass non-string to C++ string type "+n);var a=s(i),c=_t(4+a+t);return R[c>>2]=a>>o,r(i,c+4,a+t),null!==e&&e.push(ht,c),c},argPackAdvance:8,readValueFromPointer:De,destructorFunction:function(e){ht(e)}})},I:function(e,t){ce(e,{isVoid:!0,name:t=z(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},F:function(){throw"longjmp"},k:et,l:function(e){e>4&&(Ze[e].refcount+=1)},j:function(e,t){return it((e=at(e,"_emval_take_value")).readValueFromPointer(t))},E:function(){j()},C:function(e,t,n){E.copyWithin(e,t,t+n)},D:function(e){var t,n,i=E.length,r=2147483648;if((e>>>=0)>r)return!1;for(var a=1;a<=4;a*=2){var s=i*(1+.2/a);if(s=Math.min(s,e+100663296),dt(Math.min(r,((t=Math.max(e,s))%(n=65536)>0&&(t+=n-t%n),t))))return!0}return!1},q:function(e,t,n,i){for(var r=0,a=0;a<n;a++){for(var s=C[t+8*a>>2],o=C[t+(8*a+4)>>2],c=0;c<o;c++)lt.printChar(e,E[s+c]);r+=o}return C[i>>2]=r,0},a:function(){return p},f:function(e){var t=Date.now();return C[e>>2]=t/1e3|0,C[e+4>>2]=t%1e3*1e3|0,0},d:function(e,t,n){var i=ft();try{return L.get(e)(t,n)}catch(e){if(gt(i),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},n:function(e,t,n,i){var r=ft();try{return L.get(e)(t,n,i)}catch(e){if(gt(r),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},o:function(e,t,n,i,r){var a=ft();try{return L.get(e)(t,n,i,r)}catch(e){if(gt(a),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},u:function(e,t,n,i,r,a){var s=ft();try{return L.get(e)(t,n,i,r,a)}catch(e){if(gt(s),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},K:function(e,t,n,i,r,a,s,o,c){var d=ft();try{return L.get(e)(t,n,i,r,a,s,o,c)}catch(e){if(gt(d),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},B:function(e,t,n,i,r,a,s,o){var c=ft();try{return St(e,t,n,i,r,a,s,o)}catch(e){if(gt(c),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},z:function(e,t,n,i){var r=ft();try{return Tt(e,t,n,i)}catch(e){if(gt(r),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},i:function(e,t){var n=ft();try{L.get(e)(t)}catch(e){if(gt(n),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},w:function(e,t,n){var i=ft();try{L.get(e)(t,n)}catch(e){if(gt(i),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},c:function(e,t,n,i,r){var a=ft();try{L.get(e)(t,n,i,r)}catch(e){if(gt(a),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},J:function(e,t,n,i,r,a,s){var o=ft();try{L.get(e)(t,n,i,r,a,s)}catch(e){if(gt(o),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},v:function(e,t,n,i,r,a,s,o,c){var d=ft();try{L.get(e)(t,n,i,r,a,s,o,c)}catch(e){if(gt(d),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},A:function(e,t,n,i,r,a,s,o,c,d){var l=ft();try{Et(e,t,n,i,r,a,s,o,c,d)}catch(e){if(gt(l),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},b:function(e){p=e}},ht=(function(){var e={a:pt};function t(e,t){var n,r=e.exports;i.asm=r,M((h=i.asm.M).buffer),L=i.asm.Q,n=i.asm.N,x.unshift(n),function(e){if(V--,i.monitorRunDependencies&&i.monitorRunDependencies(V),0==V&&(null!==F&&(clearInterval(F),F=null),H)){var t=H;H=null,t()}}()}function r(e){t(e.instance)}function a(t){return(u||"function"!=typeof fetch?Promise.resolve().then((function(){return K(B)})):fetch(B,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+B+"'";return e.arrayBuffer()})).catch((function(){return K(B)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){l("failed to asynchronously prepare wasm: "+e),j(e)}))}if(V++,i.monitorRunDependencies&&i.monitorRunDependencies(V),i.instantiateWasm)try{return i.instantiateWasm(e,t)}catch(e){return l("Module.instantiateWasm callback failed with error: "+e),!1}(u||"function"!=typeof WebAssembly.instantiateStreaming||$(B)||"function"!=typeof fetch?a(r):fetch(B,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(r,(function(e){return l("wasm streaming compile failed: "+e),l("falling back to ArrayBuffer instantiation"),a(r)}))}))).catch(n)}(),i.___wasm_call_ctors=function(){return(i.___wasm_call_ctors=i.asm.N).apply(null,arguments)},i._free=function(){return(ht=i._free=i.asm.O).apply(null,arguments)}),_t=i._malloc=function(){return(_t=i._malloc=i.asm.P).apply(null,arguments)},mt=i.___getTypeName=function(){return(mt=i.___getTypeName=i.asm.R).apply(null,arguments)},ft=(i.___embind_register_native_and_builtin_types=function(){return(i.___embind_register_native_and_builtin_types=i.asm.S).apply(null,arguments)},i.stackSave=function(){return(ft=i.stackSave=i.asm.T).apply(null,arguments)}),gt=i.stackRestore=function(){return(gt=i.stackRestore=i.asm.U).apply(null,arguments)},vt=i._setThrew=function(){return(vt=i._setThrew=i.asm.V).apply(null,arguments)},St=i.dynCall_iiiijj=function(){return(St=i.dynCall_iiiijj=i.asm.W).apply(null,arguments)},Et=(i.dynCall_iiijiii=function(){return(i.dynCall_iiijiii=i.asm.X).apply(null,arguments)},i.dynCall_vijjjid=function(){return(Et=i.dynCall_vijjjid=i.asm.Y).apply(null,arguments)}),Tt=i.dynCall_iij=function(){return(Tt=i.dynCall_iij=i.asm.Z).apply(null,arguments)};i.dynCall_jiji=function(){return(i.dynCall_jiji=i.asm._).apply(null,arguments)};function yt(e){function n(){ut||(ut=!0,i.calledRun=!0,_||(!0,q(x),t(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),function(){if(i.postRun)for("function"==typeof i.postRun&&(i.postRun=[i.postRun]);i.postRun.length;)e=i.postRun.shift(),G.unshift(e);var e;q(G)}()))}e=e||o,V>0||(!function(){if(i.preRun)for("function"==typeof i.preRun&&(i.preRun=[i.preRun]);i.preRun.length;)e=i.preRun.shift(),U.unshift(e);var e;q(U)}(),V>0||(i.setStatus?(i.setStatus("Running..."),setTimeout((function(){setTimeout((function(){i.setStatus("")}),1),n()}),1)):n()))}if(H=function e(){ut||yt(),ut||(H=e)},i.run=yt,i.preInit)for("function"==typeof i.preInit&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return yt(),e.ready}}();e.exports=t,t.getUrl=function(e){return"https://st.mycdn.me/static/libvpx/2-0-9/"+e}},489588:(e,t,n)=>{"use strict";t.isIPadOS=t.isIPad=void 0;var i=n(279405);function r(e){e||(e=i.canUseDOM?navigator.userAgent.toLowerCase():"");var t=m(e),n=t||-1!==e.indexOf("ipad"),r=!n&&-1!==e.search(/iphone|ipod/),a=r||n,s=a&&e.match(/OS ([\d_]+) like Mac OS X/i),o=0,c=0;t?(o=13,c=0):s&&(o=+(s=s[1].split("_"))[0],c=+s[1]),s=null;var d=o<13&&!(11===o&&c<3),l=a&&function(e){if(!i.canUseDOM)return!1;var t=window.webkit;if(t&&t.messageHandlers)return!0;var n=/constructor/i.test(String(window.HTMLElement)),r=!!window.indexedDB;if(-1===e.indexOf("safari")||-1===e.indexOf("version")||navigator.standalone){if(!r&&n||!window.statusbar||!window.statusbar.visible);else if(!n||r)return!0}else;return!1}(e),u=!1;return i.canUseDOM&&(u=a&&375===screen.width&&812===screen.height&&3===window.devicePixelRatio),{isIPad:n,isIPhone:r,isIOS:a,isIPadOS:t,iosMajor:o,iosMinor:c,isWKWebView:l,isScrollBasedViewport:d,isIPhoneX:u,isIOSChrome:-1!==e.search(/crios/i)}}var a=r(),s=a.isIPad,o=a.isIPhone,c=a.isIOS,d=a.isIPadOS,l=a.iosMajor,u=a.iosMinor,p=a.isWKWebView,h=a.isScrollBasedViewport,_=a.isIPhoneX;function m(e){if(!i.canUseDOM)return!1;var t=!/ipad|iphone|ipod/.test(e);return!(!/mac os/.test(e)||!t||"boolean"!=typeof navigator.standalone)}a.isIOSChrome,t.isIPadOS=d,t.isIPad=s},279405:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.onDOMLoaded=function(e){"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)},t.canUseEventListeners=t.canUseDOM=void 0;var n=!("undefined"==typeof window||!window.document||!window.document.createElement);t.canUseDOM=n;var i=n&&!!window.addEventListener;t.canUseEventListeners=i},224736:(e,t,n)=>{var i;e=n.nmd(e);var r=function(e){"use strict";var t=1e7,n=9007199254740992,i=p(n),a="0123456789abcdefghijklmnopqrstuvwxyz",s="function"==typeof BigInt;function o(e,t,n,i){return void 0===e?o[0]:void 0!==t&&(10!=+t||n)?W(e,t,n,i):Y(e)}function c(e,t){this.value=e,this.sign=t,this.isSmall=!1}function d(e){this.value=e,this.sign=e<0,this.isSmall=!0}function l(e){this.value=e}function u(e){return-n<e&&e<n}function p(e){return e<1e7?[e]:e<1e14?[e%1e7,Math.floor(e/1e7)]:[e%1e7,Math.floor(e/1e7)%1e7,Math.floor(e/1e14)]}function h(e){_(e);var n=e.length;if(n<4&&b(e,i)<0)switch(n){case 0:return 0;case 1:return e[0];case 2:return e[0]+e[1]*t;default:return e[0]+(e[1]+e[2]*t)*t}return e}function _(e){for(var t=e.length;0===e[--t];);e.length=t+1}function m(e){for(var t=new Array(e),n=-1;++n<e;)t[n]=0;return t}function f(e){return e>0?Math.floor(e):Math.ceil(e)}function g(e,n){var i,r,a=e.length,s=n.length,o=new Array(a),c=0,d=t;for(r=0;r<s;r++)c=(i=e[r]+n[r]+c)>=d?1:0,o[r]=i-c*d;for(;r<a;)c=(i=e[r]+c)===d?1:0,o[r++]=i-c*d;return c>0&&o.push(c),o}function v(e,t){return e.length>=t.length?g(e,t):g(t,e)}function S(e,n){var i,r,a=e.length,s=new Array(a),o=t;for(r=0;r<a;r++)i=e[r]-o+n,n=Math.floor(i/o),s[r]=i-n*o,n+=1;for(;n>0;)s[r++]=n%o,n=Math.floor(n/o);return s}function E(e,n){var i,r,a=e.length,s=n.length,o=new Array(a),c=0,d=t;for(i=0;i<s;i++)(r=e[i]-c-n[i])<0?(r+=d,c=1):c=0,o[i]=r;for(i=s;i<a;i++){if(!((r=e[i]-c)<0)){o[i++]=r;break}r+=d,o[i]=r}for(;i<a;i++)o[i]=e[i];return _(o),o}function T(e,n,i){var r,a,s=e.length,o=new Array(s),l=-n,u=t;for(r=0;r<s;r++)a=e[r]+l,l=Math.floor(a/u),a%=u,o[r]=a<0?a+u:a;return"number"==typeof(o=h(o))?(i&&(o=-o),new d(o)):new c(o,i)}function y(e,n){var i,r,a,s,o=e.length,c=n.length,d=m(o+c),l=t;for(a=0;a<o;++a){s=e[a];for(var u=0;u<c;++u)i=s*n[u]+d[a+u],r=Math.floor(i/l),d[a+u]=i-r*l,d[a+u+1]+=r}return _(d),d}function C(e,n){var i,r,a=e.length,s=new Array(a),o=t,c=0;for(r=0;r<a;r++)i=e[r]*n+c,c=Math.floor(i/o),s[r]=i-c*o;for(;c>0;)s[r++]=c%o,c=Math.floor(c/o);return s}function R(e,t){for(var n=[];t-- >0;)n.push(0);return n.concat(e)}function I(e,t){var n=Math.max(e.length,t.length);if(n<=30)return y(e,t);n=Math.ceil(n/2);var i=e.slice(n),r=e.slice(0,n),a=t.slice(n),s=t.slice(0,n),o=I(r,s),c=I(i,a),d=I(v(r,i),v(s,a)),l=v(v(o,R(E(E(d,o),c),n)),R(c,2*n));return _(l),l}function P(e,n,i){return new c(e<t?C(n,e):y(n,p(e)),i)}function A(e){var n,i,r,a,s=e.length,o=m(s+s),c=t;for(r=0;r<s;r++){i=0-(a=e[r])*a;for(var d=r;d<s;d++)n=a*e[d]*2+o[r+d]+i,i=Math.floor(n/c),o[r+d]=n-i*c;o[r+s]=i}return _(o),o}function w(e,t){var n,i,r,a,s=e.length,o=m(s);for(r=0,n=s-1;n>=0;--n)r=(a=1e7*r+e[n])-(i=f(a/t))*t,o[n]=0|i;return[o,0|r]}function O(e,n){var i,r=Y(n);if(s)return[new l(e.value/r.value),new l(e.value%r.value)];var a,u=e.value,g=r.value;if(0===g)throw new Error("Cannot divide by zero");if(e.isSmall)return r.isSmall?[new d(f(u/g)),new d(u%g)]:[o[0],e];if(r.isSmall){if(1===g)return[e,o[0]];if(-1==g)return[e.negate(),o[0]];var v=Math.abs(g);if(v<t){a=h((i=w(u,v))[0]);var S=i[1];return e.sign&&(S=-S),"number"==typeof a?(e.sign!==r.sign&&(a=-a),[new d(a),new d(S)]):[new c(a,e.sign!==r.sign),new d(S)]}g=p(v)}var T=b(u,g);if(-1===T)return[o[0],e];if(0===T)return[o[e.sign===r.sign?1:-1],o[0]];a=(i=u.length+g.length<=200?function(e,n){var i,r,a,s,o,c,d,l=e.length,u=n.length,p=t,_=m(n.length),f=n[u-1],g=Math.ceil(p/(2*f)),v=C(e,g),S=C(n,g);for(v.length<=l&&v.push(0),S.push(0),f=S[u-1],r=l-u;r>=0;r--){for(i=p-1,v[r+u]!==f&&(i=Math.floor((v[r+u]*p+v[r+u-1])/f)),a=0,s=0,c=S.length,o=0;o<c;o++)a+=i*S[o],d=Math.floor(a/p),s+=v[r+o]-(a-d*p),a=d,s<0?(v[r+o]=s+p,s=-1):(v[r+o]=s,s=0);for(;0!==s;){for(i-=1,a=0,o=0;o<c;o++)(a+=v[r+o]-p+S[o])<0?(v[r+o]=a+p,a=0):(v[r+o]=a,a=1);s+=a}_[r]=i}return v=w(v,g)[0],[h(_),h(v)]}(u,g):function(e,n){for(var i,r,a,s,o,c=e.length,d=n.length,l=[],u=[],p=t;c;)if(u.unshift(e[--c]),_(u),b(u,n)<0)l.push(0);else{a=u[(r=u.length)-1]*p+u[r-2],s=n[d-1]*p+n[d-2],r>d&&(a=(a+1)*p),i=Math.ceil(a/s);do{if(b(o=C(n,i),u)<=0)break;i--}while(i);l.push(i),u=E(u,o)}return l.reverse(),[h(l),h(u)]}(u,g))[0];var y=e.sign!==r.sign,R=i[1],I=e.sign;return"number"==typeof a?(y&&(a=-a),a=new d(a)):a=new c(a,y),"number"==typeof R?(I&&(R=-R),R=new d(R)):R=new c(R,I),[a,R]}function b(e,t){if(e.length!==t.length)return e.length>t.length?1:-1;for(var n=e.length-1;n>=0;n--)if(e[n]!==t[n])return e[n]>t[n]?1:-1;return 0}function D(e){var t=e.abs();return!t.isUnit()&&(!!(t.equals(2)||t.equals(3)||t.equals(5))||!(t.isEven()||t.isDivisibleBy(3)||t.isDivisibleBy(5))&&(!!t.lesser(49)||void 0))}function N(e,t){for(var n,i,a,s=e.prev(),o=s,c=0;o.isEven();)o=o.divide(2),c++;e:for(i=0;i<t.length;i++)if(!e.lesser(t[i])&&!(a=r(t[i]).modPow(o,e)).isUnit()&&!a.equals(s)){for(n=c-1;0!=n;n--){if((a=a.square().mod(e)).isUnit())return!1;if(a.equals(s))continue e}return!1}return!0}c.prototype=Object.create(o.prototype),d.prototype=Object.create(o.prototype),l.prototype=Object.create(o.prototype),c.prototype.add=function(e){var t=Y(e);if(this.sign!==t.sign)return this.subtract(t.negate());var n=this.value,i=t.value;return t.isSmall?new c(S(n,Math.abs(i)),this.sign):new c(v(n,i),this.sign)},c.prototype.plus=c.prototype.add,d.prototype.add=function(e){var t=Y(e),n=this.value;if(n<0!==t.sign)return this.subtract(t.negate());var i=t.value;if(t.isSmall){if(u(n+i))return new d(n+i);i=p(Math.abs(i))}return new c(S(i,Math.abs(n)),n<0)},d.prototype.plus=d.prototype.add,l.prototype.add=function(e){return new l(this.value+Y(e).value)},l.prototype.plus=l.prototype.add,c.prototype.subtract=function(e){var t=Y(e);if(this.sign!==t.sign)return this.add(t.negate());var n=this.value,i=t.value;return t.isSmall?T(n,Math.abs(i),this.sign):function(e,t,n){var i;return b(e,t)>=0?i=E(e,t):(i=E(t,e),n=!n),"number"==typeof(i=h(i))?(n&&(i=-i),new d(i)):new c(i,n)}(n,i,this.sign)},c.prototype.minus=c.prototype.subtract,d.prototype.subtract=function(e){var t=Y(e),n=this.value;if(n<0!==t.sign)return this.add(t.negate());var i=t.value;return t.isSmall?new d(n-i):T(i,Math.abs(n),n>=0)},d.prototype.minus=d.prototype.subtract,l.prototype.subtract=function(e){return new l(this.value-Y(e).value)},l.prototype.minus=l.prototype.subtract,c.prototype.negate=function(){return new c(this.value,!this.sign)},d.prototype.negate=function(){var e=this.sign,t=new d(-this.value);return t.sign=!e,t},l.prototype.negate=function(){return new l(-this.value)},c.prototype.abs=function(){return new c(this.value,!1)},d.prototype.abs=function(){return new d(Math.abs(this.value))},l.prototype.abs=function(){return new l(this.value>=0?this.value:-this.value)},c.prototype.multiply=function(e){var n,i,r,a=Y(e),s=this.value,d=a.value,l=this.sign!==a.sign;if(a.isSmall){if(0===d)return o[0];if(1===d)return this;if(-1===d)return this.negate();if((n=Math.abs(d))<t)return new c(C(s,n),l);d=p(n)}return i=s.length,r=d.length,new c(-.012*i-.012*r+15e-6*i*r>0?I(s,d):y(s,d),l)},c.prototype.times=c.prototype.multiply,d.prototype._multiplyBySmall=function(e){return u(e.value*this.value)?new d(e.value*this.value):P(Math.abs(e.value),p(Math.abs(this.value)),this.sign!==e.sign)},c.prototype._multiplyBySmall=function(e){return 0===e.value?o[0]:1===e.value?this:-1===e.value?this.negate():P(Math.abs(e.value),this.value,this.sign!==e.sign)},d.prototype.multiply=function(e){return Y(e)._multiplyBySmall(this)},d.prototype.times=d.prototype.multiply,l.prototype.multiply=function(e){return new l(this.value*Y(e).value)},l.prototype.times=l.prototype.multiply,c.prototype.square=function(){return new c(A(this.value),!1)},d.prototype.square=function(){var e=this.value*this.value;return u(e)?new d(e):new c(A(p(Math.abs(this.value))),!1)},l.prototype.square=function(e){return new l(this.value*this.value)},c.prototype.divmod=function(e){var t=O(this,e);return{quotient:t[0],remainder:t[1]}},l.prototype.divmod=d.prototype.divmod=c.prototype.divmod,c.prototype.divide=function(e){return O(this,e)[0]},l.prototype.over=l.prototype.divide=function(e){return new l(this.value/Y(e).value)},d.prototype.over=d.prototype.divide=c.prototype.over=c.prototype.divide,c.prototype.mod=function(e){return O(this,e)[1]},l.prototype.mod=l.prototype.remainder=function(e){return new l(this.value%Y(e).value)},d.prototype.remainder=d.prototype.mod=c.prototype.remainder=c.prototype.mod,c.prototype.pow=function(e){var t,n,i,r=Y(e),a=this.value,s=r.value;if(0===s)return o[1];if(0===a)return o[0];if(1===a)return o[1];if(-1===a)return r.isEven()?o[1]:o[-1];if(r.sign)return o[0];if(!r.isSmall)throw new Error("The exponent "+r.toString()+" is too large.");if(this.isSmall&&u(t=Math.pow(a,s)))return new d(f(t));for(n=this,i=o[1];!0&s&&(i=i.times(n),--s),0!==s;)s/=2,n=n.square();return i},d.prototype.pow=c.prototype.pow,l.prototype.pow=function(e){var t=Y(e),n=this.value,i=t.value,r=BigInt(0),a=BigInt(1),s=BigInt(2);if(i===r)return o[1];if(n===r)return o[0];if(n===a)return o[1];if(n===BigInt(-1))return t.isEven()?o[1]:o[-1];if(t.isNegative())return new l(r);for(var c=this,d=o[1];(i&a)===a&&(d=d.times(c),--i),i!==r;)i/=s,c=c.square();return d},c.prototype.modPow=function(e,t){if(e=Y(e),(t=Y(t)).isZero())throw new Error("Cannot take modPow with modulus 0");var n=o[1],i=this.mod(t);for(e.isNegative()&&(e=e.multiply(o[-1]),i=i.modInv(t));e.isPositive();){if(i.isZero())return o[0];e.isOdd()&&(n=n.multiply(i).mod(t)),e=e.divide(2),i=i.square().mod(t)}return n},l.prototype.modPow=d.prototype.modPow=c.prototype.modPow,c.prototype.compareAbs=function(e){var t=Y(e),n=this.value,i=t.value;return t.isSmall?1:b(n,i)},d.prototype.compareAbs=function(e){var t=Y(e),n=Math.abs(this.value),i=t.value;return t.isSmall?n===(i=Math.abs(i))?0:n>i?1:-1:-1},l.prototype.compareAbs=function(e){var t=this.value,n=Y(e).value;return(t=t>=0?t:-t)===(n=n>=0?n:-n)?0:t>n?1:-1},c.prototype.compare=function(e){if(e===1/0)return-1;if(e===-1/0)return 1;var t=Y(e),n=this.value,i=t.value;return this.sign!==t.sign?t.sign?1:-1:t.isSmall?this.sign?-1:1:b(n,i)*(this.sign?-1:1)},c.prototype.compareTo=c.prototype.compare,d.prototype.compare=function(e){if(e===1/0)return-1;if(e===-1/0)return 1;var t=Y(e),n=this.value,i=t.value;return t.isSmall?n==i?0:n>i?1:-1:n<0!==t.sign?n<0?-1:1:n<0?1:-1},d.prototype.compareTo=d.prototype.compare,l.prototype.compare=function(e){if(e===1/0)return-1;if(e===-1/0)return 1;var t=this.value,n=Y(e).value;return t===n?0:t>n?1:-1},l.prototype.compareTo=l.prototype.compare,c.prototype.equals=function(e){return 0===this.compare(e)},l.prototype.eq=l.prototype.equals=d.prototype.eq=d.prototype.equals=c.prototype.eq=c.prototype.equals,c.prototype.notEquals=function(e){return 0!==this.compare(e)},l.prototype.neq=l.prototype.notEquals=d.prototype.neq=d.prototype.notEquals=c.prototype.neq=c.prototype.notEquals,c.prototype.greater=function(e){return this.compare(e)>0},l.prototype.gt=l.prototype.greater=d.prototype.gt=d.prototype.greater=c.prototype.gt=c.prototype.greater,c.prototype.lesser=function(e){return this.compare(e)<0},l.prototype.lt=l.prototype.lesser=d.prototype.lt=d.prototype.lesser=c.prototype.lt=c.prototype.lesser,c.prototype.greaterOrEquals=function(e){return this.compare(e)>=0},l.prototype.geq=l.prototype.greaterOrEquals=d.prototype.geq=d.prototype.greaterOrEquals=c.prototype.geq=c.prototype.greaterOrEquals,c.prototype.lesserOrEquals=function(e){return this.compare(e)<=0},l.prototype.leq=l.prototype.lesserOrEquals=d.prototype.leq=d.prototype.lesserOrEquals=c.prototype.leq=c.prototype.lesserOrEquals,c.prototype.isEven=function(){return 0==(1&this.value[0])},d.prototype.isEven=function(){return 0==(1&this.value)},l.prototype.isEven=function(){return(this.value&BigInt(1))===BigInt(0)},c.prototype.isOdd=function(){return 1==(1&this.value[0])},d.prototype.isOdd=function(){return 1==(1&this.value)},l.prototype.isOdd=function(){return(this.value&BigInt(1))===BigInt(1)},c.prototype.isPositive=function(){return!this.sign},d.prototype.isPositive=function(){return this.value>0},l.prototype.isPositive=d.prototype.isPositive,c.prototype.isNegative=function(){return this.sign},d.prototype.isNegative=function(){return this.value<0},l.prototype.isNegative=d.prototype.isNegative,c.prototype.isUnit=function(){return!1},d.prototype.isUnit=function(){return 1===Math.abs(this.value)},l.prototype.isUnit=function(){return this.abs().value===BigInt(1)},c.prototype.isZero=function(){return!1},d.prototype.isZero=function(){return 0===this.value},l.prototype.isZero=function(){return this.value===BigInt(0)},c.prototype.isDivisibleBy=function(e){var t=Y(e);return!t.isZero()&&(!!t.isUnit()||(0===t.compareAbs(2)?this.isEven():this.mod(t).isZero()))},l.prototype.isDivisibleBy=d.prototype.isDivisibleBy=c.prototype.isDivisibleBy,c.prototype.isPrime=function(t){var n=D(this);if(n!==e)return n;var i=this.abs(),a=i.bitLength();if(a<=64)return N(i,[2,3,5,7,11,13,17,19,23,29,31,37]);for(var s=Math.log(2)*a.toJSNumber(),o=Math.ceil(!0===t?2*Math.pow(s,2):s),c=[],d=0;d<o;d++)c.push(r(d+2));return N(i,c)},l.prototype.isPrime=d.prototype.isPrime=c.prototype.isPrime,c.prototype.isProbablePrime=function(t,n){var i=D(this);if(i!==e)return i;for(var a=this.abs(),s=t===e?5:t,o=[],c=0;c<s;c++)o.push(r.randBetween(2,a.minus(2),n));return N(a,o)},l.prototype.isProbablePrime=d.prototype.isProbablePrime=c.prototype.isProbablePrime,c.prototype.modInv=function(e){for(var t,n,i,a=r.zero,s=r.one,o=Y(e),c=this.abs();!c.isZero();)t=o.divide(c),n=a,i=o,a=s,o=c,s=n.subtract(t.multiply(s)),c=i.subtract(t.multiply(c));if(!o.isUnit())throw new Error(this.toString()+" and "+e.toString()+" are not co-prime");return-1===a.compare(0)&&(a=a.add(e)),this.isNegative()?a.negate():a},l.prototype.modInv=d.prototype.modInv=c.prototype.modInv,c.prototype.next=function(){var e=this.value;return this.sign?T(e,1,this.sign):new c(S(e,1),this.sign)},d.prototype.next=function(){var e=this.value;return e+1<n?new d(e+1):new c(i,!1)},l.prototype.next=function(){return new l(this.value+BigInt(1))},c.prototype.prev=function(){var e=this.value;return this.sign?new c(S(e,1),!0):T(e,1,this.sign)},d.prototype.prev=function(){var e=this.value;return e-1>-n?new d(e-1):new c(i,!0)},l.prototype.prev=function(){return new l(this.value-BigInt(1))};for(var k=[1];2*k[k.length-1]<=t;)k.push(2*k[k.length-1]);var M=k.length,L=k[M-1];function U(e){return Math.abs(e)<=t}function x(e,t,n){t=Y(t);for(var i=e.isNegative(),a=t.isNegative(),s=i?e.not():e,o=a?t.not():t,c=0,d=0,l=null,u=null,p=[];!s.isZero()||!o.isZero();)c=(l=O(s,L))[1].toJSNumber(),i&&(c=L-1-c),d=(u=O(o,L))[1].toJSNumber(),a&&(d=L-1-d),s=l[0],o=u[0],p.push(n(c,d));for(var h=0!==n(i?1:0,a?1:0)?r(-1):r(0),_=p.length-1;_>=0;_-=1)h=h.multiply(L).add(r(p[_]));return h}c.prototype.shiftLeft=function(e){var t=Y(e).toJSNumber();if(!U(t))throw new Error(String(t)+" is too large for shifting.");if(t<0)return this.shiftRight(-t);var n=this;if(n.isZero())return n;for(;t>=M;)n=n.multiply(L),t-=M-1;return n.multiply(k[t])},l.prototype.shiftLeft=d.prototype.shiftLeft=c.prototype.shiftLeft,c.prototype.shiftRight=function(e){var t,n=Y(e).toJSNumber();if(!U(n))throw new Error(String(n)+" is too large for shifting.");if(n<0)return this.shiftLeft(-n);for(var i=this;n>=M;){if(i.isZero()||i.isNegative()&&i.isUnit())return i;i=(t=O(i,L))[1].isNegative()?t[0].prev():t[0],n-=M-1}return(t=O(i,k[n]))[1].isNegative()?t[0].prev():t[0]},l.prototype.shiftRight=d.prototype.shiftRight=c.prototype.shiftRight,c.prototype.not=function(){return this.negate().prev()},l.prototype.not=d.prototype.not=c.prototype.not,c.prototype.and=function(e){return x(this,e,(function(e,t){return e&t}))},l.prototype.and=d.prototype.and=c.prototype.and,c.prototype.or=function(e){return x(this,e,(function(e,t){return e|t}))},l.prototype.or=d.prototype.or=c.prototype.or,c.prototype.xor=function(e){return x(this,e,(function(e,t){return e^t}))},l.prototype.xor=d.prototype.xor=c.prototype.xor;var G=1<<30;function V(e){var n=e.value,i="number"==typeof n?n|G:"bigint"==typeof n?n|BigInt(G):n[0]+n[1]*t|1073758208;return i&-i}function F(e,t){if(t.compareTo(e)<=0){var n=F(e,t.square(t)),i=n.p,a=n.e,s=i.multiply(t);return s.compareTo(e)<=0?{p:s,e:2*a+1}:{p:i,e:2*a}}return{p:r(1),e:0}}function H(e,t){return e=Y(e),t=Y(t),e.greater(t)?e:t}function j(e,t){return e=Y(e),t=Y(t),e.lesser(t)?e:t}function B(e,t){if(e=Y(e).abs(),t=Y(t).abs(),e.equals(t))return e;if(e.isZero())return t;if(t.isZero())return e;for(var n,i,r=o[1];e.isEven()&&t.isEven();)n=j(V(e),V(t)),e=e.divide(n),t=t.divide(n),r=r.multiply(n);for(;e.isEven();)e=e.divide(V(e));do{for(;t.isEven();)t=t.divide(V(t));e.greater(t)&&(i=t,t=e,e=i),t=t.subtract(e)}while(!t.isZero());return r.isUnit()?e:e.multiply(r)}c.prototype.bitLength=function(){var e=this;return e.compareTo(r(0))<0&&(e=e.negate().subtract(r(1))),0===e.compareTo(r(0))?r(0):r(F(e,r(2)).e).add(r(1))},l.prototype.bitLength=d.prototype.bitLength=c.prototype.bitLength;var W=function(e,t,n,i){n=n||a,e=String(e),i||(e=e.toLowerCase(),n=n.toLowerCase());var r,s=e.length,o=Math.abs(t),c={};for(r=0;r<n.length;r++)c[n[r]]=r;for(r=0;r<s;r++){if("-"!==(u=e[r])&&(u in c&&c[u]>=o)){if("1"===u&&1===o)continue;throw new Error(u+" is not a valid digit in base "+t+".")}}t=Y(t);var d=[],l="-"===e[0];for(r=l?1:0;r<e.length;r++){var u;if((u=e[r])in c)d.push(Y(c[u]));else{if("<"!==u)throw new Error(u+" is not a valid character");var p=r;do{r++}while(">"!==e[r]&&r<e.length);d.push(Y(e.slice(p+1,r)))}}return $(d,t,l)};function $(e,t,n){var i,r=o[0],a=o[1];for(i=e.length-1;i>=0;i--)r=r.add(e[i].times(a)),a=a.times(t);return n?r.negate():r}function K(e,t){if((t=r(t)).isZero()){if(e.isZero())return{value:[0],isNegative:!1};throw new Error("Cannot convert nonzero numbers to base 0.")}if(t.equals(-1)){if(e.isZero())return{value:[0],isNegative:!1};if(e.isNegative())return{value:[].concat.apply([],Array.apply(null,Array(-e.toJSNumber())).map(Array.prototype.valueOf,[1,0])),isNegative:!1};var n=Array.apply(null,Array(e.toJSNumber()-1)).map(Array.prototype.valueOf,[0,1]);return n.unshift([1]),{value:[].concat.apply([],n),isNegative:!1}}var i=!1;if(e.isNegative()&&t.isPositive()&&(i=!0,e=e.abs()),t.isUnit())return e.isZero()?{value:[0],isNegative:!1}:{value:Array.apply(null,Array(e.toJSNumber())).map(Number.prototype.valueOf,1),isNegative:i};for(var a,s=[],o=e;o.isNegative()||o.compareAbs(t)>=0;){a=o.divmod(t),o=a.quotient;var c=a.remainder;c.isNegative()&&(c=t.minus(c).abs(),o=o.next()),s.push(c.toJSNumber())}return s.push(o.toJSNumber()),{value:s.reverse(),isNegative:i}}function q(e,t,n){var i=K(e,t);return(i.isNegative?"-":"")+i.value.map((function(e){return function(e,t){return e<(t=t||a).length?t[e]:"<"+e+">"}(e,n)})).join("")}function J(e){if(u(+e)){var t=+e;if(t===f(t))return s?new l(BigInt(t)):new d(t);throw new Error("Invalid integer: "+e)}var n="-"===e[0];n&&(e=e.slice(1));var i=e.split(/e/i);if(i.length>2)throw new Error("Invalid integer: "+i.join("e"));if(2===i.length){var r=i[1];if("+"===r[0]&&(r=r.slice(1)),(r=+r)!==f(r)||!u(r))throw new Error("Invalid integer: "+r+" is not a valid exponent.");var a=i[0],o=a.indexOf(".");if(o>=0&&(r-=a.length-o-1,a=a.slice(0,o)+a.slice(o+1)),r<0)throw new Error("Cannot include negative exponent part for integers");e=a+=new Array(r+1).join("0")}if(!/^([0-9][0-9]*)$/.test(e))throw new Error("Invalid integer: "+e);if(s)return new l(BigInt(n?"-"+e:e));for(var p=[],h=e.length,m=h-7;h>0;)p.push(+e.slice(m,h)),(m-=7)<0&&(m=0),h-=7;return _(p),new c(p,n)}function Y(e){return"number"==typeof e?function(e){if(s)return new l(BigInt(e));if(u(e)){if(e!==f(e))throw new Error(e+" is not an integer.");return new d(e)}return J(e.toString())}(e):"string"==typeof e?J(e):"bigint"==typeof e?new l(e):e}c.prototype.toArray=function(e){return K(this,e)},d.prototype.toArray=function(e){return K(this,e)},l.prototype.toArray=function(e){return K(this,e)},c.prototype.toString=function(t,n){if(t===e&&(t=10),10!==t)return q(this,t,n);for(var i,r=this.value,a=r.length,s=String(r[--a]);--a>=0;)i=String(r[a]),s+="0000000".slice(i.length)+i;return(this.sign?"-":"")+s},d.prototype.toString=function(t,n){return t===e&&(t=10),10!=t?q(this,t,n):String(this.value)},l.prototype.toString=d.prototype.toString,l.prototype.toJSON=c.prototype.toJSON=d.prototype.toJSON=function(){return this.toString()},c.prototype.valueOf=function(){return parseInt(this.toString(),10)},c.prototype.toJSNumber=c.prototype.valueOf,d.prototype.valueOf=function(){return this.value},d.prototype.toJSNumber=d.prototype.valueOf,l.prototype.valueOf=l.prototype.toJSNumber=function(){return parseInt(this.toString(),10)};for(var z=0;z<1e3;z++)o[z]=Y(z),z>0&&(o[-z]=Y(-z));return o.one=o[1],o.zero=o[0],o.minusOne=o[-1],o.max=H,o.min=j,o.gcd=B,o.lcm=function(e,t){return e=Y(e).abs(),t=Y(t).abs(),e.divide(B(e,t)).multiply(t)},o.isInstance=function(e){return e instanceof c||e instanceof d||e instanceof l},o.randBetween=function(e,n,i){e=Y(e),n=Y(n);var r=i||Math.random,a=j(e,n),s=H(e,n).subtract(a).add(1);if(s.isSmall)return a.add(Math.floor(r()*s));for(var c=K(s,t).value,d=[],l=!0,u=0;u<c.length;u++){var p=l?c[u]:t,h=f(r()*p);d.push(h),h<p&&(l=!1)}return a.add(o.fromArray(d,t,!1))},o.fromArray=function(e,t,n){return $(e.map(Y),Y(t||10),n)},o}();e.hasOwnProperty("exports")&&(e.exports=r),void 0===(i=function(){return r}.call(t,n,t,e))||(e.exports=i)},535557:(e,t,n)=>{"use strict";function i(e,t){throw new TypeError(`unexpected tag 0x${e.toString(16)} (${t} expected)`)}function r(e){return 127&e}function a(e){return 0==(128&e)}function s(e){return 224==(224&e)}function o(e){return 160==(224&e)}function c(e){return 144==(240&e)}function d(e){return 128==(240&e)}function l(e,t,n){const i=t.byteLength;if(i<=255)e.putUi8(n),e.putUi8(i);else if(i<=65535)e.putUi8(n+1),e.putUi16(i);else{if(!(i<=4294967295))throw new RangeError("length limit exceeded");e.putUi8(n+2),e.putUi32(i)}e.put(t)}function u(e){const t=e.getUi8();let n;switch(t){case 192:n=0;break;case 196:case 217:n=e.getUi8();break;case 197:case 218:n=e.getUi16();break;case 198:case 219:n=e.getUi32();break;default:o(t)||i(t,"bytes or string"),n=function(e){return 31&e}(t)}return e.get(n)}function p(e,t){t<16?e.putUi8(144|15&t):f(e,220,t)}function h(e,t){const n=e.getUi8(),i=c(n)?function(e){return 15&e}(n):g(e,n,220,"array");if(null!=t&&i!==t)throw new Error(`invalid array header size ${i}`);return i}function _(e,t){t<16?e.putUi8(128|15&t):f(e,222,t)}function m(e,t){const n=e.getUi8(),i=d(n)?function(e){return 15&e}(n):g(e,n,222,"map");if(null!=t&&i!==t)throw new Error(`invalid map header size ${i}`);return i}function f(e,t,n){if(n<=65535)e.putUi8(t),e.putUi16(n);else{if(!(n<=4294967295))throw new RangeError("length limit exceeded");e.putUi8(t+1),e.putUi32(n)}}function g(e,t,n,r){switch(t){case 192:return 0;case n:return e.getUi16();case n+1:return e.getUi32();default:i(t,r)}}n.d(t,{decode:()=>b});const v={enc(e,t){(function(e){switch(typeof e){case"undefined":return S;case"boolean":return E;case"number":return isFinite(e)&&Math.floor(e)===e?e<0?T:y:C;case"string":return I;case"object":return null===e?S:Array.isArray(e)?A:e instanceof Uint8Array||e instanceof ArrayBuffer?R:e instanceof Date?P:O;default:throw new TypeError("unsupported type "+typeof e)}})(t).enc(e,t)},dec:e=>function(e){switch(e){case 192:return S;case 194:case 195:return E;case 208:case 209:case 210:case 211:return T;case 204:case 205:case 206:case 207:return y;case 202:case 203:return C;case 196:case 197:case 198:return R;case 217:case 218:case 219:return I;case 220:case 221:return A;case 222:case 223:return O;case 214:case 215:case 199:return P;default:if(a(e)||s(e))return T;if(o(e))return I;if(c(e))return A;if(d(e))return O;throw new TypeError(`unsupported tag ${e}`)}}(e.peek()).dec(e)},S={enc(e,t){e.putUi8(192)},dec(e){const t=e.getUi8();return 192!==t&&i(t,"nil"),null}},E={enc(e,t){e.putUi8(t?195:194)},dec(e){const t=e.getUi8();switch(t){case 192:case 194:return!1;case 195:return!0;default:i(t,"bool")}}},T={enc(e,t){-128<=t&&t<=127?t>=0?e.putUi8(r(t)):t>-32?e.putUi8(224|31&t):(e.putUi8(208),e.putUi8(t)):-32768<=t&&t<=32767?(e.putI8(209),e.putI16(t)):-2147483648<=t&&t<=2147483647?(e.putI8(210),e.putI32(t)):(e.putI8(211),e.putI64(t))},dec(e){const t=e.getUi8();if(a(t))return function(e){return 127&e}(t);if(s(t))return function(e){return e-256}(t);switch(t){case 192:return 0;case 208:return e.getI8();case 209:return e.getI16();case 210:return e.getI32();case 211:return e.getI64();case 204:return e.getUi8();case 205:return e.getUi16();case 206:return e.getUi32();case 207:return e.getUi64();default:i(t,"int")}}},y={enc(e,t){if(t<0)throw new Error(`not an uint: ${t}`);t<=127?e.putUi8(r(t)):t<=255?(e.putUi8(204),e.putUi8(t)):t<=65535?(e.putUi8(205),e.putUi16(t)):t<=4294967295?(e.putUi8(206),e.putUi32(t)):(e.putUi8(207),e.putUi64(t))},dec(e){const t=T.dec(e);if(t<0)throw new RangeError("uint underflow");return t}},C={enc(e,t){e.putUi8(203),e.putF(t)},dec(e){const t=e.getUi8();switch(t){case 192:return 0;case 202:return e.getF32();case 203:return e.getF64();default:i(t,"float")}}},R={enc(e,t){l(e,t,196)},dec:u},I={enc(e,t){const n=function(e){const t=e.length,n=new Uint8Array(4*t);let i,r=0,a=0;for(;a<t;)i=e.charCodeAt(a++),55296==(64512&i)&&(i=(i<<10)+e.charCodeAt(a++)-56613888),i<128?n[r++]=i:i<2048?(n[r++]=192+(i>>6),n[r++]=128+(63&i)):i<65536?(n[r++]=224+(i>>12),n[r++]=128+(i>>6&63),n[r++]=128+(63&i)):(n[r++]=240+(i>>18),n[r++]=128+(i>>12&63),n[r++]=128+(i>>6&63),n[r++]=128+(63&i));return n.buffer.slice(0,r)}(t);n.byteLength<32?(e.putUi8(160|31&n.byteLength),e.put(n)):l(e,n,217)},dec:e=>function(e){return new TextDecoder("utf-8").decode(e)}(u(e))},P={enc(e,t){const n=t.getTime();e.putUi8(199),e.putUi8(12),e.putI8(-1),e.putUi32(n%1e3*1e6),e.putI64(n/1e3)},dec(e){const t=e.getUi8();switch(t){case 214:if(-1===e.getI8())return new Date(1e3*e.getUi32());break;case 215:if(-1===e.getI8()){const t=e.getUi32(),n=e.getUi32();return new Date(1e3*(n+4294967296*(3&t))+t/4e6)}break;case 199:if(12===e.getUi8()&&-1===e.getI8()){const t=e.getUi32(),n=e.getI64();return new Date(1e3*n+t/1e6)}}i(t,"time")}},A=(w=v,{encHeader:p,decHeader:h,enc(e,t){p(e,t.length),t.forEach((t=>w.enc(e,t)))},dec(e){const t=[];for(let n=h(e);n>0;--n)t.push(w.dec(e));return t}});var w;const O=function(e,t){return{encHeader:_,decHeader:m,enc(n,i){const r=Object.keys(i);_(n,r.length),r.forEach((r=>{e.enc(n,r),t.enc(n,i[r])}))},dec(n){const i={};for(let r=m(n);r>0;--r){i[e.dec(n)]=t.dec(n)}return i}}}(v,v);function b(e,t){return(t||v).dec(function(e){let t=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),n=0;return{peek:()=>t.getUint8(n),get(e){n+=e;const i=t.byteOffset;return t.buffer.slice(i+n-e,i+n)},getI8:()=>t.getInt8(n++),getI16:()=>(n+=2,t.getInt16(n-2)),getI32:()=>(n+=4,t.getInt32(n-4)),getI64:()=>(n+=8,4294967296*t.getInt32(n-8)+t.getUint32(n-4)),getUi8:()=>t.getUint8(n++),getUi16:()=>(n+=2,t.getUint16(n-2)),getUi32:()=>(n+=4,t.getUint32(n-4)),getUi64:()=>(n+=8,4294967296*t.getUint32(n-8)+t.getUint32(n-4)),getF32:()=>(n+=4,t.getFloat32(n-4)),getF64:()=>(n+=8,t.getFloat64(n-8))}}(e))}},762539:(e,t,n)=>{"use strict";var i=n(857539);function r(e,t,n,r,a){var s=i.writeRtpDescription(e.kind,t);if(s+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":a||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var c="msid:"+(r?r.id:"-")+" "+o+"\r\n";s+="a="+c,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),s}function a(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},r=function(e,t,n,r){var a=i(e.parameters.apt,n),s=i(t.parameters.apt,r);return a&&s&&a.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(i){for(var a=0;a<t.codecs.length;a++){var s=t.codecs[a];if(i.name.toLowerCase()===s.name.toLowerCase()&&i.clockRate===s.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&s.parameters.apt&&!r(i,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(i.numChannels,s.numChannels),n.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var i=0;i<t.headerExtensions.length;i++){var r=t.headerExtensions[i];if(e.uri===r.uri){n.headerExtensions.push(r);break}}})),n}function s(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function o(e,t){var n=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return n||e.addRemoteCandidate(t),!n}function c(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}e.exports=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function d(t,n,i,r){var a=new Event("track");a.track=n,a.receiver=i,a.transceiver={receiver:i},a.streams=r,e.setTimeout((function(){t._dispatchEvent("track",a)}))}var l=function(n){var r=this,a=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){r[e]=a[e].bind(a)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=function(e,t){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var r="string"==typeof i;return r&&(i=[i]),i=i.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(n=!0,!0)})),delete e.url,e.urls=r?i[0]:i,!!i.length}}))}(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var s=n.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=i.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var n=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();i.iceTransport=r.iceTransport,i.dtlsTransport=r.dtlsTransport}return t||this.transceivers.push(i),i},l.prototype.addTrack=function(t,n){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var r=0;r<this.transceivers.length;r++)this.transceivers[r].track||this.transceivers[r].kind!==t.kind||(i=this.transceivers[r]);return i||(i=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),i.track=t,i.stream=n,i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport),i.rtpSender},l.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach((function(t){n.addTrack(t,e)}));else{var i=e.clone();e.getTracks().forEach((function(e,t){var n=i.getTracks()[t];e.addEventListener("enabled",(function(e){n.enabled=e.enabled}))})),i.getTracks().forEach((function(e){n.addTrack(e,i)}))}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find((function(e){return e.rtpSender===t}));if(!n)throw c("InvalidAccessError","Sender was not created by this connection.");var i=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var n=t.getSenders().find((function(t){return t.track===e}));n&&t.removeTrack(n)}))},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,n){var i=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;r.state=n?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},r.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),r},l.prototype._gather=function(t,n){var r=this,a=this.transceivers[n].iceGatherer;if(!a.onlocalcandidate){var s=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,a.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),a.onlocalcandidate=function(e){if(!(r.usingBundle&&n>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:n};var o=e.candidate,c=!o||0===Object.keys(o).length;if(c)"new"!==a.state&&"gathering"!==a.state||(a.state="completed");else{"new"===a.state&&(a.state="gathering"),o.component=1,o.ufrag=a.getLocalParameters().usernameFragment;var d=i.writeCandidate(o);s.candidate=Object.assign(s.candidate,i.parseCandidate(d)),s.candidate.candidate=d,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var l=i.getMediaSections(r._localDescription.sdp);l[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",r._localDescription.sdp=i.getDescription(r._localDescription.sdp)+l.join("");var u=r.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),c||r._dispatchEvent("icecandidate",s),u&&(r._dispatchEvent("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange())}},e.setTimeout((function(){s.forEach((function(e){a.onlocalcandidate(e)}))}),0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(n);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:i}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,n,r){var s=a(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:i.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),r&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},l.prototype.setLocalDescription=function(e){var t,n,r=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,r.signalingState)||r._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+r.signalingState));if("offer"===e.type)t=i.splitSections(e.sdp),n=t.shift(),t.forEach((function(e,t){var n=i.parseRtpParameters(e);r.transceivers[t].localCapabilities=n})),r.transceivers.forEach((function(e,t){r._gather(e.mid,t)}));else if("answer"===e.type){t=i.splitSections(r._remoteDescription.sdp),n=t.shift();var o=i.matchPrefix(n,"a=ice-lite").length>0;t.forEach((function(e,t){var s=r.transceivers[t],c=s.iceGatherer,d=s.iceTransport,l=s.dtlsTransport,u=s.localCapabilities,p=s.remoteCapabilities;if(!(i.isRejected(e)&&0===i.matchPrefix(e,"a=bundle-only").length)&&!s.rejected){var h=i.getIceParameters(e,n),_=i.getDtlsParameters(e,n);o&&(_.role="server"),r.usingBundle&&0!==t||(r._gather(s.mid,t),"new"===d.state&&d.start(c,h,o?"controlling":"controlled"),"new"===l.state&&l.start(_));var m=a(u,p);r._transceive(s,m.codecs.length>0,!1)}}))}return r._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?r._updateSignalingState("have-local-offer"):r._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(r){var l=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(c("TypeError",'Unsupported type "'+r.type+'"'));if(!s("setRemoteDescription",r.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+r.type+" in state "+l.signalingState));var u={};l.remoteStreams.forEach((function(e){u[e.id]=e}));var p=[],h=i.splitSections(r.sdp),_=h.shift(),m=i.matchPrefix(_,"a=ice-lite").length>0,f=i.matchPrefix(_,"a=group:BUNDLE ").length>0;l.usingBundle=f;var g=i.matchPrefix(_,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!g&&g.substr(14).split(" ").indexOf("trickle")>=0,h.forEach((function(s,c){var d=i.splitLines(s),h=i.getKind(s),g=i.isRejected(s)&&0===i.matchPrefix(s,"a=bundle-only").length,v=d[0].substr(2).split(" ")[2],S=i.getDirection(s,_),E=i.parseMsid(s),T=i.getMid(s)||i.generateIdentifier();if(g||"application"===h&&("DTLS/SCTP"===v||"UDP/DTLS/SCTP"===v))l.transceivers[c]={mid:T,kind:h,protocol:v,rejected:!0};else{var y,C,R,I,P,A,w,O,b;!g&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(h,!0));var D,N,k=i.parseRtpParameters(s);g||(D=i.getIceParameters(s,_),(N=i.getDtlsParameters(s,_)).role="client"),w=i.parseRtpEncodingParameters(s);var M=i.parseRtcpParameters(s),L=i.matchPrefix(s,"a=end-of-candidates",_).length>0,U=i.matchPrefix(s,"a=candidate:").map((function(e){return i.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===r.type||"answer"===r.type)&&!g&&f&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==r.type||g){if("answer"===r.type&&!g){C=(y=l.transceivers[c]).iceGatherer,R=y.iceTransport,I=y.dtlsTransport,P=y.rtpReceiver,A=y.sendEncodingParameters,O=y.localCapabilities,l.transceivers[c].recvEncodingParameters=w,l.transceivers[c].remoteCapabilities=k,l.transceivers[c].rtcpParameters=M,U.length&&"new"===R.state&&(!m&&!L||f&&0!==c?U.forEach((function(e){o(y.iceTransport,e)})):R.setRemoteCandidates(U)),f&&0!==c||("new"===R.state&&R.start(C,D,"controlling"),"new"===I.state&&I.start(N)),!a(y.localCapabilities,y.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&y.sendEncodingParameters[0].rtx&&delete y.sendEncodingParameters[0].rtx,l._transceive(y,"sendrecv"===S||"recvonly"===S,"sendrecv"===S||"sendonly"===S),!P||"sendrecv"!==S&&"sendonly"!==S?delete y.rtpReceiver:(b=P.track,E?(u[E.stream]||(u[E.stream]=new e.MediaStream),n(b,u[E.stream]),p.push([b,P,u[E.stream]])):(u.default||(u.default=new e.MediaStream),n(b,u.default),p.push([b,P,u.default])))}}else{(y=l.transceivers[c]||l._createTransceiver(h)).mid=T,y.iceGatherer||(y.iceGatherer=l._createIceGatherer(c,f)),U.length&&"new"===y.iceTransport.state&&(!L||f&&0!==c?U.forEach((function(e){o(y.iceTransport,e)})):y.iceTransport.setRemoteCandidates(U)),O=e.RTCRtpReceiver.getCapabilities(h),t<15019&&(O.codecs=O.codecs.filter((function(e){return"rtx"!==e.name}))),A=y.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var x,G=!1;if("sendrecv"===S||"sendonly"===S){if(G=!y.rtpReceiver,P=y.rtpReceiver||new e.RTCRtpReceiver(y.dtlsTransport,h),G)b=P.track,E&&"-"===E.stream||(E?(u[E.stream]||(u[E.stream]=new e.MediaStream,Object.defineProperty(u[E.stream],"id",{get:function(){return E.stream}})),Object.defineProperty(b,"id",{get:function(){return E.track}}),x=u[E.stream]):(u.default||(u.default=new e.MediaStream),x=u.default)),x&&(n(b,x),y.associatedRemoteMediaStreams.push(x)),p.push([b,P,x])}else y.rtpReceiver&&y.rtpReceiver.track&&(y.associatedRemoteMediaStreams.forEach((function(t){var n=t.getTracks().find((function(e){return e.id===y.rtpReceiver.track.id}));n&&function(t,n){n.removeTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(n,t)})),y.associatedRemoteMediaStreams=[]);y.localCapabilities=O,y.remoteCapabilities=k,y.rtpReceiver=P,y.rtcpParameters=M,y.sendEncodingParameters=A,y.recvEncodingParameters=w,l._transceive(l.transceivers[c],!1,G)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===r.type?"active":"passive"),l._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(u).forEach((function(t){var n=u[t];if(n.getTracks().length){if(-1===l.remoteStreams.indexOf(n)){l.remoteStreams.push(n);var i=new Event("addstream");i.stream=n,e.setTimeout((function(){l._dispatchEvent("addstream",i)}))}p.forEach((function(e){var t=e[0],i=e[1];n.id===e[2].id&&d(l,t,i,[n])}))}})),p.forEach((function(e){e[2]||d(l,e[0],e[1],[])})),e.setTimeout((function(){l&&l.transceivers&&l.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n)}},l.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var a=n.transceivers.filter((function(e){return"audio"===e.kind})).length,s=n.transceivers.filter((function(e){return"video"===e.kind})).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(a=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(s=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo)}for(n.transceivers.forEach((function(e){"audio"===e.kind?--a<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));a>0||s>0;)a>0&&(n._createTransceiver("audio"),a--),s>0&&(n._createTransceiver("video"),s--);var d=i.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach((function(r,a){var s=r.track,o=r.kind,c=r.mid||i.generateIdentifier();r.mid=c,r.iceGatherer||(r.iceGatherer=n._createIceGatherer(a,n.usingBundle));var d=e.RTCRtpSender.getCapabilities(o);t<15019&&(d.codecs=d.codecs.filter((function(e){return"rtx"!==e.name}))),d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),d.headerExtensions.forEach((function(e){(r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var l=r.sendEncodingParameters||[{ssrc:1001*(2*a+1)}];s&&t>=15019&&"video"===o&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,o)),r.localCapabilities=d,r.sendEncodingParameters=l})),"max-compat"!==n._config.bundlePolicy&&(d+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",n.transceivers.forEach((function(e,t){d+=r(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===n.iceGatheringState||0!==t&&n.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,d+="a="+i.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))}));var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var s=i.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(s+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var o=i.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach((function(e,i){if(!(i+1>o)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var d=a(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=r(e,d,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var d=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(r,a){if(!n._remoteDescription)return a(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<n.transceivers.length;d++)if(n.transceivers[d].mid===e.sdpMid){s=d;break}var l=n.transceivers[s];if(!l)return a(c("OperationError","Can not add ICE candidate"));if(l.rejected)return r();var u=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return r();if(u.component&&1!==u.component)return r();if((0===s||s>0&&l.iceTransport!==n.transceivers[0].iceTransport)&&!o(l.iceTransport,u))return a(c("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),(t=i.getMediaSections(n._remoteDescription.sdp))[s]+="a="+(u.type?p:"end-of-candidates")+"\r\n",n._remoteDescription.sdp=i.getDescription(n._remoteDescription.sdp)+t.join("")}else for(var h=0;h<n.transceivers.length&&(n.transceivers[h].rejected||(n.transceivers[h].iceTransport.addRemoteCandidate({}),(t=i.getMediaSections(n._remoteDescription.sdp))[h]+="a=end-of-candidates\r\n",n._remoteDescription.sdp=i.getDescription(n._remoteDescription.sdp)+t.join(""),!n.usingBundle));h++);r()}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver)})),!n)throw c("InvalidAccessError","Invalid selector.");return n.getStats()}var i=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&i.push(e[t].getStats())}))})),Promise.all(i).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var i=n.prototype.getStats;n.prototype.getStats=function(){return i.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(n){var i;e[n].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(i=e[n]).type]||i.type,t.set(n,e[n])})),t}))}}}));var u=["createOffer","createAnswer"];return u.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),l}},857539:e=>{"use strict";var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){var n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter((function(e){return 0===e.indexOf(n)}))},t.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1];break;case"ufrag":n.ufrag=t[i+1],n.usernameFragment=t[i+1];break;default:n[t[i]]=t[i+1]}return n},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<i.length;r++)n[(t=i[r].trim().split("="))[0].trim()]=t[1];return n},t.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){var i=t.matchPrefix(e+n,"a=ice-ufrag:")[0],r=t.matchPrefix(e+n,"a=ice-pwd:")[0];return i&&r?{usernameFragment:i.substr(12),password:r.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" "),r=3;r<i.length;r++){var a=i[r],s=t.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(s){var o=t.parseRtpMap(s),c=t.matchPrefix(e,"a=fmtp:"+a+" ");switch(o.parameters=c.length?t.parseFmtp(c[0]):{},o.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),n.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(o.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){n.headerExtensions.push(t.parseExtmap(e))})),n},t.writeRtpDescription=function(e,n){var i="";i+="m="+e+" ",i+=n.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=n.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach((function(e){i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));var r=0;return n.codecs.forEach((function(e){e.maxptime>r&&(r=e.maxptime)})),r>0&&(i+="a=maxptime:"+r+"\r\n"),i+="a=rtcp-mux\r\n",n.headerExtensions&&n.headerExtensions.forEach((function(e){i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){var n,i=[],r=t.parseRtpParameters(e),a=-1!==r.fecMechanisms.indexOf("RED"),s=-1!==r.fecMechanisms.indexOf("ULPFEC"),o=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=o.length>0&&o[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(n=d[0][1]),r.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&n&&(t.rtx={ssrc:n}),i.push(t),a&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&c&&i.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,i.forEach((function(e){e.maxBitrate=l}))),i},t.parseRtcpParameters=function(e){var n={},i=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];i&&(n.cname=i.value,n.ssrc=i.ssrc);var r=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=r.length>0,n.compound=0===r.length;var a=t.matchPrefix(e,"a=rtcp-mux");return n.mux=a.length>0,n},t.parseMsid=function(e){var n,i=t.matchPrefix(e,"a=msid:");if(1===i.length)return{stream:(n=i[0].substr(7).split(" "))[0],track:n[1]};var r=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return r.length>0?{stream:(n=r[0].value.split(" "))[0],track:n[1]}:void 0},t.parseSctpDescription=function(e){var n,i=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");r.length>0&&(n=parseInt(r[0].substr(19),10)),isNaN(n)&&(n=65536);var a=t.matchPrefix(e,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substr(12),10),protocol:i.fmt,maxMessageSize:n};if(t.matchPrefix(e,"a=sctpmap:").length>0){var s=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){var n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,n,i){var r=void 0!==n?n:2;return"v=0\r\no="+(i||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,n,i,r){var a=t.writeRtpDescription(e.kind,n);if(a+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.direction?a+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var s="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+s,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),a},t.getDirection=function(e,n){for(var i=t.splitLines(e),r=0;r<i.length;r++)switch(i[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[r].substr(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var n=t.splitLines(e)[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var n=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var n=t.splitLines(e),i=0;i<n.length;i++)if(n[i].length<2||"="!==n[i].charAt(1))return!1;return!0},e.exports=t},121255:(e,t,n)=>{"use strict";n.d(t,{CallStatReachedType:()=>h.CallStatReachedType,CallStatResult:()=>h.CallStatResult,CallStatFailReason:()=>h.CallStatFailReason,CallStatSource:()=>h.CallStatSource,CallActionEventType:()=>h.CallActionEventType,CallStatMuteType:()=>h.CallStatMuteType,VIDEO_SLOTS_COUNT:()=>_,NoiseCancellationTypes:()=>d,VideoResolutionTypes:()=>l,VIDEO_RESOLUTION_STORAGE_KEY:()=>I,LOCALSTORAGE_IS_CALLS_APP_DOWNLOADED:()=>P,DESKTOP_CALLS_SCHEME:()=>A,DESKTOP_CALLS_HOST:()=>w,DESKTOP_CALLS_DOWNLOAD_PAGE:()=>O,DESKTOP_CALLS_DOWNLOAD:()=>b,DESKTOP_CALLS_FILENAME:()=>D,VideoHeight:()=>m,VideoWidth:()=>f,ParticipantsManagementMode:()=>g,MediaPermissionType:()=>v,ErrorHandleType:()=>S,CallErrorType:()=>E,MediaError:()=>T,FatalError:()=>y,SearchResultType:()=>C,Mode:()=>R,LOAD_PEERS:()=>x,CHANGE_MODE:()=>G,CALL_STATE:()=>V,REMOVE_USER:()=>F,TIME_START:()=>H,LOCAL_TIME_START:()=>j,HANGUP:()=>B,SET_CHAT_INFO:()=>W,GROUP_CALL_SETUP:()=>$,TOGGLE_POPUP:()=>K,UPDATE_HASH:()=>q,CHANGE_UI_MODE:()=>J,SET_ORATOR:()=>Y,TOGGLE_ORATOR_MODE:()=>z,TOGGLE_PARTICIPANTS_ASIDE:()=>X,SET_PINNED_PARTICIPANT:()=>Q,SET_ADMIN_PINNED_PARTICIPANT:()=>Z,SET_SCREEN_SHARING_PINNED_PARTICIPANT:()=>ee,MANAGEMENT:()=>te,CALL_NOTIFICATION:()=>ne,JOIN:()=>ie,CALL_BY_NAME:()=>re,ERROR:()=>ae,CHANGE_PARTICIPANT_STATE:()=>se,CHANGE_PARTICIPANT_ROLES:()=>oe,CHANGE_PARTICIPANT_PERMISSIONS:()=>ce,SET_SCREEN_SHARER:()=>de,SET_FRIENDS:()=>le,SET_GROUP_MEMBERS:()=>ue,SET_SPEAKERS:()=>pe,UPDATE_PARTICIPANTS_BATCH:()=>he,SET_UNREAD_COUNT:()=>_e,SHOW_CAUTION_BOX:()=>me,SHOW_LOADER:()=>fe,SET_TOOLTIP:()=>ge,MANUAL_ADD_PARTICIPANTS:()=>ve,SET_TRANSLATION:()=>Se,UPDATE_ANON_SECRET:()=>Ee,TOGGLE_PARTICIPANTS_MANAGEMENT:()=>Te,TOGGLE_PARTICIPANTS_KICK:()=>ye,TOGGLE_ADMIN_ASSIGNMENT:()=>Ce,SET_NOISE_CANCELLATION:()=>Re,CHANGE_LOCAL_VIDEO_RESOLUTION:()=>Ie,SET_CONVERSATION_OPTIONS:()=>Pe,SET_PRIVACY_SETTINGS:()=>Ae,UNBAN_PARTICIPANTS:()=>we,SET_GROUP:()=>Oe,SET_WAITING_HALL:()=>be,SET_LOCAL_STATUS:()=>De,SET_PUSH_TO_TALK_ENABLE:()=>Ne,SET_GRID_SCROLL_POSITION:()=>ke,SET_ORATOR_SCROLL_POSITION:()=>Me,CallType:()=>N,UIMode:()=>k,NotificationType:()=>M,SdkHandType:()=>L,SdkErrorType:()=>U,defaultNotificationLifeSpan:()=>Ue,VOLUME_LEVEL_DETECTION:()=>xe,DEFAULT_AVATAR:()=>Ge,DEFAULT_GROUP_CALL_PHOTO:()=>Ve,HANGUP_DELAY:()=>Fe,CLIENT_ERROR_UNKNOWN:()=>He,SERVER_ERROR_UNKNOWN:()=>je,SERVER_ERROR_INVALID_REQUEST:()=>Be,SERVER_ERROR_FLOOD_CONTROL:()=>We,SERVER_ERROR_INTERNAL:()=>$e,SERVER_ERROR_OLD_RECEIVER_APP:()=>Ke,SERVER_ERROR_PRIVACY:()=>qe,SERVER_ERROR_BUSY:()=>Je,SERVER_ERROR_REQUIRE_AUTH:()=>Ye,SERVER_ERROR_MESSAGES_CALL_JOIN_NOT_ALLOWED:()=>ze,SERVER_ERROR_MESSAGES_CALL_NOT_FOUND:()=>Xe,SDK_ERROR_AUTH:()=>Qe,POPUP_SETTINGS:()=>Ze,POPUP_TRANSLATION:()=>et,POPUP_TRANSLATION_START_COUNTDOWN:()=>tt,POPUP_TRANSLATION_STOP:()=>nt,POPUP_TRANSLATION_SHARE:()=>it,POPUP_EXIT:()=>rt,POPUP_UNMUTE_REQUEST:()=>at,POPUP_ADMIN_PIN_UNMUTE_REQUEST:()=>st,POPUP_TRANSFER_ADMIN_RIGHTS:()=>ot,HANGUP_TYPE_BUSY:()=>ct,HANGUP_TYPE_CALLEE_IS_OFFLINE:()=>dt,HANGUP_TYPE_CALLER_IS_BLOCKED:()=>lt,HANGUP_TYPE_CANCELED:()=>ut,HANGUP_TYPE_EXTERNAL_API_ERROR:()=>pt,HANGUP_TYPE_FAILED:()=>ht,HANGUP_TYPE_HUNGUP:()=>_t,HANGUP_TYPE_MISSED:()=>mt,HANGUP_TYPE_NOT_FRIENDS:()=>ft,HANGUP_TYPE_OLD_VERSION:()=>gt,HANGUP_TYPE_REJECTED:()=>vt,HANGUP_TYPE_REMOVED:()=>St,HANGUP_TYPE_SERVICE_DISABLED:()=>Et,HANGUP_TYPE_UNKNOWN_ERROR:()=>Tt,HANGUP_TYPE_UNSUPPORTED:()=>yt,FLAG_OUTBOUND:()=>Ct,FLAG_DELETED:()=>Rt,FLAG_SPAM:()=>It,INCOMING_CALL:()=>Pt,ADD_MESSAGE:()=>At,CONVERSATION_UPDATED:()=>wt,MAIL_CHAT_UPDATE_TYPE_CALL_IN_PROGRESS_CHANGED:()=>Ot,READ_INBOUND:()=>bt,SET_FLAGS:()=>Dt,EDIT_MESSAGE:()=>Nt,REPLACE_MESSAGE:()=>kt,DELETE_DIALOG:()=>Mt,COUNT_OF_GROUP_MEMBERS_TO_LOAD:()=>Lt,KickParticipantType:()=>Le});var i,r,a,s,o,c,d,l,u=n(464380),p=n(233194),h=n(765446),_=30;!function(e){e.NEURAL="NEURAL",e.SIMPLE="SIMPLE",e.NONE="NONE"}(d||(d={})),function(e){e.SD="SD",e.HD="HD",e.FHD="FHD"}(l||(l={}));var m,f,g,v,S,E,T,y,C,R,I="calls_video_resolution",P="vkcalls:calls_app_downloaded",A="vkcalls://",w="vk.com",O="https://vk.com/video-calls",b=((i={})[p.OS.WINDOWS]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls.exe",i[p.OS.MAC]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls.dmg",i[p.OS.LINUX]={deb:(r={},r[p.ARCH.X64]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-amd64.deb",r[p.ARCH.X86]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-i386.deb",r),rpm:(a={},a[p.ARCH.X64]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-x86_64.rpm",a[p.ARCH.X86]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-i686.rpm",a)},i),D=((s={})[p.OS.WINDOWS]="vk-calls.exe",s[p.OS.MAC]="vk-calls.dmg",s[p.OS.LINUX]={deb:(o={},o[p.ARCH.X64]="vk-calls-amd64.deb",o[p.ARCH.X86]="vk-calls-i386.deb",o),rpm:(c={},c[p.ARCH.X64]="vk-calls-x86_64.rpm",c[p.ARCH.X86]="vk-calls-i686.rpm",c)},s);!function(e){e[e.SD=360]="SD",e[e.HD=720]="HD",e[e.FHD=1080]="FHD"}(m||(m={})),function(e){e[e.SD=640]="SD",e[e.HD=1280]="HD",e[e.FHD=1920]="FHD"}(f||(f={})),function(e){e[e.SINGLE=0]="SINGLE",e[e.ALL=1]="ALL"}(g||(g={})),function(e){e[e.DENY=0]="DENY",e[e.ONCE=1]="ONCE",e[e.ALLOW=1/0]="ALLOW"}(v||(v={})),function(e){e[e.DECLINE=0]="DECLINE",e[e.PROCESS=1]="PROCESS",e[e.FATAL=2]="FATAL"}(S||(S={})),function(e){e.ALREADY_IN_CALL="already_in_call",e.CANT_REACH_API="cant_reach_api"}(E||(E={})),function(e){e.MIC_CAMERA_PERMISSION="mic_camera",e.CAMERA_PERMISSION="camera",e.MIC_PERMISSION="mic",e.CAMERA_ACCESS="cameralock",e.MIC_ACCESS="miclock",e.MIC_NOT_FOUND="nomic",e.SCREEN_PERMISSION="screenpermission",e.SCREEN_ACCESS="screenlock"}(T||(T={})),function(e){e.AUTH="auth"}(y||(y={})),function(e){e[e.HEADER=0]="HEADER",e[e.CALL_ALL_IN_CHAT=1]="CALL_ALL_IN_CHAT",e[e.MEMBERS_MORE=2]="MEMBERS_MORE",e[e.FRIENDS_MORE=3]="FRIENDS_MORE",e[e.GROUP_MEMBERS_MORE=4]="GROUP_MEMBERS_MORE"}(C||(C={})),function(e){e[e.READY=0]="READY",e[e.CALL=1]="CALL",e[e.INCOMING=2]="INCOMING",e[e.JOIN=3]="JOIN",e[e.ERROR=4]="ERROR",e[e.FEEDBACK=5]="FEEDBACK",e[e.START=6]="START",e[e.CALL_BY=7]="CALL_BY"}(R||(R={}));var N,k,M,L,U,x="load_peer",G="change_mode",V="call_state",F="remove_user",H="time_start",j="local_time_start",B="hangup",W="set_chat_info",$="group_call_setup",K="toggle_popup",q="update_hash",J="change_ui_mode",Y="set_orator",z="toggle_orator_mode",X="toggle_participants_aside",Q="set_pinned_participant",Z="set_admin_pinned_participant",ee="set_screen_sharing_pinned_participant",te="management",ne="call_notification",ie="join",re="call_by_name",ae="error",se="change_participant_state",oe="change_participant_roles",ce="change_participant_permissions",de="set_screen_sharer",le="set_friends",ue="set_group_members",pe="set_speakers",he="update_participants_batch",_e="set_unread_count",me="show_caution_box",fe="show_loader",ge="set_tooltip",ve="manual_add_participants",Se="set_translation",Ee="update_anon_token",Te="toggle_participants_management",ye="toggle_participants_kick",Ce="toggle_admin_assignment",Re="set_noise_cancellation",Ie="change_local_video_resolution",Pe="set_conversation_options",Ae="set_privacy_settings",we="unban_participants",Oe="set_group",be="set_waiting_hall",De="set_local_status",Ne="set_push_to_talk_enable",ke="set_grid_scroll_position",Me="set_orator_scroll_position";!function(e){e.AUDIO="audio",e.VIDEO="video"}(N||(N={})),function(e){e.DEFAULT="default",e.COLLAPSED="collapsed",e.FULLSCREEN="fullscreen"}(k||(k={})),function(e){e.SPEAKING_ON_MUTE="SPEAKING_ON_MUTE",e.RAISED_HAND="RAISED_HAND",e.SCREEN_SHARING_STARTED="SCREEN_SHARING_STARTED",e.BAD_NETWORK_CONNECTION="BAD_NETWORK_CONNECTION",e.BAD_NETWORK_CONNECTION_DISABLE_CAMERA="BAD_NETWORK_CONNECTION_DISABLE_CAMERA",e.ADMIN_MUTE="ADMIN_MUTE",e.ADMIN_MUTE_PERMANENT="ADMIN_MUTE_PERMANENT",e.ADMIN_ROLE_GRANTED="ADMIN_ROLE_GRANTED",e.USER_GRANTED_WITH_ADMIN_ROLE="USER_GRANTED_WITH_ADMIN_ROLE",e.PINNED_BY_ADMIN="PINNED_BY_ADMIN",e.USER_PINNED_BY_ADMIN="USER_PINNED_BY_ADMIN",e.PUSH_TO_TALK="PUSH_TO_TALK",e.CONNECTING="CONNECTING"}(M||(M={})),function(e){e.LOWERED="0",e.RAISED="1"}(L||(L={})),function(e){e.NETWORK="network_error",e.API="api_error"}(U||(U={}));var Le,Ue=5e3,xe=.25,Ge="https://vk.com/images/camera_400.png",Ve="https://vk.com/images/call_convo_stub.png",Fe=2,He=-2,je=1,Be=8,We=9,$e=10,Ke=923,qe=928,Je=948,Ye=960,ze=963,Xe=951,Qe=401,Ze="settings",et="translation",tt="translation_start_countdown",nt="translation_stop",it="translation_stop_share",rt="exit",at="unmute_request",st="admin_pin_unmute_request",ot="transfer_admin_rights",ct=u.HangupType.BUSY,dt=u.HangupType.CALLEE_IS_OFFLINE,lt=u.HangupType.CALLER_IS_BLOCKED,ut=u.HangupType.CANCELED,pt=u.HangupType.EXTERNAL_API_ERROR,ht=u.HangupType.FAILED,_t=u.HangupType.HUNGUP,mt=u.HangupType.MISSED,ft=u.HangupType.NOT_FRIENDS,gt=u.HangupType.OLD_VERSION,vt=u.HangupType.REJECTED,St=u.HangupType.REMOVED,Et=u.HangupType.SERVICE_DISABLED,Tt=u.HangupType.UNKNOWN_ERROR,yt=u.HangupType.UNSUPPORTED,Ct=2,Rt=128,It=64,Pt="incoming_call",At="event_add_message",wt="event_chat_updated",Ot=19,bt="event_read_inbound",Dt="event_set_flags",Nt="event_edit_message",kt="event_replace_message",Mt="event_delete_dialog",Lt=500;!function(e){e[e.CALL=0]="CALL",e[e.WAITING_HALL=1]="WAITING_HALL"}(Le||(Le={}))},233194:(e,t,n)=>{"use strict";n.d(t,{OS:()=>r,ARCH:()=>a,BROWSER:()=>s,Platform:()=>h,getBrowserInfo:()=>_});var i,r,a,s,o=n(570655),c=n(489588);!function(e){e.WINDOWS="windows",e.MAC="mac",e.ANDROID="android",e.IOS="ios",e.LINUX="linux",e.UNKNOWN="unknown"}(r||(r={})),function(e){e.X86="x86",e.X64="x64",e.ARM="arm"}(a||(a={})),function(e){e.CHROME="chrome",e.FIREFOX="firefox",e.SAFARI="safari",e.OPERA="opera",e.YANDEX="yandex",e.IE="ie",e.EDGE="edge"}(s||(s={}));var d=((i={})[r.ANDROID]=/Android/i,i[r.IOS]=/(iPhone|iPad|iPod)/i,i[r.WINDOWS]=/Win/i,i[r.IOS]=/(iPhone|iPad|iPod)/i,i[r.ANDROID]=/Android/i,i[r.MAC]=/(MacPPC|MacIntel|Mac_PowerPC|Macintosh|Mac OS X)/i,i[r.LINUX]=/(Linux|X11(?!.*CrOS))/i,i),l=/(x86_64|x86-64|win64|x64;|amd64|wow64|x64_64)/i,u=/Mobile|mini|Fennec|Android|iP(ad|od|hone)|opera (mini|mobi)/i,p=new Map,h={get OS(){var e,t;if(p.has("os"))return p.get("os");var n=window.navigator.userAgent;try{for(var i=(0,o.__values)(Object.entries(d)),a=i.next();!a.done;a=i.next()){var s=(0,o.__read)(a.value,2),c=s[0],l=s[1];if(l&&l.test(n))return p.set("os",c),c}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return p.set("os",r.UNKNOWN),r.UNKNOWN},get ARCH(){if(p.has("arch"))return p.get("arch");var e=window.navigator,t=e.userAgent,n=e.platform;return l.test(t)||"MacIntel"===n||"Linux x86_64"===n?(p.set("arch",a.X64),a.X64):/arm/i.test(t)?(p.set("arch",a.ARM),a.ARM):(p.set("arch",a.X86),a.X86)},get BROWSER(){return _().name.toLowerCase()},get isChromeBased(){return _().chromeBased},get isMobile(){if(p.has("isMobile"))return p.get("isMobile");var e=window.navigator.appVersion,t=u.test(e);return p.set("isMobile",t),t},get isIPad(){return c.isIPad||c.isIPadOS}};function _(){if(p.has("browserInfo"))return p.get("browserInfo");var e=function(){var e,t=!1,n=0,i=window.navigator,r=i.userAgent,a=i.appName,o=i.appVersion,c=r.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)([\d.]+)/i)||[];if(/trident/i.test(c[1]))return e=/\brv[ :]+(\d+)([\d.]+)/g.exec(r),{name:s.IE,version:e&&e[1]||"Unknown",fullVersion:e&&e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:n};if("Safari"===c[1]){if(e=r.match(/\bEdge\/(\d+)([\d.])+/))return{name:s.EDGE,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:n};if(e=r.match(/\bCriOS\/(\d+)([\d.]+)/))return{name:s.CHROME,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:!0,chromeVersion:e[1]};if(e=r.match(/\bFxiOS\/(\d+)([\d.]+)/))return{name:s.FIREFOX,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:t,chromeVersion:n};if(e=r.match(/\bYaBrowser\/(\d+)([\d.]+)/))return{name:s.YANDEX,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:t,chromeVersion:n};if(e=r.match(/\bOPT\/(\d+)([\d.]+)/))return{name:s.OPERA,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:t,chromeVersion:n}}if("Chrome"===c[1]){if(n=Number(c[2]),t=!0,e=r.match(/\bOPR\/(\d+)([\d.]+)/))return{name:s.CHROME,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:n};if(e=r.match(/\bYaBrowser\/(\d+)([\d.]+)/))return{name:s.YANDEX,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:n};if(e=r.match(/\bEdge?\/(\d+)([\d.]+)/))return{name:s.EDGE,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:n};if(void 0!==window.opr&&/^(.+\.)?ok.ru$/.test(window.location.host))return{name:s.OPERA,version:"Hidden",fullVersion:"Hidden",chromeBased:t,chromeVersion:n}}return e=r.match(/version\/(\d+)([\d.]+)/i),{name:c[2]?c[1]:a,version:e&&e[1]||c[2]||o,fullVersion:e&&e[1]?""+e[1]+(e[2]||""):c[2]?""+c[2]+(c[3]||""):o,chromeBased:t,chromeVersion:n}}();return p.set("browserInfo",e),e}},545580:(e,t,n)=>{"use strict";n.d(t,{default:()=>i});const i=(0,n(640447).adapterFactory)({window:"undefined"==typeof window?void 0:window})},640447:(e,t,n)=>{"use strict";n.d(t,{adapterFactory:()=>l});var i=n(786643),r=n(165070),a=n(624854),s=n(960057),o=n(809080),c=n(155938),d=n(548864);function l({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const n=i.log,l=i.detectBrowser(e),u={browserDetails:l,commonShim:d,extractVersion:i.extractVersion,disableLog:i.disableLog,disableWarnings:i.disableWarnings};switch(l.browser){case"chrome":if(!r||!r.shimPeerConnection||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),u;if(null===l.version)return n("Chrome shim can not determine version, not shimming."),u;n("adapter.js shimming chrome."),u.browserShim=r,r.shimGetUserMedia(e),r.shimMediaStream(e),r.shimPeerConnection(e),r.shimOnTrack(e),r.shimAddTrackRemoveTrack(e),r.shimGetSendersWithDtmf(e),r.shimGetStats(e),r.shimSenderReceiverGetStats(e),r.fixNegotiationNeeded(e),d.shimRTCIceCandidate(e),d.shimConnectionState(e),d.shimMaxMessageSize(e),d.shimSendThrowTypeError(e),d.removeAllowExtmapMixed(e);break;case"firefox":if(!s||!s.shimPeerConnection||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),u;n("adapter.js shimming firefox."),u.browserShim=s,o.shimGetUserMedia(e),s.shimPeerConnection(e),s.shimOnTrack(e),s.shimRemoveStream(e),s.shimSenderGetStats(e),s.shimReceiverGetStats(e),s.shimRTCDataChannel(e),s.shimAddTransceiver(e),s.shimGetParameters(e),s.shimCreateOffer(e),s.shimCreateAnswer(e),d.shimRTCIceCandidate(e),d.shimConnectionState(e),d.shimMaxMessageSize(e),d.shimSendThrowTypeError(e);break;case"edge":if(!a||!a.shimPeerConnection||!t.shimEdge)return n("MS edge shim is not included in this adapter release."),u;n("adapter.js shimming edge."),u.browserShim=a,a.shimGetUserMedia(e),a.shimGetDisplayMedia(e),a.shimPeerConnection(e),a.shimReplaceTrack(e),d.shimMaxMessageSize(e),d.shimSendThrowTypeError(e);break;case"safari":if(!c||!t.shimSafari)return n("Safari shim is not included in this adapter release."),u;n("adapter.js shimming safari."),u.browserShim=c,c.shimRTCIceServerUrls(e),c.shimCreateOfferLegacy(e),c.shimCallbacksAPI(e),c.shimLocalStreamsAPI(e),c.shimRemoteStreamsAPI(e),c.shimTrackEventTransceiver(e),c.shimGetUserMedia(e),c.shimAudioContext(e),d.shimRTCIceCandidate(e),d.shimMaxMessageSize(e),d.shimSendThrowTypeError(e),d.removeAllowExtmapMixed(e);break;default:n("Unsupported browser!")}return u}},165070:(e,t,n)=>{"use strict";n.r(t),n.d(t,{shimGetUserMedia:()=>r.shimGetUserMedia,shimGetDisplayMedia:()=>a.shimGetDisplayMedia,shimMediaStream:()=>s,shimOnTrack:()=>o,shimGetSendersWithDtmf:()=>c,shimGetStats:()=>d,shimSenderReceiverGetStats:()=>l,shimAddTrackRemoveTrackWithNative:()=>u,shimAddTrackRemoveTrack:()=>p,shimPeerConnection:()=>h,fixNegotiationNeeded:()=>_});var i=n(786643),r=n(480009),a=n(271533);function s(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function o(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.track.id)):{track:n.track};const r=new Event("track");r.track=n.track,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.id)):{track:n};const r=new Event("track");r.track=n,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else i.wrapPeerConnectionEvent(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function c(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let r=n.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function d(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,i]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t[n.id]=n})),t},a=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const i=function(e){n(a(r(e)))};return t.apply(this,[i,e])}return new Promise(((e,n)=>{t.apply(this,[function(t){e(a(r(t)))},n])})).then(n,i)}}function l(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>i.filterStats(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),i.wrapPeerConnectionEvent(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>i.filterStats(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,i;return this.getSenders().forEach((n=>{n.track===e&&(t?i=!0:t=n)})),this.getReceivers().forEach((t=>(t.track===e&&(n?i=!0:n=t),t.track===e))),i||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function u(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();n.apply(this,arguments);const i=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function p(e){if(!e.RTCPeerConnection)return;const t=i.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return u(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}r.apply(this,[t])};const a=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},a.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find((e=>e.track===t));if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const a=this._streams[n.id];if(a)a.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const i=new e.MediaStream([t]);this._streams[n.id]=i,this._reverseStreams[i.id]=n,this.addStream(i)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=s(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then((e=>s(this,e)))}};e.RTCPeerConnection.prototype[t]=i[t]}));const c=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),c.apply(this,arguments)):c.apply(this,arguments)};const d=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=d.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function h(e){const t=i.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const n=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}));const r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return n||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function _(e){const t=i.detectBrowser(e);i.wrapPeerConnectionEvent(e,"negotiationneeded",(e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}},271533:(e,t,n)=>{"use strict";function i(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((t=>{const i=n.video&&n.video.width,r=n.video&&n.video.height,a=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:a||3}},i&&(n.video.mandatory.maxWidth=i),r&&(n.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}n.d(t,{shimGetDisplayMedia:()=>i})},480009:(e,t,n)=>{"use strict";n.d(t,{shimGetUserMedia:()=>a});var i=n(786643);const r=i.log;function a(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const n=i.detectBrowser(e),a=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[r("min",n)]=i.ideal,t.optional.push(e),e={},e[r("max",n)]=i.ideal,t.optional.push(e)):(e[r("",n)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach((e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,i){if(n.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const o=n.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let n;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?n=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(n=["front"]),n)return t.mediaDevices.enumerateDevices().then((t=>{let o=(t=t.filter((e=>"videoinput"===e.kind))).find((e=>n.some((t=>e.label.toLowerCase().includes(t)))));return!o&&t.length&&n.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=s.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=a(e.video),r("chrome: "+JSON.stringify(e)),i(e)}))}e.video=a(e.video)}return r("chrome: "+JSON.stringify(e)),i(e)},o=function(e){return n.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,n,i){s(e,(e=>{t.webkitGetUserMedia(e,n,(e=>{i&&i(o(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return s(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}},548864:(e,t,n)=>{"use strict";n.r(t),n.d(t,{shimRTCIceCandidate:()=>s,shimMaxMessageSize:()=>o,shimSendThrowTypeError:()=>c,shimConnectionState:()=>d,removeAllowExtmapMixed:()=>l});var i=n(857539),r=n.n(i),a=n(786643);function s(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),i=r().parseCandidate(e.candidate),a=Object.assign(n,i);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function o(e){if(!e.RTCPeerConnection)return;const t=a.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=function(e){if(!e||!e.sdp)return!1;const t=r().splitSections(e.sdp);return t.shift(),t.some((e=>{const t=r().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n},s=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n},o=function(e,n){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const a=r().matchPrefix(e.sdp,"a=max-message-size:");return a.length>0?i=parseInt(a[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const e=i(arguments[0]),t=s(e),n=o(arguments[0],e);let r;r=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>r}),this._sctp=a}return c.apply(this,arguments)}}function c(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const i=arguments[0],r=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function d(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function l(e){if(!e.RTCPeerConnection)return;const t=a.detectBrowser(e);if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n")),n.apply(this,arguments)}}},624854:(e,t,n)=>{"use strict";n.r(t),n.d(t,{shimGetUserMedia:()=>o.shimGetUserMedia,shimGetDisplayMedia:()=>c.shimGetDisplayMedia,shimPeerConnection:()=>d,shimReplaceTrack:()=>l});var i=n(786643),r=n(860641),a=n(762539),s=n.n(a),o=n(131169),c=n(794155);function d(e){const t=i.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const n=new Event("enabled");n.enabled=e,this.dispatchEvent(n)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const n=s()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,r.filterIceServers)(e.iceServers,t.version),i.log("ICE servers after filtering:",e.iceServers)),new n(e)},e.RTCPeerConnection.prototype=n.prototype}function l(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}},860641:(e,t,n)=>{"use strict";n.d(t,{filterIceServers:()=>r});var i=n(786643);function r(e,t){let n=!1;return(e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&i.deprecated("RTCIceServer.url","RTCIceServer.urls");const r="string"==typeof t;return r&&(t=[t]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!n?(n=!0,!0):t&&!n})),delete e.url,e.urls=r?t[0]:t,!!t.length}}))}},794155:(e,t,n)=>{"use strict";function i(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}n.d(t,{shimGetDisplayMedia:()=>i})},131169:(e,t,n)=>{"use strict";function i(e){const t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch((e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e))))}}n.d(t,{shimGetUserMedia:()=>i})},960057:(e,t,n)=>{"use strict";n.r(t),n.d(t,{shimGetUserMedia:()=>r.shimGetUserMedia,shimGetDisplayMedia:()=>a.shimGetDisplayMedia,shimOnTrack:()=>s,shimPeerConnection:()=>o,shimSenderGetStats:()=>c,shimReceiverGetStats:()=>d,shimRemoveStream:()=>l,shimRTCDataChannel:()=>u,shimAddTransceiver:()=>p,shimGetParameters:()=>h,shimCreateOffer:()=>_,shimCreateAnswer:()=>m});var i=n(786643),r=n(809080),a=n(72365);function s(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function o(e){const t=i.detectBrowser(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,a]=arguments;return r.apply(this,[e||null]).then((e=>{if(t.version<53&&!i)try{e.forEach((e=>{e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,i)=>{e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(i,a)}}function c(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function d(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),i.wrapPeerConnectionEvent(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function l(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){i.deprecated("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function u(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function p(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],n=e&&"sendEncodings"in e;n&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const i=t.apply(this,arguments);if(n){const{sender:t}=i,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return i})}function h(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function _(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function m(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}},72365:(e,t,n)=>{"use strict";function i(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})}n.d(t,{shimGetDisplayMedia:()=>i})},809080:(e,t,n)=>{"use strict";n.d(t,{shimGetUserMedia:()=>r});var i=n(786643);function r(e){const t=i.detectBrowser(e),n=e&&e.navigator,r=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,r){i.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,r)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}},155938:(e,t,n)=>{"use strict";n.r(t),n.d(t,{shimLocalStreamsAPI:()=>r,shimRemoteStreamsAPI:()=>a,shimCallbacksAPI:()=>s,shimGetUserMedia:()=>o,shimConstraints:()=>c,shimRTCIceServerUrls:()=>d,shimTrackEventTransceiver:()=>l,shimCreateOfferLegacy:()=>u,shimAudioContext:()=>p});var i=n(786643);function r(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((n=>t.call(this,n,e))),e.getVideoTracks().forEach((n=>t.call(this,n,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...n){return n&&n.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach((e=>{n.includes(e.track)&&this.removeTrack(e)}))})}}function a(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}))}),t.apply(e,arguments)}}}function s(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,a=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r};let o=function(e,t,n){const i=r.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i};t.setLocalDescription=o,o=function(e,t,n){const i=a.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.setRemoteDescription=o,o=function(e,t,n){const i=s.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.addIceCandidate=o}function o(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(c(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t))}function c(e){return e&&void 0!==e.video?Object.assign({},e,{video:i.compactObject(e.video)}):e}function d(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let r=e.iceServers[n];!r.hasOwnProperty("urls")&&r.hasOwnProperty("url")?(i.deprecated("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function l(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function u(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video")}return t.apply(this,arguments)}}function p(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}},786643:(e,t,n)=>{"use strict";n.d(t,{extractVersion:()=>a,wrapPeerConnectionEvent:()=>s,disableLog:()=>o,disableWarnings:()=>c,log:()=>d,deprecated:()=>l,detectBrowser:()=>u,compactObject:()=>h,filterStats:()=>m});let i=!0,r=!0;function a(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function s(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return r.apply(this,arguments);const a=e=>{const t=n(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,a),r.apply(this,[e,a])};const a=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return a.apply(this,arguments);if(!this._eventMap[t].has(n))return a.apply(this,arguments);const i=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,a.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function o(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function c(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function d(){if("object"==typeof window){if(i)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function l(e,t){r&&console.warn(e+" is deprecated, please use "+t+" instead.")}function u(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.mozGetUserMedia)t.browser="firefox",t.version=a(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=a(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.mediaDevices&&n.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=a(n.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=a(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function p(e){return"[object Object]"===Object.prototype.toString.call(e)}function h(e){return p(e)?Object.keys(e).reduce((function(t,n){const i=p(e[n]),r=i?h(e[n]):e[n],a=i&&!Object.keys(r).length;return void 0===r||a?t:Object.assign(t,{[n]:r})}),{}):e}function _(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?_(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach((t=>{_(e,e.get(t),n)}))})))}function m(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const a=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&a.push(e)})),a.forEach((t=>{e.forEach((n=>{n.type===i&&n.trackId===t.id&&_(e,n,r)}))})),r}}}]);try{stManager.done("dist/3e9fc9c12eadc5ce7d9564e99bf198bc.04144668a253c7024005.js")}catch(e){}